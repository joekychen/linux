<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › xd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file contains the driver for an XT hard disk controller</span>
<span class="cm"> * (at least the DTC 5150X) for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Pat Mackinlay, pat@it.com.au</span>
<span class="cm"> * Date: 29/09/92</span>
<span class="cm"> * </span>
<span class="cm"> * Revised: 01/01/93, ...</span>
<span class="cm"> *</span>
<span class="cm"> * Ref: DTC 5150X Controller Specification (thanks to Kevin Fowler,</span>
<span class="cm"> *   kevinf@agora.rain.com)</span>
<span class="cm"> * Also thanks to: Salvador Abreu, Dave Thaler, Risto Kankkunen and</span>
<span class="cm"> *   Wim Van Dorst.</span>
<span class="cm"> *</span>
<span class="cm"> * Revised: 04/04/94 by Risto Kankkunen</span>
<span class="cm"> *   Moved the detection code from xd_init() to xd_geninit() as it needed</span>
<span class="cm"> *   interrupts enabled and Linus didn&#39;t want to enable them in that first</span>
<span class="cm"> *   phase. xd_geninit() is the place to do these kinds of things anyway,</span>
<span class="cm"> *   he says.</span>
<span class="cm"> *</span>
<span class="cm"> * Modularized: 04/10/96 by Todd Fries, tfries@umr.edu</span>
<span class="cm"> *</span>
<span class="cm"> * Revised: 13/12/97 by Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl</span>
<span class="cm"> *   Fixed some problems with disk initialization and module initiation.</span>
<span class="cm"> *   Added support for manual geometry setting (except Seagate controllers)</span>
<span class="cm"> *   in form:</span>
<span class="cm"> *      xd_geo=&lt;cyl_xda&gt;,&lt;head_xda&gt;,&lt;sec_xda&gt;[,&lt;cyl_xdb&gt;,&lt;head_xdb&gt;,&lt;sec_xdb&gt;]</span>
<span class="cm"> *   Recovered DMA access. Abridged messages. Added support for DTC5051CX,</span>
<span class="cm"> *   WD1002-27X &amp; XEBEC controllers. Driver uses now some jumper settings.</span>
<span class="cm"> *   Extended ioctl() support.</span>
<span class="cm"> *</span>
<span class="cm"> * Bugfix: 15/02/01, Paul G. - inform queue layer of tiny xd_maxsect.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &quot;xd.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">xd_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">do_xd_setup</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">integers</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#define XD_DONT_USE_DMA		0  </span><span class="cm">/* Initial value. may be overriden using</span>
<span class="cm">				      &quot;nodma&quot; module option */</span><span class="cp"></span>
<span class="cp">#define XD_INIT_DISK_DELAY	(30)  </span><span class="cm">/* 30 ms delay during disk initialization */</span><span class="cp"></span>

<span class="cm">/* Above may need to be increased if a problem with the 2nd drive detection</span>
<span class="cm">   (ST11M controller) or resetting a controller (WD) appears */</span>

<span class="k">static</span> <span class="n">XD_INFO</span> <span class="n">xd_info</span><span class="p">[</span><span class="n">XD_MAXDRIVES</span><span class="p">];</span>

<span class="cm">/* If you try this driver and find that your card is not detected by the driver at bootup, you need to add your BIOS</span>
<span class="cm">   signature and details to the following list of signatures. A BIOS signature is a string embedded into the first</span>
<span class="cm">   few bytes of your controller&#39;s on-board ROM BIOS. To find out what yours is, use something like MS-DOS&#39;s DEBUG</span>
<span class="cm">   command. Run DEBUG, and then you can examine your BIOS signature with:</span>

<span class="cm">	d xxxx:0000</span>

<span class="cm">   where xxxx is the segment of your controller (like C800 or D000 or something). On the ASCII dump at the right, you should</span>
<span class="cm">   be able to see a string mentioning the manufacturer&#39;s copyright etc. Add this string into the table below. The parameters</span>
<span class="cm">   in the table are, in order:</span>

<span class="cm">	offset			; this is the offset (in bytes) from the start of your ROM where the signature starts</span>
<span class="cm">	signature		; this is the actual text of the signature</span>
<span class="cm">	xd_?_init_controller	; this is the controller init routine used by your controller</span>
<span class="cm">	xd_?_init_drive		; this is the drive init routine used by your controller</span>

<span class="cm">   The controllers directly supported at the moment are: DTC 5150x, WD 1004A27X, ST11M/R and override. If your controller is</span>
<span class="cm">   made by the same manufacturer as one of these, try using the same init routines as they do. If that doesn&#39;t work, your</span>
<span class="cm">   best bet is to use the &quot;override&quot; routines. These routines use a &quot;portable&quot; method of getting the disk&#39;s geometry, and</span>
<span class="cm">   may work with your card. If none of these seem to work, try sending me some email and I&#39;ll see what I can do &lt;grin&gt;.</span>

<span class="cm">   NOTE: You can now specify your XT controller&#39;s parameters from the command line in the form xd=TYPE,IRQ,IO,DMA. The driver</span>
<span class="cm">   should be able to detect your drive&#39;s geometry from this info. (eg: xd=0,5,0x320,3 is the &quot;standard&quot;). */</span>

<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#define xd_dma_mem_alloc(size) __get_dma_pages(GFP_KERNEL,get_order(size))</span>
<span class="cp">#define xd_dma_mem_free(addr, size) free_pages(addr, get_order(size))</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xd_dma_buffer</span><span class="p">;</span>

<span class="k">static</span> <span class="n">XD_SIGNATURE</span> <span class="n">xd_sigs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span><span class="s">&quot;Override geometry handler&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">xd_override_init_drive</span><span class="p">,</span><span class="s">&quot;n unknown&quot;</span> <span class="p">},</span> <span class="cm">/* Pat Mackinlay, pat@it.com.au */</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span><span class="s">&quot;[BXD06 (C) DTC 17-MAY-1985]&quot;</span><span class="p">,</span><span class="n">xd_dtc_init_controller</span><span class="p">,</span><span class="n">xd_dtc5150cx_init_drive</span><span class="p">,</span><span class="s">&quot; DTC 5150CX&quot;</span> <span class="p">},</span> <span class="cm">/* Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl */</span>
	<span class="p">{</span> <span class="mh">0x000B</span><span class="p">,</span><span class="s">&quot;CRD18A   Not an IBM rom. (C) Copyright Data Technology Corp. 05/31/88&quot;</span><span class="p">,</span><span class="n">xd_dtc_init_controller</span><span class="p">,</span><span class="n">xd_dtc_init_drive</span><span class="p">,</span><span class="s">&quot; DTC 5150X&quot;</span> <span class="p">},</span> <span class="cm">/* Todd Fries, tfries@umr.edu */</span>
	<span class="p">{</span> <span class="mh">0x000B</span><span class="p">,</span><span class="s">&quot;CXD23A Not an IBM ROM (C)Copyright Data Technology Corp 12/03/88&quot;</span><span class="p">,</span><span class="n">xd_dtc_init_controller</span><span class="p">,</span><span class="n">xd_dtc_init_drive</span><span class="p">,</span><span class="s">&quot; DTC 5150X&quot;</span> <span class="p">},</span> <span class="cm">/* Pat Mackinlay, pat@it.com.au */</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span><span class="s">&quot;07/15/86(C) Copyright 1986 Western Digital Corp.&quot;</span><span class="p">,</span><span class="n">xd_wd_init_controller</span><span class="p">,</span><span class="n">xd_wd_init_drive</span><span class="p">,</span><span class="s">&quot; Western Dig. 1002-27X&quot;</span> <span class="p">},</span> <span class="cm">/* Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl */</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span><span class="s">&quot;06/24/88(C) Copyright 1988 Western Digital Corp.&quot;</span><span class="p">,</span><span class="n">xd_wd_init_controller</span><span class="p">,</span><span class="n">xd_wd_init_drive</span><span class="p">,</span><span class="s">&quot; Western Dig. WDXT-GEN2&quot;</span> <span class="p">},</span> <span class="cm">/* Dan Newcombe, newcombe@aa.csc.peachnet.edu */</span>
	<span class="p">{</span> <span class="mh">0x0015</span><span class="p">,</span><span class="s">&quot;SEAGATE ST11 BIOS REVISION&quot;</span><span class="p">,</span><span class="n">xd_seagate_init_controller</span><span class="p">,</span><span class="n">xd_seagate_init_drive</span><span class="p">,</span><span class="s">&quot; Seagate ST11M/R&quot;</span> <span class="p">},</span> <span class="cm">/* Salvador Abreu, spa@fct.unl.pt */</span>
	<span class="p">{</span> <span class="mh">0x0010</span><span class="p">,</span><span class="s">&quot;ST11R BIOS&quot;</span><span class="p">,</span><span class="n">xd_seagate_init_controller</span><span class="p">,</span><span class="n">xd_seagate_init_drive</span><span class="p">,</span><span class="s">&quot; Seagate ST11M/R&quot;</span> <span class="p">},</span> <span class="cm">/* Risto Kankkunen, risto.kankkunen@cs.helsinki.fi */</span>
	<span class="p">{</span> <span class="mh">0x0010</span><span class="p">,</span><span class="s">&quot;ST11 BIOS v1.7&quot;</span><span class="p">,</span><span class="n">xd_seagate_init_controller</span><span class="p">,</span><span class="n">xd_seagate_init_drive</span><span class="p">,</span><span class="s">&quot; Seagate ST11R&quot;</span> <span class="p">},</span> <span class="cm">/* Alan Hourihane, alanh@fairlite.demon.co.uk */</span>
	<span class="p">{</span> <span class="mh">0x1000</span><span class="p">,</span><span class="s">&quot;(c)Copyright 1987 SMS&quot;</span><span class="p">,</span><span class="n">xd_omti_init_controller</span><span class="p">,</span><span class="n">xd_omti_init_drive</span><span class="p">,</span><span class="s">&quot;n OMTI 5520&quot;</span> <span class="p">},</span> <span class="cm">/* Dirk Melchers, dirk@merlin.nbg.sub.org */</span>
	<span class="p">{</span> <span class="mh">0x0006</span><span class="p">,</span><span class="s">&quot;COPYRIGHT XEBEC (C) 1984&quot;</span><span class="p">,</span><span class="n">xd_xebec_init_controller</span><span class="p">,</span><span class="n">xd_xebec_init_drive</span><span class="p">,</span><span class="s">&quot; XEBEC&quot;</span> <span class="p">},</span> <span class="cm">/* Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl */</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span><span class="s">&quot;(C) Copyright 1984 Western Digital Corp&quot;</span><span class="p">,</span> <span class="n">xd_wd_init_controller</span><span class="p">,</span> <span class="n">xd_wd_init_drive</span><span class="p">,</span><span class="s">&quot; Western Dig. 1002s-wx2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span><span class="s">&quot;(C) Copyright 1986 Western Digital Corporation&quot;</span><span class="p">,</span> <span class="n">xd_wd_init_controller</span><span class="p">,</span> <span class="n">xd_wd_init_drive</span><span class="p">,</span><span class="s">&quot; 1986 Western Digital&quot;</span> <span class="p">},</span> <span class="cm">/* jfree@sovereign.org */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xd_bases</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mh">0xC8000</span><span class="p">,</span> <span class="mh">0xCA000</span><span class="p">,</span> <span class="mh">0xCC000</span><span class="p">,</span>
	<span class="mh">0xCE000</span><span class="p">,</span> <span class="mh">0xD0000</span><span class="p">,</span> <span class="mh">0xD2000</span><span class="p">,</span>
	<span class="mh">0xD4000</span><span class="p">,</span> <span class="mh">0xD6000</span><span class="p">,</span> <span class="mh">0xD8000</span><span class="p">,</span>
	<span class="mh">0xDA000</span><span class="p">,</span> <span class="mh">0xDC000</span><span class="p">,</span> <span class="mh">0xDE000</span><span class="p">,</span>
	<span class="mh">0xE0000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">xd_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">xd_gendisk</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xd_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">xd_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>	<span class="o">=</span> <span class="n">xd_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span> <span class="o">=</span> <span class="n">xd_getgeo</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">xd_wait_int</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">xd_drives</span><span class="p">,</span> <span class="n">xd_irq</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">xd_dma</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">xd_maxsectors</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">xd_override</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xd_type</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x320</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xd_geo</span><span class="p">[</span><span class="n">XD_MAXDRIVES</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">xdc_busy</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">xd_watchdog_int</span><span class="p">;</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="n">u_char</span> <span class="n">xd_error</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nodma</span> <span class="o">=</span> <span class="n">XD_DONT_USE_DMA</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">xd_queue</span><span class="p">;</span>

<span class="cm">/* xd_init: register the block device number and set up pointer tables */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">i</span><span class="p">,</span><span class="n">controller</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>
	<span class="p">{</span>
		<span class="n">u_char</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">xd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xd</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">count</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">xd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">))</span>
			<span class="n">do_xd_setup</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">init_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">xd_watchdog_int</span><span class="p">);</span> <span class="n">xd_watchdog_int</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">xd_watchdog</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_blkdev</span><span class="p">(</span><span class="n">XT_DISK_MAJOR</span><span class="p">,</span> <span class="s">&quot;xd&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">xd_queue</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">do_xd_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xd_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_detect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span><span class="o">&amp;</span><span class="n">address</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Detected a%s controller (type %d) at address %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">xd_sigs</span><span class="p">[</span><span class="n">controller</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="n">controller</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">xd_iobase</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s">&quot;xd&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: Ports at 0x%x are not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">xd_iobase</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="p">)</span>
			<span class="n">xd_sigs</span><span class="p">[</span><span class="n">controller</span><span class="p">].</span><span class="n">init_controller</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
		<span class="n">xd_drives</span> <span class="o">=</span> <span class="n">xd_initdrives</span><span class="p">(</span><span class="n">xd_sigs</span><span class="p">[</span><span class="n">controller</span><span class="p">].</span><span class="n">init_drive</span><span class="p">);</span>
		
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Detected %d hard drive%s (using IRQ%d &amp; DMA%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">xd_drives</span><span class="p">,</span><span class="n">xd_drives</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;s&quot;</span><span class="p">,</span><span class="n">xd_irq</span><span class="p">,</span><span class="n">xd_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * With the drive detected, xd_maxsectors should now be known.</span>
<span class="cm">	 * If xd_maxsectors is 0, nothing was detected and we fall through</span>
<span class="cm">	 * to return -ENODEV</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_dma_buffer</span> <span class="o">&amp;&amp;</span> <span class="n">xd_maxsectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xd_dma_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xd_dma_mem_alloc</span><span class="p">(</span><span class="n">xd_maxsectors</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_dma_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xd: Out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_drives</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xd_drives</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XD_INFO</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xd_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">XT_DISK_MAJOR</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;xd%c&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="sc">&#39;a&#39;</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xd_fops</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">xd_queue</span><span class="p">;</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s: CHS=%d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
		<span class="n">xd_gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">xd_irq</span><span class="p">,</span><span class="n">xd_interrupt_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;XT hard disk&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: unable to get IRQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">xd_irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">,</span><span class="s">&quot;xd&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: unable to get DMA%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">xd_dma</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* xd_maxsectors depends on controller - so set after detection */</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">xd_queue</span><span class="p">,</span> <span class="n">xd_maxsectors</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xd_drives</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">add_disk</span><span class="p">(</span><span class="n">xd_gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out5:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">xd_irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out4:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xd_drives</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">xd_gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="nl">out3:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd_maxsectors</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">xd_iobase</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_dma_buffer</span><span class="p">)</span>
		<span class="n">xd_dma_mem_free</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xd_dma_buffer</span><span class="p">,</span>
				<span class="n">xd_maxsectors</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">xd_queue</span><span class="p">);</span>
<span class="nl">out1a:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">XT_DISK_MAJOR</span><span class="p">,</span> <span class="s">&quot;xd&quot;</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">Enomem:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">xd_gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_detect: scan the possible BIOS ROM locations for the signature strings */</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">__init</span> <span class="nf">xd_detect</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">controller</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_override</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="o">*</span><span class="n">controller</span> <span class="o">=</span> <span class="n">xd_type</span><span class="p">;</span>
		<span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xd_bases</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">xd_bases</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xd_sigs</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">xd_sigs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">string</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_signature</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">xd_sigs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">controller</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">xd_type</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">xd_bases</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* do_xd_request: handle an incoming request */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_xd_request</span> <span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xdc_busy</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">block</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">count</span> <span class="o">=</span> <span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">XD_INFO</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="n">XD_RETRIES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">res</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">xd_readwrite</span><span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">disk</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
					   <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="nl">done:</span>
		<span class="cm">/* wrap up, 0 = success, -errno = fail */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__blk_end_request_cur</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XD_INFO</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_ioctl: handle device ioctl&#39;s */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_locked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HDIO_SET_DMA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xdc_busy</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">nodma</span> <span class="o">=</span> <span class="o">!</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nodma</span> <span class="o">&amp;&amp;</span> <span class="n">xd_dma_buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xd_dma_mem_free</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xd_dma_buffer</span><span class="p">,</span>
						<span class="n">xd_maxsectors</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
				<span class="n">xd_dma_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nodma</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xd_dma_buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xd_dma_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xd_dma_mem_alloc</span><span class="p">(</span><span class="n">xd_maxsectors</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_dma_buffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nodma</span> <span class="o">=</span> <span class="n">XD_DONT_USE_DMA</span><span class="p">;</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDIO_GET_DMA</span>:
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="o">!</span><span class="n">nodma</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">HDIO_GET_MULTCOUNT</span>:
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">xd_maxsectors</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xd_locked_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_readwrite: handle a read/write request */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_readwrite</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">operation</span><span class="p">,</span><span class="n">XD_INFO</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="n">u_int</span> <span class="n">block</span><span class="p">,</span><span class="n">u_int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">sense</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u_short</span> <span class="n">track</span><span class="p">,</span><span class="n">cylinder</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">head</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">control</span><span class="p">,</span><span class="n">mode</span> <span class="o">=</span> <span class="n">PIO_MODE</span><span class="p">,</span><span class="n">temp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">real_buffer</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
<span class="cp">#ifdef DEBUG_READWRITE</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_readwrite: operation = %s, drive = %d, buffer = 0x%X, block = %d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">operation</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_READWRITE */</span><span class="cp"></span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_lock</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_dma_buffer</span><span class="p">)</span>
		<span class="n">xd_dma_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xd_dma_mem_alloc</span><span class="p">(</span><span class="n">xd_maxsectors</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">xd_maxsectors</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">xd_maxsectors</span><span class="p">;</span>

		<span class="n">track</span> <span class="o">=</span> <span class="n">block</span> <span class="o">/</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">track</span> <span class="o">%</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
		<span class="n">cylinder</span> <span class="o">=</span> <span class="n">track</span> <span class="o">/</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
		<span class="n">sector</span> <span class="o">=</span> <span class="n">block</span> <span class="o">%</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_READWRITE</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_readwrite: drive = %d, head = %d, cylinder = %d, sector = %d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">cylinder</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_READWRITE */</span><span class="cp"></span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xd_dma_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">xd_setup_dma</span><span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="n">DMA_MODE_READ</span> <span class="o">:</span> <span class="n">DMA_MODE_WRITE</span><span class="p">,(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)(</span><span class="n">xd_dma_buffer</span><span class="p">),</span><span class="n">temp</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
			<span class="n">real_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xd_dma_buffer</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">xd_dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">real_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">;</span>

		<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">operation</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="n">CMD_READ</span> <span class="o">:</span> <span class="n">CMD_WRITE</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">cylinder</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span><span class="n">control</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">mode</span><span class="p">,(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">real_buffer</span><span class="p">),(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">real_buffer</span><span class="p">),</span><span class="n">sense</span><span class="p">,</span><span class="n">XD_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd%c: %s timeout, recalibrating drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">,(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">));</span>
				<span class="n">xd_recalibrate</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd%c: %s - &quot;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">,(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="s">&quot;reading&quot;</span> <span class="o">:</span> <span class="s">&quot;writing&quot;</span><span class="p">));</span>
					<span class="k">switch</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mi">0</span>: <span class="n">printk</span><span class="p">(</span><span class="s">&quot;drive error, code = 0x%X&quot;</span><span class="p">,</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">1</span>: <span class="n">printk</span><span class="p">(</span><span class="s">&quot;controller error, code = 0x%X&quot;</span><span class="p">,</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">2</span>: <span class="n">printk</span><span class="p">(</span><span class="s">&quot;command error, code = 0x%X&quot;</span><span class="p">,</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">3</span>: <span class="n">printk</span><span class="p">(</span><span class="s">&quot;miscellaneous error, code = 0x%X&quot;</span><span class="p">,</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - CHS = %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,((</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">,</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
				<span class="cm">/*	reported drive number = (sense[1] &amp; 0xE0) &gt;&gt; 5 */</span>
				<span class="k">else</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - no valid disk address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_dma_buffer</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xd_dma_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">count</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+=</span> <span class="n">temp</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">block</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_recalibrate: recalibrate a given drive and reset controller if necessary */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_recalibrate</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	
	<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_RECALIBRATE</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd%c: warning! error recalibrating, controller may be unstable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* xd_interrupt_handler: interrupt service routine */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">xd_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">XD_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>							<span class="cm">/* check if it was our device */</span>
<span class="cp">#ifdef DEBUG_OTHER</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_interrupt_handler: interrupt detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_OTHER */</span><span class="cp"></span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XD_CONTROL</span><span class="p">);</span>								<span class="cm">/* acknowledge interrupt */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_wait_int</span><span class="p">);</span>	<span class="cm">/* and wake up sleeping processes */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: unexpected interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_setup_dma: set up the DMA controller for a data transfer */</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="nf">xd_setup_dma</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">mode</span><span class="p">,</span><span class="n">u_char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="n">u_int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">nodma</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">PIO_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_OTHER</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_setup_dma: using PIO, transfer overlaps 64k boundary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_OTHER */</span><span class="cp"></span>
		<span class="k">return</span> <span class="p">(</span><span class="n">PIO_MODE</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">f</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">);</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">,</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
	
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">DMA_MODE</span><span class="p">);</span>			<span class="cm">/* use DMA and INT */</span>
<span class="p">}</span>

<span class="cm">/* xd_build: put stuff into an array in a format suitable for the controller */</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="o">*</span><span class="nf">xd_build</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">u_char</span> <span class="n">command</span><span class="p">,</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">,</span><span class="n">u_char</span> <span class="n">head</span><span class="p">,</span><span class="n">u_short</span> <span class="n">cylinder</span><span class="p">,</span><span class="n">u_char</span> <span class="n">sector</span><span class="p">,</span><span class="n">u_char</span> <span class="n">count</span><span class="p">,</span><span class="n">u_char</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">drive</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">head</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">cylinder</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinder</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">control</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="p">(</span><span class="n">cmdblk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_watchdog</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xd_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_wait_int</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* xd_waitport: waits until port &amp; mask == flags or a timeout occurs. return 1 for a timeout */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_char</span> <span class="nf">xd_waitport</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">port</span><span class="p">,</span><span class="n">u_char</span> <span class="n">flags</span><span class="p">,</span><span class="n">u_char</span> <span class="n">mask</span><span class="p">,</span><span class="n">u_long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">expiry</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">success</span><span class="p">;</span>

	<span class="n">xdc_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">success</span> <span class="o">=</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expiry</span><span class="p">))</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">xdc_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">success</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_int</span> <span class="nf">xd_wait_for_IRQ</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">xd_watchdog_int</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_watchdog_int</span><span class="p">);</span>
	
	<span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	
	<span class="n">sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_wait_int</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd_watchdog_int</span><span class="p">);</span>
	<span class="n">xdc_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">xd_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: missed IRQ - command aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xd_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* xd_command: handle all data transfers necessary for a single command */</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="nf">xd_command</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">command</span><span class="p">,</span><span class="n">u_char</span> <span class="n">mode</span><span class="p">,</span><span class="n">u_char</span> <span class="o">*</span><span class="n">indata</span><span class="p">,</span><span class="n">u_char</span> <span class="o">*</span><span class="n">outdata</span><span class="p">,</span><span class="n">u_char</span> <span class="o">*</span><span class="n">sense</span><span class="p">,</span><span class="n">u_long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">csb</span><span class="p">,</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_COMMAND</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_command: command = 0x%X, mode = 0x%X, indata = 0x%X, outdata = 0x%X, sense = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span><span class="n">indata</span><span class="p">,</span><span class="n">outdata</span><span class="p">,</span><span class="n">sense</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_COMMAND */</span><span class="cp"></span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XD_SELECT</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span><span class="n">XD_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_waitport</span><span class="p">(</span><span class="n">XD_STATUS</span><span class="p">,</span><span class="n">STAT_SELECT</span><span class="p">,</span><span class="n">STAT_SELECT</span><span class="p">,</span><span class="n">timeout</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_waitport</span><span class="p">(</span><span class="n">XD_STATUS</span><span class="p">,</span><span class="n">STAT_READY</span><span class="p">,</span><span class="n">STAT_READY</span><span class="p">,</span><span class="n">timeout</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">XD_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_COMMAND</span> <span class="o">|</span> <span class="n">STAT_INPUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DMA_MODE</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">xd_wait_for_IRQ</span><span class="p">())</span>
						<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">outdata</span> <span class="o">?</span> <span class="o">*</span><span class="n">outdata</span><span class="o">++</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span><span class="n">XD_DATA</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STAT_INPUT</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DMA_MODE</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">xd_wait_for_IRQ</span><span class="p">())</span>
						<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">indata</span><span class="p">)</span>
						<span class="o">*</span><span class="n">indata</span><span class="o">++</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">XD_DATA</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">inb</span><span class="p">(</span><span class="n">XD_DATA</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STAT_COMMAND</span>:
				<span class="n">outb</span><span class="p">(</span><span class="n">command</span> <span class="o">?</span> <span class="o">*</span><span class="n">command</span><span class="o">++</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span><span class="n">XD_DATA</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STAT_COMMAND</span> <span class="o">|</span> <span class="n">STAT_INPUT</span>:
				<span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">csb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">XD_DATA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_waitport</span><span class="p">(</span><span class="n">XD_STATUS</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">STAT_SELECT</span><span class="p">,</span><span class="n">timeout</span><span class="p">))</span>					<span class="cm">/* wait until deselected */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csb</span> <span class="o">&amp;</span> <span class="n">CSB_ERROR</span><span class="p">)</span> <span class="p">{</span>									<span class="cm">/* read sense data if error */</span>
		<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_SENSE</span><span class="p">,(</span><span class="n">csb</span> <span class="o">&amp;</span> <span class="n">CSB_LUN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sense</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: warning! sense command failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG_COMMAND</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_command: completed with csb = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">csb</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_COMMAND */</span><span class="cp"></span>

	<span class="k">return</span> <span class="p">(</span><span class="n">csb</span> <span class="o">&amp;</span> <span class="n">CSB_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">__init</span> <span class="nf">xd_initdrives</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_drive</span><span class="p">)(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XD_MAXDRIVES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_TESTREADY</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">XD_INIT_DISK_DELAY</span><span class="p">);</span>

			<span class="n">init_drive</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>

			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">XD_INIT_DISK_DELAY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_manual_geo_set</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">drive</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">drive</span><span class="p">]);</span>
	<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">drive</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_dtc_init_controller</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00000</span>:
		<span class="k">case</span> <span class="mh">0xC8000</span>:	<span class="k">break</span><span class="p">;</span>			<span class="cm">/*initial: 0x320 */</span>
		<span class="k">case</span> <span class="mh">0xCA000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x324</span><span class="p">;</span> 
		<span class="k">case</span> <span class="mh">0xD0000</span>:				<span class="cm">/*5150CX*/</span>
		<span class="k">case</span> <span class="mh">0xD8000</span>:	<span class="k">break</span><span class="p">;</span>			<span class="cm">/*5150CX &amp; 5150XL*/</span>
		<span class="nl">default:</span>        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_dtc_init_controller: unsupported BIOS address %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xd_maxsectors</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>		<span class="cm">/* my card seems to have trouble doing multi-block transfers? */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XD_RESET</span><span class="p">);</span>		<span class="cm">/* reset the controller */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_dtc5150cx_init_drive</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* values from controller&#39;s BIOS - BIOS chip may be removed */</span>
	<span class="k">static</span> <span class="n">u_short</span> <span class="n">geometry_table</span><span class="p">[][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x200</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x100</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x267</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x267</span><span class="p">,</span><span class="mh">0x267</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x264</span><span class="p">,</span><span class="mh">0x80</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x132</span><span class="p">,</span><span class="mh">0x0</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x132</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x177</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x177</span><span class="p">,</span><span class="mh">0x0</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">},</span>
		<span class="p">{},</span>  <span class="cm">/* not used */</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x200</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x100</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x264</span><span class="p">,</span><span class="mh">0x80</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x280</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x280</span><span class="p">,</span><span class="mh">0x100</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2B9</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x2B9</span><span class="p">,</span><span class="mh">0x2B9</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2B9</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x2B9</span><span class="p">,</span><span class="mh">0x2B9</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x280</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x280</span><span class="p">,</span><span class="mh">0x100</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x132</span><span class="p">,</span><span class="mh">0x0</span><span class="p">}};</span>
	<span class="n">u_char</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">XD_JUMPER</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">drive</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x33</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">|</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">drive</span><span class="p">])</span>
		<span class="n">xd_manual_geo_set</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>	
			<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>			<span class="cm">/* heads */</span>
			<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* cylinders */</span>
			<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>				<span class="cm">/* sectors */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			xd_info[drive].rwrite = geometry_table[n][2];	/* reduced write */</span>
<span class="c">			xd_info[drive].precomp = geometry_table[n][3]		/* write precomp */</span>
<span class="c">			xd_info[drive].ecc = 0x0B;				/* ecc length */</span>
<span class="cp">#endif /* 0 */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd%c: undetermined drive geometry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>				<span class="cm">/* control byte */</span>
	<span class="n">xd_setparam</span><span class="p">(</span><span class="n">CMD_DTCSETPARAM</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span><span class="p">,</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="mh">0x0B</span><span class="p">);</span>
	<span class="n">xd_recalibrate</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_dtc_init_drive</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_DTCGETGEOM</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x0A</span><span class="p">];</span>			<span class="cm">/* heads */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span><span class="p">))[</span><span class="mh">0x04</span><span class="p">];</span>	<span class="cm">/* cylinders */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>				<span class="cm">/* sectors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">drive</span><span class="p">])</span>
			<span class="n">xd_manual_geo_set</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		xd_info[drive].rwrite = ((u_short *) (buf + 1))[0x05];	/* reduced write */</span>
<span class="c">		xd_info[drive].precomp = ((u_short *) (buf + 1))[0x06];	/* write precomp */</span>
<span class="c">		xd_info[drive].ecc = buf[0x0F];				/* ecc length */</span>
<span class="cp">#endif /* 0 */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* control byte */</span>

		<span class="n">xd_setparam</span><span class="p">(</span><span class="n">CMD_DTCSETPARAM</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span><span class="p">,((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[</span><span class="mh">0x05</span><span class="p">],((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[</span><span class="mh">0x06</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]);</span>
		<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_DTCSETSTEP</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_dtc_init_drive: error setting step rate for xd%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_dtc_init_drive: error reading geometry for xd%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_wd_init_controller</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00000</span>:
		<span class="k">case</span> <span class="mh">0xC8000</span>:	<span class="k">break</span><span class="p">;</span>			<span class="cm">/*initial: 0x320 */</span>
		<span class="k">case</span> <span class="mh">0xCA000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x324</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xCC000</span>:   <span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x328</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xCE000</span>:   <span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x32C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xD0000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x328</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* ? */</span>
		<span class="k">case</span> <span class="mh">0xD8000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x32C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* ? */</span>
		<span class="nl">default:</span>        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_wd_init_controller: unsupported BIOS address %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xd_maxsectors</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>		<span class="cm">/* this one doesn&#39;t wrap properly either... */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XD_RESET</span><span class="p">);</span>		<span class="cm">/* reset the controller */</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">XD_INIT_DISK_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_wd_init_drive</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* values from controller&#39;s BIOS - BIOS may be disabled */</span>
	<span class="k">static</span> <span class="n">u_short</span> <span class="n">geometry_table</span><span class="p">[][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x1C2</span><span class="p">,</span><span class="mh">0x1C2</span><span class="p">},</span>   <span class="cm">/* common part */</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x099</span><span class="p">,</span><span class="mh">0x0</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x267</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x1C2</span><span class="p">,</span><span class="mh">0x1C2</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x267</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x1C2</span><span class="p">,</span><span class="mh">0x1C2</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0x334</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x335</span><span class="p">,</span><span class="mh">0x335</span><span class="p">},</span>   <span class="cm">/* 1004 series RLL */</span>
		<span class="p">{</span><span class="mh">0x30E</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x30F</span><span class="p">,</span><span class="mh">0x3DC</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x30E</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x30F</span><span class="p">,</span><span class="mh">0x30F</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x267</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x268</span><span class="p">,</span><span class="mh">0x268</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0x3D5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x3D6</span><span class="p">,</span><span class="mh">0x3D6</span><span class="p">},</span>   <span class="cm">/* 1002 series RLL */</span>
		<span class="p">{</span><span class="mh">0x3DB</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x3DC</span><span class="p">,</span><span class="mh">0x3DC</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x265</span><span class="p">,</span><span class="mh">0x265</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x267</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x268</span><span class="p">,</span><span class="mh">0x268</span><span class="p">}};</span>

	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x200</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">rll</span><span class="p">,</span><span class="n">jumper_state</span><span class="p">,</span><span class="n">use_jumper_geo</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">wd_1002</span> <span class="o">=</span> <span class="p">(</span><span class="n">xd_sigs</span><span class="p">[</span><span class="n">xd_type</span><span class="p">].</span><span class="n">string</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;6&#39;</span><span class="p">);</span>
	
	<span class="n">jumper_state</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x322</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jumper_state</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">xd_irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">rll</span> <span class="o">=</span> <span class="p">(</span><span class="n">jumper_state</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&lt;&lt;</span> <span class="n">wd_1002</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_READ</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1AF</span><span class="p">];</span>				<span class="cm">/* heads */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[</span><span class="mh">0xD6</span><span class="p">];</span>	<span class="cm">/* cylinders */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>					<span class="cm">/* sectors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">drive</span><span class="p">])</span>
			<span class="n">xd_manual_geo_set</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		xd_info[drive].rwrite = ((u_short *) (buf))[0xD8];		/* reduced write */</span>
<span class="c">		xd_info[drive].wprecomp = ((u_short *) (buf))[0xDA];		/* write precomp */</span>
<span class="c">		xd_info[drive].ecc = buf[0x1B4];				/* ecc length */</span>
<span class="cp">#endif /* 0 */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1B5</span><span class="p">];</span>				<span class="cm">/* control byte */</span>
		<span class="n">use_jumper_geo</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">drive</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">xd_manual_geo_set</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
			<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">rll</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_jumper_geo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="p">(((</span><span class="n">jumper_state</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span> <span class="n">rll</span><span class="p">;</span>
			<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">rll</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			xd_info[drive].rwrite = geometry_table[n][2];</span>
<span class="c">			xd_info[drive].wprecomp = geometry_table[n][3];</span>
<span class="c">			xd_info[drive].ecc = 0x0B;</span>
<span class="cp">#endif /* 0 */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wd_1002</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_jumper_geo</span><span class="p">)</span>
				<span class="n">xd_setparam</span><span class="p">(</span><span class="n">CMD_WDSETPARAM</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span><span class="p">,</span>
					<span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="mh">0x0B</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">xd_setparam</span><span class="p">(</span><span class="n">CMD_WDSETPARAM</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span><span class="p">,</span>
					<span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span><span class="p">))[</span><span class="mh">0xD8</span><span class="p">],((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span><span class="p">))[</span><span class="mh">0xDA</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x1B4</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="cm">/* 1002 based RLL controller requests converted addressing, but reports physical </span>
<span class="cm">	   (physical 26 sec., logical 17 sec.) </span>
<span class="cm">	   1004 based ???? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rll</span> <span class="o">&amp;</span> <span class="n">wd_1002</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">*=</span> <span class="mi">26</span><span class="p">,</span>
			     <span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">/=</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1023</span><span class="p">)</span>
				<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>  <span class="cm">/* 1024 ? */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			xd_info[drive].rwrite *= 26; </span>
<span class="c">			xd_info[drive].rwrite /= 17;</span>
<span class="c">			xd_info[drive].wprecomp *= 26</span>
<span class="c">			xd_info[drive].wprecomp /= 17;</span>
<span class="cp">#endif /* 0 */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_wd_init_drive: error reading geometry for xd%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>	

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_seagate_init_controller</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00000</span>:
		<span class="k">case</span> <span class="mh">0xC8000</span>:	<span class="k">break</span><span class="p">;</span>			<span class="cm">/*initial: 0x320 */</span>
		<span class="k">case</span> <span class="mh">0xD0000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x324</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xD8000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x328</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xE0000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x32C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_seagate_init_controller: unsupported BIOS address %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xd_maxsectors</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XD_RESET</span><span class="p">);</span>		<span class="cm">/* reset the controller */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_seagate_init_drive</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x200</span><span class="p">];</span>

	<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_ST11GETGEOM</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x04</span><span class="p">];</span>				<span class="cm">/* heads */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x03</span><span class="p">];</span>	<span class="cm">/* cylinders */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x05</span><span class="p">];</span>				<span class="cm">/* sectors */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>					<span class="cm">/* control byte */</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_seagate_init_drive: error reading geometry from xd%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Omti support courtesy Dirk Melchers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_omti_init_controller</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00000</span>:
		<span class="k">case</span> <span class="mh">0xC8000</span>:	<span class="k">break</span><span class="p">;</span>			<span class="cm">/*initial: 0x320 */</span>
		<span class="k">case</span> <span class="mh">0xD0000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x324</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xD8000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x328</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xE0000</span>:	<span class="n">xd_iobase</span> <span class="o">=</span> <span class="mh">0x32C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_omti_init_controller: unsupported BIOS address %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">xd_maxsectors</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XD_RESET</span><span class="p">);</span>		<span class="cm">/* reset the controller */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_omti_init_drive</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* gets infos from drive */</span>
	<span class="n">xd_override_init_drive</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="cm">/* set other parameters, Hardcoded, not that nice :-) */</span>
	<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Xebec support (AK) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_xebec_init_controller</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* iobase may be set manually in range 0x300 - 0x33C</span>
<span class="cm">      irq may be set manually to 2(9),3,4,5,6,7</span>
<span class="cm">      dma may be set manually to 1,2,3</span>
<span class="cm">	(How to detect them ???)</span>
<span class="cm">BIOS address may be set manually in range 0x0 - 0xF8000</span>
<span class="cm">If you need non-standard settings use the xd=... command */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00000</span>:
		<span class="k">case</span> <span class="mh">0xC8000</span>:	<span class="cm">/* initially: xd_iobase==0x320 */</span>
		<span class="k">case</span> <span class="mh">0xD0000</span>:
		<span class="k">case</span> <span class="mh">0xD2000</span>:
		<span class="k">case</span> <span class="mh">0xD4000</span>:
		<span class="k">case</span> <span class="mh">0xD6000</span>:
		<span class="k">case</span> <span class="mh">0xD8000</span>:
		<span class="k">case</span> <span class="mh">0xDA000</span>:
		<span class="k">case</span> <span class="mh">0xDC000</span>:
		<span class="k">case</span> <span class="mh">0xDE000</span>:
		<span class="k">case</span> <span class="mh">0xE0000</span>:	<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd_xebec_init_controller: unsupported BIOS address %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">xd_maxsectors</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XD_RESET</span><span class="p">);</span>		<span class="cm">/* reset the controller */</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">XD_INIT_DISK_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_xebec_init_drive</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* values from controller&#39;s BIOS - BIOS chip may be removed */</span>
	<span class="k">static</span> <span class="n">u_short</span> <span class="n">geometry_table</span><span class="p">[][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x17</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x17</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x132</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x080</span><span class="p">,</span><span class="mh">0x17</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x6</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x17</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2BC</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x2BC</span><span class="p">,</span><span class="mh">0x12C</span><span class="p">,</span><span class="mh">0x6</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x3A5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x3A5</span><span class="p">,</span><span class="mh">0x3A5</span><span class="p">,</span><span class="mh">0x7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x26C</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x26C</span><span class="p">,</span><span class="mh">0x26C</span><span class="p">,</span><span class="mh">0x7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x200</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="mh">0x17</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x400</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span><span class="mh">0x7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x400</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span><span class="mh">0x7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x264</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x264</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x17</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x33E</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x33E</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x7</span><span class="p">}};</span>
	<span class="n">u_char</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">XD_JUMPER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span> <span class="cm">/* BIOS&#39;s drive number: same geometry </span>
<span class="cm">					is assumed for BOTH drives */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">drive</span><span class="p">])</span>
		<span class="n">xd_manual_geo_set</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>			<span class="cm">/* heads */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* cylinders */</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>				<span class="cm">/* sectors */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		xd_info[drive].rwrite = geometry_table[n][2];	/* reduced write */</span>
<span class="c">		xd_info[drive].precomp = geometry_table[n][3]		/* write precomp */</span>
<span class="c">		xd_info[drive].ecc = 0x0B;				/* ecc length */</span>
<span class="cp">#endif /* 0 */</span>
	<span class="p">}</span>
	<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>			<span class="cm">/* control byte */</span>
	<span class="n">xd_setparam</span><span class="p">(</span><span class="n">CMD_XBSETPARAM</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span><span class="p">,</span><span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span><span class="p">,</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">geometry_table</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="mh">0x0B</span><span class="p">);</span>
	<span class="n">xd_recalibrate</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* xd_override_init_drive: this finds disk geometry in a &quot;binary search&quot; style, narrowing in on the &quot;correct&quot; number of heads</span>
<span class="cm">   etc. by trying values until it gets the highest successful value. Idea courtesy Salvador Abreu (spa@fct.unl.pt). */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_override_init_drive</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">min</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">},</span><span class="n">max</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">16</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mi">64</span> <span class="p">},</span><span class="n">test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">};</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_geo</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">drive</span><span class="p">])</span>
		<span class="n">xd_manual_geo_set</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">max</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">CMD_SEEK</span><span class="p">,</span><span class="n">drive</span><span class="p">,(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">test</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
					<span class="n">min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_setup: initialise controller from command line parameters */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">do_xd_setup</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">integers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">integers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="k">if</span> <span class="p">(</span><span class="n">integers</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">nodma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">integers</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">xd_dma</span> <span class="o">=</span> <span class="n">integers</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="k">if</span> <span class="p">((</span><span class="n">integers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">integers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x3FC</span><span class="p">))</span>
				<span class="n">xd_iobase</span> <span class="o">=</span> <span class="n">integers</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="k">if</span> <span class="p">((</span><span class="n">integers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">integers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span>
				<span class="n">xd_irq</span> <span class="o">=</span> <span class="n">integers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">xd_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">integers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">integers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xd_sigs</span><span class="p">)))</span>
				<span class="n">xd_type</span> <span class="o">=</span> <span class="n">integers</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: too many parameters for xd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xd_maxsectors</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_setparam: set the drive characteristics */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xd_setparam</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">command</span><span class="p">,</span><span class="n">u_char</span> <span class="n">drive</span><span class="p">,</span><span class="n">u_char</span> <span class="n">heads</span><span class="p">,</span><span class="n">u_short</span> <span class="n">cylinders</span><span class="p">,</span><span class="n">u_short</span> <span class="n">rwrite</span><span class="p">,</span><span class="n">u_short</span> <span class="n">wprecomp</span><span class="p">,</span><span class="n">u_char</span> <span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">cmdblk</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>

	<span class="n">xd_build</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">drive</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">cylinders</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">cylinders</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">rwrite</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">rwrite</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">wprecomp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">wprecomp</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">cmdblk</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecc</span><span class="p">;</span>

	<span class="cm">/* Some controllers require geometry info as data, not command */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_command</span><span class="p">(</span><span class="n">cmdblk</span><span class="p">,</span><span class="n">PIO_MODE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cmdblk</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="nb">NULL</span><span class="p">,</span><span class="n">XD_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: error setting characteristics for xd%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef MODULE</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">xd_geo</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nodma</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">XT_DISK_MAJOR</span><span class="p">,</span> <span class="s">&quot;xd&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xd_drives</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_gendisk</span><span class="p">(</span><span class="n">xd_gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">xd_gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">xd_queue</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">xd_iobase</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd_drives</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">xd_irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">xd_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_dma_buffer</span><span class="p">)</span>
			<span class="n">xd_dma_mem_free</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xd_dma_buffer</span><span class="p">,</span> <span class="n">xd_maxsectors</span> <span class="o">*</span> <span class="mh">0x200</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xd_setup</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">get_options</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span> <span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">do_xd_setup</span> <span class="p">(</span><span class="n">ints</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xd_manual_geo_init: initialise drive geometry from command line parameters</span>
<span class="cm">   (used only for WD drives) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xd_manual_geo_init</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">integers</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">XD_MAXDRIVES</span><span class="p">];</span>

	<span class="n">get_options</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span> <span class="p">(</span><span class="n">integers</span><span class="p">),</span> <span class="n">integers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">integers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;xd: incorrect number of parameters for xd_geo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">integers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">XD_MAXDRIVES</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">xd_geo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">integers</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span> <span class="p">(</span><span class="s">&quot;xd=&quot;</span><span class="p">,</span> <span class="n">xd_setup</span><span class="p">);</span>
<span class="n">__setup</span> <span class="p">(</span><span class="s">&quot;xd_geo=&quot;</span><span class="p">,</span> <span class="n">xd_manual_geo_init</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="n">module_init</span><span class="p">(</span><span class="n">xd_init</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_BLOCKDEV_MAJOR</span><span class="p">(</span><span class="n">XT_DISK_MAJOR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
