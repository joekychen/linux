<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › sunvdc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sunvdc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* sunvdc.c: Sun LDOM Virtual Disk Client.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007, 2008 David S. Miller &lt;davem@davemloft.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &lt;asm/vio.h&gt;</span>
<span class="cp">#include &lt;asm/ldc.h&gt;</span>

<span class="cp">#define DRV_MODULE_NAME		&quot;sunvdc&quot;</span>
<span class="cp">#define PFX DRV_MODULE_NAME	&quot;: &quot;</span>
<span class="cp">#define DRV_MODULE_VERSION	&quot;1.0&quot;</span>
<span class="cp">#define DRV_MODULE_RELDATE	&quot;June 25, 2007&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
	<span class="n">DRV_MODULE_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_MODULE_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_MODULE_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David S. Miller (davem@davemloft.net)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun LDOM virtual disk client driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>

<span class="cp">#define VDC_TX_RING_SIZE	256</span>

<span class="cp">#define WAITING_FOR_LINK_UP	0x01</span>
<span class="cp">#define WAITING_FOR_TX_SPACE	0x02</span>
<span class="cp">#define WAITING_FOR_GEN_CMD	0x04</span>
<span class="cp">#define WAITING_FOR_ANY		-1</span>

<span class="k">struct</span> <span class="n">vdc_req_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vdc_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_driver_state</span>	<span class="n">vio</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">gendisk</span>		<span class="o">*</span><span class="n">disk</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vdc_completion</span>	<span class="o">*</span><span class="n">cmp</span><span class="p">;</span>

	<span class="n">u64</span>			<span class="n">req_id</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vdc_req_entry</span>	<span class="n">rq_arr</span><span class="p">[</span><span class="n">VDC_TX_RING_SIZE</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">ring_cookies</span><span class="p">;</span>

	<span class="n">u64</span>			<span class="n">max_xfer_size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">vdisk_block_size</span><span class="p">;</span>

	<span class="cm">/* The server fills these in for us in the disk attribute</span>
<span class="cm">	 * ACK packet.</span>
<span class="cm">	 */</span>
	<span class="n">u64</span>			<span class="n">operations</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">vdisk_size</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">vdisk_type</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="n">disk_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">vio_disk_geom</span>	<span class="n">geom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vio_disk_vtoc</span>	<span class="n">label</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="nf">to_vdc_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vdc_port</span><span class="p">,</span> <span class="n">vio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Ordered from largest major to lowest */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vio_version</span> <span class="n">vdc_versions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define VDCBLK_NAME	&quot;vdisk&quot;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vdc_major</span><span class="p">;</span>
<span class="cp">#define PARTITION_SHIFT	3</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">vdc_tx_dring_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vio_dring_avail</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">VDC_TX_RING_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vdc_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">num_hd</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">num_sec</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">num_cyl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">vdc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span>		<span class="o">=</span> <span class="n">vdc_getgeo</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vdc_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="kt">int</span> <span class="n">waiting_for</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vio</span><span class="o">-&gt;</span><span class="n">cmp</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">waiting_for</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
	     <span class="n">vio</span><span class="o">-&gt;</span><span class="n">cmp</span><span class="o">-&gt;</span><span class="n">waiting_for</span> <span class="o">==</span> <span class="n">waiting_for</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vio</span><span class="o">-&gt;</span><span class="n">cmp</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vio</span><span class="o">-&gt;</span><span class="n">cmp</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">);</span>
		<span class="n">vio</span><span class="o">-&gt;</span><span class="n">cmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vdc_handshake_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vdc_finish</span><span class="p">(</span><span class="n">vio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WAITING_FOR_LINK_UP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vdc_handle_unknown</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Received unknown msg [%02x:%02x:%04x:%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stype</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">stype_env</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Resetting connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ldc_disconnect</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lp</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vdc_send_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">to_vdc_port</span><span class="p">(</span><span class="n">vio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vio_disk_attr_info</span> <span class="n">pkt</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="p">));</span>

	<span class="n">pkt</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIO_TYPE_CTRL</span><span class="p">;</span>
	<span class="n">pkt</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">stype</span> <span class="o">=</span> <span class="n">VIO_SUBTYPE_INFO</span><span class="p">;</span>
	<span class="n">pkt</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">stype_env</span> <span class="o">=</span> <span class="n">VIO_ATTR_INFO</span><span class="p">;</span>
	<span class="n">pkt</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">vio_send_sid</span><span class="p">(</span><span class="n">vio</span><span class="p">);</span>

	<span class="n">pkt</span><span class="p">.</span><span class="n">xfer_mode</span> <span class="o">=</span> <span class="n">VIO_DRING_MODE</span><span class="p">;</span>
	<span class="n">pkt</span><span class="p">.</span><span class="n">vdisk_block_size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">;</span>
	<span class="n">pkt</span><span class="p">.</span><span class="n">max_xfer_size</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span><span class="p">;</span>

	<span class="n">viodbg</span><span class="p">(</span><span class="n">HS</span><span class="p">,</span> <span class="s">&quot;SEND ATTR xfer_mode[0x%x] blksz[%u] max_xfer[%llu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pkt</span><span class="p">.</span><span class="n">xfer_mode</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">vdisk_block_size</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">max_xfer_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vio_ldc_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vdc_handle_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">to_vdc_port</span><span class="p">(</span><span class="n">vio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vio_disk_attr_info</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">viodbg</span><span class="p">(</span><span class="n">HS</span><span class="p">,</span> <span class="s">&quot;GOT ATTR stype[0x%x] ops[%llx] disk_size[%llu] disk_type[%x] &quot;</span>
	       <span class="s">&quot;xfer_mode[0x%x] blksz[%u] max_xfer[%llu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">.</span><span class="n">stype</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">operations</span><span class="p">,</span>
	       <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_size</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_type</span><span class="p">,</span>
	       <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">xfer_mode</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">,</span>
	       <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">.</span><span class="n">stype</span> <span class="o">==</span> <span class="n">VIO_SUBTYPE_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VD_DISK_TYPE_DISK</span>:
		<span class="k">case</span> <span class="n">VD_DISK_TYPE_SLICE</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Bogus vdisk_type 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">vio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_type</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span> <span class="o">&gt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: BLOCK size increased &quot;</span>
			       <span class="s">&quot;%u --&gt; %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">vio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">operations</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">operations</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_size</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_size</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_type</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Attribute NACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vdc_end_special</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_disk_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">vdc_finish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">,</span> <span class="n">WAITING_FOR_GEN_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vdc_end_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_disk_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">vio_dring_entry</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vdc_req_entry</span> <span class="o">*</span><span class="n">rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rq_arr</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">VIO_DESC_DONE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ldc_unmap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lp</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">cookies</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">ncookies</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIO_DESC_FREE</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VDC_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">rqe</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdc_end_special</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rqe</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_queue_stopped</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">blk_start_queue</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vdc_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">drings</span><span class="p">[</span><span class="n">VIO_DRIVER_TX_RING</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">vio_dring_data</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">msgbuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dring_ident</span> <span class="o">!=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">||</span>
		     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">start_idx</span> <span class="o">!=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">end_idx</span> <span class="o">||</span>
		     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">start_idx</span> <span class="o">&gt;=</span> <span class="n">VDC_TX_RING_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vdc_end_one</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">start_idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vdc_nack</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msgbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX Implement me XXX */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vdc_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">LDC_EVENT_RESET</span> <span class="o">||</span>
		     <span class="n">event</span> <span class="o">==</span> <span class="n">LDC_EVENT_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vio_link_state_change</span><span class="p">(</span><span class="n">vio</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">LDC_EVENT_DATA_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Unexpected LDC event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vio_msg_tag</span> <span class="n">tag</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">raw</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">msgbuf</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ldc_read</span><span class="p">(</span><span class="n">vio</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">)</span>
				<span class="n">vio_conn_reset</span><span class="p">(</span><span class="n">vio</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">viodbg</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="s">&quot;TAG [%02x:%02x:%04x:%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		       <span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">stype</span><span class="p">,</span>
		       <span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">stype_env</span><span class="p">,</span>
		       <span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">sid</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vio_validate_sid</span><span class="p">(</span><span class="n">vio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">VIO_TYPE_DATA</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">stype</span> <span class="o">==</span> <span class="n">VIO_SUBTYPE_ACK</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">vdc_ack</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">stype</span> <span class="o">==</span> <span class="n">VIO_SUBTYPE_NACK</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">vdc_nack</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">vdc_handle_unknown</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msgbuf</span><span class="p">.</span><span class="n">tag</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">VIO_TYPE_CTRL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">vio_control_pkt_engine</span><span class="p">(</span><span class="n">vio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">vdc_handle_unknown</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgbuf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vdc_finish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">WAITING_FOR_ANY</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__vdc_tx_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">drings</span><span class="p">[</span><span class="n">VIO_DRIVER_TX_RING</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">vio_dring_data</span> <span class="n">hdr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">VIO_TYPE_DATA</span><span class="p">,</span>
			<span class="p">.</span><span class="n">stype</span>		<span class="o">=</span> <span class="n">VIO_SUBTYPE_INFO</span><span class="p">,</span>
			<span class="p">.</span><span class="n">stype_env</span>	<span class="o">=</span> <span class="n">VIO_DRING_DATA</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sid</span>		<span class="o">=</span> <span class="n">vio_send_sid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dring_ident</span>		<span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start_idx</span>		<span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end_idx</span>		<span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">delay</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">;</span>
	<span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vio_ldc_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dr</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">delay</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">drings</span><span class="p">[</span><span class="n">VIO_DRIVER_TX_RING</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ring_cookies</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">vdc_req_entry</span> <span class="o">*</span><span class="n">rqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vio_disk_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">map_perm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nsg</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_SHADOW</span> <span class="o">|</span> <span class="n">LDC_MAP_DIRECT</span> <span class="o">|</span> <span class="n">LDC_MAP_IO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">map_perm</span> <span class="o">|=</span> <span class="n">LDC_MAP_W</span><span class="p">;</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">VD_OP_BREAD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">map_perm</span> <span class="o">|=</span> <span class="n">LDC_MAP_R</span><span class="p">;</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">VD_OP_BWRITE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ring_cookies</span><span class="p">);</span>
	<span class="n">nsg</span> <span class="o">=</span> <span class="n">blk_rq_map_sg</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vdc_tx_dring_avail</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blk_stop_queue</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">vio_dring_cur</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ldc_map_sg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lp</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nsg</span><span class="p">,</span>
			 <span class="n">desc</span><span class="o">-&gt;</span><span class="n">cookies</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ring_cookies</span><span class="p">,</span>
			 <span class="n">map_perm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ldc_map_sg() failure, err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rq_arr</span><span class="p">[</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">];</span>
	<span class="n">rqe</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ack</span> <span class="o">=</span> <span class="n">VIO_ACK_ENABLE</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_type</span> <span class="o">==</span> <span class="n">VD_DISK_TYPE_DISK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">slice</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">slice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">ncookies</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* This has to be a non-SMP write barrier because we are writing</span>
<span class="cm">	 * to memory which is shared with the peer LDOM.</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIO_DESC_READY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__vdc_tx_trigger</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;vdc_tx_trigger() failure, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VDC_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_vdc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__send_request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vio_completion</span> <span class="n">comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vio_disk_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">map_perm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op_len</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">req_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">op</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">operations</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VD_OP_BREAD</span>:
	<span class="k">case</span> <span class="n">VD_OP_BWRITE</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_FLUSH</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_GET_WCE</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_W</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_SET_WCE</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_R</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_GET_VTOC</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_disk_vtoc</span><span class="p">);</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_W</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_SET_VTOC</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_disk_vtoc</span><span class="p">);</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_R</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_GET_DISKGEOM</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_disk_geom</span><span class="p">);</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_W</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_SET_DISKGEOM</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_disk_geom</span><span class="p">);</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_R</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_SCSICMD</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_RW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_GET_DEVID</span>:
		<span class="n">op_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_disk_devid</span><span class="p">);</span>
		<span class="n">map_perm</span> <span class="o">=</span> <span class="n">LDC_MAP_W</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VD_OP_GET_EFI</span>:
	<span class="k">case</span> <span class="n">VD_OP_SET_EFI</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">map_perm</span> <span class="o">|=</span> <span class="n">LDC_MAP_SHADOW</span> <span class="o">|</span> <span class="n">LDC_MAP_DIRECT</span> <span class="o">|</span> <span class="n">LDC_MAP_IO</span><span class="p">;</span>

	<span class="n">op_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">op_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">req_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">op_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">op_len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">op_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map_perm</span> <span class="o">&amp;</span> <span class="n">LDC_MAP_R</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">drings</span><span class="p">[</span><span class="n">VIO_DRIVER_TX_RING</span><span class="p">];</span>

	<span class="cm">/* XXX If we want to use this code generically we have to</span>
<span class="cm">	 * XXX handle TX ring exhaustion etc.</span>
<span class="cm">	 */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">vio_dring_cur</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ldc_map_single</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lp</span><span class="p">,</span> <span class="n">req_buf</span><span class="p">,</span> <span class="n">op_len</span><span class="p">,</span>
			     <span class="n">desc</span><span class="o">-&gt;</span><span class="n">cookies</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ring_cookies</span><span class="p">,</span>
			     <span class="n">map_perm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req_buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">com</span><span class="p">);</span>
	<span class="n">comp</span><span class="p">.</span><span class="n">waiting_for</span> <span class="o">=</span> <span class="n">WAITING_FOR_GEN_CMD</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ack</span> <span class="o">=</span> <span class="n">VIO_ACK_ENABLE</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">slice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">op_len</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">ncookies</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* This has to be a non-SMP write barrier because we are writing</span>
<span class="cm">	 * to memory which is shared with the peer LDOM.</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIO_DESC_READY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__vdc_tx_trigger</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VDC_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">com</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">comp</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map_perm</span> <span class="o">&amp;</span> <span class="n">LDC_MAP_W</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">req_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">req_buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vdc_alloc_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">drings</span><span class="p">[</span><span class="n">VIO_DRIVER_TX_RING</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ncookies</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dring</span><span class="p">;</span>

	<span class="n">entry_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_disk_desc</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ldc_trans_cookie</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ring_cookies</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">VDC_TX_RING_SIZE</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">);</span>

	<span class="n">ncookies</span> <span class="o">=</span> <span class="n">VIO_MAX_RING_COOKIES</span><span class="p">;</span>
	<span class="n">dring</span> <span class="o">=</span> <span class="n">ldc_alloc_exp_dring</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				    <span class="n">dr</span><span class="o">-&gt;</span><span class="n">cookies</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ncookies</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">LDC_MAP_SHADOW</span> <span class="o">|</span>
				     <span class="n">LDC_MAP_DIRECT</span> <span class="o">|</span>
				     <span class="n">LDC_MAP_RW</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dring</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dring</span><span class="p">);</span>

	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">dring</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">VDC_TX_RING_SIZE</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="n">VDC_TX_RING_SIZE</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">ncookies</span> <span class="o">=</span> <span class="n">ncookies</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vdc_free_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">drings</span><span class="p">[</span><span class="n">VIO_DRIVER_TX_RING</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ldc_free_exp_dring</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lp</span><span class="p">,</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">*</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">),</span>
				   <span class="n">dr</span><span class="o">-&gt;</span><span class="n">cookies</span><span class="p">,</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">ncookies</span><span class="p">);</span>
		<span class="n">dr</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dr</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dr</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dr</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dr</span><span class="o">-&gt;</span><span class="n">ncookies</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">probe_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_completion</span> <span class="n">comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">com</span><span class="p">);</span>
	<span class="n">comp</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">comp</span><span class="p">.</span><span class="n">waiting_for</span> <span class="o">=</span> <span class="n">WAITING_FOR_LINK_UP</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">;</span>

	<span class="n">vio_port_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">);</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp</span><span class="p">.</span><span class="n">com</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">comp</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">generic_request</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">VD_OP_GET_VTOC</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;VD_OP_GET_VTOC returns error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">generic_request</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">VD_OP_GET_DISKGEOM</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;VD_OP_GET_DISKGEOM returns &quot;</span>
		       <span class="s">&quot;error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">num_cyl</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">num_hd</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">geom</span><span class="p">.</span><span class="n">num_sec</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">do_vdc_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Could not allocate queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">g</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PARTITION_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: Could not allocate gendisk.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>

	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ring_cookies</span><span class="p">);</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span><span class="p">);</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">vdc_major</span><span class="p">;</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">&lt;&lt;</span> <span class="n">PARTITION_SHIFT</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>

	<span class="n">g</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdc_fops</span><span class="p">;</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">driverfs_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">set_capacity</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_size</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;%s: %u sectors (%u MB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">g</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span>
	       <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_size</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_size</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)));</span>

	<span class="n">add_disk</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ldc_channel_config</span> <span class="n">vdc_ldc_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">event</span>		<span class="o">=</span> <span class="n">vdc_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mtu</span>		<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">LDC_MODE_UNRELIABLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vio_driver_ops</span> <span class="n">vdc_vio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">send_attr</span>		<span class="o">=</span> <span class="n">vdc_send_attr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_attr</span>		<span class="o">=</span> <span class="n">vdc_handle_attr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handshake_complete</span>	<span class="o">=</span> <span class="n">vdc_handshake_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">print_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">version_printed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vdc_port_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_dev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">vio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">print_version</span><span class="p">();</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">mdesc_grab</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">&lt;&lt;</span> <span class="n">PARTITION_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">MINORMASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Port id [%llu] too large.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev_no</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_release_mdesc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Cannot allocate vdc_port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_release_mdesc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">&gt;=</span> <span class="mi">26</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">),</span>
			 <span class="n">VDCBLK_NAME</span> <span class="s">&quot;%c%c&quot;</span><span class="p">,</span>
			 <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">/</span> <span class="mi">26</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">%</span> <span class="mi">26</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">),</span>
			 <span class="n">VDCBLK_NAME</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">%</span> <span class="mi">26</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vio_driver_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">,</span> <span class="n">vdev</span><span class="p">,</span> <span class="n">VDEV_DISK</span><span class="p">,</span>
			      <span class="n">vdc_versions</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vdc_versions</span><span class="p">),</span>
			      <span class="o">&amp;</span><span class="n">vdc_vio_ops</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_port</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span> <span class="o">=</span> <span class="p">((</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ring_cookies</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span> <span class="o">*</span>
			       <span class="n">port</span><span class="o">-&gt;</span><span class="n">vdisk_block_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vio_ldc_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdc_ldc_cfg</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_port</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vdc_alloc_tx_ring</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_ldc</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">probe_disk</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_tx_ring</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">mdesc_release</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_tx_ring:</span>
	<span class="n">vdc_free_tx_ring</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

<span class="nl">err_out_free_ldc:</span>
	<span class="n">vio_ldc_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">);</span>

<span class="nl">err_out_free_port:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

<span class="nl">err_out_release_mdesc:</span>
	<span class="n">mdesc_release</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vdc_port_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_dev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vdc_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

		<span class="n">vdc_free_tx_ring</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">vio_ldc_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">);</span>

		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vio_device_id</span> <span class="n">vdc_port_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;vdc-port&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">vio</span><span class="p">,</span> <span class="n">vdc_port_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vio_driver</span> <span class="n">vdc_port_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">vdc_port_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">vdc_port_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">vdc_port_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;vdc_port&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vdc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VDCBLK_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">vdc_major</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdc_port_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_blkdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unregister_blkdev:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">vdc_major</span><span class="p">,</span> <span class="n">VDCBLK_NAME</span><span class="p">);</span>
	<span class="n">vdc_major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">vdc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vio_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdc_port_driver</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">vdc_major</span><span class="p">,</span> <span class="n">VDCBLK_NAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">vdc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vdc_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
