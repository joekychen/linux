<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › floppy.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>floppy.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/block/floppy.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *  Copyright (C) 1993, 1994  Alain Knaff</span>
<span class="cm"> *  Copyright (C) 1998 Alan Cox</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 02.12.91 - Changed to static variables to indicate need for reset</span>
<span class="cm"> * and recalibrate. This makes some things easier (output_byte reset</span>
<span class="cm"> * checking etc), and means less interrupt jumping in case of errors,</span>
<span class="cm"> * so the code is hopefully easier to understand.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file is certainly a mess. I&#39;ve tried my best to get it working,</span>
<span class="cm"> * but I don&#39;t like programming floppies, and I have only one anyway.</span>
<span class="cm"> * Urgel. I should check for more errors, and do more graceful error</span>
<span class="cm"> * recovery. Seems there are problems with several drives. I&#39;ve tried to</span>
<span class="cm"> * correct them. No promises.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * As with hd.c, all routines within this file can (and will) be called</span>
<span class="cm"> * by interrupts, so extreme caution is needed. A hardware interrupt</span>
<span class="cm"> * handler may not sleep, or a kernel panic will happen. Thus I cannot</span>
<span class="cm"> * call &quot;floppy-on&quot; directly, but have to set a special timer interrupt</span>
<span class="cm"> * etc.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 28.02.92 - made track-buffering routines, based on the routines written</span>
<span class="cm"> * by entropy@wintermute.wpi.edu (Lawrence Foard). Linus.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Automatic floppy-detection and formatting written by Werner Almesberger</span>
<span class="cm"> * (almesber@nessie.cs.id.ethz.ch), who also corrected some problems with</span>
<span class="cm"> * the floppy-change signal detection.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1992/7/22 -- Hennus Bergman: Added better error reporting, fixed</span>
<span class="cm"> * FDC data overrun bug, added some preliminary stuff for vertical</span>
<span class="cm"> * recording support.</span>
<span class="cm"> *</span>
<span class="cm"> * 1992/9/17: Added DMA allocation &amp; DMA functions. -- hhb.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: Errors are still not counted properly.</span>
<span class="cm"> */</span>

<span class="cm">/* 1992/9/20</span>
<span class="cm"> * Modifications for ``Sector Shifting&#39;&#39; by Rob Hooft (hooft@chem.ruu.nl)</span>
<span class="cm"> * modeled after the freeware MS-DOS program fdformat/88 V1.8 by</span>
<span class="cm"> * Christoph H. Hochst\&quot;atter.</span>
<span class="cm"> * I have fixed the shift values to the ones I always use. Maybe a new</span>
<span class="cm"> * ioctl() should be created to be able to modify them.</span>
<span class="cm"> * There is a bug in the driver that makes it impossible to format a</span>
<span class="cm"> * floppy as the first thing after bootup.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1993/4/29 -- Linus -- cleaned up the timer handling in the kernel, and</span>
<span class="cm"> * this helped the floppy driver as well. Much cleaner, and still seems to</span>
<span class="cm"> * work.</span>
<span class="cm"> */</span>

<span class="cm">/* 1994/6/24 --bbroad-- added the floppy table entries and made</span>
<span class="cm"> * minor modifications to allow 2.88 floppies to be run.</span>
<span class="cm"> */</span>

<span class="cm">/* 1994/7/13 -- Paul Vojta -- modified the probing code to allow three or more</span>
<span class="cm"> * disk types.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1994/8/8 -- Alain Knaff -- Switched to fdpatch driver: Support for bigger</span>
<span class="cm"> * format bug fixes, but unfortunately some new bugs too...</span>
<span class="cm"> */</span>

<span class="cm">/* 1994/9/17 -- Koen Holtman -- added logging of physical floppy write</span>
<span class="cm"> * errors to allow safe writing by specialized programs.</span>
<span class="cm"> */</span>

<span class="cm">/* 1995/4/24 -- Dan Fandrich -- added support for Commodore 1581 3.5&quot; disks</span>
<span class="cm"> * by defining bit 1 of the &quot;stretch&quot; parameter to mean put sectors on the</span>
<span class="cm"> * opposite side of the disk, leaving the sector IDs alone (i.e. Commodore&#39;s</span>
<span class="cm"> * drives are &quot;upside-down&quot;).</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1995/8/26 -- Andreas Busse -- added Mips support.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1995/10/18 -- Ralf Baechle -- Portability cleanup; move machine dependent</span>
<span class="cm"> * features to asm/floppy.h.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1998/1/21 -- Richard Gooch &lt;rgooch@atnf.csiro.au&gt; -- devfs support</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1998/05/07 -- Russell King -- More portability cleanups; moved definition of</span>
<span class="cm"> * interrupt and dma channel to asm/floppy.h. Cleaned up some formatting &amp;</span>
<span class="cm"> * use of &#39;0&#39; for NULL.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1998/06/07 -- Alan Cox -- Merged the 2.0.34 fixes for resource allocation</span>
<span class="cm"> * failures.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1998/09/20 -- David Weinehall -- Added slow-down code for buggy PS/2-drives.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 1999/08/13 -- Paul Slootman -- floppy stopped working on Alpha after 24</span>
<span class="cm"> * days, 6 hours, 32 minutes and 32 seconds (i.e. MAXINT jiffies; ints were</span>
<span class="cm"> * being used to store jiffies, which are unsigned longs).</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 2000/08/28 -- Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> * - get rid of check_region</span>
<span class="cm"> * - s/suser/capable/</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 2001/08/26 -- Paul Gortmaker - fix insmod oops on machines with no</span>
<span class="cm"> * floppy controller (lingering task on list after module is gone... boom.)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 2002/02/07 -- Anton Altaparmakov - Fix io ports reservation to correct range</span>
<span class="cm"> * (0x3f2-0x3f5, 0x3f7). This fix is a bit of a hack but the proper fix</span>
<span class="cm"> * requires many non-obvious changes in arch dependent code.</span>
<span class="cm"> */</span>

<span class="cm">/* 2003/07/28 -- Daniele Bellucci &lt;bellucda@tiscali.it&gt;.</span>
<span class="cm"> * Better audit of register_blkdev.</span>
<span class="cm"> */</span>

<span class="cp">#undef  FLOPPY_SILENT_DCL_CLEAR</span>

<span class="cp">#define REALLY_SLOW_IO</span>

<span class="cp">#define DEBUGT 2</span>

<span class="cp">#define DPRINT(format, args...) \</span>
<span class="cp">	pr_info(&quot;floppy%d: &quot; format, current_drive, ##args)</span>

<span class="cp">#define DCL_DEBUG		</span><span class="cm">/* debug disk change line */</span><span class="cp"></span>
<span class="cp">#ifdef DCL_DEBUG</span>
<span class="cp">#define debug_dcl(test, fmt, args...) \</span>
<span class="cp">	do { if ((test) &amp; FD_DEBUG) DPRINT(fmt, ##args); } while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define debug_dcl(test, fmt, args...) \</span>
<span class="cp">	do { if (0) DPRINT(fmt, ##args); } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* do print messages for unexpected interrupts */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">print_unex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#define FDPATCHES</span>
<span class="cp">#include &lt;linux/fdreg.h&gt;</span>
<span class="cp">#include &lt;linux/fd.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;	</span><span class="cm">/* CMOS defines */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mod_devicetable.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * PS/2 floppies have much slower step rates than regular floppies.</span>
<span class="cm"> * It&#39;s been recommended that take about 1/4 of the default speed</span>
<span class="cm"> * in some more extreme cases.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">floppy_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">slow_floppy</span><span class="p">;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">FLOPPY_IRQ</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">FLOPPY_DMA</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">can_use_virtual_dma</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cm">/* =======</span>
<span class="cm"> * can use virtual DMA:</span>
<span class="cm"> * 0 = use of virtual DMA disallowed by config</span>
<span class="cm"> * 1 = use of virtual DMA prescribed by config</span>
<span class="cm"> * 2 = no virtual DMA preference configured.  By default try hard DMA,</span>
<span class="cm"> * but fall back on virtual DMA when not enough memory available</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_virtual_dma</span><span class="p">;</span>
<span class="cm">/* =======</span>
<span class="cm"> * use virtual DMA</span>
<span class="cm"> * 0 using hard DMA</span>
<span class="cm"> * 1 using virtual DMA</span>
<span class="cm"> * This variable is set to virtual when a DMA mem problem arises, and</span>
<span class="cm"> * reset back in floppy_grab_irq_and_dma.</span>
<span class="cm"> * It is not safe to reset it in other circumstances, because the floppy</span>
<span class="cm"> * driver may have several buffers in use at once, and we do currently not</span>
<span class="cm"> * record each buffers capabilities</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">floppy_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">virtual_dma_port</span> <span class="o">=</span> <span class="mh">0x3f0</span><span class="p">;</span>
<span class="n">irqreturn_t</span> <span class="n">floppy_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_dor</span><span class="p">(</span><span class="kt">int</span> <span class="n">fdc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">char</span> <span class="n">data</span><span class="p">);</span>

<span class="cp">#define K_64	0x10000		</span><span class="cm">/* 64KB */</span><span class="cp"></span>

<span class="cm">/* the following is the mask of allowed drives. By default units 2 and</span>
<span class="cm"> * 3 of both floppy controllers are disabled, because switching on the</span>
<span class="cm"> * motor of these drives causes system hangs on some PCI computers. drive</span>
<span class="cm"> * 0 is the low bit (0x1), and drive 7 is the high bit (0x80). Bits are on if</span>
<span class="cm"> * a drive is allowed.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This must come before we include the arch floppy header because</span>
<span class="cm"> *       some ports reference this variable from there. -DaveM</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">allowed_drive_mask</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>

<span class="cp">#include &lt;asm/floppy.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">irqdma_allocated</span><span class="p">;</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;	</span><span class="cm">/* for the compatibility eject ioctl */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">current_req</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_fd_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_next_request</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#ifndef fd_get_dma_residue</span>
<span class="cp">#define fd_get_dma_residue() get_dma_residue(FLOPPY_DMA)</span>
<span class="cp">#endif</span>

<span class="cm">/* Dma Memory related stuff */</span>

<span class="cp">#ifndef fd_dma_mem_free</span>
<span class="cp">#define fd_dma_mem_free(addr, size) free_pages(addr, get_order(size))</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef fd_dma_mem_alloc</span>
<span class="cp">#define fd_dma_mem_alloc(size) __get_dma_pages(GFP_KERNEL, get_order(size))</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fallback_on_nodma_alloc</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef FLOPPY_CAN_FALLBACK_ON_NODMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* we have the memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_use_virtual_dma</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* no fallback allowed */</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DMA memory shortage. Temporarily falling back on virtual DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">nodma_mem_alloc</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* End dma memory related stuff */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fake_change</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">initialized</span><span class="p">;</span>

<span class="cp">#define ITYPE(x)	(((x) &gt;&gt; 2) &amp; 0x1f)</span>
<span class="cp">#define TOMINOR(x)	((x &amp; 3) | ((x &amp; 4) &lt;&lt; 5))</span>
<span class="cp">#define UNIT(x)		((x) &amp; 0x03)		</span><span class="cm">/* drive on fdc */</span><span class="cp"></span>
<span class="cp">#define FDC(x)		(((x) &amp; 0x04) &gt;&gt; 2)	</span><span class="cm">/* fdc of drive */</span><span class="cp"></span>
	<span class="cm">/* reverse mapping from unit and fdc to drive */</span>
<span class="cp">#define REVDRIVE(fdc, unit) ((unit) + ((fdc) &lt;&lt; 2))</span>

<span class="cp">#define DP	(&amp;drive_params[current_drive])</span>
<span class="cp">#define DRS	(&amp;drive_state[current_drive])</span>
<span class="cp">#define DRWE	(&amp;write_errors[current_drive])</span>
<span class="cp">#define FDCS	(&amp;fdc_state[fdc])</span>

<span class="cp">#define UDP	(&amp;drive_params[drive])</span>
<span class="cp">#define UDRS	(&amp;drive_state[drive])</span>
<span class="cp">#define UDRWE	(&amp;write_errors[drive])</span>
<span class="cp">#define UFDCS	(&amp;fdc_state[FDC(drive)])</span>

<span class="cp">#define PH_HEAD(floppy, head) (((((floppy)-&gt;stretch &amp; 2) &gt;&gt; 1) ^ head) &lt;&lt; 2)</span>
<span class="cp">#define STRETCH(floppy)	((floppy)-&gt;stretch &amp; FD_STRETCH)</span>

<span class="cm">/* read/write */</span>
<span class="cp">#define COMMAND		(raw_cmd-&gt;cmd[0])</span>
<span class="cp">#define DR_SELECT	(raw_cmd-&gt;cmd[1])</span>
<span class="cp">#define TRACK		(raw_cmd-&gt;cmd[2])</span>
<span class="cp">#define HEAD		(raw_cmd-&gt;cmd[3])</span>
<span class="cp">#define SECTOR		(raw_cmd-&gt;cmd[4])</span>
<span class="cp">#define SIZECODE	(raw_cmd-&gt;cmd[5])</span>
<span class="cp">#define SECT_PER_TRACK	(raw_cmd-&gt;cmd[6])</span>
<span class="cp">#define GAP		(raw_cmd-&gt;cmd[7])</span>
<span class="cp">#define SIZECODE2	(raw_cmd-&gt;cmd[8])</span>
<span class="cp">#define NR_RW 9</span>

<span class="cm">/* format */</span>
<span class="cp">#define F_SIZECODE	(raw_cmd-&gt;cmd[2])</span>
<span class="cp">#define F_SECT_PER_TRACK (raw_cmd-&gt;cmd[3])</span>
<span class="cp">#define F_GAP		(raw_cmd-&gt;cmd[4])</span>
<span class="cp">#define F_FILL		(raw_cmd-&gt;cmd[5])</span>
<span class="cp">#define NR_F 6</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum disk size (in kilobytes).</span>
<span class="cm"> * This default is used whenever the current disk size is unknown.</span>
<span class="cm"> * [Now it is rather a minimum]</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_DISK_SIZE 4		</span><span class="cm">/* 3984 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * globals used by &#39;result()&#39;</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_REPLIES 16</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reply_buffer</span><span class="p">[</span><span class="n">MAX_REPLIES</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">inr</span><span class="p">;</span>		<span class="cm">/* size of reply buffer, when called from interrupt */</span>
<span class="cp">#define ST0		(reply_buffer[0])</span>
<span class="cp">#define ST1		(reply_buffer[1])</span>
<span class="cp">#define ST2		(reply_buffer[2])</span>
<span class="cp">#define ST3		(reply_buffer[0])	</span><span class="cm">/* result of GETSTATUS */</span><span class="cp"></span>
<span class="cp">#define R_TRACK		(reply_buffer[3])</span>
<span class="cp">#define R_HEAD		(reply_buffer[4])</span>
<span class="cp">#define R_SECTOR	(reply_buffer[5])</span>
<span class="cp">#define R_SIZECODE	(reply_buffer[6])</span>

<span class="cp">#define SEL_DLY		(2 * HZ / 100)</span>

<span class="cm">/*</span>
<span class="cm"> * this struct defines the different floppy drive types.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_drive_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/* name printed while booting */</span>
<span class="p">}</span> <span class="n">default_drive_params</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* NOTE: the time values in jiffies should be in msec!</span>
<span class="cm"> CMOS drive type</span>
<span class="cm">  |     Maximum data rate supported by drive type</span>
<span class="cm">  |     |   Head load time, msec</span>
<span class="cm">  |     |   |   Head unload time, msec (not used)</span>
<span class="cm">  |     |   |   |     Step rate interval, usec</span>
<span class="cm">  |     |   |   |     |       Time needed for spinup time (jiffies)</span>
<span class="cm">  |     |   |   |     |       |      Timeout for spinning down (jiffies)</span>
<span class="cm">  |     |   |   |     |       |      |   Spindown offset (where disk stops)</span>
<span class="cm">  |     |   |   |     |       |      |   |     Select delay</span>
<span class="cm">  |     |   |   |     |       |      |   |     |     RPS</span>
<span class="cm">  |     |   |   |     |       |      |   |     |     |    Max number of tracks</span>
<span class="cm">  |     |   |   |     |       |      |   |     |     |    |     Interrupt timeout</span>
<span class="cm">  |     |   |   |     |       |      |   |     |     |    |     |   Max nonintlv. sectors</span>
<span class="cm">  |     |   |   |     |       |      |   |     |     |    |     |   | -Max Errors- flags */</span>
<span class="p">{{</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">500</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span>    <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">SEL_DLY</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">},</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="s">&quot;unknown&quot;</span> <span class="p">},</span>

<span class="p">{{</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">300</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span>    <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">SEL_DLY</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="s">&quot;360K PC&quot;</span> <span class="p">},</span> <span class="cm">/*5 1/4 360 KB PC*/</span>

<span class="p">{{</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">500</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">SEL_DLY</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="s">&quot;1.2M&quot;</span> <span class="p">},</span> <span class="cm">/*5 1/4 HD AT*/</span>

<span class="p">{{</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">250</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span>    <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">SEL_DLY</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span> <span class="s">&quot;720k&quot;</span> <span class="p">},</span> <span class="cm">/*3 1/2 DD*/</span>

<span class="p">{{</span><span class="mi">4</span><span class="p">,</span>  <span class="mi">500</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SEL_DLY</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">11</span><span class="p">},</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span> <span class="s">&quot;1.44M&quot;</span> <span class="p">},</span> <span class="cm">/*3 1/2 HD*/</span>

<span class="p">{{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SEL_DLY</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">21</span><span class="p">},</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span> <span class="s">&quot;2.88M AMI BIOS&quot;</span> <span class="p">},</span> <span class="cm">/*3 1/2 ED*/</span>

<span class="p">{{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SEL_DLY</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">21</span><span class="p">},</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span> <span class="s">&quot;2.88M&quot;</span> <span class="p">}</span> <span class="cm">/*3 1/2 ED*/</span>
<span class="cm">/*    |  --autodetected formats---    |      |      |</span>
<span class="cm"> *    read_track                      |      |    Name printed when booting</span>
<span class="cm"> *				      |     Native format</span>
<span class="cm"> *	            Frequency of disk change checks */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_drive_params</span> <span class="n">drive_params</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_drive_struct</span> <span class="n">drive_state</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_write_errors</span> <span class="n">write_errors</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">motor_off_timer</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disks</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">opened_bdev</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">open_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">*</span><span class="n">raw_cmd</span><span class="p">,</span> <span class="n">default_raw_cmd</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fdc_queue</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This struct defines the different floppy types.</span>
<span class="cm"> *</span>
<span class="cm"> * Bit 0 of &#39;stretch&#39; tells if the tracks need to be doubled for some</span>
<span class="cm"> * types (e.g. 360kB diskette in 1.2MB drive, etc.).  Bit 1 of &#39;stretch&#39;</span>
<span class="cm"> * tells if the disk is in Commodore 1581 format, which means side 0 sectors</span>
<span class="cm"> * are located on side 1 of the disk but with a side 0 ID, and vice-versa.</span>
<span class="cm"> * This is the same as the Sharp MZ-80 5.25&quot; CP/M disk format, except that the</span>
<span class="cm"> * 1581&#39;s logical side 0 is on physical side 1, whereas the Sharp&#39;s logical</span>
<span class="cm"> * side 0 is on physical side 0 (but with the misnamed sector IDs).</span>
<span class="cm"> * &#39;stretch&#39; should probably be renamed to something more general, like</span>
<span class="cm"> * &#39;options&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * Bits 2 through 9 of &#39;stretch&#39; tell the number of the first sector.</span>
<span class="cm"> * The LSB (bit 2) is flipped. For most disks, the first sector</span>
<span class="cm"> * is 1 (represented by 0x00&lt;&lt;2).  For some CP/M and music sampler</span>
<span class="cm"> * disks (such as Ensoniq EPS 16plus) it is 0 (represented as 0x01&lt;&lt;2).</span>
<span class="cm"> * For Amstrad CPC disks it is 0xC1 (represented as 0xC0&lt;&lt;2).</span>
<span class="cm"> *</span>
<span class="cm"> * Other parameters should be self-explanatory (see also setfdprm(8)).</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm">	    Size</span>
<span class="cm">	     |  Sectors per track</span>
<span class="cm">	     |  | Head</span>
<span class="cm">	     |  | |  Tracks</span>
<span class="cm">	     |  | |  | Stretch</span>
<span class="cm">	     |  | |  | |  Gap 1 size</span>
<span class="cm">	     |  | |  | |    |  Data rate, | 0x40 for perp</span>
<span class="cm">	     |  | |  | |    |    |  Spec1 (stepping rate, head unload</span>
<span class="cm">	     |  | |  | |    |    |    |    /fmt gap (gap2) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_struct</span> <span class="n">floppy_type</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="nb">NULL</span>    <span class="p">},</span>	<span class="cm">/*  0 no testing    */</span>
	<span class="p">{</span>  <span class="mi">720</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2A</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="s">&quot;d360&quot;</span>  <span class="p">},</span> <span class="cm">/*  1 360KB PC      */</span>
	<span class="p">{</span> <span class="mi">2400</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1B</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="s">&quot;h1200&quot;</span> <span class="p">},</span>	<span class="cm">/*  2 1.2MB AT      */</span>
	<span class="p">{</span>  <span class="mi">720</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2A</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="s">&quot;D360&quot;</span>  <span class="p">},</span>	<span class="cm">/*  3 360KB SS 3.5&quot; */</span>
	<span class="p">{</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2A</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="s">&quot;D720&quot;</span>  <span class="p">},</span>	<span class="cm">/*  4 720KB 3.5&quot;    */</span>
	<span class="p">{</span>  <span class="mi">720</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="s">&quot;h360&quot;</span>  <span class="p">},</span>	<span class="cm">/*  5 360KB AT      */</span>
	<span class="p">{</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="s">&quot;h720&quot;</span>  <span class="p">},</span>	<span class="cm">/*  6 720KB AT      */</span>
	<span class="p">{</span> <span class="mi">2880</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1B</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x6C</span><span class="p">,</span><span class="s">&quot;H1440&quot;</span> <span class="p">},</span>	<span class="cm">/*  7 1.44MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">5760</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1B</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0xAF</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="s">&quot;E2880&quot;</span> <span class="p">},</span>	<span class="cm">/*  8 2.88MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">6240</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1B</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0xAF</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="s">&quot;E3120&quot;</span> <span class="p">},</span>	<span class="cm">/*  9 3.12MB 3.5&quot;   */</span>

	<span class="p">{</span> <span class="mi">2880</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="s">&quot;h1440&quot;</span> <span class="p">},</span> <span class="cm">/* 10 1.44MB 5.25&quot;  */</span>
	<span class="p">{</span> <span class="mi">3360</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="s">&quot;H1680&quot;</span> <span class="p">},</span> <span class="cm">/* 11 1.68MB 3.5&quot;   */</span>
	<span class="p">{</span>  <span class="mi">820</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x2E</span><span class="p">,</span><span class="s">&quot;h410&quot;</span>  <span class="p">},</span>	<span class="cm">/* 12 410KB 5.25&quot;   */</span>
	<span class="p">{</span> <span class="mi">1640</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x2E</span><span class="p">,</span><span class="s">&quot;H820&quot;</span>  <span class="p">},</span>	<span class="cm">/* 13 820KB 3.5&quot;    */</span>
	<span class="p">{</span> <span class="mi">2952</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="s">&quot;h1476&quot;</span> <span class="p">},</span>	<span class="cm">/* 14 1.48MB 5.25&quot;  */</span>
	<span class="p">{</span> <span class="mi">3444</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="s">&quot;H1722&quot;</span> <span class="p">},</span>	<span class="cm">/* 15 1.72MB 3.5&quot;   */</span>
	<span class="p">{</span>  <span class="mi">840</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x2E</span><span class="p">,</span><span class="s">&quot;h420&quot;</span>  <span class="p">},</span>	<span class="cm">/* 16 420KB 5.25&quot;   */</span>
	<span class="p">{</span> <span class="mi">1660</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x2E</span><span class="p">,</span><span class="s">&quot;H830&quot;</span>  <span class="p">},</span>	<span class="cm">/* 17 830KB 3.5&quot;    */</span>
	<span class="p">{</span> <span class="mi">2988</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="s">&quot;h1494&quot;</span> <span class="p">},</span>	<span class="cm">/* 18 1.49MB 5.25&quot;  */</span>
	<span class="p">{</span> <span class="mi">3486</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="s">&quot;H1743&quot;</span> <span class="p">},</span> <span class="cm">/* 19 1.74 MB 3.5&quot;  */</span>

	<span class="p">{</span> <span class="mi">1760</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;h880&quot;</span>  <span class="p">},</span> <span class="cm">/* 20 880KB 5.25&quot;   */</span>
	<span class="p">{</span> <span class="mi">2080</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;D1040&quot;</span> <span class="p">},</span> <span class="cm">/* 21 1.04MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">2240</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;D1120&quot;</span> <span class="p">},</span> <span class="cm">/* 22 1.12MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">3200</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x2C</span><span class="p">,</span><span class="s">&quot;h1600&quot;</span> <span class="p">},</span> <span class="cm">/* 23 1.6MB 5.25&quot;   */</span>
	<span class="p">{</span> <span class="mi">3520</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="s">&quot;H1760&quot;</span> <span class="p">},</span> <span class="cm">/* 24 1.76MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">3840</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;H1920&quot;</span> <span class="p">},</span> <span class="cm">/* 25 1.92MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">6400</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x5B</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;E3200&quot;</span> <span class="p">},</span> <span class="cm">/* 26 3.20MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">7040</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x5B</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;E3520&quot;</span> <span class="p">},</span> <span class="cm">/* 27 3.52MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">7680</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;E3840&quot;</span> <span class="p">},</span> <span class="cm">/* 28 3.84MB 3.5&quot;   */</span>
	<span class="p">{</span> <span class="mi">3680</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="s">&quot;H1840&quot;</span> <span class="p">},</span> <span class="cm">/* 29 1.84MB 3.5&quot;   */</span>

	<span class="p">{</span> <span class="mi">1600</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xDF</span><span class="p">,</span><span class="mh">0x2E</span><span class="p">,</span><span class="s">&quot;D800&quot;</span>  <span class="p">},</span>	<span class="cm">/* 30 800KB 3.5&quot;    */</span>
	<span class="p">{</span> <span class="mi">3200</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1C</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x2C</span><span class="p">,</span><span class="s">&quot;H1600&quot;</span> <span class="p">},</span> <span class="cm">/* 31 1.6MB 3.5&quot;    */</span>
<span class="p">};</span>

<span class="cp">#define SECTSIZE (_FD_SECTSIZE(*floppy))</span>

<span class="cm">/* Auto-detection: Disk type used until the next media change occurs. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">*</span><span class="n">current_type</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * User-provided type information. current_type points to</span>
<span class="cm"> * the respective entry of this array.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_struct</span> <span class="n">user_params</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="n">floppy_sizes</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">floppy_device_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;floppy&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The driver is trying to determine the correct media format</span>
<span class="cm"> * while probing is set. rw_interrupt() clears it after a</span>
<span class="cm"> * successful access.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">probing</span><span class="p">;</span>

<span class="cm">/* Synchronization of FDC access. */</span>
<span class="cp">#define FD_COMMAND_NONE		-1</span>
<span class="cp">#define FD_COMMAND_ERROR	2</span>
<span class="cp">#define FD_COMMAND_OKAY		3</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">command_status</span> <span class="o">=</span> <span class="n">FD_COMMAND_NONE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fdc_busy</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">fdc_wait</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">command_done</span><span class="p">);</span>

<span class="cm">/* Errors during formatting are counted here. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">format_errors</span><span class="p">;</span>

<span class="cm">/* Format request descriptor. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">format_descr</span> <span class="n">format_req</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Rate is 0 for 500kb/s, 1 for 300kbps, 2 for 250kbps</span>
<span class="cm"> * Spec1 is 0xSH, where S is stepping rate (F=1ms, E=2ms, D=3ms etc),</span>
<span class="cm"> * H is head unload time (1=16ms, 2=32ms, etc)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Track buffer</span>
<span class="cm"> * Because these are written to by the DMA controller, they must</span>
<span class="cm"> * not contain a 64k byte boundary crossing, or data will be</span>
<span class="cm"> * corrupted/lost.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">floppy_track_buffer</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_buffer_sectors</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="o">*</span><span class="n">errors</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done_f</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">interrupt</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
				<span class="cm">/* this is called after the interrupt of the</span>
<span class="cm">				 * main command */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">redo</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>	<span class="cm">/* this is called to retry the operation */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>	<span class="cm">/* this is called to tally an error */</span>
	<span class="n">done_f</span> <span class="n">done</span><span class="p">;</span>		<span class="cm">/* this is called to say if the operation has</span>
<span class="cm">				 * succeeded/failed */</span>
<span class="p">}</span> <span class="o">*</span><span class="n">cont</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">floppy_ready</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">floppy_start</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_fd_request</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">recalibrate_floppy</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">floppy_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">floppy_request_regions</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">floppy_release_regions</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">floppy_grab_irq_and_dma</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">floppy_release_irq_and_dma</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The &quot;reset&quot; variable should be tested whenever an interrupt is scheduled,</span>
<span class="cm"> * after the commands have been sent. This is to ensure that the driver doesn&#39;t</span>
<span class="cm"> * get wedged when the interrupt doesn&#39;t come because of a failed command.</span>
<span class="cm"> * reset doesn&#39;t need to be tested before sending commands, because</span>
<span class="cm"> * output_byte is automatically disabled when reset is set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_fdc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * These are global variables, as that&#39;s the easiest way to give</span>
<span class="cm"> * information to interrupts. They are the data used for the current</span>
<span class="cm"> * request.</span>
<span class="cm"> */</span>
<span class="cp">#define NO_TRACK	-1</span>
<span class="cp">#define NEED_1_RECAL	-2</span>
<span class="cp">#define NEED_2_RECAL	-3</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">usage_count</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cm">/* buffer related variables */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">buffer_track</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">buffer_drive</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">buffer_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">buffer_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* fdc related variables, should end up in a struct */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_fdc_state</span> <span class="n">fdc_state</span><span class="p">[</span><span class="n">N_FDC</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fdc</span><span class="p">;</span>			<span class="cm">/* current fdc */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">floppy_wq</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">*</span><span class="n">_floppy</span> <span class="o">=</span> <span class="n">floppy_type</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_drive</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">current_count_sectors</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fsector_t</span><span class="p">;</span>	<span class="cm">/* sector in track */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in_sector_offset</span><span class="p">;</span>	<span class="cm">/* offset within physical sector,</span>
<span class="cm">					 * expressed in units of 512 bytes */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">drive_no_geom</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">current_type</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ITYPE</span><span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef fd_eject</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fd_eject</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Debugging</span>
<span class="cm"> * =========</span>
<span class="cm"> */</span>
<span class="cp">#ifdef DEBUGT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="n">debugtimer</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_debugt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugtimer</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">debugt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEBUGT</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:%s dtime=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">debugtimer</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_debugt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">debugt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUGT */</span><span class="cp"></span>


<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">fd_timeout</span><span class="p">,</span> <span class="n">floppy_shutdown</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">timeout_message</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">is_alive</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this routine checks whether the floppy driver is &quot;alive&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdc_busy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">command_status</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;%s: timeout handler died.  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">do_floppy</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#define OLOGSIZE 20</span>

<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">lasthandler</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interruptjiffies</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resultjiffies</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">resultsize</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastredo</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">output_log</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span> <span class="n">output_log</span><span class="p">[</span><span class="n">OLOGSIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">output_log_pos</span><span class="p">;</span>

<span class="cp">#define current_reqD -1</span>
<span class="cp">#define MAXTIMEOUT -2</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__reschedule_timeout</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span> <span class="o">==</span> <span class="n">current_reqD</span><span class="p">)</span>
		<span class="n">drive</span> <span class="o">=</span> <span class="n">current_drive</span><span class="p">;</span>
	<span class="n">__cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">drive</span> <span class="o">&gt;=</span> <span class="n">N_DRIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="mi">20UL</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">floppy_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_DEBUG</span><span class="p">)</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;reschedule timeout %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
	<span class="n">timeout_message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reschedule_timeout</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__reschedule_timeout</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define INFBOUND(a, b) (a) = max_t(int, a, b)</span>
<span class="cp">#define SUPBOUND(a, b) (a) = min_t(int, a, b)</span>

<span class="cm">/*</span>
<span class="cm"> * Bottom half floppy driver.</span>
<span class="cm"> * ==========================</span>
<span class="cm"> *</span>
<span class="cm"> * This part of the file contains the code talking directly to the hardware,</span>
<span class="cm"> * and also the main service loop (seek-configure-spinup-command)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * disk change.</span>
<span class="cm"> * This routine is responsible for maintaining the FD_DISK_CHANGE flag,</span>
<span class="cm"> * and the last_checked date.</span>
<span class="cm"> *</span>
<span class="cm"> * last_checked is the date of the last check which showed &#39;no disk change&#39;</span>
<span class="cm"> * FD_DISK_CHANGE is set under two conditions:</span>
<span class="cm"> * 1. The floppy has been changed after some i/o to that floppy already</span>
<span class="cm"> *    took place.</span>
<span class="cm"> * 2. No floppy disk is in the drive. This is done in order to ensure that</span>
<span class="cm"> *    requests are quickly flushed in case there is no disk in the drive. It</span>
<span class="cm"> *    follows that FD_DISK_CHANGE can only be cleared if there is a disk in</span>
<span class="cm"> *    the drive.</span>
<span class="cm"> *</span>
<span class="cm"> * For 1., maxblock is observed. Maxblock is 0 if no i/o has taken place yet.</span>
<span class="cm"> * For 2., FD_DISK_NEWCHANGE is watched. FD_DISK_NEWCHANGE is cleared on</span>
<span class="cm"> *  each seek. If a disk is present, the disk change line should also be</span>
<span class="cm"> *  cleared on each seek. Thus, if FD_DISK_NEWCHANGE is clear, but the disk</span>
<span class="cm"> *  change line is set, this means either that no disk is in the drive, or</span>
<span class="cm"> *  that it has been removed since the last seek.</span>
<span class="cm"> *</span>
<span class="cm"> * This means that we really have a third possibility too:</span>
<span class="cm"> *  The floppy has been changed after the last seek.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disk_change</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fdc</span> <span class="o">=</span> <span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">select_date</span> <span class="o">+</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">))</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;WARNING disk change called early</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">||</span> <span class="n">fdc</span> <span class="o">!=</span> <span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;probing disk change on unselected drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;drive=%d fdc=%d dor=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		  <span class="s">&quot;checking disk change line for drive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;jiffies=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;disk change line=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd_inb</span><span class="p">(</span><span class="n">FD_DIR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;flags=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_BROKEN_DCL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fd_inb</span><span class="p">(</span><span class="n">FD_DIR</span><span class="p">)</span> <span class="o">^</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="cm">/* verify write protection */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">maxblock</span><span class="p">)</span>	<span class="cm">/* mark it changed */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* invalidate its geometry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">keep_data</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FTD_MSG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">current_type</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Disk type is undefined after disk change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">current_type</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">TOMINOR</span><span class="p">(</span><span class="n">drive</span><span class="p">)]</span> <span class="o">=</span> <span class="n">MAX_DISK_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">last_checked</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_selected</span><span class="p">(</span><span class="kt">int</span> <span class="n">dor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">unit</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">unit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_ready_state</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUS_READY</span> <span class="o">|</span> <span class="n">STATUS_DIR</span> <span class="o">|</span> <span class="n">STATUS_DMA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STATUS_READY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_dor</span><span class="p">(</span><span class="kt">int</span> <span class="n">fdc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">unit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">drive</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newdor</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">olddor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">olddor</span> <span class="o">=</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">;</span>
	<span class="n">newdor</span> <span class="o">=</span> <span class="p">(</span><span class="n">olddor</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newdor</span> <span class="o">!=</span> <span class="n">olddor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unit</span> <span class="o">=</span> <span class="n">olddor</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_selected</span><span class="p">(</span><span class="n">olddor</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_selected</span><span class="p">(</span><span class="n">newdor</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drive</span> <span class="o">=</span> <span class="n">REVDRIVE</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
			<span class="n">debug_dcl</span><span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				  <span class="s">&quot;calling disk change from set_dor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">disk_change</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">=</span> <span class="n">newdor</span><span class="p">;</span>
		<span class="n">fd_outb</span><span class="p">(</span><span class="n">newdor</span><span class="p">,</span> <span class="n">FD_DOR</span><span class="p">);</span>

		<span class="n">unit</span> <span class="o">=</span> <span class="n">newdor</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_selected</span><span class="p">(</span><span class="n">olddor</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_selected</span><span class="p">(</span><span class="n">newdor</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drive</span> <span class="o">=</span> <span class="n">REVDRIVE</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
			<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">select_date</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">olddor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twaddle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">fd_outb</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)),</span> <span class="n">FD_DOR</span><span class="p">);</span>
	<span class="n">fd_outb</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">,</span> <span class="n">FD_DOR</span><span class="p">);</span>
	<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">select_date</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset all driver information about the current fdc.</span>
<span class="cm"> * This is needed after a reset, and after a raw command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_fdc_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>

	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">spec1</span> <span class="o">=</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">spec2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">need_configure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">perp_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">==</span> <span class="n">fdc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">||</span> <span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">!=</span> <span class="n">NEED_1_RECAL</span><span class="p">))</span>
			<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">NEED_2_RECAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* selects the fdc and drive, and enables the fdc&#39;s input/dma. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_fdc</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fdc</span> <span class="o">=</span> <span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">current_drive</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fdc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;bad fdc value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_dor</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#if N_FDC &gt; 1</span>
	<span class="n">set_dor</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fdc</span><span class="p">,</span> <span class="o">~</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">reset_fdc_info</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd_inb</span><span class="p">(</span><span class="n">FD_STATUS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_READY</span><span class="p">)</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* locks the driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lock_fdc</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="n">bool</span> <span class="n">interruptible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="s">&quot;Trying to lock fdc while usage count=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">fdc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdc_busy</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">command_status</span> <span class="o">=</span> <span class="n">FD_COMMAND_NONE</span><span class="p">;</span>

	<span class="n">reschedule_timeout</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="s">&quot;lock fdc&quot;</span><span class="p">);</span>
	<span class="n">set_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* unlocks the driver */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unlock_fdc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdc_busy</span><span class="p">))</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;FDC access conflict!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">raw_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">command_status</span> <span class="o">=</span> <span class="n">FD_COMMAND_NONE</span><span class="p">;</span>
	<span class="n">__cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">);</span>
	<span class="n">do_floppy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdc_busy</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdc_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* switches the motor off after a given timeout */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">motor_off_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>

	<span class="n">set_dor</span><span class="p">(</span><span class="n">FDC</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* schedules motor off */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_off</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">volatile</span> <span class="n">delta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fdc</span> <span class="o">=</span> <span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">))))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="n">motor_off_timer</span> <span class="o">+</span> <span class="n">drive</span><span class="p">);</span>

	<span class="cm">/* make spindle stop in a position which minimizes spinup time</span>
<span class="cm">	 * next time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">rps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">first_read_date</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">-</span>
		    <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">spindown_offset</span><span class="p">;</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">delta</span> <span class="o">*</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">rps</span><span class="p">)</span> <span class="o">%</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">rps</span><span class="p">;</span>
		<span class="n">motor_off_timer</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">expires</span> <span class="o">=</span>
		    <span class="n">jiffies</span> <span class="o">+</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">spindown</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="n">motor_off_timer</span> <span class="o">+</span> <span class="n">drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cycle through all N_DRIVE floppy drives, for disk change testing.</span>
<span class="cm"> * stopping at current drive. This is done before any long operation, to</span>
<span class="cm"> * be sure to have up to date disk change information.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scandrives</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_drive</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">saved_drive</span> <span class="o">=</span> <span class="n">current_drive</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="n">saved_drive</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N_DRIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">select_delay</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* skip closed drives */</span>
		<span class="n">set_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">set_dor</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">)))</span> <span class="o">&amp;</span>
		      <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">))))</span>
			<span class="cm">/* switch the motor off again, if it was off to</span>
<span class="cm">			 * begin with */</span>
			<span class="n">set_dor</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_fdc</span><span class="p">(</span><span class="n">saved_drive</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">empty</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">floppy_work</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schedule_bh</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_work</span><span class="p">));</span>

	<span class="n">PREPARE_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_work</span><span class="p">,</span> <span class="p">(</span><span class="n">work_func_t</span><span class="p">)</span><span class="n">handler</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">floppy_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">floppy_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">fd_timer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cancel_activity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_floppy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function makes sure that the disk stays in the drive during the</span>
<span class="cm"> * transfer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fd_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;calling disk change from watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disk_change</span><span class="p">(</span><span class="n">current_drive</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;disk removed during i/o</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cancel_activity</span><span class="p">();</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">reset_fdc</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">);</span>
		<span class="n">PREPARE_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">,</span> <span class="n">fd_watchdog</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">floppy_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">main_command_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">);</span>
	<span class="n">cont</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* waits for a delay (spinup or select) to pass */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fd_wait_for_completion</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span><span class="p">,</span> <span class="n">work_func_t</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_fdc</span><span class="p">();</span>	<span class="cm">/* do the reset during sleep to win time</span>
<span class="cm">				 * if we don&#39;t need to sleep, it&#39;s a good</span>
<span class="cm">				 * occasion anyways */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expires</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">);</span>
		<span class="n">PREPARE_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">floppy_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">,</span> <span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_DMA</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;zero dma transfer size:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%x,&quot;</span><span class="p">,</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;non aligned address: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">fd_disable_dma</span><span class="p">();</span>
<span class="cp">#ifdef fd_dma_setup</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd_dma_setup</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">,</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_READ</span><span class="p">)</span> <span class="o">?</span>
			 <span class="n">DMA_MODE_READ</span> <span class="o">:</span> <span class="n">DMA_MODE_WRITE</span><span class="p">,</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">fd_clear_dma_ff</span><span class="p">();</span>
	<span class="n">fd_cacheflush</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">,</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">fd_set_dma_mode</span><span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_READ</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DMA_MODE_READ</span> <span class="o">:</span> <span class="n">DMA_MODE_WRITE</span><span class="p">);</span>
	<span class="n">fd_set_dma_addr</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">);</span>
	<span class="n">fd_set_dma_count</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">virtual_dma_port</span> <span class="o">=</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="n">fd_enable_dma</span><span class="p">();</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">show_floppy</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* waits until the fdc becomes ready */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_til_ready</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">counter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fd_inb</span><span class="p">(</span><span class="n">FD_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_READY</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Getstatus times out (%x) on fdc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="n">show_floppy</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sends a command byte to the fdc */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">output_byte</span><span class="p">(</span><span class="kt">char</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">wait_til_ready</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ready_state</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fd_outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">FD_DATA</span><span class="p">);</span>
		<span class="n">output_log</span><span class="p">[</span><span class="n">output_log_pos</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
		<span class="n">output_log</span><span class="p">[</span><span class="n">output_log_pos</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">output_log</span><span class="p">[</span><span class="n">output_log_pos</span><span class="p">].</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">output_log_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_log_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">OLOGSIZE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Unable to send byte %x to FDC. Fdc=%x Status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">byte</span><span class="p">,</span> <span class="n">fdc</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">show_floppy</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gets the response from the fdc */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">result</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REPLIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">wait_til_ready</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">STATUS_DIR</span> <span class="o">|</span> <span class="n">STATUS_READY</span> <span class="o">|</span> <span class="n">STATUS_BUSY</span> <span class="o">|</span> <span class="n">STATUS_DMA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">STATUS_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATUS_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resultjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">resultsize</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">STATUS_DIR</span> <span class="o">|</span> <span class="n">STATUS_READY</span> <span class="o">|</span> <span class="n">STATUS_BUSY</span><span class="p">))</span>
			<span class="n">reply_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd_inb</span><span class="p">(</span><span class="n">FD_DATA</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;get result error. Fdc=%d Last status=%x Read bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fdc</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">show_floppy</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MORE_OUTPUT -2</span>
<span class="cm">/* does the fdc need more output? */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">need_more_output</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">wait_til_ready</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ready_state</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MORE_OUTPUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Set perpendicular mode as required, based on data rate, if supported.</span>
<span class="cm"> * 82077 Now tested. 1Mbps data rate only possible with 82077-1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">perpendicular_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">perp_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">perp_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">perp_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Invalid data rate for perpendicular mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * convenient way to return to</span>
<span class="cm">					 * redo without too much hassle</span>
<span class="cm">					 * (deep stack et al.)</span>
<span class="cm">					 */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">perp_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">perp_mode</span> <span class="o">==</span> <span class="n">perp_mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">FDC_82077_ORIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_PERPENDICULAR</span><span class="p">);</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="n">perp_mode</span><span class="p">);</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">perp_mode</span> <span class="o">=</span> <span class="n">perp_mode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perp_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;perpendicular mode not supported by this FDC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* perpendicular_mode */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fifo_depth</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">no_fifo</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fdc_configure</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Turn on FIFO */</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_CONFIGURE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_more_output</span><span class="p">()</span> <span class="o">!=</span> <span class="n">MORE_OUTPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">|</span> <span class="p">(</span><span class="n">no_fifo</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fifo_depth</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>		<span class="cm">/* pre-compensation from track</span>
<span class="cm">				   0 upwards */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NOMINAL_DTR 500</span>

<span class="cm">/* Issue a &quot;SPECIFY&quot; command to set the step rate time, head unload time,</span>
<span class="cm"> * head load time, and DMA disable flag to values needed by floppy.</span>
<span class="cm"> *</span>
<span class="cm"> * The value &quot;dtr&quot; is the data transfer rate in Kbps.  It is needed</span>
<span class="cm"> * to account for the data rate-based scaling done by the 82072 and 82077</span>
<span class="cm"> * FDC types.  This parameter is ignored for other types of FDCs (i.e.</span>
<span class="cm"> * 8272a).</span>
<span class="cm"> *</span>
<span class="cm"> * Note that changing the data transfer rate has a (probably deleterious)</span>
<span class="cm"> * effect on the parameters subject to scaling for 82072/82077 FDCs, so</span>
<span class="cm"> * fdc_specify is called again after each data transfer rate</span>
<span class="cm"> * change.</span>
<span class="cm"> *</span>
<span class="cm"> * srt: 1000 to 16000 in microseconds</span>
<span class="cm"> * hut: 16 to 240 milliseconds</span>
<span class="cm"> * hlt: 2 to 254 milliseconds</span>
<span class="cm"> *</span>
<span class="cm"> * These values are rounded up to the next highest available delay time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fdc_specify</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">spec1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">spec2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">srt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hlt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hut</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dtr</span> <span class="o">=</span> <span class="n">NOMINAL_DTR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scale_dtr</span> <span class="o">=</span> <span class="n">NOMINAL_DTR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlt_max_code</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hut_max_code</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">need_configure</span> <span class="o">&amp;&amp;</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">FDC_82072A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fdc_configure</span><span class="p">();</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">need_configure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">dtr</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dtr</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">FDC_82078</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* chose the default rate table, not the one</span>
<span class="cm">			 * where 1 = 2 Mbps */</span>
			<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_DRIVESPEC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">need_more_output</span><span class="p">()</span> <span class="o">==</span> <span class="n">MORE_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">output_byte</span><span class="p">(</span><span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">));</span>
				<span class="n">output_byte</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dtr</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">FDC_82072</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scale_dtr</span> <span class="o">=</span> <span class="n">dtr</span><span class="p">;</span>
		<span class="n">hlt_max_code</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0==256msec*dtr0/dtr (not linear!) */</span>
		<span class="n">hut_max_code</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* 0==256msec*dtr0/dtr (not linear!) */</span>
	<span class="p">}</span>

	<span class="cm">/* Convert step rate from microseconds to milliseconds and 4 bits */</span>
	<span class="n">srt</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">srt</span> <span class="o">*</span> <span class="n">scale_dtr</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">NOMINAL_DTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slow_floppy</span><span class="p">)</span>
		<span class="n">srt</span> <span class="o">=</span> <span class="n">srt</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">SUPBOUND</span><span class="p">(</span><span class="n">srt</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">INFBOUND</span><span class="p">(</span><span class="n">srt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hlt</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">hlt</span> <span class="o">*</span> <span class="n">scale_dtr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOMINAL_DTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hlt</span> <span class="o">&lt;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">hlt</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hlt</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span>
		<span class="n">hlt</span> <span class="o">=</span> <span class="n">hlt_max_code</span><span class="p">;</span>

	<span class="n">hut</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">hut</span> <span class="o">*</span> <span class="n">scale_dtr</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">NOMINAL_DTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hut</span> <span class="o">&lt;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">hut</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hut</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span>
		<span class="n">hut</span> <span class="o">=</span> <span class="n">hut_max_code</span><span class="p">;</span>

	<span class="n">spec1</span> <span class="o">=</span> <span class="p">(</span><span class="n">srt</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">hut</span><span class="p">;</span>
	<span class="n">spec2</span> <span class="o">=</span> <span class="p">(</span><span class="n">hlt</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">use_virtual_dma</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* If these parameters did not change, just return with success */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">spec1</span> <span class="o">!=</span> <span class="n">spec1</span> <span class="o">||</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">spec2</span> <span class="o">!=</span> <span class="n">spec2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Go ahead and set spec1 and spec2 */</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_SPECIFY</span><span class="p">);</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">spec1</span> <span class="o">=</span> <span class="n">spec1</span><span class="p">);</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">spec2</span> <span class="o">=</span> <span class="n">spec2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* fdc_specify */</span>

<span class="cm">/* Set the FDC&#39;s data transfer rate on behalf of the specified drive.</span>
<span class="cm"> * NOTE: with 82072/82077 FDCs, changing the data rate requires a reissue</span>
<span class="cm"> * of the specify command (i.e. using the fdc_specify function).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fdc_dtr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If data rate not already set to desired value, set it. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dtr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set dtr */</span>
	<span class="n">fd_outb</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">FD_DCR</span><span class="p">);</span>

	<span class="cm">/* TODO: some FDC/drive combinations (C&amp;T 82C711 with TEAC 1.2MB)</span>
<span class="cm">	 * need a stabilization period of several milliseconds to be</span>
<span class="cm">	 * enforced after data rate changes before R/W operations.</span>
<span class="cm">	 * Pause 5 msec to avoid trouble. (Needs to be 2 jiffies)</span>
<span class="cm">	 */</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dtr</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fd_wait_for_completion</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2UL</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">work_func_t</span><span class="p">)</span><span class="n">floppy_ready</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* fdc_dtr */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tell_sector</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;: track %d, head %d, sector %d, size %d&quot;</span><span class="p">,</span>
		<span class="n">R_TRACK</span><span class="p">,</span> <span class="n">R_HEAD</span><span class="p">,</span> <span class="n">R_SECTOR</span><span class="p">,</span> <span class="n">R_SIZECODE</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* tell_sector */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_errors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ST0</span> <span class="o">&amp;</span> <span class="n">ST0_ECE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Recalibrate failed!&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ST2</span> <span class="o">&amp;</span> <span class="n">ST2_CRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;data CRC error&quot;</span><span class="p">);</span>
		<span class="n">tell_sector</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ST1</span> <span class="o">&amp;</span> <span class="n">ST1_CRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CRC error&quot;</span><span class="p">);</span>
		<span class="n">tell_sector</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ST1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ST1_MAM</span> <span class="o">|</span> <span class="n">ST1_ND</span><span class="p">))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ST2</span> <span class="o">&amp;</span> <span class="n">ST2_MAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;sector not found&quot;</span><span class="p">);</span>
			<span class="n">tell_sector</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;probe failed...&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ST2</span> <span class="o">&amp;</span> <span class="n">ST2_WC</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* seek error */</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;wrong cylinder&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ST2</span> <span class="o">&amp;</span> <span class="n">ST2_BC</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* cylinder marked as bad */</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;bad cylinder&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;unknown error. ST[0..2] are: 0x%x 0x%x 0x%x&quot;</span><span class="p">,</span>
			<span class="n">ST0</span><span class="p">,</span> <span class="n">ST1</span><span class="p">,</span> <span class="n">ST2</span><span class="p">);</span>
		<span class="n">tell_sector</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * OK, this error interpreting routine is called after a</span>
<span class="cm"> * DMA read/write has succeeded</span>
<span class="cm"> * or failed, so we check the results, and copy any buffers.</span>
<span class="cm"> * hhb: Added better error reporting.</span>
<span class="cm"> * ak: Made this into a separate routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">interpret_errors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inr</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;-- FDC reply error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check IC to find cause of interrupt */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ST0</span> <span class="o">&amp;</span> <span class="n">ST0_INTR</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x40</span>:		<span class="cm">/* error occurred during command execution */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ST1</span> <span class="o">&amp;</span> <span class="n">ST1_EOC</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* occurs with pseudo-DMA */</span>
		<span class="n">bad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ST1</span> <span class="o">&amp;</span> <span class="n">ST1_WP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Drive is write protected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_DISK_WRITABLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">bad</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ST1</span> <span class="o">&amp;</span> <span class="n">ST1_ND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_NEED_TWADDLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ST1</span> <span class="o">&amp;</span> <span class="n">ST1_OR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FTD_MSG</span><span class="p">)</span>
				<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Over/Underrun - retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">errors</span> <span class="o">&gt;=</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">.</span><span class="n">reporting</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_errors</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ST2</span> <span class="o">&amp;</span> <span class="n">ST2_WC</span> <span class="o">||</span> <span class="n">ST2</span> <span class="o">&amp;</span> <span class="n">ST2_BC</span><span class="p">)</span>
			<span class="cm">/* wrong cylinder =&gt; recal */</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">NEED_2_RECAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x80</span>:		<span class="cm">/* invalid command given */</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Invalid FDC command given!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xc0</span>:
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Abnormal termination caused by polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* (0) Normal command termination */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called when everything should be correctly set up</span>
<span class="cm"> * for the transfer (i.e. floppy motor is on, the correct floppy is</span>
<span class="cm"> * selected, and the head is sitting on the right track).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_rw_floppy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dflags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ready_date</span><span class="p">;</span>
	<span class="n">work_func_t</span> <span class="n">function</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FD_RAW_READ</span> <span class="o">|</span> <span class="n">FD_RAW_WRITE</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_INTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_SPIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NO_MOTOR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ready_date</span> <span class="o">=</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">spinup_date</span> <span class="o">+</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">spinup</span><span class="p">;</span>
		<span class="cm">/* If spinup will take a long time, rerun scandrives</span>
<span class="cm">		 * again just before spinup completion. Beware that</span>
<span class="cm">		 * after scandrives, we must again wait for selection.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">ready_date</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ready_date</span> <span class="o">-=</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">;</span>
			<span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">work_func_t</span><span class="p">)</span><span class="n">floppy_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">work_func_t</span><span class="p">)</span><span class="n">setup_rw_floppy</span><span class="p">;</span>

		<span class="cm">/* wait until the floppy is spinning fast enough */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd_wait_for_completion</span><span class="p">(</span><span class="n">ready_date</span><span class="p">,</span> <span class="n">function</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dflags</span> <span class="o">=</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_READ</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_WRITE</span><span class="p">))</span>
		<span class="n">setup_DMA</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_INTR</span><span class="p">)</span>
		<span class="n">do_floppy</span> <span class="o">=</span> <span class="n">main_command_interrupt</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">output_byte</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;rw_command&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">();</span>
		<span class="n">reset_fdc</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_INTR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inr</span> <span class="o">=</span> <span class="n">result</span><span class="p">();</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">)</span>
		<span class="n">fd_watchdog</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">blind_seek</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This is the routine called after every seek (or recalibrate) interrupt</span>
<span class="cm"> * from the floppy controller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">seek_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inr</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">ST0</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;seek failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">NEED_2_RECAL</span><span class="p">;</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">();</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">!=</span> <span class="n">ST1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">blind_seek</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
			  <span class="s">&quot;clearing NEWCHANGE flag because of effective seek</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;jiffies=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="cm">/* effective seek */</span>
		<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">select_date</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">ST1</span><span class="p">;</span>
	<span class="n">floppy_ready</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_wp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* check write protection */</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_GETSTATUS</span><span class="p">);</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_NEED_TWADDLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
			  <span class="s">&quot;checking whether disk is write protected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;wp=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ST3</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ST3</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_WRITABLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_DISK_WRITABLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seek_floppy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">track</span><span class="p">;</span>

	<span class="n">blind_seek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;calling disk change from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">disk_change</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* the media changed flag should be cleared after the seek.</span>
<span class="cm">		 * If it isn&#39;t, this means that there is really no disk in</span>
<span class="cm">		 * the drive.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&lt;=</span> <span class="n">NEED_1_RECAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recalibrate_floppy</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&lt;=</span> <span class="n">NO_TRACK</span> <span class="o">||</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">==</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we seek to clear the media-changed condition. Does anybody</span>
<span class="cm">		 * know a more elegant way, which works on all drives? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">)</span>
			<span class="n">track</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_SILENT_DCL_CLEAR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_dor</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">blind_seek</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_NEED_SEEK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">check_wp</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">!=</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NEED_SEEK</span><span class="p">))</span>
			<span class="n">track</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">setup_rw_floppy</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">do_floppy</span> <span class="o">=</span> <span class="n">seek_interrupt</span><span class="p">;</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_SEEK</span><span class="p">);</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">output_byte</span><span class="p">(</span><span class="n">track</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_fdc</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recal_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inr</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ST0</span> <span class="o">&amp;</span> <span class="n">ST0_ECE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NEED_1_RECAL</span>:
			<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;need 1 recal&quot;</span><span class="p">);</span>
			<span class="cm">/* after a second recalibrate, we still haven&#39;t</span>
<span class="cm">			 * reached track 0. Probably no drive. Raise an</span>
<span class="cm">			 * error, as failing immediately might upset</span>
<span class="cm">			 * computers possessed by the Devil :-) */</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">();</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NEED_2_RECAL</span>:
			<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;need 2 recal&quot;</span><span class="p">);</span>
			<span class="cm">/* If we already did a recalibrate,</span>
<span class="cm">			 * and we are not at track 0, this</span>
<span class="cm">			 * means we have moved. (The only way</span>
<span class="cm">			 * not to move at recalibration is to</span>
<span class="cm">			 * be already at track 0.) Clear the</span>
<span class="cm">			 * new change flag */</span>
			<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				  <span class="s">&quot;clearing NEWCHANGE flag because of second recalibrate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">select_date</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="nl">default:</span>
			<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">);</span>
			<span class="cm">/* Recalibrate moves the head by at</span>
<span class="cm">			 * most 80 steps. If after one</span>
<span class="cm">			 * recalibrate we don&#39;t have reached</span>
<span class="cm">			 * track 0, this might mean that we</span>
<span class="cm">			 * started beyond track 80.  Try</span>
<span class="cm">			 * again.  */</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">NEED_1_RECAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">ST1</span><span class="p">;</span>
	<span class="n">floppy_ready</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_result</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;repl[%d]=%x &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reply_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* interrupt handler. Note that this can be called externally on the Sparc */</span>
<span class="n">irqreturn_t</span> <span class="nf">floppy_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">do_print</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="n">do_floppy</span><span class="p">;</span>

	<span class="n">lasthandler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
	<span class="n">interruptjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">fd_disable_dma</span><span class="p">();</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="n">do_floppy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdc</span> <span class="o">&gt;=</span> <span class="n">N_FDC</span> <span class="o">||</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we don&#39;t even know which FDC is the culprit */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DOR0=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dor</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;floppy interrupt on bizarre fdc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;handler=%pf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
		<span class="n">is_alive</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;bizarre fdc&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* We have to clear the reset flag here, because apparently on boxes</span>
<span class="cm">	 * with level triggered interrupts (PS/2, Sparc, ...), it is needed to</span>
<span class="cm">	 * emit SENSEI&#39;s to clear the interrupt line. And FDCS-&gt;reset blocks the</span>
<span class="cm">	 * emission of the SENSEI&#39;s.</span>
<span class="cm">	 * It is OK to emit floppy commands because we are in an interrupt</span>
<span class="cm">	 * handler here, and thus we have to fear no interference of other</span>
<span class="cm">	 * activity.</span>
<span class="cm">	 */</span>

	<span class="n">do_print</span> <span class="o">=</span> <span class="o">!</span><span class="n">handler</span> <span class="o">&amp;&amp;</span> <span class="n">print_unex</span> <span class="o">&amp;&amp;</span> <span class="n">initialized</span><span class="p">;</span>

	<span class="n">inr</span> <span class="o">=</span> <span class="n">result</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_print</span><span class="p">)</span>
		<span class="n">print_result</span><span class="p">(</span><span class="s">&quot;unexpected interrupt&quot;</span><span class="p">,</span> <span class="n">inr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_sensei</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_SENSEI</span><span class="p">);</span>
			<span class="n">inr</span> <span class="o">=</span> <span class="n">result</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_print</span><span class="p">)</span>
				<span class="n">print_result</span><span class="p">(</span><span class="s">&quot;sensei&quot;</span><span class="p">,</span> <span class="n">inr</span><span class="p">);</span>
			<span class="n">max_sensei</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">ST0</span> <span class="o">&amp;</span> <span class="mh">0x83</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">inr</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">max_sensei</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">schedule_bh</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
	<span class="n">is_alive</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;normal interrupt end&quot;</span><span class="p">);</span>

	<span class="cm">/* FIXME! Was it really for us? */</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recalibrate_floppy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">do_floppy</span> <span class="o">=</span> <span class="n">recal_interrupt</span><span class="p">;</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_RECALIBRATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">output_byte</span><span class="p">(</span><span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reset_fdc</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must do 4 FD_SENSEIs after reset because of ``drive polling&#39;&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">result</span><span class="p">();</span>		<span class="cm">/* get the status ready for set_fdc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;reset set in interrupt, calling %pf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">();</span>	<span class="cm">/* a reset just after a reset. BAD! */</span>
	<span class="p">}</span>
	<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reset is done by pulling bit 2 of DOR low for a while (old FDCs),</span>
<span class="cm"> * or by setting the self clearing bit 7 of STATUS (newer FDCs)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_fdc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">do_floppy</span> <span class="o">=</span> <span class="n">reset_interrupt</span><span class="p">;</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reset_fdc_info</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Pseudo-DMA may intercept &#39;reset finished&#39; interrupt.  */</span>
	<span class="cm">/* Irrelevant for systems with true DMA (i386).          */</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">fd_disable_dma</span><span class="p">();</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">FDC_82072A</span><span class="p">)</span>
		<span class="n">fd_outb</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dtr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">FD_STATUS</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fd_outb</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">FD_DOR</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">FD_RESET_DELAY</span><span class="p">);</span>
		<span class="n">fd_outb</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">,</span> <span class="n">FD_DOR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_floppy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;floppy driver state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;-------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;now=%lu last interrupt=%lu diff=%lu last called handler=%pf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">jiffies</span><span class="p">,</span> <span class="n">interruptjiffies</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">interruptjiffies</span><span class="p">,</span>
		<span class="n">lasthandler</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;timeout_message=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout_message</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;last output bytes:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OLOGSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%2x %2x %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">output_log</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">output_log_pos</span><span class="p">)</span> <span class="o">%</span> <span class="n">OLOGSIZE</span><span class="p">].</span><span class="n">data</span><span class="p">,</span>
			<span class="n">output_log</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">output_log_pos</span><span class="p">)</span> <span class="o">%</span> <span class="n">OLOGSIZE</span><span class="p">].</span><span class="n">status</span><span class="p">,</span>
			<span class="n">output_log</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">output_log_pos</span><span class="p">)</span> <span class="o">%</span> <span class="n">OLOGSIZE</span><span class="p">].</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;last result at %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resultjiffies</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;last redo_fd_request at %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lastredo</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">reply_buffer</span><span class="p">,</span> <span class="n">resultsize</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd_inb</span><span class="p">(</span><span class="n">FD_STATUS</span><span class="p">));</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;fdc_busy=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc_busy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_floppy</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;do_floppy=%pf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">do_floppy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_work</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;floppy_work.func=%pf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">floppy_work</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;delayed work.function=%p expires=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fd_timer</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">func</span><span class="p">,</span>
		       <span class="n">fd_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;timer_function=%p expires=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fd_timeout</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">func</span><span class="p">,</span>
		       <span class="n">fd_timeout</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cont=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;current_req=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current_req</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;command_status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command_status</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">show_floppy</span><span class="p">();</span>
	<span class="n">cancel_activity</span><span class="p">();</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">fd_disable_dma</span><span class="p">();</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* avoid dma going to a random drive after shutdown */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;floppy timeout called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>	<span class="cm">/* this will recall reset when needed */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;no cont in shutdown!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">is_alive</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* start motor, check media-changed condition and write protection */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_motor</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfc</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NO_MOTOR</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">set_debugt</span><span class="p">();</span>
			<span class="cm">/* no read since this drive is running */</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">first_read_date</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* note motor start time if motor is not yet running */</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">spinup_date</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)))</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">));</span>

	<span class="cm">/* starts motor and selects floppy */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="n">motor_off_timer</span> <span class="o">+</span> <span class="n">current_drive</span><span class="p">);</span>
	<span class="n">set_dor</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* wait_for_completion also schedules reset if needed. */</span>
	<span class="k">return</span> <span class="n">fd_wait_for_completion</span><span class="p">(</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">select_date</span> <span class="o">+</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">work_func_t</span><span class="p">)</span><span class="n">function</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_ready</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_fdc</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_motor</span><span class="p">(</span><span class="n">floppy_ready</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdc_dtr</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;calling disk change from floppy_ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NO_MOTOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">disk_change</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">)</span>
		<span class="n">twaddle</span><span class="p">();</span>	<span class="cm">/* this clears the dcl on certain</span>
<span class="cm">				 * drive/controller combinations */</span>

<span class="cp">#ifdef fd_chose_dma_mode</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_READ</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">fd_chose_dma_mode</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">,</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FD_RAW_NEED_SEEK</span> <span class="o">|</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">perpendicular_mode</span><span class="p">();</span>
		<span class="n">fdc_specify</span><span class="p">();</span>	<span class="cm">/* must be done here because of hut, hlt ... */</span>
		<span class="n">seek_floppy</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_READ</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_WRITE</span><span class="p">))</span>
			<span class="n">fdc_specify</span><span class="p">();</span>
		<span class="n">setup_rw_floppy</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reschedule_timeout</span><span class="p">(</span><span class="n">current_reqD</span><span class="p">,</span> <span class="s">&quot;floppy start&quot;</span><span class="p">);</span>

	<span class="n">scandrives</span><span class="p">();</span>
	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;setting NEWCHANGE in floppy_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">floppy_ready</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ========================================================================</span>
<span class="cm"> * here ends the bottom half. Exported routines are:</span>
<span class="cm"> * floppy_start, floppy_off, floppy_ready, lock_fdc, unlock_fdc, set_fdc,</span>
<span class="cm"> * start_motor, reset_fdc, reset_fdc_info, interpret_errors.</span>
<span class="cm"> * Initialization also uses output_byte, result, set_dor, floppy_interrupt</span>
<span class="cm"> * and set_dor.</span>
<span class="cm"> * ========================================================================</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * General purpose continuations.</span>
<span class="cm"> * ==============================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_wakeup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reschedule_timeout</span><span class="p">(</span><span class="n">MAXTIMEOUT</span><span class="p">,</span> <span class="s">&quot;do wakeup&quot;</span><span class="p">);</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">command_status</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="n">wakeup_cont</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">redo</span>		<span class="o">=</span> <span class="n">do_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="n">empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">done</span>		<span class="o">=</span> <span class="p">(</span><span class="n">done_f</span><span class="p">)</span><span class="n">empty</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="n">intr_cont</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">redo</span>		<span class="o">=</span> <span class="n">process_fd_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="n">empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">done</span>		<span class="o">=</span> <span class="p">(</span><span class="n">done_f</span><span class="p">)</span><span class="n">empty</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_til_done</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">void</span><span class="p">),</span> <span class="n">bool</span> <span class="n">interruptible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">schedule_bh</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interruptible</span><span class="p">)</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">command_done</span><span class="p">,</span> <span class="n">command_status</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">command_done</span><span class="p">,</span> <span class="n">command_status</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command_status</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_activity</span><span class="p">();</span>
		<span class="n">cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intr_cont</span><span class="p">;</span>
		<span class="n">reset_fdc</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">command_status</span> <span class="o">=</span> <span class="n">FD_COMMAND_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_status</span> <span class="o">==</span> <span class="n">FD_COMMAND_OKAY</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">command_status</span> <span class="o">=</span> <span class="n">FD_COMMAND_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generic_done</span><span class="p">(</span><span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">command_status</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wakeup_cont</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generic_success</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generic_failure</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">success_and_wakeup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">generic_success</span><span class="p">();</span>
	<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * formatting and rw support.</span>
<span class="cm"> * ==========================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">next_valid_format</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">probed_format</span><span class="p">;</span>

	<span class="n">probed_format</span> <span class="o">=</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">probed_format</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">probed_format</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">||</span> <span class="o">!</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">[</span><span class="n">probed_format</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">probed_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">floppy_type</span><span class="p">[</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">[</span><span class="n">probed_format</span><span class="p">]].</span><span class="n">sect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">probed_format</span> <span class="o">=</span> <span class="n">probed_format</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">probed_format</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bad_flp_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">probed_format</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_valid_format</span><span class="p">())</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err_count</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">errors</span><span class="p">);</span>
	<span class="n">INFBOUND</span><span class="p">(</span><span class="n">DRWE</span><span class="o">-&gt;</span><span class="n">badness</span><span class="p">,</span> <span class="n">err_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_count</span> <span class="o">&gt;</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">.</span><span class="n">abort</span><span class="p">)</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_count</span> <span class="o">&gt;</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">.</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err_count</span> <span class="o">&gt;</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">.</span><span class="n">recal</span><span class="p">)</span>
		<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">NEED_2_RECAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_floppy</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">ITYPE</span><span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
		<span class="n">_floppy</span> <span class="o">=</span> <span class="n">floppy_type</span> <span class="o">+</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">_floppy</span> <span class="o">=</span> <span class="n">current_type</span><span class="p">[</span><span class="n">drive</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * formatting support.</span>
<span class="cm"> * ===================</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">format_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">interpret_errors</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#define FM_MODE(x, y) ((y) &amp; ~(((x)-&gt;rate &amp; 0x80) &gt;&gt; 1))</span>
<span class="cp">#define CT(x) ((x) | 0xc0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_format_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">track</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">il</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">head_shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">track_shift</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fparm</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">track</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">here</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fparm</span> <span class="o">*</span><span class="p">)</span><span class="n">floppy_track_buffer</span><span class="p">;</span>

	<span class="n">raw_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_raw_cmd</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">track</span><span class="p">;</span>

	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">FD_RAW_WRITE</span> <span class="o">|</span> <span class="n">FD_RAW_INTR</span> <span class="o">|</span> <span class="n">FD_RAW_SPIN</span> <span class="o">|</span>
			  <span class="n">FD_RAW_NEED_DISK</span> <span class="o">|</span> <span class="n">FD_RAW_NEED_SEEK</span><span class="p">);</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x43</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">cmd_count</span> <span class="o">=</span> <span class="n">NR_F</span><span class="p">;</span>
	<span class="n">COMMAND</span> <span class="o">=</span> <span class="n">FM_MODE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">,</span> <span class="n">FD_FORMAT</span><span class="p">);</span>
	<span class="n">DR_SELECT</span> <span class="o">=</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)</span> <span class="o">+</span> <span class="n">PH_HEAD</span><span class="p">(</span><span class="n">_floppy</span><span class="p">,</span> <span class="n">format_req</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>
	<span class="n">F_SIZECODE</span> <span class="o">=</span> <span class="n">FD_SIZECODE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">);</span>
	<span class="n">F_SECT_PER_TRACK</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">&gt;&gt;</span> <span class="n">F_SIZECODE</span><span class="p">;</span>
	<span class="n">F_GAP</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">fmt_gap</span><span class="p">;</span>
	<span class="n">F_FILL</span> <span class="o">=</span> <span class="n">FD_FILL_BYTE</span><span class="p">;</span>

	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">=</span> <span class="n">floppy_track_buffer</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">;</span>

	<span class="cm">/* allow for about 30ms for data transport per track */</span>
	<span class="n">head_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">F_SECT_PER_TRACK</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>

	<span class="cm">/* a ``cylinder&#39;&#39; is two tracks plus a little stepping time */</span>
	<span class="n">track_shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">head_shift</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* position of logical sector 1 on this track */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">track_shift</span> <span class="o">*</span> <span class="n">format_req</span><span class="p">.</span><span class="n">track</span> <span class="o">+</span> <span class="n">head_shift</span> <span class="o">*</span> <span class="n">format_req</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
	    <span class="o">%</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">;</span>

	<span class="cm">/* determine interleave */</span>
	<span class="n">il</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">fmt_gap</span> <span class="o">&lt;</span> <span class="mh">0x22</span><span class="p">)</span>
		<span class="n">il</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* initialize field */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">;</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">here</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">track</span> <span class="o">=</span> <span class="n">format_req</span><span class="p">.</span><span class="n">track</span><span class="p">;</span>
		<span class="n">here</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">head</span> <span class="o">=</span> <span class="n">format_req</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		<span class="n">here</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">sect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">here</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">F_SIZECODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* place logical sectors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">;</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">here</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">sect</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">il</span><span class="p">)</span> <span class="o">%</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">here</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">sect</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* sector busy, find next free sector */</span>
			<span class="o">++</span><span class="n">n</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">here</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">sect</span><span class="p">)</span>
					<span class="o">++</span><span class="n">n</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">stretch</span> <span class="o">&amp;</span> <span class="n">FD_SECTBASEMASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">F_SECT_PER_TRACK</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
			<span class="n">here</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">sect</span> <span class="o">+=</span> <span class="n">FD_SECTBASE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">redo_format</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buffer_track</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">setup_format_params</span><span class="p">(</span><span class="n">format_req</span><span class="p">.</span><span class="n">track</span> <span class="o">&lt;&lt;</span> <span class="n">STRETCH</span><span class="p">(</span><span class="n">_floppy</span><span class="p">));</span>
	<span class="n">floppy_start</span><span class="p">();</span>
	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;queue format request&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="n">format_cont</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">format_interrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">redo</span>		<span class="o">=</span> <span class="n">redo_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="n">bad_flp_intr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">done</span>		<span class="o">=</span> <span class="n">generic_done</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_format</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="k">struct</span> <span class="n">format_descr</span> <span class="o">*</span><span class="n">tmp_format_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">set_floppy</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_floppy</span> <span class="o">||</span>
	    <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&gt;</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">tracks</span> <span class="o">||</span>
	    <span class="n">tmp_format_req</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&gt;=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">||</span>
	    <span class="n">tmp_format_req</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FD_SIZECODE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">fmt_gap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">format_req</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp_format_req</span><span class="p">;</span>
	<span class="n">format_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">format_cont</span><span class="p">;</span>
	<span class="n">errors</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">format_errors</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_til_done</span><span class="p">(</span><span class="n">redo_format</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer read/write and support</span>
<span class="cm"> * =============================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_end_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_sectors</span> <span class="o">=</span> <span class="n">current_count_sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* current_count_sectors can be zero if transfer failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">nr_sectors</span> <span class="o">=</span> <span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">nr_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We&#39;re done with the request */</span>
	<span class="n">floppy_off</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">current_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* new request_done. Can handle physical sectors which are smaller than a</span>
<span class="cm"> * logical buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">request_done</span><span class="p">(</span><span class="kt">int</span> <span class="n">uptodate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">current_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">block</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;request done &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">];</span>

	<span class="n">probing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="s">&quot;request done %d&quot;</span><span class="p">,</span> <span class="n">uptodate</span><span class="p">);</span>
	<span class="n">reschedule_timeout</span><span class="p">(</span><span class="n">MAXTIMEOUT</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;floppy.c: no request in request_done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* maintain values for invalidation on geometry</span>
<span class="cm">		 * change */</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">current_count_sectors</span> <span class="o">+</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">INFBOUND</span><span class="p">(</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">maxblock</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">maxtrack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* unlock chained buffers */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">floppy_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* record write error information */</span>
			<span class="n">DRWE</span><span class="o">-&gt;</span><span class="n">write_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DRWE</span><span class="o">-&gt;</span><span class="n">write_errors</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRWE</span><span class="o">-&gt;</span><span class="n">first_error_sector</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="n">DRWE</span><span class="o">-&gt;</span><span class="n">first_error_generation</span> <span class="o">=</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DRWE</span><span class="o">-&gt;</span><span class="n">last_error_sector</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="n">DRWE</span><span class="o">-&gt;</span><span class="n">last_error_generation</span> <span class="o">=</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">floppy_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler evaluating the result of the r/w operation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rw_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">eoc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ssize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">R_HEAD</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some Toshiba floppy controllers occasionnally seem to</span>
<span class="cm">		 * return bogus interrupts after read/write operations, which</span>
<span class="cm">		 * can be recognized by a bad head number (&gt;= 2) */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">first_read_date</span><span class="p">)</span>
		<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">first_read_date</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ssize</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SIZECODE</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ST1</span> <span class="o">&amp;</span> <span class="n">ST1_EOC</span><span class="p">)</span>
		<span class="n">eoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">eoc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="p">(((</span><span class="n">R_TRACK</span> <span class="o">-</span> <span class="n">TRACK</span><span class="p">)</span> <span class="o">*</span> <span class="n">heads</span> <span class="o">+</span>
		       <span class="n">R_HEAD</span> <span class="o">-</span> <span class="n">HEAD</span><span class="p">)</span> <span class="o">*</span> <span class="n">SECT_PER_TRACK</span> <span class="o">+</span>
		      <span class="n">R_SECTOR</span> <span class="o">-</span> <span class="n">SECTOR</span> <span class="o">+</span> <span class="n">eoc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SIZECODE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_sectors</span> <span class="o">/</span> <span class="n">ssize</span> <span class="o">&gt;</span>
	    <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">in_sector_offset</span> <span class="o">+</span> <span class="n">current_count_sectors</span><span class="p">,</span> <span class="n">ssize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;long rw: %x instead of %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">nr_sectors</span><span class="p">,</span> <span class="n">current_count_sectors</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rs=%d s=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">R_SECTOR</span><span class="p">,</span> <span class="n">SECTOR</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rh=%d h=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">R_HEAD</span><span class="p">,</span> <span class="n">HEAD</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rt=%d t=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">R_TRACK</span><span class="p">,</span> <span class="n">TRACK</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;heads=%d eoc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">eoc</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;spt=%d st=%d ss=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">SECT_PER_TRACK</span><span class="p">,</span> <span class="n">fsector_t</span><span class="p">,</span> <span class="n">ssize</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;in_sector_offset=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_sector_offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nr_sectors</span> <span class="o">-=</span> <span class="n">in_sector_offset</span><span class="p">;</span>
	<span class="n">INFBOUND</span><span class="p">(</span><span class="n">nr_sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SUPBOUND</span><span class="p">(</span><span class="n">current_count_sectors</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">interpret_errors</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_count_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">();</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_count_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">current_type</span><span class="p">[</span><span class="n">current_drive</span><span class="p">]</span> <span class="o">=</span> <span class="n">_floppy</span><span class="p">;</span>
		<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">TOMINOR</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FTD_MSG</span><span class="p">)</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Auto-detected floppy type %s in fd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">current_drive</span><span class="p">);</span>
		<span class="n">current_type</span><span class="p">[</span><span class="n">current_drive</span><span class="p">]</span> <span class="o">=</span> <span class="n">_floppy</span><span class="p">;</span>
		<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">TOMINOR</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">probing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FD_READ</span> <span class="o">||</span>
	    <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">==</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* transfer directly from buffer */</span>
		<span class="n">cont</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_track</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
		<span class="n">buffer_drive</span> <span class="o">=</span> <span class="n">current_drive</span><span class="p">;</span>
		<span class="n">INFBOUND</span><span class="p">(</span><span class="n">buffer_max</span><span class="p">,</span> <span class="n">nr_sectors</span> <span class="o">+</span> <span class="n">fsector_t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cont</span><span class="o">-&gt;</span><span class="n">redo</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Compute maximal contiguous buffer size. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_chain_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">current_req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span> <span class="o">!=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">+=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compute the maximal transfer size */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">transfer_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">ssize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SUPBOUND</span><span class="p">(</span><span class="n">max_sector</span><span class="p">,</span> <span class="n">fsector_t</span> <span class="o">+</span> <span class="n">max_size</span><span class="p">);</span>

	<span class="cm">/* alignment */</span>
	<span class="n">max_sector</span> <span class="o">-=</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">%</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span> <span class="o">%</span> <span class="n">ssize</span><span class="p">;</span>

	<span class="cm">/* transfer size, beginning not aligned */</span>
	<span class="n">current_count_sectors</span> <span class="o">=</span> <span class="n">max_sector</span> <span class="o">-</span> <span class="n">fsector_t</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">max_sector</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move data from/to the track buffer to/from the buffer cache.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">ssize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_sector_2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">remaining</span><span class="p">;</span>		<span class="cm">/* number of transferred 512-byte sectors */</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dma_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>

	<span class="n">max_sector</span> <span class="o">=</span> <span class="n">transfer_size</span><span class="p">(</span><span class="n">ssize</span><span class="p">,</span>
				   <span class="n">min</span><span class="p">(</span><span class="n">max_sector</span><span class="p">,</span> <span class="n">max_sector_2</span><span class="p">),</span>
				   <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_count_sectors</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buffer_max</span> <span class="o">&gt;</span> <span class="n">fsector_t</span> <span class="o">+</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">))</span>
		<span class="n">current_count_sectors</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">buffer_max</span> <span class="o">-</span> <span class="n">fsector_t</span><span class="p">,</span>
					      <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">));</span>

	<span class="n">remaining</span> <span class="o">=</span> <span class="n">current_count_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&gt;</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;in copy buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;current_count_sectors=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current_count_sectors</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;remaining=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;current_req-&gt;nr_sectors=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">));</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;current_req-&gt;current_nr_sectors=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">));</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;max_sector=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_sector</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ssize=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ssize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buffer_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">max_sector</span><span class="p">,</span> <span class="n">buffer_max</span><span class="p">);</span>

	<span class="n">dma_buffer</span> <span class="o">=</span> <span class="n">floppy_track_buffer</span> <span class="o">+</span> <span class="p">((</span><span class="n">fsector_t</span> <span class="o">-</span> <span class="n">buffer_min</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">blk_rq_cur_bytes</span><span class="p">(</span><span class="n">current_req</span><span class="p">);</span>

	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">current_req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remaining</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="n">SUPBOUND</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">remaining</span><span class="p">);</span>

		<span class="n">buffer</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_buffer</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span>
		    <span class="n">floppy_track_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_buffer_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">dma_buffer</span> <span class="o">&lt;</span> <span class="n">floppy_track_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;buffer overrun in copy buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">floppy_track_buffer</span> <span class="o">-</span> <span class="n">dma_buffer</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">));</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;fsector_t=%d buffer_min=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fsector_t</span><span class="p">,</span> <span class="n">buffer_min</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;current_count_sectors=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">current_count_sectors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_READ</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buffer</span><span class="p">)</span> <span class="o">%</span> <span class="mi">512</span><span class="p">)</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;%p buffer not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_READ</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">dma_buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dma_buffer</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">remaining</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">dma_buffer</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">max_sector</span> <span class="o">-=</span> <span class="n">remaining</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;weirdness: remaining %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* work around a bug in pseudo DMA</span>
<span class="cm"> * (on some FDCs) pseudo DMA does not stop when the CPU stops</span>
<span class="cm"> * sending data.  Hence we need a different way to signal the</span>
<span class="cm"> * transfer length:  We use SECT_PER_TRACK.  Unfortunately, this</span>
<span class="cm"> * does not work with MT, hence we can only transfer one head at</span>
<span class="cm"> * a time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">virtualdmabug_workaround</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hard_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_sector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">COMMAND</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* switch off multiple track mode */</span>

		<span class="n">hard_sectors</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">SIZECODE</span><span class="p">);</span>
		<span class="n">end_sector</span> <span class="o">=</span> <span class="n">SECTOR</span> <span class="o">+</span> <span class="n">hard_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end_sector</span> <span class="o">&gt;</span> <span class="n">SECT_PER_TRACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;too many sectors %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">end_sector</span><span class="p">,</span> <span class="n">SECT_PER_TRACK</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SECT_PER_TRACK</span> <span class="o">=</span> <span class="n">end_sector</span><span class="p">;</span>
					<span class="cm">/* make sure SECT_PER_TRACK</span>
<span class="cm">					 * points to end of transfer */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Formulate a read/write request.</span>
<span class="cm"> * this routine decides where to load the data (directly to buffer, or to</span>
<span class="cm"> * tmp floppy area), how much data to load (the size of the buffer, the whole</span>
<span class="cm"> * track, or a single sector)</span>
<span class="cm"> * All floppy_track_buffer handling goes in here. If we ever add track buffer</span>
<span class="cm"> * allocation on the fly, it should be done here. No other part should need</span>
<span class="cm"> * modification.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">make_raw_rw_request</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">aligned_sector_t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tracksize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ssize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">max_buffer_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;VFS: Block I/O scheduled on unopened device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_fdc</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>

	<span class="n">raw_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_raw_cmd</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FD_RAW_SPIN</span> <span class="o">|</span> <span class="n">FD_RAW_NEED_DISK</span> <span class="o">|</span> <span class="n">FD_RAW_NEED_DISK</span> <span class="o">|</span>
	    <span class="n">FD_RAW_NEED_SEEK</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">cmd_count</span> <span class="o">=</span> <span class="n">NR_RW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_READ</span><span class="p">;</span>
		<span class="n">COMMAND</span> <span class="o">=</span> <span class="n">FM_MODE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">,</span> <span class="n">FD_READ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_WRITE</span><span class="p">;</span>
		<span class="n">COMMAND</span> <span class="o">=</span> <span class="n">FM_MODE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">,</span> <span class="n">FD_WRITE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;%s: unknown command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_sector</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">*</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="n">TRACK</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_sector</span><span class="p">;</span>
	<span class="n">fsector_t</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">%</span> <span class="n">max_sector</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&amp;&amp;</span> <span class="n">TRACK</span> <span class="o">&gt;=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">current_count_sectors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">HEAD</span> <span class="o">=</span> <span class="n">fsector_t</span> <span class="o">/</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">stretch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FD_SWAPSIDES</span> <span class="o">|</span> <span class="n">FD_SECTBASEMASK</span><span class="p">))</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">FD_NEED_TWADDLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fsector_t</span> <span class="o">&lt;</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>

	<span class="cm">/* 2M disks have phantom sectors on the first track */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="n">FD_2M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">TRACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">HEAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsector_t</span> <span class="o">&gt;=</span> <span class="n">max_sector</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">current_count_sectors</span> <span class="o">=</span>
			    <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">-</span> <span class="n">fsector_t</span><span class="p">,</span>
				  <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SIZECODE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">SIZECODE</span> <span class="o">=</span> <span class="n">FD_SIZECODE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">);</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x43</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="n">FD_2M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">TRACK</span> <span class="o">||</span> <span class="n">HEAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SIZECODE</span><span class="p">)</span>
		<span class="n">SIZECODE2</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">SIZECODE2</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">TRACK</span> <span class="o">&lt;&lt;</span> <span class="n">STRETCH</span><span class="p">(</span><span class="n">_floppy</span><span class="p">);</span>
	<span class="n">DR_SELECT</span> <span class="o">=</span> <span class="n">UNIT</span><span class="p">(</span><span class="n">current_drive</span><span class="p">)</span> <span class="o">+</span> <span class="n">PH_HEAD</span><span class="p">(</span><span class="n">_floppy</span><span class="p">,</span> <span class="n">HEAD</span><span class="p">);</span>
	<span class="n">GAP</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">gap</span><span class="p">;</span>
	<span class="n">ssize</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SIZECODE</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">SECT_PER_TRACK</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">&gt;&gt;</span> <span class="n">SIZECODE</span><span class="p">;</span>
	<span class="n">SECTOR</span> <span class="o">=</span> <span class="p">((</span><span class="n">fsector_t</span> <span class="o">%</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">&gt;&gt;</span> <span class="n">SIZECODE</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">FD_SECTBASE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">);</span>

	<span class="cm">/* tracksize describes the size which can be filled up with sectors</span>
<span class="cm">	 * of size ssize.</span>
<span class="cm">	 */</span>
	<span class="n">tracksize</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">-</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">%</span> <span class="n">ssize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracksize</span> <span class="o">&lt;</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SECT_PER_TRACK</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tracksize</span> <span class="o">&lt;=</span> <span class="n">fsector_t</span> <span class="o">%</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span>
			<span class="n">SECTOR</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* if we are beyond tracksize, fill up using smaller sectors */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tracksize</span> <span class="o">&lt;=</span> <span class="n">fsector_t</span> <span class="o">%</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">tracksize</span> <span class="o">+</span> <span class="n">ssize</span> <span class="o">&gt;</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SIZECODE</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ssize</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">SECTOR</span><span class="o">++</span><span class="p">;</span>
			<span class="n">SECT_PER_TRACK</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tracksize</span> <span class="o">+=</span> <span class="n">ssize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">HEAD</span> <span class="o">*</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">+</span> <span class="n">tracksize</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TRACK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">HEAD</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="n">FD_2M</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HEAD</span> <span class="o">&amp;&amp;</span> <span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for virtual DMA bug workaround */</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">in_sector_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">fsector_t</span> <span class="o">%</span> <span class="n">_floppy</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">)</span> <span class="o">%</span> <span class="n">ssize</span><span class="p">;</span>
	<span class="n">aligned_sector_t</span> <span class="o">=</span> <span class="n">fsector_t</span> <span class="o">-</span> <span class="n">in_sector_offset</span><span class="p">;</span>
	<span class="n">max_size</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">==</span> <span class="n">buffer_track</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">current_drive</span> <span class="o">==</span> <span class="n">buffer_drive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fsector_t</span> <span class="o">&gt;=</span> <span class="n">buffer_min</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fsector_t</span> <span class="o">&lt;</span> <span class="n">buffer_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* data already in track buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">copy_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_sector</span><span class="p">,</span> <span class="n">buffer_max</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in_sector_offset</span> <span class="o">||</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ssize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>

			<span class="n">sectors</span> <span class="o">=</span> <span class="n">fsector_t</span> <span class="o">+</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">ssize</span> <span class="o">&amp;&amp;</span> <span class="n">sectors</span> <span class="o">&lt;</span> <span class="n">ssize</span> <span class="o">+</span> <span class="n">ssize</span><span class="p">)</span>
				<span class="n">max_size</span> <span class="o">=</span> <span class="n">ssize</span> <span class="o">+</span> <span class="n">ssize</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">max_size</span> <span class="o">=</span> <span class="n">ssize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FD_RAW_WRITE</span><span class="p">;</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_READ</span><span class="p">;</span>
		<span class="n">COMMAND</span> <span class="o">=</span> <span class="n">FM_MODE</span><span class="p">(</span><span class="n">_floppy</span><span class="p">,</span> <span class="n">FD_READ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">&lt;</span> <span class="n">MAX_DMA_ADDRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_limit</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">direct</span><span class="p">,</span> <span class="n">indirect</span><span class="p">;</span>

		<span class="n">indirect</span> <span class="o">=</span>
		    <span class="n">transfer_size</span><span class="p">(</span><span class="n">ssize</span><span class="p">,</span> <span class="n">max_sector</span><span class="p">,</span>
				  <span class="n">max_buffer_sectors</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">fsector_t</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Do NOT use minimum() here---MAX_DMA_ADDRESS is 64 bits wide</span>
<span class="cm">		 * on a 64 bit machine!</span>
<span class="cm">		 */</span>
		<span class="n">max_size</span> <span class="o">=</span> <span class="n">buffer_chain_size</span><span class="p">();</span>
		<span class="n">dma_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_DMA_ADDRESS</span> <span class="o">-</span>
			     <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">max_size</span> <span class="o">&gt;</span> <span class="n">dma_limit</span><span class="p">)</span>
			<span class="n">max_size</span> <span class="o">=</span> <span class="n">dma_limit</span><span class="p">;</span>
		<span class="cm">/* 64 kb boundaries */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CROSS_64KB</span><span class="p">(</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">max_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_64</span> <span class="o">-</span>
				    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">%</span>
				    <span class="n">K_64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">direct</span> <span class="o">=</span> <span class="n">transfer_size</span><span class="p">(</span><span class="n">ssize</span><span class="p">,</span> <span class="n">max_sector</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span> <span class="o">-</span> <span class="n">fsector_t</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We try to read tracks, but if we get too many errors, we</span>
<span class="cm">		 * go back to reading just one sector at a time.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This means we should be able to read a sector even if there</span>
<span class="cm">		 * are other bad sectors on this track.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">indirect</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">direct</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
		     <span class="o">*</span><span class="n">errors</span> <span class="o">&lt;</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">.</span><span class="n">read_track</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="o">!</span><span class="n">probing</span> <span class="o">||</span>
		       <span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">read_track</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">probed_format</span><span class="p">))))))</span> <span class="p">{</span>
			<span class="n">max_size</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">=</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">current_count_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;%s: zero dma transfer attempted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;indirect=%d direct=%d fsector_t=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">indirect</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">fsector_t</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">virtualdmabug_workaround</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_READ</span><span class="p">)</span>
		<span class="n">max_size</span> <span class="o">=</span> <span class="n">max_sector</span><span class="p">;</span>	<span class="cm">/* unbounded */</span>

	<span class="cm">/* claim buffer track if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_track</span> <span class="o">!=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">||</span>	<span class="cm">/* bad track */</span>
	    <span class="n">buffer_drive</span> <span class="o">!=</span> <span class="n">current_drive</span> <span class="o">||</span>	<span class="cm">/* bad drive */</span>
	    <span class="n">fsector_t</span> <span class="o">&gt;</span> <span class="n">buffer_max</span> <span class="o">||</span>
	    <span class="n">fsector_t</span> <span class="o">&lt;</span> <span class="n">buffer_min</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_READ</span> <span class="o">||</span>
	      <span class="p">(</span><span class="o">!</span><span class="n">in_sector_offset</span> <span class="o">&amp;&amp;</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ssize</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="n">max_sector</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max_buffer_sectors</span> <span class="o">+</span> <span class="n">buffer_min</span> <span class="o">&amp;&amp;</span>
	     <span class="n">max_size</span> <span class="o">+</span> <span class="n">fsector_t</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max_buffer_sectors</span> <span class="o">+</span> <span class="n">buffer_min</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* not enough space */</span>
		<span class="n">buffer_track</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">buffer_drive</span> <span class="o">=</span> <span class="n">current_drive</span><span class="p">;</span>
		<span class="n">buffer_max</span> <span class="o">=</span> <span class="n">buffer_min</span> <span class="o">=</span> <span class="n">aligned_sector_t</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">=</span> <span class="n">floppy_track_buffer</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">aligned_sector_t</span> <span class="o">-</span> <span class="n">buffer_min</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* copy write buffer to track buffer.</span>
<span class="cm">		 * if we get here, we know that the write</span>
<span class="cm">		 * is either aligned or the data already in the buffer</span>
<span class="cm">		 * (buffer will be overwritten) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_sector_offset</span> <span class="o">&amp;&amp;</span> <span class="n">buffer_track</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;internal error offset !=0 on write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">buffer_track</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
		<span class="n">buffer_drive</span> <span class="o">=</span> <span class="n">current_drive</span><span class="p">;</span>
		<span class="n">copy_buffer</span><span class="p">(</span><span class="n">ssize</span><span class="p">,</span> <span class="n">max_sector</span><span class="p">,</span>
			    <span class="mi">2</span> <span class="o">*</span> <span class="n">max_buffer_sectors</span> <span class="o">+</span> <span class="n">buffer_min</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">transfer_size</span><span class="p">(</span><span class="n">ssize</span><span class="p">,</span> <span class="n">max_sector</span><span class="p">,</span>
			      <span class="mi">2</span> <span class="o">*</span> <span class="n">max_buffer_sectors</span> <span class="o">+</span> <span class="n">buffer_min</span> <span class="o">-</span>
			      <span class="n">aligned_sector_t</span><span class="p">);</span>

	<span class="cm">/* round up current_count_sectors to get dma xfer size */</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">in_sector_offset</span> <span class="o">+</span> <span class="n">current_count_sectors</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ssize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;&lt;=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">current_count_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">!=</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">&amp;&amp;</span>
	     <span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">aligned_sector_t</span> <span class="o">+</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buffer_max</span> <span class="o">||</span>
	      <span class="n">aligned_sector_t</span> <span class="o">&lt;</span> <span class="n">buffer_min</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">%</span> <span class="p">(</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="n">SIZECODE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">current_count_sectors</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;fractionary current count b=%lx s=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">current_count_sectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">!=</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;addr=%d, length=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">-</span>
				       <span class="n">floppy_track_buffer</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">),</span>
				<span class="n">current_count_sectors</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;st=%d ast=%d mse=%d msi=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fsector_t</span><span class="p">,</span> <span class="n">aligned_sector_t</span><span class="p">,</span> <span class="n">max_sector</span><span class="p">,</span> <span class="n">max_size</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ssize=%x SIZECODE=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ssize</span><span class="p">,</span> <span class="n">SIZECODE</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;command=%x SECTOR=%d HEAD=%d, TRACK=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">COMMAND</span><span class="p">,</span> <span class="n">SECTOR</span><span class="p">,</span> <span class="n">HEAD</span><span class="p">,</span> <span class="n">TRACK</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;buffer drive=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_drive</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;buffer track=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_track</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;buffer_min=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_min</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;buffer_max=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">!=</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">&lt;</span> <span class="n">floppy_track_buffer</span> <span class="o">||</span>
		    <span class="n">current_count_sectors</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">+</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span>
		    <span class="n">floppy_track_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_buffer_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;buffer overrun in schedule dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;fsector_t=%d buffer_min=%d current_count=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fsector_t</span><span class="p">,</span> <span class="n">buffer_min</span><span class="p">,</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;current_count_sectors=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">current_count_sectors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_READ</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CT</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="n">FD_WRITE</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">current_count_sectors</span> <span class="o">&gt;</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">current_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;buffer overrun in direct transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">current_count_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;more sectors than bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;bytes=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;sectors=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current_count_sectors</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;zero dma transfer attempted from make_raw_request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">virtualdmabug_workaround</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Round-robin between our available drives, doing one request from each</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_next_request</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_pos</span> <span class="o">=</span> <span class="n">fdc_queue</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">disks</span><span class="p">[</span><span class="n">fdc_queue</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">fdc_queue</span> <span class="o">==</span> <span class="n">N_DRIVE</span><span class="p">)</span>
			<span class="n">fdc_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">current_req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_req</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">fdc_queue</span> <span class="o">!=</span> <span class="n">old_pos</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">current_req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">redo_fd_request</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">lastredo</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">)</span>
		<span class="n">floppy_off</span><span class="p">(</span><span class="n">current_drive</span><span class="p">);</span>

<span class="nl">do_request:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pending</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_lock</span><span class="p">);</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="n">set_next_request</span><span class="p">();</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_floppy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">unlock_fdc</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">set_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">reschedule_timeout</span><span class="p">(</span><span class="n">current_reqD</span><span class="p">,</span> <span class="s">&quot;redo fd request&quot;</span><span class="p">);</span>

	<span class="n">set_floppy</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
	<span class="n">raw_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_raw_cmd</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_motor</span><span class="p">(</span><span class="n">redo_fd_request</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">disk_change</span><span class="p">(</span><span class="n">current_drive</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">current_drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_change</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;disk absent or changed during operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">request_done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">do_request</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_floppy</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Autodetection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">probed_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_valid_format</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;no autodetectable formats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">_floppy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">request_done</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">do_request</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">probing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">_floppy</span> <span class="o">=</span> <span class="n">floppy_type</span> <span class="o">+</span> <span class="n">DP</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">[</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">probed_format</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">probing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">errors</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">current_req</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">make_raw_rw_request</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_done</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">do_request</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_NEED_TWADDLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">twaddle</span><span class="p">();</span>
	<span class="n">schedule_bh</span><span class="p">(</span><span class="n">floppy_start</span><span class="p">);</span>
	<span class="n">debugt</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;queue fd request&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="n">rw_cont</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">rw_interrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">redo</span>		<span class="o">=</span> <span class="n">redo_fd_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="n">bad_flp_intr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">done</span>		<span class="o">=</span> <span class="n">request_done</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_fd_request</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rw_cont</span><span class="p">;</span>
	<span class="n">schedule_bh</span><span class="p">(</span><span class="n">redo_fd_request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_fd_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">max_buffer_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="s">&quot;VFS: %s called on non-open device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="s">&quot;warning: usage count=0, current_req=%p sect=%ld type=%x flags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">current_req</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">current_req</span><span class="p">),</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">,</span>
		 <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdc_busy</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* fdc busy, this new request will be treated when the</span>
<span class="cm">		   current one is done */</span>
		<span class="n">is_alive</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;old request running&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">command_status</span> <span class="o">=</span> <span class="n">FD_COMMAND_NONE</span><span class="p">;</span>
	<span class="n">__reschedule_timeout</span><span class="p">(</span><span class="n">MAXTIMEOUT</span><span class="p">,</span> <span class="s">&quot;fd_request&quot;</span><span class="p">);</span>
	<span class="n">set_fdc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="n">is_alive</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="n">poll_cont</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">success_and_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">redo</span>		<span class="o">=</span> <span class="n">floppy_ready</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="n">generic_failure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">done</span>		<span class="o">=</span> <span class="n">generic_done</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">poll_drive</span><span class="p">(</span><span class="n">bool</span> <span class="n">interruptible</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no auto-sense, just clear dcl */</span>
	<span class="n">raw_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_raw_cmd</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">cmd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">poll_cont</span><span class="p">;</span>
	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;setting NEWCHANGE in poll_drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wait_til_done</span><span class="p">(</span><span class="n">floppy_ready</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * User triggered reset</span>
<span class="cm"> * ====================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;weird, reset interrupt called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="n">reset_cont</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">reset_intr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">redo</span>		<span class="o">=</span> <span class="n">success_and_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="n">generic_failure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">done</span>		<span class="o">=</span> <span class="n">generic_done</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_reset_fdc</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span> <span class="n">bool</span> <span class="n">interruptible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="n">FD_RESET_ALWAYS</span><span class="p">)</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reset_cont</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_til_done</span><span class="p">(</span><span class="n">reset_fdc</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Misc Ioctl&#39;s and support</span>
<span class="cm"> * ========================</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fd_copyout</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fd_copyin</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">drive_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">*</span><span class="n">floppy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
		<span class="n">floppy</span> <span class="o">=</span> <span class="n">floppy_type</span> <span class="o">+</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">native_format</span><span class="p">)</span>
			<span class="n">floppy</span> <span class="o">=</span> <span class="n">floppy_type</span> <span class="o">+</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">native_format</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="s">&quot;(null)&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">floppy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">floppy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="s">&quot;(null)&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* raw commands */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">raw_cmd_done</span><span class="p">(</span><span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_FAILURE</span><span class="p">;</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_HARDFAILURE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">reply_count</span> <span class="o">=</span> <span class="n">inr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">reply_count</span> <span class="o">&gt;</span> <span class="n">MAX_REPLIES</span><span class="p">)</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">reply_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">reply_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FD_RAW_READ</span> <span class="o">|</span> <span class="n">FD_RAW_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">fd_get_dma_residue</span><span class="p">();</span>
			<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_SOFTFAILURE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">reply_count</span> <span class="o">||</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)))</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_FAILURE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">disk_change</span><span class="p">(</span><span class="n">current_drive</span><span class="p">))</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_RAW_DISK_CHANGE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FD_RAW_DISK_CHANGE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_NO_MOTOR_AFTER</span><span class="p">)</span>
			<span class="n">motor_off_callback</span><span class="p">(</span><span class="n">current_drive</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_FAILURE</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_STOP_IF_FAILURE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_FAILURE</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_STOP_IF_SUCCESS</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">raw_cmd</span> <span class="o">=</span> <span class="n">raw_cmd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">generic_done</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cont_t</span> <span class="n">raw_cmd_cont</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">success_and_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">redo</span>		<span class="o">=</span> <span class="n">floppy_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="n">generic_failure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">done</span>		<span class="o">=</span> <span class="n">raw_cmd_done</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_cmd_copyout</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">param</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_raw_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">buffer_length</span> <span class="o">-</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">fd_copyout</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">,</span>
						 <span class="n">length</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raw_cmd_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">**</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>

	<span class="n">this</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fd_dma_mem_free</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">,</span>
					<span class="n">this</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">);</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
		<span class="n">this</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_cmd_copyin</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">**</span><span class="n">rcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rcmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">loop:</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_raw_cmd</span><span class="p">),</span> <span class="n">GFP_USER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rcmd</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_raw_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cmd_count</span> <span class="o">&gt;</span> <span class="mi">33</span><span class="p">)</span>
			<span class="cm">/* the command may now also take up the space</span>
<span class="cm">			 * initially intended for the reply &amp; the</span>
<span class="cm">			 * reply count. Needed for long 82078 commands</span>
<span class="cm">			 * such as RESTORE, which takes ... 17 command</span>
<span class="cm">			 * bytes. Murphy&#39;s law #137: When you reserve</span>
<span class="cm">			 * 16 bytes for a structure, you&#39;ll one day</span>
<span class="cm">			 * discover that you really need 17...</span>
<span class="cm">			 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">resultcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FD_RAW_READ</span> <span class="o">|</span> <span class="n">FD_RAW_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">kernel_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_dma_mem_alloc</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">fallback_on_nodma_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fd_copyin</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">kernel_data</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_RAW_MORE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;=</span> <span class="mh">0x43</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raw_cmd_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_raw_cmd</span> <span class="o">*</span><span class="n">my_raw_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fdc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive</span> <span class="o">==</span> <span class="n">current_drive</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">raw_cmd_copyin</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_raw_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw_cmd_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_raw_cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raw_cmd</span> <span class="o">=</span> <span class="n">my_raw_cmd</span><span class="p">;</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">raw_cmd_cont</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_til_done</span><span class="p">(</span><span class="n">floppy_start</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">debug_dcl</span><span class="p">(</span><span class="n">DP</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="s">&quot;calling disk change from raw_cmd ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINTR</span> <span class="o">&amp;&amp;</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">NO_TRACK</span><span class="p">;</span>

	<span class="n">ret2</span> <span class="o">=</span> <span class="n">raw_cmd_copyout</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">my_raw_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ret2</span><span class="p">;</span>
	<span class="n">raw_cmd_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_raw_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">invalidate_drive</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* invalidate the buffer track to force a reread */</span>
	<span class="n">set_bit</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_change</span><span class="p">);</span>
	<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="n">check_disk_change</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_geometry</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* sanity checking for parameters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">g</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">g</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">&gt;</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">tracks</span> <span class="o">&gt;&gt;</span> <span class="n">STRETCH</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">||</span>
	    <span class="cm">/* check if reserved bits are set */</span>
	    <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">stretch</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">FD_STRETCH</span> <span class="o">|</span> <span class="n">FD_SWAPSIDES</span> <span class="o">|</span> <span class="n">FD_SECTBASEMASK</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">floppy_type</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>
		<span class="n">floppy_type</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user format&quot;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
			<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">floppy_sizes</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">floppy_type</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">opened_bdev</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span> <span class="o">||</span> <span class="n">ITYPE</span><span class="p">(</span><span class="n">drive_state</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">fd_device</span><span class="p">)</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">__invalidate_device</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">oldStretch</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">FDDEFPRM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* notice a disk change immediately, else</span>
<span class="cm">			 * we lose our settings immediately*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_drive</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">oldStretch</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">stretch</span><span class="p">;</span>
		<span class="n">user_params</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_drive</span> <span class="o">==</span> <span class="n">drive</span><span class="p">)</span>
			<span class="n">SUPBOUND</span><span class="p">(</span><span class="n">buffer_max</span><span class="p">,</span> <span class="n">user_params</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sect</span><span class="p">);</span>
		<span class="n">current_type</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">user_params</span><span class="p">[</span><span class="n">drive</span><span class="p">];</span>
		<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_params</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">FDDEFPRM</span><span class="p">)</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">keep_data</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">DRS</span><span class="o">-&gt;</span><span class="n">keep_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* invalidation. Invalidate only when needed, i.e.</span>
<span class="cm">		 * when there are already sectors in the buffer cache</span>
<span class="cm">		 * whose number will change. This is useful, because</span>
<span class="cm">		 * mtools often changes the geometry of the disk after</span>
<span class="cm">		 * looking at the boot block */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DRS</span><span class="o">-&gt;</span><span class="n">maxblock</span> <span class="o">&gt;</span> <span class="n">user_params</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sect</span> <span class="o">||</span>
		    <span class="n">DRS</span><span class="o">-&gt;</span><span class="n">maxtrack</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">user_params</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">sect</span> <span class="o">^</span> <span class="n">oldStretch</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="p">(</span><span class="n">FD_SWAPSIDES</span> <span class="o">|</span> <span class="n">FD_SECTBASEMASK</span><span class="p">)))</span>
			<span class="n">invalidate_drive</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* handle obsolete ioctl&#39;s */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioctl_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FDCLRPRM</span><span class="p">,</span>
	<span class="n">FDSETPRM</span><span class="p">,</span>
	<span class="n">FDDEFPRM</span><span class="p">,</span>
	<span class="n">FDGETPRM</span><span class="p">,</span>
	<span class="n">FDMSGON</span><span class="p">,</span>
	<span class="n">FDMSGOFF</span><span class="p">,</span>
	<span class="n">FDFMTBEG</span><span class="p">,</span>
	<span class="n">FDFMTTRK</span><span class="p">,</span>
	<span class="n">FDFMTEND</span><span class="p">,</span>
	<span class="n">FDSETEMSGTRESH</span><span class="p">,</span>
	<span class="n">FDFLUSH</span><span class="p">,</span>
	<span class="n">FDSETMAXERRS</span><span class="p">,</span>
	<span class="n">FDGETMAXERRS</span><span class="p">,</span>
	<span class="n">FDGETDRVTYP</span><span class="p">,</span>
	<span class="n">FDSETDRVPRM</span><span class="p">,</span>
	<span class="n">FDGETDRVPRM</span><span class="p">,</span>
	<span class="n">FDGETDRVSTAT</span><span class="p">,</span>
	<span class="n">FDPOLLDRVSTAT</span><span class="p">,</span>
	<span class="n">FDRESET</span><span class="p">,</span>
	<span class="n">FDGETFDCSTAT</span><span class="p">,</span>
	<span class="n">FDWERRORCLR</span><span class="p">,</span>
	<span class="n">FDWERRORGET</span><span class="p">,</span>
	<span class="n">FDRAWCMD</span><span class="p">,</span>
	<span class="n">FDEJECT</span><span class="p">,</span>
	<span class="n">FDTWADDLE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">normalize_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioctl_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ioctl_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ioctl_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ioctl not yet supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_floppy_geometry</span><span class="p">(</span><span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">**</span><span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
		<span class="o">*</span><span class="n">g</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_type</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">poll_drive</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="o">*</span><span class="n">g</span> <span class="o">=</span> <span class="n">current_type</span><span class="p">[</span><span class="n">drive</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">g</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fd_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">ITYPE</span><span class="p">(</span><span class="n">drive_state</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">fd_device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_floppy_geometry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fd_locked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">ITYPE</span><span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_device</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">inparam</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">floppy_struct</span> <span class="n">g</span><span class="p">;</span>	<span class="cm">/* geometry */</span>
		<span class="k">struct</span> <span class="n">format_descr</span> <span class="n">f</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_max_errors</span> <span class="n">max_errors</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_drive_params</span> <span class="n">dp</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">inparam</span><span class="p">;</span>		<span class="cm">/* parameters coming from user space */</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">outparam</span><span class="p">;</span>	<span class="cm">/* parameters passed back to user space */</span>

	<span class="cm">/* convert compatibility eject ioctls into floppy eject ioctl.</span>
<span class="cm">	 * We do this in order to provide a means to eject floppy disks before</span>
<span class="cm">	 * installing the new fdutils package */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CDROMEJECT</span> <span class="o">||</span>	<span class="cm">/* CD-ROM eject */</span>
	    <span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x6470</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* SunOS floppy eject */</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;obsolete eject ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;please use floppycontrol --eject</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FDEJECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0200</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* convert the old style command into a new style command */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">normalize_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* permission checks */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_WRITE_IOCTL</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inparam</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* copyin */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inparam</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inparam</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fd_copyin</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inparam</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDEJECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="cm">/* somebody else has this drive open */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

		<span class="cm">/* do the actual eject. Fails on</span>
<span class="cm">		 * non-Sparc architectures */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fd_eject</span><span class="p">(</span><span class="n">UNIT</span><span class="p">(</span><span class="n">drive</span><span class="p">));</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDCLRPRM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">current_type</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_DISK_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">keep_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">invalidate_drive</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FDSETPRM</span>:
	<span class="k">case</span> <span class="n">FDDEFPRM</span>:
		<span class="k">return</span> <span class="n">set_geometry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inparam</span><span class="p">.</span><span class="n">g</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FDGETPRM</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_floppy_geometry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
					  <span class="p">(</span><span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">outparam</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDMSGON</span>:
		<span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FTD_MSG</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDMSGOFF</span>:
		<span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FTD_MSG</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDFMTBEG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">poll_drive</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">FD_VERIFY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">FD_DISK_WRITABLE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDFMTTRK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">do_format</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inparam</span><span class="p">.</span><span class="n">f</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FDFMTEND</span>:
	<span class="k">case</span> <span class="n">FDFLUSH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">invalidate_drive</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FDSETEMSGTRESH</span>:
		<span class="n">UDP</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">.</span><span class="n">reporting</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">param</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDGETMAXERRS</span>:
		<span class="n">outparam</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDSETMAXERRS</span>:
		<span class="n">UDP</span><span class="o">-&gt;</span><span class="n">max_errors</span> <span class="o">=</span> <span class="n">inparam</span><span class="p">.</span><span class="n">max_errors</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDGETDRVTYP</span>:
		<span class="n">outparam</span> <span class="o">=</span> <span class="n">drive_name</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
		<span class="n">SUPBOUND</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">strlen</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">outparam</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDSETDRVPRM</span>:
		<span class="o">*</span><span class="n">UDP</span> <span class="o">=</span> <span class="n">inparam</span><span class="p">.</span><span class="n">dp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDGETDRVPRM</span>:
		<span class="n">outparam</span> <span class="o">=</span> <span class="n">UDP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDPOLLDRVSTAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">poll_drive</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FDGETDRVSTAT</span>:
		<span class="n">outparam</span> <span class="o">=</span> <span class="n">UDRS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDRESET</span>:
		<span class="k">return</span> <span class="n">user_reset_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">param</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FDGETFDCSTAT</span>:
		<span class="n">outparam</span> <span class="o">=</span> <span class="n">UFDCS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDWERRORCLR</span>:
		<span class="n">memset</span><span class="p">(</span><span class="n">UDRWE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">UDRWE</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDWERRORGET</span>:
		<span class="n">outparam</span> <span class="o">=</span> <span class="n">UDRWE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDRAWCMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">set_floppy</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">raw_cmd_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDTWADDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">twaddle</span><span class="p">();</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_READ</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fd_copyout</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">,</span> <span class="n">outparam</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fd_locked_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">config_types</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">has_drive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>

	<span class="cm">/* read drive info out of physical CMOS */</span>
	<span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span><span class="p">)</span>
		<span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span> <span class="o">=</span> <span class="n">FLOPPY0_TYPE</span><span class="p">;</span>
	<span class="n">drive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span> <span class="o">&amp;&amp;</span> <span class="n">FLOPPY1_TYPE</span><span class="p">)</span>
		<span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span> <span class="o">=</span> <span class="n">FLOPPY1_TYPE</span><span class="p">;</span>

	<span class="cm">/* FIXME: additional physical CMOS drive detection should go here */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_drive_params</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="n">temparea</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_drive_params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_drive_params</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">params</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">default_drive_params</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
				<span class="n">allowed_drive_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">allowed_drive_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">default_drive_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">params</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">temparea</span><span class="p">,</span> <span class="s">&quot;unknown type %d (usb?)&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">temparea</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prepend</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_drive</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prepend</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
				<span class="n">has_drive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Floppy drive(s):&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">prepend</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s fd%d is %s&quot;</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">drive</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">UDP</span> <span class="o">=</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_drive</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;floppy_release with fd_ref == 0&quot;</span><span class="p">);</span>
		<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="p">)</span>
		<span class="n">opened_bdev</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * floppy_open check for aliasing (/dev/fd0 can be the same as</span>
<span class="cm"> * /dev/PS0 etc), and disallows simultaneous access to the same</span>
<span class="cm"> * drive with different device numbers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_dev</span><span class="p">,</span> <span class="n">new_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">try</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">old_dev</span> <span class="o">=</span> <span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opened_bdev</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">opened_bdev</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FD_BROKEN_DCL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="o">++</span><span class="p">;</span>

	<span class="n">opened_bdev</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">floppy_track_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if opening an ED drive, reserve a big buffer,</span>
<span class="cm">		 * else reserve a small one */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">try</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>	<span class="cm">/* Only 48 actually useful */</span>
		<span class="k">else</span>
			<span class="n">try</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* Only 24 actually useful */</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_dma_mem_alloc</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">try</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">floppy_track_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">try</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* buffer only one side */</span>
			<span class="n">INFBOUND</span><span class="p">(</span><span class="n">try</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_dma_mem_alloc</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">try</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">floppy_track_buffer</span><span class="p">)</span>
			<span class="n">fallback_on_nodma_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2048</span> <span class="o">*</span> <span class="n">try</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">floppy_track_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Unable to allocate DMA memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">floppy_track_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
				<span class="n">fd_dma_mem_free</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tmp</span><span class="p">,</span> <span class="n">try</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buffer_min</span> <span class="o">=</span> <span class="n">buffer_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">floppy_track_buffer</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">max_buffer_sectors</span> <span class="o">=</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">new_dev</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
	<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_device</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">],</span> <span class="n">floppy_sizes</span><span class="p">[</span><span class="n">new_dev</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_dev</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">old_dev</span> <span class="o">!=</span> <span class="n">new_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_drive</span> <span class="o">==</span> <span class="n">drive</span><span class="p">)</span>
			<span class="n">buffer_track</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UFDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">UFDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_NDELAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">last_checked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">check_disk_change</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_WRITABLE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="p">)</span>
		<span class="n">opened_bdev</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out2:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the disk has been changed or if a change has been faked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">floppy_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DISK_EVENT_MEDIA_CHANGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">last_checked</span> <span class="o">+</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">checkfreq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">poll_drive</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_change</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">drive_no_geom</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DISK_EVENT_MEDIA_CHANGE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This implements &quot;read block 0&quot; for floppy_revalidate().</span>
<span class="cm"> * Needed for format autodetection, checking whether there is</span>
<span class="cm"> * a disk in the drive, and whether that disk is writable.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_rb0_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__floppy_read_block_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="n">bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="n">bio_vec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_block_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="n">bio_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_io_vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bio_vec</span><span class="p">;</span>
	<span class="n">bio_vec</span><span class="p">.</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">bio_vec</span><span class="p">.</span><span class="n">bv_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">bio_vec</span><span class="p">.</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_flags</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_QUIET</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">);</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">complete</span><span class="p">;</span>
	<span class="n">bio</span><span class="p">.</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">floppy_rb0_complete</span><span class="p">;</span>

	<span class="n">submit_bio</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">process_fd_request</span><span class="p">();</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">);</span>

	<span class="n">__free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* revalidate the floppy disk, i.e. trigger format autodetection by reading</span>
<span class="cm"> * the bootblock (block 0). &quot;Autodetection&quot; is also needed to check whether</span>
<span class="cm"> * there is a disk in the drive at all... Thus we also do it for fixed</span>
<span class="cm"> * geometry formats */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_change</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">drive_no_geom</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="s">&quot;VFS: revalidate called on non-open device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">lock_fdc</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">cf</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">test_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cf</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_change</span><span class="p">)</span> <span class="o">||</span> <span class="n">drive_no_geom</span><span class="p">(</span><span class="n">drive</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">process_fd_request</span><span class="p">();</span>	<span class="cm">/*already done by another thread */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">maxblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">maxtrack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_drive</span> <span class="o">==</span> <span class="n">drive</span><span class="p">)</span>
			<span class="n">buffer_track</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_change</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="p">)</span>
			<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">generation</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive_no_geom</span><span class="p">(</span><span class="n">drive</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* auto-sensing */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">__floppy_read_block_0</span><span class="p">(</span><span class="n">opened_bdev</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="p">)</span>
				<span class="n">poll_drive</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">FD_RAW_NEED_DISK</span><span class="p">);</span>
			<span class="n">process_fd_request</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">floppy_sizes</span><span class="p">[</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_device</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">floppy_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">floppy_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">floppy_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">fd_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span>			<span class="o">=</span> <span class="n">fd_getgeo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span>		<span class="o">=</span> <span class="n">floppy_check_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">revalidate_disk</span>	<span class="o">=</span> <span class="n">floppy_revalidate</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Floppy Driver initialization</span>
<span class="cm"> * =============================</span>
<span class="cm"> */</span>

<span class="cm">/* Determine the floppy disk controller type */</span>
<span class="cm">/* This routine was written by David C. Niemi */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">__init</span> <span class="nf">get_fdc_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_DUMPREGS</span><span class="p">);</span>	<span class="cm">/* 82072 and better know DUMPREGS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FDC_NONE</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FDC_NONE</span><span class="p">;</span>	<span class="cm">/* No FDC present ??? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reply_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is an 8272A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_8272A</span><span class="p">;</span>	<span class="cm">/* 8272a/765 don&#39;t know DUMPREGS */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d init: DUMPREGS: unexpected return of %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fdc</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fdc_configure</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is an 82072</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_82072</span><span class="p">;</span>	<span class="cm">/* 82072 doesn&#39;t know CONFIGURE */</span>
	<span class="p">}</span>

	<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_PERPENDICULAR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_more_output</span><span class="p">()</span> <span class="o">==</span> <span class="n">MORE_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">output_byte</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is an 82072A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_82072A</span><span class="p">;</span>	<span class="cm">/* 82072A as found on Sparcs. */</span>
	<span class="p">}</span>

	<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_UNLOCK</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reply_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is a pre-1991 82077</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_82077_ORIG</span><span class="p">;</span>	<span class="cm">/* Pre-1991 82077, doesn&#39;t know</span>
<span class="cm">					 * LOCK/UNLOCK */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">reply_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d init: UNLOCK: unexpected return of %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fdc</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">output_byte</span><span class="p">(</span><span class="n">FD_PARTID</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d init: PARTID: unexpected return of %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fdc</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is a post-1991 82077</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_82077</span><span class="p">;</span>	<span class="cm">/* Revised 82077AA passes all the tests */</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reply_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0</span>:
		<span class="cm">/* Either a 82078-1 or a 82078SL running at 5Volt */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is an 82078.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_82078</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is a 44pin 82078</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_82078</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is a S82078B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_S82078B</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d is a National Semiconductor PC87306</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_87306</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FDC %d init: 82078 variant with unknown PARTID=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fdc</span><span class="p">,</span> <span class="n">reply_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FDC_82078_UNKN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* get_fdc_version */</span>

<span class="cm">/* lilo configuration */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">floppy_set_flags</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_drive_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span>
			<span class="n">default_drive_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">param2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">default_drive_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">param2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;%s flag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param2</span> <span class="o">?</span> <span class="s">&quot;Setting&quot;</span> <span class="o">:</span> <span class="s">&quot;Clearing&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">daring</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_drive_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">default_drive_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">select_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">default_drive_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="n">FD_SILENT_DCL_CLEAR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">default_drive_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">select_delay</span> <span class="o">=</span>
			    <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">default_drive_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">FD_SILENT_DCL_CLEAR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Assuming %s floppy hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span> <span class="o">?</span> <span class="s">&quot;standard&quot;</span> <span class="o">:</span> <span class="s">&quot;broken&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">set_cmos</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">current_drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;wrong number of parameters for CMOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">current_drive</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_drive</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">current_drive</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;bad drive for set_cmos</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if N_FDC &gt; 1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_drive</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FDC2</span><span class="p">)</span>
		<span class="n">FDC2</span> <span class="o">=</span> <span class="mh">0x370</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">DP</span><span class="o">-&gt;</span><span class="n">cmos</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;setting CMOS code to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">param_table</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">def_param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">param2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">config_params</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;allowed_drive_mask&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">allowed_drive_mask</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* obsolete */</span>
	<span class="p">{</span><span class="s">&quot;all_drives&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">allowed_drive_mask</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* obsolete */</span>
	<span class="p">{</span><span class="s">&quot;asus_pci&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">allowed_drive_mask</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;irq&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FLOPPY_IRQ</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;dma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FLOPPY_DMA</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;daring&quot;</span><span class="p">,</span> <span class="n">daring</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="cp">#if N_FDC &gt; 1</span>
	<span class="p">{</span><span class="s">&quot;two_fdc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FDC2</span><span class="p">,</span> <span class="mh">0x370</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;one_fdc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FDC2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="s">&quot;thinkpad&quot;</span><span class="p">,</span> <span class="n">floppy_set_flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FD_INVERTED_DCL</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;broken_dcl&quot;</span><span class="p">,</span> <span class="n">floppy_set_flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FD_BROKEN_DCL</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">floppy_set_flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FTD_MSG</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;silent_dcl_clear&quot;</span><span class="p">,</span> <span class="n">floppy_set_flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FD_SILENT_DCL_CLEAR</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;debug&quot;</span><span class="p">,</span> <span class="n">floppy_set_flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FD_DEBUG</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;nodma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">can_use_virtual_dma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;omnibook&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">can_use_virtual_dma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;yesdma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">can_use_virtual_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;fifo_depth&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo_depth</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;nofifo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_fifo</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;usefifo&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;cmos&quot;</span><span class="p">,</span> <span class="n">set_cmos</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;slow&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slow_floppy</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;unexpected_interrupts&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">print_unex</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;no_unexpected_interrupts&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">print_unex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;L40SX&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">print_unex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>

	<span class="n">EXTRA_FLOPPY_PARAMS</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">floppy_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">config_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="n">param</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">param</span> <span class="o">=</span> <span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">def_param</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fn</span><span class="p">)</span>
					<span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fn</span><span class="p">(</span><span class="n">ints</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span>
							    <span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
							    <span class="n">param2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">var</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;%s=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
					<span class="o">*</span><span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">var</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;unknown floppy option [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;allowed options are:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">config_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">config_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;botched floppy option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Read Documentation/blockdev/floppy.txt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">have_no_fdc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">floppy_cmos_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>

	<span class="n">drive</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">UDP</span><span class="o">-&gt;</span><span class="n">cmos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cmos</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">floppy_cmos_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fdc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fdc</span> <span class="o">&lt;</span> <span class="n">N_FDC</span><span class="p">;</span> <span class="n">fdc</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">user_reset_fdc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FD_RESET_ALWAYS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">floppy_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">floppy_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">floppy_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">floppy_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;floppy&quot;</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">floppy_device</span><span class="p">[</span><span class="n">N_DRIVE</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="nf">floppy_find</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">part</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="n">part</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive</span> <span class="o">&gt;=</span> <span class="n">N_DRIVE</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">allowed_drive_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">fdc_state</span><span class="p">[</span><span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">)].</span><span class="n">version</span> <span class="o">==</span> <span class="n">FDC_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">part</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">floppy_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">get_disk</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">floppy_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">dr</span><span class="p">;</span>

	<span class="n">set_debugt</span><span class="p">();</span>
	<span class="n">interruptjiffies</span> <span class="o">=</span> <span class="n">resultjiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_PPC)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_legacy_ioport</span><span class="p">(</span><span class="n">FDC1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">raw_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dr</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">dr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">floppy_wq</span> <span class="o">=</span> <span class="n">alloc_ordered_workqueue</span><span class="p">(</span><span class="s">&quot;floppy&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">floppy_wq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">do_fd_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">floppy_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_destroy_workq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">FLOPPY_MAJOR</span><span class="p">;</span>
		<span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">TOMINOR</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>
		<span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_fops</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;fd%d&quot;</span><span class="p">,</span> <span class="n">dr</span><span class="p">);</span>

		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">motor_off_timer</span><span class="p">[</span><span class="n">dr</span><span class="p">]);</span>
		<span class="n">motor_off_timer</span><span class="p">[</span><span class="n">dr</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">dr</span><span class="p">;</span>
		<span class="n">motor_off_timer</span><span class="p">[</span><span class="n">dr</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="n">motor_off_callback</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">,</span> <span class="s">&quot;fd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unreg_blkdev</span><span class="p">;</span>

	<span class="n">blk_register_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">256</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			    <span class="n">floppy_find</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ITYPE</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">floppy_type</span><span class="p">[</span><span class="n">ITYPE</span><span class="p">(</span><span class="n">i</span><span class="p">)].</span><span class="n">size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">floppy_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_DISK_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">reschedule_timeout</span><span class="p">(</span><span class="n">MAXTIMEOUT</span><span class="p">,</span> <span class="s">&quot;floppy init&quot;</span><span class="p">);</span>
	<span class="n">config_types</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_FDC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fdc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">FDCS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">FDCS</span><span class="p">));</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dtr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
<span class="cp">#if defined(__sparc__) || defined(__mc68000__)</span>
	<span class="cm">/*sparcs/sun3x don&#39;t have a DOR reset which we can fall back on to */</span>
<span class="cp">#ifdef __mc68000__</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_SUN3X</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">FDC_82072A</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">use_virtual_dma</span> <span class="o">=</span> <span class="n">can_use_virtual_dma</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fdc_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">FDC1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdc_state</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unreg_region</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if N_FDC &gt; 1</span>
	<span class="n">fdc_state</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">FDC2</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* reset fdc in case of unexpected interrupt */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">floppy_grab_irq_and_dma</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unreg_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialise drive state */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">UDRS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">UDRS</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">UDRWE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">UDRWE</span><span class="p">));</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_NEWCHANGE_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_DISK_CHANGED_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FD_VERIFY_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">UDRS</span><span class="o">-&gt;</span><span class="n">fd_device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">floppy_track_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">max_buffer_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Small 10 msec delay to let through any interrupt that</span>
<span class="cm">	 * initialization might have triggered, to not</span>
<span class="cm">	 * confuse detection:</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_FDC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fdc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">driver_version</span> <span class="o">=</span> <span class="n">FD_DRIVER_VERSION</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">unit</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">unit</span><span class="o">++</span><span class="p">)</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">rawcmd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_reset_fdc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FD_RESET_ALWAYS</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* free ioports reserved by floppy_grab_irq_and_dma() */</span>
			<span class="n">floppy_release_regions</span><span class="p">(</span><span class="n">fdc</span><span class="p">);</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">FDC_NONE</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Try to determine the floppy controller type */</span>
		<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">get_fdc_version</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">FDC_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* free ioports reserved by floppy_grab_irq_and_dma() */</span>
			<span class="n">floppy_release_regions</span><span class="p">(</span><span class="n">fdc</span><span class="p">);</span>
			<span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">can_use_virtual_dma</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">FDC_82072A</span><span class="p">)</span>
			<span class="n">can_use_virtual_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">have_no_fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Not all FDCs seem to be able to handle the version command</span>
<span class="cm">		 * properly, so force a reset for the standard FDC clones,</span>
<span class="cm">		 * to avoid interrupt garbage.</span>
<span class="cm">		 */</span>
		<span class="n">user_reset_fdc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FD_RESET_ALWAYS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">);</span>
	<span class="n">current_drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">have_no_fdc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;no floppy controllers found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">have_no_fdc</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">allowed_drive_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdc_state</span><span class="p">[</span><span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">)].</span><span class="n">version</span> <span class="o">==</span> <span class="n">FDC_NONE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">floppy_device_name</span><span class="p">;</span>
		<span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
		<span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">floppy_device_release</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_release_dma</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dev_attr_cmos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unreg_platform_dev</span><span class="p">;</span>

		<span class="cm">/* to be cleaned up... */</span>
		<span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">drive</span><span class="p">;</span>
		<span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENHD_FL_REMOVABLE</span><span class="p">;</span>
		<span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">driverfs_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">add_disk</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unreg_platform_dev:</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
<span class="nl">out_release_dma:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">))</span>
		<span class="n">floppy_release_irq_and_dma</span><span class="p">();</span>
<span class="nl">out_unreg_region:</span>
	<span class="n">blk_unregister_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_driver</span><span class="p">);</span>
<span class="nl">out_destroy_workq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">floppy_wq</span><span class="p">);</span>
<span class="nl">out_unreg_blkdev:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">,</span> <span class="s">&quot;fd&quot;</span><span class="p">);</span>
<span class="nl">out_put_disk:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dr</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">motor_off_timer</span><span class="p">[</span><span class="n">dr</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * put_disk() is not paired with add_disk() and</span>
<span class="cm">			 * will put queue reference one extra time. fix it.</span>
<span class="cm">			 */</span>
			<span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">dr</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">io_region</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">io_regions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="cm">/* address + 3 is sometimes reserved by pnp bios for motherboard */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="cm">/* address + 6 is reserved, and may be taken by IDE.</span>
<span class="cm">	 * Unfortunately, Adaptec doesn&#39;t know this :-(, */</span>
	<span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_release_allocated_regions</span><span class="p">(</span><span class="kt">int</span> <span class="n">fdc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">io_region</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">io_regions</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">--</span><span class="p">;</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define ARRAY_END(X) (&amp;((X)[ARRAY_SIZE(X)]))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_request_regions</span><span class="p">(</span><span class="kt">int</span> <span class="n">fdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">io_region</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">io_regions</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">ARRAY_END</span><span class="p">(</span><span class="n">io_regions</span><span class="p">);</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				    <span class="n">p</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;floppy&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Floppy io-port 0x%04lx in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">floppy_release_allocated_regions</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_release_regions</span><span class="p">(</span><span class="kt">int</span> <span class="n">fdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">floppy_release_allocated_regions</span><span class="p">(</span><span class="n">fdc</span><span class="p">,</span> <span class="n">ARRAY_END</span><span class="p">(</span><span class="n">io_regions</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_grab_irq_and_dma</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We might have scheduled a free_irq(), wait it to</span>
<span class="cm">	 * drain first:</span>
<span class="cm">	 */</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">floppy_wq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fd_request_irq</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Unable to grab IRQ%d for the floppy driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">FLOPPY_IRQ</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd_request_dma</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="s">&quot;Unable to grab DMA%d for the floppy driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">FLOPPY_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">can_use_virtual_dma</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">use_virtual_dma</span> <span class="o">=</span> <span class="n">can_use_virtual_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">can_use_virtual_dma</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fd_free_irq</span><span class="p">();</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fdc</span> <span class="o">&lt;</span> <span class="n">N_FDC</span><span class="p">;</span> <span class="n">fdc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">floppy_request_regions</span><span class="p">(</span><span class="n">fdc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fdc</span> <span class="o">&lt;</span> <span class="n">N_FDC</span><span class="p">;</span> <span class="n">fdc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reset_fdc_info</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">fd_outb</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">,</span> <span class="n">FD_DOR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_dor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* avoid immediate interrupt */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fdc</span> <span class="o">&lt;</span> <span class="n">N_FDC</span><span class="p">;</span> <span class="n">fdc</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">fd_outb</span><span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">,</span> <span class="n">FD_DOR</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The driver will try and free resources and relies on us</span>
<span class="cm">	 * to know if they were allocated or not.</span>
<span class="cm">	 */</span>
	<span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">irqdma_allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">cleanup:</span>
	<span class="n">fd_free_irq</span><span class="p">();</span>
	<span class="n">fd_free_dma</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">fdc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">floppy_release_regions</span><span class="p">(</span><span class="n">fdc</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">floppy_release_irq_and_dma</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_fdc</span><span class="p">;</span>
<span class="cp">#ifndef __sparc__</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">long</span> <span class="n">tmpsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqdma_allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fd_disable_dma</span><span class="p">();</span>
		<span class="n">fd_free_dma</span><span class="p">();</span>
		<span class="n">fd_free_irq</span><span class="p">();</span>
		<span class="n">irqdma_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_dor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#if N_FDC &gt; 1</span>
	<span class="n">set_dor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">~</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">floppy_track_buffer</span> <span class="o">&amp;&amp;</span> <span class="n">max_buffer_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmpsize</span> <span class="o">=</span> <span class="n">max_buffer_sectors</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">tmpaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">floppy_track_buffer</span><span class="p">;</span>
		<span class="n">floppy_track_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">max_buffer_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer_min</span> <span class="o">=</span> <span class="n">buffer_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">fd_dma_mem_free</span><span class="p">(</span><span class="n">tmpaddr</span><span class="p">,</span> <span class="n">tmpsize</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifndef __sparc__</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_FDC</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="n">motor_off_timer</span> <span class="o">+</span> <span class="n">drive</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;motor off timer %d still active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drive</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;floppy timer still active:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout_message</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;auxiliary floppy timer still active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_work</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;work still pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">old_fdc</span> <span class="o">=</span> <span class="n">fdc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fdc</span> <span class="o">&lt;</span> <span class="n">N_FDC</span><span class="p">;</span> <span class="n">fdc</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FDCS</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">floppy_release_regions</span><span class="p">(</span><span class="n">fdc</span><span class="p">);</span>
	<span class="n">fdc</span> <span class="o">=</span> <span class="n">old_fdc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">floppy</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">parse_floppy_cfg_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cfg</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span>
			<span class="n">cfg</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">cfg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
			<span class="n">floppy_setup</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">floppy_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">floppy</span><span class="p">)</span>
		<span class="n">parse_floppy_cfg_string</span><span class="p">(</span><span class="n">floppy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">floppy_init</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">floppy_module_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">floppy_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>

	<span class="n">blk_unregister_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">,</span> <span class="s">&quot;fd&quot;</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_driver</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">N_DRIVE</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">motor_off_timer</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">allowed_drive_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fdc_state</span><span class="p">[</span><span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">)].</span><span class="n">version</span> <span class="o">!=</span> <span class="n">FDC_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_gendisk</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">].</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_cmos</span><span class="p">);</span>
			<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">floppy_device</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * These disks have not called add_disk().  Don&#39;t put down</span>
<span class="cm">		 * queue reference in put_disk().</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">allowed_drive_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">drive</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">fdc_state</span><span class="p">[</span><span class="n">FDC</span><span class="p">(</span><span class="n">drive</span><span class="p">)].</span><span class="n">version</span> <span class="o">==</span> <span class="n">FDC_NONE</span><span class="p">)</span>
			<span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">put_disk</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timeout</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd_timer</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">floppy_wq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usage_count</span><span class="p">))</span>
		<span class="n">floppy_release_irq_and_dma</span><span class="p">();</span>

	<span class="cm">/* eject disk, if any */</span>
	<span class="n">fd_eject</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">floppy_module_exit</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">floppy</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">FLOPPY_IRQ</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">FLOPPY_DMA</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Alain L. Knaff&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;fd&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* This doesn&#39;t actually get used other than for module information */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">floppy_pnpids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;PNP0700&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">floppy_pnpids</span><span class="p">);</span>

<span class="cp">#else</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;floppy=&quot;</span><span class="p">,</span> <span class="n">floppy_setup</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">floppy_init</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="n">MODULE_ALIAS_BLOCKDEV_MAJOR</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
