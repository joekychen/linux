<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › rbd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rbd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   rbd.c -- Export ceph rados objects as a Linux block device</span>


<span class="cm">   based on drivers/block/osdblk.c:</span>

<span class="cm">   Copyright 2009 Red Hat, Inc.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; see the file COPYING.  If not, write to</span>
<span class="cm">   the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>



<span class="cm">   For usage instructions, please refer to:</span>

<span class="cm">                 Documentation/ABI/testing/sysfs-bus-rbd</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ceph/libceph.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/osd_client.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/mon_client.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/decode.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>

<span class="cp">#include &quot;rbd_types.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * The basic unit of block I/O is a sector.  It is interpreted in a</span>
<span class="cm"> * number of contexts in Linux (blk, bio, genhd), but the default is</span>
<span class="cm"> * universally 512 bytes.  These symbols are just slightly more</span>
<span class="cm"> * meaningful than the bare numbers they represent.</span>
<span class="cm"> */</span>
<span class="cp">#define	SECTOR_SHIFT	9</span>
<span class="cp">#define	SECTOR_SIZE	(1ULL &lt;&lt; SECTOR_SHIFT)</span>

<span class="cp">#define RBD_DRV_NAME &quot;rbd&quot;</span>
<span class="cp">#define RBD_DRV_NAME_LONG &quot;rbd (rados block device)&quot;</span>

<span class="cp">#define RBD_MINORS_PER_MAJOR	256		</span><span class="cm">/* max minors per blkdev */</span><span class="cp"></span>

<span class="cp">#define RBD_MAX_MD_NAME_LEN	(RBD_MAX_OBJ_NAME_LEN + sizeof(RBD_SUFFIX))</span>
<span class="cp">#define RBD_MAX_POOL_NAME_LEN	64</span>
<span class="cp">#define RBD_MAX_SNAP_NAME_LEN	32</span>
<span class="cp">#define RBD_MAX_OPT_LEN		1024</span>

<span class="cp">#define RBD_SNAP_HEAD_NAME	&quot;-&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * An RBD device name will be &quot;rbd#&quot;, where the &quot;rbd&quot; comes from</span>
<span class="cm"> * RBD_DRV_NAME above, and # is a unique integer identifier.</span>
<span class="cm"> * MAX_INT_FORMAT_WIDTH is used in ensuring DEV_NAME_LEN is big</span>
<span class="cm"> * enough to hold all possible device names.</span>
<span class="cm"> */</span>
<span class="cp">#define DEV_NAME_LEN		32</span>
<span class="cp">#define MAX_INT_FORMAT_WIDTH	((5 * sizeof (int)) / 2 + 1)</span>

<span class="cp">#define RBD_NOTIFY_TIMEOUT_DEFAULT 10</span>

<span class="cm">/*</span>
<span class="cm"> * block device image metadata (in-memory version)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">image_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">block_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">obj_order</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">crypt_type</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">comp_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">snap_names_len</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">snap_seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total_snaps</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">snap_names</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">snap_sizes</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">obj_version</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rbd_options</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">notify_timeout</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * an instance of the client.  multiple devices may share an rbd client.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rbd_client</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_options</span>	<span class="o">*</span><span class="n">rbd_opts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span>		<span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * a request completion status</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rbd_req_status</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * a collection of requests</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">total</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">num_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span>		<span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_req_status</span>	<span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * a single io request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rbd_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span>		<span class="o">*</span><span class="n">rq</span><span class="p">;</span>		<span class="cm">/* blk layer request */</span>
	<span class="k">struct</span> <span class="n">bio</span>		<span class="o">*</span><span class="n">bio</span><span class="p">;</span>		<span class="cm">/* cloned bio */</span>
	<span class="k">struct</span> <span class="n">page</span>		<span class="o">**</span><span class="n">pages</span><span class="p">;</span>	<span class="cm">/* list of used pages */</span>
	<span class="n">u64</span>			<span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">coll_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_req_coll</span>	<span class="o">*</span><span class="n">coll</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="p">{</span>
	<span class="k">struct</span>	<span class="n">device</span>		<span class="n">dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">node</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * a single device</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rbd_device</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">id</span><span class="p">;</span>		<span class="cm">/* blkdev unique id */</span>

	<span class="kt">int</span>			<span class="n">major</span><span class="p">;</span>		<span class="cm">/* blkdev assigned major */</span>
	<span class="k">struct</span> <span class="n">gendisk</span>		<span class="o">*</span><span class="n">disk</span><span class="p">;</span>		<span class="cm">/* blkdev&#39;s gendisk and rq */</span>
	<span class="k">struct</span> <span class="n">request_queue</span>	<span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rbd_client</span>	<span class="o">*</span><span class="n">rbd_client</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="n">DEV_NAME_LEN</span><span class="p">];</span> <span class="cm">/* blkdev name, e.g. rbd3 */</span>

	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>		<span class="cm">/* queue lock */</span>

	<span class="k">struct</span> <span class="n">rbd_image_header</span>	<span class="n">header</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">obj</span><span class="p">[</span><span class="n">RBD_MAX_OBJ_NAME_LEN</span><span class="p">];</span> <span class="cm">/* rbd image name */</span>
	<span class="kt">int</span>			<span class="n">obj_len</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">obj_md_name</span><span class="p">[</span><span class="n">RBD_MAX_MD_NAME_LEN</span><span class="p">];</span> <span class="cm">/* hdr nm. */</span>
	<span class="kt">char</span>			<span class="n">pool_name</span><span class="p">[</span><span class="n">RBD_MAX_POOL_NAME_LEN</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">poolid</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ceph_osd_event</span>   <span class="o">*</span><span class="n">watch_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">watch_request</span><span class="p">;</span>

	<span class="cm">/* protects updating the header */</span>
	<span class="k">struct</span> <span class="n">rw_semaphore</span>     <span class="n">header_rwsem</span><span class="p">;</span>
	<span class="kt">char</span>                    <span class="n">snap_name</span><span class="p">[</span><span class="n">RBD_MAX_SNAP_NAME_LEN</span><span class="p">];</span>
	<span class="n">u64</span>                     <span class="n">snap_id</span><span class="p">;</span>	<span class="cm">/* current snapshot id */</span>
	<span class="kt">int</span> <span class="n">read_only</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">node</span><span class="p">;</span>

	<span class="cm">/* list of snapshots */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">snaps</span><span class="p">;</span>

	<span class="cm">/* sysfs related */</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ctl_mutex</span><span class="p">);</span>	  <span class="cm">/* Serialize open/close/setup/teardown */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">rbd_dev_list</span><span class="p">);</span>    <span class="cm">/* devices */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">rbd_client_list</span><span class="p">);</span>		<span class="cm">/* clients */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__rbd_init_snaps_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rbd_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">rbd_snap_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__rbd_remove_snap_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">rbd_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		       <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">rbd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_attribute</span> <span class="n">rbd_bus_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rbd_add</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">remove</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rbd_remove</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">rbd_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rbd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_attrs</span>	<span class="o">=</span> <span class="n">rbd_bus_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_root_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="n">rbd_root_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_name</span> <span class="o">=</span>    <span class="s">&quot;rbd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">rbd_root_dev_release</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">rbd_get_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_put_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__rbd_refresh_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">rbd_get_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

	<span class="n">set_device_ro</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">read_only</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">read_only</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">rbd_put_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">rbd_bd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">rbd_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">rbd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize an rbd client instance.</span>
<span class="cm"> * We own *opt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rbd_client</span> <span class="o">*</span><span class="nf">rbd_client_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_options</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">rbd_options</span> <span class="o">*</span><span class="n">rbd_opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_client</span> <span class="o">*</span><span class="n">rbdc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_client_create</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rbdc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_client</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbdc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_opt</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">ceph_create_client</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">rbdc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_mutex</span><span class="p">;</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Now rbdc-&gt;client is responsible for opt */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_open_session</span><span class="p">(</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">rbd_opts</span> <span class="o">=</span> <span class="n">rbd_opts</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_client_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_client_create created %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rbdc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rbdc</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">ceph_destroy_client</span><span class="p">(</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
<span class="nl">out_mutex:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbdc</span><span class="p">);</span>
<span class="nl">out_opt:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span>
		<span class="n">ceph_destroy_options</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find a ceph client with specific addr and configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rbd_client</span> <span class="o">*</span><span class="nf">__rbd_client_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_options</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_client</span> <span class="o">*</span><span class="n">client_node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OPT_NOSHARE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">client_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_client_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ceph_compare_options</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">client_node</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">client_node</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mount options</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_notify_timeout</span><span class="p">,</span>
	<span class="n">Opt_last_int</span><span class="p">,</span>
	<span class="cm">/* int args above */</span>
	<span class="n">Opt_last_string</span><span class="p">,</span>
	<span class="cm">/* string args above */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">match_table_t</span> <span class="n">rbdopt_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_notify_timeout</span><span class="p">,</span> <span class="s">&quot;notify_timeout=%d&quot;</span><span class="p">},</span>
	<span class="cm">/* int args above */</span>
	<span class="cm">/* string args above */</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_rbd_opts_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_options</span> <span class="o">*</span><span class="n">rbdopt</span> <span class="o">=</span> <span class="n">private</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">argstr</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="n">intval</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">rbdopt_tokens</span><span class="p">,</span> <span class="n">argstr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">&lt;</span> <span class="n">Opt_last_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argstr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">intval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;bad mount option arg (not int) &quot;</span>
			       <span class="s">&quot;at &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;got int token %d val %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">intval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">&gt;</span> <span class="n">Opt_last_int</span> <span class="o">&amp;&amp;</span> <span class="n">token</span> <span class="o">&lt;</span> <span class="n">Opt_last_string</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;got string token %d val %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span>
		     <span class="n">argstr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">from</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;got token %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Opt_notify_timeout</span>:
		<span class="n">rbdopt</span><span class="o">-&gt;</span><span class="n">notify_timeout</span> <span class="o">=</span> <span class="n">intval</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a ceph client with specific addr and configuration, if one does</span>
<span class="cm"> * not exist create it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rbd_client</span> <span class="o">*</span><span class="nf">rbd_get_client</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mon_addr</span><span class="p">,</span>
					 <span class="kt">size_t</span> <span class="n">mon_addr_len</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_client</span> <span class="o">*</span><span class="n">rbdc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_options</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_options</span> <span class="o">*</span><span class="n">rbd_opts</span><span class="p">;</span>

	<span class="n">rbd_opts</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rbd_opts</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbd_opts</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">rbd_opts</span><span class="o">-&gt;</span><span class="n">notify_timeout</span> <span class="o">=</span> <span class="n">RBD_NOTIFY_TIMEOUT_DEFAULT</span><span class="p">;</span>

	<span class="n">opt</span> <span class="o">=</span> <span class="n">ceph_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">mon_addr</span><span class="p">,</span>
				<span class="n">mon_addr</span> <span class="o">+</span> <span class="n">mon_addr_len</span><span class="p">,</span>
				<span class="n">parse_rbd_opts_token</span><span class="p">,</span> <span class="n">rbd_opts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_opts</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>
	<span class="n">rbdc</span> <span class="o">=</span> <span class="n">__rbd_client_find</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbdc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* using an existing client */</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>

		<span class="n">ceph_destroy_options</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_opts</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">rbdc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>

	<span class="n">rbdc</span> <span class="o">=</span> <span class="n">rbd_client_create</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">rbd_opts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rbdc</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_opts</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rbdc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Destroy ceph client</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must hold rbd_client_list_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_client_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_client</span> <span class="o">*</span><span class="n">rbdc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_client</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_release_client %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rbdc</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_client_list_lock</span><span class="p">);</span>

	<span class="n">ceph_destroy_client</span><span class="p">(</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbdc</span><span class="o">-&gt;</span><span class="n">rbd_opts</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbdc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Drop reference to ceph client node. If it&#39;s not referenced anymore, release</span>
<span class="cm"> * it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_put_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rbd_client_release</span><span class="p">);</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Destroy requests collection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_coll_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_req_coll</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_coll_release %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">coll</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">coll</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a new header structure, translate header format from the on-disk</span>
<span class="cm"> * header.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_header_from_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rbd_image_header_ondisk</span> <span class="o">*</span><span class="n">ondisk</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">allocated_snaps</span><span class="p">,</span>
				 <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">snap_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ondisk</span><span class="p">,</span> <span class="n">RBD_HEADER_TEXT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RBD_HEADER_TEXT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">snap_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">snap_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snap_count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">UINT_MAX</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_snap_context</span><span class="p">))</span>
			 <span class="o">/</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">ondisk</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_snap_context</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">snap_count</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">ondisk</span><span class="p">),</span>
				<span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names_len</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">snap_names_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snap_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names_len</span><span class="p">,</span>
					     <span class="n">gfp_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_snapc</span><span class="p">;</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_sizes</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">snap_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
					     <span class="n">gfp_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_sizes</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_names</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_sizes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">block_name</span><span class="p">,</span> <span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">block_name</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">block_name</span><span class="p">));</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">image_size</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">image_size</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_order</span> <span class="o">=</span> <span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">order</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">crypt_type</span> <span class="o">=</span> <span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">crypt_type</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">comp_type</span> <span class="o">=</span> <span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">comp_type</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">nref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_seq</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">snap_seq</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">num_snaps</span> <span class="o">=</span> <span class="n">snap_count</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">total_snaps</span> <span class="o">=</span> <span class="n">snap_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snap_count</span> <span class="o">&amp;&amp;</span> <span class="n">allocated_snaps</span> <span class="o">==</span> <span class="n">snap_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">snap_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">image_size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* copy snapshot names */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ondisk</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_names:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names</span><span class="p">);</span>
<span class="nl">err_snapc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snap_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">snap_name</span><span class="p">,</span>
			<span class="n">u64</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">total_snaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">snap_name</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* Found it.  Pass back its id and/or size */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">)</span>
				<span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
				<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Skip ahead to the next name */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_header_set_snap</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">RBD_SNAP_HEAD_NAME</span><span class="p">));</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">,</span> <span class="n">RBD_SNAP_HEAD_NAME</span><span class="p">,</span>
		    <span class="k">sizeof</span> <span class="p">(</span><span class="n">RBD_SNAP_HEAD_NAME</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">total_snaps</span><span class="p">)</span>
			<span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_seq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">snap_id</span> <span class="o">=</span> <span class="n">CEPH_NOSNAP</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
			<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">image_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snap_by_name</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">snap_id</span> <span class="o">=</span> <span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_header_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snapc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_sizes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the actual striped segment name, offset and length</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">rbd_get_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block_name</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">seg_name</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">segofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_order</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seg_name</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">seg_name</span><span class="p">,</span> <span class="n">RBD_MAX_SEG_NAME_LEN</span><span class="p">,</span>
			 <span class="s">&quot;%s.%012llx&quot;</span><span class="p">,</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>

	<span class="n">ofs</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_order</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_order</span><span class="p">)</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">segofs</span><span class="p">)</span>
		<span class="o">*</span><span class="n">segofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_get_num_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				<span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">start_seg</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_order</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">end_seg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_order</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">end_seg</span> <span class="o">-</span> <span class="n">start_seg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * returns the size of an object in the image</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">rbd_obj_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_order</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bio helpers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bio_chain_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">chain</span><span class="p">;</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * zeros a bio chain, starting at specific offset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zero_bio_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&gt;</span> <span class="n">start_ofs</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">start_ofs</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="n">bvec_kmap_irq</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">remainder</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">-</span> <span class="n">remainder</span><span class="p">);</span>
				<span class="n">bvec_kunmap_irq</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bio_chain_clone - clone a chain of bios up to a certain length.</span>
<span class="cm"> * might return a bio_pair that will need to be released.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">bio_chain_clone</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">old</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">next</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">bio_pair</span> <span class="o">**</span><span class="n">bp</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfpmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">old_chain</span> <span class="o">=</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="o">*</span><span class="n">new_chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio_pair_release</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">old_chain</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bio_kmalloc</span><span class="p">(</span><span class="n">gfpmask</span><span class="p">,</span> <span class="n">old_chain</span><span class="o">-&gt;</span><span class="n">bi_max_vecs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">old_chain</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio_pair</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * this split can only happen with a single paged bio,</span>
<span class="cm">			 * split_bio will BUG_ON if this is not the case</span>
<span class="cm">			 */</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;bio_chain_clone split! total=%d remaining=%d&quot;</span>
			     <span class="s">&quot;bi_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">total</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="o">-</span><span class="n">total</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">old_chain</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">);</span>

			<span class="cm">/* split the bio. We&#39;ll release it either in the next</span>
<span class="cm">			   call, or it will have to be released outside */</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="n">bio_split</span><span class="p">(</span><span class="n">old_chain</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">total</span><span class="p">)</span> <span class="o">/</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

			<span class="n">__bio_clone</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">bio1</span><span class="p">);</span>

			<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">bio2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__bio_clone</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">old_chain</span><span class="p">);</span>
			<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">old_chain</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">gfpmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__GFP_WAIT</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_chain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_chain</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tail</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">old_chain</span> <span class="o">=</span> <span class="n">old_chain</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>

		<span class="n">total</span> <span class="o">+=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">tail</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">old_chain</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">new_chain</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;bio_chain_clone with err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bio_chain_put</span><span class="p">(</span><span class="n">new_chain</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * helpers for osd request op vectors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_create_rw_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">**</span><span class="n">ops</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">num_ops</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">opcode</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">payload_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_req_op</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_ops</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
		       <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * op extent offset and length will be set later on</span>
<span class="cm">	 * in calc_raw_layout()</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">payload_len</span> <span class="o">=</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_destroy_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_coll_end_req_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_coll_end_req_index %p index %d ret %d len %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">coll</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">coll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blk_end_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="n">coll</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">coll</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">coll</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">min</span> <span class="o">=</span> <span class="n">coll</span><span class="o">-&gt;</span><span class="n">num_done</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">coll</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">&amp;&amp;</span> <span class="n">coll</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">done</span><span class="p">)</span>
		<span class="n">max</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__blk_end_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">coll</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rc</span><span class="p">,</span>
				  <span class="n">coll</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes</span><span class="p">);</span>
		<span class="n">coll</span><span class="o">-&gt;</span><span class="n">num_done</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coll</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rbd_coll_release</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_coll_end_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rbd_coll_end_req_index</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">coll</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">coll_index</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send ceph osd request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_do_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">snapid</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">num_pages</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">num_reply</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">coll_index</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rbd_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">),</span>
			  <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">**</span><span class="n">linger_req</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="o">*</span><span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_request</span> <span class="o">*</span><span class="n">req_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_request_head</span> <span class="o">*</span><span class="n">reqhead</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">;</span>

	<span class="n">req_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req_data</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">coll</span><span class="p">)</span>
			<span class="n">rbd_coll_end_req_index</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">coll</span><span class="p">,</span> <span class="n">coll_index</span><span class="p">,</span>
					       <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">coll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req_data</span><span class="o">-&gt;</span><span class="n">coll</span> <span class="o">=</span> <span class="n">coll</span><span class="p">;</span>
		<span class="n">req_data</span><span class="o">-&gt;</span><span class="n">coll_index</span> <span class="o">=</span> <span class="n">coll_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_do_request obj=%s ofs=%lld len=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="n">osdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">osdc</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_osdc_alloc_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">snapc</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span>
					<span class="nb">false</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done_pages</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_callback</span> <span class="o">=</span> <span class="n">rbd_cb</span><span class="p">;</span>

	<span class="n">req_data</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="n">rq</span><span class="p">;</span>
	<span class="n">req_data</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">req_data</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
	<span class="n">req_data</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_priv</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">;</span>

	<span class="n">reqhead</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">reqhead</span><span class="o">-&gt;</span><span class="n">snapid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">CEPH_NOSNAP</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">);</span>

	<span class="n">layout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_file_layout</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">layout</span><span class="p">));</span>
	<span class="n">layout</span><span class="o">-&gt;</span><span class="n">fl_stripe_unit</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RBD_MAX_OBJ_ORDER</span><span class="p">);</span>
	<span class="n">layout</span><span class="o">-&gt;</span><span class="n">fl_stripe_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">layout</span><span class="o">-&gt;</span><span class="n">fl_object_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RBD_MAX_OBJ_ORDER</span><span class="p">);</span>
	<span class="n">layout</span><span class="o">-&gt;</span><span class="n">fl_pg_pool</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">poolid</span><span class="p">);</span>
	<span class="n">ceph_calc_raw_layout</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">snapid</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span>
				<span class="n">req</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

	<span class="n">ceph_osdc_build_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span>
				<span class="n">ops</span><span class="p">,</span>
				<span class="n">snapc</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mtime</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_oid_len</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linger_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_osdc_set_request_linger</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="o">*</span><span class="n">linger_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_osdc_start_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbd_cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_osdc_wait_request</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ver</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ver</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reassert_version</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;reassert_ver=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reassert_version</span><span class="p">.</span><span class="n">version</span><span class="p">));</span>
		<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">done_err:</span>
	<span class="n">bio_chain_put</span><span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">done_pages:</span>
	<span class="n">rbd_coll_end_req</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ceph osd op callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_req_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_request</span> <span class="o">*</span><span class="n">req_data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_reply_head</span> <span class="o">*</span><span class="n">replyhead</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_op</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_op</span><span class="p">;</span>

	<span class="cm">/* parse reply */</span>
	<span class="n">replyhead</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">replyhead</span><span class="o">-&gt;</span><span class="n">num_ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">op</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">replyhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">replyhead</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="n">bytes</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">read_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_READ</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_req_cb bytes=%lld readop=%d rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">read_op</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">&amp;&amp;</span> <span class="n">read_op</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zero_bio_chain</span><span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">read_op</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">req_data</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zero_bio_chain</span><span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">req_data</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rbd_coll_end_req</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span>
		<span class="n">bio_chain_put</span><span class="p">(</span><span class="n">req_data</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_simple_req_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ceph_osdc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do a synchronous ceph osd operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_sync_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">snapid</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">opcode</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">orig_ops</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">num_reply</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_osd_request</span> <span class="o">**</span><span class="n">linger_req</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="o">*</span><span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">orig_ops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">payload_len</span><span class="p">;</span>

	<span class="n">num_pages</span> <span class="o">=</span> <span class="n">calc_pages_for</span><span class="p">(</span><span class="n">ofs</span> <span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">ceph_alloc_page_vector</span><span class="p">(</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pages</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orig_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">payload_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_create_rw_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_copy_to_page_vector</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done_ops</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_do_request</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">snapc</span><span class="p">,</span> <span class="n">snapid</span><span class="p">,</span>
			  <span class="n">obj</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">pages</span><span class="p">,</span> <span class="n">num_pages</span><span class="p">,</span>
			  <span class="n">flags</span><span class="p">,</span>
			  <span class="n">ops</span><span class="p">,</span>
			  <span class="mi">2</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">linger_req</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_copy_from_page_vector</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="nl">done_ops:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orig_ops</span><span class="p">)</span>
		<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">ceph_release_page_vector</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">num_pages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do an asynchronous ceph osd operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_do_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="n">snapid</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_reply</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">coll_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">seg_name</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">seg_ofs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">seg_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">payload_len</span><span class="p">;</span>

	<span class="n">seg_name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RBD_MAX_SEG_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seg_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">seg_len</span> <span class="o">=</span> <span class="n">rbd_get_segment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span>
				  <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">block_name</span><span class="p">,</span>
				  <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				  <span class="n">seg_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg_ofs</span><span class="p">);</span>

	<span class="n">payload_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">?</span> <span class="n">seg_len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_create_rw_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* we&#39;ve taken care of segment sizes earlier when we</span>
<span class="cm">	   cloned the bios. We should never have a segment</span>
<span class="cm">	   truncated at this point */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">seg_len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_do_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="p">,</span> <span class="n">snapc</span><span class="p">,</span> <span class="n">snapid</span><span class="p">,</span>
			     <span class="n">seg_name</span><span class="p">,</span> <span class="n">seg_ofs</span><span class="p">,</span> <span class="n">seg_len</span><span class="p">,</span>
			     <span class="n">bio</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">flags</span><span class="p">,</span>
			     <span class="n">ops</span><span class="p">,</span>
			     <span class="n">num_reply</span><span class="p">,</span>
			     <span class="n">coll</span><span class="p">,</span> <span class="n">coll_index</span><span class="p">,</span>
			     <span class="n">rbd_req_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">seg_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request async osd write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">coll_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rbd_do_op</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="p">,</span> <span class="n">snapc</span><span class="p">,</span> <span class="n">CEPH_NOSNAP</span><span class="p">,</span>
			 <span class="n">CEPH_OSD_OP_WRITE</span><span class="p">,</span>
			 <span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">|</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">,</span>
			 <span class="mi">2</span><span class="p">,</span>
			 <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">coll</span><span class="p">,</span> <span class="n">coll_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request async osd read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">snapid</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">coll_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rbd_do_op</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			 <span class="n">snapid</span><span class="p">,</span>
			 <span class="n">CEPH_OSD_OP_READ</span><span class="p">,</span>
			 <span class="n">CEPH_OSD_FLAG_READ</span><span class="p">,</span>
			 <span class="mi">2</span><span class="p">,</span>
			 <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">coll</span><span class="p">,</span> <span class="n">coll_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request sync osd read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_sync_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_snap_context</span> <span class="o">*</span><span class="n">snapc</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">snapid</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="o">*</span><span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rbd_req_sync_op</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">snapid</span><span class="p">,</span>
			       <span class="n">CEPH_OSD_OP_READ</span><span class="p">,</span>
			       <span class="n">CEPH_OSD_FLAG_READ</span><span class="p">,</span>
			       <span class="nb">NULL</span><span class="p">,</span>
			       <span class="mi">1</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request sync osd watch</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_sync_notify_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">ver</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">notify_id</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_create_rw_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CEPH_OSD_OP_NOTIFY_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">ver</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">obj_version</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">notify_id</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_do_request</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CEPH_NOSNAP</span><span class="p">,</span>
			  <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">pages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">CEPH_OSD_FLAG_READ</span><span class="p">,</span>
			  <span class="n">ops</span><span class="p">,</span>
			  <span class="mi">1</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">rbd_simple_req_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_watch_cb</span><span class="p">(</span><span class="n">u64</span> <span class="n">ver</span><span class="p">,</span> <span class="n">u64</span> <span class="n">notify_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_watch_cb %s notify_id=%lld opcode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">,</span>
		<span class="n">notify_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">opcode</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__rbd_refresh_header</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="n">RBD_DRV_NAME</span> <span class="s">&quot;%d got notification but failed to &quot;</span>
			   <span class="s">&quot; update snaps: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">rbd_req_sync_notify_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">notify_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request sync osd watch</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_sync_watch</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">osdc</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_create_rw_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CEPH_OSD_OP_WATCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_osdc_create_event</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">rbd_watch_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">ver</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ver</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_event</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_req_sync_op</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			      <span class="n">CEPH_NOSNAP</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span>
			      <span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">|</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">,</span>
			      <span class="n">ops</span><span class="p">,</span>
			      <span class="mi">1</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_request</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_event</span><span class="p">;</span>

	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_event:</span>
	<span class="n">ceph_osdc_cancel_event</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_event</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request sync osd unwatch</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_sync_unwatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_create_rw_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CEPH_OSD_OP_WATCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_event</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_req_sync_op</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			      <span class="n">CEPH_NOSNAP</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span>
			      <span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">|</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">,</span>
			      <span class="n">ops</span><span class="p">,</span>
			      <span class="mi">1</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">ceph_osdc_cancel_event</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_event</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watch_event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rbd_notify_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_notify_cb</span><span class="p">(</span><span class="n">u64</span> <span class="n">ver</span><span class="p">,</span> <span class="n">u64</span> <span class="n">notify_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rbd_notify_cb %s notify_id=%lld opcode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">,</span>
		<span class="n">notify_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">opcode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request sync osd notify</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_sync_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		          <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">osdc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_notify_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_create_rw_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CEPH_OSD_OP_NOTIFY</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_osdc_create_event</span><span class="p">(</span><span class="n">osdc</span><span class="p">,</span> <span class="n">rbd_notify_cb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">ver</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">prot_ver</span> <span class="o">=</span> <span class="n">RADOS_NOTIFY_VER</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">watch</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_req_sync_op</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">CEPH_NOSNAP</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span>
			       <span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">|</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">,</span>
			       <span class="n">ops</span><span class="p">,</span>
			       <span class="mi">1</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_event</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_osdc_wait_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">CEPH_OSD_TIMEOUT_DEFAULT</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_osdc_wait_event returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_event:</span>
	<span class="n">ceph_osdc_cancel_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request sync osd read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_req_sync_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			     <span class="n">u64</span> <span class="o">*</span><span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_osd_req_op</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cls_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">method_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">method</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_create_rw_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CEPH_OSD_OP_CALL</span><span class="p">,</span>
				    <span class="n">cls_len</span> <span class="o">+</span> <span class="n">method_len</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cls</span><span class="p">.</span><span class="n">class_name</span> <span class="o">=</span> <span class="n">cls</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cls</span><span class="p">.</span><span class="n">class_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span><span class="n">cls_len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cls</span><span class="p">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="n">method</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cls</span><span class="p">.</span><span class="n">method_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span><span class="n">method_len</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cls</span><span class="p">.</span><span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cls</span><span class="p">.</span><span class="n">indata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cls</span><span class="p">.</span><span class="n">indata_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_req_sync_op</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">CEPH_NOSNAP</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span>
			       <span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">|</span> <span class="n">CEPH_OSD_FLAG_ONDISK</span><span class="p">,</span>
			       <span class="n">ops</span><span class="p">,</span>
			       <span class="mi">1</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>

	<span class="n">rbd_destroy_ops</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;cls_exec returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="nf">rbd_alloc_coll</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_reqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span> <span class="o">=</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_req_coll</span><span class="p">)</span> <span class="o">+</span>
			        <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_req_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_reqs</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">coll</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">coll</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">=</span> <span class="n">num_reqs</span><span class="p">;</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coll</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">coll</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * block device queue callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_rq_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_pair</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">rq</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">rq_bio</span><span class="p">,</span> <span class="o">*</span><span class="n">next_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">do_write</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">op_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">num_segs</span><span class="p">,</span> <span class="n">cur_seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rbd_req_coll</span> <span class="o">*</span><span class="n">coll</span><span class="p">;</span>

		<span class="cm">/* peek at request from block layer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;fetched request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* filter out block requests we don&#39;t understand */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* deduce our operation (read, write) */</span>
		<span class="n">do_write</span> <span class="o">=</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">*</span> <span class="n">SECTOR_SIZE</span><span class="p">;</span>
		<span class="n">rq_bio</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_write</span> <span class="o">&amp;&amp;</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">read_only</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;%s 0x%x bytes at 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">do_write</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
		     <span class="n">size</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">*</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>

		<span class="n">num_segs</span> <span class="o">=</span> <span class="n">rbd_get_num_segments</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">coll</span> <span class="o">=</span> <span class="n">rbd_alloc_coll</span><span class="p">(</span><span class="n">num_segs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">coll</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* a bio clone to be passed down to OSD req */</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rq-&gt;bio-&gt;bi_vcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">);</span>
			<span class="n">op_size</span> <span class="o">=</span> <span class="n">rbd_get_segment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span>
						  <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">block_name</span><span class="p">,</span>
						  <span class="n">ofs</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coll</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_chain_clone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq_bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span>
					      <span class="n">op_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rbd_coll_end_req_index</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">coll</span><span class="p">,</span> <span class="n">cur_seg</span><span class="p">,</span>
						       <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">op_size</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_seg</span><span class="p">;</span>
			<span class="p">}</span>


			<span class="cm">/* init OSD command: write or read */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_write</span><span class="p">)</span>
				<span class="n">rbd_req_write</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="p">,</span>
					      <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="p">,</span>
					      <span class="n">ofs</span><span class="p">,</span>
					      <span class="n">op_size</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span>
					      <span class="n">coll</span><span class="p">,</span> <span class="n">cur_seg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rbd_req_read</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="p">,</span>
					     <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snap_id</span><span class="p">,</span>
					     <span class="n">ofs</span><span class="p">,</span>
					     <span class="n">op_size</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span>
					     <span class="n">coll</span><span class="p">,</span> <span class="n">cur_seg</span><span class="p">);</span>

<span class="nl">next_seg:</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">op_size</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">op_size</span><span class="p">;</span>

			<span class="n">cur_seg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rq_bio</span> <span class="o">=</span> <span class="n">next_bio</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coll</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rbd_coll_release</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span>
			<span class="n">bio_pair_release</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * a queue callback. Makes sure that we don&#39;t create a bio that spans across</span>
<span class="cm"> * multiple osd objects. One exception would be with a single page bios,</span>
<span class="cm"> * which we handle later at bio_chain_clone</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_merge_bvec</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bvec_merge_data</span> <span class="o">*</span><span class="n">bmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bio_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">chunk_sectors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">obj_order</span> <span class="o">-</span> <span class="n">SECTOR_SHIFT</span><span class="p">);</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="n">bmd</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">get_start_sect</span><span class="p">(</span><span class="n">bmd</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">);</span>
	<span class="n">bio_sectors</span> <span class="o">=</span> <span class="n">bmd</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span>  <span class="p">(</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="p">((</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				 <span class="o">+</span> <span class="n">bio_sectors</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* bio_add cannot handle a negative return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&amp;&amp;</span> <span class="n">bio_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_free_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rbd_header_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENHD_FL_UP</span><span class="p">)</span>
		<span class="n">del_gendisk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reload the ondisk the header </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_read_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_image_header_ondisk</span> <span class="o">*</span><span class="n">dh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">snap_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ver</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First reads the fixed-size header to determine the number</span>
<span class="cm">	 * of snapshots, then re-reads it, along with all snapshot</span>
<span class="cm">	 * records as well as their stored names.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">dh</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dh</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dh</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_req_sync_read</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span>
				       <span class="nb">NULL</span><span class="p">,</span> <span class="n">CEPH_NOSNAP</span><span class="p">,</span>
				       <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dh</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_header_from_disk</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">dh</span><span class="p">,</span> <span class="n">snap_count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unrecognized header format&quot;</span>
					   <span class="s">&quot; for image %s&quot;</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_dh</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snap_count</span> <span class="o">==</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">total_snaps</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">snap_count</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">total_snaps</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">dh</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">snap_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_image_snap_ondisk</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">snap_names_len</span><span class="p">;</span>

		<span class="n">rbd_header_free</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">obj_version</span> <span class="o">=</span> <span class="n">ver</span><span class="p">;</span>

<span class="nl">out_dh:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create a snapshot</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_header_add_snap</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">snap_name</span><span class="p">,</span>
			       <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">snap_name</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">new_snapid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mon_client</span> <span class="o">*</span><span class="n">monc</span><span class="p">;</span>

	<span class="cm">/* we should create a snapshot only if we&#39;re pointing at the head */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snap_id</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">monc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ceph_monc_create_snapid</span><span class="p">(</span><span class="n">monc</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">poolid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_snapid</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;created snapid=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_snapid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">ceph_encode_string_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">snap_name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_encode_64_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">new_snapid</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_req_sync_exec</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">,</span> <span class="s">&quot;rbd&quot;</span><span class="p">,</span> <span class="s">&quot;snap_add&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">new_snapid</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rbd_remove_all_snaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snap</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_snap</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">__rbd_remove_snap_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">snap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * only read the first part of the ondisk header, without the snaps info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__rbd_refresh_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_image_header</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">snap_seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">follow_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_read_header</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* resized? */</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">image_size</span> <span class="o">/</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="n">snap_seq</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">total_snaps</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">snap_seq</span><span class="p">)</span>
		<span class="cm">/* pointing at the head, will need to follow that</span>
<span class="cm">		   if head moves */</span>
		<span class="n">follow_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_names</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_sizes</span><span class="p">);</span>

	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">total_snaps</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">total_snaps</span><span class="p">;</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">snapc</span><span class="p">;</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_names</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">snap_names</span><span class="p">;</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_names_len</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">snap_names_len</span><span class="p">;</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_sizes</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">snap_sizes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">follow_seq</span><span class="p">)</span>
		<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">snap_seq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__rbd_init_snaps_header</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_init_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">segment_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* contact OSD, request size info about the object being mapped */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_read_header</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* no need to lock here, as rbd_dev is not registered yet */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__rbd_init_snaps_header</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_header_set_snap</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* create gendisk info */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="n">RBD_MINORS_PER_MAJOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">),</span> <span class="n">RBD_DRV_NAME</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
		 <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rbd_bd_ops</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="p">;</span>

	<span class="cm">/* init rq */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">rbd_rq_fn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_disk</span><span class="p">;</span>

	<span class="cm">/* We use the default size, but let&#39;s be explicit about it. */</span>
	<span class="n">blk_queue_physical_block_size</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>

	<span class="cm">/* set io sizes to object size */</span>
	<span class="n">segment_size</span> <span class="o">=</span> <span class="n">rbd_obj_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">segment_size</span> <span class="o">/</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>
	<span class="n">blk_queue_max_segment_size</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">);</span>
	<span class="n">blk_queue_io_min</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">);</span>
	<span class="n">blk_queue_io_opt</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">);</span>

	<span class="n">blk_queue_merge_bvec</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rbd_merge_bvec</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="p">;</span>

	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>

	<span class="cm">/* finally, announce the disk to the world */</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">total_size</span> <span class="o">/</span> <span class="n">SECTOR_SIZE</span><span class="p">);</span>
	<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: added with size 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">total_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_disk:</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  sysfs</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="nf">dev_to_rbd_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">image_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_major_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_client_id_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;client%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ceph_client_id</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_pool_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">pool_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_snap_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_image_refresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">__rbd_refresh_header</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_size_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_major_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_client_id_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_pool_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rbd_image_refresh</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">current_snap</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_snap_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">create_snap</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rbd_snap_add</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">rbd_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_major</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_client_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pool</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_current_snap</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_refresh</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_create_snap</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">rbd_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">rbd_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">rbd_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">rbd_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_sysfs_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">rbd_device_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rbd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span>		<span class="o">=</span> <span class="n">rbd_attr_groups</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">rbd_sysfs_dev_release</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm">  sysfs - snapshots</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_snap_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_snap</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_snap_id_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_snap</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">snap_size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_snap_size_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">snap_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">rbd_snap_id_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">rbd_snap_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_snap_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_snap_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">rbd_snap_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">rbd_snap_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_snap_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_snap</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">snap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">rbd_snap_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">rbd_snap_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">rbd_snap_device_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">groups</span>		<span class="o">=</span> <span class="n">rbd_snap_attr_groups</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">rbd_snap_dev_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rbd_remove_snap_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_register_snap_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rbd_snap_device_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">rbd_snap_dev_release</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;snap_%s&quot;</span><span class="p">,</span> <span class="n">snap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__rbd_add_snap_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">**</span><span class="n">snapp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">snap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_is_registered</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_register_snap_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">snap</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">snapp</span> <span class="o">=</span> <span class="n">snap</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">snap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * search for the previous snap in a null delimited string list</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">rbd_prev_snap_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">name</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * compare the old list of snapshots that we have to what&#39;s in the header</span>
<span class="cm"> * and update it accordingly. Note that the header holds the snapshots</span>
<span class="cm"> * in a reverse order (from newest to oldest) and we need to go from</span>
<span class="cm"> * older to new so that we don&#39;t get a duplicate snap name when</span>
<span class="cm"> * doing the process (e.g., removed snapshot and recreated a new</span>
<span class="cm"> * one with the same name.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__rbd_init_snaps_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">first_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">total_snaps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span><span class="p">,</span> <span class="o">*</span><span class="n">old_snap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">first_name</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_names</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">first_name</span> <span class="o">+</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snap_names_len</span><span class="p">;</span>

	<span class="n">list_for_each_prev_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">cur_id</span><span class="p">;</span>

		<span class="n">old_snap</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_snap</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">cur_id</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">||</span> <span class="n">old_snap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">cur_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* old_snap-&gt;id was skipped, thus was removed */</span>
			<span class="n">__rbd_remove_snap_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">old_snap</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_snap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">cur_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we have this snapshot already */</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">rbd_prev_snap_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">first_name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">rbd_prev_snap_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">first_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cur_id</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">snapc</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/* snapshot removal? handle it above */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_id</span> <span class="o">&gt;=</span> <span class="n">old_snap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* a new snapshot */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__rbd_add_snap_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="cm">/* note that we add it backward so using n and not p */</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* we&#39;re done going over the old snap list, just add what&#39;s left */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">rbd_prev_snap_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">first_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__rbd_add_snap_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snap</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_bus_add_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_snap</span> <span class="o">*</span><span class="n">snap</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rbd_bus_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rbd_device_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rbd_root_dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">rbd_dev_release</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_register_snap_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">snap</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_bus_del_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_init_watch_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_req_sync_watch</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">,</span>
					 <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">obj_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">__rbd_refresh_header</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">atomic64_t</span> <span class="n">rbd_id_max</span> <span class="o">=</span> <span class="n">ATOMIC64_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Get a unique rbd identifier for the given new rbd_dev, and add</span>
<span class="cm"> * the rbd_dev to the global list.  The minimum rbd id is 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_id_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">atomic64_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_id_max</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove an rbd_dev from the global list, and record that its</span>
<span class="cm"> * identifier is no longer in use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_id_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rbd_id</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_id</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rbd_id</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the id being &quot;put&quot; is not the current maximum, there</span>
<span class="cm">	 * is nothing special we need to do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbd_id</span> <span class="o">!=</span> <span class="n">atomic64_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_id_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to update the current maximum id.  Search the</span>
<span class="cm">	 * list to find out what it is.  We&#39;re more likely to find</span>
<span class="cm">	 * the maximum at the end, so search the list backward.</span>
<span class="cm">	 */</span>
	<span class="n">max_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_prev</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">;</span>

		<span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_device</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbd_id</span> <span class="o">&gt;</span> <span class="n">max_id</span><span class="p">)</span>
			<span class="n">max_id</span> <span class="o">=</span> <span class="n">rbd_id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The max id could have been updated by rbd_id_get(), in</span>
<span class="cm">	 * which case it now accurately reflects the new maximum.</span>
<span class="cm">	 * Be careful not to overwrite the maximum value in that</span>
<span class="cm">	 * case.</span>
<span class="cm">	 */</span>
	<span class="n">atomic64_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_id_max</span><span class="p">,</span> <span class="n">rbd_id</span><span class="p">,</span> <span class="n">max_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Skips over white space at *buf, and updates *buf to point to the</span>
<span class="cm"> * first found non-space character (if any). Returns the length of</span>
<span class="cm"> * the token (string of non-white space characters) found.  Note</span>
<span class="cm"> * that *buf must be terminated with &#39;\0&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">next_token</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">        * These are the characters that produce nonzero for</span>
<span class="cm">        * isspace() in the &quot;C&quot; and &quot;POSIX&quot; locales.</span>
<span class="cm">        */</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spaces</span> <span class="o">=</span> <span class="s">&quot; </span><span class="se">\f\n\r\t\v</span><span class="s">&quot;</span><span class="p">;</span>

        <span class="o">*</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">strspn</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>	<span class="cm">/* Find start of token */</span>

	<span class="k">return</span> <span class="n">strcspn</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>   <span class="cm">/* Return token length */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Finds the next token in *buf, and if the provided token buffer is</span>
<span class="cm"> * big enough, copies the found token into it.  The result, if</span>
<span class="cm"> * copied, is guaranteed to be terminated with &#39;\0&#39;.  Note that *buf</span>
<span class="cm"> * must be terminated with &#39;\0&#39; on entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the length of the token found (not including the &#39;\0&#39;).</span>
<span class="cm"> * Return value will be 0 if no token is found, and it will be &gt;=</span>
<span class="cm"> * token_size if the token would not fit.</span>
<span class="cm"> *</span>
<span class="cm"> * The *buf pointer will be updated to point beyond the end of the</span>
<span class="cm"> * found token.  Note that this occurs even if the token buffer is</span>
<span class="cm"> * too small to hold it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">copy_token</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">token_size</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">next_token</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">token_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">token</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This fills in the pool_name, obj, obj_len, snap_name, obj_len,</span>
<span class="cm"> * rbd_dev, rbd_md_name, and name fields of the given rbd_dev, based</span>
<span class="cm"> * on the list of monitor addresses and other options provided via</span>
<span class="cm"> * /sys/bus/rbd/add.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_add_parse_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">mon_addrs</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="o">*</span><span class="n">mon_addrs_size</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">options_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span>	<span class="n">len</span><span class="p">;</span>

	<span class="cm">/* The first four tokens are required */</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">next_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">mon_addrs_size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">mon_addrs</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">copy_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">options_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">options_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">copy_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">pool_name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">pool_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">pool_name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">copy_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* We have the object length in hand, save it. */</span>

	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">RBD_MAX_MD_NAME_LEN</span>
				<span class="o">&lt;</span> <span class="n">RBD_MAX_OBJ_NAME_LEN</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">RBD_SUFFIX</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">,</span> <span class="n">RBD_SUFFIX</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The snapshot name is optional, but it&#39;s an error if it&#39;s</span>
<span class="cm">	 * too long.  If no snapshot is supplied, fill in the default.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">copy_token</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">,</span> <span class="n">RBD_SNAP_HEAD_NAME</span><span class="p">,</span>
			<span class="k">sizeof</span> <span class="p">(</span><span class="n">RBD_SNAP_HEAD_NAME</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snap_name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		       <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mon_addrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">mon_addrs_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_client</span> <span class="o">*</span><span class="n">osdc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rbd_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbd_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_nomem</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_nomem</span><span class="p">;</span>

	<span class="cm">/* static rbd_device initialization */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">snaps</span><span class="p">);</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">header_rwsem</span><span class="p">);</span>

	<span class="cm">/* generate unique id: find highest unique id, add one */</span>
	<span class="n">rbd_id_get</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

	<span class="cm">/* Fill in the device name, now that we have its id. */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">DEV_NAME_LEN</span>
			<span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">RBD_DRV_NAME</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAX_INT_FORMAT_WIDTH</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">RBD_DRV_NAME</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* parse add command */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_add_parse_args</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mon_addrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mon_addrs_size</span><span class="p">,</span>
				<span class="n">options</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_id</span><span class="p">;</span>

	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span> <span class="o">=</span> <span class="n">rbd_get_client</span><span class="p">(</span><span class="n">mon_addrs</span><span class="p">,</span> <span class="n">mon_addrs_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
						<span class="n">options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_put_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pick the pool */</span>
	<span class="n">osdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">osdc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ceph_pg_poolid_by_name</span><span class="p">(</span><span class="n">osdc</span><span class="o">-&gt;</span><span class="n">osdmap</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">pool_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_client</span><span class="p">;</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">poolid</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* register our block device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_client</span><span class="p">;</span>
	<span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_bus_add_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_blkdev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point cleanup in the event of an error is the job</span>
<span class="cm">	 * of the sysfs code (initiated by rbd_bus_del_dev()).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Set up and announce blkdev mapping.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_init_disk</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_bus</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_init_watch_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_bus</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">err_out_bus:</span>
	<span class="cm">/* this will also clean up rest of rbd_dev stuff */</span>

	<span class="n">rbd_bus_del_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_out_blkdev:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="nl">err_out_client:</span>
	<span class="n">rbd_put_client</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
<span class="nl">err_put_id:</span>
	<span class="n">rbd_id_put</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
<span class="nl">err_nomem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;Error adding device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="nf">__rbd_get_dev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbd_dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_device</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rbd_dev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_dev_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">watch_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">rbd_client</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

		<span class="n">ceph_osdc_unregister_linger_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">osdc</span><span class="p">,</span>
						    <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">watch_request</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">watch_event</span><span class="p">)</span>
		<span class="n">rbd_req_sync_unwatch</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">);</span>

	<span class="n">rbd_put_client</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

	<span class="cm">/* clean up and free blkdev */</span>
	<span class="n">rbd_free_disk</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* done with the id, and with the rbd_dev */</span>
	<span class="n">rbd_id_put</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

	<span class="cm">/* release module ref */</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ul</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* convert to int; abort if we lost anything in the conversion */</span>
	<span class="n">target_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ul</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_id</span> <span class="o">!=</span> <span class="n">ul</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">__rbd_get_dev</span><span class="p">(</span><span class="n">target_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbd_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__rbd_remove_all_snaps</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="n">rbd_bus_del_dev</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rbd_snap_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbd_device</span> <span class="o">*</span><span class="n">rbd_dev</span> <span class="o">=</span> <span class="n">dev_to_rbd_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rbd_header_add_snap</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span>
				  <span class="n">name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__rbd_refresh_header</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="cm">/* shouldn&#39;t hold ctl_mutex when notifying.. notify might</span>
<span class="cm">	   trigger a watch callback that would need to get that mutex */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>

	<span class="cm">/* make a best effort, don&#39;t error if failed */</span>
	<span class="n">rbd_req_sync_notify</span><span class="p">(</span><span class="n">rbd_dev</span><span class="p">,</span> <span class="n">rbd_dev</span><span class="o">-&gt;</span><span class="n">obj_md_name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create control files in sysfs</span>
<span class="cm"> * /sys/bus/rbd/...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbd_sysfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_root_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_root_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbd_sysfs_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_bus_type</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbd_root_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">rbd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rbd_sysfs_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;loaded &quot;</span> <span class="n">RBD_DRV_NAME_LONG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rbd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rbd_sysfs_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rbd_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rbd_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sage Weil &lt;sage@newdream.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yehuda Sadeh &lt;yehuda@hq.newdream.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;rados block device&quot;</span><span class="p">);</span>

<span class="cm">/* following authorship retained from original osdblk.c */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jeff Garzik &lt;jeff@garzik.org&gt;&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
