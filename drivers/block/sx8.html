<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › sx8.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sx8.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  sx8.c: Driver for Promise SATA SX8 looks-like-I2O hardware</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2004-2005 Red Hat, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  Author/maintainer:  Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define CARM_DEBUG</span>
<span class="c">#define CARM_VERBOSE_DEBUG</span>
<span class="cp">#else</span>
<span class="cp">#undef CARM_DEBUG</span>
<span class="cp">#undef CARM_VERBOSE_DEBUG</span>
<span class="cp">#endif</span>
<span class="cp">#undef CARM_NDEBUG</span>

<span class="cp">#define DRV_NAME &quot;sx8&quot;</span>
<span class="cp">#define DRV_VERSION &quot;1.0&quot;</span>
<span class="cp">#define PFX DRV_NAME &quot;: &quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jeff Garzik&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Promise SATA SX8 block driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * SX8 hardware has a single message queue for all ATA ports.</span>
<span class="cm"> * When this driver was written, the hardware (firmware?) would</span>
<span class="cm"> * corrupt data eventually, if more than one request was outstanding.</span>
<span class="cm"> * As one can imagine, having 8 ports bottlenecking on a single</span>
<span class="cm"> * command hurts performance.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on user reports, later versions of the hardware (firmware?)</span>
<span class="cm"> * seem to be able to survive with more than one command queued.</span>
<span class="cm"> *</span>
<span class="cm"> * Therefore, we default to the safe option -- 1 command -- but</span>
<span class="cm"> * allow the user to increase this.</span>
<span class="cm"> *</span>
<span class="cm"> * SX8 should be able to support up to ~60 queued commands (CARM_MAX_REQ),</span>
<span class="cm"> * but problems seem to occur when you exceed ~30, even on newer hardware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_queue</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_queue</span><span class="p">,</span> <span class="s">&quot;Maximum number of queued commands. (min==1, max==30, safe==1)&quot;</span><span class="p">);</span>


<span class="cp">#define NEXT_RESP(idx)	((idx + 1) % RMSG_Q_LEN)</span>

<span class="cm">/* 0xf is just arbitrary, non-zero noise; this is sorta like poisoning */</span>
<span class="cp">#define TAG_ENCODE(tag)	(((tag) &lt;&lt; 16) | 0xf)</span>
<span class="cp">#define TAG_DECODE(tag)	(((tag) &gt;&gt; 16) &amp; 0x1f)</span>
<span class="cp">#define TAG_VALID(tag)	((((tag) &amp; 0xf) == 0xf) &amp;&amp; (TAG_DECODE(tag) &lt; 32))</span>

<span class="cm">/* note: prints function name for you */</span>
<span class="cp">#ifdef CARM_DEBUG</span>
<span class="cp">#define DPRINTK(fmt, args...) printk(KERN_ERR &quot;%s: &quot; fmt, __func__, ## args)</span>
<span class="cp">#ifdef CARM_VERBOSE_DEBUG</span>
<span class="cp">#define VPRINTK(fmt, args...) printk(KERN_ERR &quot;%s: &quot; fmt, __func__, ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define VPRINTK(fmt, args...)</span>
<span class="cp">#endif	</span><span class="cm">/* CARM_VERBOSE_DEBUG */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(fmt, args...)</span>
<span class="cp">#define VPRINTK(fmt, args...)</span>
<span class="cp">#endif	</span><span class="cm">/* CARM_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef CARM_NDEBUG</span>
<span class="cp">#define assert(expr)</span>
<span class="cp">#else</span>
<span class="cp">#define assert(expr) \</span>
<span class="cp">        if(unlikely(!(expr))) {                                   \</span>
<span class="cp">        printk(KERN_ERR &quot;Assertion failed! %s,%s,%s,line=%d\n&quot;, \</span>
<span class="cp">	#expr, __FILE__, __func__, __LINE__);          \</span>
<span class="cp">        }</span>
<span class="cp">#endif</span>

<span class="cm">/* defines only for the constants which don&#39;t work well as enums */</span>
<span class="k">struct</span> <span class="n">carm_host</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* adapter-wide limits */</span>
	<span class="n">CARM_MAX_PORTS</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">CARM_SHM_SIZE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">CARM_MINORS_PER_MAJOR</span>	<span class="o">=</span> <span class="mi">256</span> <span class="o">/</span> <span class="n">CARM_MAX_PORTS</span><span class="p">,</span>
	<span class="n">CARM_MAX_WAIT_Q</span>		<span class="o">=</span> <span class="n">CARM_MAX_PORTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* command message queue limits */</span>
	<span class="n">CARM_MAX_REQ</span>		<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>	       <span class="cm">/* max command msgs per host */</span>
	<span class="n">CARM_MSG_LOW_WATER</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CARM_MAX_REQ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span>	     <span class="cm">/* refill mark */</span>

	<span class="cm">/* S/G limits, host-wide and per-request */</span>
	<span class="n">CARM_MAX_REQ_SG</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>	     <span class="cm">/* max s/g entries per request */</span>
	<span class="n">CARM_MAX_HOST_SG</span>	<span class="o">=</span> <span class="mi">600</span><span class="p">,</span>		<span class="cm">/* max s/g entries per host */</span>
	<span class="n">CARM_SG_LOW_WATER</span>	<span class="o">=</span> <span class="p">(</span><span class="n">CARM_MAX_HOST_SG</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span>   <span class="cm">/* re-fill mark */</span>

	<span class="cm">/* hardware registers */</span>
	<span class="n">CARM_IHQP</span>		<span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="n">CARM_INT_STAT</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* interrupt status */</span>
	<span class="n">CARM_INT_MASK</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span> <span class="cm">/* interrupt mask */</span>
	<span class="n">CARM_HMUC</span>		<span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span> <span class="cm">/* host message unit control */</span>
	<span class="n">RBUF_ADDR_LO</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span> <span class="cm">/* response msg DMA buf low 32 bits */</span>
	<span class="n">RBUF_ADDR_HI</span>		<span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span> <span class="cm">/* response msg DMA buf high 32 bits */</span>
	<span class="n">RBUF_BYTE_SZ</span>		<span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="n">CARM_RESP_IDX</span>		<span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>
	<span class="n">CARM_CMS0</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span> <span class="cm">/* command message size reg 0 */</span>
	<span class="n">CARM_LMUC</span>		<span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="n">CARM_HMPHA</span>		<span class="o">=</span> <span class="mh">0x6c</span><span class="p">,</span>
	<span class="n">CARM_INITC</span>		<span class="o">=</span> <span class="mh">0xb5</span><span class="p">,</span>

	<span class="cm">/* bits in CARM_INT_{STAT,MASK} */</span>
	<span class="n">INT_RESERVED</span>		<span class="o">=</span> <span class="mh">0xfffffff0</span><span class="p">,</span>
	<span class="n">INT_WATCHDOG</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* watchdog timer */</span>
	<span class="n">INT_Q_OVERFLOW</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* cmd msg q overflow */</span>
	<span class="n">INT_Q_AVAILABLE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* cmd msg q has free space */</span>
	<span class="n">INT_RESPONSE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* response msg available */</span>
	<span class="n">INT_ACK_MASK</span>		<span class="o">=</span> <span class="n">INT_WATCHDOG</span> <span class="o">|</span> <span class="n">INT_Q_OVERFLOW</span><span class="p">,</span>
	<span class="n">INT_DEF_MASK</span>		<span class="o">=</span> <span class="n">INT_RESERVED</span> <span class="o">|</span> <span class="n">INT_Q_OVERFLOW</span> <span class="o">|</span>
				  <span class="n">INT_RESPONSE</span><span class="p">,</span>

	<span class="cm">/* command messages, and related register bits */</span>
	<span class="n">CARM_HAVE_RESP</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">CARM_MSG_READ</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CARM_MSG_WRITE</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CARM_MSG_VERIFY</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CARM_MSG_GET_CAPACITY</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">CARM_MSG_FLUSH</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">CARM_MSG_IOCTL</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">CARM_MSG_ARRAY</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">CARM_MSG_MISC</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">CARM_CME</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">CARM_RME</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">CARM_WZBC</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CARM_RMI</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CARM_Q_FULL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">CARM_MSG_SIZE</span>		<span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
	<span class="n">CARM_Q_LEN</span>		<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>

	<span class="cm">/* CARM_MSG_IOCTL messages */</span>
	<span class="n">CARM_IOC_SCAN_CHAN</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* scan channels for devices */</span>
	<span class="n">CARM_IOC_GET_TCQ</span>	<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>	<span class="cm">/* get tcq/ncq depth */</span>
	<span class="n">CARM_IOC_SET_TCQ</span>	<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>	<span class="cm">/* set tcq/ncq depth */</span>

	<span class="n">IOC_SCAN_CHAN_NODEV</span>	<span class="o">=</span> <span class="mh">0x1f</span><span class="p">,</span>
	<span class="n">IOC_SCAN_CHAN_OFFSET</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>

	<span class="cm">/* CARM_MSG_ARRAY messages */</span>
	<span class="n">CARM_ARRAY_INFO</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="n">ARRAY_NO_EXIST</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">),</span>

	<span class="cm">/* response messages */</span>
	<span class="n">RMSG_SZ</span>			<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/* sizeof(struct carm_response) */</span>
	<span class="n">RMSG_Q_LEN</span>		<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>	<span class="cm">/* resp. msg list length */</span>
	<span class="n">RMSG_OK</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* bit indicating msg was successful */</span>
					<span class="cm">/* length of entire resp. msg buffer */</span>
	<span class="n">RBUF_LEN</span>		<span class="o">=</span> <span class="n">RMSG_SZ</span> <span class="o">*</span> <span class="n">RMSG_Q_LEN</span><span class="p">,</span>

	<span class="n">PDC_SHM_SIZE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span> <span class="cm">/* length of entire h/w buffer */</span>

	<span class="cm">/* CARM_MSG_MISC messages */</span>
	<span class="n">MISC_GET_FW_VER</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MISC_ALLOC_MEM</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">MISC_SET_TIME</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>

	<span class="cm">/* MISC_GET_FW_VER feature bits */</span>
	<span class="n">FW_VER_4PORT</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* 1=4 ports, 0=8 ports */</span>
	<span class="n">FW_VER_NON_RAID</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* 1=non-RAID firmware, 0=RAID */</span>
	<span class="n">FW_VER_ZCR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* zero channel RAID (whatever that is) */</span>

	<span class="cm">/* carm_host flags */</span>
	<span class="n">FL_NON_RAID</span>		<span class="o">=</span> <span class="n">FW_VER_NON_RAID</span><span class="p">,</span>
	<span class="n">FL_4PORT</span>		<span class="o">=</span> <span class="n">FW_VER_4PORT</span><span class="p">,</span>
	<span class="n">FL_FW_VER_MASK</span>		<span class="o">=</span> <span class="p">(</span><span class="n">FW_VER_NON_RAID</span> <span class="o">|</span> <span class="n">FW_VER_4PORT</span><span class="p">),</span>
	<span class="n">FL_DAC</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
	<span class="n">FL_DYN_MAJOR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CARM_SG_BOUNDARY</span>	<span class="o">=</span> <span class="mh">0xffffUL</span><span class="p">,</span>	    <span class="cm">/* s/g segment boundary */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">scatter_gather_types</span> <span class="p">{</span>
	<span class="n">SGT_32BIT</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SGT_64BIT</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">host_states</span> <span class="p">{</span>
	<span class="n">HST_INVALID</span><span class="p">,</span>		<span class="cm">/* invalid state; never used */</span>
	<span class="n">HST_ALLOC_BUF</span><span class="p">,</span>		<span class="cm">/* setting up master SHM area */</span>
	<span class="n">HST_ERROR</span><span class="p">,</span>		<span class="cm">/* we never leave here */</span>
	<span class="n">HST_PORT_SCAN</span><span class="p">,</span>		<span class="cm">/* start dev scan */</span>
	<span class="n">HST_DEV_SCAN_START</span><span class="p">,</span>	<span class="cm">/* start per-device probe */</span>
	<span class="n">HST_DEV_SCAN</span><span class="p">,</span>		<span class="cm">/* continue per-device probe */</span>
	<span class="n">HST_DEV_ACTIVATE</span><span class="p">,</span>	<span class="cm">/* activate devices we found */</span>
	<span class="n">HST_PROBE_FINISHED</span><span class="p">,</span>	<span class="cm">/* probe is complete */</span>
	<span class="n">HST_PROBE_START</span><span class="p">,</span>	<span class="cm">/* initiate probe */</span>
	<span class="n">HST_SYNC_TIME</span><span class="p">,</span>		<span class="cm">/* tell firmware what time it is */</span>
	<span class="n">HST_GET_FW_VER</span><span class="p">,</span>		<span class="cm">/* get firmware version, adapter port cnt */</span>
<span class="p">};</span>

<span class="cp">#ifdef CARM_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;HST_INVALID&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_ALLOC_BUF&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_ERROR&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_PORT_SCAN&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_DEV_SCAN_START&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_DEV_SCAN&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_DEV_ACTIVATE&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_PROBE_FINISHED&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_PROBE_START&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_SYNC_TIME&quot;</span><span class="p">,</span>
	<span class="s">&quot;HST_GET_FW_VER&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">carm_port</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">port_no</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span>			<span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_host</span>		<span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="cm">/* attached device characteristics */</span>
	<span class="n">u64</span>				<span class="n">capacity</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="n">name</span><span class="p">[</span><span class="mi">41</span><span class="p">];</span>
	<span class="n">u16</span>				<span class="n">dev_geom_head</span><span class="p">;</span>
	<span class="n">u16</span>				<span class="n">dev_geom_sect</span><span class="p">;</span>
	<span class="n">u16</span>				<span class="n">dev_geom_cyl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">carm_request</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">n_elem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">msg_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">msg_subtype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">msg_bucket</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span>			<span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_port</span>		<span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>		<span class="n">sg</span><span class="p">[</span><span class="n">CARM_MAX_REQ_SG</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">carm_host</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">shm</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">shm_dma</span><span class="p">;</span>

	<span class="kt">int</span>				<span class="n">major</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>			<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">fw_ver</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">request_queue</span>		<span class="o">*</span><span class="n">oob_q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">n_oob</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">hw_sg_used</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">resp_idx</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">wait_q_prod</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">wait_q_cons</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span>		<span class="o">*</span><span class="n">wait_q</span><span class="p">[</span><span class="n">CARM_MAX_WAIT_Q</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">n_msgs</span><span class="p">;</span>
	<span class="n">u64</span>				<span class="n">msg_alloc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_request</span>		<span class="n">req</span><span class="p">[</span><span class="n">CARM_MAX_REQ</span><span class="p">];</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">msg_base</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">msg_dma</span><span class="p">;</span>

	<span class="kt">int</span>				<span class="n">cur_scan_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">dev_active</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">dev_present</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_port</span>		<span class="n">port</span><span class="p">[</span><span class="n">CARM_MAX_PORTS</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">work_struct</span>		<span class="n">fsm_task</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">completion</span>		<span class="n">probe_comp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">carm_response</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">ret_handle</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_msg_sg</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_msg_rw</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sg_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sg_type</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">lba</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">lba_count</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">lba_high</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_msg_sg</span> <span class="n">sg</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_msg_allocbuf</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subtype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n_sg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sg_type</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">evt_pool</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">n_evt</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rbuf_pool</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">n_rbuf</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">msg_pool</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">n_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_msg_sg</span> <span class="n">sg</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_msg_ioctl</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subtype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">array_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">data_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_msg_sync_time</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subtype</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">timestamp</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_msg_get_fw_ver</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subtype</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">data_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_fw_ver</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">carm_array_info</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">size_hi</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">stripe_size</span><span class="p">;</span>

	<span class="n">__le32</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">stripe_blk_sz</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reserved1</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">cyl</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">head</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">sect</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">array_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved2</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

	<span class="n">__le32</span> <span class="n">array_status</span><span class="p">;</span>

	<span class="cm">/* device list continues beyond this point? */</span>
<span class="p">}</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">carm_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">carm_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">carm_bdev_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">carm_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_PROMISE</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_PROMISE</span><span class="p">,</span> <span class="mh">0x8002</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">carm_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">carm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">carm_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">carm_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">carm_remove_one</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">carm_bd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span>		<span class="o">=</span> <span class="n">carm_bdev_getgeo</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">carm_host_id</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">carm_major_alloc</span><span class="p">;</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_bdev_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_geom_head</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_geom_sect</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_geom_cyl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">msg_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">CARM_MSG_SIZE</span> <span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">carm_lookup_bucket</span><span class="p">(</span><span class="n">u32</span> <span class="n">msg_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msg_sizes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_size</span> <span class="o">&lt;=</span> <span class="n">msg_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_init_buckets</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msg_sizes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">msg_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_CMS0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">carm_ref_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msg_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">msg_idx</span> <span class="o">*</span> <span class="n">CARM_MSG_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">dma_addr_t</span> <span class="nf">carm_ref_msg_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msg_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">msg_idx</span> <span class="o">*</span> <span class="n">CARM_MSG_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_send_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">carm_ref_msg_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cm_bucket</span> <span class="o">=</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_bucket</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMUC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CARM_Q_FULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		tmp = readl(mmio + CARM_INT_MASK);</span>
<span class="c">		tmp |= INT_Q_AVAILABLE;</span>
<span class="c">		writel(tmp, mmio + CARM_INT_MASK);</span>
<span class="c">		readl(mmio + CARM_INT_MASK);	/* flush */</span>
<span class="cp">#endif</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;host msg queue full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">msg</span> <span class="o">|</span> <span class="p">(</span><span class="n">cm_bucket</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_IHQP</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_IHQP</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="nf">carm_get_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* obey global hardware limit on S/G entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hw_sg_used</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">CARM_MAX_HOST_SG</span> <span class="o">-</span> <span class="n">CARM_MAX_REQ_SG</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_alloc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">crq</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">crq</span><span class="o">-&gt;</span><span class="n">n_elem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_alloc</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_msgs</span><span class="o">++</span><span class="p">;</span>

			<span class="n">assert</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">n_msgs</span> <span class="o">&lt;=</span> <span class="n">CARM_MAX_REQ</span><span class="p">);</span>
			<span class="n">sg_init_table</span><span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">CARM_MAX_REQ_SG</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">crq</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no request available, returning NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_put_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">&lt;</span> <span class="n">max_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_alloc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* tried to clear a tag that was not active */</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hw_sg_used</span> <span class="o">&gt;=</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_alloc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">hw_sg_used</span> <span class="o">-=</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_msgs</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="nf">carm_get_special</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tries</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">crq</span> <span class="o">=</span> <span class="n">carm_get_request</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">crq</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">oob_q</span><span class="p">,</span> <span class="n">WRITE</span> <span class="cm">/* bogus */</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">carm_put_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">crq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_array_info</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">array_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_msg_ioctl</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_data</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">msg_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">crq</span> <span class="o">=</span> <span class="n">carm_get_special</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">carm_ref_msg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">msg_dma</span> <span class="o">=</span> <span class="n">carm_ref_msg_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">msg_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">msg_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_array_info</span><span class="p">));</span>

	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">CARM_MSG_ARRAY</span><span class="p">;</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_subtype</span> <span class="o">=</span> <span class="n">CARM_ARRAY_INFO</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_lookup_bucket</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_ioctl</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_array_info</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_bucket</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">CARM_MSG_ARRAY</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">subtype</span>	<span class="o">=</span> <span class="n">CARM_ARRAY_INFO</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">array_id</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">array_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TAG_ENCODE</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data_addr</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg_data</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HST_DEV_SCAN_START</span> <span class="o">||</span>
	       <span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HST_DEV_SCAN</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;blk_execute_rq_nowait, tag == %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_SPECIAL</span><span class="p">;</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">special</span> <span class="o">=</span> <span class="n">crq</span><span class="p">;</span>
	<span class="n">blk_execute_rq_nowait</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">oob_q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">carm_sspc_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_send_special</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">carm_sspc_t</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_msg_ioctl</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">crq</span> <span class="o">=</span> <span class="n">carm_get_special</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">carm_ref_msg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">msg_size</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_subtype</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_lookup_bucket</span><span class="p">(</span><span class="n">msg_size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_bucket</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;blk_execute_rq_nowait, tag == %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_SPECIAL</span><span class="p">;</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">special</span> <span class="o">=</span> <span class="n">crq</span><span class="p">;</span>
	<span class="n">blk_execute_rq_nowait</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">oob_q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">carm_fill_sync_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_msg_sync_time</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">st</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">CARM_MSG_MISC</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">subtype</span>	<span class="o">=</span> <span class="n">MISC_SET_TIME</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TAG_ENCODE</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">timestamp</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_sync_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">carm_fill_alloc_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_msg_allocbuf</span> <span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">));</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">CARM_MSG_MISC</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">subtype</span>	<span class="o">=</span> <span class="n">MISC_ALLOC_MEM</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TAG_ENCODE</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">n_sg</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">sg_type</span>	<span class="o">=</span> <span class="n">SGT_32BIT</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">addr</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">PDC_SHM_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">len</span>		<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">PDC_SHM_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">evt_pool</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">n_evt</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">rbuf_pool</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span><span class="p">);</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">n_rbuf</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RMSG_Q_LEN</span><span class="p">);</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">msg_pool</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span> <span class="o">+</span> <span class="n">RBUF_LEN</span><span class="p">);</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">n_msg</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CARM_Q_LEN</span><span class="p">);</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">PDC_SHM_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">65536</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_allocbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">carm_fill_scan_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_msg_ioctl</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">carm_ref_msg_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span>
			      <span class="n">IOC_SCAN_CHAN_OFFSET</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">CARM_MSG_IOCTL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">subtype</span>	<span class="o">=</span> <span class="n">CARM_IOC_SCAN_CHAN</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TAG_ENCODE</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data_addr</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg_data</span><span class="p">);</span>

	<span class="cm">/* fill output data area with &quot;no device&quot; default values */</span>
	<span class="n">mem</span> <span class="o">+=</span> <span class="n">IOC_SCAN_CHAN_OFFSET</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">IOC_SCAN_CHAN_NODEV</span><span class="p">,</span> <span class="n">CARM_MAX_PORTS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IOC_SCAN_CHAN_OFFSET</span> <span class="o">+</span> <span class="n">CARM_MAX_PORTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">carm_fill_get_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_msg_get_fw_ver</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">carm_ref_msg_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">CARM_MSG_MISC</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">subtype</span>	<span class="o">=</span> <span class="n">MISC_GET_FW_VER</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TAG_ENCODE</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">data_addr</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_get_fw_ver</span><span class="p">)</span> <span class="o">+</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_fw_ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">carm_end_request_queued</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_put_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">carm_push_q</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_prod</span> <span class="o">%</span> <span class="n">CARM_MAX_WAIT_Q</span><span class="p">;</span>

	<span class="n">blk_stop_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;STOPPED QUEUE %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_prod</span><span class="o">++</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_prod</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_cons</span><span class="p">);</span> <span class="cm">/* overrun */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="nf">carm_pop_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_prod</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_cons</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_cons</span> <span class="o">%</span> <span class="n">CARM_MAX_WAIT_Q</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q_cons</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">carm_round_robin</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">carm_pop_q</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blk_start_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;STARTED QUEUE %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">carm_end_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">carm_end_request_queued</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_queue</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">carm_round_robin</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">n_msgs</span> <span class="o">&lt;=</span> <span class="n">CARM_MSG_LOW_WATER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hw_sg_used</span> <span class="o">&lt;=</span> <span class="n">CARM_SG_LOW_WATER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">carm_round_robin</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_oob_rq_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;get req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">crq</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">;</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">crq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">==</span> <span class="n">rq</span><span class="p">);</span>

		<span class="n">crq</span><span class="o">-&gt;</span><span class="n">n_elem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;send req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_send_msg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blk_requeue_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
			<span class="n">carm_push_q</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>		<span class="cm">/* call us again later, eventually */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_rq_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_msg_rw</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pci_dir</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n_elem</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msg_size</span><span class="p">;</span>

<span class="nl">queue_one_request:</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;get req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_peek_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">crq</span> <span class="o">=</span> <span class="n">carm_get_request</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">carm_push_q</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* call us again later, eventually */</span>
	<span class="p">}</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="n">rq</span><span class="p">;</span>

	<span class="n">blk_start_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get scatterlist from block layer */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">n_elem</span> <span class="o">=</span> <span class="n">blk_rq_map_sg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_elem</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">carm_end_rq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* request with no s/g entries? */</span>
	<span class="p">}</span>

	<span class="cm">/* map scatterlist to PCI bus addresses */</span>
	<span class="n">n_elem</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">n_elem</span><span class="p">,</span> <span class="n">pci_dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_elem</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">carm_end_rq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* request with no s/g entries? */</span>
	<span class="p">}</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">n_elem</span> <span class="o">=</span> <span class="n">n_elem</span><span class="p">;</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">hw_sg_used</span> <span class="o">+=</span> <span class="n">n_elem</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build read/write message</span>
<span class="cm">	 */</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;build msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_rw</span> <span class="o">*</span><span class="p">)</span> <span class="n">carm_ref_msg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">writing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CARM_MSG_WRITE</span><span class="p">;</span>
		<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">CARM_MSG_WRITE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CARM_MSG_READ</span><span class="p">;</span>
		<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">CARM_MSG_READ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">id</span>		<span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">sg_count</span>	<span class="o">=</span> <span class="n">n_elem</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">sg_type</span>	<span class="o">=</span> <span class="n">SGT_32BIT</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TAG_ENCODE</span><span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">));</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">lba</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">tmp</span>		<span class="o">=</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">lba_high</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">tmp</span> <span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">lba_count</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">rq</span><span class="p">));</span>

	<span class="n">msg_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_rw</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_elem</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">carm_msg_sg</span> <span class="o">*</span><span class="n">carm_sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">carm_sg</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">carm_sg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">msg_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_sg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_lookup_bucket</span><span class="p">(</span><span class="n">msg_size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_bucket</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue read/write message to hardware</span>
<span class="cm">	 */</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;send msg, tag == %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_send_msg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">carm_put_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">);</span>
		<span class="n">blk_requeue_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="n">carm_push_q</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* call us again later, eventually */</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">queue_one_request</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_handle_array_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">msg_data</span> <span class="o">=</span> <span class="n">mem</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_array_info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">carm_array_info</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_array_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg_data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_port</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">slen</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">carm_end_rq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">array_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ARRAY_NO_EXIST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cur_port</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_scan_dev</span><span class="p">;</span>

	<span class="cm">/* should never occur */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cur_port</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cur_port</span> <span class="o">&gt;=</span> <span class="n">CARM_MAX_PORTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;BUG: cur_scan_dev==%d, array_id==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cur_port</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">array_id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">cur_port</span><span class="p">];</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size_hi</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">|</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_geom_head</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_geom_sect</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_geom_cyl</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev_active</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cur_port</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">slen</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">slen</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): port %u device %Lu sectors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): port %u device </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HST_DEV_SCAN</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fsm_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_handle_scan_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">msg_data</span> <span class="o">=</span> <span class="n">mem</span> <span class="o">+</span> <span class="n">IOC_SCAN_CHAN_OFFSET</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_DEV_SCAN_START</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">carm_end_rq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: scan and support non-disk devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* direct-access device (disk) */</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev_present</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">dev_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): found %u interesting devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">dev_count</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HST_PORT_SCAN</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fsm_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_handle_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">cur_state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">next_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">carm_end_rq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">cur_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fsm_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">carm_handle_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pci_dir</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">pci_dir</span><span class="p">);</span>

	<span class="n">carm_end_rq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">carm_handle_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				    <span class="n">__le32</span> <span class="n">ret_handle_le</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ret_handle_le</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msg_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_request</span> <span class="o">*</span><span class="n">crq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">RMSG_OK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER, handle == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">TAG_VALID</span><span class="p">(</span><span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): BUG: invalid tag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg_idx</span> <span class="o">=</span> <span class="n">TAG_DECODE</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;tag == %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">);</span>

	<span class="n">crq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">msg_idx</span><span class="p">];</span>

	<span class="cm">/* fast path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">==</span> <span class="n">CARM_MSG_READ</span> <span class="o">||</span>
		   <span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">==</span> <span class="n">CARM_MSG_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">carm_handle_rw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">carm_ref_msg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARM_MSG_IOCTL</span>: <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_subtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CARM_IOC_SCAN_CHAN</span>:
			<span class="n">carm_handle_scan_chan</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* unknown / invalid response */</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CARM_MSG_MISC</span>: <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_subtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MISC_ALLOC_MEM</span>:
			<span class="n">carm_handle_generic</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span>
					    <span class="n">HST_ALLOC_BUF</span><span class="p">,</span> <span class="n">HST_SYNC_TIME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MISC_SET_TIME</span>:
			<span class="n">carm_handle_generic</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span>
					    <span class="n">HST_SYNC_TIME</span><span class="p">,</span> <span class="n">HST_GET_FW_VER</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MISC_GET_FW_VER</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">carm_fw_ver</span> <span class="o">*</span><span class="n">ver</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_fw_ver</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">mem</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_msg_get_fw_ver</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ver</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">FL_FW_VER_MASK</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">carm_handle_generic</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span>
					    <span class="n">HST_GET_FW_VER</span><span class="p">,</span> <span class="n">HST_PORT_SCAN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="cm">/* unknown / invalid response */</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CARM_MSG_ARRAY</span>: <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_subtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CARM_ARRAY_INFO</span>:
			<span class="n">carm_handle_array_info</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* unknown / invalid response */</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="cm">/* unknown / invalid response */</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): BUG: unhandled message type %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">,</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">msg_subtype</span><span class="p">);</span>
	<span class="n">carm_end_rq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">crq</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">carm_handle_responses</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_response</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">resp_idx</span> <span class="o">%</span> <span class="n">RMSG_Q_LEN</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ending response on index %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_RESP_IDX</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* response to a message we sent */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;handling msg response on index %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">carm_handle_resp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ret_handle</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">resp</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* asynchronous events the hardware throws our way */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">evt_type_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="n">u8</span> <span class="n">evt_type</span> <span class="o">=</span> <span class="o">*</span><span class="n">evt_type_ptr</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): unhandled event type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">evt_type</span><span class="p">);</span>
			<span class="n">resp</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">NEXT_RESP</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">work</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, work==%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">resp_idx</span> <span class="o">+=</span> <span class="n">work</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">carm_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">__host</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;no host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mmio</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>

	<span class="cm">/* reading should also clear interrupts */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_INT_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mask</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;no work, mask == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_ACK_MASK</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_INT_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HST_INVALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;not initialized yet, mask = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CARM_HAVE_RESP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">carm_handle_responses</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_fsm_task</span> <span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">carm_host</span><span class="p">,</span> <span class="n">fsm_task</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">next_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reschedule</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_INVALID</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER, state == %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state_name</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HST_PROBE_START</span>:
		<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_ALLOC_BUF</span><span class="p">;</span>
		<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_ALLOC_BUF</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_send_special</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">carm_fill_alloc_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
			<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_SYNC_TIME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_send_special</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">carm_fill_sync_time</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
			<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_GET_FW_VER</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_send_special</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">carm_fill_get_fw_ver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
			<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_PORT_SCAN</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_send_special</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">carm_fill_scan_channels</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
			<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_DEV_SCAN_START</span>:
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_scan_dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_DEV_SCAN</span><span class="p">;</span>
		<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_DEV_SCAN</span>:
		<span class="n">next_dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_scan_dev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CARM_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev_present</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">next_dev</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next_dev</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_scan_dev</span> <span class="o">=</span> <span class="n">next_dev</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_array_info</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">next_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_ERROR</span><span class="p">;</span>
				<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_DEV_ACTIVATE</span><span class="p">;</span>
			<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_DEV_ACTIVATE</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">activated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CARM_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev_active</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">carm_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">;</span>

				<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">);</span>
				<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
				<span class="n">activated</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): %d ports activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">activated</span><span class="p">);</span>

		<span class="n">new_state</span> <span class="o">=</span> <span class="n">HST_PROBE_FINISHED</span><span class="p">;</span>
		<span class="n">reschedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">HST_PROBE_FINISHED</span>:
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">probe_comp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HST_ERROR</span>:
		<span class="cm">/* FIXME: TODO */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* should never occur */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;BUG: unknown state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">HST_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reschedule</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fsm_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_init_wait</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">test_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_LMUC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">==</span> <span class="n">bits</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;carm_init_wait timeout, bits == 0x%x, test_bit == %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bits</span><span class="p">,</span> <span class="n">test_bit</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_init_responses</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carm_response</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carm_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RMSG_Q_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_RESP_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_init_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_INT_MASK</span><span class="p">);</span>

	<span class="n">tmp8</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_INITC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp8</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">tmp8</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_INITC</span><span class="p">);</span>
		<span class="n">readb</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_INITC</span><span class="p">);</span>	<span class="cm">/* flush */</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;snooze...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMUC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CARM_CME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CME bit present, waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_init_wait</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">CARM_CME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, carm_init_wait 1 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CARM_RME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;RME bit present, waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_init_wait</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">CARM_RME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, carm_init_wait 2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CARM_RME</span> <span class="o">|</span> <span class="n">CARM_CME</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMUC</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMUC</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_init_wait</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">CARM_RME</span> <span class="o">|</span> <span class="n">CARM_CME</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, carm_init_wait 3 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">carm_init_buckets</span><span class="p">(</span><span class="n">mmio</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">RBUF_ADDR_LO</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">RBUF_ADDR_HI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RBUF_LEN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">RBUF_BYTE_SZ</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMUC</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CARM_RME</span> <span class="o">|</span> <span class="n">CARM_CME</span> <span class="o">|</span> <span class="n">CARM_WZBC</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMUC</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMUC</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_init_wait</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">CARM_RME</span> <span class="o">|</span> <span class="n">CARM_CME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, carm_init_wait 4 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_HMPHA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">INT_DEF_MASK</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CARM_INT_MASK</span><span class="p">);</span>

	<span class="n">carm_init_responses</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* start initialization, probing state machine */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HST_INVALID</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HST_PROBE_START</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fsm_task</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_init_disks</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CARM_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">carm_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

		<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="n">CARM_MINORS_PER_MAJOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;/%u&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">*</span> <span class="n">CARM_MAX_PORTS</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">CARM_MINORS_PER_MAJOR</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">carm_bd_ops</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

		<span class="n">q</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">carm_rq_fn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
		<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">CARM_MAX_REQ_SG</span><span class="p">);</span>
		<span class="n">blk_queue_segment_boundary</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">CARM_SG_BOUNDARY</span><span class="p">);</span>

		<span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_free_disks</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CARM_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">disk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENHD_FL_UP</span><span class="p">)</span>
				<span class="n">del_gendisk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span>
				<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_init_shm</span><span class="p">(</span><span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">CARM_SHM_SIZE</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_base</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span> <span class="o">+</span> <span class="n">RBUF_LEN</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_dma</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span> <span class="o">+</span> <span class="n">RBUF_LEN</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">RBUF_LEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">msg_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PDC_SHM_SIZE</span> <span class="o">-</span> <span class="n">RBUF_LEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carm_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_dac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot; version &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

<span class="cp">#ifdef IF_64BIT_DMA_IS_POSSIBLE </span><span class="cm">/* grrrr... */</span><span class="cp"></span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): consistent DMA mask failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">err_out_regions</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): DMA mask failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">err_out_regions</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef IF_64BIT_DMA_IS_POSSIBLE </span><span class="cm">/* grrrr... */</span><span class="cp"></span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">host</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): memory alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">pci_dac</span> <span class="o">?</span> <span class="n">FL_DAC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fsm_task</span><span class="p">,</span> <span class="n">carm_fsm_task</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">probe_comp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): MMIO alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_init_shm</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): DMA SHM alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">carm_oob_rq_fn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): OOB queue alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_pci_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">oob_q</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Figure out which major to use: 160, 161, or dynamic</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">carm_major_alloc</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="mi">160</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">carm_major_alloc</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="mi">161</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FL_DYN_MAJOR</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">carm_host_id</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">carm_host_id</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_majors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FL_DYN_MAJOR</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_init_disks</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_blkdev_disks</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">carm_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;(%s): irq alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out_blkdev_disks</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">carm_init_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_irq</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;waiting for probe_comp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">probe_comp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: pci %s, ports %d, io %llx, irq %u, major %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">host</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">CARM_MAX_PORTS</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>

	<span class="n">carm_host_id</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
<span class="nl">err_out_blkdev_disks:</span>
	<span class="n">carm_free_disks</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="nl">err_out_free_majors:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">160</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">carm_major_alloc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">161</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">carm_major_alloc</span><span class="p">);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">oob_q</span><span class="p">);</span>
<span class="nl">err_out_pci_free:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">CARM_SHM_SIZE</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span><span class="p">);</span>
<span class="nl">err_out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
<span class="nl">err_out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">err_out_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carm_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carm_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;BUG: no host data for PCI(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="n">carm_free_disks</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">160</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">carm_major_alloc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">161</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">carm_major_alloc</span><span class="p">);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">oob_q</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">CARM_SHM_SIZE</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">shm_dma</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">carm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carm_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">carm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carm_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">carm_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">carm_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
