f | common.h | s | 9.4K | 267 | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1338412804 |  | xen/blkback: Copy id field when doing BLKIF_DISCARD.  We weren't copying the id field so when we sent the response back to the frontend (especially with a 64-bit host and 32-bit guest), we ended up using a random value. This lead to the frontend crashing as it would try to pass to __blk_end_request_all a NULL 'struct request' (b/c it would use the 'id' to find the proper 'struct request' in its shadow array) and end up crashing:  BUG: unable to handle kernel NULL pointer dereference at 000000e4 IP: [<c0646d4c>] __blk_end_request_all+0xc/0x40 .. snip.. EIP is at __blk_end_request_all+0xc/0x40 .. snip..  [<ed95db72>] blkif_interrupt+0x172/0x330 [xen_blkfront]  This fixes the bug by passing in the proper id for the response.  Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=824641  CC: stable@kernel.org Tested-by: William Dauchy <wdauchy@gmail.com> Acked-by: Stefano Stabellini <stefano.stabellini@eu.citrix.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | xenbus.c | s | 18K | 655 | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1334778848 |  | xen/blkback: Fix warning error.  drivers/block/xen-blkback/xenbus.c: In function 'xen_blkbk_discard': drivers/block/xen-blkback/xenbus.c:419:4: warning: passing argument 1 of 'dev_warn' makes pointer from integer without a cast +[enabled by default] include/linux/device.h:894:5: note: expected 'const struct device *' but argument is of type 'long int'  It is unclear how that mistake made it in. It surely is wrong.  Acked-by: Jens Axboe <axboe@kernel.dk> Reported-by: Stephen Rothwell <sfr@canb.auug.org.au> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | blkback.c | s | 23K | 753 | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1332597875 |  | xen/blkback: Squash the discard support for 'file' and 'phy' type.  The only reason for the distinction was for the special case of 'file' (which is assumed to be loopback device), was to reach inside the loopback device, find the underlaying file, and call fallocate on it. Fortunately "xen-blkback: convert hole punching to discard request on loop devices" removes that use-case and we now based the discard support based on blk_queue_discard(q) and extract all appropriate parameters from the 'struct request_queue'.  CC: Li Dongyang <lidongyang@novell.com> Acked-by: Jan Beulich <JBeulich@suse.com> [v1: Dropping pointless initializer and keeping blank line] [v2: Remove the kfree as it is not used anymore] Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | Makefile | g | 87B |  | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1303315079 |  | xen/blkback: Squash vbd.c,interface.c in blkback.c and xenbus.c respectivly.  Daniel Stodden suggested to eliminate vbd.c and interface.c, inlining the critical bits where they belong, respectively.  Leaving only blkback.c for the data- and xenbus.c for the control path.  Suggested-by:  Daniel Stodden <daniel.stodden@citrix.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
