<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › drbd › drbd_receiver.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drbd_receiver.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   drbd_receiver.c</span>

<span class="cm">   This file is part of DRBD by Philipp Reisner and Lars Ellenberg.</span>

<span class="cm">   Copyright (C) 2001-2008, LINBIT Information Technologies GmbH.</span>
<span class="cm">   Copyright (C) 1999-2008, Philipp Reisner &lt;philipp.reisner@linbit.com&gt;.</span>
<span class="cm">   Copyright (C) 2002-2008, Lars Ellenberg &lt;lars.ellenberg@linbit.com&gt;.</span>

<span class="cm">   drbd is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm">   any later version.</span>

<span class="cm">   drbd is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with drbd; see the file COPYING.  If not, write to</span>
<span class="cm">   the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cp">#include &lt;linux/drbd.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/memcontrol.h&gt;</span>
<span class="cp">#include &lt;linux/mm_inline.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pkt_sched.h&gt;</span>
<span class="cp">#define __KERNEL_SYSCALLS__</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &quot;drbd_int.h&quot;</span>
<span class="cp">#include &quot;drbd_req.h&quot;</span>

<span class="cp">#include &quot;drbd_vli.h&quot;</span>

<span class="k">enum</span> <span class="n">finish_epoch</span> <span class="p">{</span>
	<span class="n">FE_STILL_LIVE</span><span class="p">,</span>
	<span class="n">FE_DESTROYED</span><span class="p">,</span>
	<span class="n">FE_RECYCLED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">drbd_do_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">drbd_do_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">finish_epoch</span> <span class="n">drbd_may_finish_epoch</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">epoch_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e_end_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>


<span class="cp">#define GFP_TRY	(__GFP_HIGHMEM | __GFP_NOWARN)</span>

<span class="cm">/*</span>
<span class="cm"> * some helper functions to deal with single linked page lists,</span>
<span class="cm"> * page-&gt;private being our &quot;next&quot; pointer.</span>
<span class="cm"> */</span>

<span class="cm">/* If at least n pages are linked at head, get n pages off.</span>
<span class="cm"> * Otherwise, don&#39;t modify head, and return NULL.</span>
<span class="cm"> * Locking is the responsibility of the caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">page_chain_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">);</span>

	<span class="n">page</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">page_chain_next</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* found sufficient pages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="cm">/* insufficient pages, don&#39;t use any of them. */</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add end of list marker for the returned list */</span>
	<span class="n">set_page_private</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* actual return value, and adjustment of head */</span>
	<span class="n">page</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* may be used outside of locks to find the tail of a (usually short)</span>
<span class="cm"> * &quot;private&quot; page chain, before adding it back to a global chain head</span>
<span class="cm"> * with page_chain_add() under a spinlock. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">page_chain_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">page_chain_next</span><span class="p">(</span><span class="n">page</span><span class="p">)))</span>
		<span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">page_chain_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">page_chain_for_each_safe</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">page_chain_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">chain_first</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">chain_last</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 1</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">page_chain_tail</span><span class="p">(</span><span class="n">chain_first</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">chain_last</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* add chain to head */</span>
	<span class="n">set_page_private</span><span class="p">(</span><span class="n">chain_last</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">head</span><span class="p">);</span>
	<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">chain_first</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">drbd_pp_first_pages_or_try_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Yes, testing drbd_pp_vacant outside the lock is racy.</span>
<span class="cm">	 * So what. It saves a spin_lock. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_pp_vacant</span> <span class="o">&gt;=</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">page_chain_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_pool</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
			<span class="n">drbd_pp_vacant</span> <span class="o">-=</span> <span class="n">number</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* GFP_TRY, because we must not cause arbitrary write-out: in a DRBD</span>
<span class="cm">	 * &quot;criss-cross&quot; setup, that might cause write-out on some other DRBD,</span>
<span class="cm">	 * which in turn might block on the other node at this very place.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_TRY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">set_page_private</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">number</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">page</span><span class="p">;</span>

	<span class="cm">/* Not enough pages immediately available this time.</span>
<span class="cm">	 * No need to jump around here, drbd_pp_alloc will retry this</span>
<span class="cm">	 * function &quot;soon&quot;. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">page_chain_tail</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>
		<span class="n">page_chain_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_pool</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">drbd_pp_vacant</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reclaim_net_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">to_be_freed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">le</span><span class="p">,</span> <span class="o">*</span><span class="n">tle</span><span class="p">;</span>

	<span class="cm">/* The EEs are always appended to the end of the list. Since</span>
<span class="cm">	   they are sent in order over the wire, they have to finish</span>
<span class="cm">	   in order. As soon as we see the first not finished we can</span>
<span class="cm">	   stop to examine the list... */</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_ee</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_ee_has_active_page</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">list_move</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">to_be_freed</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_kick_lo_and_reclaim_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">reclaimed</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">reclaim_net_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclaimed</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclaimed</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">)</span>
		<span class="n">drbd_free_net_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_pp_alloc() - Returns @number pages, retries forever (or until signalled)</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @number:	number of pages requested</span>
<span class="cm"> * @retry:	whether to retry, if not enough pages are available right now</span>
<span class="cm"> *</span>
<span class="cm"> * Tries to allocate number pages, first from our own page pool, then from</span>
<span class="cm"> * the kernel, unless this allocation would exceed the max_buffers setting.</span>
<span class="cm"> * Possibly retry until DRBD frees sufficient pages somewhere else.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a page chain linked via page-&gt;private.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">drbd_pp_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">number</span><span class="p">,</span> <span class="n">bool</span> <span class="n">retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* Yes, we may run up to @number over max_buffers. If we</span>
<span class="cm">	 * follow it strictly, the admin will get it wrong anyways. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">max_buffers</span><span class="p">)</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">drbd_pp_first_pages_or_try_alloc</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="n">drbd_kick_lo_and_reclaim_net</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">max_buffers</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">drbd_pp_first_pages_or_try_alloc</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_pp_alloc interrupted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must not be used from irq, as that may deadlock: see drbd_pp_alloc.</span>
<span class="cm"> * Is also used from inside an other spin_lock_irq(&amp;mdev-&gt;req_lock);</span>
<span class="cm"> * Either links the page chain back to the global pool,</span>
<span class="cm"> * or returns all pages to the system. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_pp_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">is_net</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use_by_net</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_pp_vacant</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">DRBD_MAX_BIO_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">)</span><span class="o">*</span><span class="n">minor_count</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">page_chain_free</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">page_chain_tail</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>
		<span class="n">page_chain_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_pool</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">drbd_pp_vacant</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_sub_return</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERTION FAILED: %s: %d &lt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">is_net</span> <span class="o">?</span> <span class="s">&quot;pp_in_use_by_net&quot;</span> <span class="o">:</span> <span class="s">&quot;pp_in_use&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">You need to hold the req_lock:</span>
<span class="cm"> _drbd_wait_ee_list_empty()</span>

<span class="cm">You must not have the req_lock:</span>
<span class="cm"> drbd_free_ee()</span>
<span class="cm"> drbd_alloc_ee()</span>
<span class="cm"> drbd_init_ee()</span>
<span class="cm"> drbd_release_ee()</span>
<span class="cm"> drbd_ee_fix_bhs()</span>
<span class="cm"> drbd_process_done_ee()</span>
<span class="cm"> drbd_clear_done_ee()</span>
<span class="cm"> drbd_wait_ee_list_empty()</span>
<span class="cm">*/</span>

<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="nf">drbd_alloc_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="n">id</span><span class="p">,</span>
				     <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">,</span>
				     <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nr_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_insert_fault</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">DRBD_FAULT_AL_EE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">drbd_ee_mempool</span><span class="p">,</span> <span class="n">gfp_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__GFP_HIGHMEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gfp_mask</span> <span class="o">&amp;</span> <span class="n">__GFP_NOWARN</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;alloc_ee: Allocation of an EE failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">drbd_pp_alloc</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="p">(</span><span class="n">gfp_mask</span> <span class="o">&amp;</span> <span class="n">__GFP_WAIT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">INIT_HLIST_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">epoch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">drbd_ee_mempool</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_free_some_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_HAS_DIGEST</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">);</span>
	<span class="n">drbd_pp_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">is_net</span><span class="p">);</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">));</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">drbd_ee_mempool</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_release_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">work_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_net</span> <span class="o">=</span> <span class="n">list</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_ee</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_free_some_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">is_net</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This function is called from _asender only_</span>
<span class="cm"> * but see also comments in _req_mod(,barrier_acked)</span>
<span class="cm"> * and receive_Barrier.</span>
<span class="cm"> *</span>
<span class="cm"> * Move entries from net_ee to done_ee, if ready.</span>
<span class="cm"> * Grab done_ee, call all callbacks, free the entries.</span>
<span class="cm"> * The callbacks typically send out ACKs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_process_done_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">reclaimed</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">reclaim_net_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclaimed</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclaimed</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">)</span>
		<span class="n">drbd_free_net_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="cm">/* possible callbacks here:</span>
<span class="cm">	 * e_end_block, and e_end_resync_block, e_send_discard_ack.</span>
<span class="cm">	 * all ignore the last argument.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* list_del not necessary, next/prev members not touched */</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">;</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_drbd_wait_ee_list_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* avoids spin_lock/unlock</span>
<span class="cm">	 * and calling prepare_to_wait in the fast path */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="n">io_schedule</span><span class="p">();</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_wait_ee_list_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">_drbd_wait_ee_list_empty</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* see also kernel_accept; which is only present since 2.6.18.</span>
<span class="cm"> * also we want to log which part of it failed, exactly */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">what</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">newsock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">what</span> <span class="o">=</span> <span class="s">&quot;listen&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="o">*</span><span class="n">what</span> <span class="o">=</span> <span class="s">&quot;sock_create_lite&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_create_lite</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_family</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">,</span>
			       <span class="n">newsock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="o">*</span><span class="n">what</span> <span class="o">=</span> <span class="s">&quot;accept&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="n">newsock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="o">*</span><span class="n">newsock</span><span class="p">);</span>
		<span class="o">*</span><span class="n">newsock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">newsock</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span>  <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">__module_get</span><span class="p">((</span><span class="o">*</span><span class="n">newsock</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_recv_short</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">?</span> <span class="n">flags</span> <span class="o">:</span> <span class="n">MSG_WAITALL</span> <span class="o">|</span> <span class="n">MSG_NOSIGNAL</span><span class="p">)</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">sock_recvmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_WAITALL</span> <span class="o">|</span> <span class="n">MSG_NOSIGNAL</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">sock_recvmsg</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Note:</span>
<span class="cm">		 * ECONNRESET	other side closed the connection</span>
<span class="cm">		 * ERESTARTSYS	(on  sock) we got a signal</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;sock was reset by peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;sock_recvmsg returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;sock was shut down by peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
			<span class="cm">/* signal came in, or peer/link went down,</span>
<span class="cm">			 * after we read a partial message</span>
<span class="cm">			 */</span>
			<span class="cm">/* D_ASSERT(signal_pending(current)); */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_BROKEN_PIPE</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* quoting tcp(7):</span>
<span class="cm"> *   On individual connections, the socket buffer size must be set prior to the</span>
<span class="cm"> *   listen(2) or connect(2) calls in order to have it take effect.</span>
<span class="cm"> * This is our wrapper to do so.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_setbufsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rcv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* open coded SO_SNDBUF, SO_RCVBUF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">=</span> <span class="n">snd</span><span class="p">;</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_userlocks</span> <span class="o">|=</span> <span class="n">SOCK_SNDBUF_LOCK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span> <span class="o">=</span> <span class="n">rcv</span><span class="p">;</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_userlocks</span> <span class="o">|=</span> <span class="n">SOCK_RCVBUF_LOCK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="nf">drbd_try_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="n">src_in6</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disconnect_on_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;sock_create_kern&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_create_kern</span><span class="p">(((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">,</span>
		<span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">=</span>  <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">try_connect_int</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">drbd_setbufsize</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">sndbuf_size</span><span class="p">,</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">);</span>

       <span class="cm">/* explicitly bind to the configured IP as source IP</span>
<span class="cm">	*  for the outgoing connections.</span>
<span class="cm">	*  This is needed for multihomed hosts and to be</span>
<span class="cm">	*  able to use lo: interfaces for drbd.</span>
<span class="cm">	* Make sure to use 0 as port number, so linux selects</span>
<span class="cm">	*  a free one dynamically.</span>
<span class="cm">	*/</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_in6</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr</span><span class="p">,</span>
	       <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">src_in6</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">src_in6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src_in6</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* AF_INET &amp; AF_SCI */</span>

	<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;bind before connect&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
			      <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">src_in6</span><span class="p">,</span>
			      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* connect may fail, peer not yet available.</span>
<span class="cm">	 * stay C_WF_CONNECTION, don&#39;t go Disconnecting! */</span>
	<span class="n">disconnect_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;connect&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
				 <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">,</span>
				 <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
			<span class="n">sock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* timeout, busy, signal pending */</span>
		<span class="k">case</span> <span class="n">ETIMEDOUT</span>: <span class="k">case</span> <span class="n">EAGAIN</span>: <span class="k">case</span> <span class="n">EINPROGRESS</span>:
		<span class="k">case</span> <span class="n">EINTR</span>: <span class="k">case</span> <span class="n">ERESTARTSYS</span>:
			<span class="cm">/* peer not (yet) available, network problem */</span>
		<span class="k">case</span> <span class="n">ECONNREFUSED</span>: <span class="k">case</span> <span class="n">ENETUNREACH</span>:
		<span class="k">case</span> <span class="n">EHOSTDOWN</span>:    <span class="k">case</span> <span class="n">EHOSTUNREACH</span>:
			<span class="n">disconnect_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s failed, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disconnect_on_error</span><span class="p">)</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="nf">drbd_wait_for_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeo</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">s_estab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">s_listen</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;sock_create_kern&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_create_kern</span><span class="p">(((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">,</span>
		<span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s_listen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s_listen</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeo</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">try_connect_int</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">timeo</span> <span class="o">+=</span> <span class="p">(</span><span class="n">random32</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">timeo</span> <span class="o">/</span> <span class="mi">7</span> <span class="o">:</span> <span class="o">-</span><span class="n">timeo</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* 28.5% random jitter */</span>

	<span class="n">s_listen</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_reuse</span>    <span class="o">=</span> <span class="n">SK_CAN_REUSE</span><span class="p">;</span> <span class="cm">/* SO_REUSEADDR */</span>
	<span class="n">s_listen</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span> <span class="n">timeo</span><span class="p">;</span>
	<span class="n">s_listen</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">=</span> <span class="n">timeo</span><span class="p">;</span>
	<span class="n">drbd_setbufsize</span><span class="p">(</span><span class="n">s_listen</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">sndbuf_size</span><span class="p">,</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">);</span>

	<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;bind before listen&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">s_listen</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">(</span><span class="n">s_listen</span><span class="p">,</span>
			      <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr</span><span class="p">,</span>
			      <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_accept</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">,</span> <span class="n">s_listen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s_estab</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s_listen</span><span class="p">)</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">s_listen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINTR</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s failed, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">s_estab</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_send_fp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sbuf</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">h80</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="nf">drbd_recv_fp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">h80</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rr</span><span class="p">;</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_recv_short</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_socket_okay() - Free the socket if its connection is not okay</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @sock:	pointer to the pointer to the socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_socket_okay</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_recv_short</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">MSG_DONTWAIT</span> <span class="o">|</span> <span class="n">MSG_PEEK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rr</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="o">*</span><span class="n">sock</span><span class="p">);</span>
		<span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return values:</span>
<span class="cm"> *   1 yes, we have a valid connection</span>
<span class="cm"> *   0 oops, did not work out, please try again</span>
<span class="cm"> *  -1 peer talks different language,</span>
<span class="cm"> *     no point in trying again, please go standalone.</span>
<span class="cm"> *  -2 We do not have a network config...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="n">msock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">try</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_WF_CONNECTION</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">sock</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">msock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;)</span> <span class="p">{</span>
			<span class="cm">/* 3 tries, this should take less than a second! */</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">drbd_try_connect</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">||</span> <span class="o">++</span><span class="n">try</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* give the other side time to call bind() &amp; listen() */</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drbd_send_fp</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">P_HAND_SHAKE_S</span><span class="p">);</span>
				<span class="n">sock</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
				<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drbd_send_fp</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">P_HAND_SHAKE_M</span><span class="p">);</span>
				<span class="n">msock</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
				<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Logic error in drbd_connect()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_release_sockets</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">msock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_timeo</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_socket_okay</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_socket_okay</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">retry:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">drbd_wait_for_connect</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">try</span> <span class="o">=</span> <span class="n">drbd_recv_fp</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">drbd_socket_okay</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
			<span class="n">drbd_socket_okay</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msock</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">try</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">P_HAND_SHAKE_S</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;initial packet S crossed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">sock</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">P_HAND_SHAKE_M</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">msock</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;initial packet M crossed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">sock_release</span><span class="p">(</span><span class="n">msock</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">msock</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Error receiving initial packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">sock_release</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">random32</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_DISCONNECTING</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_release_sockets</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">smp_rmb</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_t_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">)</span> <span class="o">==</span> <span class="n">Exiting</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_release_sockets</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">msock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_socket_okay</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_socket_okay</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">msock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_reuse</span> <span class="o">=</span> <span class="n">SK_CAN_REUSE</span><span class="p">;</span> <span class="cm">/* SO_REUSEADDR */</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_reuse</span> <span class="o">=</span> <span class="n">SK_CAN_REUSE</span><span class="p">;</span> <span class="cm">/* SO_REUSEADDR */</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span> <span class="o">=</span> <span class="n">GFP_NOIO</span><span class="p">;</span>
	<span class="n">msock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span> <span class="o">=</span> <span class="n">GFP_NOIO</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_priority</span> <span class="o">=</span> <span class="n">TC_PRIO_INTERACTIVE_BULK</span><span class="p">;</span>
	<span class="n">msock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_priority</span> <span class="o">=</span> <span class="n">TC_PRIO_INTERACTIVE</span><span class="p">;</span>

	<span class="cm">/* NOT YET ...</span>
<span class="cm">	 * sock-&gt;sk-&gt;sk_sndtimeo = mdev-&gt;net_conf-&gt;timeout*HZ/10;</span>
<span class="cm">	 * sock-&gt;sk-&gt;sk_rcvtimeo = MAX_SCHEDULE_TIMEOUT;</span>
<span class="cm">	 * first set it to the P_HAND_SHAKE timeout,</span>
<span class="cm">	 * which we set to 4x the configured ping_timeout. */</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">=</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_timeo</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>

	<span class="n">msock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="n">msock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_int</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t want delays.</span>
<span class="cm">	 * we use TCP_CORK where appropriate, though */</span>
	<span class="n">drbd_tcp_nodelay</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="n">drbd_tcp_nodelay</span><span class="p">(</span><span class="n">msock</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">msock</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_received</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">drbd_do_handshake</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">h</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* drbd_request_state(mdev, NS(conn, WFAuth)); */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">drbd_do_auth</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Authentication of peer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Authentication of peer failed, trying again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">packet_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_send_protocol</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STATE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">drbd_send_sync_param</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">);</span>
	<span class="n">drbd_send_sizes</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_send_current_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">USE_DEGR_WFC_T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RESIZE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">_NS</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drbd_thread_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">request_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span> <span class="cm">/* just start it here. */</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out_release_sockets:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msock</span><span class="p">)</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">msock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_recv_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">p_header</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short read expecting header on sock: r=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h80</span><span class="p">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h80</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="o">*</span><span class="n">packet_size</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h80</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h95</span><span class="p">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">BE_DRBD_MAGIC_BIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h95</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="o">*</span><span class="n">packet_size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h95</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;magic?? on data m: 0x%08x c: %d l: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h80</span><span class="p">.</span><span class="n">magic</span><span class="p">),</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h80</span><span class="p">.</span><span class="n">command</span><span class="p">),</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">h80</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_received</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span> <span class="o">&gt;=</span> <span class="n">WO_bdev_flush</span> <span class="o">&amp;&amp;</span> <span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">blkdev_issue_flush</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;local disk flush failed with status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="cm">/* would rather check on EOPNOTSUPP, but that is not reliable.</span>
<span class="cm">			 * don&#39;t try again for ANY return value != 0</span>
<span class="cm">			 * if (rv == -EOPNOTSUPP) */</span>
			<span class="n">drbd_bump_write_ordering</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">WO_drain_io</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_may_finish_epoch() - Applies an epoch_event to the epoch&#39;s state, eventually finishes it.</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @epoch:	Epoch object.</span>
<span class="cm"> * @ev:		Epoch event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">finish_epoch</span> <span class="nf">drbd_may_finish_epoch</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">drbd_epoch</span> <span class="o">*</span><span class="n">epoch</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">epoch_event</span> <span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">epoch_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_epoch</span> <span class="o">*</span><span class="n">next_epoch</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">finish_epoch</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">FE_STILL_LIVE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">next_epoch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">epoch_size</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EV_CLEANUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EV_PUT</span>:
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EV_GOT_BARRIER_NR</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DE_HAVE_BARRIER_NUMBER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EV_BECAME_LAST</span>:
			<span class="cm">/* nothing to do*/</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">epoch_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DE_HAVE_BARRIER_NUMBER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span> <span class="n">ev</span> <span class="o">&amp;</span> <span class="n">EV_CLEANUP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">EV_CLEANUP</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>
				<span class="n">drbd_send_b_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">epoch</span><span class="o">-&gt;</span><span class="n">barrier_nr</span><span class="p">,</span> <span class="n">epoch_size</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DE_HAVE_BARRIER_NUMBER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span> <span class="o">!=</span> <span class="n">epoch</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">next_epoch</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">ev</span> <span class="o">=</span> <span class="n">EV_BECAME_LAST</span> <span class="o">|</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">EV_CLEANUP</span><span class="p">);</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epochs</span><span class="o">--</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">epoch</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">FE_STILL_LIVE</span><span class="p">)</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="n">FE_DESTROYED</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">epoch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="cm">/* atomic_set(&amp;epoch-&gt;active, 0); is already zero */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">FE_STILL_LIVE</span><span class="p">)</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="n">FE_RECYCLED</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_epoch</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">epoch</span> <span class="o">=</span> <span class="n">next_epoch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_bump_write_ordering() - Fall back to an other write ordering method</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @wo:		Write ordering method to try.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_bump_write_ordering</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">write_ordering_e</span> <span class="n">wo</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">write_ordering_e</span> <span class="n">pwo</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">write_ordering_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">WO_none</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">WO_drain_io</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;drain&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">WO_bdev_flush</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;flush&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">pwo</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span><span class="p">;</span>
	<span class="n">wo</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pwo</span><span class="p">,</span> <span class="n">wo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wo</span> <span class="o">==</span> <span class="n">WO_bdev_flush</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">no_disk_flush</span><span class="p">)</span>
		<span class="n">wo</span> <span class="o">=</span> <span class="n">WO_drain_io</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wo</span> <span class="o">==</span> <span class="n">WO_drain_io</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">no_disk_drain</span><span class="p">)</span>
		<span class="n">wo</span> <span class="o">=</span> <span class="n">WO_none</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span> <span class="o">=</span> <span class="n">wo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pwo</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span> <span class="o">||</span> <span class="n">wo</span> <span class="o">==</span> <span class="n">WO_bdev_flush</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Method to ensure write ordering: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">write_ordering_str</span><span class="p">[</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_submit_ee()</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @e:		epoch entry</span>
<span class="cm"> * @rw:		flag field, see bio-&gt;bi_rw</span>
<span class="cm"> *</span>
<span class="cm"> * May spread the pages to multiple bios,</span>
<span class="cm"> * depending on bio_add_page restrictions.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if all bios have been submitted,</span>
<span class="cm"> * -ENOMEM if we could not allocate enough bios,</span>
<span class="cm"> * -ENOSPC (any better suggestion?) if we have not been able to bio_add_page a</span>
<span class="cm"> *  single page to an empty bio (which should never happen and likely indicates</span>
<span class="cm"> *  that the lower level IO stack is in some way broken). This has been observed</span>
<span class="cm"> *  on certain Xen deployments.</span>
<span class="cm"> */</span>
<span class="cm">/* TODO allocate from our own bio_set. */</span>
<span class="kt">int</span> <span class="nf">drbd_submit_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">rw</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">fault_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">n_bios</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nr_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* In most cases, we will only need one bio.  But in case the lower</span>
<span class="cm">	 * level restrictions happen to be different at this offset on this</span>
<span class="cm">	 * side than those of the sending peer, we may need to submit the</span>
<span class="cm">	 * request in more than one bio.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Plain bio_alloc is good enough here, this is no DRBD internally</span>
<span class="cm">	 * generated bio, but a bio allocated on behalf of the peer.</span>
<span class="cm">	 */</span>
<span class="nl">next_bio:</span>
	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;submit_ee: Allocation of a bio failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* &gt; e-&gt;sector, unless this is the first bio */</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">rw</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">drbd_endio_sec</span><span class="p">;</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">bios</span><span class="p">;</span>
	<span class="n">bios</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="o">++</span><span class="n">n_bios</span><span class="p">;</span>

	<span class="n">page_chain_for_each</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* A single page must always be possible!</span>
<span class="cm">			 * But in case it fails anyways,</span>
<span class="cm">			 * we deal with it, and complain (below). */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
					<span class="s">&quot;bio_add_page failed for len=%u, &quot;</span>
					<span class="s">&quot;bi_vcnt=0 (bi_sector=%llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">next_bio</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ds</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sector</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="o">--</span><span class="n">nr_pages</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">ds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">,</span> <span class="n">n_bios</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bios</span><span class="p">;</span>
		<span class="n">bios</span> <span class="o">=</span> <span class="n">bios</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">drbd_generic_make_request</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">fault_type</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bios</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bios</span><span class="p">;</span>
		<span class="n">bios</span> <span class="o">=</span> <span class="n">bios</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_Barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_barrier</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">barrier</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_epoch</span> <span class="o">*</span><span class="n">epoch</span><span class="p">;</span>

	<span class="n">inc_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">barrier_nr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_may_finish_epoch</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="p">,</span> <span class="n">EV_GOT_BARRIER_NR</span><span class="p">);</span>

	<span class="cm">/* P_BARRIER_ACK may imply that the corresponding extent is dropped from</span>
<span class="cm">	 * the activity log, which means it would not be resynced in case the</span>
<span class="cm">	 * R_PRIMARY crashes now.</span>
<span class="cm">	 * Therefore we must send the barrier_ack after the barrier request was</span>
<span class="cm">	 * completed. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WO_none</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">FE_RECYCLED</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/* receiver context, in the writeout path of the other node.</span>
<span class="cm">		 * avoid potential distributed deadlock */</span>
		<span class="n">epoch</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Allocation of an epoch failed, slowing down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Fall through */</span>

	<span class="k">case</span> <span class="n">WO_bdev_flush</span>:
	<span class="k">case</span> <span class="n">WO_drain_io</span>:
		<span class="n">drbd_wait_ee_list_empty</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">);</span>
		<span class="n">drbd_flush</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">epoch</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">epoch</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="p">;</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Strangeness in mdev-&gt;write_ordering %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">epoch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epochs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The current_epoch got recycled while we allocated this one... */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">epoch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* used from receive_RSDataReply (recv_resync_read)</span>
<span class="cm"> * and from receive_Data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span>
<span class="nf">read_in_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">id</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">sector_t</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dgs</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">rr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dig_in</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_in</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dig_vv</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_vv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">dgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">dig_in</span><span class="p">,</span> <span class="n">dgs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
					<span class="s">&quot;short read receiving data digest: read %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rr</span><span class="p">,</span> <span class="n">dgs</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">data_size</span> <span class="o">-=</span> <span class="n">dgs</span><span class="p">;</span>

	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">data_size</span> <span class="o">&amp;</span>  <span class="mh">0x1ff</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span>  <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* even though we trust out peer,</span>
<span class="cm">	 * we sometimes have to double check. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">data_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;request from peer beyond end of local disk: &quot;</span>
			<span class="s">&quot;capacity: %llus &lt; sector: %llus + size: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">capacity</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* GFP_NOIO, because we must not cause arbitrary write-out: in a DRBD</span>
<span class="cm">	 * &quot;criss-cross&quot; setup, that might cause write-out on some other DRBD,</span>
<span class="cm">	 * which in turn might block on the other node at this very place.  */</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">drbd_alloc_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ds</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>
	<span class="n">page_chain_for_each</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_insert_fault</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">DRBD_FAULT_RECEIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Fault injection: Corrupting data on receive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short read receiving data: read %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ds</span> <span class="o">-=</span> <span class="n">rr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_csum_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">dig_vv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dig_in</span><span class="p">,</span> <span class="n">dig_vv</span><span class="p">,</span> <span class="n">dgs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Digest integrity check FAILED: %llus +%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
			<span class="n">drbd_bcast_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;digest failed&quot;</span><span class="p">,</span>
					<span class="n">dgs</span><span class="p">,</span> <span class="n">dig_in</span><span class="p">,</span> <span class="n">dig_vv</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">+=</span> <span class="n">data_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* drbd_drain_block() just takes a data block</span>
<span class="cm"> * out of the socket input buffer, and discards it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_drain_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rr</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">drbd_pp_alloc</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
					<span class="s">&quot;short read receiving data: read %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rr</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data_size</span> <span class="o">-=</span> <span class="n">rr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">drbd_pp_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">recv_dless_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			   <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dgs</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">expect</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dig_in</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_in</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dig_vv</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_vv</span><span class="p">;</span>

	<span class="n">dgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">dig_in</span><span class="p">,</span> <span class="n">dgs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
					<span class="s">&quot;short read receiving data reply digest: read %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rr</span><span class="p">,</span> <span class="n">dgs</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">data_size</span> <span class="o">-=</span> <span class="n">dgs</span><span class="p">;</span>

	<span class="cm">/* optimistically update recv_cnt.  if receiving fails below,</span>
<span class="cm">	 * we disconnect anyways, and counters will be reset. */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">+=</span> <span class="n">data_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">sector</span> <span class="o">==</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>

	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">expect</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span>
			     <span class="n">kmap</span><span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span><span class="o">+</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span>
			     <span class="n">expect</span><span class="p">);</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short read receiving data reply: &quot;</span>
					<span class="s">&quot;read %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rr</span><span class="p">,</span> <span class="n">expect</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data_size</span> <span class="o">-=</span> <span class="n">rr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_csum_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">dig_vv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dig_in</span><span class="p">,</span> <span class="n">dig_vv</span><span class="p">,</span> <span class="n">dgs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Digest integrity check FAILED. Broken NICs?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* e_end_resync_block() is called via</span>
<span class="cm"> * drbd_process_done_ee() by asender only */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e_end_resync_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_set_in_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_RS_WRITE_ACK</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Record failure to sync */</span>
		<span class="n">drbd_rs_failed_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

		<span class="n">ok</span>  <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_ACK</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">recv_resync_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span> <span class="n">__releases</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">read_in_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ID_SYNCER</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">inc_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="cm">/* corresponding dec_unacked() in e_end_resync_block()</span>
<span class="cm">	 * respective _drbd_clear_done_ee */</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">e_end_resync_block</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_ev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_submit_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">,</span> <span class="n">DRBD_FAULT_RS_WR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* don&#39;t care for the reason here */</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;submit failed, triggering re-connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_DataReply</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">_ar_id_to_req</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Got a corrupt block_id/sector pair(1).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hlist_del(&amp;req-&gt;collision) is done in _req_may_be_done, to avoid</span>
<span class="cm">	 * special casing it there for the various failure cases.</span>
<span class="cm">	 * still no race with drbd_fail_pending_reads */</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">recv_dless_read</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
		<span class="n">req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">data_received</span><span class="p">);</span>
	<span class="cm">/* else: nothing. handled from drbd_disconnect...</span>
<span class="cm">	 * I don&#39;t think we may complete this just yet</span>
<span class="cm">	 * in case we are &quot;on-disconnect: freeze&quot; */</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_RSDataReply</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span> <span class="o">==</span> <span class="n">ID_SYNCER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* data is submitted to disk within recv_resync_read.</span>
<span class="cm">		 * corresponding put_ldev done below on error,</span>
<span class="cm">		 * or in drbd_endio_write_sec. */</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">recv_resync_read</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Can not write resync data to local disk.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_drain_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

		<span class="n">drbd_send_ack_dp</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_ACK</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_in</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* e_end_block() is called via drbd_process_done_ee().</span>
<span class="cm"> * this means this function only runs in the asender thread</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e_end_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pcmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_PAUSED_SYNC_T</span> <span class="o">&amp;&amp;</span>
				<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_MAY_SET_IN_SYNC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">P_RS_WRITE_ACK</span> <span class="o">:</span> <span class="n">P_WRITE_ACK</span><span class="p">;</span>
			<span class="n">ok</span> <span class="o">&amp;=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">pcmd</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcmd</span> <span class="o">==</span> <span class="n">P_RS_WRITE_ACK</span><span class="p">)</span>
				<span class="n">drbd_set_in_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ok</span>  <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_ACK</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="cm">/* we expect it to be marked out of sync anyways...</span>
<span class="cm">			 * maybe assert this?  */</span>
		<span class="p">}</span>
		<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* we delete from the conflict detection hash _after_ we sent out the</span>
<span class="cm">	 * P_WRITE_ACK / P_NEG_ACK, to get the sequence number right.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">));</span>
		<span class="n">hlist_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">drbd_may_finish_epoch</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="p">,</span> <span class="n">EV_PUT</span> <span class="o">+</span> <span class="p">(</span><span class="n">cancel</span> <span class="o">?</span> <span class="n">EV_CLEANUP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e_send_discard_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_C</span><span class="p">);</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_DISCARD_ACK</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">));</span>
	<span class="n">hlist_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">overlapping_resync_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">data_e</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">rs_e</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rs_e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">overlaps</span><span class="p">(</span><span class="n">data_e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">data_e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">rs_e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">rs_e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called from receive_Data.</span>
<span class="cm"> * Synchronize packets on sock with packets on msock.</span>
<span class="cm"> *</span>
<span class="cm"> * This is here so even when a P_DATA packet traveling via sock overtook an Ack</span>
<span class="cm"> * packet traveling on msock, they are still processed in the order they have</span>
<span class="cm"> * been sent.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: we don&#39;t care for Ack packets overtaking P_DATA packets.</span>
<span class="cm"> *</span>
<span class="cm"> * In case packet_seq is larger than mdev-&gt;peer_seq number, there are</span>
<span class="cm"> * outstanding packets on the msock. We wait for them to arrive.</span>
<span class="cm"> * In case we are the logically next packet, we update mdev-&gt;peer_seq</span>
<span class="cm"> * ourselves. Correctly handles 32bit wrap around.</span>
<span class="cm"> *</span>
<span class="cm"> * Assume we have a 10 GBit connection, that is about 1&lt;&lt;30 byte per second,</span>
<span class="cm"> * about 1&lt;&lt;21 sectors per second. So &quot;worst&quot; case, we have 1&lt;&lt;3 == 8 seconds</span>
<span class="cm"> * for the 24bit wrap (historical atomic_t guarantee on some archs), and we have</span>
<span class="cm"> * 1&lt;&lt;9 == 512 seconds aka ages for the 32bit wrap around...</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if we may process the packet,</span>
<span class="cm"> * -ERESTARTSYS if we were interrupted (by disconnect signal). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_wait_peer_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">packet_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p_seq</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">seq_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq_le</span><span class="p">(</span><span class="n">packet_seq</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p_seq</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p_seq</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERT FAILED waited 30 seconds for sequence update, forcing reconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">seq_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">packet_seq</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* see also bio_flags_to_wire()</span>
<span class="cm"> * DRBD_REQ_*, because we need to semantically map the flags to data packet</span>
<span class="cm"> * flags and back. We may replicate to other kernel versions. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">wire_flags_to_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>  <span class="p">(</span><span class="n">dpf</span> <span class="o">&amp;</span> <span class="n">DP_RW_SYNC</span> <span class="o">?</span> <span class="n">REQ_SYNC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dpf</span> <span class="o">&amp;</span> <span class="n">DP_FUA</span> <span class="o">?</span> <span class="n">REQ_FUA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dpf</span> <span class="o">&amp;</span> <span class="n">DP_FLUSH</span> <span class="o">?</span> <span class="n">REQ_FLUSH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dpf</span> <span class="o">&amp;</span> <span class="n">DP_DISCARD</span> <span class="o">?</span> <span class="n">REQ_DISCARD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* mirrored write */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_Data</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dp_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">))</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>

		<span class="n">drbd_send_ack_dp</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_ACK</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">drbd_drain_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* get_ldev(mdev) successful.</span>
<span class="cm">	 * Corresponding put_ldev done either below (on various errors),</span>
<span class="cm">	 * or in drbd_endio_write_sec, if we successfully submit the data at</span>
<span class="cm">	 * the end of this function. */</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">read_in_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">e_end_block</span><span class="p">;</span>

	<span class="n">dp_flags</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dp_flags</span><span class="p">);</span>
	<span class="n">rw</span> <span class="o">|=</span> <span class="n">wire_flags_to_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">dp_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dp_flags</span> <span class="o">&amp;</span> <span class="n">DP_MAY_SET_IN_SYNC</span><span class="p">)</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EE_MAY_SET_IN_SYNC</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>

	<span class="cm">/* I&#39;m the receiver, I do hold a net_cnt reference. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t get the req_lock yet,</span>
<span class="cm">		 * we may sleep in drbd_wait_peer_seq */</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">discard</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">first</span><span class="p">;</span>

		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_C</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* conflict detection and handling:</span>
<span class="cm">		 * 1. wait on the sequence number,</span>
<span class="cm">		 *    in case this data packet overtook ACK packets.</span>
<span class="cm">		 * 2. check our hash tables for conflicting requests.</span>
<span class="cm">		 *    we only need to walk the tl_hash, since an ee can not</span>
<span class="cm">		 *    have a conflict with an other ee: on the submitting</span>
<span class="cm">		 *    node, the corresponding req had already been conflicting,</span>
<span class="cm">		 *    and a conflicting req is never sent.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note: for two_primaries, we are protocol C,</span>
<span class="cm">		 * so there cannot be any request that is DONE</span>
<span class="cm">		 * but still on the transfer log.</span>
<span class="cm">		 *</span>
<span class="cm">		 * unconditionally add to the ee_hash.</span>
<span class="cm">		 *</span>
<span class="cm">		 * if no conflicting request is found:</span>
<span class="cm">		 *    submit.</span>
<span class="cm">		 *</span>
<span class="cm">		 * if any conflicting request is found</span>
<span class="cm">		 * that has not yet been acked,</span>
<span class="cm">		 * AND I have the &quot;discard concurrent writes&quot; flag:</span>
<span class="cm">		 *	 queue (via done_ee) the P_DISCARD_ACK; OUT.</span>
<span class="cm">		 *</span>
<span class="cm">		 * if any conflicting request is found:</span>
<span class="cm">		 *	 block the receiver, waiting on misc_wait</span>
<span class="cm">		 *	 until no more conflicting requests are there,</span>
<span class="cm">		 *	 or we get interrupted (disconnect).</span>
<span class="cm">		 *</span>
<span class="cm">		 *	 we do not just write after local io completion of those</span>
<span class="cm">		 *	 requests, but only after req is done completely, i.e.</span>
<span class="cm">		 *	 we wait for the P_DISCARD_ACK to arrive!</span>
<span class="cm">		 *</span>
<span class="cm">		 *	 then proceed normally, i.e. submit.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_wait_peer_seq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out_interrupted</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

		<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">,</span> <span class="n">ee_hash_slot</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">));</span>

<span class="cp">#define OVERLAPS overlaps(i-&gt;sector, i-&gt;size, sector, size)</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">tl_hash_slot</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">have_unacked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">have_conflict</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">collision</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">OVERLAPS</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* only ALERT on first iteration,</span>
<span class="cm">					 * we may be woken up early... */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
						<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s[%u] Concurrent local write detected!&quot;</span>
						      <span class="s">&quot;	new: %llus +%u; pending: %llus +%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						      <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
						      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">rq_state</span> <span class="o">&amp;</span> <span class="n">RQ_NET_PENDING</span><span class="p">)</span>
						<span class="o">++</span><span class="n">have_unacked</span><span class="p">;</span>
					<span class="o">++</span><span class="n">have_conflict</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#undef OVERLAPS</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_conflict</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Discard Ack only for the _first_ iteration */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="n">discard</span> <span class="o">&amp;&amp;</span> <span class="n">have_unacked</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Concurrent write! [DISCARD BY FLAG] sec=%llus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
				<span class="n">inc_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">e_send_discard_ack</span><span class="p">;</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">);</span>

				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

				<span class="cm">/* we could probably send that P_DISCARD_ACK ourselves,</span>
<span class="cm">				 * but I don&#39;t like the receiver using the msock */</span>

				<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="n">wake_asender</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hlist_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">);</span>

				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

				<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_interrupted</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Concurrent write! [W AFTERWARDS] &quot;</span>
				     <span class="s">&quot;sec=%llus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* we had none on the first iteration.</span>
<span class="cm">				 * there must be none now. */</span>
				<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">have_unacked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span><span class="p">)</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">overlapping_resync_write</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRBD_PROT_C</span>:
		<span class="n">inc_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="cm">/* corresponding dec_unacked() in e_end_block()</span>
<span class="cm">		 * respective _drbd_clear_done_ee */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRBD_PROT_B</span>:
		<span class="cm">/* I really don&#39;t like it that the receiver thread</span>
<span class="cm">		 * sends on the msock, but anyways */</span>
		<span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_RECV_ACK</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRBD_PROT_A</span>:
		<span class="cm">/* nothing to do */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In case we have the only disk of the cluster, */</span>
		<span class="n">drbd_set_out_of_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EE_CALL_AL_COMPLETE_IO</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EE_MAY_SET_IN_SYNC</span><span class="p">;</span>
		<span class="n">drbd_al_begin_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_submit_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">DRBD_FAULT_DT_WR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* don&#39;t care for the reason here */</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;submit failed, triggering re-connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">hlist_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collision</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_CALL_AL_COMPLETE_IO</span><span class="p">)</span>
		<span class="n">drbd_al_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

<span class="nl">out_interrupted:</span>
	<span class="n">drbd_may_finish_epoch</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">epoch</span><span class="p">,</span> <span class="n">EV_PUT</span> <span class="o">+</span> <span class="n">EV_CLEANUP</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We may throttle resync, if the lower device seems to be busy,</span>
<span class="cm"> * and current sync rate is above c_min_rate.</span>
<span class="cm"> *</span>
<span class="cm"> * To decide whether or not the lower device is busy, we use a scheme similar</span>
<span class="cm"> * to MD RAID is_mddev_idle(): if the partition stats reveal &quot;significant&quot;</span>
<span class="cm"> * (more than 64 sectors) of activity we cannot account for with our own resync</span>
<span class="cm"> * activity, it obviously is &quot;busy&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * The current sync rate used here uses only the most recent two step marks,</span>
<span class="cm"> * to have a short time average so we can react faster.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_rs_should_slow_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">db</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dbdt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">throttle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* feature disabled? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_min_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">lc_find</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">BM_SECT_TO_EXT</span><span class="p">(</span><span class="n">sector</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="n">bm_ext</span> <span class="o">=</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_PRIORITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Do not slow down if app IO is already waiting for this extent */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

	<span class="n">curr_events</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">part_stat_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
		      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">part_stat_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_ev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_events</span> <span class="o">||</span> <span class="n">curr_events</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_events</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rs_left</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_events</span> <span class="o">=</span> <span class="n">curr_events</span><span class="p">;</span>

		<span class="cm">/* sync speed average over the last 2*DRBD_SYNC_MARK_STEP,</span>
<span class="cm">		 * approx. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_mark</span> <span class="o">+</span> <span class="n">DRBD_SYNC_MARKS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DRBD_SYNC_MARKS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span>
			<span class="n">rs_left</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs_left</span> <span class="o">=</span> <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">;</span>

		<span class="n">dt</span> <span class="o">=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">jiffies</span> <span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt</span><span class="p">)</span>
			<span class="n">dt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs_left</span><span class="p">;</span>
		<span class="n">dbdt</span> <span class="o">=</span> <span class="n">Bit2KB</span><span class="p">(</span><span class="n">db</span><span class="o">/</span><span class="n">dt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dbdt</span> <span class="o">&gt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_min_rate</span><span class="p">)</span>
			<span class="n">throttle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">throttle</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_DataRequest</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">digest_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">sector_t</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">digest_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">verb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fault_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_block_req</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span>	<span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">block_req</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">size</span>   <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s:%d: sector: %llus, size: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s:%d: sector: %llus, size: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_UP_TO_DATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">verb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">P_DATA_REQUEST</span>:
			<span class="n">drbd_send_ack_rp</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_DREPLY</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_RS_DATA_REQUEST</span>:
		<span class="k">case</span> <span class="n">P_CSUM_RS_REQUEST</span>:
		<span class="k">case</span> <span class="n">P_OV_REQUEST</span>:
			<span class="n">drbd_send_ack_rp</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_RS_DREPLY</span> <span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_OV_REPLY</span>:
			<span class="n">verb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">drbd_send_ack_ex</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_OV_RESULT</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ID_IN_SYNC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected command (%s) in receive_DataRequest</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verb</span> <span class="o">&amp;&amp;</span> <span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Can not satisfy peer&#39;s read request, &quot;</span>
			    <span class="s">&quot;no local data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* drain possibly payload */</span>
		<span class="k">return</span> <span class="n">drbd_drain_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* GFP_NOIO, because we must not cause arbitrary write-out: in a DRBD</span>
<span class="cm">	 * &quot;criss-cross&quot; setup, that might cause write-out on some other DRBD,</span>
<span class="cm">	 * which in turn might block on the other node at this very place.  */</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">drbd_alloc_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P_DATA_REQUEST</span>:
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_e_end_data_req</span><span class="p">;</span>
		<span class="n">fault_type</span> <span class="o">=</span> <span class="n">DRBD_FAULT_DT_RD</span><span class="p">;</span>
		<span class="cm">/* application IO, don&#39;t drbd_rs_begin_io */</span>
		<span class="k">goto</span> <span class="n">submit</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">P_RS_DATA_REQUEST</span>:
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_e_end_rsdata_req</span><span class="p">;</span>
		<span class="n">fault_type</span> <span class="o">=</span> <span class="n">DRBD_FAULT_RS_RD</span><span class="p">;</span>
		<span class="cm">/* used in the sector offset progress display */</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">P_OV_REPLY</span>:
	<span class="k">case</span> <span class="n">P_CSUM_RS_REQUEST</span>:
		<span class="n">fault_type</span> <span class="o">=</span> <span class="n">DRBD_FAULT_RS_RD</span><span class="p">;</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">)</span> <span class="o">+</span> <span class="n">digest_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_e</span><span class="p">;</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">digest_size</span> <span class="o">=</span> <span class="n">digest_size</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">digest</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">di</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">digest_info</span><span class="p">));</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">digest</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">EE_HAS_DIGEST</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">digest_size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_e</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">P_CSUM_RS_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">89</span><span class="p">);</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_e_end_csum_rs_req</span><span class="p">;</span>
			<span class="cm">/* used in the sector offset progress display */</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">P_OV_REPLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* track progress, we may need to throttle */</span>
			<span class="n">atomic_add</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_in</span><span class="p">);</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_e_end_ov_reply</span><span class="p">;</span>
			<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="cm">/* drbd_rs_begin_io done when we sent this request,</span>
<span class="cm">			 * but accounting still needs to be done. */</span>
			<span class="k">goto</span> <span class="n">submit_for_resync</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">P_OV_REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">==</span> <span class="o">~</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_position</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span> <span class="o">=</span> <span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">-</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRBD_SYNC_MARKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">;</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Online Verify start sector: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_e_end_ov_req</span><span class="p">;</span>
		<span class="n">fault_type</span> <span class="o">=</span> <span class="n">DRBD_FAULT_RS_RD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected command (%s) in receive_DataRequest</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">fault_type</span> <span class="o">=</span> <span class="n">DRBD_FAULT_MAX</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_e</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Throttle, drbd_rs_begin_io and submit should become asynchronous</span>
<span class="cm">	 * wrt the receiver, but it is not as straightforward as it may seem.</span>
<span class="cm">	 * Various places in the resync start and stop logic assume resync</span>
<span class="cm">	 * requests are processed in order, requeuing this on the worker thread</span>
<span class="cm">	 * introduces a bunch of new code for synchronization between threads.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unlimited throttling before drbd_rs_begin_io may stall the resync</span>
<span class="cm">	 * &quot;forever&quot;, throttling after drbd_rs_begin_io will lock that extent</span>
<span class="cm">	 * for application writes for the same time.  For now, just throttle</span>
<span class="cm">	 * here, where the rest of the code expects the receiver to sleep for</span>
<span class="cm">	 * a while, anyways.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Throttle before drbd_rs_begin_io, as that locks out application IO;</span>
<span class="cm">	 * this defers syncer requests for some time, before letting at least</span>
<span class="cm">	 * on request through.  The resync controller on the receiving side</span>
<span class="cm">	 * will adapt to the incoming rate accordingly.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We cannot throttle here if remote is Primary/SyncTarget:</span>
<span class="cm">	 * we would also throttle its application reads.</span>
<span class="cm">	 * In that case, throttling is done on the SyncTarget only.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">peer</span> <span class="o">!=</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">drbd_rs_should_slow_down</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">))</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_rs_begin_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_e</span><span class="p">;</span>

<span class="nl">submit_for_resync:</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_ev</span><span class="p">);</span>

<span class="nl">submit:</span>
	<span class="n">inc_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_submit_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="n">fault_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* don&#39;t care for the reason here */</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;submit failed, triggering re-connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="cm">/* no drbd_rs_complete_io(), we are dropping the connection anyways */</span>

<span class="nl">out_free_e:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_asb_recover_0p</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ch_self</span><span class="p">,</span> <span class="n">ch_peer</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ch_peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_SIZE</span><span class="p">];</span>
	<span class="n">ch_self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">comm_bm_set</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_0p</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASB_CONSENSUS</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_SECONDARY</span>:
	<span class="k">case</span> <span class="n">ASB_CALL_HELPER</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Configuration error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCONNECT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_YOUNGER_PRI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">peer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">peer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Else fall through to one of the other strategies... */</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_OLDER_PRI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">peer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">peer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Else fall through to one of the other strategies... */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Discard younger/older primary did not find a decision</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Using discard-least-changes instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_ZERO_CHG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ch_peer</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ch_self</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				<span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch_peer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">rv</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch_self</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_0p</span> <span class="o">==</span> <span class="n">ASB_DISCARD_ZERO_CHG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_LEAST_CHG</span>:
		<span class="k">if</span>	<span class="p">(</span><span class="n">ch_self</span> <span class="o">&lt;</span> <span class="n">ch_peer</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch_self</span> <span class="o">&gt;</span> <span class="n">ch_peer</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* ( ch_self == ch_peer ) */</span>
		     <span class="cm">/* Well, then use something else. */</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				<span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_LOCAL</span>:
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_REMOTE</span>:
		<span class="n">rv</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_asb_recover_1p</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hg</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_1p</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_YOUNGER_PRI</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_OLDER_PRI</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_LEAST_CHG</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_LOCAL</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_REMOTE</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Configuration error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCONNECT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_CONSENSUS</span>:
		<span class="n">hg</span> <span class="o">=</span> <span class="n">drbd_asb_recover_0p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">hg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="mi">1</span>  <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">hg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_VIOLENTLY</span>:
		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_asb_recover_0p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_SECONDARY</span>:
		<span class="k">return</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_CALL_HELPER</span>:
		<span class="n">hg</span> <span class="o">=</span> <span class="n">drbd_asb_recover_0p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv2</span><span class="p">;</span>

			<span class="n">drbd_set_role</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">R_SECONDARY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			 <span class="cm">/* drbd_change_state() does not sleep while in SS_IN_TRANSIENT_STATE,</span>
<span class="cm">			  * we might be here in C_WF_REPORT_PARAMS which is transient.</span>
<span class="cm">			  * we do not need to wait for the after state change work either. */</span>
			<span class="n">rv2</span> <span class="o">=</span> <span class="n">drbd_change_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">R_SECONDARY</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv2</span> <span class="o">!=</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;pri-lost-after-sb&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Successfully gave up primary role.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">hg</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">hg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_asb_recover_2p</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hg</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_2p</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASB_DISCARD_YOUNGER_PRI</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_OLDER_PRI</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_LEAST_CHG</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_LOCAL</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_REMOTE</span>:
	<span class="k">case</span> <span class="n">ASB_CONSENSUS</span>:
	<span class="k">case</span> <span class="n">ASB_DISCARD_SECONDARY</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Configuration error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_VIOLENTLY</span>:
		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_asb_recover_0p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_DISCONNECT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASB_CALL_HELPER</span>:
		<span class="n">hg</span> <span class="o">=</span> <span class="n">drbd_asb_recover_0p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv2</span><span class="p">;</span>

			 <span class="cm">/* drbd_change_state() does not sleep while in SS_IN_TRANSIENT_STATE,</span>
<span class="cm">			  * we might be here in C_WF_REPORT_PARAMS which is transient.</span>
<span class="cm">			  * we do not need to wait for the after state change work either. */</span>
			<span class="n">rv2</span> <span class="o">=</span> <span class="n">drbd_change_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">R_SECONDARY</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv2</span> <span class="o">!=</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;pri-lost-after-sb&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Successfully gave up primary role.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">hg</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">hg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_uuid_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">uuid</span><span class="p">,</span>
			   <span class="n">u64</span> <span class="n">bits</span><span class="p">,</span> <span class="n">u64</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uuid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s uuid info vanished while I was looking!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s %016llX:%016llX:%016llX:%016llX bits:%llu flags:%llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">text</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">],</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">],</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">],</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_END</span><span class="p">],</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bits</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  100	after split brain try auto recover</span>
<span class="cm">    2	C_SYNC_SOURCE set BitMap</span>
<span class="cm">    1	C_SYNC_SOURCE use BitMap</span>
<span class="cm">    0	no Sync</span>
<span class="cm">   -1	C_SYNC_TARGET use BitMap</span>
<span class="cm">   -2	C_SYNC_TARGET set BitMap</span>
<span class="cm"> -100	after split brain, disconnect</span>
<span class="cm">-1000	unrelated data</span>
<span class="cm">-1091   requires proto 91</span>
<span class="cm">-1096   requires proto 96</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_uuid_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rule_nr</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">UUID_JUST_CREATED</span> <span class="o">&amp;&amp;</span> <span class="n">peer</span> <span class="o">==</span> <span class="n">UUID_JUST_CREATED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">self</span> <span class="o">==</span> <span class="n">UUID_JUST_CREATED</span> <span class="o">||</span> <span class="n">self</span> <span class="o">==</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">peer</span> <span class="o">!=</span> <span class="n">UUID_JUST_CREATED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="n">UUID_JUST_CREATED</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">peer</span> <span class="o">==</span> <span class="n">UUID_JUST_CREATED</span> <span class="o">||</span> <span class="n">peer</span> <span class="o">==</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rct</span><span class="p">,</span> <span class="n">dc</span><span class="p">;</span> <span class="cm">/* roles at crash time */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">91</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1091</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;was SyncSource, missed the resync finished event, corrected myself:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">drbd_uuid_set_bm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">);</span>

				<span class="n">drbd_uuid_dump</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;self&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span>
					       <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_NEGOTIATING</span> <span class="o">?</span> <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">34</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;was SyncSource (peer failed to write sync_uuid)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">91</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1091</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;was SyncTarget, peer missed the resync finished event, corrected peer:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">];</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">];</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>

				<span class="n">drbd_uuid_dump</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_SIZE</span><span class="p">],</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;was SyncTarget (failed to write sync_uuid)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">37</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Common power [off|failure] */</span>
		<span class="n">rct</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CRASHED_PRIMARY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* lowest bit is set when we were primary,</span>
<span class="cm">		 * next bit (weight 2) is set when peer was primary */</span>
		<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rct</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* !self_pri &amp;&amp; !peer_pri */</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/*  self_pri &amp;&amp; !peer_pri */</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* !self_pri &amp;&amp;  peer_pri */</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/*  self_pri &amp;&amp;  peer_pri */</span>
			<span class="n">dc</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">dc</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">51</span><span class="p">;</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">96</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">:</span>
		    <span class="n">peer</span> <span class="o">+</span> <span class="n">UUID_NEW_BM_OFFSET</span> <span class="o">==</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* The last P_SYNC_UUID did not get though. Undo the last start of</span>
<span class="cm">			   resync as sync source modifications of the peer&#39;s UUIDs. */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">91</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1091</span><span class="p">;</span>

			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">];</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Lost last syncUUID packet, corrected:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drbd_uuid_dump</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_SIZE</span><span class="p">],</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]);</span>

			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_HISTORY_START</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UI_HISTORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">71</span><span class="p">;</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">96</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">:</span>
		    <span class="n">self</span> <span class="o">+</span> <span class="n">UUID_NEW_BM_OFFSET</span> <span class="o">==</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* The last P_SYNC_UUID did not get though. Undo the last start of</span>
<span class="cm">			   resync as sync source modifications of our UUIDs. */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">91</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1091</span><span class="p">;</span>

			<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_BITMAP</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]);</span>
			<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_HISTORY_START</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Last syncUUID did not get through, corrected:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drbd_uuid_dump</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;self&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span>
				       <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_NEGOTIATING</span> <span class="o">?</span> <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_HISTORY_START</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UI_HISTORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span> <span class="o">&amp;&amp;</span> <span class="n">self</span> <span class="o">!=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">100</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rule_nr</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_HISTORY_START</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UI_HISTORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">UI_HISTORY_START</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">UI_HISTORY_END</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* drbd_sync_handshake() returns the new conn state on success, or</span>
<span class="cm">   CONN_MASK (-1) on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_conns</span> <span class="nf">drbd_sync_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_role</span> <span class="n">peer_role</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">peer_disk</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hg</span><span class="p">,</span> <span class="n">rule_nr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_conns</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">C_MASK</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">mydisk</span><span class="p">;</span>

	<span class="n">mydisk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mydisk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span>
		<span class="n">mydisk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">new_state_tmp</span><span class="p">.</span><span class="n">disk</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_sync_handshake:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">drbd_uuid_dump</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;self&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">comm_bm_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">drbd_uuid_dump</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">,</span>
		       <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_SIZE</span><span class="p">],</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]);</span>

	<span class="n">hg</span> <span class="o">=</span> <span class="n">drbd_uuid_compare</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rule_nr</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;uuid_compare()=%d by rule %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span> <span class="n">rule_nr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Unrelated data, aborting!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">C_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;To resolve this both sides have to support at least protocol %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">hg</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">C_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span>    <span class="p">((</span><span class="n">mydisk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">peer_disk</span> <span class="o">&gt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">peer_disk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">mydisk</span>    <span class="o">&gt;</span> <span class="n">D_INCONSISTENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="n">abs</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hg</span> <span class="o">=</span> <span class="n">mydisk</span> <span class="o">&gt;</span> <span class="n">D_INCONSISTENT</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="n">hg</span> <span class="o">=</span> <span class="n">hg</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Becoming sync %s due to disk states.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">hg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;source&quot;</span> <span class="o">:</span> <span class="s">&quot;target&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;initial-split-brain&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="mi">100</span> <span class="o">||</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">always_asbp</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span>
			   <span class="o">+</span> <span class="p">(</span><span class="n">peer_role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">forced</span> <span class="o">=</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">hg</span> <span class="o">=</span> <span class="n">drbd_asb_recover_0p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">hg</span> <span class="o">=</span> <span class="n">drbd_asb_recover_1p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">hg</span> <span class="o">=</span> <span class="n">drbd_asb_recover_2p</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Split-Brain detected, %d primaries, &quot;</span>
			     <span class="s">&quot;automatically solved. Sync from %s node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pcount</span><span class="p">,</span> <span class="p">(</span><span class="n">hg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;peer&quot;</span> <span class="o">:</span> <span class="s">&quot;this&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">forced</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Doing a full sync, since&quot;</span>
				     <span class="s">&quot; UUIDs where ambiguous.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">hg</span> <span class="o">=</span> <span class="n">hg</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">hg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">hg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Split-Brain detected, manually solved. &quot;</span>
			     <span class="s">&quot;Sync from %s node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">hg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;peer&quot;</span> <span class="o">:</span> <span class="s">&quot;this&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME this log message is not correct if we end up here</span>
<span class="cm">		 * after an attempted attach on a diskless node.</span>
<span class="cm">		 * We just refuse to attach -- well, we drop the &quot;connection&quot;</span>
<span class="cm">		 * to that disk, in a way... */</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Split-Brain detected but unresolved, dropping connection!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;split-brain&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">C_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mydisk</span> <span class="o">&lt;=</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;I shall become SyncSource, but I am inconsistent!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">C_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="cm">/* by intention we do not use mydisk here. */</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_CONSISTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">rr_conflict</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ASB_CALL_HELPER</span>:
			<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;pri-lost&quot;</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">ASB_DISCONNECT</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;I shall become SyncTarget, but I am primary!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">C_MASK</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ASB_VIOLENTLY</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Becoming SyncTarget, violating the stable-data&quot;</span>
			     <span class="s">&quot;assumption</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">dry_run</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">CONN_DRY_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;dry-run connect: No resync, would become Connected immediately.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;dry-run connect: Would become %s, doing a %s resync.&quot;</span><span class="p">,</span>
				 <span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">hg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">:</span> <span class="n">C_SYNC_TARGET</span><span class="p">),</span>
				 <span class="n">abs</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;bit-map based&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">C_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Writing the whole bitmap, full sync required after drbd_sync_handshake.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bmio_set_n_write</span><span class="p">,</span> <span class="s">&quot;set_n_write from sync_handshake&quot;</span><span class="p">,</span>
					<span class="n">BM_LOCKED_SET_ALLOWED</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">C_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* become sync source. */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">C_WF_BITMAP_S</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* become sync target */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">C_WF_BITMAP_T</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">C_CONNECTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;No resync, but %lu bits in bitmap!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns 1 if invalid */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmp_after_sb</span><span class="p">(</span><span class="k">enum</span> <span class="n">drbd_after_sb_p</span> <span class="n">peer</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_after_sb_p</span> <span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ASB_DISCARD_REMOTE - ASB_DISCARD_LOCAL is valid */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">peer</span> <span class="o">==</span> <span class="n">ASB_DISCARD_REMOTE</span> <span class="o">&amp;&amp;</span> <span class="n">self</span> <span class="o">==</span> <span class="n">ASB_DISCARD_LOCAL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="n">ASB_DISCARD_REMOTE</span> <span class="o">&amp;&amp;</span> <span class="n">peer</span> <span class="o">==</span> <span class="n">ASB_DISCARD_LOCAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* any other things with ASB_DISCARD_REMOTE or ASB_DISCARD_LOCAL are invalid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span> <span class="o">==</span> <span class="n">ASB_DISCARD_REMOTE</span> <span class="o">||</span> <span class="n">peer</span> <span class="o">==</span> <span class="n">ASB_DISCARD_LOCAL</span> <span class="o">||</span>
	    <span class="n">self</span> <span class="o">==</span> <span class="n">ASB_DISCARD_REMOTE</span> <span class="o">||</span> <span class="n">self</span> <span class="o">==</span> <span class="n">ASB_DISCARD_LOCAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* everything else is valid if they are equal on both sides. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span> <span class="o">==</span> <span class="n">self</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* everything es is invalid. */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_protocol</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">protocol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p_proto</span><span class="p">,</span> <span class="n">p_after_sb_0p</span><span class="p">,</span> <span class="n">p_after_sb_1p</span><span class="p">,</span> <span class="n">p_after_sb_2p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p_want_lose</span><span class="p">,</span> <span class="n">p_two_primaries</span><span class="p">,</span> <span class="n">cf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">p_integrity_alg</span><span class="p">[</span><span class="n">SHARED_SECRET_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">p_proto</span>		<span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="n">p_after_sb_0p</span>	<span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">after_sb_0p</span><span class="p">);</span>
	<span class="n">p_after_sb_1p</span>	<span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">after_sb_1p</span><span class="p">);</span>
	<span class="n">p_after_sb_2p</span>	<span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">after_sb_2p</span><span class="p">);</span>
	<span class="n">p_two_primaries</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">two_primaries</span><span class="p">);</span>
	<span class="n">cf</span>		<span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">conn_flags</span><span class="p">);</span>
	<span class="n">p_want_lose</span> <span class="o">=</span> <span class="n">cf</span> <span class="o">&amp;</span> <span class="n">CF_WANT_LOSE</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONN_DRY_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cf</span> <span class="o">&amp;</span> <span class="n">CF_DRY_RUN</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONN_DRY_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_proto</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;incompatible communication protocols</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp_after_sb</span><span class="p">(</span><span class="n">p_after_sb_0p</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_0p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;incompatible after-sb-0pri settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp_after_sb</span><span class="p">(</span><span class="n">p_after_sb_1p</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_1p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;incompatible after-sb-1pri settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp_after_sb</span><span class="p">(</span><span class="n">p_after_sb_2p</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_2p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;incompatible after-sb-2pri settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_want_lose</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;both sides have the &#39;want_lose&#39; flag set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_two_primaries</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;incompatible setting of the two-primaries options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">my_alg</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">integrity_alg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p_integrity_alg</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data_size</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">p_integrity_alg</span><span class="p">[</span><span class="n">SHARED_SECRET_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p_integrity_alg</span><span class="p">,</span> <span class="n">my_alg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;incompatible setting of the data-integrity-alg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;data-integrity-alg: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">my_alg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">my_alg</span> <span class="o">:</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;&lt;not-used&gt;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">disconnect:</span>
	<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* helper function</span>
<span class="cm"> * input: alg name, feature name</span>
<span class="cm"> * return: NULL (alg name was &quot;&quot;)</span>
<span class="cm"> *         ERR_PTR(error) if something goes wrong</span>
<span class="cm"> *         or the crypto hash ptr, if it worked out ok. */</span>
<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="nf">drbd_crypto_alloc_digest_safe</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tfm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tfm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Can not allocate </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> as %s (reason: %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">alg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tfm</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">tfm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_crypto_is_hash</span><span class="p">(</span><span class="n">crypto_hash_tfm</span><span class="p">(</span><span class="n">tfm</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> is not a digest (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tfm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_SyncParam</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_rs_param_95</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">rs_param_95</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">header_size</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">exp_max_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">verify_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">csums_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">apv</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">rs_plan_s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">exp_max_sz</span>  <span class="o">=</span> <span class="n">apv</span> <span class="o">&lt;=</span> <span class="mi">87</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param</span><span class="p">)</span>
		    <span class="o">:</span> <span class="n">apv</span> <span class="o">==</span> <span class="mi">88</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param</span><span class="p">)</span>
					<span class="o">+</span> <span class="n">SHARED_SECRET_MAX</span>
		    <span class="o">:</span> <span class="n">apv</span> <span class="o">&lt;=</span> <span class="mi">94</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param_89</span><span class="p">)</span>
		    <span class="o">:</span> <span class="cm">/* apv &gt;= 95 */</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param_95</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet_size</span> <span class="o">&gt;</span> <span class="n">exp_max_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;SyncParam packet too long: received %u, expected &lt;= %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">packet_size</span><span class="p">,</span> <span class="n">exp_max_sz</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">&lt;=</span> <span class="mi">88</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">header_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">);</span>
		<span class="n">data_size</span>   <span class="o">=</span> <span class="n">packet_size</span>  <span class="o">-</span> <span class="n">header_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">&lt;=</span> <span class="mi">94</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">header_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param_89</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">);</span>
		<span class="n">data_size</span>   <span class="o">=</span> <span class="n">packet_size</span>  <span class="o">-</span> <span class="n">header_size</span><span class="p">;</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">header_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param_95</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">);</span>
		<span class="n">data_size</span>   <span class="o">=</span> <span class="n">packet_size</span>  <span class="o">-</span> <span class="n">header_size</span><span class="p">;</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* initialize verify_alg and csums_alg */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SHARED_SECRET_MAX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">header_size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">header_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">rate</span>	  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">&gt;=</span> <span class="mi">88</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">==</span> <span class="mi">88</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="n">SHARED_SECRET_MAX</span> <span class="o">||</span> <span class="n">data_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;verify-alg of wrong size, &quot;</span>
					<span class="s">&quot;peer wants %u, accepting only up to %u byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">data_size</span><span class="p">,</span> <span class="n">SHARED_SECRET_MAX</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data_size</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

			<span class="cm">/* we expect NUL terminated string */</span>
			<span class="cm">/* but just in case someone tries to be evil */</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">[</span><span class="n">data_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">[</span><span class="n">data_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* apv &gt;= 89 */</span> <span class="p">{</span>
			<span class="cm">/* we still expect NUL terminated strings */</span>
			<span class="cm">/* but just in case someone tries to be evil */</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">[</span><span class="n">SHARED_SECRET_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">[</span><span class="n">SHARED_SECRET_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">[</span><span class="n">SHARED_SECRET_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">[</span><span class="n">SHARED_SECRET_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Different verify-alg settings. me=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> peer=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">verify_tfm</span> <span class="o">=</span> <span class="n">drbd_crypto_alloc_digest_safe</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">,</span> <span class="s">&quot;verify-alg&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">verify_tfm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">verify_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">&gt;=</span> <span class="mi">89</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Different csums-alg settings. me=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> peer=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">csums_tfm</span> <span class="o">=</span> <span class="n">drbd_crypto_alloc_digest_safe</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">,</span> <span class="s">&quot;csums-alg&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">csums_tfm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">csums_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">&gt;</span> <span class="mi">94</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">rate</span>	  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_plan_ahead</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_plan_ahead</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_delay_target</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_delay_target</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_fill_target</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_fill_target</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_max_rate</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_max_rate</span><span class="p">);</span>

			<span class="n">fifo_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_plan_ahead</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">SLEEP_TIME</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fifo_size</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">fifo_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs_plan_s</span>   <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs_plan_s</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;kmalloc of fifo_buffer failed&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
		<span class="cm">/* lock against drbd_nl_syncer_conf() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verify_tfm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span> <span class="o">=</span> <span class="n">verify_tfm</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;using verify-alg: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csums_tfm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">csums_alg_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span> <span class="o">=</span> <span class="n">csums_tfm</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;using csums-alg: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo_size</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">values</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">rs_plan_s</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span>   <span class="o">=</span> <span class="n">fifo_size</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_planed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="nl">disconnect:</span>
	<span class="cm">/* just for completeness: actually not needed,</span>
<span class="cm">	 * as this is not reached if csums_tfm was ok. */</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">csums_tfm</span><span class="p">);</span>
	<span class="cm">/* but free the verify_tfm again, if csums_tfm did not work out */</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">verify_tfm</span><span class="p">);</span>
	<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* warn if the arguments differ by more than 12.5% */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">warn_if_differ_considerably</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">a</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">a</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">b</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Considerable difference in %s: %llus vs. %llus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_sizes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_sizes</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">sizes</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">determine_dev_size</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">unchanged</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">p_size</span><span class="p">,</span> <span class="n">p_usize</span><span class="p">,</span> <span class="n">my_usize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ldsc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* local disk size changed */</span>
	<span class="k">enum</span> <span class="n">dds_flags</span> <span class="n">ddsf</span><span class="p">;</span>

	<span class="n">p_size</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_size</span><span class="p">);</span>
	<span class="n">p_usize</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">u_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;some backing storage is needed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* just store the peer&#39;s disk size for now.</span>
<span class="cm">	 * we still need to figure out whether we accept that. */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_size</span> <span class="o">=</span> <span class="n">p_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">warn_if_differ_considerably</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;lower level device sizes&quot;</span><span class="p">,</span>
			   <span class="n">p_size</span><span class="p">,</span> <span class="n">drbd_get_max_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">));</span>
		<span class="n">warn_if_differ_considerably</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;user requested size&quot;</span><span class="p">,</span>
					    <span class="n">p_usize</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">);</span>

		<span class="cm">/* if this is the first connect, or an otherwise expected</span>
<span class="cm">		 * param exchange, choose the minimum */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span>
			<span class="n">p_usize</span> <span class="o">=</span> <span class="n">min_not_zero</span><span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">,</span>
					     <span class="n">p_usize</span><span class="p">);</span>

		<span class="n">my_usize</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span> <span class="o">!=</span> <span class="n">p_usize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span> <span class="o">=</span> <span class="n">p_usize</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Peer sets u_size to %lu sectors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Never shrink a device with usable data during connect.</span>
<span class="cm">		   But allow online shrinking if we are connected. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_new_dev_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span>
		   <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_OUTDATED</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;The peer&#39;s disk size is too small!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span> <span class="o">=</span> <span class="n">my_usize</span><span class="p">;</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ddsf</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dds_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dd</span> <span class="o">=</span> <span class="n">drbd_determine_dev_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ddsf</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span> <span class="o">==</span> <span class="n">dev_size_error</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I am diskless, need to accept the peer&#39;s size. */</span>
		<span class="n">drbd_set_my_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_max_bio_size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">max_bio_size</span><span class="p">);</span>
	<span class="n">drbd_reconsider_max_bio_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">known_size</span> <span class="o">!=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">known_size</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">);</span>
			<span class="n">ldsc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c_size</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ldsc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we have different sizes, probably peer</span>
<span class="cm">			 * needs to know my new size... */</span>
			<span class="n">drbd_send_sizes</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ddsf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RESIZE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dd</span> <span class="o">==</span> <span class="n">grew</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;=</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ddsf</span> <span class="o">&amp;</span> <span class="n">DDSF_NO_RESYNC</span><span class="p">)</span>
					<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Resync of new storage suppressed with --assume-clean</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">resync_after_online_grow</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">RESYNC_AFTER_NEG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_uuids</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_uuids</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">uuids</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">p_uuid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">updated_uuids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p_uuid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">*</span><span class="n">UI_EXTENDED_SIZE</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_CURRENT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UI_EXTENDED_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p_uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span> <span class="o">=</span> <span class="n">p_uuid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ed_uuid</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Can only connect to data with current UUID=%016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ed_uuid</span><span class="p">);</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">skip_initial_sync</span> <span class="o">=</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">==</span> <span class="n">UUID_JUST_CREATED</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip_initial_sync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Accepted new current UUID, preparing to skip initial sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bmio_clear_n_write</span><span class="p">,</span>
					<span class="s">&quot;clear_n_write from receive_uuids&quot;</span><span class="p">,</span>
					<span class="n">BM_LOCKED_TEST_ALLOWED</span><span class="p">);</span>
			<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_CURRENT</span><span class="p">,</span> <span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]);</span>
			<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_BITMAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">_NS2</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">D_UP_TO_DATE</span><span class="p">,</span> <span class="n">pdsk</span><span class="p">,</span> <span class="n">D_UP_TO_DATE</span><span class="p">),</span>
					<span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">updated_uuids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* I am a diskless primary, the peer just created a new current UUID</span>
<span class="cm">		   for me. */</span>
		<span class="n">updated_uuids</span> <span class="o">=</span> <span class="n">drbd_set_ed_uuid</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Before we test for the disk state, we should wait until an eventually</span>
<span class="cm">	   ongoing cluster wide state change is finished. That is important if</span>
<span class="cm">	   we are primary and are detaching from our disk. We need to see the</span>
<span class="cm">	   new disk state... */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CLUSTER_ST_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
		<span class="n">updated_uuids</span> <span class="o">|=</span> <span class="n">drbd_set_ed_uuid</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">updated_uuids</span><span class="p">)</span>
		<span class="n">drbd_print_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;receiver updated UUIDs to&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * convert_state() - Converts the peer&#39;s view of the cluster state to our point of view</span>
<span class="cm"> * @ps:		The state as seen by the peer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="nf">convert_state</span><span class="p">(</span><span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ms</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_conns</span> <span class="n">c_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C_CONNECTED</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_CONNECTED</span><span class="p">,</span>

		<span class="p">[</span><span class="n">C_STARTING_SYNC_S</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_STARTING_SYNC_T</span><span class="p">,</span>
		<span class="p">[</span><span class="n">C_STARTING_SYNC_T</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_STARTING_SYNC_S</span><span class="p">,</span>
		<span class="p">[</span><span class="n">C_DISCONNECTING</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_TEAR_DOWN</span><span class="p">,</span> <span class="cm">/* C_NETWORK_FAILURE, */</span>
		<span class="p">[</span><span class="n">C_VERIFY_S</span><span class="p">]</span>       <span class="o">=</span> <span class="n">C_VERIFY_T</span><span class="p">,</span>
		<span class="p">[</span><span class="n">C_MASK</span><span class="p">]</span>   <span class="o">=</span> <span class="n">C_MASK</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">ms</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>

	<span class="n">ms</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">c_tab</span><span class="p">[</span><span class="n">ps</span><span class="p">.</span><span class="n">conn</span><span class="p">];</span>
	<span class="n">ms</span><span class="p">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">role</span><span class="p">;</span>
	<span class="n">ms</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">peer</span><span class="p">;</span>
	<span class="n">ms</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">disk</span><span class="p">;</span>
	<span class="n">ms</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">pdsk</span><span class="p">;</span>
	<span class="n">ms</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">|</span> <span class="n">ps</span><span class="p">.</span><span class="n">user_isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ms</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_req_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_req_state</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">req_state</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">mask</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">val</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">CLUSTER_ST_CHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_send_sr_reply</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">SS_CONCURRENT_ST_CHG</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">convert_state</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">convert_state</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_change_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">drbd_send_sr_reply</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_state</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">peer_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">real_peer_disk</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">cs_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">peer_state</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">real_peer_disk</span> <span class="o">=</span> <span class="n">peer_state</span><span class="p">.</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer_state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">real_peer_disk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="o">?</span> <span class="n">D_INCONSISTENT</span> <span class="o">:</span> <span class="n">D_CONSISTENT</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;real peer disk state = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">real_peer_disk</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
 <span class="nl">retry:</span>
	<span class="n">os</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="cm">/* If some other part of the code (asender thread, timeout)</span>
<span class="cm">	 * already decided to close the connection again,</span>
<span class="cm">	 * we must not &quot;re-establish&quot; it here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_TEAR_DOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* If this is the &quot;end of sync&quot; confirmation, usually the peer disk</span>
<span class="cm">	 * transitions from D_INCONSISTENT to D_UP_TO_DATE. For empty (0 bits</span>
<span class="cm">	 * set) resync started in PausedSyncT, or if the timing of pause-/</span>
<span class="cm">	 * unpause-sync events has been &quot;just right&quot;, the peer disk may</span>
<span class="cm">	 * transition from D_CONSISTENT to D_UP_TO_DATE as well.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_CONSISTENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">real_peer_disk</span> <span class="o">==</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we are (becoming) SyncSource, but peer is still in sync</span>
<span class="cm">		 * preparation, ignore its uptodate-ness to avoid flapping, it</span>
<span class="cm">		 * will change to inconsistent once the peer reaches active</span>
<span class="cm">		 * syncing states.</span>
<span class="cm">		 * It may have changed syncer-paused flags, however, so we</span>
<span class="cm">		 * cannot ignore this completely. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_SYNC_SOURCE</span><span class="p">)</span>
			<span class="n">real_peer_disk</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>

		<span class="cm">/* if peer_state changes to connected at the same time,</span>
<span class="cm">		 * it explicitly notifies us that it finished resync.</span>
<span class="cm">		 * Maybe we should finish it up, too? */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span>
			 <span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">)</span>
				<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* peer says his disk is inconsistent, while we think it is uptodate,</span>
<span class="cm">	 * and this happens while the peer still thinks we have a sync going on,</span>
<span class="cm">	 * but we think we are already done with the sync.</span>
<span class="cm">	 * We ignore this to avoid flapping pdsk.</span>
<span class="cm">	 * This should not happen, if the peer is a recent version of drbd. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">real_peer_disk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_SYNC_SOURCE</span><span class="p">)</span>
		<span class="n">real_peer_disk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_CONNECTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_AHEAD</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_BEHIND</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span> <span class="o">&amp;&amp;</span> <span class="n">peer_state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_NEGOTIATING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_NEGOTIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cr</span><span class="p">;</span> <span class="cm">/* consider resync */</span>

		<span class="cm">/* if we established a new connection */</span>
		<span class="n">cr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">);</span>
		<span class="cm">/* if we had an established connection</span>
<span class="cm">		 * and one of the nodes newly attaches a disk */</span>
		<span class="n">cr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">peer_state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span> <span class="o">||</span>
			<span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">));</span>
		<span class="cm">/* if we have both been inconsistent, and the peer has been</span>
<span class="cm">		 * forced to be UpToDate with --overwrite-data */</span>
		<span class="n">cr</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">CONSIDER_RESYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* if we had been plain connected, and the admin requested to</span>
<span class="cm">		 * start a sync by &quot;invalidate&quot; or &quot;invalidate-remote&quot; */</span>
		<span class="n">cr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_STARTING_SYNC_S</span> <span class="o">&amp;&amp;</span>
				 <span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_WF_BITMAP_T</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cr</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">drbd_sync_handshake</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">peer_state</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">real_peer_disk</span><span class="p">);</span>

		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_CONNECTED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">peer_state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Disk attach process on the peer node was aborted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">peer_state</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">;</span>
				<span class="n">real_peer_disk</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CONN_DRY_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">);</span>
				<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">i</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">i</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONSIDER_RESYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">peer_state</span><span class="p">.</span><span class="n">role</span><span class="p">;</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">real_peer_disk</span><span class="p">;</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">=</span> <span class="p">(</span><span class="n">peer_state</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">|</span> <span class="n">peer_state</span><span class="p">.</span><span class="n">user_isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_BITMAP_S</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">new_state_tmp</span><span class="p">.</span><span class="n">disk</span><span class="p">;</span>
	<span class="n">cs_flags</span> <span class="o">=</span> <span class="n">CS_VERBOSE</span> <span class="o">+</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">CS_HARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_CONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">is_susp</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Do not allow tl_restart(resend) for a rebooted peer. We can only allow this</span>
<span class="cm">		   for temporal network outages! */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Aborting Connect, can not thaw IO with an only Consistent peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tl_clear</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_uuid_new_current</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS2</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_PROTOCOL_ERROR</span><span class="p">,</span> <span class="n">susp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">cs_flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">peer_state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">peer_state</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_NEGOTIATING</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we want resync, peer has not yet decided to sync... */</span>
			<span class="cm">/* Nowadays only used when forcing a node into primary role and</span>
<span class="cm">			   setting its disk to UpToDate with that */</span>
			<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">drbd_send_current_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* update connected indicator, la_size, ... */</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_sync_uuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_rs_uuid</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">rs_uuid</span><span class="p">;</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_SYNC_UUID</span> <span class="o">||</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_BEHIND</span> <span class="o">||</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">||</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_NEGOTIATING</span><span class="p">);</span>

	<span class="cm">/* D_ASSERT( mdev-&gt;state.conn == C_WF_SYNC_UUID ); */</span>

	<span class="cm">/* Here the _drbd_uuid_ functions are right, current should</span>
<span class="cm">	   _not_ be rotated into the history */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_NEGOTIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_CURRENT</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">));</span>
		<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_BITMAP</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">);</span>

		<span class="n">drbd_print_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;updated sync uuid&quot;</span><span class="p">);</span>
		<span class="n">drbd_start_resync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">C_SYNC_TARGET</span><span class="p">);</span>

		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Ignoring SyncUUID packet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * receive_bitmap_plain</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 when done, 1 when another iteration is needed, and a negative error</span>
<span class="cm"> * code upon failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">receive_bitmap_plain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">num_words</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">BM_PACKET_WORDS</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_words</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">want</span> <span class="o">=</span> <span class="n">num_words</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">want</span> <span class="o">!=</span> <span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s:want (%u) != data_size (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">want</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">want</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">want</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drbd_bm_merge_lel</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span><span class="p">,</span> <span class="n">num_words</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span> <span class="o">+=</span> <span class="n">num_words</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * recv_bm_rle_bits</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 when done, 1 when another iteration is needed, and a negative error</span>
<span class="cm"> * code upon failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">recv_bm_rle_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">p_compressed_bm</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bitstream</span> <span class="n">bs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">look_ahead</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rl</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">toggle</span> <span class="o">=</span> <span class="n">DCBP_get_start</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">have</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">bitstream_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bs</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DCBP_get_pad_bits</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">bitstream_get_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">look_ahead</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">have</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span> <span class="n">have</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">+=</span> <span class="n">rl</span><span class="p">,</span> <span class="n">toggle</span> <span class="o">=</span> <span class="o">!</span><span class="n">toggle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">vli_decode_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rl</span><span class="p">,</span> <span class="n">look_ahead</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">toggle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">rl</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;bitmap overflow (e:%lu) while decoding bm RLE packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">_drbd_bm_set_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">have</span> <span class="o">&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;bitmap decoding error: h:%d b:%d la:0x%08llx l:%u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">have</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">look_ahead</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">bs</span><span class="p">.</span><span class="n">cur</span><span class="p">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">bs</span><span class="p">.</span><span class="n">buf_len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">look_ahead</span> <span class="o">&gt;&gt;=</span> <span class="n">bits</span><span class="p">;</span>
		<span class="n">have</span> <span class="o">-=</span> <span class="n">bits</span><span class="p">;</span>

		<span class="n">bits</span> <span class="o">=</span> <span class="n">bitstream_get_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">have</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">look_ahead</span> <span class="o">|=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="n">have</span><span class="p">;</span>
		<span class="n">have</span> <span class="o">+=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">bm_xfer_ctx_bit_to_word_offset</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * decode_bitmap_c</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 when done, 1 when another iteration is needed, and a negative error</span>
<span class="cm"> * code upon failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">decode_bitmap_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">p_compressed_bm</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DCBP_get_code</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">RLE_VLI_Bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">recv_bm_rle_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="cm">/* other variants had been implemented for evaluation,</span>
<span class="cm">	 * but have been dropped as this one turned out to be &quot;best&quot;</span>
<span class="cm">	 * during all our tests. */</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;receive_bitmap_c: unknown encoding %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">);</span>
	<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_PROTOCOL_ERROR</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">INFO_bm_xfer_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">direction</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* what would it take to transfer it &quot;plaintext&quot; */</span>
	<span class="kt">unsigned</span> <span class="n">plain</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_words</span><span class="o">+</span><span class="n">BM_PACKET_WORDS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">BM_PACKET_WORDS</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_words</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">total</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* total can not be zero. but just in case: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* don&#39;t report if not compressed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;=</span> <span class="n">plain</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* total &lt; plain. check for overflow, still */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;</span> <span class="n">UINT_MAX</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="p">(</span><span class="n">plain</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span>
		                    <span class="o">:</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">total</span> <span class="o">/</span> <span class="n">plain</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">-</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s bitmap stats [Bytes(packets)]: plain %u(%u), RLE %u(%u), &quot;</span>
	     <span class="s">&quot;total %u; compression: %u.%u%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">direction</span><span class="p">,</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">total</span><span class="p">,</span> <span class="n">r</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">r</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Since we are processing the bitfield from lower addresses to higher,</span>
<span class="cm">   it does not matter if the process it in 32 bit chunks or 64 bit</span>
<span class="cm">   chunks as long as it is little endian. (Understand it as byte stream,</span>
<span class="cm">   beginning with the lowest byte...) If we would use big endian</span>
<span class="cm">   we would need to process it from the highest address to the lowest,</span>
<span class="cm">   in order to be agnostic to the 32 vs 64 bits issue.</span>

<span class="cm">   returns 0 on failure, 1 if we successfully received it. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">h80</span><span class="p">;</span>

	<span class="n">drbd_bm_lock</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;receive bitmap&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_SET_ALLOWED</span><span class="p">);</span>
	<span class="cm">/* you are supposed to send additional out-of-sync information</span>
<span class="cm">	 * if you actually set bits during this phase */</span>

	<span class="cm">/* maybe we should use some per thread scratch page,</span>
<span class="cm">	 * and allocate that during initial device creation? */</span>
	<span class="n">buffer</span>	 <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;failed to allocate one page buffer in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bm_xfer_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bm_bits</span> <span class="o">=</span> <span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">),</span>
		<span class="p">.</span><span class="n">bm_words</span> <span class="o">=</span> <span class="n">drbd_bm_words</span><span class="p">(</span><span class="n">mdev</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">P_BITMAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">receive_bitmap_plain</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">P_COMPRESSED_BITMAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* MAYBE: sanity check that we speak proto &gt;= 90,</span>
<span class="cm">			 * and the feature is enabled! */</span>
			<span class="k">struct</span> <span class="n">p_compressed_bm</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="n">BM_PACKET_PAYLOAD_BYTES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ReportCBitmap packet too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* use the page buff */</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data_size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ReportCBitmap packet too small (l:%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">decode_bitmap_c</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;receive_bitmap: cmd neither ReportBitMap nor ReportCBitMap (is 0x%x)&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">c</span><span class="p">.</span><span class="n">packets</span><span class="p">[</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">P_BITMAP</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">P_BITMAP</span><span class="p">]</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_recv_header</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INFO_bm_xfer_stats</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;receive&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_BITMAP_T</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>

		<span class="n">ok</span> <span class="o">=</span> <span class="o">!</span><span class="n">drbd_send_bitmap</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="cm">/* Omit CS_ORDERED with this state transition to avoid deadlocks. */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_WF_SYNC_UUID</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">);</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_WF_BITMAP_S</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* admin may have requested C_DISCONNECTING,</span>
<span class="cm">		 * other threads may have noticed network errors */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected cstate (%s) in receive_bitmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">drbd_bm_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_BITMAP_S</span><span class="p">)</span>
		<span class="n">drbd_start_resync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">C_SYNC_SOURCE</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_skip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO zero copy sink :) */</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">sink</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;skipping unknown optional packet type %d, l: %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cmd</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">want</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sink</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">want</span><span class="p">);</span>
		<span class="n">ERR_IF</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_UnplugRemote</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make sure we&#39;ve acked all the TCP data associated</span>
<span class="cm">	 * with the data requests being unplugged */</span>
	<span class="n">drbd_tcp_quickack</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_out_of_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_block_desc</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">block_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C_WF_SYNC_UUID</span>:
	<span class="k">case</span> <span class="n">C_WF_BITMAP_T</span>:
	<span class="k">case</span> <span class="n">C_BEHIND</span>:
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERT FAILED cstate = %s, expected: WFSyncUUID|WFBitMapT|Behind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">drbd_set_out_of_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">));</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">drbd_cmd_handler_f</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to_receive</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">data_cmd</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">expect_payload</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">pkt_size</span><span class="p">;</span>
	<span class="n">drbd_cmd_handler_f</span> <span class="n">function</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">data_cmd</span> <span class="n">drbd_cmd_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">P_DATA</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_data</span><span class="p">),</span> <span class="n">receive_Data</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_DATA_REPLY</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_data</span><span class="p">),</span> <span class="n">receive_DataReply</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_RS_DATA_REPLY</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_data</span><span class="p">),</span> <span class="n">receive_RSDataReply</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">[</span><span class="n">P_BARRIER</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_barrier</span><span class="p">),</span> <span class="n">receive_Barrier</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">[</span><span class="n">P_BITMAP</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">),</span> <span class="n">receive_bitmap</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">[</span><span class="n">P_COMPRESSED_BITMAP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">),</span> <span class="n">receive_bitmap</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">[</span><span class="n">P_UNPLUG_REMOTE</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">),</span> <span class="n">receive_UnplugRemote</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_DATA_REQUEST</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_req</span><span class="p">),</span> <span class="n">receive_DataRequest</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_RS_DATA_REQUEST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_req</span><span class="p">),</span> <span class="n">receive_DataRequest</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_SYNC_PARAM</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">),</span> <span class="n">receive_SyncParam</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_SYNC_PARAM89</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">),</span> <span class="n">receive_SyncParam</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_PROTOCOL</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_protocol</span><span class="p">),</span> <span class="n">receive_protocol</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_UUIDS</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_uuids</span><span class="p">),</span> <span class="n">receive_uuids</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_SIZES</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_sizes</span><span class="p">),</span> <span class="n">receive_sizes</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_STATE</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_state</span><span class="p">),</span> <span class="n">receive_state</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_STATE_CHG_REQ</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_req_state</span><span class="p">),</span> <span class="n">receive_req_state</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_SYNC_UUID</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_uuid</span><span class="p">),</span> <span class="n">receive_sync_uuid</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_OV_REQUEST</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_req</span><span class="p">),</span> <span class="n">receive_DataRequest</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_OV_REPLY</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_req</span><span class="p">),</span> <span class="n">receive_DataRequest</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_CSUM_RS_REQUEST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_req</span><span class="p">),</span> <span class="n">receive_DataRequest</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_DELAY_PROBE</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_delay_probe93</span><span class="p">),</span> <span class="n">receive_skip</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_OUT_OF_SYNC</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_desc</span><span class="p">),</span> <span class="n">receive_out_of_sync</span> <span class="p">},</span>
	<span class="cm">/* anything missing from this table is in</span>
<span class="cm">	 * the asender_tbl, see get_asender_cmd */</span>
	<span class="p">[</span><span class="n">P_MAX_CMD</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* All handler functions that expect a sub-header get that sub-heder in</span>
<span class="cm">   mdev-&gt;data.rbuf.header.head.payload.</span>

<span class="cm">   Usually in mdev-&gt;data.rbuf.header.head the callback can find the usual</span>
<span class="cm">   p_header, but they may not rely on that. Since there is also p_header95 !</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbdd</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">p_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">packet_size</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">shs</span><span class="p">;</span> <span class="cm">/* sub header size */</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">get_t_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">)</span> <span class="o">==</span> <span class="n">Running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_thread_current_set_cpu</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_recv_header</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;=</span> <span class="n">P_MAX_CMD</span> <span class="o">||</span> <span class="o">!</span><span class="n">drbd_cmd_handler</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">function</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unknown packet type %d, l: %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">shs</span> <span class="o">=</span> <span class="n">drbd_cmd_handler</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">pkt_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">p_header</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet_size</span> <span class="o">-</span> <span class="n">shs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">drbd_cmd_handler</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">expect_payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;No payload expected %s l:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">packet_size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">h80</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">shs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="n">shs</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short read while reading sub header: rv=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_cmd_handler</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">function</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">packet_size</span> <span class="o">-</span> <span class="n">shs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;error receiving %s, l: %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">packet_size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">err_out:</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_PROTOCOL_ERROR</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* If we leave here, we probably want to update at least the</span>
<span class="cm">	 * &quot;Connected&quot; indicator on stable storage. Do so explicitly here. */</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_flush_workqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_wq_barrier</span> <span class="n">barr</span><span class="p">;</span>

	<span class="n">barr</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_prev_work_done</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barr</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">barr</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barr</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_free_tl_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STANDALONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* paranoia code */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span> <span class="o">+</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash_s</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERT FAILED ee_hash[%u].first == %p, expected NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">h</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span><span class="p">),</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* paranoia code */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span> <span class="o">+</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash_s</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERT FAILED tl_hash[%u] == %p, expected NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">h</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span><span class="p">),</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_fencing_p</span> <span class="n">fp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">SS_UNKNOWN_ERROR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We are about to start the cleanup after connection loss.</span>
<span class="cm">	 * Make sure drbd_make_request knows about that.</span>
<span class="cm">	 * Usually we should be in some network failure state already,</span>
<span class="cm">	 * but just in case we are not, we fix it up here.</span>
<span class="cm">	 */</span>
	<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_NETWORK_FAILURE</span><span class="p">));</span>

	<span class="cm">/* asender does not clean up anything. it must not interfere, either */</span>
	<span class="n">drbd_thread_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">);</span>
	<span class="n">drbd_free_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* wait for current activity to cease. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">_drbd_wait_ee_list_empty</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">);</span>
	<span class="n">_drbd_wait_ee_list_empty</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">);</span>
	<span class="n">_drbd_wait_ee_list_empty</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="cm">/* We do not have data structures that would allow us to</span>
<span class="cm">	 * get the rs_pending_cnt down to 0 again.</span>
<span class="cm">	 *  * On C_SYNC_TARGET we do not have any data structures describing</span>
<span class="cm">	 *    the pending RSDataRequest&#39;s we have sent.</span>
<span class="cm">	 *  * On C_SYNC_SOURCE there is no data structure that tracks</span>
<span class="cm">	 *    the P_RS_DATA_REPLY blocks that we sent to the SyncTarget.</span>
<span class="cm">	 *  And no, it is not the sum of the reference counts in the</span>
<span class="cm">	 *  resync_LRU. The resync_LRU tracks the whole operation including</span>
<span class="cm">	 *  the disk-IO, while the rs_pending_cnt only tracks the blocks</span>
<span class="cm">	 *  on the fly. */</span>
	<span class="n">drbd_rs_cancel_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_pending_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>

	<span class="cm">/* make sure syncer is stopped and w_resume_next_sg queued */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">);</span>
	<span class="n">resync_timer_fn</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* wait for all w_e_end_data_req, w_e_end_rsdata_req, w_send_barrier,</span>
<span class="cm">	 * w_make_resync_request etc. which may still be on the worker queue</span>
<span class="cm">	 * to be &quot;canceled&quot; */</span>
	<span class="n">drbd_flush_workqueue</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* This also does reclaim_net_ee().  If we do this too early, we might</span>
<span class="cm">	 * miss some resync ee and pages.*/</span>
	<span class="n">drbd_process_done_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_susp</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">tl_clear</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Connection closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">FP_DONT_CARE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span> <span class="o">&gt;=</span> <span class="n">FP_RESOURCE</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;=</span> <span class="n">D_UNKNOWN</span><span class="p">)</span>
		<span class="n">drbd_try_outdate_peer_async</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_UNCONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do not restart in case we are C_DISCONNECTING */</span>
		<span class="n">ns</span> <span class="o">=</span> <span class="n">os</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_UNCONNECTED</span><span class="p">;</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_cnt_wait</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_STANDALONE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* serialize with bitmap writeout triggered by the state change,</span>
<span class="cm">	 * if any. */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="cm">/* tcp_close and release of sendpage pages can be deferred.  I don&#39;t</span>
<span class="cm">	 * want to use SO_LINGER, because apparently it can be deferred for</span>
<span class="cm">	 * more than 20 seconds (longest time I checked).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Actually we don&#39;t care for exactly when the network stack does its</span>
<span class="cm">	 * put_page(), but release our reference on these pages right here.</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">drbd_release_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_ee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;net_ee not empty, killed %u entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use_by_net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;pp_in_use_by_net = %d, expected 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;pp_in_use = %d, expected 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">));</span>

	<span class="cm">/* ok, no more ee&#39;s on the fly, it is safe to reset the epoch_size */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We support PRO_VERSION_MIN to PRO_VERSION_MAX. The protocol version</span>
<span class="cm"> * we can agree on is stored in agreed_pro_version.</span>
<span class="cm"> *</span>
<span class="cm"> * feature flags and the reserved array should be enough room for future</span>
<span class="cm"> * enhancements of the handshake protocol, and possible plugins...</span>
<span class="cm"> *</span>
<span class="cm"> * for now, they are expected to be zero, but ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_send_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ASSERT current == mdev-&gt;receiver ... */</span>
	<span class="k">struct</span> <span class="n">p_handshake</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sbuf</span><span class="p">.</span><span class="n">handshake</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;interrupted during initial handshake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* interrupted. not ok. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_min</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">PRO_VERSION_MIN</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">PRO_VERSION_MAX</span><span class="p">);</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span> <span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">P_HAND_SHAKE</span><span class="p">,</span>
			     <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span> <span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return values:</span>
<span class="cm"> *   1 yes, we have a valid connection</span>
<span class="cm"> *   0 oops, did not work out, please try again</span>
<span class="cm"> *  -1 peer talks different language,</span>
<span class="cm"> *     no point in trying again, please go standalone.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_do_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ASSERT current == mdev-&gt;receiver ... */</span>
	<span class="k">struct</span> <span class="n">p_handshake</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">handshake</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">expect</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_handshake</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_send_handshake</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv_header</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">P_HAND_SHAKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;expected HandShake packet, received: %s (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;expected HandShake length: %u, received: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">expect</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">expect</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short read receiving handshake packet: l=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_min</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_min</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_min</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PRO_VERSION_MAX</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_min</span> <span class="o">||</span>
	    <span class="n">PRO_VERSION_MIN</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">incompat</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">PRO_VERSION_MAX</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Handshake successful: &quot;</span>
	     <span class="s">&quot;Agreed network protocol version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">incompat:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;incompatible DRBD dialects: &quot;</span>
	    <span class="s">&quot;I support %d-%d, peer supports %d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">PRO_VERSION_MIN</span><span class="p">,</span> <span class="n">PRO_VERSION_MAX</span><span class="p">,</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_min</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol_max</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if !defined(CONFIG_CRYPTO_HMAC) &amp;&amp; !defined(CONFIG_CRYPTO_HMAC_MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_do_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;This kernel was build without CONFIG_CRYPTO_HMAC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;You need to disable &#39;cram-hmac-alg&#39; in drbd.conf.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define CHALLENGE_LEN 64</span>

<span class="cm">/* Return value:</span>
<span class="cm">	1 - auth succeeded,</span>
<span class="cm">	0 - failed, try again (network error),</span>
<span class="cm">	-1 - auth failed, don&#39;t try again.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_do_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">my_challenge</span><span class="p">[</span><span class="n">CHALLENGE_LEN</span><span class="p">];</span>  <span class="cm">/* 64 Bytes... */</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">right_response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">peers_ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">shared_secret</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resp_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_desc</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">crypto_hash_setkey</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">shared_secret</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;crypto_hash_setkey() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">my_challenge</span><span class="p">,</span> <span class="n">CHALLENGE_LEN</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_send_cmd2</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_AUTH_CHALLENGE</span><span class="p">,</span> <span class="n">my_challenge</span><span class="p">,</span> <span class="n">CHALLENGE_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv_header</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">P_AUTH_CHALLENGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;expected AuthChallenge packet, received: %s (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">CHALLENGE_LEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;expected AuthChallenge payload too big.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">peers_ch</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peers_ch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;kmalloc of peers_ch failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">peers_ch</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short read AuthChallenge: l=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">resp_size</span> <span class="o">=</span> <span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span><span class="p">);</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">resp_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;kmalloc of response failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">peers_ch</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">crypto_hash_digest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;crypto_hash_digest() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_send_cmd2</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_AUTH_RESPONSE</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">resp_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv_header</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">P_AUTH_RESPONSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;expected AuthResponse packet, received: %s (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="n">resp_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;expected AuthResponse payload of wrong size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">response</span> <span class="p">,</span> <span class="n">resp_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="n">resp_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short read receiving AuthResponse: l=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">right_response</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">resp_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right_response</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;kmalloc of right_response failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_set_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">my_challenge</span><span class="p">,</span> <span class="n">CHALLENGE_LEN</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">crypto_hash_digest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">right_response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;crypto_hash_digest() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">right_response</span><span class="p">,</span> <span class="n">resp_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Peer authenticated using %d bytes of &#39;%s&#39; HMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">resp_size</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">cram_hmac_alg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">peers_ch</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">right_response</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">drbdd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">thi</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="s">&quot;drbd%d_receiver&quot;</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;receiver (re)started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">drbd_connect</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_disconnect</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Discarding network configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drbdd</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drbd_disconnect</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;receiver terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ********* acknowledge sender ******** */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_RqSReply</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_req_state_reply</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_req_state_reply</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">&gt;=</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CL_ST_CHG_SUCCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CL_ST_CHG_FAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Requested state change failed by peer: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">drbd_set_st_err_str</span><span class="p">(</span><span class="n">retcode</span><span class="p">),</span> <span class="n">retcode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_Ping</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drbd_send_ping_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_PingAck</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* restore idle timeout */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_int</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">GOT_PING_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_IsInSync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">blksize</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">89</span><span class="p">);</span>

	<span class="n">update_peer_seq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
		<span class="n">drbd_set_in_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
		<span class="cm">/* rs_same_csums is supposed to count in units of BM_BLOCK_SIZE */</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_same_csum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">blksize</span> <span class="o">&gt;&gt;</span> <span class="n">BM_BLOCK_SHIFT</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">blksize</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_in</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* when we receive the ACK for a write request,</span>
<span class="cm"> * verify that we actually know about it */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="nf">_ack_id_to_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">id</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">tl_hash_slot</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">collision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">!=</span> <span class="n">sector</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;_ack_id_to_req: found req %p but it has &quot;</span>
				    <span class="s">&quot;wrong sector (%llus versus %llus)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="p">(</span><span class="n">req_validator_fn</span><span class="p">)</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">id</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_req_change_req_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">id</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="n">req_validator_fn</span> <span class="n">validator</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_req_event</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_and_error</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">validator</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s: failed to find req %p, sector %llus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bio</span><span class="p">)</span>
		<span class="n">complete_master_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_BlockAck</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">blksize</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">drbd_req_event</span> <span class="n">what</span><span class="p">;</span>

	<span class="n">update_peer_seq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_syncer_block_id</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_set_in_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
		<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P_RS_WRITE_ACK</span>:
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_C</span><span class="p">);</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">write_acked_by_peer_and_sis</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_WRITE_ACK</span>:
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_C</span><span class="p">);</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">write_acked_by_peer</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_RECV_ACK</span>:
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_B</span><span class="p">);</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">recv_acked_by_peer</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_DISCARD_ACK</span>:
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_C</span><span class="p">);</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">conflict_discarded_by_peer</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">validate_req_change_req_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span>
		<span class="n">_ack_id_to_req</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">what</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_NegAck</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_and_error</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">update_peer_seq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_syncer_block_id</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_rs_failed_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">_ack_id_to_req</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_A</span> <span class="o">||</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Protocol A has no P_WRITE_ACKs, but has P_NEG_ACKs.</span>
<span class="cm">			   The master bio might already be completed, therefore the</span>
<span class="cm">			   request is no longer in the collision hash.</span>
<span class="cm">			   =&gt; Do not try to validate block_id as request. */</span>
			<span class="cm">/* In Protocol B we might already have got a P_RECV_ACK</span>
<span class="cm">			   but then get a P_NEG_ACK after wards. */</span>
			<span class="n">drbd_set_out_of_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s: failed to find req %p, sector %llus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">__req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">neg_acked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bio</span><span class="p">)</span>
		<span class="n">complete_master_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_NegDReply</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">update_peer_seq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Got NegDReply; Sector %llus, len %u; Fail original request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">validate_req_change_req_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span>
		<span class="n">_ar_id_to_req</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">neg_acked</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_NegRSDReply</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>

	<span class="n">update_peer_seq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>

	<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">P_NEG_RS_DREPLY</span>:
			<span class="n">drbd_rs_failed_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">P_RS_CANCEL</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_BarrierAck</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_barrier_ack</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_barrier_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>

	<span class="n">tl_release</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">set_size</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_AHEAD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_in_flight</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">AHEAD_TO_SYNC_SOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_OVResult</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>

	<span class="n">update_peer_seq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ID_OUT_OF_SYNC</span><span class="p">)</span>
		<span class="n">drbd_ov_oos_found</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ov_oos_print</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
	<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="o">--</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">;</span>

	<span class="cm">/* let&#39;s advance progress step marks only for every other megabyte */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="n">drbd_advance_rs_marks</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_ov_finished</span><span class="p">;</span>
			<span class="n">drbd_queue_work_front</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;kmalloc(w) failed.&quot;</span><span class="p">);</span>
			<span class="n">ov_oos_print</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_skip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">asender_cmd</span> <span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">pkt_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">process</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">asender_cmd</span> <span class="o">*</span><span class="nf">get_asender_cmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">asender_cmd</span> <span class="n">asender_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* anything missing from this table is in</span>
<span class="cm">		 * the drbd_cmd_handler (drbd_default_handler) table,</span>
<span class="cm">		 * see the beginning of drbdd() */</span>
	<span class="p">[</span><span class="n">P_PING</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">),</span> <span class="n">got_Ping</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_PING_ACK</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">),</span> <span class="n">got_PingAck</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_RECV_ACK</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_BlockAck</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_WRITE_ACK</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_BlockAck</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_RS_WRITE_ACK</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_BlockAck</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_DISCARD_ACK</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_BlockAck</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_NEG_ACK</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_NegAck</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_NEG_DREPLY</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_NegDReply</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_NEG_RS_DREPLY</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_NegRSDReply</span><span class="p">},</span>
	<span class="p">[</span><span class="n">P_OV_RESULT</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_OVResult</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_BARRIER_ACK</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_barrier_ack</span><span class="p">),</span> <span class="n">got_BarrierAck</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_STATE_CHG_REPLY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_req_state_reply</span><span class="p">),</span> <span class="n">got_RqSReply</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_RS_IS_IN_SYNC</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_IsInSync</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_DELAY_PROBE</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_delay_probe93</span><span class="p">),</span> <span class="n">got_skip</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">P_RS_CANCEL</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_block_ack</span><span class="p">),</span> <span class="n">got_NegRSDReply</span><span class="p">},</span>
	<span class="p">[</span><span class="n">P_MAX_CMD</span><span class="p">]</span>	    <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;</span> <span class="n">P_MAX_CMD</span> <span class="o">||</span> <span class="n">asender_tbl</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">process</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">asender_tbl</span><span class="p">[</span><span class="n">cmd</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_asender</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">thi</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">rbuf</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">h80</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asender_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span>    <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">expect</span>   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">empty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ping_timeout_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="s">&quot;drbd%d_asender&quot;</span><span class="p">,</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">));</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_RR</span><span class="p">;</span>  <span class="cm">/* Make this a realtime task! */</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">rt_priority</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>    <span class="cm">/* more important than all other tasks */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">get_t_state</span><span class="p">(</span><span class="n">thi</span><span class="p">)</span> <span class="o">==</span> <span class="n">Running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_thread_current_set_cpu</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">SEND_PING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ERR_IF</span><span class="p">(</span><span class="o">!</span><span class="n">drbd_send_ping</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_timeo</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
			<span class="n">ping_timeout_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* conditionally cork;</span>
<span class="cm">		 * it may hurt latency if we cork without much to send */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">no_cork</span> <span class="o">&amp;&amp;</span>
			<span class="mi">3</span> <span class="o">&lt;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unacked_cnt</span><span class="p">))</span>
			<span class="n">drbd_tcp_cork</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">SIGNAL_ASENDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_process_done_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>
			<span class="cm">/* to avoid race with newly queued ACKs */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">SIGNAL_ASENDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
			<span class="n">empty</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
			<span class="cm">/* new ack may have been queued right here,</span>
<span class="cm">			 * but then there is also a signal pending,</span>
<span class="cm">			 * and we start over... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">empty</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* but unconditionally uncork unless disabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">no_cork</span><span class="p">)</span>
			<span class="n">drbd_tcp_uncork</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>

		<span class="cm">/* short circuit, recv_msg would return EINTR anyways. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_recv_short</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span>
				     <span class="n">buf</span><span class="p">,</span> <span class="n">expect</span><span class="o">-</span><span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">SIGNAL_ASENDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

		<span class="cm">/* Note:</span>
<span class="cm">		 * -EINTR	 (on meta) we got a signal</span>
<span class="cm">		 * -EAGAIN	 (on meta) rcvtimeo expired</span>
<span class="cm">		 * -ECONNRESET	 other side closed the connection</span>
<span class="cm">		 * -ERESTARTSYS  (on data) we got a signal</span>
<span class="cm">		 * rv &lt;  0	 other than above: unexpected error!</span>
<span class="cm">		 * rv == expected: full header or command</span>
<span class="cm">		 * rv &lt;  expected: &quot;woken&quot; by signal during receive</span>
<span class="cm">		 * rv == 0	 : &quot;connection shut down by peer&quot;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">received</span> <span class="o">+=</span> <span class="n">rv</span><span class="p">;</span>
			<span class="n">buf</span>	 <span class="o">+=</span> <span class="n">rv</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;meta connection shut down by peer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If the data socket received something meanwhile,</span>
<span class="cm">			 * that is good enough: peer is still alive. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_received</span><span class="p">,</span>
				<span class="n">jiffies</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ping_timeout_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;PingAck did not arrive in time.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">SEND_PING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;sock_recvmsg returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">received</span> <span class="o">==</span> <span class="n">expect</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;magic?? on meta m: 0x%08x c: %d l: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">),</span>
				    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">),</span>
				    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">get_asender_cmd</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unknown command?? on meta m: 0x%08x c: %d l: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">),</span>
				    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">),</span>
				    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">disconnect</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">expect</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
			<span class="n">ERR_IF</span><span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">expect</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">received</span> <span class="o">==</span> <span class="n">expect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_received</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">reconnect</span><span class="p">;</span>

			<span class="cm">/* the idle_timeout (ping-int)</span>
<span class="cm">			 * has been restored in got_PingAck() */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">get_asender_cmd</span><span class="p">(</span><span class="n">P_PING_ACK</span><span class="p">))</span>
				<span class="n">ping_timeout_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">buf</span>	 <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
			<span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">expect</span>	 <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">);</span>
			<span class="n">cmd</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">reconnect:</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_NETWORK_FAILURE</span><span class="p">));</span>
		<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">disconnect:</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
		<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SIGNAL_ASENDER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;asender terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
