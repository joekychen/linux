<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › drbd › drbd_worker.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drbd_worker.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   drbd_worker.c</span>

<span class="cm">   This file is part of DRBD by Philipp Reisner and Lars Ellenberg.</span>

<span class="cm">   Copyright (C) 2001-2008, LINBIT Information Technologies GmbH.</span>
<span class="cm">   Copyright (C) 1999-2008, Philipp Reisner &lt;philipp.reisner@linbit.com&gt;.</span>
<span class="cm">   Copyright (C) 2002-2008, Lars Ellenberg &lt;lars.ellenberg@linbit.com&gt;.</span>

<span class="cm">   drbd is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm">   any later version.</span>

<span class="cm">   drbd is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with drbd; see the file COPYING.  If not, write to</span>
<span class="cm">   the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/drbd.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/memcontrol.h&gt;</span>
<span class="cp">#include &lt;linux/mm_inline.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &quot;drbd_int.h&quot;</span>
<span class="cp">#include &quot;drbd_req.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">w_make_ov_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w_make_resync_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">);</span>



<span class="cm">/* endio handlers:</span>
<span class="cm"> *   drbd_md_io_complete (defined here)</span>
<span class="cm"> *   drbd_endio_pri (defined here)</span>
<span class="cm"> *   drbd_endio_sec (defined here)</span>
<span class="cm"> *   bm_async_io_complete (defined in drbd_bitmap.c)</span>
<span class="cm"> *</span>
<span class="cm"> * For all these callbacks, note the following:</span>
<span class="cm"> * The callbacks will be called in irq context by the IDE drivers,</span>
<span class="cm"> * and in Softirqs/Tasklets/BH context by the SCSI drivers.</span>
<span class="cm"> * Try to get the locking right :)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cm">/* About the global_state_lock</span>
<span class="cm">   Each state transition on an device holds a read lock. In case we have</span>
<span class="cm">   to evaluate the sync after dependencies, we grab a write lock, because</span>
<span class="cm">   we need stable states on all devices for that.  */</span>
<span class="n">rwlock_t</span> <span class="n">global_state_lock</span><span class="p">;</span>

<span class="cm">/* used for synchronous meta data and bitmap IO</span>
<span class="cm"> * submitted by drbd_md_sync_page_io()</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_md_io_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_md_io</span> <span class="o">*</span><span class="n">md_io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>

	<span class="n">md_io</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_md_io</span> <span class="o">*</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="n">mdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">md_io</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_conf</span><span class="p">,</span> <span class="n">md_io</span><span class="p">);</span>

	<span class="n">md_io</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* We grabbed an extra reference in _drbd_md_sync_page_io() to be able</span>
<span class="cm">	 * to timeout on the lower level device, and eventually detach from it.</span>
<span class="cm">	 * If this io completion runs after that timeout expired, this</span>
<span class="cm">	 * drbd_md_put_buffer() may allow us to finally try and re-attach.</span>
<span class="cm">	 * During normal operation, this only puts that extra reference</span>
<span class="cm">	 * down to 1 again.</span>
<span class="cm">	 * Make sure we first drop the reference, and only then signal</span>
<span class="cm">	 * completion, or we may (in drbd_al_read_log()) cycle so fast into the</span>
<span class="cm">	 * next drbd_md_sync_page_io(), that we trigger the</span>
<span class="cm">	 * ASSERT(atomic_read(&amp;mdev-&gt;md_io_in_use) == 1) there.</span>
<span class="cm">	 */</span>
	<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">md_io</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* reads on behalf of the partner,</span>
<span class="cm"> * &quot;submitted&quot; by the receiver</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_endio_read_sec_final</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="n">__releases</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span> <span class="o">!=</span> <span class="n">ID_VACANT</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">+=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__EE_WAS_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">__drbd_chk_io_error</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* writes on behalf of the partner, or resync writes,</span>
<span class="cm"> * &quot;submitted&quot; by the receiver, final stage.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_endio_write_sec_final</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="n">__releases</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">e_sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_wake</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_syncer_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_al_complete_io</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span> <span class="o">!=</span> <span class="n">ID_VACANT</span><span class="p">);</span>

	<span class="cm">/* after we moved e to done_ee,</span>
<span class="cm">	 * we may no longer access it,</span>
<span class="cm">	 * it may be freed/reused already!</span>
<span class="cm">	 * (as soon as we release the req_lock) */</span>
	<span class="n">e_sector</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="n">do_al_complete_io</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_CALL_AL_COMPLETE_IO</span><span class="p">;</span>
	<span class="n">is_syncer_req</span> <span class="o">=</span> <span class="n">is_syncer_block_id</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">writ_cnt</span> <span class="o">+=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span> <span class="cm">/* has been on active_ee or sync_ee */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">);</span>

	<span class="cm">/* No hlist_del_init(&amp;e-&gt;collision) here, we did not send the Ack yet,</span>
<span class="cm">	 * neither did we wake possibly waiting conflicting requests.</span>
<span class="cm">	 * done from &quot;drbd_process_done_ee&quot; within the appropriate w.cb</span>
<span class="cm">	 * (e_end_block/e_end_resync_block) or from _drbd_clear_done_ee */</span>

	<span class="n">do_wake</span> <span class="o">=</span> <span class="n">is_syncer_req</span>
		<span class="o">?</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__EE_WAS_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">__drbd_chk_io_error</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_syncer_req</span><span class="p">)</span>
		<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e_sector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_wake</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_al_complete_io</span><span class="p">)</span>
		<span class="n">drbd_al_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e_sector</span><span class="p">);</span>

	<span class="n">wake_asender</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* writes on behalf of the partner, or resync writes,</span>
<span class="cm"> * &quot;submitted&quot; by the receiver.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_endio_sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">bio_flagged</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">BIO_UPTODATE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_write</span> <span class="o">=</span> <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s: error=%d s=%llus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">is_write</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s: setting error to -EIO s=%llus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">is_write</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="cm">/* strange behavior of some lower level drivers...</span>
<span class="cm">		 * fail the request by clearing the uptodate flag,</span>
<span class="cm">		 * but do not return any error?! */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">__EE_WAS_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span> <span class="cm">/* no need for the bio anymore */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">pending_bios</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_write</span><span class="p">)</span>
			<span class="n">drbd_endio_write_sec_final</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">drbd_endio_read_sec_final</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* read, readA or write requests on R_PRIMARY coming from drbd_make_request</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_endio_pri</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_and_error</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_req_event</span> <span class="n">what</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">bio_flagged</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">BIO_UPTODATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;p %s: setting error to -EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
		<span class="cm">/* strange behavior of some lower level drivers...</span>
<span class="cm">		 * fail the request by clearing the uptodate flag,</span>
<span class="cm">		 * but do not return any error?! */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* to avoid recursion in __req_mod */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">write_completed_with_error</span>
			<span class="o">:</span> <span class="p">(</span><span class="n">bio_rw</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
			  <span class="o">?</span> <span class="n">read_completed_with_error</span>
			  <span class="o">:</span> <span class="n">read_ahead_completed_with_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">completed_ok</span><span class="p">;</span>

	<span class="n">bio_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">private_bio</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">private_bio</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>

	<span class="cm">/* not req_mod(), we need irqsave here! */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bio</span><span class="p">)</span>
		<span class="n">complete_master_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_read_retry_remote</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="cm">/* We should not detach for read io-error,</span>
<span class="cm">	 * but try to WRITE the P_DATA_REPLY to the failed location,</span>
<span class="cm">	 * to give the disk the chance to relocate that block */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cancel</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">!=</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">read_retry_remote_canceled</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">w_send_read_req</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_csum_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">digest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_desc</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">tfm</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">crypto_hash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">page_chain_next</span><span class="p">(</span><span class="n">page</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* all but the last page will be fully used */</span>
		<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">crypto_hash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* and now the last, possibly only partially used page */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span> <span class="o">?:</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">crypto_hash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">crypto_hash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_csum_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">digest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_desc</span> <span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">tfm</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">crypto_hash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">);</span>
		<span class="n">crypto_hash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">crypto_hash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TODO merge common code with w_e_end_ov_req */</span>
<span class="kt">int</span> <span class="nf">w_e_send_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">digest_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">digest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span> <span class="o">==</span> <span class="n">DRBD_MAGIC</span> <span class="o">+</span> <span class="mh">0xbeef</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">digest_size</span> <span class="o">=</span> <span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">);</span>
	<span class="n">digest</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">digest_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">digest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">drbd_csum_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>
		<span class="cm">/* Free e and pages before send.</span>
<span class="cm">		 * In case we block on congestion, we could otherwise run into</span>
<span class="cm">		 * some distributed deadlock, if the other side blocks on</span>
<span class="cm">		 * congestion as well, because our receiver blocks in</span>
<span class="cm">		 * drbd_pp_alloc due to pp_in_use &gt; max_buffers. */</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">inc_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_drequest_csum</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					     <span class="n">digest</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">,</span>
					     <span class="n">P_CSUM_RS_REQUEST</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">digest</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;kmalloc() of digest failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_send_drequest(..., csum) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define GFP_TRY	(__GFP_HIGHMEM | __GFP_NOWARN)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_for_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_rs_should_slow_down</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">defer</span><span class="p">;</span>

	<span class="cm">/* GFP_TRY, because if there is no memory available right now, this may</span>
<span class="cm">	 * be rescheduled for later. It is &quot;only&quot; background resync, after all. */</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">drbd_alloc_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">DRBD_MAGIC</span><span class="o">+</span><span class="mh">0xbeef</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_TRY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">defer</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_e_send_csum</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_ev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_submit_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="n">DRBD_FAULT_RS_RD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If it failed because of ENOMEM, retry should help.  If it failed</span>
<span class="cm">	 * because bio_add_page failed (probably broken lower level driver),</span>
<span class="cm">	 * retry may or may not help.</span>
<span class="cm">	 * If it does not, you may need to force disconnect. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="nl">defer:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_resync_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C_VERIFY_S</span>:
		<span class="n">w_make_ov_request</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">cancel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_SYNC_TARGET</span>:
		<span class="n">w_make_resync_request</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">cancel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">resync_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">.</span><span class="n">list</span><span class="p">))</span>
		<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fifo_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo_buffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fifo_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo_buffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ov</span><span class="p">;</span>

	<span class="n">ov</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">head_index</span><span class="p">];</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">head_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">head_index</span> <span class="o">&gt;=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">head_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ov</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fifo_add_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo_buffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_rs_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sect_in</span><span class="p">;</span>  <span class="cm">/* Number of sectors that came in since the last turn */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">want</span><span class="p">;</span>     <span class="cm">/* The number of sectors we want in the proxy */</span>
	<span class="kt">int</span> <span class="n">req_sect</span><span class="p">;</span> <span class="cm">/* Number of sectors to request in this turn */</span>
	<span class="kt">int</span> <span class="n">correction</span><span class="p">;</span> <span class="cm">/* Number of sectors more we need in the proxy*/</span>
	<span class="kt">int</span> <span class="n">cps</span><span class="p">;</span> <span class="cm">/* correction per invocation of drbd_rs_controller() */</span>
	<span class="kt">int</span> <span class="n">steps</span><span class="p">;</span> <span class="cm">/* Number of time steps to plan ahead */</span>
	<span class="kt">int</span> <span class="n">curr_corr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sect</span><span class="p">;</span>

	<span class="n">sect_in</span> <span class="o">=</span> <span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Number of sectors that came in */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_in_flight</span> <span class="o">-=</span> <span class="n">sect_in</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span> <span class="cm">/* get an atomic view on mdev-&gt;rs_plan_s */</span>

	<span class="n">steps</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="cm">/* (mdev-&gt;sync_conf.c_plan_ahead * 10 * SLEEP_TIME) / HZ; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_in_flight</span> <span class="o">+</span> <span class="n">sect_in</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* At start of resync */</span>
		<span class="n">want</span> <span class="o">=</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">rate</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SLEEP_TIME</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">*</span> <span class="n">steps</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* normal path */</span>
		<span class="n">want</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_fill_target</span> <span class="o">?</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_fill_target</span> <span class="o">:</span>
			<span class="n">sect_in</span> <span class="o">*</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_delay_target</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="p">(</span><span class="n">SLEEP_TIME</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">correction</span> <span class="o">=</span> <span class="n">want</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_in_flight</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_planed</span><span class="p">;</span>

	<span class="cm">/* Plan ahead */</span>
	<span class="n">cps</span> <span class="o">=</span> <span class="n">correction</span> <span class="o">/</span> <span class="n">steps</span><span class="p">;</span>
	<span class="n">fifo_add_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">,</span> <span class="n">cps</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_planed</span> <span class="o">+=</span> <span class="n">cps</span> <span class="o">*</span> <span class="n">steps</span><span class="p">;</span>

	<span class="cm">/* What we do in this step */</span>
	<span class="n">curr_corr</span> <span class="o">=</span> <span class="n">fifo_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_planed</span> <span class="o">-=</span> <span class="n">curr_corr</span><span class="p">;</span>

	<span class="n">req_sect</span> <span class="o">=</span> <span class="n">sect_in</span> <span class="o">+</span> <span class="n">curr_corr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_sect</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">req_sect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">max_sect</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">c_max_rate</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SLEEP_TIME</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_sect</span> <span class="o">&gt;</span> <span class="n">max_sect</span><span class="p">)</span>
		<span class="n">req_sect</span> <span class="o">=</span> <span class="n">max_sect</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	dev_warn(DEV, &quot;si=%u if=%d wa=%u co=%d st=%d cps=%d pl=%d cc=%d rs=%d\n&quot;,</span>
<span class="cm">		 sect_in, mdev-&gt;rs_in_flight, want, correction,</span>
<span class="cm">		 steps, cps, mdev-&gt;rs_planed, curr_corr, req_sect);</span>
<span class="cm">	*/</span>

	<span class="k">return</span> <span class="n">req_sect</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_rs_number_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* mdev-&gt;sync_conf.c_plan_ahead */</span>
		<span class="n">number</span> <span class="o">=</span> <span class="n">drbd_rs_controller</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">BM_BLOCK_SHIFT</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">c_sync_rate</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="p">(</span><span class="n">BM_BLOCK_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="n">SLEEP_TIME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">c_sync_rate</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>
		<span class="n">number</span> <span class="o">=</span> <span class="n">SLEEP_TIME</span> <span class="o">*</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">c_sync_rate</span>  <span class="o">/</span> <span class="p">((</span><span class="n">BM_BLOCK_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ignore the amount of pending requests, the resync controller should</span>
<span class="cm">	 * throttle down to incoming reply rate soon enough anyways. */</span>
	<span class="k">return</span> <span class="n">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_make_resync_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">sector_t</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_bio_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="n">rollback_i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">align</span><span class="p">,</span> <span class="n">queued</span><span class="p">,</span> <span class="n">sndbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* empty resync? */</span>
		<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Since we only need to access mdev-&gt;rsync a</span>
<span class="cm">		   get_ldev_if_state(mdev,D_FAILED) would be sufficient, but</span>
<span class="cm">		   to continue resync with a broken disk makes no sense at</span>
<span class="cm">		   all */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Disk broke down during resync!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_bio_size</span> <span class="o">=</span> <span class="n">queue_max_hw_sectors</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rq_queue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">number</span> <span class="o">=</span> <span class="n">drbd_rs_number_requests</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stop generating RS requests, when half of the send buffer is filled */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queued</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wmem_queued</span><span class="p">;</span>
			<span class="n">sndbuf</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sndbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queued</span> <span class="o">&gt;</span> <span class="n">sndbuf</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>

<span class="nl">next_sector:</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">BM_BLOCK_SIZE</span><span class="p">;</span>
		<span class="n">bit</span>  <span class="o">=</span> <span class="n">drbd_bm_find_next</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="n">DRBD_END_OF_BITMAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sector</span> <span class="o">=</span> <span class="n">BM_BIT_TO_SECT</span><span class="p">(</span><span class="n">bit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_rs_should_slow_down</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">drbd_try_rs_begin_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">drbd_bm_test_bit</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_sector</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#if DRBD_MAX_BIO_SIZE &gt; BM_BLOCK_SIZE</span>
		<span class="cm">/* try to find some adjacent bits.</span>
<span class="cm">		 * we stop if we have already the maximum req size.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Additionally always align bigger requests, in order to</span>
<span class="cm">		 * be prepared for all stripe sizes of software RAIDs.</span>
<span class="cm">		 */</span>
		<span class="n">align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rollback_i</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">BM_BLOCK_SIZE</span> <span class="o">&gt;</span> <span class="n">max_bio_size</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Be always aligned */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">align</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* do not cross extent boundaries */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">bit</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_BLOCKS_PER_BM_EXT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* now, is it actually dirty, after all?</span>
<span class="cm">			 * caution, drbd_bm_test_bit is tri-state for some</span>
<span class="cm">			 * obscure reason; ( b == 0 ) would get the out-of-band</span>
<span class="cm">			 * only accidentally right because of the &quot;oddly sized&quot;</span>
<span class="cm">			 * adjustment below */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_test_bit</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bit</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">bit</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">BM_BLOCK_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">BM_BLOCK_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">align</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span>
				<span class="n">align</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* if we merged some,</span>
<span class="cm">		 * reset the offset to start the next drbd_bm_find_next from */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">BM_BLOCK_SIZE</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* adjust very last sectors, in case we are oddly sized */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span><span class="o">-</span><span class="n">sector</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">89</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">read_for_csum</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>: <span class="cm">/* Disk failure */</span>
				<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>: <span class="cm">/* allocation failed, or ldev busy */</span>
				<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">rollback_i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="cm">/* everything ok */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">inc_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_send_drequest</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_RS_DATA_REQUEST</span><span class="p">,</span>
					       <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ID_SYNCER</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_send_drequest() failed, aborting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">&gt;=</span> <span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* last syncer _request_ was sent,</span>
<span class="cm">		 * but the P_RS_DATA_REPLY not yet received.  sync will end (and</span>
<span class="cm">		 * next sync group will resume), as soon as we receive the last</span>
<span class="cm">		 * resync data block, and the last bit is cleared.</span>
<span class="cm">		 * until then resync &quot;work&quot; is &quot;inactive&quot; ...</span>
<span class="cm">		 */</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">requeue:</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_in_flight</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BM_BLOCK_SHIFT</span> <span class="o">-</span> <span class="mi">9</span><span class="p">));</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SLEEP_TIME</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_make_ov_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">sector_t</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">number</span> <span class="o">=</span> <span class="n">drbd_rs_number_requests</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_position</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">capacity</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">BM_BLOCK_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_rs_should_slow_down</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">drbd_try_rs_begin_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_position</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span><span class="o">-</span><span class="n">sector</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">;</span>

		<span class="n">inc_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_send_ov_request</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sector</span> <span class="o">+=</span> <span class="n">BM_SECT_PER_BIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_position</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>

 <span class="nl">requeue:</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_in_flight</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BM_BLOCK_SHIFT</span> <span class="o">-</span> <span class="mi">9</span><span class="p">));</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SLEEP_TIME</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">start_resync_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_start_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unacked_cnt</span><span class="p">)</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_pending_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;w_start_resync later...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_timer</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drbd_start_resync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">C_SYNC_SOURCE</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AHEAD_TO_SYNC_SOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_ov_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="n">ov_oos_print</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_resync_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

	<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ping_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GOT_PING_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">request_ping</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span>
		   <span class="n">test_bit</span><span class="p">(</span><span class="n">GOT_PING_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_resync_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">db</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dbdt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n_oos</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">khelper_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">verify_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Remove all elements from the resync LRU. Since future actions</span>
<span class="cm">	 * might set bits in the (main) bitmap, then the entries in the</span>
<span class="cm">	 * resync LRU would be wrong. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_rs_del_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* In case this is not possible now, most probably because</span>
<span class="cm">		 * there are P_RS_DATA_REPLY Packets lingering on the worker&#39;s</span>
<span class="cm">		 * queue (or even the read operations for those packets</span>
<span class="cm">		 * is not finished by now).   Retry in 100ms. */</span>

		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_resync_finished</span><span class="p">;</span>
			<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Warn failed to drbd_rs_del_all() and to kmalloc(w).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_start</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_paused</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">db</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span><span class="p">;</span>
	<span class="n">dbdt</span> <span class="o">=</span> <span class="n">Bit2KB</span><span class="p">(</span><span class="n">db</span><span class="o">/</span><span class="n">dt</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_paused</span> <span class="o">/=</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ping_peer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="n">verify_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">);</span>

	<span class="cm">/* This protects us against multiple calls (that can happen in the presence</span>
<span class="cm">	   of application IO), and against connectivity loss just before we arrive here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">os</span><span class="p">;</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_CONNECTED</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s done (total %lu sec; paused %lu sec; %lu K/sec)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">verify_done</span> <span class="o">?</span> <span class="s">&quot;Online verify &quot;</span> <span class="o">:</span> <span class="s">&quot;Resync&quot;</span><span class="p">,</span>
	     <span class="n">dt</span> <span class="o">+</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_paused</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_paused</span><span class="p">,</span> <span class="n">dbdt</span><span class="p">);</span>

	<span class="n">n_oos</span> <span class="o">=</span> <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n_oos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Online verify found %lu %dk block out of sync!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">n_oos</span><span class="p">,</span> <span class="n">Bit2KB</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">khelper_cmd</span> <span class="o">=</span> <span class="s">&quot;out-of-sync&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_ASSERT</span><span class="p">((</span><span class="n">n_oos</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span>
			<span class="n">khelper_cmd</span> <span class="o">=</span> <span class="s">&quot;after-resync-target&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_same_csum</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">ratio</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>     <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">s</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="n">t</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">100</span><span class="p">));</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%u %% had equal checksums, eliminated: %luK; &quot;</span>
			     <span class="s">&quot;transferred %luK total %luK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ratio</span><span class="p">,</span>
			     <span class="n">Bit2KB</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_same_csum</span><span class="p">),</span>
			     <span class="n">Bit2KB</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_same_csum</span><span class="p">),</span>
			     <span class="n">Bit2KB</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;            %lu failed blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_BITMAP</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UI_HISTORY_END</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_BITMAP</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]);</span>
				<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_CURRENT</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;mdev-&gt;p_uuid is NULL! BUG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* for verify runs, we don&#39;t update uuids here,</span>
<span class="cm">			 * so there would be nothing to report. */</span>
			<span class="n">drbd_uuid_set_bm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">);</span>
			<span class="n">drbd_print_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;updated UUIDs&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Now the two UUID sets are equal, update what we</span>
<span class="cm">				 * know of the peer. */</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_CURRENT</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UI_HISTORY_END</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_paused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verify_done</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">khelper_cmd</span><span class="p">)</span>
		<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">khelper_cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* helper */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">move_to_net_ee_or_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_ee_has_active_page</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This might happen if sendpage() has not finished */</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use_by_net</span><span class="p">);</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_ee</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * w_e_end_data_req() - Worker callback, to send a P_DATA_REPLY packet in response to a P_DATA_REQUEST</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @w:		work object.</span>
<span class="cm"> * @cancel:	The connection will be closed anyways</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">w_e_end_data_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_DATA_REPLY</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Sending NegDReply. sector=%llus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_DREPLY</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">move_to_net_ee_or_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_send_block() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * w_e_end_rsdata_req() - Worker callback to send a P_RS_DATA_REPLY packet in response to a P_RS_DATA_REQUESTRS</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @w:		work object.</span>
<span class="cm"> * @cancel:	The connection will be closed anyways</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">w_e_end_rsdata_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_AHEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_RS_CANCEL</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;=</span> <span class="n">D_INCONSISTENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">inc_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_RS_DATA_REPLY</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Not sending RSDataReply, &quot;</span>
				    <span class="s">&quot;partner DISKLESS!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Sending NegRSDReply. sector %llus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_RS_DREPLY</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

		<span class="cm">/* update resync data with failure */</span>
		<span class="n">drbd_rs_failed_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">move_to_net_ee_or_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_send_block() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_e_end_csum_rs_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">digest_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">digest_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">digest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="n">eq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* quick hack to try to avoid a race against reconfiguration.</span>
<span class="cm">		 * a real fix would be much more involved,</span>
<span class="cm">		 * introducing more locking mechanisms */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">digest_size</span> <span class="o">=</span> <span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">);</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">digest_size</span> <span class="o">==</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">digest_size</span><span class="p">);</span>
			<span class="n">digest</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">digest_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_csum_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>
			<span class="n">eq</span> <span class="o">=</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">digest</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_set_in_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="cm">/* rs_same_csums unit is BM_BLOCK_SIZE */</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_same_csum</span> <span class="o">+=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">BM_BLOCK_SHIFT</span><span class="p">;</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_RS_IS_IN_SYNC</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">inc_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">ID_SYNCER</span><span class="p">;</span> <span class="cm">/* By setting block_id, digest pointer becomes invalid! */</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EE_HAS_DIGEST</span><span class="p">;</span> <span class="cm">/* This e no longer has a digest pointer */</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_block</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_RS_DATA_REPLY</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_NEG_RS_DREPLY</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Sending NegDReply. I guess it gets messy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">move_to_net_ee_or_free</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_send_block/ack() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO merge common code with w_e_send_csum */</span>
<span class="kt">int</span> <span class="nf">w_e_end_ov_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">digest_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">digest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">digest_size</span> <span class="o">=</span> <span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span><span class="p">);</span>
	<span class="n">digest</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">digest_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">digest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* terminate the connection in case the allocation failed */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)))</span>
		<span class="n">drbd_csum_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">);</span>

	<span class="cm">/* Free e and pages before send.</span>
<span class="cm">	 * In case we block on congestion, we could otherwise run into</span>
<span class="cm">	 * some distributed deadlock, if the other side blocks on</span>
<span class="cm">	 * congestion as well, because our receiver blocks in</span>
<span class="cm">	 * drbd_pp_alloc due to pp_in_use &gt; max_buffers. */</span>
	<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">inc_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_drequest_csum</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				     <span class="n">digest</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">,</span>
				     <span class="n">P_OV_REPLY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span>
		<span class="n">dec_rs_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">digest</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_ov_oos_found</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_last_oos_start</span> <span class="o">+</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_last_oos_size</span> <span class="o">==</span> <span class="n">sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_last_oos_size</span> <span class="o">+=</span> <span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_last_oos_start</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_last_oos_size</span> <span class="o">=</span> <span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">drbd_set_out_of_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_e_end_ov_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">digest_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">digest</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">digest_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="n">eq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
		<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* after &quot;cancel&quot;, because after drbd_disconnect/drbd_rs_cancel_all</span>
<span class="cm">	 * the resync lru has been cleaned up already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_rs_complete_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EE_WAS_ERROR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">digest_size</span> <span class="o">=</span> <span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span><span class="p">);</span>
		<span class="n">digest</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">digest_size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_csum_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>

			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">digest_size</span> <span class="o">==</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">digest_size</span><span class="p">);</span>
			<span class="n">eq</span> <span class="o">=</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">digest</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

		<span class="cm">/* Free e and pages before send.</span>
<span class="cm">		 * In case we block on congestion, we could otherwise run into</span>
<span class="cm">		 * some distributed deadlock, if the other side blocks on</span>
<span class="cm">		 * congestion as well, because our receiver blocks in</span>
<span class="cm">		 * drbd_pp_alloc due to pp_in_use &gt; max_buffers. */</span>
	<span class="n">drbd_free_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eq</span><span class="p">)</span>
		<span class="n">drbd_ov_oos_found</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ov_oos_print</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_ack_ex</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_OV_RESULT</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			      <span class="n">eq</span> <span class="o">?</span> <span class="n">ID_IN_SYNC</span> <span class="o">:</span> <span class="n">ID_OUT_OF_SYNC</span><span class="p">);</span>

	<span class="n">dec_unacked</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="o">--</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">;</span>

	<span class="cm">/* let&#39;s advance progress step marks only for every other megabyte */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="n">drbd_advance_rs_marks</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ov_oos_print</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_prev_work_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_wq_barrier</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_wq_barrier</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_send_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_tl_epoch</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_tl_epoch</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">p_barrier</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sbuf</span><span class="p">.</span><span class="n">barrier</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* really avoid racing with tl_clear.  w.cb may have been referenced</span>
<span class="cm">	 * just before it was reassigned and re-queued, so double check that.</span>
<span class="cm">	 * actually, this race was harmless, since we only try to send the</span>
<span class="cm">	 * barrier packet here, and otherwise do nothing with the object.</span>
<span class="cm">	 * but compare with the head of w_clear_epoch */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">!=</span> <span class="n">w_send_barrier</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">cancel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cancel</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_get_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">br_number</span><span class="p">;</span>
	<span class="cm">/* inc_ap_pending was done where this was queued.</span>
<span class="cm">	 * dec_ap_pending will be done in got_BarrierAck</span>
<span class="cm">	 * or (on connection loss) in w_clear_epoch.  */</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">P_BARRIER</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">drbd_put_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_send_write_hint</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cancel</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">drbd_send_short_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_UNPLUG_REMOTE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_send_oos</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">send_canceled</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_oos</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">oos_handed_to_network</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * w_send_dblock() - Worker callback to send a P_DATA packet in order to mirror a write request</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @w:		work object.</span>
<span class="cm"> * @cancel:	The connection will be closed anyways</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">w_send_dblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">send_canceled</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_dblock</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ok</span> <span class="o">?</span> <span class="n">handed_over_to_network</span> <span class="o">:</span> <span class="n">send_failed</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * w_send_read_req() - Worker callback to send a read request (P_DATA_REQUEST) packet</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @w:		work object.</span>
<span class="cm"> * @cancel:	The connection will be closed anyways</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">w_send_read_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cancel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">send_canceled</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_drequest</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">P_DATA_REQUEST</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ?? we set C_TIMEOUT or C_BROKEN_PIPE in drbd_send();</span>
<span class="cm">		 * so this is probably redundant */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_NETWORK_FAILURE</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ok</span> <span class="o">?</span> <span class="n">handed_over_to_network</span> <span class="o">:</span> <span class="n">send_failed</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w_restart_disk_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cancel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_state</span> <span class="o">&amp;</span> <span class="n">RQ_IN_ACT_LOG</span><span class="p">)</span>
		<span class="n">drbd_al_begin_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="cm">/* Calling drbd_al_begin_io() out of the worker might deadlocks</span>
<span class="cm">	   theoretically. Practically it can not deadlock, since this is</span>
<span class="cm">	   only used when unfreezing IOs. All the extents of the requests</span>
<span class="cm">	   that made it into the TL are already active */</span>

	<span class="n">drbd_req_make_private_bio</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">private_bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">;</span>
	<span class="n">generic_make_request</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">private_bio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_may_sync_now</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">odev</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">after</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">odev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">after</span><span class="p">);</span>
		<span class="n">ERR_IF</span><span class="p">(</span><span class="o">!</span><span class="n">odev</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span>
		     <span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">||</span> <span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">||</span>
		    <span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">user_isp</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _drbd_pause_after() - Pause resync on all devices that may not resync now</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Called from process context only (admin command and after_state_ch).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_pause_after</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">odev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">minor_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">odev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span> <span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_drbd_may_sync_now</span><span class="p">(</span><span class="n">odev</span><span class="p">))</span>
			<span class="n">rv</span> <span class="o">|=</span> <span class="p">(</span><span class="n">__drbd_set_state</span><span class="p">(</span><span class="n">_NS</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span> <span class="n">aftr_isp</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">CS_HARD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
			       <span class="o">!=</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _drbd_resume_next() - Resume resync on all devices that may resync now</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Called from process context only (admin command and worker).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_resume_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">odev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">minor_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">odev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span> <span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">aftr_isp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">_drbd_may_sync_now</span><span class="p">(</span><span class="n">odev</span><span class="p">))</span>
				<span class="n">rv</span> <span class="o">|=</span> <span class="p">(</span><span class="n">__drbd_set_state</span><span class="p">(</span><span class="n">_NS</span><span class="p">(</span><span class="n">odev</span><span class="p">,</span> <span class="n">aftr_isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
							<span class="n">CS_HARD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
				       <span class="o">!=</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">resume_next_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
	<span class="n">_drbd_resume_next</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">suspend_other_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
	<span class="n">_drbd_pause_after</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sync_after_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">o_minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">odev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">o_minor</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">o_minor</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">o_minor</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_SYNC_AFTER</span><span class="p">;</span>

	<span class="cm">/* check for loops */</span>
	<span class="n">odev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">o_minor</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odev</span> <span class="o">==</span> <span class="n">mdev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_SYNC_AFTER_CYCLE</span><span class="p">;</span>

		<span class="cm">/* dependency chain ends here, no cycles. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">after</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span>

		<span class="cm">/* follow the dependency chain */</span>
		<span class="n">odev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">after</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_alter_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">na</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retcode</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
	<span class="n">retcode</span> <span class="o">=</span> <span class="n">sync_after_error</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">na</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">after</span> <span class="o">=</span> <span class="n">na</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">changes</span>  <span class="o">=</span> <span class="n">_drbd_pause_after</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">_drbd_resume_next</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">changes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_rs_controller_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_in_flight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_planed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
	<span class="n">fifo_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_start_resync() - Start the resync process</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @side:	Either C_SYNC_SOURCE or C_SYNC_TARGET</span>
<span class="cm"> *</span>
<span class="cm"> * This function might bring you directly into one of the</span>
<span class="cm"> * C_PAUSED_SYNC_* states.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_start_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_conns</span> <span class="n">side</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_AHEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Resync already running!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_AHEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In case a previous resync run was aborted by an IO error/detach on the peer. */</span>
		<span class="n">drbd_rs_cancel_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="cm">/* This should be done when we abort the resync. We definitely do not</span>
<span class="cm">		   want to have this for connections going back and forth between</span>
<span class="cm">		   Ahead/Behind and SyncSource/SyncTarget */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Since application IO was locked out during C_WF_BITMAP_T and</span>
<span class="cm">		   C_WF_SYNC_UUID we are still unmodified. Before going to C_SYNC_TARGET</span>
<span class="cm">		   we check that we might make the data inconsistent. */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;before-resync-target&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;before-resync-target handler returned %d, &quot;</span>
			     <span class="s">&quot;dropping connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* C_SYNC_SOURCE */</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;before-resync-source&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;before-resync-source handler returned %d, &quot;</span>
					 <span class="s">&quot;ignoring. Old userland tools?&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;before-resync-source handler returned %d, &quot;</span>
					 <span class="s">&quot;dropping connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
				<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drbd_state_lock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_NEGOTIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>
		<span class="n">drbd_state_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>

	<span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">=</span> <span class="o">!</span><span class="n">_drbd_may_sync_now</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">side</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* side == C_SYNC_SOURCE */</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">__drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">SS_UNKNOWN_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tw</span> <span class="o">=</span> <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_paused</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_same_csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_sect_ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span>     <span class="o">=</span> <span class="n">tw</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_start</span>     <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRBD_SYNC_MARKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">_drbd_pause_after</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Began resync as %s (will sync %lu KB [%lu bits set]).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span><span class="p">),</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BM_BLOCK_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_resync_fo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Since protocol 96, we must serialize drbd_gen_and_send_sync_uuid</span>
<span class="cm">		 * with w_send_oos, or the sync target will get confused as to</span>
<span class="cm">		 * how much bits to resync.  We cannot do that always, because for an</span>
<span class="cm">		 * empty resync and protocol &lt; 95, we need to do it here, as we call</span>
<span class="cm">		 * drbd_resync_finished from here in that case.</span>
<span class="cm">		 * We drbd_gen_and_send_sync_uuid here for protocol &lt; 96,</span>
<span class="cm">		 * and from after_state_ch otherwise. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">96</span><span class="p">)</span>
			<span class="n">drbd_gen_and_send_sync_uuid</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">95</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This still has a race (about when exactly the peers</span>
<span class="cm">			 * detect connection loss) that can lead to a full sync</span>
<span class="cm">			 * on next handshake. In 8.3.9 we fixed this with explicit</span>
<span class="cm">			 * resync-finished notifications, but the fix</span>
<span class="cm">			 * introduces a protocol change.  Sleeping for some</span>
<span class="cm">			 * time longer than the ping interval + timeout on the</span>
<span class="cm">			 * SyncSource, to give the SyncTarget the chance to</span>
<span class="cm">			 * detect connection loss, then waiting for a ping</span>
<span class="cm">			 * response (implicit in drbd_resync_finished) reduces</span>
<span class="cm">			 * the race considerably, but does not solve it. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span><span class="p">)</span>
				<span class="n">schedule_timeout_interruptible</span><span class="p">(</span>
					<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_int</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">+</span>
					<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_timeo</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">9</span><span class="p">);</span>
			<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">drbd_rs_controller_reset</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="cm">/* ns.conn may already be != mdev-&gt;state.conn,</span>
<span class="cm">		 * we may have been paused in between, or become paused until</span>
<span class="cm">		 * the timer triggers.</span>
<span class="cm">		 * No matter, that is handled in resync_timer_fn() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

		<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_state_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">thi</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">work_list</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="s">&quot;drbd%d_worker&quot;</span><span class="p">,</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">get_t_state</span><span class="p">(</span><span class="n">thi</span><span class="p">)</span> <span class="o">==</span> <span class="n">Running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_thread_current_set_cpu</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">no_cork</span><span class="p">)</span>
				<span class="n">drbd_tcp_uncork</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

			<span class="n">intr</span> <span class="o">=</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span>  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">no_cork</span><span class="p">)</span>
				<span class="n">drbd_tcp_cork</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">);</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">ERR_IF</span> <span class="p">(</span><span class="n">get_t_state</span><span class="p">(</span><span class="n">thi</span><span class="p">)</span> <span class="o">==</span> <span class="n">Running</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_t_state</span><span class="p">(</span><span class="n">thi</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Running</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* With this break, we have done a down() but not consumed</span>
<span class="cm">		   the entry from the list. The cleanup code takes care of</span>
<span class="cm">		   this...   */</span>

		<span class="n">w</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>
		<span class="n">ERR_IF</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* something terribly wrong in our logic.</span>
<span class="cm">			 * we were able to down() the semaphore,</span>
<span class="cm">			 * but the list is empty... doh.</span>
<span class="cm">			 *</span>
<span class="cm">			 * what is the best thing to do now?</span>
<span class="cm">			 * try again from scratch, restarting the receiver,</span>
<span class="cm">			 * asender, whatnot? could break even more ugly,</span>
<span class="cm">			 * e.g. when we are primary, but no good local data.</span>
<span class="cm">			 *</span>
<span class="cm">			 * I&#39;ll try to get away just starting over this loop.</span>
<span class="cm">			 */</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* dev_warn(DEV, &quot;worker: a callback failed! \n&quot;); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
				<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span>
						<span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_NETWORK_FAILURE</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_DYING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONFIG_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">w</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">work_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* dead debugging code */</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* DANGEROUS race: if someone did queue his work within the spinlock,</span>
<span class="cm">	 * but up() ed outside the spinlock, we could get an up() on the</span>
<span class="cm">	 * semaphore without corresponding list entry.</span>
<span class="cm">	 * So don&#39;t do that.</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span><span class="p">);</span>
	<span class="cm">/* _drbd_set_state only uses stop_nowait.</span>
<span class="cm">	 * wait here for the Exiting receiver. */</span>
	<span class="n">drbd_thread_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">);</span>
	<span class="n">drbd_mdev_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;worker terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DEVICE_DYING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONFIG_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
