<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › drbd › drbd_nl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drbd_nl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   drbd_nl.c</span>

<span class="cm">   This file is part of DRBD by Philipp Reisner and Lars Ellenberg.</span>

<span class="cm">   Copyright (C) 2001-2008, LINBIT Information Technologies GmbH.</span>
<span class="cm">   Copyright (C) 1999-2008, Philipp Reisner &lt;philipp.reisner@linbit.com&gt;.</span>
<span class="cm">   Copyright (C) 2002-2008, Lars Ellenberg &lt;lars.ellenberg@linbit.com&gt;.</span>

<span class="cm">   drbd is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm">   any later version.</span>

<span class="cm">   drbd is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with drbd; see the file COPYING.  If not, write to</span>
<span class="cm">   the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/drbd.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/connector.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &quot;drbd_int.h&quot;</span>
<span class="cp">#include &quot;drbd_req.h&quot;</span>
<span class="cp">#include &quot;drbd_wrappers.h&quot;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;linux/drbd_tag_magic.h&gt;</span>
<span class="cp">#include &lt;linux/drbd_limits.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl_add_blob</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_tags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl_add_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_tags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl_add_int</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_tags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* see get_sb_bdev and bd_claim */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">drbd_m_holder</span> <span class="o">=</span> <span class="s">&quot;Hands off! this is DRBD&#39;s meta data device.&quot;</span><span class="p">;</span>

<span class="cm">/* Generate the tag_list to struct functions */</span>
<span class="cp">#define NL_PACKET(name, number, fields) \</span>
<span class="cp">static int name ## _from_tags(struct drbd_conf *mdev, \</span>
<span class="cp">	unsigned short *tags, struct name *arg) __attribute__ ((unused)); \</span>
<span class="cp">static int name ## _from_tags(struct drbd_conf *mdev, \</span>
<span class="cp">	unsigned short *tags, struct name *arg) \</span>
<span class="cp">{ \</span>
<span class="cp">	int tag; \</span>
<span class="cp">	int dlen; \</span>
<span class="cp">	\</span>
<span class="cp">	while ((tag = get_unaligned(tags++)) != TT_END) {	\</span>
<span class="cp">		dlen = get_unaligned(tags++);			\</span>
<span class="cp">		switch (tag_number(tag)) { \</span>
<span class="cp">		fields \</span>
<span class="cp">		default: \</span>
<span class="cp">			if (tag &amp; T_MANDATORY) { \</span>
<span class="cp">				dev_err(DEV, &quot;Unknown tag: %d\n&quot;, tag_number(tag)); \</span>
<span class="cp">				return 0; \</span>
<span class="cp">			} \</span>
<span class="cp">		} \</span>
<span class="cp">		tags = (unsigned short *)((char *)tags + dlen); \</span>
<span class="cp">	} \</span>
<span class="cp">	return 1; \</span>
<span class="cp">}</span>
<span class="cp">#define NL_INTEGER(pn, pr, member) \</span>
<span class="cp">	case pn: </span><span class="cm">/* D_ASSERT( tag_type(tag) == TT_INTEGER ); */</span><span class="cp"> \</span>
<span class="cp">		arg-&gt;member = get_unaligned((int *)(tags));	\</span>
<span class="cp">		break;</span>
<span class="cp">#define NL_INT64(pn, pr, member) \</span>
<span class="cp">	case pn: </span><span class="cm">/* D_ASSERT( tag_type(tag) == TT_INT64 ); */</span><span class="cp"> \</span>
<span class="cp">		arg-&gt;member = get_unaligned((u64 *)(tags));	\</span>
<span class="cp">		break;</span>
<span class="cp">#define NL_BIT(pn, pr, member) \</span>
<span class="cp">	case pn: </span><span class="cm">/* D_ASSERT( tag_type(tag) == TT_BIT ); */</span><span class="cp"> \</span>
<span class="cp">		arg-&gt;member = *(char *)(tags) ? 1 : 0; \</span>
<span class="cp">		break;</span>
<span class="cp">#define NL_STRING(pn, pr, member, len) \</span>
<span class="cp">	case pn: </span><span class="cm">/* D_ASSERT( tag_type(tag) == TT_STRING ); */</span><span class="cp"> \</span>
<span class="cp">		if (dlen &gt; len) { \</span>
<span class="cp">			dev_err(DEV, &quot;arg too long: %s (%u wanted, max len: %u bytes)\n&quot;, \</span>
<span class="cp">				#member, dlen, (unsigned int)len); \</span>
<span class="cp">			return 0; \</span>
<span class="cp">		} \</span>
<span class="cp">		 arg-&gt;member ## _len = dlen; \</span>
<span class="cp">		 memcpy(arg-&gt;member, tags, min_t(size_t, dlen, len)); \</span>
<span class="cp">		 break;</span>
<span class="cp">#include &lt;linux/drbd_nl.h&gt;</span>

<span class="cm">/* Generate the struct to tag_list functions */</span>
<span class="cp">#define NL_PACKET(name, number, fields) \</span>
<span class="cp">static unsigned short* \</span>
<span class="cp">name ## _to_tags(struct drbd_conf *mdev, \</span>
<span class="cp">	struct name *arg, unsigned short *tags) __attribute__ ((unused)); \</span>
<span class="cp">static unsigned short* \</span>
<span class="cp">name ## _to_tags(struct drbd_conf *mdev, \</span>
<span class="cp">	struct name *arg, unsigned short *tags) \</span>
<span class="cp">{ \</span>
<span class="cp">	fields \</span>
<span class="cp">	return tags; \</span>
<span class="cp">}</span>

<span class="cp">#define NL_INTEGER(pn, pr, member) \</span>
<span class="cp">	put_unaligned(pn | pr | TT_INTEGER, tags++);	\</span>
<span class="cp">	put_unaligned(sizeof(int), tags++);		\</span>
<span class="cp">	put_unaligned(arg-&gt;member, (int *)tags);	\</span>
<span class="cp">	tags = (unsigned short *)((char *)tags+sizeof(int));</span>
<span class="cp">#define NL_INT64(pn, pr, member) \</span>
<span class="cp">	put_unaligned(pn | pr | TT_INT64, tags++);	\</span>
<span class="cp">	put_unaligned(sizeof(u64), tags++);		\</span>
<span class="cp">	put_unaligned(arg-&gt;member, (u64 *)tags);	\</span>
<span class="cp">	tags = (unsigned short *)((char *)tags+sizeof(u64));</span>
<span class="cp">#define NL_BIT(pn, pr, member) \</span>
<span class="cp">	put_unaligned(pn | pr | TT_BIT, tags++);	\</span>
<span class="cp">	put_unaligned(sizeof(char), tags++);		\</span>
<span class="cp">	*(char *)tags = arg-&gt;member; \</span>
<span class="cp">	tags = (unsigned short *)((char *)tags+sizeof(char));</span>
<span class="cp">#define NL_STRING(pn, pr, member, len) \</span>
<span class="cp">	put_unaligned(pn | pr | TT_STRING, tags++);	\</span>
<span class="cp">	put_unaligned(arg-&gt;member ## _len, tags++);	\</span>
<span class="cp">	memcpy(tags, arg-&gt;member, arg-&gt;member ## _len); \</span>
<span class="cp">	tags = (unsigned short *)((char *)tags + arg-&gt;member ## _len);</span>
<span class="cp">#include &lt;linux/drbd_nl.h&gt;</span>

<span class="kt">void</span> <span class="n">drbd_bcast_ev_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">helper_name</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">drbd_nl_send_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drbd_khelper</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;HOME=/&quot;</span><span class="p">,</span>
			<span class="s">&quot;TERM=linux&quot;</span><span class="p">,</span>
			<span class="s">&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* Will be set to address family */</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* Will be set to address */</span>
			<span class="nb">NULL</span> <span class="p">};</span>

	<span class="kt">char</span> <span class="n">mb</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">af</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">ad</span><span class="p">[</span><span class="mi">60</span><span class="p">],</span> <span class="o">*</span><span class="n">afs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">usermode_helper</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;minor-%d&quot;</span><span class="p">,</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AF_INET6</span>:
			<span class="n">afs</span> <span class="o">=</span> <span class="s">&quot;ipv6&quot;</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s">&quot;DRBD_PEER_ADDRESS=%pI6&quot;</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AF_INET</span>:
			<span class="n">afs</span> <span class="o">=</span> <span class="s">&quot;ipv4&quot;</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s">&quot;DRBD_PEER_ADDRESS=%pI4&quot;</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">afs</span> <span class="o">=</span> <span class="s">&quot;ssocks&quot;</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s">&quot;DRBD_PEER_ADDRESS=%pI4&quot;</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;DRBD_PEER_AF=%s&quot;</span><span class="p">,</span> <span class="n">afs</span><span class="p">);</span>
		<span class="n">envp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">af</span><span class="p">;</span>
		<span class="n">envp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">ad</span><span class="p">;</span>
		<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The helper may take some time.</span>
<span class="cm">	 * write out any unsynced meta data changes now */</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;helper command: %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usermode_helper</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="n">drbd_bcast_ev_helper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">call_usermodehelper</span><span class="p">(</span><span class="n">usermode_helper</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">,</span> <span class="n">UMH_WAIT_PROC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;helper command: %s %s %s exit code %u (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">usermode_helper</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;helper command: %s %s %s exit code %u (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">usermode_helper</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Ignore any ERRNOs we got. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="nf">drbd_try_outdate_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ex_to_string</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">nps</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_fencing_p</span> <span class="n">fp</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_UNKNOWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_CONSISTENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Not fencing peer, I&#39;m not even Consistent myself.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nps</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;fence-peer&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">r</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* peer is inconsistent */</span>
		<span class="n">ex_to_string</span> <span class="o">=</span> <span class="s">&quot;peer is inconsistent or worse&quot;</span><span class="p">;</span>
		<span class="n">nps</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* peer got outdated, or was already outdated */</span>
		<span class="n">ex_to_string</span> <span class="o">=</span> <span class="s">&quot;peer was fenced&quot;</span><span class="p">;</span>
		<span class="n">nps</span> <span class="o">=</span> <span class="n">D_OUTDATED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* peer was down */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we will(have) create(d) a new UUID anyways... */</span>
			<span class="n">ex_to_string</span> <span class="o">=</span> <span class="s">&quot;peer is unreachable, assumed to be dead&quot;</span><span class="p">;</span>
			<span class="n">nps</span> <span class="o">=</span> <span class="n">D_OUTDATED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ex_to_string</span> <span class="o">=</span> <span class="s">&quot;peer unreachable, doing nothing since disk != UpToDate&quot;</span><span class="p">;</span>
			<span class="n">nps</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* Peer is primary, voluntarily outdate myself.</span>
<span class="cm">		 * This is useful when an unconnected R_SECONDARY is asked to</span>
<span class="cm">		 * become R_PRIMARY, but finds the other peer being active. */</span>
		<span class="n">ex_to_string</span> <span class="o">=</span> <span class="s">&quot;peer is active&quot;</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Peer is primary, outdating myself.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nps</span> <span class="o">=</span> <span class="n">D_UNKNOWN</span><span class="p">;</span>
		<span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_OUTDATED</span><span class="p">),</span> <span class="n">CS_WAIT_COMPLETE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="n">FP_STONITH</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;fence-peer() = 7 &amp;&amp; fencing != Stonith !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ex_to_string</span> <span class="o">=</span> <span class="s">&quot;peer was stonithed&quot;</span><span class="p">;</span>
		<span class="n">nps</span> <span class="o">=</span> <span class="n">D_OUTDATED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* The script is broken ... */</span>
		<span class="n">nps</span> <span class="o">=</span> <span class="n">D_UNKNOWN</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;fence-peer helper broken, returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">nps</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;fence-peer helper returned %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">r</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ex_to_string</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">susp_fen</span> <span class="o">&amp;&amp;</span> <span class="n">nps</span> <span class="o">&gt;=</span> <span class="n">D_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The handler was not successful... unfreeze here, the</span>
<span class="cm">		   state engine can not unfreeze... */</span>
		<span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">susp_fen</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nps</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_try_outdate_peer_async</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">nps</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">;</span>

	<span class="n">nps</span> <span class="o">=</span> <span class="n">drbd_try_outdate_peer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* Not using</span>
<span class="cm">	   drbd_request_state(mdev, NS(pdsk, nps));</span>
<span class="cm">	   here, because we might were able to re-establish the connection</span>
<span class="cm">	   in the meantime. This can only partially be solved in the state&#39;s</span>
<span class="cm">	   engine is_valid_state() and is_valid_state_transition()</span>
<span class="cm">	   functions.</span>

<span class="cm">	   nps can be D_INCONSISTENT, D_OUTDATED or D_UNKNOWN.</span>
<span class="cm">	   pdsk == D_INCONSISTENT while conn &gt;= C_CONNECTED is valid,</span>
<span class="cm">	   therefore we have to have the pre state change check here.</span>
<span class="cm">	*/</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_WF_REPORT_PARAMS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">nps</span><span class="p">;</span>
		<span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_try_outdate_peer_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">opa</span><span class="p">;</span>

	<span class="n">opa</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">_try_outdate_peer_async</span><span class="p">,</span> <span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;drbd%d_a_helper&quot;</span><span class="p">,</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">opa</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;out of mem, failed to invoke fence-peer helper</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">drbd_set_role</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_role</span> <span class="n">new_role</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">SS_UNKNOWN_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">forced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">nps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span>
		<span class="n">request_ping</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* Detect a dead peer ASAP */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">mask</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mask</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">R_MASK</span><span class="p">;</span>
	<span class="n">val</span><span class="p">.</span><span class="n">i</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">val</span><span class="p">.</span><span class="n">role</span>  <span class="o">=</span> <span class="n">new_role</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">try</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">CS_WAIT_COMPLETE</span><span class="p">);</span>

		<span class="cm">/* in case we first succeeded to outdate,</span>
<span class="cm">		 * but now suddenly could establish a connection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_CW_FAILED_BY_PEER</span> <span class="o">&amp;&amp;</span> <span class="n">mask</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mask</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_NO_UP_TO_DATE_DISK</span> <span class="o">&amp;&amp;</span> <span class="n">force</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span>
		     <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_INCONSISTENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mask</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_MASK</span><span class="p">;</span>
			<span class="n">val</span><span class="p">.</span><span class="n">disk</span>  <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
			<span class="n">forced</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_NO_UP_TO_DATE_DISK</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_CONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">mask</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_UNKNOWN</span><span class="p">);</span>
			<span class="n">nps</span> <span class="o">=</span> <span class="n">drbd_try_outdate_peer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nps</span> <span class="o">==</span> <span class="n">D_OUTDATED</span> <span class="o">||</span> <span class="n">nps</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
				<span class="n">mask</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_MASK</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">val</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">nps</span><span class="p">;</span>
			<span class="n">mask</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_MASK</span><span class="p">;</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_PRIMARY_NOP</span> <span class="o">&amp;&amp;</span> <span class="n">mask</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nps</span> <span class="o">=</span> <span class="n">drbd_try_outdate_peer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="n">nps</span> <span class="o">&gt;</span> <span class="n">D_OUTDATED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Forced into split brain situation!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">nps</span> <span class="o">=</span> <span class="n">D_OUTDATED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">mask</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_MASK</span><span class="p">;</span>
			<span class="n">val</span><span class="p">.</span><span class="n">pdsk</span>  <span class="o">=</span> <span class="n">nps</span><span class="p">;</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_TWO_PRIMARIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Maybe the peer is detected as dead very soon...</span>
<span class="cm">			   retry at most once more in this case. */</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ping_timeo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">try</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">)</span>
				<span class="n">try</span> <span class="o">=</span> <span class="n">max_tries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
						<span class="n">CS_VERBOSE</span> <span class="o">+</span> <span class="n">CS_WAIT_COMPLETE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forced</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Forced to consider local data as UpToDate!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait until nothing is on the fly :) */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_pending_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">||</span>
			       <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;=</span> <span class="n">D_FAILED</span><span class="p">)</span>
			      <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">forced</span><span class="p">)</span>
				<span class="n">drbd_uuid_new_current</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* writeout of activity log covered areas of the bitmap</span>
<span class="cm">	 * to stable storage done in after state change already */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if this was forced, we should consider sync */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">forced</span><span class="p">)</span>
			<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_send_current_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
 <span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="nf">ensure_mdev</span><span class="p">(</span><span class="kt">int</span> <span class="n">minor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">minor_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mdev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span> <span class="o">&amp;&amp;</span> <span class="n">create</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mdev</span> <span class="o">=</span> <span class="n">drbd_new_device</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minor_table</span><span class="p">[</span><span class="n">minor</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">minor_table</span><span class="p">[</span><span class="n">minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>
			<span class="n">disk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">;</span>
			<span class="n">mdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* else: we lost the race */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="p">)</span> <span class="cm">/* we won the race above */</span>
			<span class="cm">/* in case we ever add a drbd_delete_device(),</span>
<span class="cm">			 * don&#39;t forget the del_gendisk! */</span>
			<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/* we lost the race above */</span>
			<span class="n">drbd_free_mdev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="n">mdev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_primary</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">primary</span> <span class="n">primary_args</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">primary_args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">primary</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">primary_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">primary_args</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span>
		<span class="n">drbd_set_role</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">R_PRIMARY</span><span class="p">,</span> <span class="n">primary_args</span><span class="p">.</span><span class="n">primary_force</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_secondary</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">drbd_set_role</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">R_SECONDARY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initializes the md.*_offset members, so we are able to find</span>
<span class="cm"> * the on disk meta data */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_md_set_sector_offsets</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">md_size_sect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="cm">/* v07 style fixed size indexed meta data */</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span> <span class="o">=</span> <span class="n">MD_RESERVED_SECT</span><span class="p">;</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span> <span class="o">=</span> <span class="n">drbd_md_ss__</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span> <span class="o">=</span> <span class="n">MD_AL_OFFSET</span><span class="p">;</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bm_offset</span> <span class="o">=</span> <span class="n">MD_BM_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRBD_MD_INDEX_FLEX_EXT</span>:
		<span class="cm">/* just occupy the full device; unit: sectors */</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">);</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span> <span class="o">=</span> <span class="n">MD_AL_OFFSET</span><span class="p">;</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bm_offset</span> <span class="o">=</span> <span class="n">MD_BM_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRBD_MD_INDEX_INTERNAL</span>:
	<span class="k">case</span> <span class="n">DRBD_MD_INDEX_FLEX_INT</span>:
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span> <span class="o">=</span> <span class="n">drbd_md_ss__</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>
		<span class="cm">/* al size is still fixed */</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">MD_AL_MAX_SIZE</span><span class="p">;</span>
		<span class="cm">/* we need (slightly less than) ~ this much bitmap sectors: */</span>
		<span class="n">md_size_sect</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">);</span>
		<span class="n">md_size_sect</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">md_size_sect</span><span class="p">,</span> <span class="n">BM_SECT_PER_EXT</span><span class="p">);</span>
		<span class="n">md_size_sect</span> <span class="o">=</span> <span class="n">BM_SECT_TO_EXT</span><span class="p">(</span><span class="n">md_size_sect</span><span class="p">);</span>
		<span class="n">md_size_sect</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">md_size_sect</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/* plus the &quot;drbd meta data super block&quot;,</span>
<span class="cm">		 * and the activity log; */</span>
		<span class="n">md_size_sect</span> <span class="o">+=</span> <span class="n">MD_BM_OFFSET</span><span class="p">;</span>

		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span> <span class="o">=</span> <span class="n">md_size_sect</span><span class="p">;</span>
		<span class="cm">/* bitmap offset is adjusted by &#39;super&#39; block size */</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bm_offset</span>   <span class="o">=</span> <span class="o">-</span><span class="n">md_size_sect</span> <span class="o">+</span> <span class="n">MD_AL_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* input size is expected to be in KB */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">ppsize</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Needs 9 bytes at max including trailing NUL:</span>
<span class="cm">	 * -1ULL ==&gt; &quot;16384 EB&quot; */</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">units</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* shift + round */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="o">!!</span><span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">));</span>
		<span class="n">base</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u %cB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">size</span><span class="p">,</span> <span class="n">units</span><span class="p">[</span><span class="n">base</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* there is still a theoretical deadlock when called from receiver</span>
<span class="cm"> * on an D_INCONSISTENT R_PRIMARY:</span>
<span class="cm"> *  remote READ does inc_ap_bio, receiver would need to receive answer</span>
<span class="cm"> *  packet from remote to dec_ap_bio again.</span>
<span class="cm"> *  receiver receive_sizes(), comes here,</span>
<span class="cm"> *  waits for ap_bio_cnt == 0. -&gt; deadlock.</span>
<span class="cm"> * but this cannot happen, actually, because:</span>
<span class="cm"> *  R_PRIMARY D_INCONSISTENT, and peer&#39;s disk is unreachable</span>
<span class="cm"> *  (not connected, or bad/no disk on peer):</span>
<span class="cm"> *  see drbd_fail_request_early, ap_bio_cnt is zero.</span>
<span class="cm"> *  R_PRIMARY D_INCONSISTENT, and C_SYNC_TARGET:</span>
<span class="cm"> *  peer may not initiate a resize.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_suspend_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SUSPEND_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_susp</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_bio_cnt</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_resume_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SUSPEND_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_determine_dev_size() -  Sets the right device size obeying all constraints</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative return values indicate errors.</span>
<span class="cm"> * You should call drbd_md_sync() after calling this function.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">determine_dev_size</span> <span class="nf">drbd_determine_dev_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dds_flags</span> <span class="n">flags</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">prev_first_sect</span><span class="p">,</span> <span class="n">prev_size</span><span class="p">;</span> <span class="cm">/* previous meta location */</span>
	<span class="n">sector_t</span> <span class="n">la_size</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ppb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">md_moved</span><span class="p">,</span> <span class="n">la_size_changed</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">determine_dev_size</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">unchanged</span><span class="p">;</span>

	<span class="cm">/* race:</span>
<span class="cm">	 * application request passes inc_ap_bio,</span>
<span class="cm">	 * but then cannot get an AL-reference.</span>
<span class="cm">	 * this function later may wait on ap_bio_cnt == 0. -&gt; deadlock.</span>
<span class="cm">	 *</span>
<span class="cm">	 * to avoid that:</span>
<span class="cm">	 * Suspend IO right here.</span>
<span class="cm">	 * still lock the act_log to not trigger ASSERTs there.</span>
<span class="cm">	 */</span>
	<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* no wait necessary anymore, actually we could assert that */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">,</span> <span class="n">lc_try_lock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">));</span>

	<span class="n">prev_first_sect</span> <span class="o">=</span> <span class="n">drbd_md_first_sector</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">);</span>
	<span class="n">prev_size</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span><span class="p">;</span>
	<span class="n">la_size</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">la_size_sect</span><span class="p">;</span>

	<span class="cm">/* TODO: should only be some assert here, not (re)init... */</span>
	<span class="n">drbd_md_set_sector_offsets</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">drbd_new_dev_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DDSF_FORCED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">||</span>
	    <span class="n">drbd_bm_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_bm_resize</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DDSF_NO_RESYNC</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* currently there is only one error: ENOMEM! */</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">drbd_bm_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;OUT OF MEMORY! &quot;</span>
				    <span class="s">&quot;Could not allocate bitmap!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;BM resizing failed. &quot;</span>
				    <span class="s">&quot;Leaving size unchanged at size = %lu KB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">dev_size_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* racy, see comments above. */</span>
		<span class="n">drbd_set_my_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">la_size_sect</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;size = %s (%llu KB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppsize</span><span class="p">(</span><span class="n">ppb</span><span class="p">,</span> <span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">),</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">dev_size_error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">la_size_changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">la_size</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">la_size_sect</span><span class="p">);</span>

	<span class="n">md_moved</span> <span class="o">=</span> <span class="n">prev_first_sect</span> <span class="o">!=</span> <span class="n">drbd_md_first_sector</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">prev_size</span>	   <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">la_size_changed</span> <span class="o">||</span> <span class="n">md_moved</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">drbd_al_shrink</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* All extents inactive. */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Writing the whole bitmap, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">la_size_changed</span> <span class="o">&amp;&amp;</span> <span class="n">md_moved</span> <span class="o">?</span> <span class="s">&quot;size changed and md moved&quot;</span> <span class="o">:</span>
			 <span class="n">la_size_changed</span> <span class="o">?</span> <span class="s">&quot;size changed&quot;</span> <span class="o">:</span> <span class="s">&quot;md moved&quot;</span><span class="p">);</span>
		<span class="cm">/* next line implicitly does drbd_suspend_io()+drbd_resume_io() */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bm_write</span><span class="p">,</span>
				<span class="s">&quot;size changed&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">dev_size_error</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">la_size</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">grew</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">la_size</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">shrunk</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">lc_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">sector_t</span>
<span class="nf">drbd_new_dev_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">assume_peer_has_space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">p_size</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_size</span><span class="p">;</span>   <span class="cm">/* partner&#39;s disk size. */</span>
	<span class="n">sector_t</span> <span class="n">la_size</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">la_size_sect</span><span class="p">;</span> <span class="cm">/* last agreed size. */</span>
	<span class="n">sector_t</span> <span class="n">m_size</span><span class="p">;</span> <span class="cm">/* my size */</span>
	<span class="n">sector_t</span> <span class="n">u_size</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">;</span> <span class="cm">/* size requested by user. */</span>
	<span class="n">sector_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">m_size</span> <span class="o">=</span> <span class="n">drbd_get_max_capacity</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">assume_peer_has_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Resize while not connected was forced by the user!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">p_size</span> <span class="o">=</span> <span class="n">m_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_size</span> <span class="o">&amp;&amp;</span> <span class="n">m_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">sector_t</span><span class="p">,</span> <span class="n">p_size</span><span class="p">,</span> <span class="n">m_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">la_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">la_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m_size</span> <span class="o">&amp;&amp;</span> <span class="n">m_size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">m_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_size</span> <span class="o">&amp;&amp;</span> <span class="n">p_size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">p_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m_size</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">m_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_size</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">p_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Both nodes diskless!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u_size</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Requested disk size is too big (%lu &gt; %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">u_size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">u_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_check_al_size() - Ensures that the AL is of the right size</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns -EBUSY if current al lru is still used, -ENOMEM when allocation</span>
<span class="cm"> * failed, and 0 on success. You should call drbd_md_sync() after you called</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_check_al_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lru_cache</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_use</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">al_extents</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">lc_create</span><span class="p">(</span><span class="s">&quot;act_log&quot;</span><span class="p">,</span> <span class="n">drbd_al_ext_cache</span><span class="p">,</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">al_extents</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lc_element</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Cannot allocate act_log lru!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">lc_element_by_index</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;refcnt(%d)==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">e</span><span class="o">-&gt;</span><span class="n">lc_number</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
			<span class="n">in_use</span> <span class="o">+=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_use</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Activity log still in use!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lc_destroy</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
			<span class="n">lc_destroy</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* we changed mdev-&gt;act_log-&gt;nr_elemens */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_setup_queue_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_bio_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span> <span class="k">const</span> <span class="n">q</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rq_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_hw_sectors</span> <span class="o">=</span> <span class="n">max_bio_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_segments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span> <span class="k">const</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>

		<span class="n">max_hw_sectors</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">queue_max_hw_sectors</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">max_bio_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">max_segments</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">max_bio_bvecs</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">max_hw_sectors</span><span class="p">);</span>
	<span class="cm">/* This is the workaround for &quot;bio would need to, but cannot, be split&quot; */</span>
	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">max_segments</span> <span class="o">?</span> <span class="n">max_segments</span> <span class="o">:</span> <span class="n">BLK_MAX_SEGMENTS</span><span class="p">);</span>
	<span class="n">blk_queue_segment_boundary</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span> <span class="k">const</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>

		<span class="n">blk_queue_stack_limits</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Adjusting my ra_pages to backing device&#39;s (%lu -&gt; %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span><span class="p">,</span>
				 <span class="n">b</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span><span class="p">);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_reconsider_max_bio_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">now</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">peer</span><span class="p">;</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">queue_max_hw_sectors</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rq_queue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_max_bio_size</span><span class="p">;</span> <span class="cm">/* Eventually last known value, from volatile memory */</span>
	<span class="n">peer</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_max_bio_size</span><span class="p">;</span> <span class="cm">/* Eventually last known value, from meta data */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local</span> <span class="o">=</span> <span class="n">queue_max_hw_sectors</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_max_bio_size</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We may ignore peer limits if the peer is modern enough.</span>
<span class="cm">	   Because new from 8.3.8 onwards the peer can use multiple</span>
<span class="cm">	   BIOs for a single peer_request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">94</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peer</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_max_bio_size</span><span class="p">,</span> <span class="n">DRBD_MAX_SIZE_H80_PACKET</span><span class="p">);</span>
			<span class="cm">/* Correct old drbd (up to 8.3.7) if it believes it can do more than 32KiB */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">==</span> <span class="mi">94</span><span class="p">)</span>
			<span class="n">peer</span> <span class="o">=</span> <span class="n">DRBD_MAX_SIZE_H80_PACKET</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* drbd 8.3.8 onwards */</span>
			<span class="n">peer</span> <span class="o">=</span> <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">new</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERT FAILED new &lt; now; (%d &lt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">now</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;max BIO size = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

	<span class="n">drbd_setup_queue_param</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* serialize deconfig (worker exiting, doing cleanup)</span>
<span class="cm"> * and reconfig (drbdsetup disk, drbdsetup net)</span>
<span class="cm"> *</span>
<span class="cm"> * Wait for a potentially exiting worker, then restart it,</span>
<span class="cm"> * or start a new one.  Flush any pending work, there may still be an</span>
<span class="cm"> * after_state_change queued.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_reconfig_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CONFIG_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_DYING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">drbd_thread_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">);</span>
	<span class="n">drbd_flush_workqueue</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* if still unconfigured, stops worker again.</span>
<span class="cm"> * if configured now, clears CONFIG_PENDING.</span>
<span class="cm"> * wakes potential waiters */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_reconfig_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_DYING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">drbd_thread_stop_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONFIG_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Make sure IO is suspended before calling this function(). */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_suspend_al</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lc_try_lock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_al_shrink</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">lc_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Failed to lock al in drbd_suspend_al()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">AL_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Suspended AL updates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* does always return 0;</span>
<span class="cm"> * interesting return code is in reply-&gt;ret_code */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_disk_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_ret_code</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">determine_dev_size</span> <span class="n">dd</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">max_possible_sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">min_md_device_sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">nbc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* new_backing_conf */</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lru_cache</span> <span class="o">*</span><span class="n">resync_lru</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span> <span class="n">os</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cp_discovered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">logical_block_size</span><span class="p">;</span>

	<span class="n">drbd_reconfig_start</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* if you want to reconfigure, please tear down first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_DISKLESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_DISK_CONFIGURED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* It may just now have detached because of IO error.  Make sure</span>
<span class="cm">	 * drbd_ldev_destroy is done already, we may end up here very fast,</span>
<span class="cm">	 * e.g. if someone calls attach from the on-io-error handler,</span>
<span class="cm">	 * to realize a &quot;hot spare&quot; feature (not that I&#39;d recommend that) */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_cnt</span><span class="p">));</span>

	<span class="cm">/* allocation not in the IO path, cqueue thread context */</span>
	<span class="n">nbc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_backing_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nbc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span>     <span class="o">=</span> <span class="n">DRBD_DISK_SIZE_SECT_DEF</span><span class="p">;</span>
	<span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">on_io_error</span>   <span class="o">=</span> <span class="n">DRBD_ON_IO_ERROR_DEF</span><span class="p">;</span>
	<span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span>       <span class="o">=</span> <span class="n">DRBD_FENCING_DEF</span><span class="p">;</span>
	<span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">max_bio_bvecs</span> <span class="o">=</span> <span class="n">DRBD_MAX_BIO_BVECS_DEF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk_conf_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span> <span class="o">&lt;</span> <span class="n">DRBD_MD_INDEX_FLEX_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MD_IDX_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span><span class="p">;</span>
		<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span> <span class="o">==</span> <span class="n">FP_STONITH</span> <span class="o">&amp;&amp;</span> <span class="n">prot</span> <span class="o">==</span> <span class="n">DRBD_PROT_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_STONITH_AND_PROT_A</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_path</span><span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">backing_dev</span><span class="p">,</span>
				  <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">,</span> <span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;open(</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">) failed with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">backing_dev</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_OPEN_DISK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nbc</span><span class="o">-&gt;</span><span class="n">backing_bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * meta_dev_idx &gt;= 0: external fixed size, possibly multiple</span>
<span class="cm">	 * drbd sharing one meta device.  TODO in that case, paranoia</span>
<span class="cm">	 * check that [md_bdev, meta_dev_idx] is not yet used by some</span>
<span class="cm">	 * other drbd minor!  (if you use drbd.conf + drbdadm, that</span>
<span class="cm">	 * should check it for you already; but if you don&#39;t, or</span>
<span class="cm">	 * someone fooled it, we need to double check here)</span>
<span class="cm">	 */</span>
	<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_path</span><span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev</span><span class="p">,</span>
				  <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mdev</span> <span class="o">:</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">drbd_m_holder</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;open(</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">) failed with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_OPEN_MD_DISK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md_bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">backing_bdev</span> <span class="o">==</span> <span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span> <span class="o">==</span> <span class="n">DRBD_MD_INDEX_INTERNAL</span> <span class="o">||</span>
	     <span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span> <span class="o">==</span> <span class="n">DRBD_MD_INDEX_FLEX_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MD_IDX_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">resync_lru</span> <span class="o">=</span> <span class="n">lc_create</span><span class="p">(</span><span class="s">&quot;resync&quot;</span><span class="p">,</span> <span class="n">drbd_bm_ext_cache</span><span class="p">,</span>
			<span class="mi">61</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bm_extent</span><span class="p">),</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resync_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* RT - for drbd_get_max_capacity() DRBD_MD_INDEX_FLEX_INT */</span>
	<span class="n">drbd_md_set_sector_offsets</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nbc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_get_max_capacity</span><span class="p">(</span><span class="n">nbc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;max capacity %llu smaller than disk size %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">drbd_get_max_capacity</span><span class="p">(</span><span class="n">nbc</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">);</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_DISK_TOO_SMALL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_possible_sectors</span> <span class="o">=</span> <span class="n">DRBD_MAX_SECTORS_FLEX</span><span class="p">;</span>
		<span class="cm">/* at least one MB, otherwise it does not make sense */</span>
		<span class="n">min_md_device_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">max_possible_sectors</span> <span class="o">=</span> <span class="n">DRBD_MAX_SECTORS</span><span class="p">;</span>
		<span class="n">min_md_device_sectors</span> <span class="o">=</span> <span class="n">MD_RESERVED_SECT</span> <span class="o">*</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_md_device_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MD_DISK_TOO_SMALL</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;refusing attach: md-device too small, &quot;</span>
		     <span class="s">&quot;at least %llu sectors needed for this meta-disk type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">min_md_device_sectors</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure the new disk is big enough</span>
<span class="cm">	 * (we may currently be R_PRIMARY with no local disk...) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_get_max_capacity</span><span class="p">(</span><span class="n">nbc</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_DISK_TOO_SMALL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nbc</span><span class="o">-&gt;</span><span class="n">known_size</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">known_size</span> <span class="o">&gt;</span> <span class="n">max_possible_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;==&gt; truncating very big lower level device &quot;</span>
			<span class="s">&quot;to currently maximum possible %llu sectors &lt;==</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">max_possible_sectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">meta_dev_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;==&gt;&gt; using internal or flexible &quot;</span>
				      <span class="s">&quot;meta data may help &lt;&lt;==</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="cm">/* also wait for the last barrier ack. */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_pending_cnt</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_susp</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="cm">/* and for any other previously queued work */</span>
	<span class="n">drbd_flush_workqueue</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">);</span>
	<span class="n">retcode</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>  <span class="cm">/* FIXME: Type mismatch. */</span>
	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">force_diskless</span><span class="p">;</span>

	<span class="n">drbd_md_set_sector_offsets</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nbc</span><span class="p">);</span>

	<span class="cm">/* allocate a second IO page if logical_block_size != 512 */</span>
	<span class="n">logical_block_size</span> <span class="o">=</span> <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logical_block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">logical_block_size</span> <span class="o">=</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">logical_block_size</span> <span class="o">!=</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>

			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Meta data&#39;s bdev logical_block_size = %d != %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">logical_block_size</span><span class="p">,</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Workaround engaged (has performance impact).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_md_read</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nbc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ed_uuid</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Can only attach to data with current UUID=%016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ed_uuid</span><span class="p">);</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_DATA_NOT_CURRENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Since we are diskless, fix the activity log first... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_check_al_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prevent shrinking of consistent devices ! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">nbc</span><span class="p">,</span> <span class="n">MDF_CONSISTENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">drbd_new_dev_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nbc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">la_size_sect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;refusing to truncate a consistent device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_DISK_TOO_SMALL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_al_read_log</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nbc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the &quot;barriers don&#39;t work&quot; bits here, then force meta data to</span>
<span class="cm">	 * be written, to ensure we determine if barriers are supported. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">no_md_flush</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_NO_FUA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_NO_FUA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Point of no return reached.</span>
<span class="cm">	 * Devices and memory are no longer released by error cleanup below.</span>
<span class="cm">	 * now mdev takes over responsibility, and the state engine should</span>
<span class="cm">	 * clean it up somewhere.  */</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span> <span class="o">=</span> <span class="n">nbc</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span> <span class="o">=</span> <span class="n">resync_lru</span><span class="p">;</span>
	<span class="n">nbc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">resync_lru</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span> <span class="o">=</span> <span class="n">WO_bdev_flush</span><span class="p">;</span>
	<span class="n">drbd_bump_write_ordering</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">WO_bdev_flush</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_CRASHED_PRIMARY</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CRASHED_PRIMARY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CRASHED_PRIMARY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_PRIMARY_IND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">susp_nod</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CRASHED_PRIMARY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cp_discovered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">send_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">writ_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drbd_reconsider_max_bio_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* If I am currently not R_PRIMARY,</span>
<span class="cm">	 * but meta data primary indicator is set,</span>
<span class="cm">	 * I just now recover from a hard crash,</span>
<span class="cm">	 * and have been R_PRIMARY before that crash.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Now, if I had no connection before that crash</span>
<span class="cm">	 * (have been degraded R_PRIMARY), chances are that</span>
<span class="cm">	 * I won&#39;t find my peer now either.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In that case, and _only_ in that case,</span>
<span class="cm">	 * we use the degr-wfc-timeout instead of the default,</span>
<span class="cm">	 * so we can automatically recover from a crash of a</span>
<span class="cm">	 * degraded but active &quot;cluster&quot; after a certain timeout.</span>
<span class="cm">	 */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">USE_DEGR_WFC_T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span>
	     <span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_PRIMARY_IND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_CONNECTED_IND</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">USE_DEGR_WFC_T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dd</span> <span class="o">=</span> <span class="n">drbd_determine_dev_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span> <span class="o">==</span> <span class="n">dev_size_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM_BITMAP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dd</span> <span class="o">==</span> <span class="n">grew</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">RESYNC_AFTER_NEG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_FULL_SYNC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Assuming that all blocks are out of sync &quot;</span>
		     <span class="s">&quot;(aka FullSync)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bmio_set_n_write</span><span class="p">,</span>
			<span class="s">&quot;set_n_write from attaching&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bm_read</span><span class="p">,</span>
			<span class="s">&quot;read from attaching&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp_discovered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_al_apply_to_bm</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bm_write</span><span class="p">,</span>
			<span class="s">&quot;crashed primary apply AL&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">==</span> <span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="n">drbd_suspend_al</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* IO is still suspended here... */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
	<span class="cm">/* If MDF_CONSISTENT is not set go into inconsistent state,</span>
<span class="cm">	   otherwise investigate MDF_WasUpToDate...</span>
<span class="cm">	   If MDF_WAS_UP_TO_DATE is not set go into D_OUTDATED disk state,</span>
<span class="cm">	   otherwise into D_CONSISTENT state.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_CONSISTENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_WAS_UP_TO_DATE</span><span class="p">))</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_CONSISTENT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_OUTDATED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_PEER_OUT_DATED</span><span class="p">))</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_OUTDATED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_CONSISTENT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_OUTDATED</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span> <span class="o">==</span> <span class="n">FP_DONT_CARE</span><span class="p">))</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>

	<span class="cm">/* All tests on MDF_PRIMARY_IND, MDF_CONNECTED_IND,</span>
<span class="cm">	   MDF_CONSISTENT and MDF_WAS_UP_TO_DATE must happen before</span>
<span class="cm">	   this point, because drbd_request_state() modifies these</span>
<span class="cm">	   flags. */</span>

	<span class="cm">/* In case we are C_CONNECTED postpone any decision on the new disk</span>
<span class="cm">	   state after the negotiation phase. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">new_state_tmp</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">ns</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_NEGOTIATING</span><span class="p">;</span>

		<span class="cm">/* We expect to receive up-to-date UUIDs soon.</span>
<span class="cm">		   To avoid a race in receive_state, free p_uuid while</span>
<span class="cm">		   holding req_lock. I.e. atomic with the state change */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">force_diskless_dec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="n">drbd_reconfig_done</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">force_diskless_dec:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
 <span class="nl">force_diskless:</span>
	<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">));</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
 <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">)</span>
			<span class="n">blkdev_put</span><span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">,</span>
				   <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">)</span>
			<span class="n">blkdev_put</span><span class="p">(</span><span class="n">nbc</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">,</span>
				   <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nbc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lc_destroy</span><span class="p">(</span><span class="n">resync_lru</span><span class="p">);</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="n">drbd_reconfig_done</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Detaching the disk is a process in multiple stages.  First we need to lock</span>
<span class="cm"> * out application IO, in-flight IO, IO stuck in drbd_al_begin_io.</span>
<span class="cm"> * Then we transition to D_DISKLESS, and wait for put_ldev() to return all</span>
<span class="cm"> * internal references as well.</span>
<span class="cm"> * Only then we have finally detached. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_ret_code</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">detach</span> <span class="n">dt</span> <span class="o">=</span> <span class="p">{};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">detach_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="p">.</span><span class="n">detach_force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">));</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">SS_SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* so no-one is stuck in drbd_al_begin_io */</span>
	<span class="n">drbd_md_get_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* make sure there is no in-flight meta-data IO */</span>
	<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">));</span>
	<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="cm">/* D_FAILED will transition to DISKLESS. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_FAILED</span><span class="p">);</span>
	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">retcode</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">SS_IS_DISKLESS</span><span class="p">)</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_INTR</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_net_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_ret_code</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_conf</span> <span class="o">*</span><span class="n">new_conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">integrity_w_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">integrity_r_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">new_tl_hash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">new_ee_hash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">odev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hmac_name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">int_dig_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">int_dig_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">int_dig_vv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">new_my_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">new_peer_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">taken_addr</span><span class="p">;</span>

	<span class="n">drbd_reconfig_start</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_STANDALONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NET_CONFIGURED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocation not in the IO path, cqueue thread context */</span>
	<span class="n">new_conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">timeout</span>	   <span class="o">=</span> <span class="n">DRBD_TIMEOUT_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">try_connect_int</span>  <span class="o">=</span> <span class="n">DRBD_CONNECT_INT_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">ping_int</span>	   <span class="o">=</span> <span class="n">DRBD_PING_INT_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">max_epoch_size</span>   <span class="o">=</span> <span class="n">DRBD_MAX_EPOCH_SIZE_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">max_buffers</span>	   <span class="o">=</span> <span class="n">DRBD_MAX_BUFFERS_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">unplug_watermark</span> <span class="o">=</span> <span class="n">DRBD_UNPLUG_WATERMARK_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">sndbuf_size</span>	   <span class="o">=</span> <span class="n">DRBD_SNDBUF_SIZE_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span>	   <span class="o">=</span> <span class="n">DRBD_RCVBUF_SIZE_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">ko_count</span>	   <span class="o">=</span> <span class="n">DRBD_KO_COUNT_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">after_sb_0p</span>	   <span class="o">=</span> <span class="n">DRBD_AFTER_SB_0P_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">after_sb_1p</span>	   <span class="o">=</span> <span class="n">DRBD_AFTER_SB_1P_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">after_sb_2p</span>	   <span class="o">=</span> <span class="n">DRBD_AFTER_SB_2P_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span>    <span class="o">=</span> <span class="n">DRBD_PROT_C</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">ping_timeo</span>	   <span class="o">=</span> <span class="n">DRBD_PING_TIMEO_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">rr_conflict</span>	   <span class="o">=</span> <span class="n">DRBD_RR_CONFLICT_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">on_congestion</span>    <span class="o">=</span> <span class="n">DRBD_ON_CONGESTION_DEF</span><span class="p">;</span>
	<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">cong_extents</span>     <span class="o">=</span> <span class="n">DRBD_CONG_EXTENTS_DEF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_conf_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="n">new_conf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">!=</span> <span class="n">DRBD_PROT_C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOT_PROTO_C</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">drbd_fencing_p</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_A</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span> <span class="o">==</span> <span class="n">FP_STONITH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_STONITH_AND_PROT_A</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">on_congestion</span> <span class="o">!=</span> <span class="n">OC_BLOCK</span> <span class="o">&amp;&amp;</span> <span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">!=</span> <span class="n">DRBD_PROT_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_CONG_NOT_PROTO_A</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_DISCARD</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retcode</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>

	<span class="n">new_my_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">my_addr</span><span class="p">;</span>
	<span class="n">new_peer_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">minor_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">odev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odev</span> <span class="o">||</span> <span class="n">odev</span> <span class="o">==</span> <span class="n">mdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">odev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">taken_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">my_addr_len</span> <span class="o">==</span> <span class="n">odev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">my_addr_len</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">new_my_addr</span><span class="p">,</span> <span class="n">taken_addr</span><span class="p">,</span> <span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">my_addr_len</span><span class="p">))</span>
				<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_LOCAL_ADDR</span><span class="p">;</span>

			<span class="n">taken_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">peer_addr_len</span> <span class="o">==</span> <span class="n">odev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">peer_addr_len</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">new_peer_addr</span><span class="p">,</span> <span class="n">taken_addr</span><span class="p">,</span> <span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">peer_addr_len</span><span class="p">))</span>
				<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_PEER_ADDR</span><span class="p">;</span>

			<span class="n">put_net_conf</span><span class="p">(</span><span class="n">odev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">cram_hmac_alg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">hmac_name</span><span class="p">,</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">,</span> <span class="s">&quot;hmac(%s)&quot;</span><span class="p">,</span>
			<span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">cram_hmac_alg</span><span class="p">);</span>
		<span class="n">tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="n">hmac_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tfm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_AUTH_ALG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_crypto_is_hash</span><span class="p">(</span><span class="n">crypto_hash_tfm</span><span class="p">(</span><span class="n">tfm</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_AUTH_ALG_ND</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">integrity_alg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">integrity_w_tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">integrity_alg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">integrity_w_tfm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">integrity_w_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">retcode</span><span class="o">=</span><span class="n">ERR_INTEGRITY_ALG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_crypto_is_hash</span><span class="p">(</span><span class="n">crypto_hash_tfm</span><span class="p">(</span><span class="n">integrity_w_tfm</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">retcode</span><span class="o">=</span><span class="n">ERR_INTEGRITY_ALG_ND</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">integrity_r_tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">integrity_alg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">integrity_r_tfm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">integrity_r_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">retcode</span><span class="o">=</span><span class="n">ERR_INTEGRITY_ALG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">max_epoch_size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash_s</span> <span class="o">!=</span> <span class="n">ns</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_tl_hash</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ns</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_tl_hash</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">max_buffers</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash_s</span> <span class="o">!=</span> <span class="n">ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new_ee_hash</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ns</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_ee_hash</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">new_conf</span><span class="o">-&gt;</span><span class="n">shared_secret</span><span class="p">)[</span><span class="n">SHARED_SECRET_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">integrity_w_tfm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">integrity_w_tfm</span><span class="p">);</span>
		<span class="n">int_dig_out</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_dig_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">int_dig_in</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_dig_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">int_dig_vv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_dig_vv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">drbd_bm_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drbd_flush_workqueue</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NET_CONFIGURED</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span> <span class="o">=</span> <span class="n">new_conf</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">send_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_tl_hash</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash_s</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">max_epoch_size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span> <span class="o">=</span> <span class="n">new_tl_hash</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_ee_hash</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash_s</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">max_buffers</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span> <span class="o">=</span> <span class="n">new_ee_hash</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span> <span class="o">=</span> <span class="n">tfm</span><span class="p">;</span>

	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span> <span class="o">=</span> <span class="n">integrity_w_tfm</span><span class="p">;</span>

	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span> <span class="o">=</span> <span class="n">integrity_r_tfm</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_out</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_in</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_vv</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_out</span><span class="o">=</span><span class="n">int_dig_out</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_in</span><span class="o">=</span><span class="n">int_dig_in</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_vv</span><span class="o">=</span><span class="n">int_dig_vv</span><span class="p">;</span>
	<span class="n">retcode</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">_NS</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">C_UNCONNECTED</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="n">drbd_reconfig_done</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">int_dig_out</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">int_dig_in</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">int_dig_vv</span><span class="p">);</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">integrity_w_tfm</span><span class="p">);</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">integrity_r_tfm</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new_tl_hash</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new_ee_hash</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new_conf</span><span class="p">);</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="n">drbd_reconfig_done</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">disconnect</span> <span class="n">dc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">disconnect</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disconnect_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">.</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_WF_CONNECTION</span><span class="p">)</span>
			<span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">_NS</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">),</span> <span class="n">CS_HARD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retcode</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">),</span> <span class="n">CS_ORDERED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_ALREADY_STANDALONE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_PRIMARY_NOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Our statche checking code wants to see the peer outdated. */</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS2</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">,</span>
						      <span class="n">pdsk</span><span class="p">,</span> <span class="n">D_OUTDATED</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_CW_FAILED_BY_PEER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The peer probably wants to see us outdated. */</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS2</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">,</span>
							<span class="n">disk</span><span class="p">,</span> <span class="n">D_OUTDATED</span><span class="p">),</span>
					      <span class="n">CS_ORDERED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_IS_DISKLESS</span> <span class="o">||</span> <span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_LOWER_THAN_OUTDATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_DISCONNECTING</span><span class="p">));</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">SS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">,</span>
				     <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_DISCONNECTING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Do not test for mdev-&gt;state.conn == C_STANDALONE, since</span>
<span class="cm">		   someone else might connect us in the mean time! */</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_INTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="n">retcode</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">resync_after_online_grow</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iass</span><span class="p">;</span> <span class="cm">/* I am sync source */</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Resync of new storage after online grow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">peer</span><span class="p">)</span>
		<span class="n">iass</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">iass</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DISCARD_CONCURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iass</span><span class="p">)</span>
		<span class="n">drbd_start_resync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">C_SYNC_SOURCE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_WF_SYNC_UUID</span><span class="p">),</span> <span class="n">CS_VERBOSE</span> <span class="o">+</span> <span class="n">CS_SERIALIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resize</span> <span class="n">rs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">determine_dev_size</span> <span class="n">dd</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dds_flags</span> <span class="n">ddsf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resize</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resize_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_RESIZE_RESYNC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_SECONDARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NO_PRIMARY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NO_DISK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">no_resync</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">93</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NEED_APV_93</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_ldev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">known_size</span> <span class="o">!=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">))</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">known_size</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">rs</span><span class="p">.</span><span class="n">resize_size</span><span class="p">;</span>
	<span class="n">ddsf</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">resize_force</span> <span class="o">?</span> <span class="n">DDSF_FORCED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">no_resync</span> <span class="o">?</span> <span class="n">DDSF_NO_RESYNC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="n">drbd_determine_dev_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ddsf</span><span class="p">);</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span> <span class="o">==</span> <span class="n">dev_size_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM_BITMAP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span> <span class="o">==</span> <span class="n">grew</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RESIZE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_send_sizes</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ddsf</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">fail:</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail_ldev:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_syncer_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ovr</span><span class="p">;</span> <span class="cm">/* online verify running */</span>
	<span class="kt">int</span> <span class="n">rsr</span><span class="p">;</span> <span class="cm">/* re-sync running */</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">verify_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_hash</span> <span class="o">*</span><span class="n">csums_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">syncer_conf</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">new_cpu_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">rs_plan_s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_cpu_mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRBD_NL_SET_DEFAULTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">syncer_conf</span><span class="p">));</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">rate</span>       <span class="o">=</span> <span class="n">DRBD_RATE_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">after</span>      <span class="o">=</span> <span class="n">DRBD_AFTER_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">=</span> <span class="n">DRBD_AL_EXTENTS_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">on_no_data</span>  <span class="o">=</span> <span class="n">DRBD_ON_NO_DATA_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">c_plan_ahead</span> <span class="o">=</span> <span class="n">DRBD_C_PLAN_AHEAD_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">c_delay_target</span> <span class="o">=</span> <span class="n">DRBD_C_DELAY_TARGET_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">c_fill_target</span> <span class="o">=</span> <span class="n">DRBD_C_FILL_TARGET_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">c_max_rate</span> <span class="o">=</span> <span class="n">DRBD_C_MAX_RATE_DEF</span><span class="p">;</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">c_min_rate</span> <span class="o">=</span> <span class="n">DRBD_C_MIN_RATE_DEF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">syncer_conf</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">syncer_conf_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* re-sync running */</span>
	<span class="n">rsr</span> <span class="o">=</span> <span class="p">(</span>	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">||</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span> <span class="o">||</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_S</span> <span class="o">||</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsr</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_CSUMS_RESYNC_RUNNING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsr</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">csums_tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">csums_tfm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">csums_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_CSUMS_ALG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_crypto_is_hash</span><span class="p">(</span><span class="n">crypto_hash_tfm</span><span class="p">(</span><span class="n">csums_tfm</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_CSUMS_ALG_ND</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* online verify running */</span>
	<span class="n">ovr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_VERIFY_RUNNING</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovr</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">verify_tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_hash</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">verify_tfm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">verify_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_VERIFY_ALG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_crypto_is_hash</span><span class="p">(</span><span class="n">crypto_hash_tfm</span><span class="p">(</span><span class="n">verify_tfm</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_VERIFY_ALG_ND</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* silently ignore cpu mask on UP kernel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_cpu_ids</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="p">.</span><span class="n">cpu_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_parse</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">cpu_mask</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
				<span class="n">cpumask_bits</span><span class="p">(</span><span class="n">new_cpu_mask</span><span class="p">),</span> <span class="n">nr_cpu_ids</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;bitmap_parse() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_CPU_MASK_PARSE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ERR_IF</span> <span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">sc</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ERR_IF</span> <span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="n">sc</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span> <span class="cm">/* arbitrary minimum */</span>
<span class="cp">#define AL_MAX ((MD_AL_MAX_SIZE-1) * AL_EXTENTS_PT)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">&gt;</span> <span class="n">AL_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;sc.al_extents &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">AL_MAX</span><span class="p">);</span>
		<span class="n">sc</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">=</span> <span class="n">AL_MAX</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#undef AL_MAX</span>

	<span class="cm">/* to avoid spurious errors when configuring minors before configuring</span>
<span class="cm">	 * the minors they depend on: if necessary, first create the minor we</span>
<span class="cm">	 * depend on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">after</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ensure_mdev</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">after</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* most sanity checks done, try to assign the new sync-after</span>
<span class="cm">	 * dependency.  need to hold the global lock in there,</span>
<span class="cm">	 * to avoid a race in the dependency loop check. */</span>
	<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_alter_sa</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sc</span><span class="p">.</span><span class="n">after</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">fifo_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">c_plan_ahead</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">SLEEP_TIME</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_size</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">fifo_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rs_plan_s</span>   <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs_plan_s</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;kmalloc of fifo_buffer failed&quot;</span><span class="p">);</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ok, assign the rest of it as well.</span>
<span class="cm">	 * lock against receive_SyncParam() */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span> <span class="o">=</span> <span class="n">csums_tfm</span><span class="p">;</span>
		<span class="n">csums_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ovr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span> <span class="o">=</span> <span class="n">verify_tfm</span><span class="p">;</span>
		<span class="n">verify_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_size</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">values</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">rs_plan_s</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_plan_s</span><span class="p">.</span><span class="n">size</span>   <span class="o">=</span> <span class="n">fifo_size</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_planed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rs_plan_s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">,</span> <span class="n">lc_try_lock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">));</span>
		<span class="n">drbd_al_shrink</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_check_al_size</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">lc_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>

		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">drbd_send_sync_param</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpumask_equal</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">,</span> <span class="n">new_cpu_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">,</span> <span class="n">new_cpu_mask</span><span class="p">);</span>
		<span class="n">drbd_calc_cpu_mask</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">.</span><span class="n">reset_cpu_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">.</span><span class="n">reset_cpu_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">.</span><span class="n">reset_cpu_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rs_plan_s</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">new_cpu_mask</span><span class="p">);</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">csums_tfm</span><span class="p">);</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">verify_tfm</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_invalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retcode</span><span class="p">;</span>

	<span class="cm">/* If there is still bitmap IO pending, probably because of a previous</span>
<span class="cm">	 * resync just being finished, wait for it before requesting a new resync. */</span>
	<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="n">retcode</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_STARTING_SYNC_T</span><span class="p">),</span> <span class="n">CS_ORDERED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">retcode</span> <span class="o">!=</span> <span class="n">SS_NEED_CONNECTION</span><span class="p">)</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_STARTING_SYNC_T</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_NEED_CONNECTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">_NS</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">D_INCONSISTENT</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">SS_NEED_CONNECTION</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_STARTING_SYNC_T</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_bmio_set_susp_al</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_bmio_set_n_write</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_suspend_al</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_invalidate_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retcode</span><span class="p">;</span>

	<span class="cm">/* If there is still bitmap IO pending, probably because of a previous</span>
<span class="cm">	 * resync just being finished, wait for it before requesting a new resync. */</span>
	<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="n">retcode</span> <span class="o">=</span> <span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_STARTING_SYNC_S</span><span class="p">),</span> <span class="n">CS_ORDERED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">SS_NEED_CONNECTION</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The peer will get a resync upon connect anyways. Just make that</span>
<span class="cm">			   into a full resync. */</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">pdsk</span><span class="p">,</span> <span class="n">D_INCONSISTENT</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retcode</span> <span class="o">&gt;=</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bmio_set_susp_al</span><span class="p">,</span>
					<span class="s">&quot;set_n_write from invalidate_peer&quot;</span><span class="p">,</span>
					<span class="n">BM_LOCKED_SET_ALLOWED</span><span class="p">))</span>
					<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_STARTING_SYNC_S</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_pause_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">user_isp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">)</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_PAUSE_IS_SET</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_resume_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">user_isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_S</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">?</span> <span class="n">ERR_PIC_AFTER_DEP</span> <span class="o">:</span>
				  <span class="n">s</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">?</span> <span class="n">ERR_PIC_PEER_DEP</span> <span class="o">:</span> <span class="n">ERR_PAUSE_IS_CLEAR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_PAUSE_IS_CLEAR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_suspend_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">susp</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_resume_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_uuid_new_current</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS3</span><span class="p">(</span><span class="n">susp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">susp_nod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">susp_fen</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
			<span class="n">tl_clear</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_FAILED</span><span class="p">)</span>
			<span class="n">tl_restart</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">fail_frozen_disk_io</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_outdate</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_OUTDATED</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_get_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="n">disk_conf_to_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="n">net_conf_to_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>
		<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tl</span> <span class="o">=</span> <span class="n">syncer_conf_to_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>

	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rs_left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">get_state_to_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">get_state</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>

	<span class="cm">/* no local ref, no bitmap, no syncer progress. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drbd_get_syncer_progress</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
			<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_int</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_sync_progress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_get_uuids</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_blob</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_uuids</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">UI_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_int</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_uuids_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_nl_get_timeout_flag() - Used by drbdsetup to find out which timeout value to use</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @nlp:	Netlink/connector packet from drbdsetup</span>
<span class="cm"> * @reply:	Reply packet for drbdsetup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_get_timeout_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_OUTDATED</span>        <span class="o">?</span> <span class="n">UT_PEER_OUTDATED</span> <span class="o">:</span>
	  <span class="n">test_bit</span><span class="p">(</span><span class="n">USE_DEGR_WFC_T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="n">UT_DEGRADED</span> <span class="o">:</span> <span class="n">UT_DEFAULT</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_blob</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_use_degraded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rv</span><span class="p">));</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_start_ov</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* default to resume from last known position, if possible */</span>
	<span class="k">struct</span> <span class="n">start_ov</span> <span class="n">args</span> <span class="o">=</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">start_sector</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_ov_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If there is still bitmap IO pending, e.g. previous resync or verify</span>
<span class="cm">	 * just being finished, wait for it before requesting a new resync. */</span>
	<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="cm">/* w_make_ov_request expects position to be aligned */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">start_sector</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BM_SECT_PER_BIT</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span><span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">C_VERIFY_S</span><span class="p">));</span>
	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_nl_new_c_uuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip_initial_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">new_c_uuid</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">new_c_uuid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_c_uuid_from_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">ERR_MANDATORY_TAG</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span> <span class="cm">/* Protects us against serialized state changes. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NO_DISK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* this is &quot;skip initial sync&quot;, assume to be clean */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]</span> <span class="o">==</span> <span class="n">UUID_JUST_CREATED</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="p">.</span><span class="n">clear_bm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Preparing to skip initial sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">skip_initial_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STANDALONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_CONNECTED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_dec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_BITMAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Rotate UI_BITMAP to History 1, etc... */</span>
	<span class="n">drbd_uuid_new_current</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* New current, previous to UI_BITMAP */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">clear_bm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bmio_clear_n_write</span><span class="p">,</span>
			<span class="s">&quot;clear_n_write from new_c_uuid&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Writing bitmap failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip_initial_sync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_send_uuids_skip_initial_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_BITMAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">drbd_print_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;cleared bitmap UUID&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
			<span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">_NS2</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">D_UP_TO_DATE</span><span class="p">,</span> <span class="n">pdsk</span><span class="p">,</span> <span class="n">D_UP_TO_DATE</span><span class="p">),</span>
					<span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="nl">out_dec:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cn_handler_struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reply_body_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cn_handler_struct</span> <span class="n">cnd_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">P_primary</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_primary</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_secondary</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_secondary</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_disk_conf</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_disk_conf</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_detach</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_detach</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_net_conf</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_net_conf</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_disconnect</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_disconnect</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_resize</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_resize</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_syncer_conf</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_syncer_conf</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_invalidate</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_invalidate</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_invalidate_peer</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_invalidate_peer</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_pause_sync</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_pause_sync</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_resume_sync</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_resume_sync</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_suspend_io</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_suspend_io</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_resume_io</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_resume_io</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_outdate</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_outdate</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_get_config</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_get_config</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">syncer_conf_tag_len_struct</span><span class="p">)</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">disk_conf_tag_len_struct</span><span class="p">)</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_conf_tag_len_struct</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_get_state</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_get_state</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">get_state_tag_len_struct</span><span class="p">)</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sync_progress_tag_len_struct</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">[</span> <span class="n">P_get_uuids</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_get_uuids</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">get_uuids_tag_len_struct</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_get_timeout_flag</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_get_timeout_flag</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">get_timeout_flag_tag_len_struct</span><span class="p">)},</span>
	<span class="p">[</span> <span class="n">P_start_ov</span> <span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_start_ov</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span> <span class="n">P_new_c_uuid</span> <span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">drbd_nl_new_c_uuid</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_connector_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_skb_parms</span> <span class="o">*</span><span class="n">nsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="n">nlp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cn_handler_struct</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">cn_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retcode</span><span class="p">,</span> <span class="n">rr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reply_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span><span class="p">)</span>
		<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span>
		<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span> <span class="kt">int</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drbd: try_module_get() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_PERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span> <span class="o">=</span> <span class="n">ensure_mdev</span><span class="p">(</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">drbd_minor</span><span class="p">,</span>
			<span class="p">(</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRBD_NL_CREATE_DEVICE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_MINOR_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">&gt;=</span> <span class="n">P_nl_after_last_packet</span> <span class="o">||</span>
	    <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">==</span> <span class="n">P_return_code_only</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_PACKET_NR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cm</span> <span class="o">=</span> <span class="n">cnd_table</span> <span class="o">+</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">packet_type</span><span class="p">;</span>

	<span class="cm">/* This may happen if packet number is 0: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_PACKET_NR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply_size</span> <span class="o">+=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">reply_body_size</span><span class="p">;</span>

	<span class="cm">/* allocation not in the IO path, cqueue thread context */</span>
	<span class="n">cn_reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">reply_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cn_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">ERR_NOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="p">)</span> <span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">=</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">reply_body_size</span> <span class="o">?</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">:</span> <span class="n">P_return_code_only</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">drbd_minor</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span> <span class="cm">/* Might by modified by cm-&gt;function. */</span>
	<span class="cm">/* reply-&gt;tag_list; might be modified by cm-&gt;function. */</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nlp</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ack</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span> <span class="o">+</span> <span class="n">rr</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">,</span> <span class="n">CN_IDX_DRBD</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">rr</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drbd: cn_netlink_send()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">drbd_nl_send_reply</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">retcode</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">drbd_nl_seq</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* two. */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span>
<span class="nf">__tl_add_blob</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_tags</span> <span class="n">tag</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nul_terminated</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">l</span> <span class="o">=</span> <span class="n">tag_descriptions</span><span class="p">[</span><span class="n">tag_number</span><span class="p">(</span><span class="n">tag</span><span class="p">)].</span><span class="n">max_len</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">)</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span>  <span class="n">l</span><span class="p">;</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">tl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nul_terminated</span><span class="p">)</span>
		<span class="o">*</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span>
<span class="nf">tl_add_blob</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_tags</span> <span class="n">tag</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__tl_add_blob</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span>
<span class="nf">tl_add_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_tags</span> <span class="n">tag</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__tl_add_blob</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span>
<span class="nf">tl_add_int</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_tags</span> <span class="n">tag</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">tag_type</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TT_INTEGER</span>:
		<span class="n">put_unaligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span>
		<span class="n">put_unaligned</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span><span class="p">);</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">tl</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TT_INT64</span>:
		<span class="n">put_unaligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span>
		<span class="n">put_unaligned</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span><span class="p">);</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">tl</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* someone did something stupid. */</span>
		<span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_bcast_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">get_state_tag_len_struct</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span> <span class="kt">int</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">cn_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="p">)</span><span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>

	<span class="cm">/* dev_warn(DEV, &quot;drbd_bcast_state() got called\n&quot;); */</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">get_state_to_tags</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">get_state</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>

	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">CN_IDX_DRBD</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">CN_VAL_DRBD</span><span class="p">;</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_nl_seq</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not used here. */</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">=</span> <span class="n">P_get_state</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>

	<span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">,</span> <span class="n">CN_IDX_DRBD</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_bcast_ev_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">helper_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">call_helper_tag_len_struct</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span> <span class="kt">int</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">cn_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="p">)</span><span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>

	<span class="cm">/* dev_warn(DEV, &quot;drbd_bcast_state() got called\n&quot;); */</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_str</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_helper</span><span class="p">,</span> <span class="n">helper_name</span><span class="p">);</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">CN_IDX_DRBD</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">CN_VAL_DRBD</span><span class="p">;</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_nl_seq</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not used here. */</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">=</span> <span class="n">P_call_helper</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>

	<span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">,</span> <span class="n">CN_IDX_DRBD</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_bcast_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">dgs</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">seen_hash</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">calc_hash</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">cn_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reason</span> <span class="o">||</span> <span class="o">!</span><span class="n">reason</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* apparently we have to memcpy twice, first to prepare the data for the</span>
<span class="cm">	 * struct cn_msg, then within cn_netlink_send from the cn_msg to the</span>
<span class="cm">	 * netlink skb. */</span>
	<span class="cm">/* receiver thread context, which is not in the writeout path (of this node),</span>
<span class="cm">	 * but may be in the writeout path of the _other_ node.</span>
<span class="cm">	 * GFP_NOIO to avoid potential &quot;distributed deadlock&quot;. */</span>
	<span class="n">cn_reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span><span class="p">)</span><span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span><span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dump_ee_tag_len_struct</span><span class="p">)</span><span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span> <span class="kt">int</span><span class="p">),</span>
		<span class="n">GFP_NOIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cn_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;could not kmalloc buffer for drbd_bcast_ee, sector %llu, size %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="o">*</span><span class="p">)</span><span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_str</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_dump_ee_reason</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_blob</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_seen_digest</span><span class="p">,</span> <span class="n">seen_hash</span><span class="p">,</span> <span class="n">dgs</span><span class="p">);</span>
	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_blob</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_calc_digest</span><span class="p">,</span> <span class="n">calc_hash</span><span class="p">,</span> <span class="n">dgs</span><span class="p">);</span>
	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_int</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_ee_sector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_int</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_ee_block_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">);</span>

	<span class="cm">/* dump the first 32k */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">T_ee_data</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>
	<span class="n">page_chain_for_each</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">l</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="n">tl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">+</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">CN_IDX_DRBD</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">CN_VAL_DRBD</span><span class="p">;</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">drbd_nl_seq</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// not used here.</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">=</span> <span class="n">P_dump_ee</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>

	<span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">,</span> <span class="n">CN_IDX_DRBD</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_bcast_sync_progress</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sync_progress_tag_len_struct</span><span class="p">)</span><span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span> <span class="kt">int</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">cn_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="p">)</span><span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tl</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rs_left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* no local ref, no bitmap, no syncer progress, no broadcast. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">drbd_get_syncer_progress</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="n">tl_add_int</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">T_sync_progress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="n">put_unaligned</span><span class="p">(</span><span class="n">TT_END</span><span class="p">,</span> <span class="n">tl</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* Close the tag list */</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">CN_IDX_DRBD</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">CN_VAL_DRBD</span><span class="p">;</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_nl_seq</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not used here. */</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tl</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">tag_list</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">=</span> <span class="n">P_sync_progress</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>

	<span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">,</span> <span class="n">CN_IDX_DRBD</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">drbd_nl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">cb_id</span> <span class="n">cn_id_drbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">try</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span>

	<span class="n">cn_id_drbd</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">CN_VAL_DRBD</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cn_id_drbd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">cn_idx</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cn_add_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cn_id_drbd</span><span class="p">,</span> <span class="s">&quot;cn_drbd&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_connector_callback</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cn_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cn_idx</span> <span class="o">+</span> <span class="n">CN_IDX_STEP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">try</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drbd: cn_drbd failed to register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_nl_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">cb_id</span> <span class="n">cn_id_drbd</span><span class="p">;</span>

	<span class="n">cn_id_drbd</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">cn_idx</span><span class="p">;</span>
	<span class="n">cn_id_drbd</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">CN_VAL_DRBD</span><span class="p">;</span>

	<span class="n">cn_del_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cn_id_drbd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_nl_send_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">cn_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span> <span class="o">*</span><span class="p">)</span><span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ack</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_reply</span><span class="p">);</span>
	<span class="n">cn_reply</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">packet_type</span> <span class="o">=</span> <span class="n">P_return_code_only</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">drbd_nl_cfg_req</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">drbd_minor</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">ret_code</span> <span class="o">=</span> <span class="n">ret_code</span><span class="p">;</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">cn_reply</span><span class="p">,</span> <span class="n">CN_IDX_DRBD</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">rr</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drbd: cn_netlink_send()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
