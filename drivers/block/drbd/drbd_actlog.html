<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › drbd › drbd_actlog.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drbd_actlog.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   drbd_actlog.c</span>

<span class="cm">   This file is part of DRBD by Philipp Reisner and Lars Ellenberg.</span>

<span class="cm">   Copyright (C) 2003-2008, LINBIT Information Technologies GmbH.</span>
<span class="cm">   Copyright (C) 2003-2008, Philipp Reisner &lt;philipp.reisner@linbit.com&gt;.</span>
<span class="cm">   Copyright (C) 2003-2008, Lars Ellenberg &lt;lars.ellenberg@linbit.com&gt;.</span>

<span class="cm">   drbd is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm">   any later version.</span>

<span class="cm">   drbd is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with drbd; see the file COPYING.  If not, write to</span>
<span class="cm">   the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/drbd.h&gt;</span>
<span class="cp">#include &quot;drbd_int.h&quot;</span>
<span class="cp">#include &quot;drbd_wrappers.h&quot;</span>

<span class="cm">/* We maintain a trivial checksum in our on disk activity log.</span>
<span class="cm"> * With that we can ensure correct operation even when the storage</span>
<span class="cm"> * device might do a partial (last) sector write while losing power.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">__packed</span> <span class="n">al_transaction</span> <span class="p">{</span>
	<span class="n">u32</span>       <span class="n">magic</span><span class="p">;</span>
	<span class="n">u32</span>       <span class="n">tr_number</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__packed</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">extent</span><span class="p">;</span> <span class="p">}</span> <span class="n">updates</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">AL_EXTENTS_PT</span><span class="p">];</span>
	<span class="n">u32</span>       <span class="n">xor_sum</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">update_odbm_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_work</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">update_al_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_work</span> <span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">al_ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">;</span>
	<span class="cm">/* if old_enr != LC_FREE, write corresponding bitmap sector, too */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_enr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">drbd_atodb_wait</span> <span class="p">{</span>
	<span class="n">atomic_t</span>           <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>  <span class="n">io_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span>   <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">int</span>                <span class="n">error</span><span class="p">;</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="n">w_al_write_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">drbd_md_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_in_use</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;=</span> <span class="n">D_FAILED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">page_address</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_md_put_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_in_use</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">md_io_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ds</span> <span class="o">&gt;=</span> <span class="n">D_NEGOTIATING</span> <span class="o">||</span> <span class="n">ds</span> <span class="o">==</span> <span class="n">D_ATTACHING</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wait_until_done_or_disk_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_timeout</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dt</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>

	<span class="n">dt</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">*</span><span class="n">done</span> <span class="o">||</span> <span class="o">!</span><span class="n">md_io_allowed</span><span class="p">(</span><span class="n">mdev</span><span class="p">),</span> <span class="n">dt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;meta-data IO operation timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_md_sync_page_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_NO_FUA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">rw</span> <span class="o">|=</span> <span class="n">REQ_FUA</span> <span class="o">|</span> <span class="n">REQ_FLUSH</span><span class="p">;</span>
	<span class="n">rw</span> <span class="o">|=</span> <span class="n">REQ_SYNC</span><span class="p">;</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc_drbd</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">drbd_md_io_complete</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">rw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/* Corresponding put_ldev in drbd_md_io_complete() */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERT FAILED: get_ldev_if_state() == 1 in _drbd_md_sync_page_io()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bio_get</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span> <span class="cm">/* one bio_put() is in the completion handler */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_in_use</span><span class="p">);</span> <span class="cm">/* drbd_md_put_buffer() is in the completion handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_insert_fault</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="n">DRBD_FAULT_MD_WR</span> <span class="o">:</span> <span class="n">DRBD_FAULT_MD_RD</span><span class="p">))</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="n">wait_until_done_or_disk_failure</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">bio_flagged</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">BIO_UPTODATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io</span><span class="p">.</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_md_sync_page_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
			 <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">logical_block_size</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">iop</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_in_use</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">);</span>

	<span class="n">logical_block_size</span> <span class="o">=</span> <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logical_block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">logical_block_size</span> <span class="o">=</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">;</span>

	<span class="cm">/* in case logical_block_size != 512 [ s390 only? ] */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logical_block_size</span> <span class="o">!=</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">logical_block_size</span> <span class="o">/</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">logical_block_size</span> <span class="o">==</span> <span class="p">(</span><span class="n">mask</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">iop</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* these are GFP_KERNEL pages, pre-allocated</span>
<span class="cm">			 * on device initialization */</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span><span class="p">);</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span><span class="p">);</span>

			<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_md_sync_page_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">iop</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span>
					<span class="n">READ</span><span class="p">,</span> <span class="n">logical_block_size</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_md_sync_page_io(,%llus,&quot;</span>
				    <span class="s">&quot;READ [logical_block_size!=512]) failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">hp</span> <span class="o">+</span> <span class="n">offset</span><span class="o">*</span><span class="n">MD_SECTOR_SIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&lt;</span> <span class="n">drbd_md_first_sector</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">sector</span> <span class="o">&gt;</span> <span class="n">drbd_md_last_sector</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s [%d]:%s(,%llus,%s) out of range md access!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;WRITE&quot;</span> <span class="o">:</span> <span class="s">&quot;READ&quot;</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_md_sync_page_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">iop</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">logical_block_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_md_sync_page_io(,%llus,%s) failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;WRITE&quot;</span> <span class="o">:</span> <span class="s">&quot;READ&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">logical_block_size</span> <span class="o">!=</span> <span class="n">MD_SECTOR_SIZE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span><span class="p">);</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hp</span> <span class="o">+</span> <span class="n">offset</span><span class="o">*</span><span class="n">MD_SECTOR_SIZE</span><span class="p">,</span> <span class="n">MD_SECTOR_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="nf">_al_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">al_ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>     <span class="n">al_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wake</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">lc_find</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">enr</span><span class="o">/</span><span class="n">AL_EXT_PER_BM_SECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bm_extent</span>  <span class="o">*</span><span class="n">bm_ext</span> <span class="o">=</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wake</span> <span class="o">=</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BME_PRIORITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">al_ext</span>   <span class="o">=</span> <span class="n">lc_get</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
	<span class="n">al_flags</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	if (!al_ext) {</span>
<span class="cm">		if (al_flags &amp; LC_STARVING)</span>
<span class="cm">			dev_warn(DEV, &quot;Have to wait for LRU element (AL too small?)\n&quot;);</span>
<span class="cm">		if (al_flags &amp; LC_DIRTY)</span>
<span class="cm">			dev_warn(DEV, &quot;Ongoing AL update (AL device too slow?)\n&quot;);</span>
<span class="cm">	}</span>
<span class="cm">	*/</span>

	<span class="k">return</span> <span class="n">al_ext</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_al_begin_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">AL_EXTENT_SHIFT</span><span class="o">-</span><span class="mi">9</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">al_ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">update_al_work</span> <span class="n">al_work</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">,</span> <span class="p">(</span><span class="n">al_ext</span> <span class="o">=</span> <span class="n">_al_get</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">al_ext</span><span class="o">-&gt;</span><span class="n">lc_number</span> <span class="o">!=</span> <span class="n">enr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* drbd_al_write_transaction(mdev,al_ext,enr);</span>
<span class="cm">		 * recurses into generic_make_request(), which</span>
<span class="cm">		 * disallows recursion, bios being serialized on the</span>
<span class="cm">		 * current-&gt;bio_tail list now.</span>
<span class="cm">		 * we have to delegate updates to the activity log</span>
<span class="cm">		 * to the worker thread. */</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">al_work</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
		<span class="n">al_work</span><span class="p">.</span><span class="n">al_ext</span> <span class="o">=</span> <span class="n">al_ext</span><span class="p">;</span>
		<span class="n">al_work</span><span class="p">.</span><span class="n">enr</span> <span class="o">=</span> <span class="n">enr</span><span class="p">;</span>
		<span class="n">al_work</span><span class="p">.</span><span class="n">old_enr</span> <span class="o">=</span> <span class="n">al_ext</span><span class="o">-&gt;</span><span class="n">lc_number</span><span class="p">;</span>
		<span class="n">al_work</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_al_write_transaction</span><span class="p">;</span>
		<span class="n">drbd_queue_work_front</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al_work</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">al_work</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>

		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_writ_cnt</span><span class="o">++</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
		<span class="n">lc_changed</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">al_ext</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_al_complete_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">AL_EXTENT_SHIFT</span><span class="o">-</span><span class="mi">9</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">extent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">extent</span> <span class="o">=</span> <span class="n">lc_find</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;al_complete_io() called on inactive extent %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lc_put</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">extent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if (PAGE_SHIFT + 3) &lt; (AL_EXTENT_SHIFT - BM_BLOCK_SHIFT)</span>
<span class="cm">/* Currently BM_BLOCK_SHIFT, BM_EXT_SHIFT and AL_EXTENT_SHIFT</span>
<span class="cm"> * are still coupled, or assume too much about their relation.</span>
<span class="cm"> * Code below will not work if this is violated.</span>
<span class="cm"> * Will be cleaned up with some followup patch.</span>
<span class="cm"> */</span>
<span class="cp"># error FIXME</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">al_extent_to_bm_page</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">al_enr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">al_enr</span> <span class="o">&gt;&gt;</span>
		<span class="cm">/* bit to page */</span>
		<span class="p">((</span><span class="n">PAGE_SHIFT</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span>
		<span class="cm">/* al extent number to bit */</span>
		 <span class="p">(</span><span class="n">AL_EXTENT_SHIFT</span> <span class="o">-</span> <span class="n">BM_BLOCK_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rs_extent_to_bm_page</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rs_enr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rs_enr</span> <span class="o">&gt;&gt;</span>
		<span class="cm">/* bit to page */</span>
		<span class="p">((</span><span class="n">PAGE_SHIFT</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span>
		<span class="cm">/* al extent number to bit */</span>
		 <span class="p">(</span><span class="n">BM_EXT_SHIFT</span> <span class="o">-</span> <span class="n">BM_BLOCK_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">w_al_write_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">update_al_work</span> <span class="o">*</span><span class="n">aw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">update_al_work</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">updated</span> <span class="o">=</span> <span class="n">aw</span><span class="o">-&gt;</span><span class="n">al_ext</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_enr</span> <span class="o">=</span> <span class="n">aw</span><span class="o">-&gt;</span><span class="n">enr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">evicted</span> <span class="o">=</span> <span class="n">aw</span><span class="o">-&gt;</span><span class="n">old_enr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">al_transaction</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">mx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extent_nr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xor_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
			<span class="s">&quot;disk is %s, cannot start al transaction (-%d +%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span><span class="p">),</span> <span class="n">evicted</span><span class="p">,</span> <span class="n">new_enr</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">update_al_work</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* do we have to do a bitmap write, first?</span>
<span class="cm">	 * TODO reduce maximum latency:</span>
<span class="cm">	 * submit both bios, then wait for both,</span>
<span class="cm">	 * instead of doing two synchronous sector writes.</span>
<span class="cm">	 * For now, we must not write the transaction,</span>
<span class="cm">	 * if we cannot write out the bitmap of the evicted extent. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">evicted</span> <span class="o">!=</span> <span class="n">LC_FREE</span><span class="p">)</span>
		<span class="n">drbd_bm_write_page</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">al_extent_to_bm_page</span><span class="p">(</span><span class="n">evicted</span><span class="p">));</span>

	<span class="cm">/* The bitmap write may have failed, causing a state change. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
			<span class="s">&quot;disk is %s, cannot write al transaction (-%d +%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span><span class="p">),</span> <span class="n">evicted</span><span class="p">,</span> <span class="n">new_enr</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">update_al_work</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">drbd_md_get_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span> <span class="cm">/* protects md_io_buffer, al_tr_cycle, ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;disk failed while waiting for md_io buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">update_al_work</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">DRBD_MAGIC</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">tr_number</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_number</span><span class="p">);</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">lc_index_of</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">updated</span><span class="p">);</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">extent</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">new_enr</span><span class="p">);</span>

	<span class="n">xor_sum</span> <span class="o">^=</span> <span class="n">new_enr</span><span class="p">;</span>

	<span class="n">mx</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">AL_EXTENTS_PT</span><span class="p">,</span>
		   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_cycle</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_cycle</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">extent_nr</span> <span class="o">=</span> <span class="n">lc_element_by_index</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lc_number</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">extent</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">extent_nr</span><span class="p">);</span>
		<span class="n">xor_sum</span> <span class="o">^=</span> <span class="n">extent_nr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AL_EXTENTS_PT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">pos</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">extent</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be32</span><span class="p">(</span><span class="n">LC_FREE</span><span class="p">);</span>
		<span class="n">xor_sum</span> <span class="o">^=</span> <span class="n">LC_FREE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_cycle</span> <span class="o">+=</span> <span class="n">AL_EXTENTS_PT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_cycle</span> <span class="o">&gt;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">xor_sum</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">xor_sum</span><span class="p">);</span>

	<span class="n">sector</span> <span class="o">=</span>  <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span>
		<span class="o">+</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span> <span class="o">+</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_md_sync_page_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">))</span>
		<span class="n">drbd_chk_io_error</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_pos</span> <span class="o">&gt;</span>
	    <span class="n">div_ceil</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">,</span> <span class="n">AL_EXTENTS_PT</span><span class="p">))</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_pos</span> <span class="o">&lt;</span> <span class="n">MD_AL_MAX_SIZE</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_number</span><span class="o">++</span><span class="p">;</span>

	<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">update_al_work</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_al_read_tr() - Read a single transaction from the on disk activity log</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @bdev:	Block device to read form.</span>
<span class="cm"> * @b:		pointer to an al_transaction.</span>
<span class="cm"> * @index:	On disk slot of the transaction to read.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns -1 on IO error, 0 on checksum error and 1 upon success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_al_read_tr</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">al_transaction</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xor_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span> <span class="o">+</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Dont process error normally,</span>
<span class="cm">	 * as this is done before disk is attached! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_md_sync_page_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">DRBD_MAGIC</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AL_EXTENTS_PT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">xor_sum</span> <span class="o">^=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">extent</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">xor_sum</span> <span class="o">==</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">xor_sum</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_al_read_log() - Restores the activity log from its on disk representation.</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @bdev:	Block device to read form.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 on success, returns 0 when reading the log failed due to IO errors.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_al_read_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">al_transaction</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active_extents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transactions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">from_tnr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">to_tnr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cnr</span><span class="p">;</span>

	<span class="n">mx</span> <span class="o">=</span> <span class="n">div_ceil</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">,</span> <span class="n">AL_EXTENTS_PT</span><span class="p">);</span>

	<span class="cm">/* lock out all other meta data io for now,</span>
<span class="cm">	 * and make sure the page is mapped.</span>
<span class="cm">	 */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">drbd_md_get_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Find the valid transaction in the log */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">mx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_al_read_tr</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cnr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">tr_number</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">found_valid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">from</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">to</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">from_tnr</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">;</span>
			<span class="n">to_tnr</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cnr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">from_tnr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">from_tnr</span> <span class="o">-</span> <span class="n">cnr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">from</span> <span class="o">==</span> <span class="n">mx</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">from</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">from_tnr</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cnr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">to_tnr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">cnr</span> <span class="o">-</span> <span class="n">to_tnr</span> <span class="o">==</span> <span class="n">i</span> <span class="o">-</span> <span class="n">to</span><span class="p">);</span>
			<span class="n">to</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">to_tnr</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;No usable activity log found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the valid transactions.</span>
<span class="cm">	 * dev_info(DEV, &quot;Reading from %d to %d.\n&quot;,from,to); */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extent_nr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trn</span><span class="p">;</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_al_read_tr</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ERR_IF</span><span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">cancel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">trn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">tr_number</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

		<span class="cm">/* This loop runs backwards because in the cyclic</span>
<span class="cm">		   elements there might be an old version of the</span>
<span class="cm">		   updated element (in slot 0). So the element in slot 0</span>
<span class="cm">		   can overwrite old versions. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">AL_EXTENTS_PT</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pos</span><span class="p">);</span>
			<span class="n">extent_nr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">updates</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">extent</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">extent_nr</span> <span class="o">==</span> <span class="n">LC_FREE</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">lc_set</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">extent_nr</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
			<span class="n">active_extents</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

		<span class="n">transactions</span><span class="o">++</span><span class="p">;</span>

<span class="nl">cancel:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">to</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">mx</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_number</span> <span class="o">=</span> <span class="n">to_tnr</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_pos</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_pos</span> <span class="o">&gt;</span>
	    <span class="n">div_ceil</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">,</span> <span class="n">AL_EXTENTS_PT</span><span class="p">))</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_tr_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ok, we are done with it */</span>
	<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Found %d transactions (%d active extents) in activity log.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">transactions</span><span class="p">,</span> <span class="n">active_extents</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_al_apply_to_bm() - Sets the bitmap to diry(1) where covered ba active AL extents</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_al_apply_to_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ppb</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">,</span> <span class="n">lc_try_lock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enr</span> <span class="o">=</span> <span class="n">lc_element_by_index</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lc_number</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enr</span> <span class="o">==</span> <span class="n">LC_FREE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">drbd_bm_ALe_set_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
		<span class="n">dynamic_dev_dbg</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;AL: set %d bits in extent %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
		<span class="n">add</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lc_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Marked additional %s as out-of-sync based on AL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">ppsize</span><span class="p">(</span><span class="n">ppb</span><span class="p">,</span> <span class="n">Bit2KB</span><span class="p">(</span><span class="n">add</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_try_lc_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">al_ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="n">al_ext</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span>
		<span class="n">lc_del</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">al_ext</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_al_shrink() - Removes all active extents form the activity log</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Removes all active extents form the activity log, waiting until</span>
<span class="cm"> * the reference count of each entry dropped to 0 first, of course.</span>
<span class="cm"> *</span>
<span class="cm"> * You need to lock mdev-&gt;act_log with lc_try_lock() / lc_unlock()</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_al_shrink</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">al_ext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__LC_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">al_ext</span> <span class="o">=</span> <span class="n">lc_element_by_index</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">al_ext</span><span class="o">-&gt;</span><span class="n">lc_number</span> <span class="o">==</span> <span class="n">LC_FREE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">,</span> <span class="n">_try_lc_del</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">al_ext</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_update_odbm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">update_odbm_work</span> <span class="o">*</span><span class="n">udw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">update_odbm_work</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Can not update on disk bitmap, local IO disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">udw</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drbd_bm_write_page</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">rs_extent_to_bm_page</span><span class="p">(</span><span class="n">udw</span><span class="o">-&gt;</span><span class="n">enr</span><span class="p">));</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">udw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_SYNC_SOURCE</span>:  <span class="k">case</span> <span class="n">C_SYNC_TARGET</span>:
		<span class="k">case</span> <span class="n">C_PAUSED_SYNC_S</span>: <span class="k">case</span> <span class="n">C_PAUSED_SYNC_T</span>:
			<span class="n">drbd_resync_finished</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="cm">/* nothing to do */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">drbd_bcast_sync_progress</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ATTENTION. The AL&#39;s extents are 4MB each, while the extents in the</span>
<span class="cm"> * resync LRU-cache are 16MB each.</span>
<span class="cm"> * The caller of this function has to hold an get_ldev() reference.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO will be obsoleted once we have a caching lru of the on disk bitmap</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_try_clear_on_disk_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">success</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">update_odbm_work</span> <span class="o">*</span><span class="n">udw</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_cnt</span><span class="p">));</span>

	<span class="cm">/* I simply assume that a sector/size pair never crosses</span>
<span class="cm">	 * a 16 MB extent border. (Currently this is true...) */</span>
	<span class="n">enr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_EXT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">lc_get</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span> <span class="o">==</span> <span class="n">enr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
				<span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;BAD! sector=%llus enr=%u rs_left=%d &quot;</span>
				    <span class="s">&quot;rs_failed=%d count=%d cstate=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span>
				     <span class="n">ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_left</span><span class="p">,</span>
				     <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
				     <span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span><span class="p">));</span>

				<span class="cm">/* We don&#39;t expect to be able to clear more bits</span>
<span class="cm">				 * than have been set when we originally counted</span>
<span class="cm">				 * the set bits to cache that value in ext-&gt;rs_left.</span>
<span class="cm">				 * Whatever the reason (disconnect during resync,</span>
<span class="cm">				 * delayed local completion of an application write),</span>
<span class="cm">				 * try to fix it up by recounting here. */</span>
				<span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">=</span> <span class="n">drbd_bm_e_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Normally this element should be in the cache,</span>
<span class="cm">			 * since drbd_rs_begin_io() pulled it already in.</span>
<span class="cm">			 *</span>
<span class="cm">			 * But maybe an application write finished, and we set</span>
<span class="cm">			 * something outside the resync lru_cache in sync.</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">rs_left</span> <span class="o">=</span> <span class="n">drbd_bm_e_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;changing resync lce: %d[%u;%02lx]&quot;</span>
				     <span class="s">&quot; -&gt; %d[%u;00]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_left</span><span class="p">,</span>
				     <span class="n">ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">enr</span><span class="p">,</span> <span class="n">rs_left</span><span class="p">);</span>
				<span class="n">ext</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Kicking resync_lru element enr=%u &quot;</span>
				     <span class="s">&quot;out with rs_failed=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">=</span> <span class="n">rs_left</span><span class="p">;</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">=</span> <span class="n">success</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">lc_changed</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lc_put</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">);</span>
		<span class="cm">/* no race, we are within the al_lock! */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">==</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">udw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">udw</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udw</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udw</span><span class="o">-&gt;</span><span class="n">enr</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span><span class="p">;</span>
				<span class="n">udw</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_update_odbm</span><span class="p">;</span>
				<span class="n">drbd_queue_work_front</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udw</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Could not kmalloc an udw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;lc_get() failed! locked=%d/%d flags=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span><span class="p">,</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">,</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_advance_rs_marks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">still_to_go</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_mark</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_mark</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DRBD_SYNC_MARKS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">last</span> <span class="o">+</span> <span class="n">DRBD_SYNC_MARK_STEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_left</span><span class="p">[</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_mark</span><span class="p">]</span> <span class="o">!=</span> <span class="n">still_to_go</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_PAUSED_SYNC_T</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">next</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_left</span><span class="p">[</span><span class="n">next</span><span class="p">]</span> <span class="o">=</span> <span class="n">still_to_go</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_mark</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* clear the bit corresponding to the piece of storage in question:</span>
<span class="cm"> * size byte of data starting from sector.  Only clear a bits of the affected</span>
<span class="cm"> * one ore more _aligned_ BM_BLOCK_SIZE blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * called by worker on C_SYNC_TARGET and receiver on SyncSource.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__drbd_set_in_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Is called from worker and receiver context _only_ */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbnr</span><span class="p">,</span> <span class="n">ebnr</span><span class="p">,</span> <span class="n">lbnr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">esector</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wake_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_set_in_sync: sector=%llus size=%d nonsense!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>
	<span class="n">esector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">nr_sectors</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">esector</span> <span class="o">&gt;=</span> <span class="n">nr_sectors</span><span class="p">)</span> <span class="n">esector</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">lbnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* we clear it (in sync).</span>
<span class="cm">	 * round up start sector, round down end sector.  we make sure we only</span>
<span class="cm">	 * clear full, aligned, BM_BLOCK_SIZE (4K) blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">esector</span> <span class="o">&lt;</span> <span class="n">BM_SECT_PER_BIT</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">esector</span> <span class="o">==</span> <span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">ebnr</span> <span class="o">=</span> <span class="n">lbnr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ebnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">esector</span> <span class="o">-</span> <span class="p">(</span><span class="n">BM_SECT_PER_BIT</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">sbnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">sector</span> <span class="o">+</span> <span class="n">BM_SECT_PER_BIT</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbnr</span> <span class="o">&gt;</span> <span class="n">ebnr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ok, (capacity &amp; 7) != 0 sometimes, but who cares...</span>
<span class="cm">	 * we count rs_{total,left} in bits, not sectors.</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">drbd_bm_clear_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sbnr</span><span class="p">,</span> <span class="n">ebnr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_advance_rs_marks</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">drbd_try_clear_on_disk_bm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* just wake_up unconditional now, various lc_chaged(),</span>
<span class="cm">		 * lc_put() in drbd_try_clear_on_disk_bm(). */</span>
		<span class="n">wake_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wake_up</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this is intended to set one request worth of data out of sync.</span>
<span class="cm"> * affects at least 1 bit,</span>
<span class="cm"> * and at most 1+DRBD_MAX_BIO_SIZE/BM_BLOCK_SIZE bits.</span>
<span class="cm"> *</span>
<span class="cm"> * called by tl_clear and drbd_send_dblock (==drbd_make_request).</span>
<span class="cm"> * so this can be _any_ process.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__drbd_set_out_of_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbnr</span><span class="p">,</span> <span class="n">ebnr</span><span class="p">,</span> <span class="n">lbnr</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">esector</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;sector: %llus, size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no disk, no metadata, no bitmap to set bits in */</span>

	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>
	<span class="n">esector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">nr_sectors</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">esector</span> <span class="o">&gt;=</span> <span class="n">nr_sectors</span><span class="p">)</span>
		<span class="n">esector</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">lbnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* we set it out of sync,</span>
<span class="cm">	 * we do not need to round anything here */</span>
	<span class="n">sbnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">ebnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">esector</span><span class="p">);</span>

	<span class="cm">/* ok, (capacity &amp; 7) != 0 sometimes, but who cares...</span>
<span class="cm">	 * we count rs_{total,left} in bits, not sectors.  */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">drbd_bm_set_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sbnr</span><span class="p">,</span> <span class="n">ebnr</span><span class="p">);</span>

	<span class="n">enr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_EXT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">lc_find</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
		<span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="nf">_bme_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="n">bm_ext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rs_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span> <span class="o">&gt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">lc_get</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
	<span class="n">bm_ext</span> <span class="o">=</span> <span class="n">e</span> <span class="o">?</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span> <span class="o">!=</span> <span class="n">enr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">=</span> <span class="n">drbd_bm_e_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
			<span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc_changed</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">);</span>
			<span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span><span class="o">++</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rs_flags</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bm_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">LC_STARVING</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Have to wait for element&quot;</span>
			     <span class="s">&quot; (resync LRU too small?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">LC_DIRTY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bm_ext</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_is_in_al</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">al_ext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">enr</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">new_number</span><span class="p">))</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">al_ext</span> <span class="o">=</span> <span class="n">lc_find</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">al_ext</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">al_ext</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	if (unlikely(rv)) {</span>
<span class="cm">		dev_info(DEV, &quot;Delaying sync read until app&#39;s write is done\n&quot;);</span>
<span class="cm">	}</span>
<span class="cm">	*/</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_rs_begin_io() - Gets an extent in the resync LRU cache and sets it to BME_LOCKED</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @sector:	The sector number.</span>
<span class="cm"> *</span>
<span class="cm"> * This functions sleeps on al_wait. Returns 0 on success, -EINTR if interrupted.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_rs_begin_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_EXT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="n">bm_ext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sa</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="cm">/* Step aside 200 times, then grab the extent and let app-IO wait.</span>
<span class="cm">			 200 times -&gt; 20 seconds. */</span>

<span class="nl">retry:</span>
	<span class="n">sig</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bm_ext</span> <span class="o">=</span> <span class="n">_bme_get</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AL_EXT_PER_BM_SECT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">,</span>
					       <span class="o">!</span><span class="n">_is_in_al</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span> <span class="o">*</span> <span class="n">AL_EXT_PER_BM_SECT</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">||</span>
					       <span class="n">test_bit</span><span class="p">(</span><span class="n">BME_PRIORITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_PRIORITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lc_put</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* clears BME_NO_WRITES and eventually BME_PRIORITY */</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span><span class="o">--</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sa</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">sa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span><span class="s">&quot;drbd_rs_begin_io() stepped aside for 20sec.&quot;</span>
					 <span class="s">&quot;Resync stalled?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_try_rs_begin_io() - Gets an extent in the resync LRU cache, does not sleep</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @sector:	The sector number.</span>
<span class="cm"> *</span>
<span class="cm"> * Gets an extent in the resync LRU cache, sets it to BME_NO_WRITES, then</span>
<span class="cm"> * tries to set it to BME_LOCKED. Returns 0 upon success, and -EAGAIN</span>
<span class="cm"> * if there is still application IO going on in this area.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_try_rs_begin_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_EXT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">al_enr</span> <span class="o">=</span> <span class="n">enr</span><span class="o">*</span><span class="n">AL_EXT_PER_BM_SECT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="n">bm_ext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">!=</span> <span class="n">LC_FREE</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">!=</span> <span class="n">enr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* in case you have very heavy scattered io, it may</span>
<span class="cm">		 * stall the syncer undefined if we give up the ref count</span>
<span class="cm">		 * when we try again and requeue.</span>
<span class="cm">		 *</span>
<span class="cm">		 * if we don&#39;t give up the refcount, but the next time</span>
<span class="cm">		 * we are scheduled this extent has been &quot;synced&quot; by new</span>
<span class="cm">		 * application writes, we&#39;d miss the lc_put on the</span>
<span class="cm">		 * extent we keep the refcount on.</span>
<span class="cm">		 * so we remembered which extent we had to try again, and</span>
<span class="cm">		 * if the next requested one is something else, we do</span>
<span class="cm">		 * the lc_put here...</span>
<span class="cm">		 * we also have to wake_up</span>
<span class="cm">		 */</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">lc_find</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span><span class="p">);</span>
		<span class="n">bm_ext</span> <span class="o">=</span> <span class="n">e</span> <span class="o">?</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">=</span> <span class="n">LC_FREE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lc_put</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span><span class="o">--</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_alert</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;LOGIC BUG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* TRY. */</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">lc_try_get</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
	<span class="n">bm_ext</span> <span class="o">=</span> <span class="n">e</span> <span class="o">?</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">proceed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* we did set the BME_NO_WRITES,</span>
<span class="cm">			 * but then could not set BME_LOCKED,</span>
<span class="cm">			 * so we tried again.</span>
<span class="cm">			 * drop the extra reference. */</span>
			<span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">refcnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">refcnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">check_al</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* do we rather want to try later? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span> <span class="o">&gt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
		<span class="cm">/* Do or do not. There is no try. -- Yoda */</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">lc_get</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
		<span class="n">bm_ext</span> <span class="o">=</span> <span class="n">e</span> <span class="o">?</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bm_ext</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rs_flags</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">LC_STARVING</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Have to wait for element&quot;</span>
				     <span class="s">&quot; (resync LRU too small?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">LC_DIRTY</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span> <span class="o">!=</span> <span class="n">enr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">rs_left</span> <span class="o">=</span> <span class="n">drbd_bm_e_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
			<span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc_changed</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_al</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">check_al:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AL_EXT_PER_BM_SECT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">al_enr</span><span class="o">+</span><span class="n">i</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">new_number</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lc_is_used</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">,</span> <span class="n">al_enr</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="nl">proceed:</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">=</span> <span class="n">LC_FREE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">try_again:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">=</span> <span class="n">enr</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_rs_complete_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_EXT</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="n">bm_ext</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">lc_find</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
	<span class="n">bm_ext</span> <span class="o">=</span> <span class="n">e</span> <span class="o">?</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bm_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_rs_complete_io() called, but extent not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_rs_complete_io(,%llu [=%u]) called, &quot;</span>
		    <span class="s">&quot;but refcnt is 0!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">enr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lc_put</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* clear BME_LOCKED, BME_NO_WRITES and BME_PRIORITY */</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span><span class="o">--</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_rs_cancel_all() - Removes all extents from the resync LRU (even BME_LOCKED)</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_rs_cancel_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Makes sure -&gt;resync is there. */</span>
		<span class="n">lc_reset</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">=</span> <span class="n">LC_FREE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_rs_del_all() - Gracefully remove all extents from the resync LRU</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 upon success, -EAGAIN if at least one reference count was</span>
<span class="cm"> * not zero.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_rs_del_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lc_element</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bm_extent</span> <span class="o">*</span><span class="n">bm_ext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ok, -&gt;resync is there. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">lc_element_by_index</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">bm_ext</span> <span class="o">=</span> <span class="n">lc_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_extent</span><span class="p">,</span> <span class="n">lce</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span> <span class="o">==</span> <span class="n">LC_FREE</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">lc_number</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;dropping %u in drbd_rs_del_all, apparently&quot;</span>
				     <span class="s">&quot; got &#39;synced&#39; by application io</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span><span class="p">);</span>
				<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
				<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">=</span> <span class="n">LC_FREE</span><span class="p">;</span>
				<span class="n">lc_put</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">refcnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Retrying drbd_rs_del_all() later. &quot;</span>
				     <span class="s">&quot;refcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">.</span><span class="n">refcnt</span><span class="p">);</span>
				<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
			<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BME_NO_WRITES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
			<span class="n">lc_del</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bm_ext</span><span class="o">-&gt;</span><span class="n">lce</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_rs_failed_io() - Record information on a failure to resync the specified blocks</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @sector:	The sector number.</span>
<span class="cm"> * @size:	Size of failed IO operation, in byte.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_rs_failed_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Is called from worker and receiver context _only_ */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbnr</span><span class="p">,</span> <span class="n">ebnr</span><span class="p">,</span> <span class="n">lbnr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">esector</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wake_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;drbd_rs_failed_io: sector=%llus size=%d nonsense!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>
	<span class="n">esector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">nr_sectors</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">esector</span> <span class="o">&gt;=</span> <span class="n">nr_sectors</span><span class="p">)</span> <span class="n">esector</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">lbnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * round up start sector, round down end sector.  we make sure we only</span>
<span class="cm">	 * handle full, aligned, BM_BLOCK_SIZE (4K) blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">esector</span> <span class="o">&lt;</span> <span class="n">BM_SECT_PER_BIT</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">esector</span> <span class="o">==</span> <span class="p">(</span><span class="n">nr_sectors</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">ebnr</span> <span class="o">=</span> <span class="n">lbnr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ebnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">esector</span> <span class="o">-</span> <span class="p">(</span><span class="n">BM_SECT_PER_BIT</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">sbnr</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">sector</span> <span class="o">+</span> <span class="n">BM_SECT_PER_BIT</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbnr</span> <span class="o">&gt;</span> <span class="n">ebnr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ok, (capacity &amp; 7) != 0 sometimes, but who cares...</span>
<span class="cm">	 * we count rs_{total,left} in bits, not sectors.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">drbd_bm_count_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sbnr</span><span class="p">,</span> <span class="n">ebnr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drbd_try_clear_on_disk_bm</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* just wake_up unconditional now, various lc_chaged(),</span>
<span class="cm">		 * lc_put() in drbd_try_clear_on_disk_bm(). */</span>
		<span class="n">wake_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wake_up</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
