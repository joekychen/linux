<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › drbd › drbd_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drbd_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   drbd.c</span>

<span class="cm">   This file is part of DRBD by Philipp Reisner and Lars Ellenberg.</span>

<span class="cm">   Copyright (C) 2001-2008, LINBIT Information Technologies GmbH.</span>
<span class="cm">   Copyright (C) 1999-2008, Philipp Reisner &lt;philipp.reisner@linbit.com&gt;.</span>
<span class="cm">   Copyright (C) 2002-2008, Lars Ellenberg &lt;lars.ellenberg@linbit.com&gt;.</span>

<span class="cm">   Thanks to Carter Burden, Bart Grantham and Gennadiy Nerubayev</span>
<span class="cm">   from Logicworks, Inc. for making SDP replication support possible.</span>

<span class="cm">   drbd is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm">   any later version.</span>

<span class="cm">   drbd is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with drbd; see the file COPYING.  If not, write to</span>
<span class="cm">   the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/drbd.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/memcontrol.h&gt;</span>
<span class="cp">#include &lt;linux/mm_inline.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>

<span class="cp">#define __KERNEL_SYSCALLS__</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &lt;linux/drbd_limits.h&gt;</span>
<span class="cp">#include &quot;drbd_int.h&quot;</span>
<span class="cp">#include &quot;drbd_req.h&quot; </span><span class="cm">/* only for _req_mod in tl_release and tl_clear */</span><span class="cp"></span>

<span class="cp">#include &quot;drbd_vli.h&quot;</span>

<span class="k">struct</span> <span class="n">after_state_chg_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_work</span> <span class="n">w</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">done</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">drbd_main_mutex</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">drbdd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">drbd_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">drbd_asender</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">drbd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">drbd_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">drbd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gd</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w_after_state_ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">after_state_ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span> <span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w_md_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">md_sync_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w_bitmap_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w_go_diskless</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Philipp Reisner &lt;phil@linbit.com&gt;, &quot;</span>
	      <span class="s">&quot;Lars Ellenberg &lt;lars@linbit.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;drbd - Distributed Replicated Block Device v&quot;</span> <span class="n">REL_VERSION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">REL_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">minor_count</span><span class="p">,</span> <span class="s">&quot;Maximum number of drbd devices (&quot;</span>
		 <span class="n">__stringify</span><span class="p">(</span><span class="n">DRBD_MINOR_COUNT_MIN</span><span class="p">)</span> <span class="s">&quot;-&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">DRBD_MINOR_COUNT_MAX</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_BLOCKDEV_MAJOR</span><span class="p">(</span><span class="n">DRBD_MAJOR</span><span class="p">);</span>

<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cm">/* allow_open_on_secondary */</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">allow_oos</span><span class="p">,</span> <span class="s">&quot;DONT USE!&quot;</span><span class="p">);</span>
<span class="cm">/* thanks to these macros, if compiled into the kernel (not-module),</span>
<span class="cm"> * this becomes the boot parameter drbd.minor_count */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">minor_count</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_sendpage</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">allow_oos</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cn_idx</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">proc_details</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DRBD_FAULT_INJECTION</span>
<span class="kt">int</span> <span class="n">enable_faults</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">fault_rate</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fault_count</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">fault_devs</span><span class="p">;</span>
<span class="cm">/* bitmap of enabled faults */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_faults</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="cm">/* fault rate % value - applies to all enabled faults */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fault_rate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="cm">/* count of faults inserted */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fault_count</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="cm">/* bitmap of devices to insert faults on */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fault_devs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* module parameter, defined */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor_count</span> <span class="o">=</span> <span class="n">DRBD_MINOR_COUNT_DEF</span><span class="p">;</span>
<span class="n">bool</span> <span class="n">disable_sendpage</span><span class="p">;</span>
<span class="n">bool</span> <span class="n">allow_oos</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cn_idx</span> <span class="o">=</span> <span class="n">CN_IDX_DRBD</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">proc_details</span><span class="p">;</span>       <span class="cm">/* Detail level in proc drbd*/</span>

<span class="cm">/* Module parameter for setting the user mode helper program</span>
<span class="cm"> * to run. Default is /sbin/drbdadm */</span>
<span class="kt">char</span> <span class="n">usermode_helper</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;/sbin/drbdadm&quot;</span><span class="p">;</span>

<span class="n">module_param_string</span><span class="p">(</span><span class="n">usermode_helper</span><span class="p">,</span> <span class="n">usermode_helper</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usermode_helper</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/* in 2.6.x, our device mapping and config info contains our virtual gendisks</span>
<span class="cm"> * as member &quot;struct gendisk *vdisk;&quot;</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">**</span><span class="n">minor_table</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">drbd_request_cache</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">drbd_ee_cache</span><span class="p">;</span>	<span class="cm">/* epoch entries */</span>
<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">drbd_bm_ext_cache</span><span class="p">;</span>	<span class="cm">/* bitmap extents */</span>
<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">drbd_al_ext_cache</span><span class="p">;</span>	<span class="cm">/* activity log extents */</span>
<span class="n">mempool_t</span> <span class="o">*</span><span class="n">drbd_request_mempool</span><span class="p">;</span>
<span class="n">mempool_t</span> <span class="o">*</span><span class="n">drbd_ee_mempool</span><span class="p">;</span>
<span class="n">mempool_t</span> <span class="o">*</span><span class="n">drbd_md_io_page_pool</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">bio_set</span> <span class="o">*</span><span class="n">drbd_md_io_bio_set</span><span class="p">;</span>

<span class="cm">/* I do not use a standard mempool, because:</span>
<span class="cm">   1) I want to hand out the pre-allocated objects first.</span>
<span class="cm">   2) I want to be able to interrupt sleeping allocation with a signal.</span>
<span class="cm">   Note: This is a single linked list, the next pointer is the private</span>
<span class="cm">	 member of struct page.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">drbd_pp_pool</span><span class="p">;</span>
<span class="n">spinlock_t</span>   <span class="n">drbd_pp_lock</span><span class="p">;</span>
<span class="kt">int</span>          <span class="n">drbd_pp_vacant</span><span class="p">;</span>
<span class="n">wait_queue_head_t</span> <span class="n">drbd_pp_wait</span><span class="p">;</span>

<span class="n">DEFINE_RATELIMIT_STATE</span><span class="p">(</span><span class="n">drbd_ratelimit_state</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">drbd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>   <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>    <span class="n">drbd_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">drbd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bio_destructor_drbd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bio_free</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">drbd_md_io_bio_set</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">bio_alloc_drbd</span><span class="p">(</span><span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_md_io_bio_set</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bio_alloc</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc_bioset</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">drbd_md_io_bio_set</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_destructor</span> <span class="o">=</span> <span class="n">bio_destructor_drbd</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bio</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef __CHECKER__</span>
<span class="cm">/* When checking with sparse, and this is an inline function, sparse will</span>
<span class="cm">   give tons of false positives. When this is a real functions sparse works.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">_get_ldev_if_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">mins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">io_allowed</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_cnt</span><span class="p">);</span>
	<span class="n">io_allowed</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">mins</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_cnt</span><span class="p">))</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">io_allowed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * DOC: The transfer log</span>
<span class="cm"> *</span>
<span class="cm"> * The transfer log is a single linked list of &amp;struct drbd_tl_epoch objects.</span>
<span class="cm"> * mdev-&gt;newest_tle points to the head, mdev-&gt;oldest_tle points to the tail</span>
<span class="cm"> * of the list. There is always at least one &amp;struct drbd_tl_epoch object.</span>
<span class="cm"> *</span>
<span class="cm"> * Each &amp;struct drbd_tl_epoch has a circular double linked list of requests</span>
<span class="cm"> * attached.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_tl_epoch</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="cm">/* during device minor initialization, we may well use GFP_KERNEL */</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_tl_epoch</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">br_number</span> <span class="o">=</span> <span class="mi">4711</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">n_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* if this is != NULL, we need to dec_ap_pending in tl_clear */</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">newest_tle</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">out_of_sequence_requests</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">barrier_acked_requests</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tl_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">newest_tle</span><span class="p">);</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">out_of_sequence_requests</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unused_spare_tle</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unused_spare_tle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _tl_add_barrier() - Adds a barrier to the transfer log</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @new:	Barrier to be added before the current head of the TL.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller must hold the req_lock.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">_tl_add_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_tl_epoch</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_tl_epoch</span> <span class="o">*</span><span class="n">newest_before</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* if this is != NULL, we need to dec_ap_pending in tl_clear */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">n_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">newest_before</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">newest_tle</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_number</span> <span class="o">=</span> <span class="n">newest_before</span><span class="o">-&gt;</span><span class="n">br_number</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">newest_tle</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">newest_tle</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">newest_tle</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tl_release() - Free or recycle the oldest &amp;struct drbd_tl_epoch object of the TL</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @barrier_nr:	Expected identifier of the DRBD write barrier packet.</span>
<span class="cm"> * @set_size:	Expected number of requests before that barrier.</span>
<span class="cm"> *</span>
<span class="cm"> * In case the passed barrier_nr or set_size does not match the oldest</span>
<span class="cm"> * &amp;struct drbd_tl_epoch objects this function will cause a termination</span>
<span class="cm"> * of the connection.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tl_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">barrier_nr</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_tl_epoch</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">nob</span><span class="p">;</span> <span class="cm">/* next old barrier */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">le</span><span class="p">,</span> <span class="o">*</span><span class="n">tle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span><span class="p">;</span>

	<span class="cm">/* first some paranoia code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;BAD! BarrierAck #%u received, but no epoch in tl!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">barrier_nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">br_number</span> <span class="o">!=</span> <span class="n">barrier_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;BAD! BarrierAck #%u received, expected #%u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">barrier_nr</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">br_number</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">n_writes</span> <span class="o">!=</span> <span class="n">set_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;BAD! BarrierAck #%u received with n_writes=%u, expected n_writes=%u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">barrier_nr</span><span class="p">,</span> <span class="n">set_size</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">n_writes</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clean up list of requests processed during current epoch */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">tl_requests</span><span class="p">);</span>
		<span class="n">_req_mod</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">barrier_acked</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* There could be requests on the list waiting for completion</span>
<span class="cm">	   of the write to the local disk. To avoid corruptions of</span>
<span class="cm">	   slab&#39;s data structures we have to remove the lists head.</span>

<span class="cm">	   Also there could have been a barrier ack out of sequence, overtaking</span>
<span class="cm">	   the write acks - which would be a bug and violating write ordering.</span>
<span class="cm">	   To not deadlock in case we lose connection while such requests are</span>
<span class="cm">	   still pending, we need some way to find them for the</span>
<span class="cm">	   _req_mode(connection_lost_while_pending).</span>

<span class="cm">	   These have been list_move&#39;d to the out_of_sequence_requests list in</span>
<span class="cm">	   _req_mod(, barrier_acked) above.</span>
<span class="cm">	   */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">barrier_acked_requests</span><span class="p">);</span>

	<span class="n">nob</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CREATE_BARRIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_tl_add_barrier</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nob</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span> <span class="o">=</span> <span class="n">nob</span><span class="p">;</span>
		<span class="cm">/* if nob == NULL b was the only barrier, and becomes the new</span>
<span class="cm">		   barrier. Therefore mdev-&gt;oldest_tle points already to b */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">nob</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span> <span class="o">=</span> <span class="n">nob</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">dec_ap_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">bail:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_PROTOCOL_ERROR</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _tl_restart() - Walks the transfer log, and applies an action to all requests</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @what:       The action/event to perform with all request objects</span>
<span class="cm"> *</span>
<span class="cm"> * @what might be one of connection_lost_while_pending, resend, fail_frozen_disk_io,</span>
<span class="cm"> * restart_frozen_disk_io.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_tl_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_req_event</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_tl_epoch</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">**</span><span class="n">pn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">le</span><span class="p">,</span> <span class="o">*</span><span class="n">tle</span><span class="p">,</span> <span class="n">carry_reads</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">n_writes</span><span class="p">,</span> <span class="n">n_reads</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span><span class="p">;</span>
	<span class="n">pn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n_reads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carry_reads</span><span class="p">);</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">tl_requests</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">_req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>

			<span class="n">n_writes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="n">MR_WRITE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MR_WRITE_SHIFT</span><span class="p">;</span>
			<span class="n">n_reads</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="n">MR_READ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MR_READ_SHIFT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n_writes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="n">resend</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b</span><span class="o">-&gt;</span><span class="n">n_writes</span> <span class="o">=</span> <span class="n">n_writes</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_send_barrier</span><span class="p">;</span>
					<span class="n">inc_ap_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">CREATE_BARRIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_reads</span><span class="p">)</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carry_reads</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
			<span class="cm">/* there could still be requests on that ring list,</span>
<span class="cm">			 * in case local io is still pending */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>

			<span class="cm">/* dec_ap_pending corresponding to queue_barrier.</span>
<span class="cm">			 * the newest barrier may not have been queued yet,</span>
<span class="cm">			 * in which case w.cb is still NULL. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">dec_ap_pending</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">newest_tle</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* recycle, but reinit! */</span>
				<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
				<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carry_reads</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
				<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
				<span class="n">b</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">b</span><span class="o">-&gt;</span><span class="n">br_number</span> <span class="o">=</span> <span class="n">net_random</span><span class="p">();</span>
				<span class="n">b</span><span class="o">-&gt;</span><span class="n">n_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="o">*</span><span class="n">pn</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">pn</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carry_reads</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Actions operating on the disk state, also want to work on</span>
<span class="cm">	   requests that got barrier acked. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">fail_frozen_disk_io</span>:
	<span class="k">case</span> <span class="n">restart_frozen_disk_io</span>:
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">barrier_acked_requests</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">tl_requests</span><span class="p">);</span>
			<span class="n">_req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">connection_lost_while_pending</span>:
	<span class="k">case</span> <span class="n">resend</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;what = %d in _tl_restart()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * tl_clear() - Clears all requests and &amp;struct drbd_tl_epoch objects out of the TL</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called after the connection to the peer was lost. The storage covered</span>
<span class="cm"> * by the requests on the transfer gets marked as our of sync. Called from the</span>
<span class="cm"> * receiver thread and the worker thread.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tl_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">le</span><span class="p">,</span> <span class="o">*</span><span class="n">tle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">_tl_restart</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">connection_lost_while_pending</span><span class="p">);</span>

	<span class="cm">/* we expect this list to be empty. */</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">out_of_sequence_requests</span><span class="p">));</span>

	<span class="cm">/* but just in case, clean it up anyways! */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">out_of_sequence_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">tl_requests</span><span class="p">);</span>
		<span class="cm">/* It would be nice to complete outside of spinlock.</span>
<span class="cm">		 * But this is easier for now. */</span>
		<span class="n">_req_mod</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">connection_lost_while_pending</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ensure bit indicating barrier is required is clear */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CREATE_BARRIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">app_reads_hash</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">APP_R_HSIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tl_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_req_event</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">_tl_restart</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tl_abort_disk_io() - Abort disk I/O for all requests for a certain mdev in the TL</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tl_abort_disk_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_tl_epoch</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">le</span><span class="p">,</span> <span class="o">*</span><span class="n">tle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">oldest_tle</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">tl_requests</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_state</span> <span class="o">&amp;</span> <span class="n">RQ_LOCAL_PENDING</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">_req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">abort_disk_io</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">barrier_acked_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span><span class="p">,</span> <span class="n">tl_requests</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_state</span> <span class="o">&amp;</span> <span class="n">RQ_LOCAL_PENDING</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">_req_mod</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">abort_disk_io</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cl_wide_st_chg() - true if the state change is a cluster wide one</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @os:		old (current) state.</span>
<span class="cm"> * @ns:		new (wanted) state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cl_wide_st_chg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
		 <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STARTING_SYNC_T</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_T</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STARTING_SYNC_S</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_S</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_FAILED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_FAILED</span><span class="p">)))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_DISCONNECTING</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">drbd_change_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">f</span><span class="p">,</span>
		  <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">.</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_force_state() - Impose a change which happens outside our control on our state</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @mask:	mask of state bits to change.</span>
<span class="cm"> * @val:	value of new state bits.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_force_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drbd_change_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">CS_HARD</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">is_valid_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span><span class="p">);</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">is_valid_state_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span>
						    <span class="k">union</span> <span class="n">drbd_state</span><span class="p">,</span>
						    <span class="k">union</span> <span class="n">drbd_state</span><span class="p">);</span>
<span class="k">enum</span> <span class="n">sanitize_state_warnings</span> <span class="p">{</span>
	<span class="n">NO_WARNING</span><span class="p">,</span>
	<span class="n">ABORTED_ONLINE_VERIFY</span><span class="p">,</span>
	<span class="n">ABORTED_RESYNC</span><span class="p">,</span>
	<span class="n">CONNECTION_LOST_NEGOTIATING</span><span class="p">,</span>
	<span class="n">IMPLICITLY_UPGRADED_DISK</span><span class="p">,</span>
	<span class="n">IMPLICITLY_UPGRADED_PDSK</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">sanitize_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sanitize_state_warnings</span> <span class="o">*</span><span class="n">warn</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">drbd_send_state_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">drbd_state</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span><span class="p">);</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">_req_st_cond</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span>
	     <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CL_ST_CHG_SUCCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SS_CW_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">CL_ST_CHG_FAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SS_CW_FAILED_BY_PEER</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">.</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">sanitize_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cl_wide_st_chg</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">))</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_CW_NO_NEED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">is_valid_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">is_valid_state_transition</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_UNKNOWN_ERROR</span><span class="p">;</span> <span class="cm">/* cont waiting, otherwise fail. */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_req_state() - Perform an eventually cluster wide state change</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @mask:	mask of state bits to change.</span>
<span class="cm"> * @val:	value of new state bits.</span>
<span class="cm"> * @f:		flags</span>
<span class="cm"> *</span>
<span class="cm"> * Should not be called directly, use drbd_request_state() or</span>
<span class="cm"> * _drbd_request_state().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">drbd_req_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span>
	       <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">val</span><span class="p">,</span> <span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">CS_SERIALIZE</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">.</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">sanitize_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cl_wide_st_chg</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">is_valid_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">is_valid_state_transition</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">CS_VERBOSE</span><span class="p">)</span>
				<span class="n">print_st_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">drbd_state_lock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_send_state_req</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drbd_state_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_CW_FAILED_BY_PEER</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">CS_VERBOSE</span><span class="p">)</span>
				<span class="n">print_st_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">,</span>
			<span class="p">(</span><span class="n">rv</span> <span class="o">=</span> <span class="n">_req_st_cond</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_state_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">CS_VERBOSE</span><span class="p">)</span>
				<span class="n">print_st_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">.</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">drbd_state_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">CS_WAIT_COMPLETE</span> <span class="o">&amp;&amp;</span> <span class="n">rv</span> <span class="o">==</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">current</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">abort:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="n">CS_SERIALIZE</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _drbd_request_state() - Request a state change (with flags)</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @mask:	mask of state bits to change.</span>
<span class="cm"> * @val:	value of new state bits.</span>
<span class="cm"> * @f:		flags</span>
<span class="cm"> *</span>
<span class="cm"> * Cousin of drbd_request_state(), useful with the CS_WAIT_COMPLETE</span>
<span class="cm"> * flag, or when logging of failed state change requests is not desired.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">_drbd_request_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span>
		    <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">val</span><span class="p">,</span> <span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_req_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="o">!=</span> <span class="n">SS_IN_TRANSIENT_STATE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot; %s = { cs:%s ro:%s/%s ds:%s/%s %c%c%c%c }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">name</span><span class="p">,</span>
	    <span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span><span class="p">),</span>
	    <span class="n">drbd_role_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span><span class="p">),</span>
	    <span class="n">drbd_role_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">peer</span><span class="p">),</span>
	    <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span><span class="p">),</span>
	    <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span><span class="p">),</span>
	    <span class="n">is_susp</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;s&#39;</span> <span class="o">:</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">?</span> <span class="sc">&#39;a&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">?</span> <span class="sc">&#39;p&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">user_isp</span> <span class="o">?</span> <span class="sc">&#39;u&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span>
	    <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_st_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span>
	          <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">SS_IN_TRANSIENT_STATE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;State change failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drbd_set_st_err_str</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
	<span class="n">print_st</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot; state&quot;</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
	<span class="n">print_st</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;wanted&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * is_valid_state() - Returns an SS_ error code if ns is not valid</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @ns:		State to consider.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">is_valid_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* See drbd_state_sw_errors in drbd_strings.c */</span>

	<span class="k">enum</span> <span class="n">drbd_fencing_p</span> <span class="n">fp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">SS_SUCCESS</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">FP_DONT_CARE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_TWO_PRIMARIES</span><span class="p">;</span>
		<span class="n">put_net_conf</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* already found a reason to abort */</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">open_cnt</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_DEVICE_IN_USE</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NO_UP_TO_DATE_DISK</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&gt;=</span> <span class="n">FP_RESOURCE</span> <span class="o">&amp;&amp;</span>
		 <span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;=</span> <span class="n">D_UNKNOWN</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_PRIMARY_NOP</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;=</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;=</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NO_UP_TO_DATE_DISK</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NO_LOCAL_DISK</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NO_REMOTE_DISK</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NO_UP_TO_DATE_DISK</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">||</span>
		  <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_BITMAP_S</span> <span class="o">||</span>
		  <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">||</span>
		  <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_OUTDATED</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_CONNECTED_OUTDATES</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NO_VERIFY_ALG</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">88</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NOT_SUPPORTED</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_UNKNOWN</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_CONNECTED_OUTDATES</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_valid_state_transition() - Returns an SS_ error code if the state transition is not possible</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @ns:		new state.</span>
<span class="cm"> * @os:		old state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">is_valid_state_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">SS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_T</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_S</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_RESYNC_RUNNING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_DISCONNECTING</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_ALREADY_STANDALONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_ATTACHING</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_IS_DISKLESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_CONNECTION</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_UNCONNECTED</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NO_NET_CONFIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_OUTDATED</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_OUTDATED</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_ATTACHING</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_LOWER_THAN_OUTDATED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_DISCONNECTING</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_UNCONNECTED</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_IN_TRANSIENT_STATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_IN_TRANSIENT_STATE</span><span class="p">;</span>

	<span class="cm">/* While establishing a connection only allow cstate to change.</span>
<span class="cm">	   Delay/refuse role changes, detach attach etc... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_CONNECTION</span><span class="p">)))</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_IN_TRANSIENT_STATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NEED_CONNECTION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_RESYNC_RUNNING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_S</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_T</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NEED_CONNECTION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">SS_NEED_CONNECTION</span><span class="p">;</span> <span class="cm">/* No NetworkFailure -&gt; SyncTarget etc... */</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_sanitize_warnings</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sanitize_state_warnings</span> <span class="n">warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">NO_WARNING</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ABORTED_ONLINE_VERIFY</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Online-verify aborted.&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ABORTED_RESYNC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Resync aborted.&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">CONNECTION_LOST_NEGOTIATING</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Connection lost while negotiating, no data!&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IMPLICITLY_UPGRADED_DISK</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Implicitly upgraded disk&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">IMPLICITLY_UPGRADED_PDSK</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Implicitly upgraded pdsk&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">warn</span> <span class="o">!=</span> <span class="n">NO_WARNING</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_table</span><span class="p">[</span><span class="n">warn</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sanitize_state() - Resolves implicitly necessary additional changes to a state transition</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @os:		old state.</span>
<span class="cm"> * @ns:		new state.</span>
<span class="cm"> * @warn_sync_abort:</span>
<span class="cm"> *</span>
<span class="cm"> * When we loose connection, we have to set the state of the peers disk (pdsk)</span>
<span class="cm"> * to D_UNKNOWN. This rule and many more along those lines are in this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="nf">sanitize_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sanitize_state_warnings</span> <span class="o">*</span><span class="n">warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_fencing_p</span> <span class="n">fp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_disk_state</span> <span class="n">disk_min</span><span class="p">,</span> <span class="n">disk_max</span><span class="p">,</span> <span class="n">pdsk_min</span><span class="p">,</span> <span class="n">pdsk_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">warn</span><span class="p">)</span>
		<span class="o">*</span><span class="n">warn</span> <span class="o">=</span> <span class="n">NO_WARNING</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">FP_DONT_CARE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disallow Network errors to configure a device&#39;s network part */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_TIMEOUT</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_TEAR_DOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_DISCONNECTING</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span><span class="p">;</span>

	<span class="cm">/* After a network error (+C_TEAR_DOWN) only C_UNCONNECTED or C_DISCONNECTING can follow.</span>
<span class="cm">	 * If you try to go into some Sync* state, that shall fail (elsewhere). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_TIMEOUT</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_TEAR_DOWN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_UNCONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_DISCONNECTING</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span><span class="p">;</span>

	<span class="cm">/* we cannot fail (again) if we already detached */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_FAILED</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">;</span>

	<span class="cm">/* After C_DISCONNECTING only C_STANDALONE may follow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_DISCONNECTING</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STANDALONE</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">R_UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;</span> <span class="n">D_UNKNOWN</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the aftr_isp when becoming unconfigured */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Abort resync if a disk fails/detaches */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;=</span> <span class="n">D_FAILED</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;=</span> <span class="n">D_FAILED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">warn</span><span class="p">)</span>
			<span class="o">*</span><span class="n">warn</span> <span class="o">=</span>	<span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span> <span class="o">?</span>
				<span class="n">ABORTED_ONLINE_VERIFY</span> <span class="o">:</span> <span class="n">ABORTED_RESYNC</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_CONNECTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Connection breaks down before we finished &quot;Negotiating&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_NEGOTIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ed_uuid</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">new_state_tmp</span><span class="p">.</span><span class="n">disk</span><span class="p">;</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">new_state_tmp</span><span class="p">.</span><span class="n">pdsk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">warn</span><span class="p">)</span>
				<span class="o">*</span><span class="n">warn</span> <span class="o">=</span> <span class="n">CONNECTION_LOST_NEGOTIATING</span><span class="p">;</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">;</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_UNKNOWN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* D_CONSISTENT and D_OUTDATED vanish when we get connected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_AHEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_CONSISTENT</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_OUTDATED</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_CONSISTENT</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_OUTDATED</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Implications of the connection stat on the disk states */</span>
	<span class="n">disk_min</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">;</span>
	<span class="n">disk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
	<span class="n">pdsk_min</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
	<span class="n">pdsk_max</span> <span class="o">=</span> <span class="n">D_UNKNOWN</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="k">enum</span> <span class="n">drbd_conns</span><span class="p">)</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C_WF_BITMAP_T</span>:
	<span class="k">case</span> <span class="n">C_PAUSED_SYNC_T</span>:
	<span class="k">case</span> <span class="n">C_STARTING_SYNC_T</span>:
	<span class="k">case</span> <span class="n">C_WF_SYNC_UUID</span>:
	<span class="k">case</span> <span class="n">C_BEHIND</span>:
		<span class="n">disk_min</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="n">disk_max</span> <span class="o">=</span> <span class="n">D_OUTDATED</span><span class="p">;</span>
		<span class="n">pdsk_min</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">pdsk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_VERIFY_S</span>:
	<span class="k">case</span> <span class="n">C_VERIFY_T</span>:
		<span class="n">disk_min</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">disk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">pdsk_min</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">pdsk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_CONNECTED</span>:
		<span class="n">disk_min</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">;</span>
		<span class="n">disk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">pdsk_min</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">;</span>
		<span class="n">pdsk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_WF_BITMAP_S</span>:
	<span class="k">case</span> <span class="n">C_PAUSED_SYNC_S</span>:
	<span class="k">case</span> <span class="n">C_STARTING_SYNC_S</span>:
	<span class="k">case</span> <span class="n">C_AHEAD</span>:
		<span class="n">disk_min</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">disk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">pdsk_min</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="n">pdsk_max</span> <span class="o">=</span> <span class="n">D_CONSISTENT</span><span class="p">;</span> <span class="cm">/* D_OUTDATED would be nice. But explicit outdate necessary*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_SYNC_TARGET</span>:
		<span class="n">disk_min</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="n">disk_max</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="n">pdsk_min</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">pdsk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_SYNC_SOURCE</span>:
		<span class="n">disk_min</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">disk_max</span> <span class="o">=</span> <span class="n">D_UP_TO_DATE</span><span class="p">;</span>
		<span class="n">pdsk_min</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="n">pdsk_max</span> <span class="o">=</span> <span class="n">D_INCONSISTENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_STANDALONE</span>:
	<span class="k">case</span> <span class="n">C_DISCONNECTING</span>:
	<span class="k">case</span> <span class="n">C_UNCONNECTED</span>:
	<span class="k">case</span> <span class="n">C_TIMEOUT</span>:
	<span class="k">case</span> <span class="n">C_BROKEN_PIPE</span>:
	<span class="k">case</span> <span class="n">C_NETWORK_FAILURE</span>:
	<span class="k">case</span> <span class="n">C_PROTOCOL_ERROR</span>:
	<span class="k">case</span> <span class="n">C_TEAR_DOWN</span>:
	<span class="k">case</span> <span class="n">C_WF_CONNECTION</span>:
	<span class="k">case</span> <span class="n">C_WF_REPORT_PARAMS</span>:
	<span class="k">case</span> <span class="n">C_MASK</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">disk_max</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">disk_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">disk_min</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">warn</span><span class="p">)</span>
			<span class="o">*</span><span class="n">warn</span> <span class="o">=</span> <span class="n">IMPLICITLY_UPGRADED_DISK</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">disk_min</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;</span> <span class="n">pdsk_max</span><span class="p">)</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">pdsk_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">pdsk_min</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">warn</span><span class="p">)</span>
			<span class="o">*</span><span class="n">warn</span> <span class="o">=</span> <span class="n">IMPLICITLY_UPGRADED_PDSK</span><span class="p">;</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">pdsk_min</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="n">FP_STONITH</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;</span> <span class="n">D_OUTDATED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;</span> <span class="n">D_OUTDATED</span><span class="p">))</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">susp_fen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Suspend IO while fence-peer handler runs (peer lost) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">on_no_data</span> <span class="o">==</span> <span class="n">OND_SUSPEND_IO</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span><span class="p">))</span>
		<span class="n">ns</span><span class="p">.</span><span class="n">susp_nod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Suspend IO while no data available (no accessible data available) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">user_isp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_SYNC_SOURCE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span>
			<span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_SYNC_TARGET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* helper for __drbd_set_state */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ov_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_conns</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">=</span> <span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* starting online verify from an arbitrary position</span>
<span class="cm">		 * does not fit well into the existing protocol.</span>
<span class="cm">		 * on C_VERIFY_T, we initialize ov_left and friends</span>
<span class="cm">		 * implicitly in receive_DataRequest once the</span>
<span class="cm">		 * first P_OV_REQUEST is received */</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">BM_SECT_TO_BIT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">=</span>
				<span class="n">BM_BIT_TO_SECT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">-=</span> <span class="n">bit</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_position</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_resume_al</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AL_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Resumed AL updates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __drbd_set_state() - Set a new DRBD state</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @ns:		new state.</span>
<span class="cm"> * @flags:	Flags</span>
<span class="cm"> * @done:	Optional completion, that will get completed after the after_state_ch() finished</span>
<span class="cm"> *</span>
<span class="cm"> * Caller needs to hold req_lock, and global_state_lock. Do not call directly.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">drbd_state_rv</span>
<span class="nf">__drbd_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span>
	         <span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">SS_SUCCESS</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sanitize_state_warnings</span> <span class="n">ssw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">after_state_chg_work</span> <span class="o">*</span><span class="n">ascw</span><span class="p">;</span>

	<span class="n">os</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">sanitize_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">os</span><span class="p">.</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SS_NOTHING_TO_DO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CS_HARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  pre-state-change checks ; only look at ns  */</span>
		<span class="cm">/* See drbd_state_sw_errors in drbd_strings.c */</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">is_valid_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If the old state was illegal as well, then let</span>
<span class="cm">			   this happen...*/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">)</span> <span class="o">==</span> <span class="n">rv</span><span class="p">)</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">is_valid_state_transition</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">is_valid_state_transition</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="n">SS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CS_VERBOSE</span><span class="p">)</span>
			<span class="n">print_st_err</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">print_sanitize_warnings</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ssw</span><span class="p">);</span>

	<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbp</span><span class="p">,</span> <span class="n">pb</span><span class="p">[</span><span class="mi">300</span><span class="p">];</span>
	<span class="n">pbp</span> <span class="o">=</span> <span class="n">pb</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pbp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">role</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;role( %s -&gt; %s ) &quot;</span><span class="p">,</span>
			       <span class="n">drbd_role_str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">role</span><span class="p">),</span>
			       <span class="n">drbd_role_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">peer</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;peer( %s -&gt; %s ) &quot;</span><span class="p">,</span>
			       <span class="n">drbd_role_str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">peer</span><span class="p">),</span>
			       <span class="n">drbd_role_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">peer</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;conn( %s -&gt; %s ) &quot;</span><span class="p">,</span>
			       <span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span><span class="p">),</span>
			       <span class="n">drbd_conn_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;disk( %s -&gt; %s ) &quot;</span><span class="p">,</span>
			       <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span><span class="p">),</span>
			       <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;pdsk( %s -&gt; %s ) &quot;</span><span class="p">,</span>
			       <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">pdsk</span><span class="p">),</span>
			       <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_susp</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">is_susp</span><span class="p">(</span><span class="n">os</span><span class="p">))</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;susp( %d -&gt; %d ) &quot;</span><span class="p">,</span>
			       <span class="n">is_susp</span><span class="p">(</span><span class="n">os</span><span class="p">),</span>
			       <span class="n">is_susp</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">aftr_isp</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;aftr_isp( %d -&gt; %d ) &quot;</span><span class="p">,</span>
			       <span class="n">os</span><span class="p">.</span><span class="n">aftr_isp</span><span class="p">,</span>
			       <span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">peer_isp</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;peer_isp( %d -&gt; %d ) &quot;</span><span class="p">,</span>
			       <span class="n">os</span><span class="p">.</span><span class="n">peer_isp</span><span class="p">,</span>
			       <span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">user_isp</span> <span class="o">!=</span> <span class="n">os</span><span class="p">.</span><span class="n">user_isp</span><span class="p">)</span>
		<span class="n">pbp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">pbp</span><span class="p">,</span> <span class="s">&quot;user_isp( %d -&gt; %d ) &quot;</span><span class="p">,</span>
			       <span class="n">os</span><span class="p">.</span><span class="n">user_isp</span><span class="p">,</span>
			       <span class="n">ns</span><span class="p">.</span><span class="n">user_isp</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* solve the race between becoming unconfigured,</span>
<span class="cm">	 * worker doing the cleanup, and</span>
<span class="cm">	 * admin reconfiguring us:</span>
<span class="cm">	 * on (re)configure, first set CONFIG_PENDING,</span>
<span class="cm">	 * then wait for a potentially exiting worker,</span>
<span class="cm">	 * start the worker, and schedule one no_op.</span>
<span class="cm">	 * then proceed with configuration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CONFIG_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_DYING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* if we are going -&gt; D_FAILED or D_DISKLESS, grab one extra reference</span>
<span class="cm">	 * on the ldev here, to be sure the transition -&gt; D_DISKLESS resp.</span>
<span class="cm">	 * drbd_ldev_destroy() won&#39;t happen before our corresponding</span>
<span class="cm">	 * after_state_ch works run, where we put_ldev again. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_FAILED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_FAILED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span><span class="p">))</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_cnt</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_ATTACHING</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span>
		<span class="n">drbd_print_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;attached to UUIDs&quot;</span><span class="p">);</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>

	<span class="cm">/* aborted verify run. log the last position */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span> <span class="o">=</span>
			<span class="n">BM_BIT_TO_SECT</span><span class="p">(</span><span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">-</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Online Verify reached sector %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_start_sector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span>  <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Syncer continues.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_paused</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">jiffies</span>
				  <span class="o">-</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_mark</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_TARGET</span>  <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_T</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Resync suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_mark</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_T</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">set_ov_position</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_start</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_sect_ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_last_oos_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_last_oos_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRBD_SYNC_MARKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_left</span><span class="p">;</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">drbd_rs_controller_reset</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_VERIFY_S</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Starting Online Verify from sector %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ov_position</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mdf</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MDF_CONSISTENT</span><span class="o">|</span><span class="n">MDF_PRIMARY_IND</span><span class="o">|</span>
						 <span class="n">MDF_CONNECTED_IND</span><span class="o">|</span><span class="n">MDF_WAS_UP_TO_DATE</span><span class="o">|</span>
						 <span class="n">MDF_PEER_OUT_DATED</span><span class="o">|</span><span class="n">MDF_CRASHED_PRIMARY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CRASHED_PRIMARY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">mdf</span> <span class="o">|=</span> <span class="n">MDF_CRASHED_PRIMARY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">))</span>
			<span class="n">mdf</span> <span class="o">|=</span> <span class="n">MDF_PRIMARY_IND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span>
			<span class="n">mdf</span> <span class="o">|=</span> <span class="n">MDF_CONNECTED_IND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
			<span class="n">mdf</span> <span class="o">|=</span> <span class="n">MDF_CONSISTENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_OUTDATED</span><span class="p">)</span>
			<span class="n">mdf</span> <span class="o">|=</span> <span class="n">MDF_WAS_UP_TO_DATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;=</span> <span class="n">D_OUTDATED</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;=</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
			<span class="n">mdf</span> <span class="o">|=</span> <span class="n">MDF_PEER_OUT_DATED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdf</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">mdf</span><span class="p">;</span>
			<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_CONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_CONSISTENT</span><span class="p">)</span>
			<span class="n">drbd_set_ed_uuid</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">]);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Peer was forced D_UP_TO_DATE &amp; R_PRIMARY, consider to resync */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_SECONDARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONSIDER_RESYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Receiver should clean up itself */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_DISCONNECTING</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_DISCONNECTING</span><span class="p">)</span>
		<span class="n">drbd_thread_stop_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">);</span>

	<span class="cm">/* Now the receiver finished cleaning up itself, it should die */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span><span class="p">)</span>
		<span class="n">drbd_thread_stop_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">);</span>

	<span class="cm">/* Upon network failure, we need to restart the receiver. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_WF_CONNECTION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_TEAR_DOWN</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_TIMEOUT</span><span class="p">)</span>
		<span class="n">drbd_thread_restart_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">);</span>

	<span class="cm">/* Resume AL writing if we get a connection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">drbd_resume_al</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* remember last connect and attach times so request_timer_fn() won&#39;t</span>
<span class="cm">	 * kill newly established sessions while we are still trying to thaw</span>
<span class="cm">	 * previously frozen IO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_WF_REPORT_PARAMS</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_reconnect_jif</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_ATTACHING</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_reattach_jif</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">ascw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ascw</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ascw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ascw</span><span class="o">-&gt;</span><span class="n">os</span> <span class="o">=</span> <span class="n">os</span><span class="p">;</span>
		<span class="n">ascw</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
		<span class="n">ascw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">ascw</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_after_state_ch</span><span class="p">;</span>
		<span class="n">ascw</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ascw</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Could not kmalloc an ascw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_after_state_ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">after_state_chg_work</span> <span class="o">*</span><span class="n">ascw</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">after_state_chg_work</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="n">after_state_ch</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ascw</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span> <span class="n">ascw</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="n">ascw</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ascw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CS_WAIT_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">ascw</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">ascw</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ascw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abw_start_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Writing the bitmap failed not starting resync.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_CONNECTED</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C_STARTING_SYNC_T</span>:
		<span class="n">_drbd_request_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_WF_SYNC_UUID</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C_STARTING_SYNC_S</span>:
		<span class="n">drbd_start_resync</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">C_SYNC_SOURCE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_bitmap_io_from_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">io_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">),</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">why</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bm_flag</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="cm">/* open coded non-blocking drbd_suspend_io(mdev); */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SUSPEND_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">drbd_bm_lock</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">why</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">io_fn</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_bm_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * after_state_ch() - Perform after state change actions that may sleep</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @os:		old state.</span>
<span class="cm"> * @ns:		new state.</span>
<span class="cm"> * @flags:	Flags</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">after_state_ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">os</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">ns</span><span class="p">,</span> <span class="k">enum</span> <span class="n">chg_state_flags</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drbd_fencing_p</span> <span class="n">fp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drbd_req_event</span> <span class="n">what</span> <span class="o">=</span> <span class="n">nothing</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">nsm</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">drbd_state</span><span class="p">){</span> <span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CRASHED_PRIMARY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">)</span>
			<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">FP_DONT_CARE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">fencing</span><span class="p">;</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Inform userspace about the change... */</span>
	<span class="n">drbd_bcast_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span><span class="p">))</span>
		<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;pri-on-incon-degr&quot;</span><span class="p">);</span>

	<span class="cm">/* Here we have the actions that are performed after a</span>
<span class="cm">	   state change. This function might sleep */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;=</span> <span class="n">D_NEGOTIATING</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">request_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">nsm</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">susp_nod</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
			<span class="n">what</span> <span class="o">=</span> <span class="n">resend</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_ATTACHING</span> <span class="o">||</span> <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span>
			<span class="n">what</span> <span class="o">=</span> <span class="n">restart_frozen_disk_io</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">!=</span> <span class="n">nothing</span><span class="p">)</span>
			<span class="n">nsm</span><span class="p">.</span><span class="n">susp_nod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">susp_fen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* case1: The outdate peer handler is successful: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;</span> <span class="n">D_OUTDATED</span>  <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;=</span> <span class="n">D_OUTDATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tl_clear</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">drbd_uuid_new_current</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
			<span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">_NS</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">susp_fen</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* case2: The connection was established again: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">what</span> <span class="o">=</span> <span class="n">resend</span><span class="p">;</span>
			<span class="n">nsm</span><span class="p">.</span><span class="n">susp_fen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">!=</span> <span class="n">nothing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
		<span class="n">_tl_restart</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
		<span class="n">nsm</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
		<span class="n">_drbd_set_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">CS_VERBOSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Became sync source.  With protocol &gt;= 96, we still need to send out</span>
<span class="cm">	 * the sync uuid now. Need to do that before any drbd_send_state, or</span>
<span class="cm">	 * the other side may go &quot;paused sync&quot; before receiving the sync uuids,</span>
<span class="cm">	 * which is unexpected. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_PAUSED_SYNC_S</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">96</span> <span class="o">&amp;&amp;</span> <span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_gen_and_send_sync_uuid</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Do not change the order of the if above and the two below... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;</span> <span class="n">D_DISKLESS</span><span class="p">)</span> <span class="p">{</span>      <span class="cm">/* attach on the peer */</span>
		<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* No point in queuing send_bitmap if we don&#39;t have a connection</span>
<span class="cm">	 * anymore, so check also the _current_ state, not only the new state</span>
<span class="cm">	 * at the time this work was queued. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_WF_BITMAP_S</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_BITMAP_S</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_BITMAP_S</span><span class="p">)</span>
		<span class="n">drbd_queue_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_send_bitmap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="s">&quot;send_bitmap (WFBitMapS)&quot;</span><span class="p">,</span>
				<span class="n">BM_LOCKED_TEST_ALLOWED</span><span class="p">);</span>

	<span class="cm">/* Lost contact to peer&#39;s copy of the data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;=</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span>
	     <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">!=</span> <span class="n">D_UNKNOWN</span> <span class="o">&amp;&amp;</span>
	     <span class="n">os</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">!=</span> <span class="n">D_OUTDATED</span><span class="p">)</span>
	<span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span> <span class="o">||</span>
	     <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_UNKNOWN</span> <span class="o">||</span>
	     <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">==</span> <span class="n">D_OUTDATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_susp</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">NEW_CUR_UUID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">drbd_uuid_new_current</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
					<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&lt;</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_SECONDARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">D_UP_TO_DATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_uuid_new_current</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* D_DISKLESS Peer becomes secondary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">peer</span> <span class="o">==</span> <span class="n">R_SECONDARY</span><span class="p">)</span>
			<span class="cm">/* We may still be Primary ourselves.</span>
<span class="cm">			 * No harm done if the bitmap still changes,</span>
<span class="cm">			 * redirtied pages will follow later. */</span>
			<span class="n">drbd_bitmap_io_from_worker</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bm_write</span><span class="p">,</span>
				<span class="s">&quot;demote diskless peer&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_SET_ALLOWED</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Write out all changed bits on demote.</span>
<span class="cm">	 * Though, no need to da that just yet</span>
<span class="cm">	 * if there is a resync going on still */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span> <span class="o">&amp;&amp;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No changes to the bitmap expected this time, so assert that,</span>
<span class="cm">		 * even though no harm was done if it did change. */</span>
		<span class="n">drbd_bitmap_io_from_worker</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bm_write</span><span class="p">,</span>
				<span class="s">&quot;demote&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_TEST_ALLOWED</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Last part of the attaching process ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_ATTACHING</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_NEGOTIATING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_send_sizes</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* to start sync... */</span>
		<span class="n">drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We want to pause/continue resync, tell peer. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">!=</span> <span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">user_isp</span> <span class="o">!=</span> <span class="n">ns</span><span class="p">.</span><span class="n">user_isp</span><span class="p">)))</span>
		<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

	<span class="cm">/* In case one of the isp bits got set, suspend other devices. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">os</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">os</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">os</span><span class="p">.</span><span class="n">user_isp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">||</span> <span class="n">ns</span><span class="p">.</span><span class="n">user_isp</span><span class="p">))</span>
		<span class="n">suspend_other_sg</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* Make sure the peer gets informed about eventual state</span>
<span class="cm">	   changes (ISP bits) while we were in WFReportParams. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_AHEAD</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_AHEAD</span><span class="p">)</span>
		<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

	<span class="cm">/* We are in the progress to start a full sync... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STARTING_SYNC_T</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_T</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_STARTING_SYNC_S</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STARTING_SYNC_S</span><span class="p">))</span>
		<span class="cm">/* no other bitmap changes expected during this phase */</span>
		<span class="n">drbd_queue_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">drbd_bmio_set_n_write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abw_start_sync</span><span class="p">,</span>
			<span class="s">&quot;set_n_write from StartingSync&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_TEST_ALLOWED</span><span class="p">);</span>

	<span class="cm">/* We are invalidating our self... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span><span class="p">)</span>
		<span class="cm">/* other bitmap operation expected during this phase */</span>
		<span class="n">drbd_queue_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bmio_set_n_write</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="s">&quot;set_n_write from invalidate&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_MASK</span><span class="p">);</span>

	<span class="cm">/* first half of local IO error, failure to attach,</span>
<span class="cm">	 * or administrative detach */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_FAILED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">drbd_io_error_p</span> <span class="n">eh</span> <span class="o">=</span> <span class="n">EP_PASS_ON</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">was_io_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* corresponding get_ldev was in __drbd_set_state, to serialize</span>
<span class="cm">		 * our cleanup here with the transition to D_DISKLESS.</span>
<span class="cm">		 * But is is still not save to dreference ldev here, since</span>
<span class="cm">		 * we might come from an failed Attach before ldev was set. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eh</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">on_io_error</span><span class="p">;</span>
			<span class="n">was_io_error</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WAS_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

			<span class="cm">/* Immediately allow completion of all application IO, that waits</span>
<span class="cm">			   for completion from the local disk. */</span>
			<span class="n">tl_abort_disk_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

			<span class="cm">/* current state still has to be D_FAILED,</span>
<span class="cm">			 * there is only one way out: to D_DISKLESS,</span>
<span class="cm">			 * and that may only happen after our put_ldev below. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_FAILED</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
					<span class="s">&quot;ASSERT FAILED: disk is %s during detach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
				<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

			<span class="n">drbd_rs_cancel_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

			<span class="cm">/* In case we want to get something to stable storage still,</span>
<span class="cm">			 * this may be the last chance.</span>
<span class="cm">			 * Following put_ldev may transition to D_DISKLESS. */</span>
			<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">was_io_error</span> <span class="o">&amp;&amp;</span> <span class="n">eh</span> <span class="o">==</span> <span class="n">EP_CALL_HELPER</span><span class="p">)</span>
			<span class="n">drbd_khelper</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;local-io-error&quot;</span><span class="p">);</span>
	<span class="p">}</span>

        <span class="cm">/* second half of local IO error, failure to attach,</span>
<span class="cm">         * or administrative detach,</span>
<span class="cm">         * after local_cnt references have reached zero again */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* We must still be diskless,</span>
<span class="cm">                 * re-attach has to be serialized with this! */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">!=</span> <span class="n">D_DISKLESS</span><span class="p">)</span>
                        <span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
                                <span class="s">&quot;ASSERT FAILED: disk is %s while going diskless</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="n">drbd_disk_str</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span><span class="p">));</span>

                <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_pending_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
			<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

		<span class="cm">/* corresponding get_ldev in __drbd_set_state</span>
<span class="cm">		 * this may finally trigger drbd_ldev_destroy. */</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Notify peer that I had a local IO error, and did not detached.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

	<span class="cm">/* Disks got bigger while they were detached */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">&gt;</span> <span class="n">D_NEGOTIATING</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">pdsk</span> <span class="o">&gt;</span> <span class="n">D_NEGOTIATING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RESYNC_AFTER_NEG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
			<span class="n">resync_after_online_grow</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* A resync finished or aborted, wake paused devices... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">peer_isp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ns</span><span class="p">.</span><span class="n">peer_isp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">user_isp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ns</span><span class="p">.</span><span class="n">user_isp</span><span class="p">))</span>
		<span class="n">resume_next_sg</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* sync target done with resync.  Explicitly notify peer, even though</span>
<span class="cm">	 * it should (at least for non-empty resyncs) already know itself. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">D_UP_TO_DATE</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="n">drbd_send_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

	<span class="cm">/* Wake up role changes, that were delayed because of connection establishing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_WF_REPORT_PARAMS</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">!=</span> <span class="n">C_WF_REPORT_PARAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This triggers bitmap writeout of potentially still unwritten pages</span>
<span class="cm">	 * if the resync finished cleanly, or aborted because of peer disk</span>
<span class="cm">	 * failure, or because of connection loss.</span>
<span class="cm">	 * For resync aborted because of local disk failure, we cannot do</span>
<span class="cm">	 * any bitmap writeout anymore.</span>
<span class="cm">	 * No harm done if some bits change during this phase.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_queue_bitmap_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_bm_write_copy_pages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="s">&quot;write from resync_finished&quot;</span><span class="p">,</span> <span class="n">BM_LOCKED_CHANGE_ALLOWED</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free tl_hash if we Got thawed and are C_STANDALONE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_susp</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">tl_hash</span><span class="p">)</span>
		<span class="n">drbd_free_tl_hash</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* Upon network connection, we need to start the receiver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_UNCONNECTED</span><span class="p">)</span>
		<span class="n">drbd_thread_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">);</span>

	<span class="cm">/* Terminate worker thread if we are unconfigured - it will be</span>
<span class="cm">	   restarted as needed... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_DISKLESS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">conn</span> <span class="o">==</span> <span class="n">C_STANDALONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_SECONDARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">aftr_isp</span> <span class="o">!=</span> <span class="n">ns</span><span class="p">.</span><span class="n">aftr_isp</span><span class="p">)</span>
			<span class="n">resume_next_sg</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="cm">/* set in __drbd_set_state, unless CONFIG_PENDING was set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_DYING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">drbd_thread_stop_nowait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_thread_setup</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">thi</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">thi</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">(</span><span class="n">thi</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* if the receiver has been &quot;Exiting&quot;, the last thing it did</span>
<span class="cm">	 * was set the conn state to &quot;StandAlone&quot;,</span>
<span class="cm">	 * if now a re-connect request comes in, conn state goes C_UNCONNECTED,</span>
<span class="cm">	 * and receiver thread will be &quot;started&quot;.</span>
<span class="cm">	 * drbd_thread_start needs to set &quot;Restarting&quot; in that case.</span>
<span class="cm">	 * t_state check and assignment needs to be within the same spinlock,</span>
<span class="cm">	 * so either thread_start sees Exiting, and can remap to Restarting,</span>
<span class="cm">	 * or thread_start see None, and can proceed as normal.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">==</span> <span class="n">Restarting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Restarting %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
		<span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">=</span> <span class="n">Running</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">thi</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">=</span> <span class="n">None</span><span class="p">;</span>
	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Terminating %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>

	<span class="cm">/* Release mod reference taken when thread was started */</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_thread_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">);</span>
	<span class="n">thi</span><span class="o">-&gt;</span><span class="n">task</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">=</span> <span class="n">None</span><span class="p">;</span>
	<span class="n">thi</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">thi</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_thread_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">thi</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">nt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span>
		<span class="n">thi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span> <span class="o">?</span> <span class="s">&quot;receiver&quot;</span> <span class="o">:</span>
		<span class="n">thi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span>  <span class="o">?</span> <span class="s">&quot;asender&quot;</span>  <span class="o">:</span>
		<span class="n">thi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span>   <span class="o">?</span> <span class="s">&quot;worker&quot;</span>   <span class="o">:</span> <span class="s">&quot;NONSENSE&quot;</span><span class="p">;</span>

	<span class="cm">/* is used from state engine doing drbd_thread_stop_nowait,</span>
<span class="cm">	 * while holding the req lock irqsave */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">None</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Starting %s thread (from %s [%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">me</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

		<span class="cm">/* Get ref on module for thread - this is released when thread exits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Failed to get module reference in drbd_thread_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">thi</span><span class="o">-&gt;</span><span class="n">reset_cpu_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">=</span> <span class="n">Running</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span> <span class="cm">/* otherw. may get -ERESTARTNOINTR */</span>

		<span class="n">nt</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">drbd_thread_setup</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">thi</span><span class="p">,</span>
				    <span class="s">&quot;drbd%d_%s&quot;</span><span class="p">,</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">),</span> <span class="n">me</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t start thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">thi</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">nt</span><span class="p">;</span>
		<span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">=</span> <span class="n">Running</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">nt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Exiting</span>:
		<span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">=</span> <span class="n">Restarting</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Restarting %s thread (from %s [%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">me</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">Running</span>:
	<span class="k">case</span> <span class="n">Restarting</span>:
	<span class="nl">default:</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">_drbd_thread_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">restart</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">drbd_thread_state</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">restart</span> <span class="o">?</span> <span class="n">Restarting</span> <span class="o">:</span> <span class="n">Exiting</span><span class="p">;</span>

	<span class="cm">/* may be called from state engine, holding the req lock irqsave */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">==</span> <span class="n">None</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span>
			<span class="n">drbd_thread_start</span><span class="p">(</span><span class="n">thi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">!=</span> <span class="n">ns</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_state</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">!=</span> <span class="n">current</span><span class="p">)</span>
			<span class="n">force_sig</span><span class="p">(</span><span class="n">DRBD_SIGKILL</span><span class="p">,</span> <span class="n">thi</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">t_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="cm">/**</span>
<span class="cm"> * drbd_calc_cpu_mask() - Generate CPU masks, spread over all CPUs</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Forces all threads of a device onto the same CPU. This is beneficial for</span>
<span class="cm"> * DRBD&#39;s performance. May be overwritten by user&#39;s configuration.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_calc_cpu_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ord</span><span class="p">,</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="cm">/* user override. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ord</span> <span class="o">=</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">%</span> <span class="n">cpumask_weight</span><span class="p">(</span><span class="n">cpu_online_mask</span><span class="p">);</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ord</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* should not be reached */</span>
	<span class="n">cpumask_setall</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_thread_current_set_cpu() - modifies the cpu mask of the _current_ thread</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * call in the &quot;main loop&quot; of _all_ threads, no need for any mutex, current won&#39;t die</span>
<span class="cm"> * prematurely.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_thread_current_set_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drbd_thread</span> <span class="o">*</span><span class="n">thi</span> <span class="o">=</span>
		<span class="n">p</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">.</span><span class="n">task</span>  <span class="o">?</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span>  <span class="o">:</span>
		<span class="n">p</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">.</span><span class="n">task</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span> <span class="o">:</span>
		<span class="n">p</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">.</span><span class="n">task</span>   <span class="o">?</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span>   <span class="o">:</span>
		<span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ERR_IF</span><span class="p">(</span><span class="n">thi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thi</span><span class="o">-&gt;</span><span class="n">reset_cpu_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">thi</span><span class="o">-&gt;</span><span class="n">reset_cpu_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_cpus_allowed_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* the appropriate socket mutex must be held already */</span>
<span class="kt">int</span> <span class="nf">_drbd_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">msg_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sent</span><span class="p">,</span> <span class="n">ok</span><span class="p">;</span>

	<span class="n">ERR_IF</span><span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ERR_IF</span><span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">magic</span>   <span class="o">=</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">length</span>  <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">));</span>

	<span class="n">sent</span> <span class="o">=</span> <span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg_flags</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">sent</span> <span class="o">==</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;short sent %s size=%d sent=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">cmdname</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">,</span> <span class="n">sent</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* don&#39;t pass the socket. we may only look at it</span>
<span class="cm"> * when we hold the appropriate socket mutex.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_data_socket</span><span class="p">,</span>
		  <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_data_socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">sock</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">sock</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* drbd_disconnect() could have called drbd_free_sock()</span>
<span class="cm">	 * while we were waiting in down()... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_data_socket</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_cmd2</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_header80</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="n">h</span><span class="p">.</span><span class="n">magic</span>   <span class="o">=</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">;</span>
	<span class="n">h</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">h</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_get_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span>
		<span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">drbd_put_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_sync_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">syncer_conf</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_rs_param_95</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">apv</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">apv</span> <span class="o">&lt;=</span> <span class="mi">87</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">apv</span> <span class="o">==</span> <span class="mi">88</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="o">:</span> <span class="n">apv</span> <span class="o">&lt;=</span> <span class="mi">94</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param_89</span><span class="p">)</span>
		<span class="o">:</span> <span class="cm">/* apv &gt;= 95 */</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_rs_param_95</span><span class="p">);</span>

	<span class="cm">/* used from admin command context and receiver/worker context.</span>
<span class="cm">	 * to avoid kmalloc, grab the socket right here,</span>
<span class="cm">	 * then use the pre-allocated sbuf there */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">sock</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">apv</span> <span class="o">&gt;=</span> <span class="mi">89</span> <span class="o">?</span> <span class="n">P_SYNC_PARAM89</span> <span class="o">:</span> <span class="n">P_SYNC_PARAM</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sbuf</span><span class="p">.</span><span class="n">rs_param_95</span><span class="p">;</span>

		<span class="cm">/* initialize verify_alg and csums_alg */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SHARED_SECRET_MAX</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_plan_ahead</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">c_plan_ahead</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_delay_target</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">c_delay_target</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_fill_target</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">c_fill_target</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_max_rate</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">c_max_rate</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">&gt;=</span> <span class="mi">88</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">verify_alg</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">verify_alg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apv</span> <span class="o">&gt;=</span> <span class="mi">89</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">csums_alg</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">csums_alg</span><span class="p">);</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not ok */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_protocol</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_protocol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">integrity_alg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* we must not recurse into our own queue,</span>
<span class="cm">	 * as that is blocked during handshake */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span>      <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">after_sb_0p</span>   <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_0p</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">after_sb_1p</span>   <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_1p</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">after_sb_2p</span>   <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">after_sb_2p</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">two_primaries</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">two_primaries</span><span class="p">);</span>

	<span class="n">cf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span><span class="p">)</span>
		<span class="n">cf</span> <span class="o">|=</span> <span class="n">CF_WANT_LOSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">dry_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">92</span><span class="p">)</span>
			<span class="n">cf</span> <span class="o">|=</span> <span class="n">CF_DRY_RUN</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;--dry-run is not supported by peer&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">conn_flags</span>    <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">cf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">integrity_alg</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">integrity_alg</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">P_PROTOCOL</span><span class="p">,</span>
			   <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">_drbd_send_uuids</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">uuid_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_uuids</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_NEGOTIATING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_CURRENT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UI_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span> <span class="o">?</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">comm_bm_set</span> <span class="o">=</span> <span class="n">drbd_bm_total_weight</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">comm_bm_set</span><span class="p">);</span>
	<span class="n">uuid_flags</span> <span class="o">|=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">want_lose</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uuid_flags</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">CRASHED_PRIMARY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uuid_flags</span> <span class="o">|=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">new_state_tmp</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_INCONSISTENT</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_FLAGS</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">uuid_flags</span><span class="p">);</span>

	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">P_UUIDS</span><span class="p">,</span>
			     <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_uuids</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_uuids_skip_initial_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_drbd_send_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_print_uuids</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_NEGOTIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s %016llX:%016llX:%016llX:%016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">text</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_END</span><span class="p">]);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s effective data uuid: %016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">text</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ed_uuid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_gen_and_send_sync_uuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_rs_uuid</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">uuid</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_UP_TO_DATE</span><span class="p">);</span>

	<span class="n">uuid</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="o">&amp;&amp;</span> <span class="n">uuid</span> <span class="o">!=</span> <span class="n">UUID_JUST_CREATED</span><span class="p">)</span>
		<span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid</span> <span class="o">+</span> <span class="n">UUID_NEW_BM_OFFSET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_BITMAP</span><span class="p">,</span> <span class="n">uuid</span><span class="p">);</span>
	<span class="n">drbd_print_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;updated sync UUID&quot;</span><span class="p">);</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">uuid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">P_SYNC_UUID</span><span class="p">,</span>
			     <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_sizes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trigger_reply</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dds_flags</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_sizes</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">d_size</span><span class="p">,</span> <span class="n">u_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_order_type</span><span class="p">,</span> <span class="n">max_bio_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_NEGOTIATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">);</span>
		<span class="n">d_size</span> <span class="o">=</span> <span class="n">drbd_get_max_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">);</span>
		<span class="n">u_size</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">disk_size</span><span class="p">;</span>
		<span class="n">q_order_type</span> <span class="o">=</span> <span class="n">drbd_queue_order_type</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">max_bio_size</span> <span class="o">=</span> <span class="n">queue_max_hw_sectors</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">max_bio_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">max_bio_size</span><span class="p">,</span> <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">q_order_type</span> <span class="o">=</span> <span class="n">QUEUE_ORDERED_NONE</span><span class="p">;</span>
		<span class="n">max_bio_size</span> <span class="o">=</span> <span class="n">DRBD_MAX_BIO_SIZE</span><span class="p">;</span> <span class="cm">/* ... multiple BIOs per peer_request */</span>
	<span class="p">}</span>

	<span class="cm">/* Never allow old drbd (up to 8.3.7) to see more than 32KiB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;=</span> <span class="mi">94</span><span class="p">)</span>
		<span class="n">max_bio_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">max_bio_size</span><span class="p">,</span> <span class="n">DRBD_MAX_SIZE_H80_PACKET</span><span class="p">);</span>

	<span class="n">p</span><span class="p">.</span><span class="n">d_size</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">d_size</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">u_size</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">u_size</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">c_size</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">trigger_reply</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">));</span>
	<span class="n">p</span><span class="p">.</span><span class="n">max_bio_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">max_bio_size</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">queue_order_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">q_order_type</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">dds_flags</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">P_SIZES</span><span class="p">,</span>
			   <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_send_current_state() - Sends the drbd state to the peer</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_send_current_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_state</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Grab state lock so we wont send state if we&#39;re in the middle</span>
<span class="cm">	 * of a cluster wide state change on another thread */</span>
	<span class="n">drbd_state_lock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">p</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">i</span><span class="p">);</span> <span class="cm">/* Within the send mutex */</span>
	<span class="n">sock</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">P_STATE</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">drbd_state_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_send_state() - After a state change, sends the new state to the peer</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @state:	the state to send, not necessarily the current state.</span>
<span class="cm"> *</span>
<span class="cm"> * Each state change queues an &quot;after_state_ch&quot; work, which will eventually</span>
<span class="cm"> * send the resulting new state to the peer. If more state changes happen</span>
<span class="cm"> * between queuing and processing of the after_state_ch work, we still</span>
<span class="cm"> * want to send each intermediary state in the order it occurred.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_send_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_state</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">p</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
	<span class="n">sock</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">P_STATE</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_state_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">drbd_state</span> <span class="n">mask</span><span class="p">,</span> <span class="k">union</span> <span class="n">drbd_state</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_req_state</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">mask</span>    <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">val</span>     <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">P_STATE_CHG_REQ</span><span class="p">,</span>
			     <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_sr_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_state_rv</span> <span class="n">retcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_req_state_reply</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">retcode</span>    <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">retcode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_META_SOCKET</span><span class="p">,</span> <span class="n">P_STATE_CHG_REPLY</span><span class="p">,</span>
			     <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fill_bitmap_rle_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">p_compressed_bm</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bitstream</span> <span class="n">bs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">plain_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">toggle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="cm">/* may we use this feature? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">use_rle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* nothing to do. */</span>

	<span class="cm">/* use at most thus many bytes */</span>
	<span class="n">bitstream_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bs</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">BM_PACKET_VLI_BYTES_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BM_PACKET_VLI_BYTES_MAX</span><span class="p">);</span>
	<span class="cm">/* plain bits covered in this code string */</span>
	<span class="n">plain_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* p-&gt;encoding &amp; 0x80 stores whether the first run length is set.</span>
<span class="cm">	 * bit offset is implicit.</span>
<span class="cm">	 * start with toggle == 2 to be able to tell the first iteration */</span>
	<span class="n">toggle</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* see how much plain bits we can stuff into one packet</span>
<span class="cm">	 * using RLE and VLI. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">toggle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">_drbd_bm_find_next_zero</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span><span class="p">)</span>
				    <span class="o">:</span> <span class="n">_drbd_bm_find_next</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">;</span>
		<span class="n">rl</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">toggle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* first iteration */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* the first checked bit was set,</span>
<span class="cm">				 * store start value, */</span>
				<span class="n">DCBP_set_start</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="cm">/* but skip encoding of zero run length */</span>
				<span class="n">toggle</span> <span class="o">=</span> <span class="o">!</span><span class="n">toggle</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DCBP_set_start</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* paranoia: catch zero runlength.</span>
<span class="cm">		 * can only happen if bitmap is modified while we scan it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected zero runlength while encoding bitmap &quot;</span>
			    <span class="s">&quot;t:%u bo:%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">toggle</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bits</span> <span class="o">=</span> <span class="n">vli_encode_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bs</span><span class="p">,</span> <span class="n">rl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">)</span> <span class="cm">/* buffer full */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;error while encoding bitmap: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">toggle</span> <span class="o">=</span> <span class="o">!</span><span class="n">toggle</span><span class="p">;</span>
		<span class="n">plain_bits</span> <span class="o">+=</span> <span class="n">rl</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">bs</span><span class="p">.</span><span class="n">cur</span><span class="p">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">+</span> <span class="o">!!</span><span class="n">bs</span><span class="p">.</span><span class="n">cur</span><span class="p">.</span><span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plain_bits</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* incompressible with this method.</span>
<span class="cm">		 * we need to rewind both word and bit position. */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">-=</span> <span class="n">plain_bits</span><span class="p">;</span>
		<span class="n">bm_xfer_ctx_bit_to_word_offset</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* RLE + VLI was able to compress it just fine.</span>
<span class="cm">	 * update c-&gt;word_offset. */</span>
	<span class="n">bm_xfer_ctx_bit_to_word_offset</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="cm">/* store pad_bits */</span>
	<span class="n">DCBP_set_pad_bits</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bs</span><span class="p">.</span><span class="n">cur</span><span class="p">.</span><span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * send_bitmap_rle_or_plain</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 when done, 1 when another iteration is needed, and a negative error</span>
<span class="cm"> * code upon failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">send_bitmap_rle_or_plain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_compressed_bm</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_words</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fill_bitmap_rle_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DCBP_set_code</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RLE_VLI_Bits</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">P_COMPRESSED_BITMAP</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">c</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* DONE */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* was not compressible.</span>
<span class="cm">		 * send a buffer full of plain text bits instead. */</span>
		<span class="n">num_words</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">BM_PACKET_WORDS</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_words</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">num_words</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="n">drbd_bm_get_lel</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span><span class="p">,</span> <span class="n">num_words</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">P_BITMAP</span><span class="p">,</span>
				   <span class="n">h</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span> <span class="o">+=</span> <span class="n">num_words</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">word_offset</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>

		<span class="n">c</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bm_bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INFO_bm_xfer_stats</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;send&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* See the comment at receive_bitmap() */</span>
<span class="kt">int</span> <span class="nf">_drbd_send_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bm_xfer_ctx</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ERR_IF</span><span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* maybe we should use some per thread scratch page,</span>
<span class="cm">	 * and allocate that during initial device creation? */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;failed to allocate one page buffer in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_test_flag</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">MDF_FULL_SYNC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Writing the whole bitmap, MDF_FullSync was set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drbd_bm_set_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_write</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* write_bm did fail! Leave full sync flag set in Meta P_DATA</span>
<span class="cm">				 * but otherwise process as per normal - need to tell other</span>
<span class="cm">				 * side that a full resync is required! */</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Failed to write bitmap to disk!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">drbd_md_clear_flag</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">MDF_FULL_SYNC</span><span class="p">);</span>
				<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bm_xfer_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bm_bits</span> <span class="o">=</span> <span class="n">drbd_bm_bits</span><span class="p">(</span><span class="n">mdev</span><span class="p">),</span>
		<span class="p">.</span><span class="n">bm_words</span> <span class="o">=</span> <span class="n">drbd_bm_words</span><span class="p">(</span><span class="n">mdev</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_bitmap_rle_or_plain</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_get_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">!</span><span class="n">_drbd_send_bitmap</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_put_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_b_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">barrier_nr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">set_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_barrier_ack</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">barrier</span>  <span class="o">=</span> <span class="n">barrier_nr</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">set_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">set_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_META_SOCKET</span><span class="p">,</span> <span class="n">P_BARRIER_ACK</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _drbd_send_ack() - Sends an ack packet</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @cmd:	Packet command code.</span>
<span class="cm"> * @sector:	sector, needs to be in big endian byte order</span>
<span class="cm"> * @blksize:	size in byte, needs to be in big endian byte order</span>
<span class="cm"> * @block_id:	Id, big endian byte order</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">sector</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">blksize</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">block_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_block_ack</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">sector</span>   <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">block_id</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">blksize</span>  <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">seq_num</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">packet_seq</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span> <span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_META_SOCKET</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dp-&gt;sector and dp-&gt;block_id already/still in network byte order,</span>
<span class="cm"> * data_size is payload size according to dp-&gt;head,</span>
<span class="cm"> * and may need to be corrected for digest size. */</span>
<span class="kt">int</span> <span class="nf">drbd_send_ack_dp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">p_data</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data_size</span> <span class="o">-=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">data_size</span><span class="p">),</span>
			      <span class="n">dp</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_ack_rp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">p_block_req</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_send_ack() - Sends an ack packet</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @cmd:	Packet command code.</span>
<span class="cm"> * @e:		Epoch entry.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_send_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			      <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">),</span>
			      <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
			      <span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function misuses the block_id field to signal if the blocks</span>
<span class="cm"> * are is sync or not. */</span>
<span class="kt">int</span> <span class="nf">drbd_send_ack_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span>
		     <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">u64</span> <span class="n">block_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_drbd_send_ack</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			      <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sector</span><span class="p">),</span>
			      <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">blksize</span><span class="p">),</span>
			      <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">block_id</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_drequest</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u64</span> <span class="n">block_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_block_req</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">sector</span>   <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">block_id</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">blksize</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_drequest_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
			    <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">digest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">digest_size</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_block_req</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">sector</span>   <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">BE_DRBD_MAGIC</span> <span class="o">+</span> <span class="mh">0xbeef</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">blksize</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">magic</span>   <span class="o">=</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">)</span> <span class="o">+</span> <span class="n">digest_size</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">digest_size</span> <span class="o">==</span> <span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">digest_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_ov_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_block_req</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">sector</span>   <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">BE_DRBD_MAGIC</span> <span class="o">+</span> <span class="mh">0xbabe</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">blksize</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">P_OV_REQUEST</span><span class="p">,</span>
			   <span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called on sndtimeo</span>
<span class="cm"> * returns false if we should retry,</span>
<span class="cm"> * true if we think connection is dead</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">we_should_drop_the_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drop_it</span><span class="p">;</span>
	<span class="cm">/* long elapsed = (long)(jiffies - mdev-&gt;last_received); */</span>

	<span class="n">drop_it</span> <span class="o">=</span>   <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span> <span class="o">==</span> <span class="n">sock</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">.</span><span class="n">task</span>
		<span class="o">||</span> <span class="n">get_t_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Running</span>
		<span class="o">||</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drop_it</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">drop_it</span> <span class="o">=</span> <span class="o">!--</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ko_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drop_it</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;[%s/%d] sock_sendmsg time expired, ko = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ko_count</span><span class="p">);</span>
		<span class="n">request_ping</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">drop_it</span><span class="p">;</span> <span class="cm">/* &amp;&amp; (mdev-&gt;state == R_PRIMARY) */</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The idea of sendpage seems to be to put some kind of reference</span>
<span class="cm"> * to the page into the skb, and to hand it over to the NIC. In</span>
<span class="cm"> * this process get_page() gets called.</span>
<span class="cm"> *</span>
<span class="cm"> * As soon as the page was really sent over the network put_page()</span>
<span class="cm"> * gets called by some part of the network layer. [ NIC driver? ]</span>
<span class="cm"> *</span>
<span class="cm"> * [ get_page() / put_page() increment/decrement the count. If count</span>
<span class="cm"> *   reaches 0 the page will be freed. ]</span>
<span class="cm"> *</span>
<span class="cm"> * This works nicely with pages from FSs.</span>
<span class="cm"> * But this means that in protocol A we might signal IO completion too early!</span>
<span class="cm"> *</span>
<span class="cm"> * In order not to corrupt data during a resync we must make sure</span>
<span class="cm"> * that we do not reuse our own buffer pages (EEs) to early, therefore</span>
<span class="cm"> * we have the net_ee list.</span>
<span class="cm"> *</span>
<span class="cm"> * XFS seems to have problems, still, it submits pages with page_count == 0!</span>
<span class="cm"> * As a workaround, we disable sendpage on pages</span>
<span class="cm"> * with page_count == 0 or PageSlab.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_no_send_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">msg_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg_flags</span><span class="p">);</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">send_cnt</span> <span class="o">+=</span> <span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sent</span> <span class="o">==</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_send_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">msg_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">sent</span><span class="p">,</span> <span class="n">ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* e.g. XFS meta- &amp; log-data is in slab pages, which have a</span>
<span class="cm">	 * page_count of 0 and/or have PageSlab() set.</span>
<span class="cm">	 * we cannot use send_page for those, as that does get_page();</span>
<span class="cm">	 * put_page(); and would cause either a VM_BUG directly, or</span>
<span class="cm">	 * __page_cache_release a page that would actually still be referenced</span>
<span class="cm">	 * by someone, leading to some obscure delayed Oops somewhere else. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_sendpage</span> <span class="o">||</span> <span class="p">(</span><span class="n">page_count</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">PageSlab</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">_drbd_no_send_page</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg_flags</span><span class="p">);</span>

	<span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_NOSIGNAL</span><span class="p">;</span>
	<span class="n">drbd_update_congested</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sent</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sendpage</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
							<span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
							<span class="n">msg_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">we_should_drop_the_connection</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span>
							  <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s: size=%d len=%d sent=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">sent</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span>    <span class="o">-=</span> <span class="n">sent</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">sent</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="cm">/* THINK &amp;&amp; mdev-&gt;cstate &gt;= C_CONNECTED*/</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NET_CONGESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ok</span><span class="p">))</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">send_cnt</span> <span class="o">+=</span> <span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_send_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* hint all but last page with MSG_MORE */</span>
	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_drbd_no_send_page</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">,</span>
				     <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">,</span>
				     <span class="n">i</span> <span class="o">==</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">MSG_MORE</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_send_zc_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* hint all but last page with MSG_MORE */</span>
	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_drbd_send_page</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">,</span>
				     <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">,</span>
				     <span class="n">i</span> <span class="o">==</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">MSG_MORE</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_drbd_send_zc_ee</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="cm">/* hint all but last page with MSG_MORE */</span>
	<span class="n">page_chain_for_each</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">l</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_drbd_send_page</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
				<span class="n">page_chain_next</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">?</span> <span class="n">MSG_MORE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bio_flags_to_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bi_rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">95</span><span class="p">)</span>
		<span class="k">return</span>  <span class="p">(</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span> <span class="o">?</span> <span class="n">DP_RW_SYNC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_FUA</span> <span class="o">?</span> <span class="n">DP_FUA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_FLUSH</span> <span class="o">?</span> <span class="n">DP_FLUSH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_DISCARD</span> <span class="o">?</span> <span class="n">DP_DISCARD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span> <span class="o">?</span> <span class="n">DP_RW_SYNC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Used to send write requests</span>
<span class="cm"> * R_PRIMARY -&gt; Peer	(P_DATA)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_send_dblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_data</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dp_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dgb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dgs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_get_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">DRBD_MAX_SIZE_H80_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h80</span><span class="p">.</span><span class="n">magic</span>   <span class="o">=</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">;</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h80</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">P_DATA</span><span class="p">);</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h80</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">p_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">dgs</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h95</span><span class="p">.</span><span class="n">magic</span>   <span class="o">=</span> <span class="n">BE_DRBD_MAGIC_BIG</span><span class="p">;</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h95</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">P_DATA</span><span class="p">);</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h95</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">p_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">dgs</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="p">.</span><span class="n">sector</span>   <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">block_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span><span class="p">;</span>
	<span class="n">p</span><span class="p">.</span><span class="n">seq_num</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">packet_seq</span><span class="p">));</span>

	<span class="n">dp_flags</span> <span class="o">=</span> <span class="n">bio_flags_to_wire</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&gt;=</span> <span class="n">C_SYNC_SOURCE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;=</span> <span class="n">C_PAUSED_SYNC_T</span><span class="p">)</span>
		<span class="n">dp_flags</span> <span class="o">|=</span> <span class="n">DP_MAY_SET_IN_SYNC</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">dp_flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dp_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">UNPLUG_REMOTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">dgs</span> <span class="o">?</span> <span class="n">MSG_MORE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dgb</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_out</span><span class="p">;</span>
		<span class="n">drbd_csum_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">,</span> <span class="n">dgb</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">dgs</span> <span class="o">==</span> <span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">dgb</span><span class="p">,</span> <span class="n">dgs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For protocol A, we have to memcpy the payload into</span>
<span class="cm">		 * socket buffers, as we may complete right away</span>
<span class="cm">		 * as soon as we handed it over to tcp, at which point the data</span>
<span class="cm">		 * pages may become invalid.</span>
<span class="cm">		 *</span>
<span class="cm">		 * For data-integrity enabled, we copy it as well, so we can be</span>
<span class="cm">		 * sure that even if the bio pages may still be modified, it</span>
<span class="cm">		 * won&#39;t change the data on the wire, thus if the digest checks</span>
<span class="cm">		 * out ok after sending on this side, but does not fit on the</span>
<span class="cm">		 * receiving side, we sure have detected corruption elsewhere.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">wire_protocol</span> <span class="o">==</span> <span class="n">DRBD_PROT_A</span> <span class="o">||</span> <span class="n">dgs</span><span class="p">)</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_zc_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">);</span>

		<span class="cm">/* double check digest, sometimes buffers have been modified in flight. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dgs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dgs</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 64 byte, 512 bit, is the largest digest size</span>
<span class="cm">			 * currently supported in kernel crypto. */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">digest</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
			<span class="n">drbd_csum_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_out</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">dgs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span>
					<span class="s">&quot;Digest mismatch, buffer modified by upper layers during write: %llus +%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="cm">/* else if (dgs &gt; 64) {</span>
<span class="cm">		     ... Be noisy about digest too large ...</span>
<span class="cm">		} */</span>
	<span class="p">}</span>

	<span class="n">drbd_put_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* answer packet, used to send data back for read requests:</span>
<span class="cm"> *  Peer       -&gt; (diskless) R_PRIMARY   (P_DATA_REPLY)</span>
<span class="cm"> *  C_SYNC_SOURCE -&gt; C_SYNC_TARGET         (P_RS_DATA_REPLY)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_send_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">drbd_packets</span> <span class="n">cmd</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drbd_epoch_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p_data</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dgb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dgs</span><span class="p">;</span>

	<span class="n">dgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">&gt;=</span> <span class="mi">87</span> <span class="o">&amp;&amp;</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">crypto_hash_digestsize</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">DRBD_MAX_SIZE_H80_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h80</span><span class="p">.</span><span class="n">magic</span>   <span class="o">=</span> <span class="n">BE_DRBD_MAGIC</span><span class="p">;</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h80</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h80</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">)</span> <span class="o">+</span> <span class="n">dgs</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h95</span><span class="p">.</span><span class="n">magic</span>   <span class="o">=</span> <span class="n">BE_DRBD_MAGIC_BIG</span><span class="p">;</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h95</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">h95</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_header80</span><span class="p">)</span> <span class="o">+</span> <span class="n">dgs</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="p">.</span><span class="n">sector</span>   <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">block_id</span><span class="p">;</span>
	<span class="cm">/* p.seq_num  = 0;    No sequence numbers here.. */</span>

	<span class="cm">/* Only called by our kernel thread.</span>
<span class="cm">	 * This one may be interrupted by DRBD_SIG and/or DRBD_SIGKILL</span>
<span class="cm">	 * in response to admin command or module unload.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_get_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">dgs</span> <span class="o">?</span> <span class="n">MSG_MORE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">dgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dgb</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_out</span><span class="p">;</span>
		<span class="n">drbd_csum_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">dgb</span><span class="p">);</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">dgs</span> <span class="o">==</span> <span class="n">drbd_send</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">dgb</span><span class="p">,</span> <span class="n">dgs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">_drbd_send_zc_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="n">drbd_put_data_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drbd_send_oos</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p_block_desc</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="p">.</span><span class="n">sector</span>  <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">p</span><span class="p">.</span><span class="n">blksize</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drbd_send_cmd</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">USE_DATA_SOCKET</span><span class="p">,</span> <span class="n">P_OUT_OF_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  drbd_send distinguishes two cases:</span>

<span class="cm">  Packets sent via the data socket &quot;sock&quot;</span>
<span class="cm">  and packets sent via the meta data socket &quot;msock&quot;</span>

<span class="cm">		    sock                      msock</span>
<span class="cm">  -----------------+-------------------------+------------------------------</span>
<span class="cm">  timeout           conf.timeout / 2          conf.timeout / 2</span>
<span class="cm">  timeout action    send a ping via msock     Abort communication</span>
<span class="cm">					      and close all sockets</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> * you must have down()ed the appropriate [m]sock_mutex elsewhere!</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
	      <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">msg_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* THINK  if (signal_pending) return ... ? */</span>

	<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">msg_name</span>       <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_namelen</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span>      <span class="o">=</span> <span class="n">msg_flags</span> <span class="o">|</span> <span class="n">MSG_NOSIGNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ko_count</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span><span class="o">-&gt;</span><span class="n">ko_count</span><span class="p">;</span>
		<span class="n">drbd_update_congested</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* STRANGE</span>
<span class="cm">		 * tcp_sendmsg does _not_ use its size parameter at all ?</span>
<span class="cm">		 *</span>
<span class="cm">		 * -EAGAIN on timeout, -EINTR on signal.</span>
<span class="cm">		 */</span>
<span class="cm">/* THINK</span>
<span class="cm"> * do we need to block DRBD_SIG if sock == &amp;meta.socket ??</span>
<span class="cm"> * otherwise wake_asender() might interrupt some send_*Ack !</span>
<span class="cm"> */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">kernel_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">we_should_drop_the_connection</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sent</span> <span class="o">+=</span> <span class="n">rv</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">+=</span> <span class="n">rv</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span>  <span class="o">-=</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NET_CONGESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%s_sendmsg returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">sock</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span> <span class="o">?</span> <span class="s">&quot;msock&quot;</span> <span class="o">:</span> <span class="s">&quot;sock&quot;</span><span class="p">,</span>
			    <span class="n">rv</span><span class="p">);</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_BROKEN_PIPE</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">C_TIMEOUT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_main_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* to have a stable mdev-&gt;state.role</span>
<span class="cm">	 * and no race with updating open_cnt */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">R_PRIMARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_oos</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">open_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_main_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gd</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_main_mutex</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">open_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_main_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This way we get a compile error when sync_conf grows,</span>
<span class="cm">	   and we forgot to initialize it here */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">syncer_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* .rate = */</span>		<span class="n">DRBD_RATE_DEF</span><span class="p">,</span>
		<span class="cm">/* .after = */</span>		<span class="n">DRBD_AFTER_DEF</span><span class="p">,</span>
		<span class="cm">/* .al_extents = */</span>	<span class="n">DRBD_AL_EXTENTS_DEF</span><span class="p">,</span>
		<span class="cm">/* .verify_alg = */</span>	<span class="p">{},</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* .cpu_mask = */</span>	<span class="p">{},</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* .csums_alg = */</span>	<span class="p">{},</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* .use_rle = */</span>	<span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* .on_no_data = */</span>	<span class="n">DRBD_ON_NO_DATA_DEF</span><span class="p">,</span>
		<span class="cm">/* .c_plan_ahead = */</span>	<span class="n">DRBD_C_PLAN_AHEAD_DEF</span><span class="p">,</span>
		<span class="cm">/* .c_delay_target = */</span>	<span class="n">DRBD_C_DELAY_TARGET_DEF</span><span class="p">,</span>
		<span class="cm">/* .c_fill_target = */</span>	<span class="n">DRBD_C_FILL_TARGET_DEF</span><span class="p">,</span>
		<span class="cm">/* .c_max_rate = */</span>	<span class="n">DRBD_C_MAX_RATE_DEF</span><span class="p">,</span>
		<span class="cm">/* .c_min_rate = */</span>	<span class="n">DRBD_C_MIN_RATE_DEF</span>
	<span class="p">};</span>

	<span class="cm">/* Have to use that way, because the layout differs between</span>
<span class="cm">	   big endian and little endian */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">drbd_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">R_SECONDARY</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">R_UNKNOWN</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">C_STANDALONE</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">D_DISKLESS</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">pdsk</span> <span class="o">=</span> <span class="n">D_UNKNOWN</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">susp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">susp_nod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">susp_fen</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_init_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the memset(,0,) did most of this.</span>
<span class="cm">	 * note: only assignments, no allocation in here */</span>

	<span class="n">drbd_set_defaults</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_bio_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_pending_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_pending_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unacked_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">packet_seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">pp_in_use_by_net</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_sect_ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_in_flight</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_in_use</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_mutex</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q_lock</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_seq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epoch_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_ee</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_reads</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unplug_work</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">go_diskless</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_work</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_work</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">.</span><span class="n">cb</span>  <span class="o">=</span> <span class="n">w_resync_timer</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unplug_work</span><span class="p">.</span><span class="n">cb</span>  <span class="o">=</span> <span class="n">w_send_write_hint</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">go_diskless</span><span class="p">.</span><span class="n">cb</span>  <span class="o">=</span> <span class="n">w_go_diskless</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_work</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_md_sync</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_bitmap_io</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_work</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">w_start_resync</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_timer</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_timer</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">request_timer</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">resync_timer_fn</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mdev</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">md_sync_timer_fn</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mdev</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">start_resync_timer_fn</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">start_resync_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mdev</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">request_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">request_timer_fn</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">request_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mdev</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_cnt_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">seq_wait</span><span class="p">);</span>

	<span class="n">drbd_thread_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">,</span> <span class="n">drbdd_init</span><span class="p">);</span>
	<span class="n">drbd_thread_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">,</span> <span class="n">drbd_worker</span><span class="p">);</span>
	<span class="n">drbd_thread_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">asender</span><span class="p">,</span> <span class="n">drbd_asender</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">agreed_pro_version</span> <span class="o">=</span> <span class="n">PRO_VERSION_MAX</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">write_ordering</span> <span class="o">=</span> <span class="n">WO_bdev_flush</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_wenr</span> <span class="o">=</span> <span class="n">LC_FREE</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_max_bio_size</span> <span class="o">=</span> <span class="n">DRBD_MAX_BIO_SIZE_SAFE</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">local_max_bio_size</span> <span class="o">=</span> <span class="n">DRBD_MAX_BIO_SIZE_SAFE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_mdev_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">.</span><span class="n">t_state</span> <span class="o">!=</span> <span class="n">None</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;ASSERT FAILED: receiver t_state == %d expected 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">receiver</span><span class="p">.</span><span class="n">t_state</span><span class="p">);</span>

	<span class="cm">/* no need to lock it, I&#39;m the only thread alive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">)</span> <span class="o">!=</span>  <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;epoch_size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">epoch_size</span><span class="p">));</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">al_writ_cnt</span>  <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_writ_cnt</span>  <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_cnt</span>     <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">recv_cnt</span>     <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">send_cnt</span>     <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">writ_cnt</span>     <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_size</span>       <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_start</span>     <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_total</span>     <span class="o">=</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_failed</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_last_sect_ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRBD_SYNC_MARKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rs_mark_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_conf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">drbd_set_my_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* maybe never allocated. */</span>
		<span class="n">drbd_bm_resize</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">drbd_bm_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drbd_free_resources</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AL_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * currently we drbd_init_ee only on module load, so</span>
<span class="cm">	 * we may do drbd_release_ee only on module unload!</span>
<span class="cm">	 */</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_ee</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_reads</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">.</span><span class="n">list</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">unplug_work</span><span class="p">.</span><span class="n">list</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">go_diskless</span><span class="p">.</span><span class="n">list</span><span class="p">));</span>

	<span class="n">drbd_set_defaults</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_destroy_mempools</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">drbd_pp_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">drbd_pp_pool</span><span class="p">;</span>
		<span class="n">drbd_pp_pool</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span><span class="n">page_private</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">drbd_pp_vacant</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* D_ASSERT(atomic_read(&amp;drbd_pp_vacant)==0); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_io_bio_set</span><span class="p">)</span>
		<span class="n">bioset_free</span><span class="p">(</span><span class="n">drbd_md_io_bio_set</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_io_page_pool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">drbd_md_io_page_pool</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_ee_mempool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">drbd_ee_mempool</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_request_mempool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">drbd_request_mempool</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_ee_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">drbd_ee_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_request_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">drbd_request_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_ext_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">drbd_bm_ext_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_al_ext_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">drbd_al_ext_cache</span><span class="p">);</span>

	<span class="n">drbd_md_io_bio_set</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_md_io_page_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_ee_mempool</span>      <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_request_mempool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_ee_cache</span>        <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_request_cache</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_bm_ext_cache</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_al_ext_cache</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_create_mempools</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="n">DRBD_MAX_BIO_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="n">minor_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* prepare our caches and mempools */</span>
	<span class="n">drbd_request_mempool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_ee_cache</span>        <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_request_cache</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_bm_ext_cache</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_al_ext_cache</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_pp_pool</span>         <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_md_io_page_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drbd_md_io_bio_set</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* caches */</span>
	<span class="n">drbd_request_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span>
		<span class="s">&quot;drbd_req&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_request</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_request_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">drbd_ee_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span>
		<span class="s">&quot;drbd_ee&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch_entry</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_ee_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">drbd_bm_ext_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span>
		<span class="s">&quot;drbd_bm&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bm_extent</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_ext_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">drbd_al_ext_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span>
		<span class="s">&quot;drbd_al&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lc_element</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_al_ext_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="cm">/* mempools */</span>
<span class="cp">#ifdef COMPAT_HAVE_BIOSET_CREATE</span>
	<span class="n">drbd_md_io_bio_set</span> <span class="o">=</span> <span class="n">bioset_create</span><span class="p">(</span><span class="n">DRBD_MIN_POOL_PAGES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_io_bio_set</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">drbd_md_io_page_pool</span> <span class="o">=</span> <span class="n">mempool_create_page_pool</span><span class="p">(</span><span class="n">DRBD_MIN_POOL_PAGES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_md_io_page_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">drbd_request_mempool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">number</span><span class="p">,</span>
		<span class="n">mempool_alloc_slab</span><span class="p">,</span> <span class="n">mempool_free_slab</span><span class="p">,</span> <span class="n">drbd_request_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_request_mempool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">drbd_ee_mempool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">number</span><span class="p">,</span>
		<span class="n">mempool_alloc_slab</span><span class="p">,</span> <span class="n">mempool_free_slab</span><span class="p">,</span> <span class="n">drbd_ee_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_ee_mempool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="cm">/* drbd&#39;s page pool */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_HIGHUSER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
		<span class="n">set_page_private</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">drbd_pp_pool</span><span class="p">);</span>
		<span class="n">drbd_pp_pool</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">drbd_pp_vacant</span> <span class="o">=</span> <span class="n">number</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">Enomem:</span>
	<span class="n">drbd_destroy_mempools</span><span class="p">();</span> <span class="cm">/* in case we allocated some */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_notify_sys</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* just so we have it.  you never know what interesting things we</span>
<span class="cm">	 * might want to do here some day...</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">drbd_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">drbd_notify_sys</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_release_ee_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rr</span><span class="p">;</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_release_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">active_ee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%d EEs in active list found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr</span><span class="p">);</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_release_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_ee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%d EEs in sync list found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr</span><span class="p">);</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_release_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">read_ee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%d EEs in read list found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr</span><span class="p">);</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_release_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">done_ee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%d EEs in done list found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr</span><span class="p">);</span>

	<span class="n">rr</span> <span class="o">=</span> <span class="n">drbd_release_ee</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">net_ee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;%d EEs in net list found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* caution. no locking.</span>
<span class="cm"> * currently only used from module cleanup code. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_delete_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">minor_to_mdev</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">request_timer</span><span class="p">);</span>

	<span class="cm">/* paranoia asserts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">open_cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;open_cnt = %d in %s:%u&quot;</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">open_cnt</span><span class="p">,</span>
				<span class="n">__FILE__</span> <span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">ERR_IF</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;lp = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="cm">/* end paranoia asserts */</span>

	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">);</span>

	<span class="cm">/* cleanup stuff that may have been allocated during</span>
<span class="cm">	 * device (re-)configuration or state changes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">)</span>
		<span class="n">bdput</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>

	<span class="n">drbd_free_resources</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">drbd_release_ee_lists</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="cm">/* should be freed on disconnect? */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ee_hash</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	mdev-&gt;ee_hash_s = 0;</span>
<span class="cm">	mdev-&gt;ee_hash = NULL;</span>
<span class="cm">	*/</span>

	<span class="n">lc_destroy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">);</span>
	<span class="n">lc_destroy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">p_uuid</span><span class="p">);</span>
	<span class="cm">/* mdev-&gt;p_uuid = NULL; */</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_out</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_in</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">int_dig_vv</span><span class="p">);</span>

	<span class="cm">/* cleanup the rest that has been</span>
<span class="cm">	 * allocated from drbd_new_device</span>
<span class="cm">	 * and actually free the mdev itself */</span>
	<span class="n">drbd_free_mdev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_notifier</span><span class="p">);</span>

	<span class="cm">/* first remove proc,</span>
<span class="cm">	 * drbdsetup uses it&#39;s presence to detect</span>
<span class="cm">	 * whether DRBD is loaded.</span>
<span class="cm">	 * If we would get stuck in proc removal,</span>
<span class="cm">	 * but have netlink already deregistered,</span>
<span class="cm">	 * some drbdsetup commands may wait forever</span>
<span class="cm">	 * for an answer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_proc</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;drbd&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">drbd_nl_cleanup</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">minor_count</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">drbd_delete_device</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">drbd_destroy_mempools</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">minor_table</span><span class="p">);</span>

	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">DRBD_MAJOR</span><span class="p">,</span> <span class="s">&quot;drbd&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drbd: module cleanup done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_congested() - Callback for pdflush</span>
<span class="cm"> * @congested_data:	User data</span>
<span class="cm"> * @bdi_bits:		Bits pdflush is currently interested in</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1&lt;&lt;BDI_async_congested and/or 1&lt;&lt;BDI_sync_congested if we are congested.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drbd_congested</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">congested_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bdi_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">congested_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">reason</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">may_inc_ap_bio</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DRBD has frozen IO */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">bdi_bits</span><span class="p">;</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">bdi_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">,</span> <span class="n">bdi_bits</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="sc">&#39;b&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdi_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BDI_async_congested</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NET_CONGESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BDI_async_congested</span><span class="p">);</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span> <span class="o">==</span> <span class="sc">&#39;b&#39;</span> <span class="o">?</span> <span class="sc">&#39;a&#39;</span> <span class="o">:</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">congestion_reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="nf">drbd_new_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="cm">/* GFP_KERNEL, we are outside of all write-out paths */</span>
	<span class="n">mdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_no_cpumask</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">minor</span><span class="p">;</span>

	<span class="n">drbd_init_set_defaults</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">blk_alloc_queue</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_q</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rq_queue</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span>   <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>

	<span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_disk</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>

	<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">DRBD_MAJOR</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drbd_ops</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;drbd%d&quot;</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span> <span class="o">=</span> <span class="n">bdget</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">DRBD_MAJOR</span><span class="p">,</span> <span class="n">minor</span><span class="p">));</span>
	<span class="cm">/* we have no partitions. we contain only ourselves. */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_fn</span> <span class="o">=</span> <span class="n">drbd_congested</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_data</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>

	<span class="n">blk_queue_make_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">drbd_make_request</span><span class="p">);</span>
	<span class="cm">/* Setting the max_hw_sectors to an odd value of 8kibyte here</span>
<span class="cm">	   This triggers a max_bio_size message upon first attach or connect */</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">DRBD_MAX_BIO_SIZE_SAFE</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">BLK_BOUNCE_ANY</span><span class="p">);</span>
	<span class="n">blk_queue_merge_bvec</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">drbd_merge_bvec</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_io_page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drbd_bm_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_no_bitmap</span><span class="p">;</span>
	<span class="cm">/* no need to lock access, we are still initializing this minor device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tl_init</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_no_tl</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">app_reads_hash</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">APP_R_HSIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">app_reads_hash</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_app_reads</span><span class="p">;</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_epoch</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_epoch</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mdev</span><span class="p">;</span>

<span class="cm">/* out_whatever_else:</span>
<span class="cm">	kfree(mdev-&gt;current_epoch); */</span>
<span class="nl">out_no_epoch:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">app_reads_hash</span><span class="p">);</span>
<span class="nl">out_no_app_reads:</span>
	<span class="n">tl_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="nl">out_no_tl:</span>
	<span class="n">drbd_bm_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="nl">out_no_bitmap:</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span><span class="p">);</span>
<span class="nl">out_no_io_page:</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="nl">out_no_disk:</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="nl">out_no_q:</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">);</span>
<span class="nl">out_no_cpumask:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* counterpart of drbd_new_device.</span>
<span class="cm"> * last part of drbd_delete_device. */</span>
<span class="kt">void</span> <span class="nf">drbd_free_mdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">current_epoch</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">app_reads_hash</span><span class="p">);</span>
	<span class="n">tl_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="cm">/* should no longer be there. */</span>
		<span class="n">drbd_bm_cleanup</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_page</span><span class="p">);</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">vdisk</span><span class="p">);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">rq_queue</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cpu_mask</span><span class="p">);</span>
	<span class="n">drbd_free_tl_hash</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">__init</span> <span class="nf">drbd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p_handshake</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;drbd: never change the size or layout &quot;</span>
		       <span class="s">&quot;of the HandShake packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor_count</span> <span class="o">&lt;</span> <span class="n">DRBD_MINOR_COUNT_MIN</span> <span class="o">||</span> <span class="n">minor_count</span> <span class="o">&gt;</span> <span class="n">DRBD_MINOR_COUNT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;drbd: invalid minor_count (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">minor_count</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">minor_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_nl_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="n">DRBD_MAJOR</span><span class="p">,</span> <span class="s">&quot;drbd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;drbd: unable to register block device major %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRBD_MAJOR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_notifier</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate all necessary structs</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_pp_wait</span><span class="p">);</span>

	<span class="n">drbd_proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* play safe for drbd_cleanup */</span>
	<span class="n">minor_table</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">minor_count</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minor_table</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">drbd_create_mempools</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">drbd_proc</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;drbd&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drbd_proc_fops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_proc</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drbd: unable to register proc file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_state_lock</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drbd: initialized. &quot;</span>
	       <span class="s">&quot;Version: &quot;</span> <span class="n">REL_VERSION</span> <span class="s">&quot; (api:%d/proto:%d-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">API_VERSION</span><span class="p">,</span> <span class="n">PRO_VERSION_MIN</span><span class="p">,</span> <span class="n">PRO_VERSION_MAX</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drbd: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drbd_buildtag</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drbd: registered as block device major %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DRBD_MAJOR</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drbd: minor_table @ 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">minor_table</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Success! */</span>

<span class="nl">Enomem:</span>
	<span class="n">drbd_cleanup</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="cm">/* currently always the case */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drbd: ran out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drbd: initialization failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_free_bc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">ldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ldev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">backing_bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>
	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md_bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_free_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">kernel_sock_shutdown</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">SHUT_RDWR</span><span class="p">);</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">kernel_sock_shutdown</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">SHUT_RDWR</span><span class="p">);</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">drbd_free_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">csums_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">verify_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">cram_hmac_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_w_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">crypto_free_hash</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">integrity_r_tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">drbd_free_sock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">__no_warn</span><span class="p">(</span><span class="n">local</span><span class="p">,</span>
		  <span class="n">drbd_free_bc</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">);</span>
		  <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;);</span>
<span class="p">}</span>

<span class="cm">/* meta data management */</span>

<span class="k">struct</span> <span class="n">meta_data_on_disk</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">la_size</span><span class="p">;</span>           <span class="cm">/* last agreed size. */</span>
	<span class="n">u64</span> <span class="n">uuid</span><span class="p">[</span><span class="n">UI_SIZE</span><span class="p">];</span>   <span class="cm">/* UUIDs. */</span>
	<span class="n">u64</span> <span class="n">device_uuid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reserved_u64_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>             <span class="cm">/* MDF */</span>
	<span class="n">u32</span> <span class="n">magic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">md_size_sect</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">al_offset</span><span class="p">;</span>         <span class="cm">/* offset to this block */</span>
	<span class="n">u32</span> <span class="n">al_nr_extents</span><span class="p">;</span>     <span class="cm">/* important for restoring the AL */</span>
	      <span class="cm">/* `-- act_log-&gt;nr_elements &lt;-- sync_conf.al_extents */</span>
	<span class="n">u32</span> <span class="n">bm_offset</span><span class="p">;</span>         <span class="cm">/* offset to the bitmap, from here */</span>
	<span class="n">u32</span> <span class="n">bm_bytes_per_bit</span><span class="p">;</span>  <span class="cm">/* BM_BLOCK_SIZE */</span>
	<span class="n">u32</span> <span class="n">la_peer_max_bio_size</span><span class="p">;</span>   <span class="cm">/* last peer max_bio_size */</span>
	<span class="n">u32</span> <span class="n">reserved_u32</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_md_sync() - Writes the meta data super block if the MD_DIRTY flag bit is set</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_md_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">meta_data_on_disk</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_timer</span><span class="p">);</span>
	<span class="cm">/* timer may be rearmed by drbd_md_mark_dirty() now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MD_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We use here D_FAILED and not D_ATTACHING because we try to write</span>
<span class="cm">	 * metadata even if we detach due to a disk failure! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_FAILED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">drbd_md_get_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">la_size</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_CURRENT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UI_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">DRBD_MD_MAGIC</span><span class="p">);</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">md_size_sect</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">al_offset</span>     <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">al_nr_extents</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="o">-&gt;</span><span class="n">nr_elements</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">bm_bytes_per_bit</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">BM_BLOCK_SIZE</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">device_uuid</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">device_uuid</span><span class="p">);</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">bm_offset</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bm_offset</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">la_peer_max_bio_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_max_bio_size</span><span class="p">);</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">drbd_md_ss__</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">)</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span><span class="p">);</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_md_sync_page_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this was a try anyways ... */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;meta data update failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drbd_chk_io_error</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update mdev-&gt;ldev-&gt;md.la_size_sect,</span>
<span class="cm">	 * since we updated it on metadata. */</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">la_size_sect</span> <span class="o">=</span> <span class="n">drbd_get_capacity</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">this_bdev</span><span class="p">);</span>

	<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_md_read() - Reads in the meta data super block</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @bdev:	Device from which the meta data should be read in.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 (NO_ERROR) on success, and an enum drbd_ret_code in case</span>
<span class="cm"> * something goes wrong.  Currently only: ERR_IO_MD_DISK, ERR_MD_INVALID.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_md_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">meta_data_on_disk</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">NO_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">drbd_md_get_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drbd_md_sync_page_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_offset</span><span class="p">,</span> <span class="n">READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* NOTE: can&#39;t do normal error processing here as this is</span>
<span class="cm">		   called BEFORE disk is attached */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Error while reading metadata.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_IO_MD_DISK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DRBD_MD_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;Error while reading metadata, magic not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_MD_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">al_offset</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected al_offset: %d (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">al_offset</span><span class="p">),</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">al_offset</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_MD_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">bm_offset</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bm_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected bm_offset: %d (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">bm_offset</span><span class="p">),</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bm_offset</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_MD_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">md_size_sect</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected md_size: %u (expected %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">md_size_sect</span><span class="p">),</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">md_size_sect</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_MD_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">bm_bytes_per_bit</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BM_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;unexpected bm_bytes_per_bit: %u (expected %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">bm_bytes_per_bit</span><span class="p">),</span> <span class="n">BM_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_MD_INVALID</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">la_size_sect</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">la_size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_CURRENT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UI_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">al_nr_extents</span><span class="p">);</span>
	<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">device_uuid</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">device_uuid</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">conn</span> <span class="o">&lt;</span> <span class="n">C_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">peer</span><span class="p">;</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">la_peer_max_bio_size</span><span class="p">);</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">DRBD_MAX_BIO_SIZE_SAFE</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">peer_max_bio_size</span> <span class="o">=</span> <span class="n">peer</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">sync_conf</span><span class="p">.</span><span class="n">al_extents</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">drbd_md_put_buffer</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_md_mark_dirty() - Mark meta data super block as dirty</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Call this function if you change anything that should be written to</span>
<span class="cm"> * the meta-data super block. This function sets MD_DIRTY, and starts a</span>
<span class="cm"> * timer that ensures that within five seconds you have to call drbd_md_sync().</span>
<span class="cm"> */</span>
<span class="cp">#ifdef DEBUG</span>
<span class="kt">void</span> <span class="nf">drbd_md_mark_dirty_</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">MD_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_md_mark_dirty</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_md_mark_dirty</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="nf">drbd_md_mark_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">MD_DIRTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drbd_uuid_move_history</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UI_HISTORY_START</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UI_HISTORY_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_drbd_uuid_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">UI_CURRENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">R_PRIMARY</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">drbd_set_ed_uuid</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">drbd_uuid_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">drbd_uuid_move_history</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_uuid_new_current() - Creates a new current UUID</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Creates a new current UUID, and rotates the old current UUID into</span>
<span class="cm"> * the bitmap slot. Causes an incremental resync upon next connect.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_uuid_new_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bm_uuid</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bm_uuid</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;bm UUID was already set: %llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bm_uuid</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_CURRENT</span><span class="p">];</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">_drbd_uuid_set</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">UI_CURRENT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">drbd_print_uuids</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="s">&quot;new current UUID&quot;</span><span class="p">);</span>
	<span class="cm">/* get it to stable storage _now_ */</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_uuid_set_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_uuid_move_history</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_HISTORY_START</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">];</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bm_uuid</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bm_uuid</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;bm UUID was already set: %llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bm_uuid</span><span class="p">);</span>

		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">uuid</span><span class="p">[</span><span class="n">UI_BITMAP</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_bmio_set_n_write() - io_fn for drbd_queue_bitmap_io() or drbd_bitmap_io()</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets all bits in the bitmap and writes the whole bitmap to stable storage.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_bmio_set_n_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_md_set_flag</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">MDF_FULL_SYNC</span><span class="p">);</span>
		<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_bm_set_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_bm_write</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drbd_md_clear_flag</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">MDF_FULL_SYNC</span><span class="p">);</span>
			<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_bmio_clear_n_write() - io_fn for drbd_queue_bitmap_io() or drbd_bitmap_io()</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> *</span>
<span class="cm"> * Clears all bits in the bitmap and writes the whole bitmap to stable storage.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_bmio_clear_n_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">drbd_resume_al</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev_if_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">D_ATTACHING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_bm_clear_all</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">drbd_bm_write</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_bitmap_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bm_io_work</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bm_io_work</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_bio_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drbd_bm_lock</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">why</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">io_fn</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">drbd_bm_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">put_ldev</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BITMAP_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)</span>
		<span class="n">work</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BITMAP_IO_QUEUED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">why</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_ldev_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lc_destroy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">resync</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lc_destroy</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span><span class="p">);</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">act_log</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__no_warn</span><span class="p">(</span><span class="n">local</span><span class="p">,</span>
		<span class="n">drbd_free_bc</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_io_tmpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">GO_DISKLESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_go_diskless</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_FAILED</span><span class="p">);</span>
	<span class="cm">/* we cannot assert local_cnt == 0 here, as get_ldev_if_state will</span>
<span class="cm">	 * inc/dec it frequently. Once we are D_DISKLESS, no one will touch</span>
<span class="cm">	 * the protected members anymore, though, so once put_ldev reaches zero</span>
<span class="cm">	 * again, it will be safe to free them. */</span>
	<span class="n">drbd_force_state</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">NS</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">D_DISKLESS</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_go_diskless</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disk</span> <span class="o">==</span> <span class="n">D_FAILED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">GO_DISKLESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">go_diskless</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_queue_bitmap_io() - Queues an IO operation on the whole bitmap</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @io_fn:	IO callback to be called when bitmap IO is possible</span>
<span class="cm"> * @done:	callback to be called after the bitmap IO was performed</span>
<span class="cm"> * @why:	Descriptive text of the reason for doing the IO</span>
<span class="cm"> *</span>
<span class="cm"> * While IO on the bitmap happens we freeze application IO thus we ensure</span>
<span class="cm"> * that drbd_set_out_of_sync() can not be called. This function MAY ONLY be</span>
<span class="cm"> * called from worker context. It MUST NOT be used while a previous such</span>
<span class="cm"> * work is still pending!</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drbd_queue_bitmap_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">io_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">),</span>
			  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">),</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">why</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bm_flag</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_IO_QUEUED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">list</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">why</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;FIXME going to queue &#39;%s&#39; but &#39;%s&#39; still pending?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">why</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">why</span><span class="p">);</span>

	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">io_fn</span> <span class="o">=</span> <span class="n">io_fn</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">why</span> <span class="o">=</span> <span class="n">why</span><span class="p">;</span>
	<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BITMAP_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ap_bio_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BITMAP_IO_QUEUED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">drbd_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">bm_io_work</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drbd_bitmap_io() -  Does an IO operation on the whole bitmap</span>
<span class="cm"> * @mdev:	DRBD device.</span>
<span class="cm"> * @io_fn:	IO callback to be called when bitmap IO is possible</span>
<span class="cm"> * @why:	Descriptive text of the reason for doing the IO</span>
<span class="cm"> *</span>
<span class="cm"> * freezes application IO while that the actual IO operations runs. This</span>
<span class="cm"> * functions MAY NOT be called from worker context.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drbd_bitmap_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">io_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">),</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">why</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bm_flag</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">D_ASSERT</span><span class="p">(</span><span class="n">current</span> <span class="o">!=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BM_LOCKED_SET_ALLOWED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">drbd_suspend_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="n">drbd_bm_lock</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">why</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">io_fn</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="n">drbd_bm_unlock</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BM_LOCKED_SET_ALLOWED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">drbd_resume_io</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_md_set_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drbd_md_clear_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drbd_md_mark_dirty</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flag</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">drbd_md_test_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_backing_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_sync_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">drbd_queue_work_front</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">md_sync_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_md_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drbd_work</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;md_sync_timer expired! Worker calls drbd_md_sync().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;last md_mark_dirty: %s:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_md_mark_dirty</span><span class="p">.</span><span class="n">func</span><span class="p">,</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">last_md_mark_dirty</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">drbd_md_sync</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DRBD_FAULT_INJECTION</span>
<span class="cm">/* Fault insertion support including random number generator shamelessly</span>
<span class="cm"> * stolen from kernel/rcutorture.c */</span>
<span class="k">struct</span> <span class="n">fault_random_state</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FAULT_RANDOM_MULT 39916801  </span><span class="cm">/* prime */</span><span class="cp"></span>
<span class="cp">#define FAULT_RANDOM_ADD	479001701 </span><span class="cm">/* prime */</span><span class="cp"></span>
<span class="cp">#define FAULT_RANDOM_REFRESH 10000</span>

<span class="cm">/*</span>
<span class="cm"> * Crude but fast random-number generator.  Uses a linear congruential</span>
<span class="cm"> * generator, with occasional help from get_random_bytes().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">_drbd_fault_random</span><span class="p">(</span><span class="k">struct</span> <span class="n">fault_random_state</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">refresh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">refresh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">refresh</span><span class="p">));</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">+=</span> <span class="n">refresh</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">FAULT_RANDOM_REFRESH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">*</span> <span class="n">FAULT_RANDOM_MULT</span> <span class="o">+</span> <span class="n">FAULT_RANDOM_ADD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">swahw32</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">_drbd_fault_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_faults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_MD_WR</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Meta-data write&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_MD_RD</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Meta-data read&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_RS_WR</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Resync write&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_RS_RD</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Resync read&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_DT_WR</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Data write&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_DT_RD</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Data read&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_DT_RA</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Data read ahead&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_BM_ALLOC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;BM allocation&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_AL_EE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;EE allocation&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DRBD_FAULT_RECEIVE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;receive data corruption&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">DRBD_FAULT_MAX</span><span class="p">)</span> <span class="o">?</span> <span class="n">_faults</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;**Unknown**&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">_drbd_insert_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">drbd_conf</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">fault_random_state</span> <span class="n">rrs</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
		<span class="p">(</span><span class="n">fault_devs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mdev_to_minor</span><span class="p">(</span><span class="n">mdev</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">fault_devs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(((</span><span class="n">_drbd_fault_random</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">fault_rate</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fault_count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drbd_ratelimit_state</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">DEV</span><span class="p">,</span> <span class="s">&quot;***Simulating %s failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">_drbd_fault_str</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">drbd_buildtag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* DRBD built from external sources has here a reference to the</span>
<span class="cm">	   git hash of the source code. */</span>

	<span class="k">static</span> <span class="kt">char</span> <span class="n">buildtag</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">uilt-in&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buildtag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef MODULE</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buildtag</span><span class="p">,</span> <span class="s">&quot;srcversion: %-24s&quot;</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="o">-&gt;</span><span class="n">srcversion</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">buildtag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;b&#39;</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buildtag</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">drbd_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">drbd_cleanup</span><span class="p">)</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drbd_conn_str</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drbd_role_str</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drbd_disk_str</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drbd_set_st_err_str</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
