<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hv › hv_util.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hv_util.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010, Microsoft Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Haiyang Zhang &lt;haiyangz@microsoft.com&gt;</span>
<span class="cm"> *   Hank Janssen  &lt;hjanssen@microsoft.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/hyperv.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">shutdown_onchannelcallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hv_util_service</span> <span class="n">util_shutdown</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">util_cb</span> <span class="o">=</span> <span class="n">shutdown_onchannelcallback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">timesync_onchannelcallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hv_util_service</span> <span class="n">util_timesynch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">util_cb</span> <span class="o">=</span> <span class="n">timesync_onchannelcallback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">heartbeat_onchannelcallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hv_util_service</span> <span class="n">util_heartbeat</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">util_cb</span> <span class="o">=</span> <span class="n">heartbeat_onchannelcallback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hv_util_service</span> <span class="n">util_kvp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">util_cb</span> <span class="o">=</span> <span class="n">hv_kvp_onchannelcallback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">util_init</span> <span class="o">=</span> <span class="n">hv_kvp_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">util_deinit</span> <span class="o">=</span> <span class="n">hv_kvp_deinit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shutdown_onchannelcallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmbus_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recvlen</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">requestid</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">execute_shutdown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="o">*</span><span class="n">shut_txf_buf</span> <span class="o">=</span> <span class="n">util_shutdown</span><span class="p">.</span><span class="n">recv_buffer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">shutdown_msg_data</span> <span class="o">*</span><span class="n">shutdown_msg</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">icmsg_hdr</span> <span class="o">*</span><span class="n">icmsghdrp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">icmsg_negotiate</span> <span class="o">*</span><span class="n">negop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vmbus_recvpacket</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">shut_txf_buf</span><span class="p">,</span>
			 <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">requestid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recvlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icmsghdrp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">icmsg_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">shut_txf_buf</span><span class="p">[</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmbuspipe_hdr</span><span class="p">)];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">icmsgtype</span> <span class="o">==</span> <span class="n">ICMSGTYPE_NEGOTIATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vmbus_prep_negotiate_resp</span><span class="p">(</span><span class="n">icmsghdrp</span><span class="p">,</span> <span class="n">negop</span><span class="p">,</span>
					<span class="n">shut_txf_buf</span><span class="p">,</span> <span class="n">MAX_SRV_VER</span><span class="p">,</span> <span class="n">MAX_SRV_VER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shutdown_msg</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">shutdown_msg_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">shut_txf_buf</span><span class="p">[</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmbuspipe_hdr</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icmsg_hdr</span><span class="p">)];</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">shutdown_msg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">HV_S_OK</span><span class="p">;</span>
				<span class="n">execute_shutdown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Shutdown request received -&quot;</span>
					    <span class="s">&quot; graceful shutdown initiated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">HV_E_FAIL</span><span class="p">;</span>
				<span class="n">execute_shutdown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Shutdown request received -&quot;</span>
					    <span class="s">&quot; Invalid request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">icflags</span> <span class="o">=</span> <span class="n">ICMSGHDRFLAG_TRANSACTION</span>
			<span class="o">|</span> <span class="n">ICMSGHDRFLAG_RESPONSE</span><span class="p">;</span>

		<span class="n">vmbus_sendpacket</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">shut_txf_buf</span><span class="p">,</span>
				       <span class="n">recvlen</span><span class="p">,</span> <span class="n">requestid</span><span class="p">,</span>
				       <span class="n">VM_PKT_DATA_INBAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">execute_shutdown</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">orderly_poweroff</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set guest time to host UTC time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">do_adj_guesttime</span><span class="p">(</span><span class="n">u64</span> <span class="n">hosttime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">host_tns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">host_ts</span><span class="p">;</span>

	<span class="n">host_tns</span> <span class="o">=</span> <span class="p">(</span><span class="n">hosttime</span> <span class="o">-</span> <span class="n">WLTIMEDELTA</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">host_ts</span> <span class="o">=</span> <span class="n">ns_to_timespec</span><span class="p">(</span><span class="n">host_tns</span><span class="p">);</span>

	<span class="n">do_settimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host_ts</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the host time in a process context.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">adj_time_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">host_time</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hv_set_host_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adj_time_work</span>	<span class="o">*</span><span class="n">wrk</span><span class="p">;</span>

	<span class="n">wrk</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adj_time_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">do_adj_guesttime</span><span class="p">(</span><span class="n">wrk</span><span class="o">-&gt;</span><span class="n">host_time</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wrk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Synchronize time with host after reboot, restore, etc.</span>
<span class="cm"> *</span>
<span class="cm"> * ICTIMESYNCFLAG_SYNC flag bit indicates reboot, restore events of the VM.</span>
<span class="cm"> * After reboot the flag ICTIMESYNCFLAG_SYNC is included in the first time</span>
<span class="cm"> * message after the timesync channel is opened. Since the hv_utils module is</span>
<span class="cm"> * loaded after hv_vmbus, the first message is usually missed. The other</span>
<span class="cm"> * thing is, systime is automatically set to emulated hardware clock which may</span>
<span class="cm"> * not be UTC time or in the same time zone. So, to override these effects, we</span>
<span class="cm"> * use the first 50 time samples for initial system time setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">adj_guesttime</span><span class="p">(</span><span class="n">u64</span> <span class="n">hosttime</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adj_time_work</span>    <span class="o">*</span><span class="n">wrk</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">s32</span> <span class="n">scnt</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="n">wrk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adj_time_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wrk</span><span class="o">-&gt;</span><span class="n">host_time</span> <span class="o">=</span> <span class="n">hosttime</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICTIMESYNCFLAG_SYNC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrk</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">hv_set_host_time</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrk</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICTIMESYNCFLAG_SAMPLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">scnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrk</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">hv_set_host_time</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrk</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">wrk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Time Sync Channel message handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">timesync_onchannelcallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmbus_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recvlen</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">requestid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">icmsg_hdr</span> <span class="o">*</span><span class="n">icmsghdrp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ictimesync_data</span> <span class="o">*</span><span class="n">timedatap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">time_txf_buf</span> <span class="o">=</span> <span class="n">util_timesynch</span><span class="p">.</span><span class="n">recv_buffer</span><span class="p">;</span>

	<span class="n">vmbus_recvpacket</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">time_txf_buf</span><span class="p">,</span>
			 <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">requestid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recvlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icmsghdrp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">icmsg_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">time_txf_buf</span><span class="p">[</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmbuspipe_hdr</span><span class="p">)];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">icmsgtype</span> <span class="o">==</span> <span class="n">ICMSGTYPE_NEGOTIATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vmbus_prep_negotiate_resp</span><span class="p">(</span><span class="n">icmsghdrp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">time_txf_buf</span><span class="p">,</span>
						<span class="n">MAX_SRV_VER</span><span class="p">,</span> <span class="n">MAX_SRV_VER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">timedatap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ictimesync_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">time_txf_buf</span><span class="p">[</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmbuspipe_hdr</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icmsg_hdr</span><span class="p">)];</span>
			<span class="n">adj_guesttime</span><span class="p">(</span><span class="n">timedatap</span><span class="o">-&gt;</span><span class="n">parenttime</span><span class="p">,</span> <span class="n">timedatap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">icflags</span> <span class="o">=</span> <span class="n">ICMSGHDRFLAG_TRANSACTION</span>
			<span class="o">|</span> <span class="n">ICMSGHDRFLAG_RESPONSE</span><span class="p">;</span>

		<span class="n">vmbus_sendpacket</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">time_txf_buf</span><span class="p">,</span>
				<span class="n">recvlen</span><span class="p">,</span> <span class="n">requestid</span><span class="p">,</span>
				<span class="n">VM_PKT_DATA_INBAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Heartbeat functionality.</span>
<span class="cm"> * Every two seconds, Hyper-V send us a heartbeat request message.</span>
<span class="cm"> * we respond to this message, and Hyper-V knows we are alive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">heartbeat_onchannelcallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmbus_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recvlen</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">requestid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">icmsg_hdr</span> <span class="o">*</span><span class="n">icmsghdrp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">heartbeat_msg_data</span> <span class="o">*</span><span class="n">heartbeat_msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">hbeat_txf_buf</span> <span class="o">=</span> <span class="n">util_heartbeat</span><span class="p">.</span><span class="n">recv_buffer</span><span class="p">;</span>

	<span class="n">vmbus_recvpacket</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">hbeat_txf_buf</span><span class="p">,</span>
			 <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">requestid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recvlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icmsghdrp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">icmsg_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hbeat_txf_buf</span><span class="p">[</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmbuspipe_hdr</span><span class="p">)];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">icmsgtype</span> <span class="o">==</span> <span class="n">ICMSGTYPE_NEGOTIATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vmbus_prep_negotiate_resp</span><span class="p">(</span><span class="n">icmsghdrp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">hbeat_txf_buf</span><span class="p">,</span> <span class="n">MAX_SRV_VER</span><span class="p">,</span> <span class="n">MAX_SRV_VER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">heartbeat_msg</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">heartbeat_msg_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hbeat_txf_buf</span><span class="p">[</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmbuspipe_hdr</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">icmsg_hdr</span><span class="p">)];</span>

			<span class="n">heartbeat_msg</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">icmsghdrp</span><span class="o">-&gt;</span><span class="n">icflags</span> <span class="o">=</span> <span class="n">ICMSGHDRFLAG_TRANSACTION</span>
			<span class="o">|</span> <span class="n">ICMSGHDRFLAG_RESPONSE</span><span class="p">;</span>

		<span class="n">vmbus_sendpacket</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">hbeat_txf_buf</span><span class="p">,</span>
				       <span class="n">recvlen</span><span class="p">,</span> <span class="n">requestid</span><span class="p">,</span>
				       <span class="n">VM_PKT_DATA_INBAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">util_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">hv_vmbus_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hv_util_service</span> <span class="o">*</span><span class="n">srv</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">hv_util_service</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">srv</span><span class="o">-&gt;</span><span class="n">recv_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srv</span><span class="o">-&gt;</span><span class="n">recv_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srv</span><span class="o">-&gt;</span><span class="n">util_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srv</span><span class="o">-&gt;</span><span class="n">util_init</span><span class="p">(</span><span class="n">srv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vmbus_open</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">srv</span><span class="o">-&gt;</span><span class="n">util_cb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">hv_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">srv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srv</span><span class="o">-&gt;</span><span class="n">util_deinit</span><span class="p">)</span>
		<span class="n">srv</span><span class="o">-&gt;</span><span class="n">util_deinit</span><span class="p">();</span>
<span class="nl">error1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">srv</span><span class="o">-&gt;</span><span class="n">recv_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">util_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hv_util_service</span> <span class="o">*</span><span class="n">srv</span> <span class="o">=</span> <span class="n">hv_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vmbus_close</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srv</span><span class="o">-&gt;</span><span class="n">util_deinit</span><span class="p">)</span>
		<span class="n">srv</span><span class="o">-&gt;</span><span class="n">util_deinit</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">srv</span><span class="o">-&gt;</span><span class="n">recv_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hv_vmbus_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Shutdown guid */</span>
	<span class="p">{</span> <span class="n">VMBUS_DEVICE</span><span class="p">(</span><span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mi">0</span><span class="n">X0E</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span>
		       <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">0</span><span class="n">XD9</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">)</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">util_shutdown</span> <span class="p">},</span>
	<span class="cm">/* Time synch guid */</span>
	<span class="p">{</span> <span class="n">VMBUS_DEVICE</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span>
		       <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">)</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">util_timesynch</span> <span class="p">},</span>
	<span class="cm">/* Heartbeat guid */</span>
	<span class="p">{</span> <span class="n">VMBUS_DEVICE</span><span class="p">(</span><span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span>
		       <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">)</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">util_heartbeat</span> <span class="p">},</span>
	<span class="cm">/* KVP guid */</span>
	<span class="p">{</span> <span class="n">VMBUS_DEVICE</span><span class="p">(</span><span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span>
		       <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span>  <span class="mh">0xe6</span><span class="p">)</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">util_kvp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">vmbus</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="cm">/* The one and only one */</span>
<span class="k">static</span>  <span class="k">struct</span> <span class="n">hv_driver</span> <span class="n">util_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hv_util&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>  <span class="n">util_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>  <span class="n">util_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_hyperv_utils</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Registering HyperV Utility Driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vmbus_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">util_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exit_hyperv_utils</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;De-Registered HyperV Utility Driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">vmbus_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">util_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_hyperv_utils</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_hyperv_utils</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Hyper-V Utilities&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">HV_DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
