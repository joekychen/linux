<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › acornfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>acornfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/acornfb.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1998-2001 Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Frame buffer code for Acorn platforms</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Most of the modes with X!=640 will disappear shortly.</span>
<span class="cm"> * NOTE: Startup setting of HS &amp; VS polarity not supported.</span>
<span class="cm"> *       (do we need to support it if we&#39;re coming up in 640x480?)</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: (things broken by the &quot;new improved&quot; FBCON API)</span>
<span class="cm"> *  - Blanking 8bpp displays with VIDC</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>

<span class="cp">#include &quot;acornfb.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * VIDC machines can&#39;t do 16 or 32BPP modes.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef HAS_VIDC</span>
<span class="cp">#undef FBCON_HAS_CFB16</span>
<span class="cp">#undef FBCON_HAS_CFB32</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Default resolution.</span>
<span class="cm"> * NOTE that it has to be supported in the table towards</span>
<span class="cm"> * the end of this file.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_XRES	640</span>
<span class="cp">#define DEFAULT_YRES	480</span>
<span class="cp">#define DEFAULT_BPP	4</span>

<span class="cm">/*</span>
<span class="cm"> * define this to debug the video mode selection</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG_MODE_SELECTION</span>

<span class="cm">/*</span>
<span class="cm"> * Translation from RISC OS monitor types to actual</span>
<span class="cm"> * HSYNC and VSYNC frequency ranges.  These are</span>
<span class="cm"> * probably not right, but they&#39;re the best info I</span>
<span class="cm"> * have.  Allow 1% either way on the nominal for TVs.</span>
<span class="cm"> */</span>
<span class="cp">#define NR_MONTYPES	6</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="n">monspecs</span><span class="p">[</span><span class="n">NR_MONTYPES</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* TV		*/</span>
		<span class="p">.</span><span class="n">hfmin</span>	<span class="o">=</span> <span class="mi">15469</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfmax</span>	<span class="o">=</span> <span class="mi">15781</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmin</span>	<span class="o">=</span> <span class="mi">49</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmax</span>	<span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* Multi Freq	*/</span>
		<span class="p">.</span><span class="n">hfmin</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfmax</span>	<span class="o">=</span> <span class="mi">99999</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmin</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmax</span>	<span class="o">=</span> <span class="mi">199</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* Hi-res mono	*/</span>
		<span class="p">.</span><span class="n">hfmin</span>	<span class="o">=</span> <span class="mi">58608</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfmax</span>	<span class="o">=</span> <span class="mi">58608</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmin</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmax</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* VGA		*/</span>
		<span class="p">.</span><span class="n">hfmin</span>	<span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfmax</span>	<span class="o">=</span> <span class="mi">70000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmin</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmax</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* SVGA		*/</span>
		<span class="p">.</span><span class="n">hfmin</span>	<span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfmax</span>	<span class="o">=</span> <span class="mi">70000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmin</span>	<span class="o">=</span> <span class="mi">56</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmax</span>	<span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hfmin</span>	<span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfmax</span>	<span class="o">=</span> <span class="mi">70000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmin</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfmax</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="n">fb_info</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acornfb_par</span> <span class="n">current_par</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vidc_timing</span> <span class="n">current_vidc</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vram_size</span><span class="p">;</span>	<span class="cm">/* set by setup.c */</span>

<span class="cp">#ifdef HAS_VIDC</span>

<span class="cp">#define MAX_SIZE	480*1024</span>

<span class="cm">/* CTL     VIDC	Actual</span>
<span class="cm"> * 24.000  0	 8.000</span>
<span class="cm"> * 25.175  0	 8.392</span>
<span class="cm"> * 36.000  0	12.000</span>
<span class="cm"> * 24.000  1	12.000</span>
<span class="cm"> * 25.175  1	12.588</span>
<span class="cm"> * 24.000  2	16.000</span>
<span class="cm"> * 25.175  2	16.783</span>
<span class="cm"> * 36.000  1	18.000</span>
<span class="cm"> * 24.000  3	24.000</span>
<span class="cm"> * 36.000  2	24.000</span>
<span class="cm"> * 25.175  3	25.175</span>
<span class="cm"> * 36.000  3	36.000</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pixclock</span> <span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">min_clock</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">max_clock</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">vidc_ctl</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">vid_ctl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pixclock</span> <span class="n">arc_clocks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* we allow +/-1% on these */</span>
	<span class="p">{</span> <span class="mi">123750</span><span class="p">,</span> <span class="mi">126250</span><span class="p">,</span> <span class="n">VIDC_CTRL_DIV3</span><span class="p">,</span>   <span class="n">VID_CTL_24MHz</span> <span class="p">},</span>	<span class="cm">/*  8.000MHz */</span>
	<span class="p">{</span>  <span class="mi">82500</span><span class="p">,</span>  <span class="mi">84167</span><span class="p">,</span> <span class="n">VIDC_CTRL_DIV2</span><span class="p">,</span>   <span class="n">VID_CTL_24MHz</span> <span class="p">},</span>	<span class="cm">/* 12.000MHz */</span>
	<span class="p">{</span>  <span class="mi">61875</span><span class="p">,</span>  <span class="mi">63125</span><span class="p">,</span> <span class="n">VIDC_CTRL_DIV1_5</span><span class="p">,</span> <span class="n">VID_CTL_24MHz</span> <span class="p">},</span>	<span class="cm">/* 16.000MHz */</span>
	<span class="p">{</span>  <span class="mi">41250</span><span class="p">,</span>  <span class="mi">42083</span><span class="p">,</span> <span class="n">VIDC_CTRL_DIV1</span><span class="p">,</span>   <span class="n">VID_CTL_24MHz</span> <span class="p">},</span>	<span class="cm">/* 24.000MHz */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pixclock</span> <span class="o">*</span>
<span class="nf">acornfb_valid_pixrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">arc_clocks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">&gt;</span> <span class="n">arc_clocks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_clock</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pixclock</span> <span class="o">&lt;</span> <span class="n">arc_clocks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_clock</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">arc_clocks</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VIDC Rules:</span>
<span class="cm"> * hcr  : must be even (interlace, hcr/2 must be even)</span>
<span class="cm"> * hswr : must be even</span>
<span class="cm"> * hdsr : must be odd</span>
<span class="cm"> * hder : must be odd</span>
<span class="cm"> *</span>
<span class="cm"> * vcr  : must be odd</span>
<span class="cm"> * vswr : &gt;= 1</span>
<span class="cm"> * vdsr : &gt;= 1</span>
<span class="cm"> * vder : &gt;= vdsr</span>
<span class="cm"> * if interlaced, then hcr/2 must be even</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">acornfb_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pixclock</span> <span class="o">*</span><span class="n">pclk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vidc_timing</span> <span class="n">vidc</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">horiz_correction</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">sync_len</span><span class="p">,</span> <span class="n">display_start</span><span class="p">,</span> <span class="n">display_end</span><span class="p">,</span> <span class="n">cycle</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">is_interlaced</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">vid_ctl</span><span class="p">,</span> <span class="n">vidc_ctl</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">bandwidth</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vidc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vidc</span><span class="p">));</span>

	<span class="n">pclk</span> <span class="o">=</span> <span class="n">acornfb_valid_pixrate</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="n">vidc_ctl</span> <span class="o">=</span> <span class="n">pclk</span><span class="o">-&gt;</span><span class="n">vidc_ctl</span><span class="p">;</span>
	<span class="n">vid_ctl</span>  <span class="o">=</span> <span class="n">pclk</span><span class="o">-&gt;</span><span class="n">vid_ctl</span><span class="p">;</span>

	<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="cm">/* 25.175, 4bpp = 79.444ns per byte, 317.776ns per word: fifo = 2,6 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">&gt;</span> <span class="mi">143500</span><span class="p">)</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_FIFO_3_7</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">&gt;</span> <span class="mi">71750</span><span class="p">)</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_FIFO_2_6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">&gt;</span> <span class="mi">35875</span><span class="p">)</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_FIFO_1_5</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_FIFO_0_4</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">horiz_correction</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_1BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">horiz_correction</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_2BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">horiz_correction</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_4BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">horiz_correction</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_8BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">)</span> <span class="cm">/* should be FB_SYNC_COMP */</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_CSYNC</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">))</span>
			<span class="n">vid_ctl</span> <span class="o">|=</span> <span class="n">VID_CTL_HS_NHSYNC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">))</span>
			<span class="n">vid_ctl</span> <span class="o">|=</span> <span class="n">VID_CTL_VS_NVSYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sync_len</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">display_start</span>	<span class="o">=</span> <span class="n">sync_len</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">display_end</span>	<span class="o">=</span> <span class="n">display_start</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">cycle</span>		<span class="o">=</span> <span class="n">display_end</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>

	<span class="cm">/* if interlaced, then hcr/2 must be even */</span>
	<span class="n">is_interlaced</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_interlaced</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vidc_ctl</span> <span class="o">|=</span> <span class="n">VIDC_CTRL_INTERLACE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cycle</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span>		<span class="o">=</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_sync_width</span>	<span class="o">=</span> <span class="p">(</span><span class="n">sync_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_border_start</span>	<span class="o">=</span> <span class="p">(</span><span class="n">display_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_display_start</span>	<span class="o">=</span> <span class="p">(</span><span class="n">display_start</span> <span class="o">-</span> <span class="n">horiz_correction</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_display_end</span>	<span class="o">=</span> <span class="p">(</span><span class="n">display_end</span> <span class="o">-</span> <span class="n">horiz_correction</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_border_end</span>	<span class="o">=</span> <span class="p">(</span><span class="n">display_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_interlace</span>	<span class="o">=</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">sync_len</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">display_start</span>	<span class="o">=</span> <span class="n">sync_len</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">display_end</span>	<span class="o">=</span> <span class="n">display_start</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">cycle</span>		<span class="o">=</span> <span class="n">display_end</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_interlaced</span><span class="p">)</span>
		<span class="n">cycle</span> <span class="o">=</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vidc</span><span class="p">.</span><span class="n">v_cycle</span>		<span class="o">=</span> <span class="n">cycle</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_sync_width</span>	<span class="o">=</span> <span class="n">sync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span>	<span class="o">=</span> <span class="n">display_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_display_start</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span>	<span class="o">=</span> <span class="n">display_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_border_end</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_a5k</span><span class="p">())</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">vid_ctl</span><span class="p">,</span> <span class="n">IOEB_VID_CTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_vidc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vidc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vidc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">current_vidc</span> <span class="o">=</span> <span class="n">vidc</span><span class="p">;</span>

		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xe0000000</span> <span class="o">|</span> <span class="n">vidc_ctl</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x84000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_sync_width</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x88000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_border_start</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x8c000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_display_start</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x90000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_display_end</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x94000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_border_end</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x98000000</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x9c000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">h_interlace</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xa0000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">v_cycle</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xa4000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">v_sync_width</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xa8000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xac000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">v_display_start</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xb0000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xb4000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">vidc</span><span class="p">.</span><span class="n">v_border_end</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xb8000000</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xbc000000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG_MODE_SELECTION</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VIDC registers for %dx%dx%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
	       <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-cycle          : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-sync-width     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_sync_width</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-border-start   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-display-start  : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-display-end    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-border-end     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-interlace      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_interlace</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-cycle          : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_cycle</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-sync-width     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_sync_width</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-border-start   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-display-start  : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-display-end    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-border-end     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; VIDC Ctrl (E)    : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc_ctl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; IOEB Ctrl        : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vid_ctl</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acornfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		  <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">palette</span> <span class="n">pal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pal</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pal</span><span class="p">.</span><span class="n">vidc</span><span class="p">.</span><span class="n">reg</span>   <span class="o">=</span> <span class="n">regno</span><span class="p">;</span>
	<span class="n">pal</span><span class="p">.</span><span class="n">vidc</span><span class="p">.</span><span class="n">red</span>   <span class="o">=</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">pal</span><span class="p">.</span><span class="n">vidc</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">pal</span><span class="p">.</span><span class="n">vidc</span><span class="p">.</span><span class="n">blue</span>  <span class="o">=</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">current_par</span><span class="p">.</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">;</span>

	<span class="n">vidc_writel</span><span class="p">(</span><span class="n">pal</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HAS_VIDC20</span>
<span class="cp">#include &lt;mach/acornfb.h&gt;</span>

<span class="cp">#define MAX_SIZE	2*1024*1024</span>

<span class="cm">/* VIDC20 has a different set of rules from the VIDC:</span>
<span class="cm"> *  hcr  : must be multiple of 4</span>
<span class="cm"> *  hswr : must be even</span>
<span class="cm"> *  hdsr : must be even</span>
<span class="cm"> *  hder : must be even</span>
<span class="cm"> *  vcr  : &gt;= 2, (interlace, must be odd)</span>
<span class="cm"> *  vswr : &gt;= 1</span>
<span class="cm"> *  vdsr : &gt;= 1</span>
<span class="cm"> *  vder : &gt;= vdsr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acornfb_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vidc_timing</span> <span class="n">vidc</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">vcr</span><span class="p">,</span> <span class="n">fsize</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">ext_ctl</span><span class="p">,</span> <span class="n">dat_ctl</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">words_per_line</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vidc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vidc</span><span class="p">));</span>

	<span class="n">vidc</span><span class="p">.</span><span class="n">h_sync_width</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_border_start</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_sync_width</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_display_start</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_start</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">-</span> <span class="mi">18</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_display_end</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_start</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_border_end</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_end</span> <span class="o">+</span> <span class="mi">18</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span>		<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_end</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">h_interlace</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_sync_width</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_sync_width</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_display_start</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_start</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">v_border_end</span>	<span class="o">=</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span><span class="p">;</span>
	<span class="n">vidc</span><span class="p">.</span><span class="n">control</span>		<span class="o">=</span> <span class="n">acornfb_default_control</span><span class="p">();</span>

	<span class="n">vcr</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span>
	      <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vidc</span><span class="p">.</span><span class="n">v_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcr</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vidc</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">VIDC20_CTRL_INT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vidc</span><span class="p">.</span><span class="n">v_cycle</span> <span class="o">=</span> <span class="n">vcr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="mi">1</span>: <span class="n">vidc</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">VIDC20_CTRL_1BPP</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="mi">2</span>: <span class="n">vidc</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">VIDC20_CTRL_2BPP</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="mi">4</span>: <span class="n">vidc</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">VIDC20_CTRL_4BPP</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span>  <span class="mi">8</span>: <span class="n">vidc</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">VIDC20_CTRL_8BPP</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>: <span class="n">vidc</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">VIDC20_CTRL_16BPP</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>: <span class="n">vidc</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">VIDC20_CTRL_32BPP</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acornfb_vidc20_find_rates</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vidc</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="n">fsize</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_vidc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vidc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vidc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">current_vidc</span> <span class="o">=</span> <span class="n">vidc</span><span class="p">;</span>

		<span class="n">vidc_writel</span><span class="p">(</span><span class="n">VIDC20_CTRL</span><span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">control</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0xd0000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">pll_ctl</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x81000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_sync_width</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x82000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_start</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x83000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_start</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x84000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_end</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x85000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_end</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x86000000</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x87000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_interlace</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x90000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_cycle</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x91000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_sync_width</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x92000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x93000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_start</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x94000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x95000000</span> <span class="o">|</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_end</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x96000000</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x97000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iomd_writel</span><span class="p">(</span><span class="n">fsize</span><span class="p">,</span> <span class="n">IOMD_FSIZE</span><span class="p">);</span>

	<span class="n">ext_ctl</span> <span class="o">=</span> <span class="n">acornfb_default_econtrol</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">)</span> <span class="cm">/* should be FB_SYNC_COMP */</span>
		<span class="n">ext_ctl</span> <span class="o">|=</span> <span class="n">VIDC20_ECTL_HS_NCSYNC</span> <span class="o">|</span> <span class="n">VIDC20_ECTL_VS_NCSYNC</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
			<span class="n">ext_ctl</span> <span class="o">|=</span> <span class="n">VIDC20_ECTL_HS_HSYNC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ext_ctl</span> <span class="o">|=</span> <span class="n">VIDC20_ECTL_HS_NHSYNC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
			<span class="n">ext_ctl</span> <span class="o">|=</span> <span class="n">VIDC20_ECTL_VS_VSYNC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ext_ctl</span> <span class="o">|=</span> <span class="n">VIDC20_ECTL_VS_NVSYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vidc_writel</span><span class="p">(</span><span class="n">VIDC20_ECTL</span> <span class="o">|</span> <span class="n">ext_ctl</span><span class="p">);</span>

	<span class="n">words_per_line</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">==</span> <span class="mi">2048</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
		<span class="n">words_per_line</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* RiscPC doesn&#39;t use the VIDC&#39;s VRAM control. */</span>
	<span class="n">dat_ctl</span> <span class="o">=</span> <span class="n">VIDC20_DCTL_VRAM_DIS</span> <span class="o">|</span> <span class="n">VIDC20_DCTL_SNA</span> <span class="o">|</span> <span class="n">words_per_line</span><span class="p">;</span>

	<span class="cm">/* The data bus width is dependent on both the type</span>
<span class="cm">	 * and amount of video memory.</span>
<span class="cm">	 *     DRAM	32bit low</span>
<span class="cm">	 * 1MB VRAM	32bit</span>
<span class="cm">	 * 2MB VRAM	64bit</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span> <span class="o">&amp;&amp;</span> <span class="n">current_par</span><span class="p">.</span><span class="n">vram_half_sam</span> <span class="o">==</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="n">dat_ctl</span> <span class="o">|=</span> <span class="n">VIDC20_DCTL_BUS_D63_0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dat_ctl</span> <span class="o">|=</span> <span class="n">VIDC20_DCTL_BUS_D31_0</span><span class="p">;</span>

	<span class="n">vidc_writel</span><span class="p">(</span><span class="n">VIDC20_DCTL</span> <span class="o">|</span> <span class="n">dat_ctl</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_MODE_SELECTION</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VIDC registers for %dx%dx%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
	       <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-cycle          : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_cycle</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-sync-width     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_sync_width</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-border-start   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-display-start  : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-display-end    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_display_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-border-end     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_border_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; H-interlace      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">h_interlace</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-cycle          : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_cycle</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-sync-width     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_sync_width</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-border-start   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-display-start  : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_start</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-display-end    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_display_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; V-border-end     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">v_border_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Ext Ctrl  (C)    : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_ctl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLL Ctrl  (D)    : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">pll_ctl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Ctrl      (E)    : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidc</span><span class="p">.</span><span class="n">control</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Data Ctrl (F)    : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dat_ctl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Fsize            : 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsize</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have to take note of the VIDC20&#39;s 16-bit palette here.</span>
<span class="cm"> * The VIDC20 looks up a 16 bit pixel as follows:</span>
<span class="cm"> *</span>
<span class="cm"> *   bits   111111</span>
<span class="cm"> *          5432109876543210</span>
<span class="cm"> *   red            ++++++++  (8 bits,  7 to 0)</span>
<span class="cm"> *  green       ++++++++      (8 bits, 11 to 4)</span>
<span class="cm"> *   blue   ++++++++          (8 bits, 15 to 8)</span>
<span class="cm"> *</span>
<span class="cm"> * We use a pixel which looks like:</span>
<span class="cm"> *</span>
<span class="cm"> *   bits   111111</span>
<span class="cm"> *          5432109876543210</span>
<span class="cm"> *   red               +++++  (5 bits,  4 to  0)</span>
<span class="cm"> *  green         +++++       (5 bits,  9 to  5)</span>
<span class="cm"> *   blue    +++++            (5 bits, 14 to 10)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acornfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		  <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">palette</span> <span class="n">pal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pseudo_val</span><span class="p">;</span>

		<span class="n">pseudo_val</span>  <span class="o">=</span> <span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">pseudo_val</span> <span class="o">|=</span> <span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">pseudo_val</span> <span class="o">|=</span> <span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pseudo_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pal</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pal</span><span class="p">.</span><span class="n">vidc20</span><span class="p">.</span><span class="n">red</span>   <span class="o">=</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pal</span><span class="p">.</span><span class="n">vidc20</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pal</span><span class="p">.</span><span class="n">vidc20</span><span class="p">.</span><span class="n">blue</span>  <span class="o">=</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">current_par</span><span class="p">.</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pal</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x10000000</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pal</span><span class="p">.</span><span class="n">vidc20</span><span class="p">.</span><span class="n">red</span>   <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">palette</span><span class="p">[</span> <span class="n">i</span>       <span class="o">&amp;</span> <span class="mi">31</span><span class="p">].</span><span class="n">vidc20</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
			<span class="n">pal</span><span class="p">.</span><span class="n">vidc20</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">palette</span><span class="p">[(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">].</span><span class="n">vidc20</span><span class="p">.</span><span class="n">green</span><span class="p">;</span>
			<span class="n">pal</span><span class="p">.</span><span class="n">vidc20</span><span class="p">.</span><span class="n">blue</span>  <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">palette</span><span class="p">[(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">].</span><span class="n">vidc20</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>
			<span class="n">vidc_writel</span><span class="p">(</span><span class="n">pal</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
			<span class="cm">/* Palette register pointer auto-increments */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="mh">0x10000000</span> <span class="o">|</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">vidc_writel</span><span class="p">(</span><span class="n">pal</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Before selecting the timing parameters, adjust</span>
<span class="cm"> * the resolution to fit the rules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acornfb_adjust_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">fontht</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">font_line_len</span><span class="p">,</span> <span class="n">sam_size</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">nr_y</span><span class="p">;</span>

	<span class="cm">/* xres must be even */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t allow xres_virtual to differ from xres</span>
<span class="cm">	 */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span><span class="p">)</span>
		<span class="n">sam_size</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">vram_half_sam</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sam_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, find a value for yres_virtual which allows</span>
<span class="cm">	 * us to do ywrap scrolling.  The value of</span>
<span class="cm">	 * yres_virtual must be such that the end of the</span>
<span class="cm">	 * displayable frame buffer must be aligned with</span>
<span class="cm">	 * the start of a font line.</span>
<span class="cm">	 */</span>
	<span class="n">font_line_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">*</span> <span class="n">fontht</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">min_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If minimum screen size is greater than that we have</span>
<span class="cm">	 * available, reject it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Find int &#39;y&#39;, such that y * fll == s * sam &lt; maxsize</span>
<span class="cm">	 * y = s * sam / fll; s = maxsize / sam</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>
	     <span class="n">nr_y</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">font_line_len</span><span class="p">,</span> <span class="n">min_size</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">;</span>
	     <span class="n">size</span> <span class="o">-=</span> <span class="n">sam_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_y</span> <span class="o">*</span> <span class="n">font_line_len</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nr_y</span> <span class="o">*=</span> <span class="n">fontht</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * failed, use ypan</span>
<span class="cm">			 */</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">font_line_len</span> <span class="o">/</span> <span class="n">fontht</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">nr_y</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">nr_y</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">nr_y</span><span class="p">;</span>

	<span class="n">current_par</span><span class="p">.</span><span class="n">screen_end</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fix yres &amp; yoffset if needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hsync_len must be even */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef HAS_VIDC</span>
	<span class="cm">/* left_margin must be odd */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* right_margin must be odd */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#elif defined(HAS_VIDC20)</span>
	<span class="cm">/* left_margin must be even */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* right_margin must be even */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acornfb_validate_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">monspecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hs</span><span class="p">,</span> <span class="n">vs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * hs(Hz) = 10^12 / (pixclock * xtotal)</span>
<span class="cm">	 * vs(Hz) = hs(Hz) / ytotal</span>
<span class="cm">	 *</span>
<span class="cm">	 * No need to do long long divisions or anything</span>
<span class="cm">	 * like that if you factor it correctly</span>
<span class="cm">	 */</span>
	<span class="n">hs</span> <span class="o">=</span> <span class="mi">1953125000</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">/</span>
	     <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">);</span>
	<span class="n">vs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">/</span>
	     <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">vs</span> <span class="o">&gt;=</span> <span class="n">monspecs</span><span class="o">-&gt;</span><span class="n">vfmin</span> <span class="o">&amp;&amp;</span> <span class="n">vs</span> <span class="o">&lt;=</span> <span class="n">monspecs</span><span class="o">-&gt;</span><span class="n">vfmax</span> <span class="o">&amp;&amp;</span>
		<span class="n">hs</span> <span class="o">&gt;=</span> <span class="n">monspecs</span><span class="o">-&gt;</span><span class="n">hfmin</span> <span class="o">&amp;&amp;</span> <span class="n">hs</span> <span class="o">&lt;=</span> <span class="n">monspecs</span><span class="o">-&gt;</span><span class="n">hfmax</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">acornfb_update_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">off</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

<span class="cp">#if defined(HAS_MEMC)</span>
	<span class="n">memc_write</span><span class="p">(</span><span class="n">VDMA_INIT</span><span class="p">,</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#elif defined(HAS_IOMD)</span>
	<span class="n">iomd_writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">IOMD_VIDINIT</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acornfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">fontht</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Find the font height</span>
<span class="cm">	 */</span>
	<span class="n">fontht</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="k">case</span> <span class="mi">2</span>:	<span class="k">case</span> <span class="mi">4</span>:	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span>         <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span>          <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef HAS_VIDC20</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if the pixel rate is valid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acornfb_valid_pixrate</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate and adjust the resolution to</span>
<span class="cm">	 * match the video generator hardware.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">acornfb_adjust_timing</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">fontht</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate the timing against the</span>
<span class="cm">	 * monitor hardware.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">acornfb_validate_timing</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acornfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span> <span class="o">=</span> <span class="n">VIDC_PALETTE_SIZE</span><span class="p">;</span>
<span class="cp">#ifdef HAS_VIDC</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef HAS_VIDC20</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span> <span class="o">=</span> <span class="n">VIDC_PALETTE_SIZE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span>	<span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

<span class="cp">#if defined(HAS_MEMC)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">-</span> <span class="n">VDMA_XFERSIZE</span><span class="p">;</span>

		<span class="n">memc_write</span><span class="p">(</span><span class="n">VDMA_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memc_write</span><span class="p">(</span><span class="n">VDMA_END</span><span class="p">,</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#elif defined(HAS_IOMD)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">u_int</span> <span class="n">control</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">;</span>
		<span class="n">size</span>  <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">screen_end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">vram_half_sam</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">=</span> <span class="n">DMA_CR_E</span> <span class="o">|</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">vram_half_sam</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">=</span> <span class="n">DMA_CR_E</span> <span class="o">|</span> <span class="n">DMA_CR_D</span> <span class="o">|</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iomd_writel</span><span class="p">(</span><span class="n">start</span><span class="p">,</span>   <span class="n">IOMD_VIDSTART</span><span class="p">);</span>
		<span class="n">iomd_writel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span>    <span class="n">IOMD_VIDEND</span><span class="p">);</span>
		<span class="n">iomd_writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">IOMD_VIDCR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">acornfb_update_dma</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="n">acornfb_set_timing</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acornfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">y_bottom</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">))</span>
		<span class="n">y_bottom</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_bottom</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acornfb_update_dma</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">acornfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">acornfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">acornfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">acornfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">acornfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Everything after here is initialisation!!!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">modedb</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* 320x256 @ 50Hz */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">320</span><span class="p">,</span>  <span class="mi">256</span><span class="p">,</span> <span class="mi">125000</span><span class="p">,</span>  <span class="mi">92</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">38</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 640x250 @ 50Hz, 15.6 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">250</span><span class="p">,</span>  <span class="mi">62500</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span>  <span class="mi">38</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span>  <span class="mi">76</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 640x256 @ 50Hz, 15.6 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">256</span><span class="p">,</span>  <span class="mi">62500</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span>  <span class="mi">76</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 640x512 @ 50Hz, 26.8 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">512</span><span class="p">,</span>  <span class="mi">41667</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span>  <span class="mi">87</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">56</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 640x250 @ 70Hz, 31.5 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">250</span><span class="p">,</span>  <span class="mi">39722</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 640x256 @ 70Hz, 31.5 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">256</span><span class="p">,</span>  <span class="mi">39722</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 640x352 @ 70Hz, 31.5 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">352</span><span class="p">,</span>  <span class="mi">39722</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">58</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 640x480 @ 60Hz, 31.5 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>  <span class="mi">640</span><span class="p">,</span>  <span class="mi">480</span><span class="p">,</span>  <span class="mi">39722</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 800x600 @ 56Hz, 35.2 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span>  <span class="mi">800</span><span class="p">,</span>  <span class="mi">600</span><span class="p">,</span>  <span class="mi">27778</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 896x352 @ 60Hz, 21.8 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>  <span class="mi">896</span><span class="p">,</span>  <span class="mi">352</span><span class="p">,</span>  <span class="mi">41667</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span>  <span class="mi">27</span><span class="p">,</span>   <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 1024x 768 @ 60Hz, 48.4 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span>  <span class="mi">768</span><span class="p">,</span>  <span class="mi">15385</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* 1280x1024 @ 60Hz, 63.8 kHz hsync */</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span>   <span class="mi">9090</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span>  <span class="mi">96</span><span class="p">,</span>  <span class="mi">38</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">acornfb_default_mode</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">refresh</span> <span class="o">=</span>	<span class="mi">60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres</span> <span class="o">=</span>		<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> <span class="o">=</span>		<span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span>	<span class="mi">39722</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span>	<span class="mi">56</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span>	<span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span>	<span class="mi">34</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span>	<span class="mi">9</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span>	<span class="mi">88</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span>	<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span>	<span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">acornfb_init_fbinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">acornfb_ops</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Acorn&quot;</span><span class="p">);</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup initial parameters</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">));</span>

<span class="cp">#if defined(HAS_VIDC20)</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	   <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#elif defined(HAS_VIDC)</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	   <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span>	   <span class="o">=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span>	   <span class="o">=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>	   <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">height</span>	   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">width</span>	   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span>	   <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span>	   <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>

	<span class="n">current_par</span><span class="p">.</span><span class="n">dram_size</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span>	   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">current_par</span><span class="p">.</span><span class="n">dpms</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * setup acornfb options:</span>
<span class="cm"> *</span>
<span class="cm"> *  mon:hmin-hmax:vmin-vmax:dpms:width:height</span>
<span class="cm"> *	Set monitor parameters:</span>
<span class="cm"> *		hmin   = horizontal minimum frequency (Hz)</span>
<span class="cm"> *		hmax   = horizontal maximum frequency (Hz)	(optional)</span>
<span class="cm"> *		vmin   = vertical minimum frequency (Hz)</span>
<span class="cm"> *		vmax   = vertical maximum frequency (Hz)	(optional)</span>
<span class="cm"> *		dpms   = DPMS supported?			(optional)</span>
<span class="cm"> *		width  = width of picture in mm.		(optional)</span>
<span class="cm"> *		height = height of picture in mm.		(optional)</span>
<span class="cm"> *</span>
<span class="cm"> * montype:type</span>
<span class="cm"> *	Set RISC-OS style monitor type:</span>
<span class="cm"> *		0 (or tv)	- TV frequency</span>
<span class="cm"> *		1 (or multi)	- Multi frequency</span>
<span class="cm"> *		2 (or hires)	- Hi-res monochrome</span>
<span class="cm"> *		3 (or vga)	- VGA</span>
<span class="cm"> *		4 (or svga)	- SVGA</span>
<span class="cm"> *		auto, or option missing</span>
<span class="cm"> *				- try hardware detect</span>
<span class="cm"> *</span>
<span class="cm"> * dram:size</span>
<span class="cm"> *	Set the amount of DRAM to use for the frame buffer</span>
<span class="cm"> *	(even if you have VRAM).</span>
<span class="cm"> *	size can optionally be followed by &#39;M&#39; or &#39;K&#39; for</span>
<span class="cm"> *	MB or KB respectively.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">acornfb_parse_mon</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>

	<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">check_values</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">check_values</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">check_values</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">check_values:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">&lt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">||</span>
	    <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&lt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Acornfb: bad monitor settings: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
	<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">acornfb_parse_montype</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;tv&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;multi&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;hires&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;vga&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;svga&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">opt</span><span class="p">))</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span> <span class="o">||</span>
	    <span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">&gt;</span> <span class="n">NR_MONTYPES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;acornfb: unknown monitor type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">opt</span><span class="p">);</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;,dpms&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">current_par</span><span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;acornfb: unknown monitor option: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">opt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">acornfb_parse_dram</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="n">size</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
			<span class="n">size</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">current_par</span><span class="p">.</span><span class="n">dram_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">options</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">parse</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">);</span>
<span class="p">}</span> <span class="n">opt_table</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;mon&quot;</span><span class="p">,</span>     <span class="n">acornfb_parse_mon</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;montype&quot;</span><span class="p">,</span> <span class="n">acornfb_parse_montype</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dram&quot;</span><span class="p">,</span>    <span class="n">acornfb_parse_dram</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">acornfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">options</span> <span class="o">*</span><span class="n">optp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">acornfb_init_fbinfo</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">optp</span> <span class="o">=</span> <span class="n">opt_table</span><span class="p">;</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">optp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">optlen</span><span class="p">;</span>

			<span class="n">optlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">optlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">opt</span><span class="p">[</span><span class="n">optlen</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">optp</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="n">optlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;acornfb: unknown parameter: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">opt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Detect type of monitor connected</span>
<span class="cm"> *  For now, we just assume SVGA</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">acornfb_detect_monitortype</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This enables the unused memory to be freed on older Acorn machines.</span>
<span class="cm"> * We are freeing memory on behalf of the architecture initialisation</span>
<span class="cm"> * code here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">free_unused_pages</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virtual_start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virtual_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mb_freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Align addresses</span>
<span class="cm">	 */</span>
	<span class="n">virtual_start</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">virtual_start</span><span class="p">);</span>
	<span class="n">virtual_end</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">virtual_end</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">virtual_start</span> <span class="o">&lt;</span> <span class="n">virtual_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear page reserved bit,</span>
<span class="cm">		 * set count to 1, and free</span>
<span class="cm">		 * the page.</span>
<span class="cm">		 */</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">virtual_start</span><span class="p">);</span>
		<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">init_page_count</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">virtual_start</span><span class="p">);</span>

		<span class="n">virtual_start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">mb_freed</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;acornfb: freed %dK memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb_freed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">acornfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">h_sync</span><span class="p">,</span> <span class="n">v_sync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;acornfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">acornfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>

	<span class="n">acornfb_init_fbinfo</span><span class="p">();</span>

	<span class="n">current_par</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="n">acornfb_detect_monitortype</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">&gt;</span> <span class="n">NR_MONTYPES</span><span class="p">)</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">montype</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span> <span class="o">=</span> <span class="n">monspecs</span><span class="p">[</span><span class="n">current_par</span><span class="p">.</span><span class="n">montype</span><span class="p">];</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">dpms</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to select a suitable default mode</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">modedb</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hs</span><span class="p">;</span>

		<span class="n">hs</span> <span class="o">=</span> <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span> <span class="o">*</span>
		     <span class="p">(</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span> <span class="o">+</span> <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">upper_margin</span> <span class="o">+</span>
		      <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vsync_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span> <span class="o">==</span> <span class="n">DEFAULT_XRES</span> <span class="o">&amp;&amp;</span>
		    <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span> <span class="o">==</span> <span class="n">DEFAULT_YRES</span> <span class="o">&amp;&amp;</span>
		    <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span> <span class="o">&gt;=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">&amp;&amp;</span>
		    <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span> <span class="o">&lt;=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hs</span>                <span class="o">&gt;=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hs</span>                <span class="o">&lt;=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acornfb_default_mode</span> <span class="o">=</span> <span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">screen_base</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">SCREEN_BASE</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">SCREEN_START</span><span class="p">;</span>
	<span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If vram_size is set, we are using VRAM in</span>
<span class="cm">	 * a Risc PC.  However, if the user has specified</span>
<span class="cm">	 * an amount of DRAM then use that instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vram_size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_par</span><span class="p">.</span><span class="n">dram_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">vram_size</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">vram_half_sam</span> <span class="o">=</span> <span class="n">vram_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">dram_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">dram_size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">MAX_SIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Limit maximum screen size.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_SIZE</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">MAX_SIZE</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

<span class="cp">#if defined(HAS_VIDC20)</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">handle</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * RiscPC needs to allocate the DRAM memory</span>
<span class="cm">		 * for the framebuffer if we are not using</span>
<span class="cm">		 * VRAM.</span>
<span class="cm">		 */</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">dma_alloc_writecombine</span><span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;acornfb: unable to allocate screen &quot;</span>
			       <span class="s">&quot;memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fb_info</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(HAS_VIDC)</span>
	<span class="cm">/*</span>
<span class="cm">	 * Archimedes/A5000 machines use a fixed address for their</span>
<span class="cm">	 * framebuffers.  Free unused pages</span>
<span class="cm">	 */</span>
	<span class="n">free_unused_pages</span><span class="p">(</span><span class="n">PAGE_OFFSET</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">PAGE_OFFSET</span> <span class="o">+</span> <span class="n">MAX_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">current_par</span><span class="p">.</span><span class="n">palette_size</span>   <span class="o">=</span> <span class="n">VIDC_PALETTE_SIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lookup the timing for this resolution.  If we can&#39;t</span>
<span class="cm">	 * find it, then we can&#39;t restore it if we change</span>
<span class="cm">	 * the resolution, so we disable this feature.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">modedb</span><span class="p">,</span>
				 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">modedb</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">acornfb_default_mode</span><span class="p">,</span> <span class="n">DEFAULT_BPP</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we found an exact match, all ok.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">acornfb_default_mode</span><span class="p">,</span> <span class="n">DEFAULT_BPP</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we found an exact match, all ok.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">modedb</span><span class="p">,</span>
				 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">modedb</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">acornfb_default_mode</span><span class="p">,</span> <span class="n">DEFAULT_BPP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">acornfb_default_mode</span><span class="p">,</span> <span class="n">DEFAULT_BPP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we didn&#39;t find an exact match, try the</span>
<span class="cm">	 * generic database.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Acornfb: no valid mode found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_sync</span> <span class="o">=</span> <span class="mi">1953125000</span> <span class="o">/</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="n">h_sync</span> <span class="o">=</span> <span class="n">h_sync</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">/</span> <span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">+</span>
		 <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">);</span>
	<span class="n">v_sync</span> <span class="o">=</span> <span class="n">h_sync</span> <span class="o">/</span> <span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">+</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">+</span>
		 <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Acornfb: %dkB %cRAM, %s, using %dx%d, &quot;</span>
		<span class="s">&quot;%d.%03dkHz, %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="n">current_par</span><span class="p">.</span><span class="n">using_vram</span> <span class="o">?</span> <span class="sc">&#39;V&#39;</span> <span class="o">:</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>
		<span class="n">VIDC_NAME</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
		<span class="n">h_sync</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">h_sync</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">v_sync</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Acornfb: Monitor: %d.%03d-%d.%03dkHz, %d-%dHz%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">,</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dpms</span> <span class="o">?</span> <span class="s">&quot;, DPMS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_set_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Acornfb: unable to set display parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">acornfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">acornfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;acornfb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acornfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acornfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">acornfb_init</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Russell King&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VIDC 1/1a/20 framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
