<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › tgafb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tgafb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/tgafb.c -- DEC 21030 TGA frame buffer device</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1995 Jay Estabrook</span>
<span class="cm"> *	Copyright (C) 1997 Geert Uytterhoeven</span>
<span class="cm"> *	Copyright (C) 1999,2000 Martin Lucina, Tom Zerucha</span>
<span class="cm"> *	Copyright (C) 2002 Richard Henderson</span>
<span class="cm"> *	Copyright (C) 2006, 2007  Maciej W. Rozycki</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bitrev.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/selection.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/tc.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;video/tgafb.h&gt;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#define TGA_BUS_PCI(dev) (dev-&gt;bus == &amp;pci_bus_type)</span>
<span class="cp">#else</span>
<span class="cp">#define TGA_BUS_PCI(dev) 0</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TC</span>
<span class="cp">#define TGA_BUS_TC(dev) (dev-&gt;bus == &amp;tc_bus_type)</span>
<span class="cp">#else</span>
<span class="cp">#define TGA_BUS_TC(dev) 0</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Local functions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tgafb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tgafb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tgafb_set_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tgafb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span>
			   <span class="kt">unsigned</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tgafb_blank</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tgafb_init_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tgafb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tgafb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tgafb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tgafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">tgafb_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">tgafb_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option_pci</span> <span class="o">=</span> <span class="s">&quot;640x480@60&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option_tc</span> <span class="o">=</span> <span class="s">&quot;1280x1024@72&quot;</span><span class="p">;</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tgafb_pci_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tc_driver</span> <span class="n">tgafb_tc_driver</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  Frame buffer operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">tgafb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>		<span class="o">=</span> <span class="n">tgafb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>		<span class="o">=</span> <span class="n">tgafb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>		<span class="o">=</span> <span class="n">tgafb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>		<span class="o">=</span> <span class="n">tgafb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>		<span class="o">=</span> <span class="n">tgafb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>		<span class="o">=</span> <span class="n">tgafb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>		<span class="o">=</span> <span class="n">tgafb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>		<span class="o">=</span> <span class="n">tgafb_imageblit</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cm">/*</span>
<span class="cm"> *  PCI registration operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">tgafb_pci_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">tgafb_pci_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="k">const</span> <span class="n">tgafb_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_DEC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DEC_TGA</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tgafb_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tgafb_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;tgafb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">tgafb_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">tgafb_pci_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>			<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tgafb_pci_unregister</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">tgafb_pci_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tgafb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">tgafb_pci_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tgafb_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_TC</span>
<span class="cm">/*</span>
<span class="cm"> *  TC registration operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">tgafb_tc_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="n">tgafb_tc_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tc_device_id</span> <span class="k">const</span> <span class="n">tgafb_tc_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;DEC     &quot;</span><span class="p">,</span> <span class="s">&quot;PMAGD-AA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DEC     &quot;</span><span class="p">,</span> <span class="s">&quot;PMAGD   &quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="n">tgafb_tc_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tc_driver</span> <span class="n">tgafb_tc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">tgafb_tc_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>			<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;tgafb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tc_bus_type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tgafb_tc_register</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tgafb_tc_unregister</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">tgafb_tc_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">tgafb_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span>
<span class="nf">tgafb_tc_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tgafb_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_TC */</span><span class="cp"></span>


<span class="cm">/**</span>
<span class="cm"> *      tgafb_check_var - Optional function.  Validates a var passed in.</span>
<span class="cm"> *      @var: frame buffer variable screen structure</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tgafb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1000000000</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&gt;</span> <span class="n">TGA_PLL_MAX_FREQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Some of the acceleration routines assume the line width is</span>
<span class="cm">	   a multiple of 64 bytes.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      tgafb_set_par - Optional function.  Alters the hardware state.</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tgafb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">deep_presets</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00004000</span><span class="p">,</span>
		<span class="mh">0x0000440d</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="mh">0x0000441d</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">rasterop_presets</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00000003</span><span class="p">,</span>
		<span class="mh">0x00000303</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="mh">0x00000303</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">mode_presets</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
		<span class="mh">0x00000300</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="mh">0x00000300</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">base_addr_presets</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
		<span class="mh">0x00000001</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="mh">0x00000001</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tga_bus_pci</span> <span class="o">=</span> <span class="n">TGA_BUS_PCI</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tga_bus_tc</span> <span class="o">=</span> <span class="n">TGA_BUS_TC</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">htimings</span><span class="p">,</span> <span class="n">vtimings</span><span class="p">,</span> <span class="n">pll_freq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tga_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Encode video timings.  */</span>
	<span class="n">htimings</span> <span class="o">=</span> <span class="p">(((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_HORIZ_ACT_LSB</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x600</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_HORIZ_ACT_MSB</span><span class="p">));</span>
	<span class="n">vtimings</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&amp;</span> <span class="n">TGA_VERT_ACTIVE</span><span class="p">);</span>
	<span class="n">htimings</span> <span class="o">|=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_HORIZ_FP</span><span class="p">;</span>
	<span class="n">vtimings</span> <span class="o">|=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_VERT_FP</span><span class="p">;</span>
	<span class="n">htimings</span> <span class="o">|=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_HORIZ_SYNC</span><span class="p">;</span>
	<span class="n">vtimings</span> <span class="o">|=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_VERT_SYNC</span><span class="p">;</span>
	<span class="n">htimings</span> <span class="o">|=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_HORIZ_BP</span><span class="p">;</span>
	<span class="n">vtimings</span> <span class="o">|=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TGA_VERT_BP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">htimings</span> <span class="o">|=</span> <span class="n">TGA_HORIZ_POLARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">vtimings</span> <span class="o">|=</span> <span class="n">TGA_VERT_POLARITY</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">htimings</span> <span class="o">=</span> <span class="n">htimings</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vtimings</span> <span class="o">=</span> <span class="n">vtimings</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">sync_on_green</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_ON_GREEN</span><span class="p">);</span>

	<span class="cm">/* Store other useful values in par.  */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pll_freq</span> <span class="o">=</span> <span class="n">pll_freq</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">tga_type</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_type</span><span class="p">;</span>

	<span class="cm">/* First, disable video.  */</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_VALID_VIDEO</span> <span class="o">|</span> <span class="n">TGA_VALID_BLANK</span><span class="p">,</span> <span class="n">TGA_VALID_REG</span><span class="p">);</span>

	<span class="cm">/* Write the DEEP register.  */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_CMD_STAT_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* wait for not busy */</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">deep_presets</span><span class="p">[</span><span class="n">tga_type</span><span class="p">]</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">sync_on_green</span> <span class="o">?</span> <span class="mh">0x0</span> <span class="o">:</span> <span class="mh">0x00010000</span><span class="p">),</span>
		      <span class="n">TGA_DEEP_REG</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_CMD_STAT_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* wait for not busy */</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Write some more registers.  */</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">rasterop_presets</span><span class="p">[</span><span class="n">tga_type</span><span class="p">],</span> <span class="n">TGA_RASTEROP_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">mode_presets</span><span class="p">[</span><span class="n">tga_type</span><span class="p">],</span> <span class="n">TGA_MODE_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">base_addr_presets</span><span class="p">[</span><span class="n">tga_type</span><span class="p">],</span> <span class="n">TGA_BASE_ADDR_REG</span><span class="p">);</span>

	<span class="cm">/* Calculate &amp; write the PLL.  */</span>
	<span class="n">tgafb_set_pll</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pll_freq</span><span class="p">);</span>

	<span class="cm">/* Write some more registers.  */</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">TGA_PLANEMASK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>

	<span class="cm">/* Init video timing regs.  */</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">htimings</span><span class="p">,</span> <span class="n">TGA_HORIZ_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vtimings</span><span class="p">,</span> <span class="n">TGA_VERT_REG</span><span class="p">);</span>

	<span class="cm">/* Initialise RAMDAC. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span> <span class="o">&amp;&amp;</span> <span class="n">tga_bus_pci</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Init BT485 RAMDAC registers.  */</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0xa2</span> <span class="o">|</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">sync_on_green</span> <span class="o">?</span> <span class="mh">0x8</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">),</span>
			    <span class="n">BT485_CMD_0</span><span class="p">);</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">BT485_ADDR_PAL_WRITE</span><span class="p">);</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">BT485_CMD_3</span><span class="p">);</span> <span class="cm">/* cursor 64x64 */</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">BT485_CMD_1</span><span class="p">);</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">BT485_CMD_2</span><span class="p">);</span> <span class="cm">/* cursor off, for now */</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">BT485_PIXEL_MASK</span><span class="p">);</span>

		<span class="cm">/* Fill palette registers.  */</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">BT485_ADDR_PAL_WRITE</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT485_DATA_PAL</span><span class="p">,</span> <span class="n">TGA_RAMDAC_SETUP_REG</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x55</span> <span class="o">|</span> <span class="p">(</span><span class="n">BT485_DATA_PAL</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				      <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="p">(</span><span class="n">BT485_DATA_PAL</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				      <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="p">(</span><span class="n">BT485_DATA_PAL</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				      <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="p">(</span><span class="n">BT485_DATA_PAL</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				      <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span> <span class="o">&amp;&amp;</span> <span class="n">tga_bus_tc</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Init BT459 RAMDAC registers.  */</span>
		<span class="n">BT459_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT459_REG_ACC</span><span class="p">,</span> <span class="n">BT459_CMD_REG_0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">BT459_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT459_REG_ACC</span><span class="p">,</span> <span class="n">BT459_CMD_REG_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">BT459_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT459_REG_ACC</span><span class="p">,</span> <span class="n">BT459_CMD_REG_2</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">sync_on_green</span> <span class="o">?</span> <span class="mh">0xc0</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">));</span>

		<span class="n">BT459_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT459_REG_ACC</span><span class="p">,</span> <span class="n">BT459_CUR_CMD_REG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* Fill the palette.  */</span>
		<span class="n">BT459_LOAD_ADDR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT459_PALETTE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TGA_RAMDAC_SETUP_REG</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* 24-plane or 24plusZ */</span>

		<span class="cm">/* Init BT463 RAMDAC registers.  */</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_CMD_REG_0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_CMD_REG_1</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_CMD_REG_2</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">sync_on_green</span> <span class="o">?</span> <span class="mh">0xc0</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">));</span>

		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_READ_MASK_0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_READ_MASK_1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_READ_MASK_2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_READ_MASK_3</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>

		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_BLINK_MASK_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_BLINK_MASK_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_BLINK_MASK_2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">BT463_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span><span class="p">,</span> <span class="n">BT463_BLINK_MASK_3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* Fill the palette.  */</span>
		<span class="n">BT463_LOAD_ADDR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_PALETTE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TGA_RAMDAC_SETUP_REG</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HW_CONSOLE</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">default_red</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">default_grn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">default_blu</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">528</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Fill window type table after start of vertical retrace.  */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_INTR_STAT_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TGA_INTR_STAT_REG</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_INTR_STAT_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TGA_INTR_STAT_REG</span><span class="p">);</span>

		<span class="n">BT463_LOAD_ADDR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_WINDOW_TYPE_BASE</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_REG_ACC</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TGA_RAMDAC_SETUP_REG</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Finally, enable video scan (and pray for the monitor... :-) */</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_VALID_VIDEO</span><span class="p">,</span> <span class="n">TGA_VALID_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DIFFCHECK(X)							  \</span>
<span class="cp">do {									  \</span>
<span class="cp">	if (m &lt;= 0x3f) {						  \</span>
<span class="cp">		int delta = f - (TGA_PLL_BASE_FREQ * (X)) / (r &lt;&lt; shift); \</span>
<span class="cp">		if (delta &lt; 0)						  \</span>
<span class="cp">			delta = -delta;					  \</span>
<span class="cp">		if (delta &lt; min_diff)					  \</span>
<span class="cp">			min_diff = delta, vm = m, va = a, vr = r;	  \</span>
<span class="cp">	}								  \</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">tgafb_set_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">min_diff</span><span class="p">,</span> <span class="n">target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">vm</span> <span class="o">=</span> <span class="mi">34</span><span class="p">,</span> <span class="n">va</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">!</span><span class="n">r</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;</span> <span class="n">TGA_PLL_MAX_FREQ</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">TGA_PLL_MAX_FREQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="n">TGA_PLL_MAX_FREQ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="n">TGA_PLL_MAX_FREQ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">shift</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">shift</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="mi">120000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>

	<span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="n">TGA_PLL_BASE_FREQ</span><span class="p">;</span>
	<span class="n">min_diff</span> <span class="o">=</span> <span class="n">TGA_PLL_MAX_FREQ</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">/</span> <span class="n">target</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">target</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="mi">449</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="n">base</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">base</span> <span class="o">+</span> <span class="n">target</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">449</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DIFFCHECK</span><span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="n">DIFFCHECK</span><span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">6</span><span class="p">))</span>
				<span class="n">DIFFCHECK</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r</span><span class="o">++</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">+=</span> <span class="n">target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vr</span><span class="o">--</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="p">(</span><span class="n">vm</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="p">(</span><span class="n">va</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="p">(</span><span class="n">vr</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
	<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="p">((</span><span class="n">vr</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="mi">2</span><span class="p">,</span> <span class="n">TGA_CLOCK_REG</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *      tgafb_setcolreg - Optional function. Sets a color register.</span>
<span class="cm"> *      @regno: boolean, 0 copy local, 1 get_user() function</span>
<span class="cm"> *      @red: frame buffer colormap structure</span>
<span class="cm"> *      @green: The green value which can be up to 16 bits wide</span>
<span class="cm"> *      @blue:  The blue value which can be up to 16 bits wide.</span>
<span class="cm"> *      @transp: If supported the alpha value which can be up to 16 bits wide.</span>
<span class="cm"> *      @info: frame buffer info structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="n">tgafb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tga_bus_pci</span> <span class="o">=</span> <span class="n">TGA_BUS_PCI</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tga_bus_tc</span> <span class="o">=</span> <span class="n">TGA_BUS_TC</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span> <span class="o">&amp;&amp;</span> <span class="n">tga_bus_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT485_WRITE</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">BT485_ADDR_PAL_WRITE</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT485_DATA_PAL</span><span class="p">,</span> <span class="n">TGA_RAMDAC_SETUP_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">red</span><span class="o">|</span><span class="p">(</span><span class="n">BT485_DATA_PAL</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">),</span><span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">green</span><span class="o">|</span><span class="p">(</span><span class="n">BT485_DATA_PAL</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">),</span><span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">blue</span><span class="o">|</span><span class="p">(</span><span class="n">BT485_DATA_PAL</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">),</span><span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span> <span class="o">&amp;&amp;</span> <span class="n">tga_bus_tc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BT459_LOAD_ADDR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT459_PALETTE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TGA_RAMDAC_SETUP_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">regno</span><span class="p">;</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BT463_LOAD_ADDR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">BT463_PALETTE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TGA_RAMDAC_SETUP_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">TGA_RAMDAC_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *      tgafb_blank - Optional function.  Blanks the display.</span>
<span class="cm"> *      @blank_mode: the blank mode we want.</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="n">tgafb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vhcr</span><span class="p">,</span> <span class="n">vvcr</span><span class="p">,</span> <span class="n">vvvr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">vhcr</span> <span class="o">=</span> <span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_HORIZ_REG</span><span class="p">);</span>
	<span class="n">vvcr</span> <span class="o">=</span> <span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_VERT_REG</span><span class="p">);</span>
	<span class="n">vvvr</span> <span class="o">=</span> <span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_VALID_REG</span><span class="p">);</span>
	<span class="n">vvvr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TGA_VALID_VIDEO</span> <span class="o">|</span> <span class="n">TGA_VALID_BLANK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>: <span class="cm">/* Unblanking */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vhcr</span> <span class="o">&amp;</span> <span class="mh">0xbfffffff</span><span class="p">,</span> <span class="n">TGA_HORIZ_REG</span><span class="p">);</span>
			<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvcr</span> <span class="o">&amp;</span> <span class="mh">0xbfffffff</span><span class="p">,</span> <span class="n">TGA_VERT_REG</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvvr</span> <span class="o">|</span> <span class="n">TGA_VALID_VIDEO</span><span class="p">,</span> <span class="n">TGA_VALID_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>: <span class="cm">/* Normal blanking */</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvvr</span> <span class="o">|</span> <span class="n">TGA_VALID_VIDEO</span> <span class="o">|</span> <span class="n">TGA_VALID_BLANK</span><span class="p">,</span>
			      <span class="n">TGA_VALID_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>: <span class="cm">/* VESA blank (vsync off) */</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvcr</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="n">TGA_VERT_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvvr</span> <span class="o">|</span> <span class="n">TGA_VALID_BLANK</span><span class="p">,</span> <span class="n">TGA_VALID_REG</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>: <span class="cm">/* VESA blank (hsync off) */</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vhcr</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="n">TGA_HORIZ_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvvr</span> <span class="o">|</span> <span class="n">TGA_VALID_BLANK</span><span class="p">,</span> <span class="n">TGA_VALID_REG</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>: <span class="cm">/* Poweroff */</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vhcr</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="n">TGA_HORIZ_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvcr</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="n">TGA_VERT_REG</span><span class="p">);</span>
		<span class="n">TGA_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vvvr</span> <span class="o">|</span> <span class="n">TGA_VALID_BLANK</span><span class="p">,</span> <span class="n">TGA_VALID_REG</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vesa_blanked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Acceleration.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">tgafb_mono_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fgcolor</span><span class="p">,</span> <span class="n">bgcolor</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">,</span> <span class="n">pixelmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rincr</span><span class="p">,</span> <span class="n">line_length</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">is8bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fb_base</span><span class="p">;</span>

	<span class="n">is8bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">dx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="n">rincr</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* A shift below cannot cope with.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Crop the image to the screen.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">dy</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="n">regs_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="n">fb_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>

	<span class="cm">/* Expand the color values to fill 32-bits.  */</span>
	<span class="cm">/* ??? Would be nice to notice colour changes elsewhere, so</span>
<span class="cm">	   that we can do this only when necessary.  */</span>
	<span class="n">fgcolor</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">;</span>
	<span class="n">bgcolor</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is8bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fgcolor</span> <span class="o">|=</span> <span class="n">fgcolor</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">fgcolor</span> <span class="o">|=</span> <span class="n">fgcolor</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">bgcolor</span> <span class="o">|=</span> <span class="n">bgcolor</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bgcolor</span> <span class="o">|=</span> <span class="n">bgcolor</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fgcolor</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">fgcolor</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">fgcolor</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bgcolor</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">bgcolor</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">bgcolor</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">fgcolor</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_FOREGROUND_REG</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bgcolor</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BACKGROUND_REG</span><span class="p">);</span>

	<span class="cm">/* Acquire proper alignment; set up the PIXELMASK register</span>
<span class="cm">	   so that we only write the proper character cell.  */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is8bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">dx</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">&amp;=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">&amp;=</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Enable opaque stipple mode.  */</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">is8bpp</span>
		      <span class="o">?</span> <span class="n">TGA_MODE_SBM_8BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_OPAQUE_STIPPLE</span>
		      <span class="o">:</span> <span class="n">TGA_MODE_SBM_24BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_OPAQUE_STIPPLE</span><span class="p">),</span>
		     <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_MODE_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">shift</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bwidth</span><span class="p">;</span>

		<span class="cm">/* Handle common case of imaging a single character, in</span>
<span class="cm">		   a font less than or 32 pixels wide.  */</span>

		<span class="cm">/* Avoid a shift by 32; width &gt; 0 implied.  */</span>
		<span class="n">pixelmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2ul</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pixelmask</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">pixelmask</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">bwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* The image data is bit big endian; we need</span>
<span class="cm">			   little endian.  */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bwidth</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>

			<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">rincr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos0</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data0</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bincr</span> <span class="o">=</span> <span class="p">(</span><span class="n">is8bpp</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bwidth</span><span class="p">;</span>

		<span class="cm">/* Handle another common case in which accel_putcs</span>
<span class="cm">		   generates a large bitmap, which happens to be aligned.</span>
<span class="cm">		   Allow the tail to be misaligned.  This case is </span>
<span class="cm">		   interesting because we&#39;ve not got to hold partial</span>
<span class="cm">		   bytes across the words being written.  */</span>

		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">bwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bwidth</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">bincr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">rincr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">pixelmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixelmask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">pixelmask</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>

			<span class="n">pos</span> <span class="o">=</span> <span class="n">pos0</span> <span class="o">+</span> <span class="n">bwidth</span><span class="o">*</span><span class="n">bincr</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data0</span> <span class="o">+</span> <span class="n">bwidth</span><span class="p">;</span>
			<span class="n">bwidth</span> <span class="o">=</span> <span class="p">((</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bwidth</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
					<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
				<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">+=</span> <span class="n">rincr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos0</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data0</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bincr</span> <span class="o">=</span> <span class="p">(</span><span class="n">is8bpp</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bwidth</span><span class="p">;</span>

		<span class="cm">/* Finally, handle the generic case of misaligned start.</span>
<span class="cm">		   Here we split the write into 16-bit spans.  This allows</span>
<span class="cm">		   us to use only one pixel mask, instead of four as would</span>
<span class="cm">		   be required by writing 24-bit spans.  */</span>

		<span class="n">pixelmask</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">pixelmask</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">bwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bwidth</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">bincr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">rincr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">pixelmask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixelmask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">pixelmask</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>

			<span class="n">pos</span> <span class="o">=</span> <span class="n">pos0</span> <span class="o">+</span> <span class="n">bwidth</span><span class="o">*</span><span class="n">bincr</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data0</span> <span class="o">+</span> <span class="n">bwidth</span><span class="p">;</span>
			<span class="n">bwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bwidth</span><span class="p">)</span>
					<span class="n">mask</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
				<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">+=</span> <span class="n">rincr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_PIXELMASK_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable opaque stipple mode.  */</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">is8bpp</span>
		      <span class="o">?</span> <span class="n">TGA_MODE_SBM_8BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_SIMPLE</span>
		      <span class="o">:</span> <span class="n">TGA_MODE_SBM_24BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_SIMPLE</span><span class="p">),</span>
		     <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_MODE_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">tgafb_clut_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">color</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">palette</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos</span><span class="p">,</span> <span class="n">line_length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs_base</span><span class="p">,</span> <span class="o">*</span><span class="n">fb_base</span><span class="p">;</span>

	<span class="n">dx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

	<span class="cm">/* Crop the image to the screen.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">dy</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="n">regs_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="n">fb_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Now copy the image, color_expanding via the palette. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">];</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      tgafb_imageblit - REQUIRED function. Can use generic routines if</span>
<span class="cm"> *                        non acclerated hardware and packed pixel based.</span>
<span class="cm"> *                        Copies a image from system memory to the screen.</span>
<span class="cm"> *</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *      @image: structure defining the image.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">tgafb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is8bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* If a mono image, regardless of FB depth, go do it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tgafb_mono_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For copies that aren&#39;t pixel expansion, there&#39;s little we</span>
<span class="cm">	   can do better than the generic code.  */</span>
	<span class="cm">/* ??? There is a DMA write mode; I wonder if that could be</span>
<span class="cm">	   made to pull the data from the image buffer...  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If 24-plane FB and the image is 8-plane with CLUT, we can do it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is8bpp</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tgafb_clut_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Silently return... */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      tgafb_fillrect - REQUIRED function. Can use generic routines if </span>
<span class="cm"> *                       non acclerated hardware and packed pixel based.</span>
<span class="cm"> *                       Draws a rectangle on the screen.               </span>
<span class="cm"> *</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *      @rect: structure defining the rectagle and operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">tgafb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is8bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">,</span> <span class="n">color</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">line_length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fb_base</span><span class="p">;</span>

	<span class="n">dx</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="n">regs_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="n">fb_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>

	<span class="cm">/* Crop the rectangle to the screen.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">dy</span> <span class="o">&gt;</span> <span class="n">vyres</span> <span class="o">||</span> <span class="o">!</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">is8bpp</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* ??? We could implement ROP_XOR with opaque fill mode</span>
<span class="cm">	   and a RasterOp setting of GXxor, but as far as I can</span>
<span class="cm">	   tell, this mode is not actually used in the kernel.</span>
<span class="cm">	   Thus I am ignoring it for now.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">!=</span> <span class="n">ROP_COPY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Expand the color value to fill 8 pixels.  */</span>
	<span class="n">color</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is8bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">color</span> <span class="o">|=</span> <span class="n">color</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">color</span> <span class="o">|=</span> <span class="n">color</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR0_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR1_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">color</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">color</span><span class="p">];</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR0_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR1_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR2_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR3_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR4_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR5_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR6_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_BLOCK_COLOR7_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The DATA register holds the fill mask for block fill mode.</span>
<span class="cm">	   Since we&#39;re not stippling, this is all ones.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_DATA_REG</span><span class="p">);</span>

	<span class="cm">/* Enable block fill mode.  */</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">is8bpp</span>
		      <span class="o">?</span> <span class="n">TGA_MODE_SBM_8BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_BLOCK_FILL</span>
		      <span class="o">:</span> <span class="n">TGA_MODE_SBM_24BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_BLOCK_FILL</span><span class="p">),</span>
		     <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_MODE_REG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* We can fill 2k pixels per operation.  Notice blocks that fit</span>
<span class="cm">	   the width of the screen so that we can take advantage of this</span>
<span class="cm">	   and fill more than one line per write.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">line_length</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">*=</span> <span class="n">height</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* The write into the frame buffer must be aligned to 4 bytes,</span>
<span class="cm">	   but we are allowed to encode the offset within the word in</span>
<span class="cm">	   the data word written.  */</span>
	<span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">&amp;=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">align</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">is8bpp</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">2048</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">fdata</span><span class="p">,</span> <span class="n">ldata</span><span class="p">;</span>

		<span class="n">fdata</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2048</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">align</span><span class="p">;</span>
		<span class="n">ldata</span> <span class="o">=</span> <span class="p">((</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mi">2047</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">align</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nwidth</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2048</span><span class="p">)</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">Bpp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">)</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">ldata</span><span class="p">,</span> <span class="n">fb_base</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">Bpp</span><span class="p">);</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">line_length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Disable block fill mode.  */</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">is8bpp</span>
		      <span class="o">?</span> <span class="n">TGA_MODE_SBM_8BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_SIMPLE</span>
		      <span class="o">:</span> <span class="n">TGA_MODE_SBM_24BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_SIMPLE</span><span class="p">),</span>
		     <span class="n">regs_base</span> <span class="o">+</span> <span class="n">TGA_MODE_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      tgafb_copyarea - REQUIRED function. Can use generic routines if</span>
<span class="cm"> *                       non acclerated hardware and packed pixel based.</span>
<span class="cm"> *                       Copies on area of the screen to another area.</span>
<span class="cm"> *</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *      @area: structure defining the source and destination.</span>
<span class="cm"> */</span>

<span class="cm">/* Handle the special case of copying entire lines, e.g. during scrolling.</span>
<span class="cm">   We can avoid a lot of needless computation in this case.  In the 8bpp</span>
<span class="cm">   case we need to use the COPY64 registers instead of mask writes into </span>
<span class="cm">   the frame buffer to achieve maximum performance.  */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="n">copyarea_line_8bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sy</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">height</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tga_regs</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dpos</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n64</span><span class="p">;</span>

	<span class="cm">/* Set up the MODE and PIXELSHIFT registers.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_8BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_COPY</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_PIXELSHIFT_REG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">n64</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sy</span> <span class="o">&lt;</span> <span class="n">dy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spos</span> <span class="o">=</span> <span class="p">(</span><span class="n">sy</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">dpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n64</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spos</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">dpos</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">spos</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_COPY64_SRC</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">dpos</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_COPY64_DST</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spos</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">dpos</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n64</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">spos</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_COPY64_SRC</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">dpos</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_COPY64_DST</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">spos</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">dpos</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the MODE register to normal.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_8BPP</span><span class="o">|</span><span class="n">TGA_MODE_SIMPLE</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="n">copyarea_line_32bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sy</span><span class="p">,</span>
		    <span class="n">u32</span> <span class="n">height</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tga_regs</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tga_fb</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">n16</span><span class="p">;</span>

	<span class="cm">/* Set up the MODE and PIXELSHIFT registers.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_24BPP</span> <span class="o">|</span> <span class="n">TGA_MODE_COPY</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_PIXELSHIFT_REG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">n16</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sy</span> <span class="o">&lt;</span> <span class="n">dy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="p">(</span><span class="n">sy</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">src</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">src</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the MODE register to normal.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_24BPP</span><span class="o">|</span><span class="n">TGA_MODE_SIMPLE</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The general case of forward copy in 8bpp mode.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="n">copyarea_foreward_8bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sy</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">height</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">line_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">copied</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dpos</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">dalign</span><span class="p">,</span> <span class="n">salign</span><span class="p">,</span> <span class="n">yincr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">smask_first</span><span class="p">,</span> <span class="n">dmask_first</span><span class="p">,</span> <span class="n">dmask_last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixel_shift</span><span class="p">,</span> <span class="n">need_prime</span><span class="p">,</span> <span class="n">need_second</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n64</span><span class="p">,</span> <span class="n">n32</span><span class="p">,</span> <span class="n">xincr_first</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tga_regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tga_fb</span><span class="p">;</span>

	<span class="n">yincr</span> <span class="o">=</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">sy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dy</span> <span class="o">+=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sy</span> <span class="o">+=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">yincr</span> <span class="o">=</span> <span class="o">-</span><span class="n">yincr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Compute the offsets and alignments in the frame buffer.</span>
<span class="cm">	   More than anything else, these control how we do copies.  */</span>
	<span class="n">dpos</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">spos</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">sx</span><span class="p">;</span>
	<span class="n">dalign</span> <span class="o">=</span> <span class="n">dpos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">salign</span> <span class="o">=</span> <span class="n">spos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">dpos</span> <span class="o">&amp;=</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">spos</span> <span class="o">&amp;=</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Compute the value for the PIXELSHIFT register.  This controls</span>
<span class="cm">	   both non-co-aligned source and destination and copy direction.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dalign</span> <span class="o">&gt;=</span> <span class="n">salign</span><span class="p">)</span>
		<span class="n">pixel_shift</span> <span class="o">=</span> <span class="n">dalign</span> <span class="o">-</span> <span class="n">salign</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pixel_shift</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="n">salign</span> <span class="o">-</span> <span class="n">dalign</span><span class="p">);</span>

	<span class="cm">/* Figure out if we need an additional priming step for the</span>
<span class="cm">	   residue register.  */</span>
	<span class="n">need_prime</span> <span class="o">=</span> <span class="p">(</span><span class="n">salign</span> <span class="o">&gt;</span> <span class="n">dalign</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_prime</span><span class="p">)</span>
		<span class="n">dpos</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Begin by copying the leading unaligned destination.  Copy enough</span>
<span class="cm">	   to make the next destination address 32-byte aligned.  */</span>
	<span class="n">copied</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="p">(</span><span class="n">dalign</span> <span class="o">+</span> <span class="p">(</span><span class="n">dpos</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xincr_first</span> <span class="o">=</span> <span class="p">(</span><span class="n">copied</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">smask_first</span> <span class="o">=</span> <span class="n">dmask_first</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="n">copied</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">smask_first</span> <span class="o">&lt;&lt;=</span> <span class="n">salign</span><span class="p">;</span>
	<span class="n">dmask_first</span> <span class="o">&lt;&lt;=</span> <span class="n">dalign</span> <span class="o">+</span> <span class="n">need_prime</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_prime</span> <span class="o">&amp;&amp;</span> <span class="n">copied</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">copied</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">copied</span><span class="p">;</span>

	<span class="cm">/* Care for small copies.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">&lt;&lt;=</span> <span class="n">dalign</span> <span class="o">+</span> <span class="n">need_prime</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">dmask_first</span> <span class="o">&amp;=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Attempt to use 64-byte copies.  This is only possible if the</span>
<span class="cm">	   source and destination are co-aligned at 64 bytes.  */</span>
	<span class="n">n64</span> <span class="o">=</span> <span class="n">need_second</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dpos</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">spos</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">height</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">line_length</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We may need a 32-byte copy to ensure 64 byte alignment.  */</span>
		<span class="n">need_second</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpos</span> <span class="o">+</span> <span class="n">xincr_first</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">need_second</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">!=</span> <span class="n">need_second</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: need_second wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="n">need_second</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">need_second</span><span class="p">;</span>
			<span class="n">n64</span> <span class="o">=</span> <span class="n">left</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">%=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">need_second</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy trailing full 32-byte sections.  This will be the main</span>
<span class="cm">	   loop if the 64 byte loop can&#39;t be used.  */</span>
	<span class="n">n32</span> <span class="o">=</span> <span class="n">left</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">%=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/* Copy the trailing unaligned destination.  */</span>
	<span class="n">dmask_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tga_regs</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="n">tga_fb</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>

	<span class="cm">/* Set up the MODE and PIXELSHIFT registers.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_8BPP</span><span class="o">|</span><span class="n">TGA_MODE_COPY</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">pixel_shift</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_PIXELSHIFT_REG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dfb</span><span class="p">;</span>

		<span class="n">sfb</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="n">spos</span><span class="p">;</span>
		<span class="n">dfb</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="n">dpos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmask_first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">smask_first</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">dmask_first</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">sfb</span> <span class="o">+=</span> <span class="n">xincr_first</span><span class="p">;</span>
			<span class="n">dfb</span> <span class="o">+=</span> <span class="n">xincr_first</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">need_second</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">sfb</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">dfb</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n64</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sfb</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dfb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;tgafb: misaligned copy64 (s:%p, d:%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sfb</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n64</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">sfb</span> <span class="o">-</span> <span class="n">tga_fb</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_COPY64_SRC</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">dfb</span> <span class="o">-</span> <span class="n">tga_fb</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_COPY64_DST</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">sfb</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">dfb</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n32</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">sfb</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">dfb</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dmask_last</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">dmask_last</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">spos</span> <span class="o">+=</span> <span class="n">yincr</span><span class="p">;</span>
		<span class="n">dpos</span> <span class="o">+=</span> <span class="n">yincr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the MODE register to normal.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_8BPP</span><span class="o">|</span><span class="n">TGA_MODE_SIMPLE</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The (almost) general case of backward copy in 8bpp mode.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="n">copyarea_backward_8bpp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sy</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">height</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">line_length</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">yincr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">depos</span><span class="p">,</span> <span class="n">sepos</span><span class="p">,</span> <span class="n">dealign</span><span class="p">,</span> <span class="n">sealign</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_first</span><span class="p">,</span> <span class="n">mask_last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n32</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tga_regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tga_fb</span><span class="p">;</span>

	<span class="n">yincr</span> <span class="o">=</span> <span class="n">line_length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">sy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dy</span> <span class="o">+=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sy</span> <span class="o">+=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">yincr</span> <span class="o">=</span> <span class="o">-</span><span class="n">yincr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Compute the offsets and alignments in the frame buffer.</span>
<span class="cm">	   More than anything else, these control how we do copies.  */</span>
	<span class="n">depos</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">sepos</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">line_length</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">dealign</span> <span class="o">=</span> <span class="n">depos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">sealign</span> <span class="o">=</span> <span class="n">sepos</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="cm">/* ??? The documentation appears to be incorrect (or very</span>
<span class="cm">	   misleading) wrt how pixel shifting works in backward copy</span>
<span class="cm">	   mode, i.e. when PIXELSHIFT is negative.  I give up for now.</span>
<span class="cm">	   Do handle the common case of co-aligned backward copies,</span>
<span class="cm">	   but frob everything else back on generic code.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dealign</span> <span class="o">!=</span> <span class="n">sealign</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We begin the copy with the trailing pixels of the</span>
<span class="cm">	   unaligned destination.  */</span>
	<span class="n">mask_first</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="n">dealign</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">dealign</span><span class="p">;</span>

	<span class="cm">/* Care for small copies.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dealign</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask_first</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dealign</span> <span class="o">-</span> <span class="n">width</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Next copy full words at a time.  */</span>
	<span class="n">n32</span> <span class="o">=</span> <span class="n">left</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">%=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/* Finally copy the unaligned head of the span.  */</span>
	<span class="n">mask_last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">left</span><span class="p">);</span>

	<span class="n">tga_regs</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="n">tga_fb</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>

	<span class="cm">/* Set up the MODE and PIXELSHIFT registers.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_8BPP</span><span class="o">|</span><span class="n">TGA_MODE_COPY</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_PIXELSHIFT_REG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dfb</span><span class="p">;</span>

		<span class="n">sfb</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="n">sepos</span><span class="p">;</span>
		<span class="n">dfb</span> <span class="o">=</span> <span class="n">tga_fb</span> <span class="o">+</span> <span class="n">depos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask_first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask_first</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask_first</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n32</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sfb</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">dfb</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mask_last</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sfb</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">dfb</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask_last</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask_last</span><span class="p">,</span> <span class="n">dfb</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">sepos</span> <span class="o">+=</span> <span class="n">yincr</span><span class="p">;</span>
		<span class="n">depos</span> <span class="o">+=</span> <span class="n">yincr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the MODE register to normal.  */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">TGA_MODE_SBM_8BPP</span><span class="o">|</span><span class="n">TGA_MODE_SIMPLE</span><span class="p">,</span> <span class="n">tga_regs</span><span class="o">+</span><span class="n">TGA_MODE_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">tgafb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_length</span><span class="p">,</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">;</span>
	<span class="n">sy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">;</span>
	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>

	<span class="cm">/* The top left corners must be in the virtual screen.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">sx</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">dy</span> <span class="o">&gt;</span> <span class="n">vyres</span> <span class="o">||</span> <span class="n">sy</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clip the destination.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="cm">/* The source must be completely inside the virtual screen.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">sy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="cm">/* Detect copies of the entire line.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">line_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">copyarea_line_8bpp</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">copyarea_line_32bpp</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ??? The documentation is unclear to me exactly how the pixelshift</span>
<span class="cm">	   register works in 32bpp mode.  Since I don&#39;t have hardware to test,</span>
<span class="cm">	   give up for now and fall back on the generic routines.  */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>

	<span class="cm">/* Detect overlapping source and destination that requires</span>
<span class="cm">	   a backward copy.  */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">==</span> <span class="n">sy</span> <span class="o">&amp;&amp;</span> <span class="n">dx</span> <span class="o">&gt;</span> <span class="n">sx</span> <span class="o">&amp;&amp;</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
		<span class="n">copyarea_backward_8bpp</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
				       <span class="n">width</span><span class="p">,</span> <span class="n">line_length</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">copyarea_foreward_8bpp</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
				       <span class="n">width</span><span class="p">,</span> <span class="n">line_length</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Initialisation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">tgafb_init_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tga_bus_pci</span> <span class="o">=</span> <span class="n">TGA_BUS_PCI</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tga_bus_tc</span> <span class="o">=</span> <span class="n">TGA_BUS_TC</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tga_type</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_type</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tga_type_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tga_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TGA_TYPE_8PLANE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span>
			<span class="n">tga_type_name</span> <span class="o">=</span> <span class="s">&quot;Digital ZLXp-E1&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span>
			<span class="n">tga_type_name</span> <span class="o">=</span> <span class="s">&quot;Digital ZLX-E1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TGA_TYPE_24PLANE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span>
			<span class="n">tga_type_name</span> <span class="o">=</span> <span class="s">&quot;Digital ZLXp-E2&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span>
			<span class="n">tga_type_name</span> <span class="o">=</span> <span class="s">&quot;Digital ZLX-E2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TGA_TYPE_24PLUSZ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span>
			<span class="n">tga_type_name</span> <span class="o">=</span> <span class="s">&quot;Digital ZLXp-E3&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span>
			<span class="n">tga_type_name</span> <span class="o">=</span> <span class="s">&quot;Digital ZLX-E3&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tga_type_name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tga_type_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="p">(</span><span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span>
			    <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>
			    <span class="o">:</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_DEC_TGA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * These are needed by fb_set_logo_truepalette(), so we</span>
<span class="cm">	 * set them here for 24-plane cards.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_type</span> <span class="o">!=</span> <span class="n">TGA_TYPE_8PLANE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tgafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We just use this to catch switches out of graphics mode. */</span>
	<span class="n">tgafb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* A bit of overkill for BASE_ADDR reset. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="n">tgafb_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">modedb_tc</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* 1280x1024 @ 72 Hz, 76.8 kHz hsync */</span>
		<span class="s">&quot;1280x1024@72&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">7645</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="n">FB_SYNC_ON_GREEN</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="k">const</span> <span class="n">fb_offset_presets</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">TGA_8PLANE_FB_OFFSET</span><span class="p">,</span>
		<span class="n">TGA_24PLANE_FB_OFFSET</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="n">TGA_24PLUSZ_FB_OFFSET</span>
	<span class="p">};</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">modedb_tga</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">bar0_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bar0_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option_tga</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tga_bus_pci</span> <span class="o">=</span> <span class="n">TGA_BUS_PCI</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tga_bus_tc</span> <span class="o">=</span> <span class="n">TGA_BUS_TC</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modedbsize_tga</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tga_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable device in PCI config.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span> <span class="o">&amp;&amp;</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: Cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate the fb and par structures.  */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tga_par</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: Cannot allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Request the mem regions.  */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bar0_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bar0_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bar0_start</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">bar0_len</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">bar0_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span> <span class="p">(</span><span class="n">bar0_start</span><span class="p">,</span> <span class="n">bar0_len</span><span class="p">,</span> <span class="s">&quot;tgafb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: cannot reserve FB region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Map the framebuffer.  */</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">bar0_start</span><span class="p">,</span> <span class="n">bar0_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: Cannot map MMIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Grab info about the card.  */</span>
	<span class="n">tga_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">mem_base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_mem_base</span> <span class="o">=</span> <span class="n">mem_base</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span> <span class="o">=</span> <span class="n">mem_base</span> <span class="o">+</span> <span class="n">fb_offset_presets</span><span class="p">[</span><span class="n">tga_type</span><span class="p">];</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_regs_base</span> <span class="o">=</span> <span class="n">mem_base</span> <span class="o">+</span> <span class="n">TGA_REGS_OFFSET</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_type</span> <span class="o">=</span> <span class="n">tga_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_chip_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_chip_rev</span> <span class="o">=</span> <span class="n">TGA_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">TGA_START_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Setup framebuffer.  */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>
		      <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_FILLRECT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tgafb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_fb_base</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>

	<span class="cm">/* This should give a reasonable default video mode.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode_option_tga</span> <span class="o">=</span> <span class="n">mode_option_pci</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode_option_tga</span> <span class="o">=</span> <span class="n">mode_option_tc</span><span class="p">;</span>
		<span class="n">modedb_tga</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">modedb_tc</span><span class="p">;</span>
		<span class="n">modedbsize_tga</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
			   <span class="n">mode_option</span> <span class="o">?</span> <span class="n">mode_option</span> <span class="o">:</span> <span class="n">mode_option_tga</span><span class="p">,</span>
			   <span class="n">modedb_tga</span><span class="p">,</span> <span class="n">modedbsize_tga</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			   <span class="n">tga_type</span> <span class="o">==</span> <span class="n">TGA_TYPE_8PLANE</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: Could not find valid video mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: Could not allocate color map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tgafb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">tgafb_init_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;tgafb: Could not register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tgafb: DC21030 [TGA] detected, rev=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_chip_rev</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tgafb: at PCI bus %d, device %d, function %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
			<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tgafb: SFB+ detected, rev=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_chip_rev</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;fb%d: %s frame buffer device at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">bar0_start</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err2:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
 <span class="nl">err1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">bar0_start</span><span class="p">,</span> <span class="n">bar0_len</span><span class="p">);</span>
 <span class="nl">err0:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="n">tgafb_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">bar0_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bar0_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tga_bus_pci</span> <span class="o">=</span> <span class="n">TGA_BUS_PCI</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tga_bus_tc</span> <span class="o">=</span> <span class="n">TGA_BUS_TC</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tga_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">tga_mem_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bar0_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bar0_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tga_bus_tc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bar0_start</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">bar0_len</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">bar0_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">bar0_start</span><span class="p">,</span> <span class="n">bar0_len</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="n">tgafb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tc_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgafb_tc_driver</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgafb_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="n">tgafb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mode:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
				<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;tgafb: unknown parameter %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">this_opt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="n">tgafb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;tgafb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">tgafb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgafb_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tc_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgafb_tc_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Modularisation</span>
<span class="cm"> */</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tgafb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tgafb_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for TGA/SFB+ chipset&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
