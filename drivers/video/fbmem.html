<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › fbmem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fbmem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/fbmem.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1994 Martin Schaller</span>
<span class="cm"> *</span>
<span class="cm"> *	2001 - Documented with DocBook</span>
<span class="cm"> *	- Brad Douglas &lt;brad@neruo.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mman.h&gt;</span>
<span class="cp">#include &lt;linux/vt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/linux_logo.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/efi.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>

<span class="cp">#include &lt;asm/fb.h&gt;</span>


    <span class="cm">/*</span>
<span class="cm">     *  Frame buffer device initialization and setup routines</span>
<span class="cm">     */</span>

<span class="cp">#define FBPIXMAPSIZE	(1024 * 8)</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">registration_lock</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">registered_fb</span><span class="p">[</span><span class="n">FB_MAX</span><span class="p">]</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">num_registered_fb</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="nf">get_fb_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">FB_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">fb_info</span> <span class="o">=</span> <span class="n">registered_fb</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fb_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_fb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_destroy</span><span class="p">)</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_destroy</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lock_fb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">lock_fb_info</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Helpers</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">fb_get_color_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_MONO01</span> <span class="o">||</span>
	    <span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_MONO10</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">&amp;&amp;</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_get_color_depth</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Data padding functions.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fb_pad_aligned_buffer</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">d_pitch</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">s_pitch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__fb_pad_aligned_buffer</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">d_pitch</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">s_pitch</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_pad_aligned_buffer</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">fb_pad_unaligned_buffer</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">d_pitch</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">shift_high</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shift_low</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="n">shift_high</span><span class="p">),</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">idx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="o">*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="n">shift_low</span><span class="p">;</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="n">shift_high</span><span class="p">;</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="o">*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="n">shift_low</span><span class="p">;</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift_high</span> <span class="o">&lt;</span> <span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="n">shift_high</span><span class="p">;</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">d_pitch</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_pad_unaligned_buffer</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * we need to lock this section since fb_cursor</span>
<span class="cm"> * may use fb_imageblit()</span>
<span class="cm"> */</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">fb_get_buffer_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_pixmap</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">align</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* If IO mapped, we need to sync before access, no sharing of</span>
<span class="cm">	 * the pixmap is done</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FB_PIXMAP_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FB_PIXMAP_SYNC</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* See if we fit in the remaining pixmap space */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">align</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We do not fit. In order to be able to re-use the buffer,</span>
<span class="cm">		 * we must ensure no asynchronous DMA&#39;ing or whatever operation</span>
<span class="cm">		 * is in progress, we sync for that.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FB_PIXMAP_SYNC</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_LOGO</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">safe_shift</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="o">-</span><span class="n">n</span> <span class="o">:</span> <span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_set_logocmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_cmap</span> <span class="n">palette_cmap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">palette_green</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">palette_blue</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">palette_red</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clut</span> <span class="o">=</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">clut</span><span class="p">;</span>

	<span class="n">palette_cmap</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">palette_cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">palette_cmap</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="n">palette_red</span><span class="p">;</span>
	<span class="n">palette_cmap</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">palette_green</span><span class="p">;</span>
	<span class="n">palette_cmap</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">palette_blue</span><span class="p">;</span>
	<span class="n">palette_cmap</span><span class="p">.</span><span class="n">transp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">clutsize</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">clutsize</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* palette_cmap provides space for only 16 colors at once */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">palette_cmap</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">palette_cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">palette_cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">clut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">clut</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">palette_cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">clut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">clut</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">palette_cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">clut</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">clut</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">clut</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palette_cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="nf">fb_set_logo_truepalette</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">,</span>
					    <span class="n">u32</span> <span class="o">*</span><span class="n">palette</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,</span><span class="mh">0xf0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0xfc</span><span class="p">,</span><span class="mh">0xfe</span><span class="p">,</span><span class="mh">0xff</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">redmask</span><span class="p">,</span> <span class="n">greenmask</span><span class="p">,</span> <span class="n">bluemask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">greenshift</span><span class="p">,</span> <span class="n">blueshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clut</span> <span class="o">=</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">clut</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to create a temporary palette since console palette is only</span>
<span class="cm">	 * 16 colors long.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Bug: Doesn&#39;t obey msb_right ... (who needs that?) */</span>
	<span class="n">redmask</span>   <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>   <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>   <span class="o">:</span> <span class="mi">8</span><span class="p">];</span>
	<span class="n">greenmask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">:</span> <span class="mi">8</span><span class="p">];</span>
	<span class="n">bluemask</span>  <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>  <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>  <span class="o">:</span> <span class="mi">8</span><span class="p">];</span>
	<span class="n">redshift</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>   <span class="o">-</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">greenshift</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">blueshift</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>  <span class="o">-</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">clutsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">safe_shift</span><span class="p">((</span><span class="n">clut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">redmask</span><span class="p">),</span> <span class="n">redshift</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">safe_shift</span><span class="p">((</span><span class="n">clut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">greenmask</span><span class="p">),</span> <span class="n">greenshift</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">safe_shift</span><span class="p">((</span><span class="n">clut</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bluemask</span><span class="p">),</span> <span class="n">blueshift</span><span class="p">));</span>
		<span class="n">clut</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_set_logo_directpalette</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="o">*</span><span class="n">palette</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">greenshift</span><span class="p">,</span> <span class="n">blueshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">redshift</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">greenshift</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">blueshift</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">clutsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">redshift</span> <span class="o">|</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">greenshift</span> <span class="o">|</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">blueshift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_set_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">xor</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_MONO01</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fb_get_color_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fg</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fg</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_MONO01</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_MONO10</span><span class="p">)</span>
		<span class="n">fg</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="n">src</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
					<span class="n">j</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="n">src</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span> <span class="o">^</span> <span class="n">xor</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="n">k</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">fg</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">j</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Three (3) kinds of logo maps exist.  linux_logo_clut224 (&gt;16 colors),</span>
<span class="cm"> * linux_logo_vga16 (16 colors) and linux_logo_mono (2 colors).  Depending on</span>
<span class="cm"> * the visual format and color depth of the framebuffer, the DAC, the</span>
<span class="cm"> * pseudo_palette, and the logo data will be adjusted accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * Case 1 - linux_logo_clut224:</span>
<span class="cm"> * Color exceeds the number of console colors (16), thus we set the hardware DAC</span>
<span class="cm"> * using fb_set_cmap() appropriately.  The &quot;needs_cmapreset&quot;  flag will be set.</span>
<span class="cm"> *</span>
<span class="cm"> * For visuals that require color info from the pseudo_palette, we also construct</span>
<span class="cm"> * one for temporary use. The &quot;needs_directpalette&quot; or &quot;needs_truepalette&quot; flags</span>
<span class="cm"> * will be set.</span>
<span class="cm"> *</span>
<span class="cm"> * Case 2 - linux_logo_vga16:</span>
<span class="cm"> * The number of colors just matches the console colors, thus there is no need</span>
<span class="cm"> * to set the DAC or the pseudo_palette.  However, the bitmap is packed, ie,</span>
<span class="cm"> * each byte contains color information for two pixels (upper and lower nibble).</span>
<span class="cm"> * To be consistent with fb_imageblit() usage, we therefore separate the two</span>
<span class="cm"> * nibbles into separate bytes. The &quot;depth&quot; flag will be set to 4.</span>
<span class="cm"> *</span>
<span class="cm"> * Case 3 - linux_logo_mono:</span>
<span class="cm"> * This is similar with Case 2.  Each byte contains information for 8 pixels.</span>
<span class="cm"> * We isolate each bit and expand each into a byte. The &quot;depth&quot; flag will</span>
<span class="cm"> * be set to 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">logo_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_directpalette</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_truepalette</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_cmapreset</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">;</span>
<span class="p">}</span> <span class="n">fb_logo</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_rotate_logo_ud</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">out</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span>
		<span class="o">*</span><span class="n">out</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">in</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_rotate_logo_cw</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">out</span><span class="p">[</span><span class="n">height</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">in</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_rotate_logo_ccw</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">out</span><span class="p">[</span><span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">in</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_rotate_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_UD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_rotate_logo_ud</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
				  <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_CW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_rotate_logo_cw</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
				  <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_CCW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_rotate_logo_ccw</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
				   <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_do_show_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">rotate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_UR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
		     <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
			<span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_UD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
			<span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">-=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_CW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
		     <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
			<span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_CCW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
			<span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">-=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_show_logo_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">palette</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">saved_pseudo_palette</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">logo_new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">logo_rotate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_image</span> <span class="n">image</span><span class="p">;</span>

	<span class="cm">/* Return if the frame buffer is not mapped or suspended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_MODULE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">image</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">image</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_cmapreset</span><span class="p">)</span>
		<span class="n">fb_set_logocmap</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">logo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_truepalette</span> <span class="o">||</span>
	    <span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_directpalette</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">palette</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">palette</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_truepalette</span><span class="p">)</span>
			<span class="n">fb_set_logo_truepalette</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">logo</span><span class="p">,</span> <span class="n">palette</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fb_set_logo_directpalette</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">logo</span><span class="p">,</span> <span class="n">palette</span><span class="p">);</span>

		<span class="n">saved_pseudo_palette</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">palette</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">logo_new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">logo_new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">palette</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saved_pseudo_palette</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">saved_pseudo_palette</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">image</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">logo_new</span><span class="p">;</span>
		<span class="n">fb_set_logo</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">logo</span><span class="p">,</span> <span class="n">logo_new</span><span class="p">,</span> <span class="n">fb_logo</span><span class="p">.</span><span class="n">depth</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">image</span><span class="p">.</span><span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">image</span><span class="p">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">image</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">logo_rotate</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span>
				      <span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">logo_rotate</span><span class="p">)</span>
			<span class="n">fb_rotate_logo</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">logo_rotate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">,</span> <span class="n">rotate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fb_do_show_logo</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">palette</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_pseudo_palette</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">saved_pseudo_palette</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">logo_new</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">logo_rotate</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_FB_LOGO_EXTRA</span>

<span class="cp">#define FB_LOGO_EX_NUM_MAX 10</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">logo_data_extra</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span> <span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">FB_LOGO_EX_NUM_MAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fb_logo_ex_num</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">fb_append_extra_logo</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">linux_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span> <span class="o">||</span> <span class="n">fb_logo_ex_num</span> <span class="o">==</span> <span class="n">FB_LOGO_EX_NUM_MAX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">fb_logo_ex_num</span><span class="p">].</span><span class="n">logo</span> <span class="o">=</span> <span class="n">logo</span><span class="p">;</span>
	<span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">fb_logo_ex_num</span><span class="p">].</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">fb_logo_ex_num</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_prepare_extra_logos</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* FIXME: logo_ex supports only truecolor fb. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">!=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span>
		<span class="n">fb_logo_ex_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_logo_ex_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">logo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">height</span> <span class="o">+=</span> <span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">height</span> <span class="o">-=</span> <span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
			<span class="n">fb_logo_ex_num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_show_extra_logos</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_logo_ex_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">+=</span> <span class="n">fb_show_logo_line</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span>
				       <span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">logo</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fb_logo_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_FB_LOGO_EXTRA */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fb_prepare_extra_logos</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fb_show_extra_logos</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_LOGO_EXTRA */</span><span class="cp"></span>


<span class="kt">int</span> <span class="nf">fb_prepare_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">fb_get_color_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_logo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">logo_data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_MISC_TILEBLITTING</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_MODULE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* assume console colormap */</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return if no suitable logo was found */</span>
	<span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span> <span class="o">=</span> <span class="n">fb_find_logo</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_UR</span> <span class="o">||</span> <span class="n">rotate</span> <span class="o">==</span> <span class="n">FB_ROTATE_UD</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* What depth we asked for might be different from what we get */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LINUX_LOGO_CLUT224</span><span class="p">)</span>
		<span class="n">fb_logo</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LINUX_LOGO_VGA16</span><span class="p">)</span>
		<span class="n">fb_logo</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fb_logo</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


 	<span class="k">if</span> <span class="p">(</span><span class="n">fb_logo</span><span class="p">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
 		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
 		<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
 			<span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_truepalette</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 			<span class="k">break</span><span class="p">;</span>
 		<span class="k">case</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span>:
 			<span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_directpalette</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 			<span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_cmapreset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 			<span class="k">break</span><span class="p">;</span>
 		<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
 			<span class="n">fb_logo</span><span class="p">.</span><span class="n">needs_cmapreset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 			<span class="k">break</span><span class="p">;</span>
 		<span class="p">}</span>
 	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fb_prepare_extra_logos</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">yres</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fb_show_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">y</span><span class="p">;</span>

	<span class="n">y</span> <span class="o">=</span> <span class="n">fb_show_logo_line</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">fb_logo</span><span class="p">.</span><span class="n">logo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="n">num_online_cpus</span><span class="p">());</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">fb_show_extra_logos</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rotate</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="nf">fb_prepare_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">fb_show_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_LOGO */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">fb_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">FB_MAX</span><span class="p">)</span> <span class="o">?</span> <span class="n">pos</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">fb_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">FB_MAX</span><span class="p">)</span> <span class="o">?</span> <span class="n">pos</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">loff_t</span> <span class="o">*</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">proc_fb_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">fb_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">fb_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">fb_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">fb_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_fb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_fb_seq_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fb_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_fb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * We hold a reference to the fb_info in file-&gt;private_data,</span>
<span class="cm"> * but if the current registered fb has changed, we don&#39;t</span>
<span class="cm"> * actually want to use it.</span>
<span class="cm"> *</span>
<span class="cm"> * So look up the fb_info using the inode minor number,</span>
<span class="cm"> * and just verify it against the reference we have.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="nf">file_fb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fbidx</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">registered_fb</span><span class="p">[</span><span class="n">fbidx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">!=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span>
		<span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">fb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">file_fb_info</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="o">!</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_read</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_read</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
	
	<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">,</span>
			 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span>  <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="n">fb_memcpy_fromfb</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">fb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">file_fb_info</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_write</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_write</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
	
	<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">,</span>
			 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fb_memcpy_tofb</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">?</span> <span class="n">cnt</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">||</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">%</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">yres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">||</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">%</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">||</span>
				 <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">%</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span><span class="p">)))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_pan_display</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_pan_display</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_check_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">activate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_blit_caps</span> <span class="n">caps</span><span class="p">,</span> <span class="n">fbcaps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caps</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbcaps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fbcaps</span><span class="p">));</span>
	<span class="n">caps</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_ALL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">;</span>
	<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_GET_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_get_caps</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbcaps</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">fbcaps</span><span class="p">.</span><span class="n">x</span> <span class="o">^</span> <span class="n">caps</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">caps</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">fbcaps</span><span class="p">.</span><span class="n">y</span> <span class="o">^</span> <span class="n">caps</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">caps</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fbcaps</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">caps</span><span class="p">.</span><span class="n">len</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">fb_set_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_INV_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">mode1</span><span class="p">,</span> <span class="n">mode2</span><span class="p">;</span>

		<span class="n">fb_var_to_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode1</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="n">fb_var_to_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
		<span class="cm">/* make sure we don&#39;t delete the videomode of current var */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_mode_is_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>

		    <span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		    <span class="n">event</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mode1</span><span class="p">;</span>
		    <span class="n">ret</span> <span class="o">=</span> <span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_MODE_DELETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		    <span class="n">fb_delete_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>


		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_FORCE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">activate</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">;</span>

		<span class="cm">/* When using FOURCC mode, make sure the red, green, blue and</span>
<span class="cm">		 * transp fields are set to 0.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">FB_CAP_FOURCC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>     <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>    <span class="o">||</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span>   <span class="o">||</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>     <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>    <span class="o">||</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>   <span class="o">||</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span>  <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">||</span>
			    <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_check_var</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_check_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">old_var</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">mode</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_get_caps</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_check_caps</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">activate</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">old_var</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_set_par</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">old_var</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;detected &quot;</span>
						<span class="s">&quot;fb_set_par error, &quot;</span>
						<span class="s">&quot;error code: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">fb_pan_display</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
			<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">fb_var_to_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">.</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">.</span><span class="n">next</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_add_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_MISC_USEREVENT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">evnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_ALL</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">FB_EVENT_MODE_CHANGE_ALL</span> <span class="o">:</span>
					<span class="n">FB_EVENT_MODE_CHANGE</span><span class="p">;</span>

				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_MISC_USEREVENT</span><span class="p">;</span>
				<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
				<span class="n">event</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">;</span>
				<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">evnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">fb_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blank</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">early_ret</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span> <span class="o">&gt;</span> <span class="n">FB_BLANK_POWERDOWN</span><span class="p">)</span>
 		<span class="n">blank</span> <span class="o">=</span> <span class="n">FB_BLANK_POWERDOWN</span><span class="p">;</span>

	<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">blank</span><span class="p">;</span>

	<span class="n">early_ret</span> <span class="o">=</span> <span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EARLY_EVENT_BLANK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_blank</span><span class="p">)</span>
 		<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_blank</span><span class="p">(</span><span class="n">blank</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_BLANK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if fb_blank is failed then revert effects of</span>
<span class="cm">		 * the early blank event.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early_ret</span><span class="p">)</span>
			<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_R_EARLY_EVENT_BLANK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

 	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">do_fb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_ops</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_con2fbmap</span> <span class="n">con2fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_cmap</span> <span class="n">cmap_from</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_cmap_user</span> <span class="n">cmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIOGET_VSCREENINFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOPUT_VSCREENINFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">console_lock</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_MISC_USEREVENT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_set_var</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_MISC_USEREVENT</span><span class="p">;</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOGET_FSCREENINFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">fix</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOPUTCMAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmap</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_set_user_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOGETCMAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmap</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">cmap_from</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">;</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_cmap_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmap_from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOPAN_DISPLAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">console_lock</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_pan_display</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">);</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIO_CURSOR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOGET_CON2FBMAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con2fb</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">con2fb</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con2fb</span><span class="p">.</span><span class="n">console</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">con2fb</span><span class="p">.</span><span class="n">console</span> <span class="o">&gt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">con2fb</span><span class="p">.</span><span class="n">framebuffer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">con2fb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_GET_CONSOLE_MAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con2fb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">con2fb</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOPUT_CON2FBMAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con2fb</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">con2fb</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con2fb</span><span class="p">.</span><span class="n">console</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">con2fb</span><span class="p">.</span><span class="n">console</span> <span class="o">&gt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con2fb</span><span class="p">.</span><span class="n">framebuffer</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">con2fb</span><span class="p">.</span><span class="n">framebuffer</span> <span class="o">&gt;=</span> <span class="n">FB_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registered_fb</span><span class="p">[</span><span class="n">con2fb</span><span class="p">.</span><span class="n">framebuffer</span><span class="p">])</span>
			<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;fb%d&quot;</span><span class="p">,</span> <span class="n">con2fb</span><span class="p">.</span><span class="n">framebuffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registered_fb</span><span class="p">[</span><span class="n">con2fb</span><span class="p">.</span><span class="n">framebuffer</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">event</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">con2fb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_SET_CONSOLE_MAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIOBLANK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">console_lock</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_MISC_USEREVENT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_blank</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_MISC_USEREVENT</span><span class="p">;</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">fb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fb_ioctl</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fb_ioctl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">fb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">file_fb_info</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">do_fb_ioctl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">struct</span> <span class="n">fb_fix_screeninfo32</span> <span class="p">{</span>
	<span class="kt">char</span>			<span class="n">id</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">compat_caddr_t</span>		<span class="n">smem_start</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">smem_len</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">type_aux</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">visual</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">xpanstep</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">ypanstep</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">ywrapstep</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">line_length</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>		<span class="n">mmio_start</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">mmio_len</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">accel</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fb_cmap32</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">len</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>	<span class="n">red</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>	<span class="n">green</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>	<span class="n">blue</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>	<span class="n">transp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_getput_cmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_cmap_user</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_cmap32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cmap32</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmap</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmap</span><span class="p">));</span>
	<span class="n">cmap32</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap32</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap32</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap32</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap32</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap32</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_fb_ioctl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmap32</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				 <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_fscreeninfo_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">fb_fix_screeninfo32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">fix32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">type_aux</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">visual</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">xpanstep</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">ypanstep</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">ywrapstep</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">line_length</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">fix32</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_get_fscreeninfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">fix32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">fix32</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">do_fb_ioctl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fix</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_fscreeninfo_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fix</span><span class="p">,</span> <span class="n">fix32</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">fb_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">file_fb_info</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_ops</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIOGET_VSCREENINFO</span>:
	<span class="k">case</span> <span class="n">FBIOPUT_VSCREENINFO</span>:
	<span class="k">case</span> <span class="n">FBIOPAN_DISPLAY</span>:
	<span class="k">case</span> <span class="n">FBIOGET_CON2FBMAP</span>:
	<span class="k">case</span> <span class="n">FBIOPUT_CON2FBMAP</span>:
		<span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FBIOBLANK</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_fb_ioctl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FBIOGET_FSCREENINFO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_get_fscreeninfo</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FBIOGETCMAP</span>:
	<span class="k">case</span> <span class="n">FBIOPUTCMAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_getput_cmap</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fb_compat_ioctl</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fb_compat_ioctl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span> <span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">file_fb_info</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_ops</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fb_mmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fb_mmap</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* frame buffer memory */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="n">start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* memory mapped io */</span>
		<span class="n">off</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="n">start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="cm">/* This is an IO map - tell maydump to skip this VMA */</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_IO</span> <span class="o">|</span> <span class="n">VM_RESERVED</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span> <span class="o">=</span> <span class="n">vm_get_page_prot</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="p">);</span>
	<span class="n">fb_pgprotect</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
			     <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fbidx</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">get_fb_info</span><span class="p">(</span><span class="n">fbidx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;fb%d&quot;</span><span class="p">,</span> <span class="n">fbidx</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">get_fb_info</span><span class="p">(</span><span class="n">fbidx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_open</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_FB_DEFERRED_IO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span><span class="p">)</span>
		<span class="n">fb_deferred_io_open</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">put_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">fb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span> <span class="k">const</span> <span class="n">info</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_release</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_release</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">put_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fb_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">fb_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">fb_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">fb_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">fb_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">fb_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">fb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">fb_release</span><span class="p">,</span>
<span class="cp">#ifdef HAVE_ARCH_FB_UNMAPPED_AREA</span>
	<span class="p">.</span><span class="n">get_unmapped_area</span> <span class="o">=</span> <span class="n">get_fb_unmapped_area</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FB_DEFERRED_IO</span>
	<span class="p">.</span><span class="n">fsync</span> <span class="o">=</span>	<span class="n">fb_deferred_io_fsync</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">fb_class</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_class</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_check_foreignness</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">bool</span> <span class="n">foreign_endian</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_FOREIGN_ENDIAN</span><span class="p">;</span>

	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_FOREIGN_ENDIAN</span><span class="p">;</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">foreign_endian</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FBINFO_BE_MATH</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">foreign_endian</span> <span class="o">?</span> <span class="n">FBINFO_BE_MATH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* __BIG_ENDIAN */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_BE_MATH</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fb_be_math</span><span class="p">(</span><span class="n">fi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: enable CONFIG_FB_BIG_ENDIAN to &quot;</span>
		       <span class="s">&quot;support this framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_BE_MATH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fb_be_math</span><span class="p">(</span><span class="n">fi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: enable CONFIG_FB_LITTLE_ENDIAN to &quot;</span>
		       <span class="s">&quot;support this framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">apertures_overlap</span><span class="p">(</span><span class="k">struct</span> <span class="n">aperture</span> <span class="o">*</span><span class="n">gen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aperture</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* is the generic aperture base the same as the HW one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* is the generic aperture base inside the hw base-&gt;hw base+size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">gen</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">fb_do_apertures_overlap</span><span class="p">(</span><span class="k">struct</span> <span class="n">apertures_struct</span> <span class="o">*</span><span class="n">gena</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">apertures_struct</span> <span class="o">*</span><span class="n">hwa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwa</span> <span class="o">||</span> <span class="o">!</span><span class="n">gena</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hwa</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aperture</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwa</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">gena</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">aperture</span> <span class="o">*</span><span class="n">g</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gena</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;checking generic (%llx %llx) vs hw (%llx %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">apertures_overlap</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">do_unregister_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">);</span>

<span class="cp">#define VGA_FB_PHYS 0xA0000</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_remove_conflicting_framebuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">apertures_struct</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">bool</span> <span class="n">primary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* check all firmware fbs and kick off if the base addr overlaps */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FB_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">apertures_struct</span> <span class="o">*</span><span class="n">gen_aper</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_MISC_FIRMWARE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">gen_aper</span> <span class="o">=</span> <span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb_do_apertures_overlap</span><span class="p">(</span><span class="n">gen_aper</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">primary</span> <span class="o">&amp;&amp;</span> <span class="n">gen_aper</span> <span class="o">&amp;&amp;</span> <span class="n">gen_aper</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;&amp;</span>
			 <span class="n">gen_aper</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">base</span> <span class="o">==</span> <span class="n">VGA_FB_PHYS</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb: conflicting fb hw usage &quot;</span>
			       <span class="s">&quot;%s vs %s - removing generic driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">name</span><span class="p">,</span> <span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="n">do_unregister_framebuffer</span><span class="p">(</span><span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_register_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_check_foreignness</span><span class="p">(</span><span class="n">fb_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="n">do_remove_conflicting_framebuffers</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">apertures</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
					 <span class="n">fb_is_primary_device</span><span class="p">(</span><span class="n">fb_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_registered_fb</span> <span class="o">==</span> <span class="n">FB_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">num_registered_fb</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FB_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>

	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">fb_class</span><span class="p">,</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				     <span class="n">MKDEV</span><span class="p">(</span><span class="n">FB_MAJOR</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fb%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not fatal */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to create device for framebuffer %d; errno = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fb_init_device</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">FBPIXMAPSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">FBPIXMAPSIZE</span><span class="p">;</span>
			<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">buf_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">access_align</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FB_PIXMAP_DEFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>	
	<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">blit_x</span><span class="p">)</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">blit_x</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">blit_y</span><span class="p">)</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">blit_y</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">.</span><span class="n">prev</span> <span class="o">||</span> <span class="o">!</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>

	<span class="n">fb_var_to_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="n">fb_add_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_info</span><span class="p">;</span>

	<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">fb_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">fb_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_FB_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_unregister_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">FB_MAX</span> <span class="o">||</span> <span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fb_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">fb_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">fb_info</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_FB_UNBIND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">unlink_framebuffer</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FB_PIXMAP_DEFAULT</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">fb_destroy_modelist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">num_registered_fb</span><span class="o">--</span><span class="p">;</span>
	<span class="n">fb_cleanup_device</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">fb_info</span><span class="p">;</span>
	<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_FB_UNREGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

	<span class="cm">/* this may free fb info */</span>
	<span class="n">put_fb_info</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">unlink_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">FB_MAX</span> <span class="o">||</span> <span class="n">registered_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fb_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_destroy</span><span class="p">(</span><span class="n">fb_class</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">FB_MAJOR</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unlink_framebuffer</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">remove_conflicting_framebuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">apertures_struct</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">bool</span> <span class="n">primary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">do_remove_conflicting_framebuffers</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">primary</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">remove_conflicting_framebuffers</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	register_framebuffer - registers a frame buffer device</span>
<span class="cm"> *	@fb_info: frame buffer info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Registers a frame buffer device @fb_info.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero for success.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">register_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_register_framebuffer</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	unregister_framebuffer - releases a frame buffer device</span>
<span class="cm"> *	@fb_info: frame buffer info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Unregisters a frame buffer device @fb_info.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero for success.</span>
<span class="cm"> *</span>
<span class="cm"> *      This function will also notify the framebuffer console</span>
<span class="cm"> *      to release the driver.</span>
<span class="cm"> *</span>
<span class="cm"> *      This is meant to be called within a driver&#39;s module_exit()</span>
<span class="cm"> *      function. If this is called outside module_exit(), ensure</span>
<span class="cm"> *      that the driver implements fb_open() and fb_release() to</span>
<span class="cm"> *      check that no processes are using the device.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">unregister_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_unregister_framebuffer</span><span class="p">(</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	fb_set_suspend - low level driver signals suspend</span>
<span class="cm"> *	@info: framebuffer affected</span>
<span class="cm"> *	@state: 0 = resuming, !=0 = suspending</span>
<span class="cm"> *</span>
<span class="cm"> *	This is meant to be used by low level drivers to</span>
<span class="cm"> * 	signal suspend/resume to the core &amp; clients.</span>
<span class="cm"> *	It must be called with the console semaphore held</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fb_set_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_SUSPEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FBINFO_STATE_SUSPENDED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">;</span>
		<span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_RESUME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	fbmem_init - init frame buffer subsystem</span>
<span class="cm"> *</span>
<span class="cm"> *	Initialize the frame buffer subsystem.</span>
<span class="cm"> *</span>
<span class="cm"> *	NOTE: This function is _only_ to be called by drivers/char/mem.c.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">fbmem_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;fb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_proc_fops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_chrdev</span><span class="p">(</span><span class="n">FB_MAJOR</span><span class="p">,</span><span class="s">&quot;fb&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fb_fops</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unable to get major %d for fb devs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FB_MAJOR</span><span class="p">);</span>

	<span class="n">fb_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;graphics&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fb_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to create fb class; errno = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fb_class</span><span class="p">));</span>
		<span class="n">fb_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">fbmem_init</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">fbmem_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;fb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">fb_class</span><span class="p">);</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">FB_MAJOR</span><span class="p">,</span> <span class="s">&quot;fb&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">fbmem_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer base&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">fbmem_init</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">fb_new_modelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_modelist</span> <span class="o">*</span><span class="n">modelist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modelist</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_modelist</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">modelist</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fb_set_var</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">);</span>
		<span class="n">fb_var_to_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="o">!</span><span class="n">fb_mode_is_equal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">event</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fb_notifier_call_chain</span><span class="p">(</span><span class="n">FB_EVENT_NEW_MODELIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">unlock_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">video_options</span><span class="p">[</span><span class="n">FB_MAX</span><span class="p">]</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ofonly</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * fb_get_options - get kernel boot parameters</span>
<span class="cm"> * @name:   framebuffer name as it would appear in</span>
<span class="cm"> *          the boot parameter line</span>
<span class="cm"> *          (video=&lt;name&gt;:&lt;options&gt;)</span>
<span class="cm"> * @option: the option will be stored here</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Needed to maintain backwards compatibility</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fb_get_options</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">&amp;&amp;</span> <span class="n">ofonly</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;offb&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FB_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">video_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">video_options</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">opt</span> <span class="o">=</span> <span class="n">video_options</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">name_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">opt</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
				<span class="n">options</span> <span class="o">=</span> <span class="n">opt</span> <span class="o">+</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">option</span><span class="p">)</span>
		<span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="cm">/**</span>
<span class="cm"> *	video_setup - process command line options</span>
<span class="cm"> *	@options: string of options</span>
<span class="cm"> *</span>
<span class="cm"> *	Process command line options for frame buffer subsystem.</span>
<span class="cm"> *</span>
<span class="cm"> *	NOTE: This function is a __setup and __init function.</span>
<span class="cm"> *            It only stores the options.  Drivers have to call</span>
<span class="cm"> *            fb_get_options() as necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns zero.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">video_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">global</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
 		<span class="n">global</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">global</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;ofonly&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
 		<span class="n">ofonly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 		<span class="n">global</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 	<span class="p">}</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">global</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strchr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>
 		<span class="n">fb_mode_option</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
 		<span class="n">global</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 	<span class="p">}</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">global</span><span class="p">)</span> <span class="p">{</span>
 		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FB_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
 			<span class="k">if</span> <span class="p">(</span><span class="n">video_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
 				<span class="n">video_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
 				<span class="k">break</span><span class="p">;</span>
 			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;video=&quot;</span><span class="p">,</span> <span class="n">video_setup</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="cm">/*</span>
<span class="cm">     *  Visible symbols for modules</span>
<span class="cm">     */</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">register_framebuffer</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unregister_framebuffer</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">num_registered_fb</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">registered_fb</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_show_logo</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_set_var</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_blank</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_pan_display</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_get_buffer_offset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_set_suspend</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_get_options</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
