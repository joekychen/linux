<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › mbx › mbxfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mbxfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/mbx/mbxfb.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006-2007 8D Technologies inc</span>
<span class="cm"> *  Raphael Assenat &lt;raph@8d.com&gt;</span>
<span class="cm"> *  	- Added video overlay support</span>
<span class="cm"> *  	- Various improvements</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Compulab, Ltd.</span>
<span class="cm"> *  Mike Rapoport &lt;mike@compulab.co.il&gt;</span>
<span class="cm"> *  	- Creation of driver</span>
<span class="cm"> *</span>
<span class="cm"> *   Based on pxafb.c</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   Intel 2700G (Marathon) Graphics Accelerator Frame Buffer Driver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;video/mbxfb.h&gt;</span>

<span class="cp">#include &quot;regs.h&quot;</span>
<span class="cp">#include &quot;reg_bits.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">virt_base_2700</span><span class="p">;</span>

<span class="cp">#define write_reg(val, reg) do { writel((val), (reg)); } while(0)</span>

<span class="cm">/* Without this delay, the graphics appears somehow scaled and</span>
<span class="cm"> * there is a lot of jitter in scanlines. This delay is probably</span>
<span class="cm"> * needed only after setting some specific register(s) somewhere,</span>
<span class="cm"> * not all over the place... */</span>
<span class="cp">#define write_reg_dly(val, reg) do { writel((val), reg); udelay(1000); } while(0)</span>

<span class="cp">#define MIN_XRES	16</span>
<span class="cp">#define MIN_YRES	16</span>
<span class="cp">#define MAX_XRES	2048</span>
<span class="cp">#define MAX_YRES	2048</span>

<span class="cp">#define MAX_PALETTES	16</span>

<span class="cm">/* FIXME: take care of different chip revisions with different sizes</span>
<span class="cm">   of ODFB */</span>
<span class="cp">#define MEMORY_OFFSET	0x60000</span>

<span class="k">struct</span> <span class="n">mbxfb_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">fb_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">fb_req</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">reg_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">reg_req</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fb_virt_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_phys_addr</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_virt_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_phys_addr</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">platform_probe</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span> <span class="n">fb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">platform_remove</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span> <span class="n">fb</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="n">MAX_PALETTES</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_FB_MBX_DEBUG</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">debugfs_data</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">mbxfb_default</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">33</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">mbxfb_fix</span>  <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;MBX&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pixclock_div</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">p</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mbxfb_get_pixclock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock_ps</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pixclock_div</span> <span class="o">*</span><span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_err</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">best_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ref_clk</span> <span class="o">=</span> <span class="mi">13000</span><span class="p">;</span>	<span class="cm">/* FIXME: take from platform data */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock</span><span class="p">;</span>

	<span class="cm">/* convert pixclock to KHz */</span>
	<span class="n">pixclock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">pixclock_ps</span><span class="p">);</span>

	<span class="cm">/* PLL output freq = (ref_clk * M) / (N * 2^P)</span>
<span class="cm">	 *</span>
<span class="cm">	 * M: 1 to 63</span>
<span class="cm">	 * N: 1 to 7</span>
<span class="cm">	 * P: 0 to 7</span>
<span class="cm">	 */</span>

	<span class="cm">/* RAPH: When N==1, the resulting pixel clock appears to</span>
<span class="cm">	 * get divided by 2. Preventing N=1 by starting the following</span>
<span class="cm">	 * loop at 2 prevents this. Is this a bug with my chip</span>
<span class="cm">	 * revision or something I dont understand? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref_clk</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">));</span>
				<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk</span> <span class="o">&gt;</span> <span class="n">pixclock</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">clk</span> <span class="o">-</span> <span class="n">pixclock</span><span class="p">)</span> <span class="o">:</span>
					<span class="p">(</span><span class="n">pixclock</span> <span class="o">-</span> <span class="n">clk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">min_err</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">min_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
					<span class="n">best_clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
					<span class="n">div</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
					<span class="n">div</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
					<span class="n">div</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="n">best_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="n">MAX_PALETTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
		<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pixclock_div</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">mbxfb_get_pixclock</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">MIN_XRES</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">MIN_XRES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">MIN_YRES</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">MIN_YRES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">MAX_XRES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">MAX_YRES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 8 bits-per-pixel is not supported yet */</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:		<span class="cm">/* RGB 888   */</span>
	<span class="k">case</span> <span class="mi">32</span>:		<span class="cm">/* RGBA 8888 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">-</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">?</span> <span class="mi">24</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pixclock_div</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">hbps</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">hfps</span><span class="p">,</span> <span class="n">has</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">vbps</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="n">vfps</span><span class="p">,</span> <span class="n">vas</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gsctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">GSCTRL</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gsadr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">GSADR</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* setup color mode */</span>
	<span class="n">gsctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">GSCTRL_GPIXFMT</span><span class="p">));</span>
	<span class="cm">/* FIXME: add *WORKING* support for 8-bits per color */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="n">gsctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GSCTRL_LUT_EN</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_ARGB1555</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_RGB565</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_RGB888</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_ARGB8888</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* setup resolution */</span>
	<span class="n">gsctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">GSCTRL_GSWIDTH</span><span class="p">)</span> <span class="o">|</span> <span class="n">FMsk</span><span class="p">(</span><span class="n">GSCTRL_GSHEIGHT</span><span class="p">));</span>
	<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">Gsctrl_Width</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">Gsctrl_Height</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">gsctrl</span><span class="p">,</span> <span class="n">GSCTRL</span><span class="p">);</span>

	<span class="n">gsadr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">GSADR_SRCSTRIDE</span><span class="p">));</span>
	<span class="n">gsadr</span> <span class="o">|=</span> <span class="n">Gsadr_Srcstride</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span>
				 <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">gsadr</span><span class="p">,</span> <span class="n">GSADR</span><span class="p">);</span>

	<span class="cm">/* setup timings */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">mbxfb_get_pixclock</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Disp_Pll_M</span><span class="p">(</span><span class="n">div</span><span class="p">.</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="n">Disp_Pll_N</span><span class="p">(</span><span class="n">div</span><span class="p">.</span><span class="n">n</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">Disp_Pll_P</span><span class="p">(</span><span class="n">div</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="o">|</span> <span class="n">DISP_PLL_EN</span><span class="p">),</span> <span class="n">DISPPLL</span><span class="p">);</span>

	<span class="n">hbps</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">has</span> <span class="o">=</span> <span class="n">hbps</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">hfps</span> <span class="o">=</span> <span class="n">has</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">ht</span> <span class="o">=</span> <span class="n">hfps</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>

	<span class="n">vbps</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">vas</span> <span class="o">=</span> <span class="n">vbps</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">vfps</span> <span class="o">=</span> <span class="n">vas</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">vt</span> <span class="o">=</span> <span class="n">vfps</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>

	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dht01_Hbps</span><span class="p">(</span><span class="n">hbps</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dht01_Ht</span><span class="p">(</span><span class="n">ht</span><span class="p">)),</span> <span class="n">DHT01</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dht02_Hlbs</span><span class="p">(</span><span class="n">has</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dht02_Has</span><span class="p">(</span><span class="n">has</span><span class="p">)),</span> <span class="n">DHT02</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dht03_Hfps</span><span class="p">(</span><span class="n">hfps</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dht03_Hrbs</span><span class="p">(</span><span class="n">hfps</span><span class="p">)),</span> <span class="n">DHT03</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dhdet_Hdes</span><span class="p">(</span><span class="n">has</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dhdet_Hdef</span><span class="p">(</span><span class="n">hfps</span><span class="p">)),</span> <span class="n">DHDET</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dvt01_Vbps</span><span class="p">(</span><span class="n">vbps</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dvt01_Vt</span><span class="p">(</span><span class="n">vt</span><span class="p">)),</span> <span class="n">DVT01</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dvt02_Vtbs</span><span class="p">(</span><span class="n">vas</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dvt02_Vas</span><span class="p">(</span><span class="n">vas</span><span class="p">)),</span> <span class="n">DVT02</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dvt03_Vfps</span><span class="p">(</span><span class="n">vfps</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dvt03_Vbbs</span><span class="p">(</span><span class="n">vfps</span><span class="p">)),</span> <span class="n">DVT03</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dvdet_Vdes</span><span class="p">(</span><span class="n">vas</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dvdet_Vdef</span><span class="p">(</span><span class="n">vfps</span><span class="p">)),</span> <span class="n">DVDET</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Dvectrl_Vevent</span><span class="p">(</span><span class="n">vfps</span><span class="p">)</span> <span class="o">|</span> <span class="n">Dvectrl_Vfetch</span><span class="p">(</span><span class="n">vbps</span><span class="p">)),</span> <span class="n">DVECTRL</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">DSCTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DSCTRL_SYNCGEN_EN</span><span class="p">),</span> <span class="n">DSCTRL</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">DINTRE_VEVENT0_EN</span><span class="p">,</span> <span class="n">DINTRE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">DSCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DSCTRL_SYNCGEN_EN</span><span class="p">),</span> <span class="n">DSCTRL</span><span class="p">);</span>
		<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PIXCLK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIXCLK_EN</span><span class="p">),</span> <span class="n">PIXCLK</span><span class="p">);</span>
		<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">VOVRCLK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VOVRCLK_EN</span><span class="p">),</span> <span class="n">VOVRCLK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">DSCTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DSCTRL_SYNCGEN_EN</span><span class="p">),</span> <span class="n">DSCTRL</span><span class="p">);</span>
		<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PIXCLK</span><span class="p">)</span> <span class="o">|</span> <span class="n">PIXCLK_EN</span><span class="p">),</span> <span class="n">PIXCLK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_setupOverlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_overlaySetup</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vsctrl</span><span class="p">,</span> <span class="n">vscadr</span><span class="p">,</span> <span class="n">vsadr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sssize</span><span class="p">,</span> <span class="n">spoctrl</span><span class="p">,</span> <span class="n">shctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vubase</span><span class="p">,</span> <span class="n">vvbase</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vovrclk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_width</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_height</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* read registers which have reserved bits</span>
<span class="cm">	 * so we can write them back as-is. */</span>
	<span class="n">vovrclk</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VOVRCLK</span><span class="p">);</span>
	<span class="n">vsctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VSCTRL</span><span class="p">);</span>
	<span class="n">vscadr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VSCADR</span><span class="p">);</span>
	<span class="n">vubase</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VUBASE</span><span class="p">);</span>
	<span class="n">vvbase</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VVBASE</span><span class="p">);</span>
	<span class="n">shctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SHCTRL</span><span class="p">);</span>

	<span class="n">spoctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SPOCTRL</span><span class="p">);</span>
	<span class="n">sssize</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SSSIZE</span><span class="p">);</span>

	<span class="n">vsctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span>	<span class="n">FMsk</span><span class="p">(</span><span class="n">VSCTRL_VSWIDTH</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">FMsk</span><span class="p">(</span><span class="n">VSCTRL_VSHEIGHT</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">FMsk</span><span class="p">(</span><span class="n">VSCTRL_VPIXFMT</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">VSCTRL_GAMMA_EN</span> <span class="o">|</span> <span class="n">VSCTRL_CSC_EN</span> <span class="o">|</span>
					<span class="n">VSCTRL_COSITED</span> <span class="p">);</span>
	<span class="n">vsctrl</span> <span class="o">|=</span> <span class="n">Vsctrl_Width</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">|</span> <span class="n">Vsctrl_Height</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">VSCTRL_CSC_EN</span><span class="p">;</span>

	<span class="n">vscadr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VSCADR_STR_EN</span> <span class="o">|</span> <span class="n">FMsk</span><span class="p">(</span><span class="n">VSCADR_VBASE_ADR</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">vubase</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VUBASE_UVHALFSTR</span> <span class="o">|</span> <span class="n">FMsk</span><span class="p">(</span><span class="n">VUBASE_UBASE_ADR</span><span class="p">));</span>
	<span class="n">vvbase</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">VVBASE_VBASE_ADR</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBXFB_FMT_YUV16</span>:
		<span class="n">vsctrl</span> <span class="o">|=</span> <span class="n">VSCTRL_VPIXFMT_YUV12</span><span class="p">;</span>

		<span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span> <span class="o">=</span> <span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xf</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_FMT_YUV12</span>:
		<span class="n">vsctrl</span> <span class="o">|=</span> <span class="n">VSCTRL_VPIXFMT_YUV12</span><span class="p">;</span>

		<span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span> <span class="o">=</span> <span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xf</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
		<span class="n">vubase</span> <span class="o">|=</span> <span class="n">VUBASE_UVHALFSTR</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_FMT_UY0VY1</span>:
		<span class="n">vsctrl</span> <span class="o">|=</span> <span class="n">VSCTRL_VPIXFMT_UY0VY1</span><span class="p">;</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mh">0xf</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_FMT_VY0UY1</span>:
		<span class="n">vsctrl</span> <span class="o">|=</span> <span class="n">VSCTRL_VPIXFMT_VY0UY1</span><span class="p">;</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mh">0xf</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_FMT_Y0UY1V</span>:
		<span class="n">vsctrl</span> <span class="o">|=</span> <span class="n">VSCTRL_VPIXFMT_Y0UY1V</span><span class="p">;</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mh">0xf</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_FMT_Y0VY1U</span>:
		<span class="n">vsctrl</span> <span class="o">|=</span> <span class="n">VSCTRL_VPIXFMT_Y0VY1U</span><span class="p">;</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mh">0xf</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* VSCTRL has the bits which sets the Video Pixel Format.</span>
<span class="cm">	 * When passing from a packed to planar format,</span>
<span class="cm">	 * if we write VSCTRL first, VVBASE and VUBASE would</span>
<span class="cm">	 * be zero if we would not set them here. (And then,</span>
<span class="cm">	 * the chips hangs and only a reset seems to fix it).</span>
<span class="cm">	 *</span>
<span class="cm">	 * If course, the values calculated here have no meaning</span>
<span class="cm">	 * for packed formats.</span>
<span class="cm">	 */</span>
	<span class="n">set</span><span class="o">-&gt;</span><span class="n">UV_stride</span> <span class="o">=</span> <span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x7</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">U_offset</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span><span class="p">;</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">V_offset</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">U_offset</span> <span class="o">+</span>
						<span class="n">set</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">UV_stride</span><span class="p">;</span>
	<span class="n">vubase</span> <span class="o">|=</span> <span class="n">Vubase_Ubase_Adr</span><span class="p">(</span>
			<span class="p">(</span><span class="mh">0x60000</span> <span class="o">+</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">mem_offset</span> <span class="o">+</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">U_offset</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">vvbase</span> <span class="o">|=</span> <span class="n">Vvbase_Vbase_Adr</span><span class="p">(</span>
			<span class="p">(</span><span class="mh">0x60000</span> <span class="o">+</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">mem_offset</span> <span class="o">+</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">V_offset</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">);</span>


	<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">Vscadr_Vbase_Adr</span><span class="p">((</span><span class="mh">0x60000</span> <span class="o">+</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">mem_offset</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_STR_EN</span><span class="p">;</span>


	<span class="n">vsadr</span> <span class="o">=</span> <span class="n">Vsadr_Srcstride</span><span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">Y_stride</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">Vsadr_Xstart</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">Vsadr_Ystart</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>

	<span class="n">sssize</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">SSSIZE_SC_WIDTH</span><span class="p">)</span> <span class="o">|</span> <span class="n">FMsk</span><span class="p">(</span><span class="n">SSSIZE_SC_HEIGHT</span><span class="p">));</span>
	<span class="n">sssize</span> <span class="o">=</span> <span class="n">Sssize_Sc_Width</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_width</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">Sssize_Sc_Height</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_height</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">spoctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SPOCTRL_H_SC_BP</span> <span class="o">|</span> <span class="n">SPOCTRL_V_SC_BP</span> <span class="o">|</span>
			<span class="n">SPOCTRL_HV_SC_OR</span> <span class="o">|</span> <span class="n">SPOCTRL_VS_UR_C</span> <span class="o">|</span>
			<span class="n">FMsk</span><span class="p">(</span><span class="n">SPOCTRL_VPITCH</span><span class="p">));</span>
	<span class="n">spoctrl</span> <span class="o">|=</span> <span class="n">Spoctrl_Vpitch</span><span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">/</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_height</span><span class="p">);</span>

	<span class="cm">/* Bypass horiz/vert scaler when same size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_width</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
		<span class="n">spoctrl</span> <span class="o">|=</span> <span class="n">SPOCTRL_H_SC_BP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_height</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="n">spoctrl</span> <span class="o">|=</span> <span class="n">SPOCTRL_V_SC_BP</span><span class="p">;</span>

	<span class="n">shctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">SHCTRL_HPITCH</span><span class="p">)</span> <span class="o">|</span> <span class="n">SHCTRL_HDECIM</span><span class="p">);</span>
	<span class="n">shctrl</span> <span class="o">|=</span> <span class="n">Shctrl_Hpitch</span><span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span><span class="o">/</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">scaled_width</span><span class="p">);</span>

	<span class="cm">/* Video plane registers */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">vsctrl</span><span class="p">,</span> <span class="n">VSCTRL</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">vscadr</span><span class="p">,</span> <span class="n">VSCADR</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">vubase</span><span class="p">,</span> <span class="n">VUBASE</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">vvbase</span><span class="p">,</span> <span class="n">VVBASE</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">vsadr</span><span class="p">,</span> <span class="n">VSADR</span><span class="p">);</span>

	<span class="cm">/* Video scaler registers */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">sssize</span><span class="p">,</span> <span class="n">SSSIZE</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">spoctrl</span><span class="p">,</span> <span class="n">SPOCTRL</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">shctrl</span><span class="p">,</span> <span class="n">SHCTRL</span><span class="p">);</span>

	<span class="cm">/* Clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">vovrclk</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vovrclk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">vovrclk</span><span class="p">,</span> <span class="n">VOVRCLK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_ioctl_planeorder</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_planeorder</span> <span class="o">*</span><span class="n">porder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gscadr</span><span class="p">,</span> <span class="n">vscadr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">porder</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">==</span> <span class="n">porder</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">gscadr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">GSCADR</span><span class="p">);</span>
	<span class="n">vscadr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VSCADR</span><span class="p">);</span>

	<span class="n">gscadr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">GSCADR_BLEND_POS</span><span class="p">));</span>
	<span class="n">vscadr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">VSCADR_BLEND_POS</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">porder</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBXFB_PLANE_GRAPHICS</span>:
		<span class="n">gscadr</span> <span class="o">|=</span> <span class="n">GSCADR_BLEND_GFX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_PLANE_VIDEO</span>:
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_BLEND_GFX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">porder</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBXFB_PLANE_GRAPHICS</span>:
		<span class="n">gscadr</span> <span class="o">|=</span> <span class="n">GSCADR_BLEND_VID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_PLANE_VIDEO</span>:
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">GSCADR_BLEND_VID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">vscadr</span><span class="p">,</span> <span class="n">VSCADR</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">gscadr</span><span class="p">,</span> <span class="n">GSCADR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_ioctl_alphactl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_alphaCtl</span> <span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vscadr</span><span class="p">,</span> <span class="n">vbbase</span><span class="p">,</span> <span class="n">vcmsk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gscadr</span><span class="p">,</span> <span class="n">gbbase</span><span class="p">,</span> <span class="n">gdrctrl</span><span class="p">;</span>

	<span class="n">vbbase</span> <span class="o">=</span> <span class="n">Vbbase_Glalpha</span><span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">overlay_global_alpha</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">Vbbase_Colkey</span><span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">overlay_colorkey</span><span class="p">);</span>

	<span class="n">gbbase</span> <span class="o">=</span> <span class="n">Gbbase_Glalpha</span><span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">graphics_global_alpha</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">Gbbase_Colkey</span><span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">graphics_colorkey</span><span class="p">);</span>

	<span class="n">vcmsk</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VCMSK</span><span class="p">);</span>
	<span class="n">vcmsk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">VCMSK_COLKEY_M</span><span class="p">));</span>
	<span class="n">vcmsk</span> <span class="o">|=</span> <span class="n">Vcmsk_colkey_m</span><span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">overlay_colorkey_mask</span><span class="p">);</span>

	<span class="n">gdrctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">GDRCTRL</span><span class="p">);</span>
	<span class="n">gdrctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">GDRCTRL_COLKEYM</span><span class="p">));</span>
	<span class="n">gdrctrl</span> <span class="o">|=</span> <span class="n">Gdrctrl_Colkeym</span><span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">graphics_colorkey_mask</span><span class="p">);</span>

	<span class="n">vscadr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VSCADR</span><span class="p">);</span>
	<span class="n">vscadr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">VSCADR_BLEND_M</span><span class="p">)</span> <span class="o">|</span> <span class="n">VSCADR_COLKEYSRC</span> <span class="o">|</span> <span class="n">VSCADR_COLKEY_EN</span><span class="p">);</span>

	<span class="n">gscadr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">GSCADR</span><span class="p">);</span>
	<span class="n">gscadr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">GSCADR_BLEND_M</span><span class="p">)</span> <span class="o">|</span> <span class="n">GSCADR_COLKEY_EN</span> <span class="o">|</span> <span class="n">GSCADR_COLKEYSRC</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">overlay_colorkey_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBXFB_COLORKEY_DISABLED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_COLORKEY_PREVIOUS</span>:
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_COLKEY_EN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_COLORKEY_CURRENT</span>:
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_COLKEY_EN</span> <span class="o">|</span> <span class="n">VSCADR_COLKEYSRC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">overlay_blend_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBXFB_ALPHABLEND_NONE</span>:
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_BLEND_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_ALPHABLEND_GLOBAL</span>:
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_BLEND_GLOB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_ALPHABLEND_PIXEL</span>:
		<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_BLEND_PIX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">graphics_colorkey_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBXFB_COLORKEY_DISABLED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_COLORKEY_PREVIOUS</span>:
		<span class="n">gscadr</span> <span class="o">|=</span> <span class="n">GSCADR_COLKEY_EN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_COLORKEY_CURRENT</span>:
		<span class="n">gscadr</span> <span class="o">|=</span> <span class="n">GSCADR_COLKEY_EN</span> <span class="o">|</span> <span class="n">GSCADR_COLKEYSRC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">alpha</span><span class="o">-&gt;</span><span class="n">graphics_blend_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBXFB_ALPHABLEND_NONE</span>:
		<span class="n">gscadr</span> <span class="o">|=</span> <span class="n">GSCADR_BLEND_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_ALPHABLEND_GLOBAL</span>:
		<span class="n">gscadr</span> <span class="o">|=</span> <span class="n">GSCADR_BLEND_GLOB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBXFB_ALPHABLEND_PIXEL</span>:
		<span class="n">gscadr</span> <span class="o">|=</span> <span class="n">GSCADR_BLEND_PIX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">vbbase</span><span class="p">,</span> <span class="n">VBBASE</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">gbbase</span><span class="p">,</span> <span class="n">GBBASE</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">vcmsk</span><span class="p">,</span> <span class="n">VCMSK</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">gdrctrl</span><span class="p">,</span> <span class="n">GDRCTRL</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">gscadr</span><span class="p">,</span> <span class="n">GSCADR</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">vscadr</span><span class="p">,</span> <span class="n">VSCADR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mbxfb_overlaySetup</span>	<span class="n">setup</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mbxfb_planeorder</span> 	<span class="n">porder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mbxfb_alphaCtl</span> 		<span class="n">alpha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mbxfb_reg</span>			<span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MBXFB_IOCX_OVERLAY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_overlaySetup</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="n">res</span> <span class="o">=</span> <span class="n">mbxfb_setupOverlay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_overlaySetup</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBXFB_IOCS_PLANEORDER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">porder</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_planeorder</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">mbxfb_ioctl_planeorder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">porder</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">MBXFB_IOCS_ALPHA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alpha</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_alphaCtl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">mbxfb_ioctl_alphactl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alpha</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">MBXFB_IOCS_REG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_reg</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="cm">/* regs are from 0x3fe0000 to 0x3feffff */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">virt_base_2700</span> <span class="o">+</span> <span class="n">reg</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">reg</span><span class="p">.</span><span class="n">mask</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">reg</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">reg</span><span class="p">.</span><span class="n">mask</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">virt_base_2700</span> <span class="o">+</span> <span class="n">reg</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MBXFB_IOCX_REG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_reg</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span>	<span class="cm">/* regs are from 0x3fe0000 to 0x3feffff */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">reg</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">virt_base_2700</span> <span class="o">+</span> <span class="n">reg</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_reg</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">mbxfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">mbxfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> <span class="o">=</span> <span class="n">mbxfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="n">mbxfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span> <span class="n">mbxfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span> <span class="o">=</span> <span class="n">mbxfb_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">  Enable external SDRAM controller. Assume that all clocks are active</span>
<span class="cm">  by now.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">setup_memc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* FIXME: use platform specific parameters */</span>
	<span class="cm">/* setup SDRAM controller */</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">LMCFG_LMC_DS</span> <span class="o">|</span> <span class="n">LMCFG_LMC_TS</span> <span class="o">|</span> <span class="n">LMCFG_LMD_TS</span> <span class="o">|</span>
		<span class="n">LMCFG_LMA_TS</span><span class="p">),</span>
	       <span class="n">LMCFG</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">LMPWR_MC_PWR_ACT</span><span class="p">,</span> <span class="n">LMPWR</span><span class="p">);</span>

	<span class="cm">/* setup SDRAM timings */</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Lmtim_Tras</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">Lmtim_Trp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">Lmtim_Trcd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">Lmtim_Trc</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">Lmtim_Tdpl</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
	       <span class="n">LMTIM</span><span class="p">);</span>
	<span class="cm">/* setup SDRAM refresh rate */</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0xc2b</span><span class="p">,</span> <span class="n">LMREFRESH</span><span class="p">);</span>
	<span class="cm">/* setup SDRAM type parameters */</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">LMTYPE_CASLAT_3</span> <span class="o">|</span> <span class="n">LMTYPE_BKSZ_2</span> <span class="o">|</span> <span class="n">LMTYPE_ROWSZ_11</span> <span class="o">|</span>
		<span class="n">LMTYPE_COLSZ_8</span><span class="p">),</span>
	       <span class="n">LMTYPE</span><span class="p">);</span>
	<span class="cm">/* enable memory controller */</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">LMPWR_MC_PWR_ACT</span><span class="p">,</span> <span class="n">LMPWR</span><span class="p">);</span>
	<span class="cm">/* perform dummy reads */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable clocks */</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">SYSCLKSRC_PLL_2</span><span class="p">,</span> <span class="n">SYSCLKSRC</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">PIXCLKSRC_PLL_1</span><span class="p">,</span> <span class="n">PIXCLKSRC</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">CLKSLEEP</span><span class="p">);</span>

	<span class="cm">/* PLL output = (Frefclk * M) / (N * 2^P )</span>
<span class="cm">	 *</span>
<span class="cm">	 * M: 0x17, N: 0x3, P: 0x0 == 100 Mhz!</span>
<span class="cm">	 * M: 0xb, N: 0x1, P: 0x1 == 71 Mhz</span>
<span class="cm">	 * */</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Core_Pll_M</span><span class="p">(</span><span class="mh">0xb</span><span class="p">)</span> <span class="o">|</span> <span class="n">Core_Pll_N</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span> <span class="n">Core_Pll_P</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">CORE_PLL_EN</span><span class="p">),</span>
	       <span class="n">COREPLL</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">Disp_Pll_M</span><span class="p">(</span><span class="mh">0x1b</span><span class="p">)</span> <span class="o">|</span> <span class="n">Disp_Pll_N</span><span class="p">(</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">|</span> <span class="n">Disp_Pll_P</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">DISP_PLL_EN</span><span class="p">),</span>
	       <span class="n">DISPPLL</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">VOVRCLK</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">PIXCLK_EN</span><span class="p">,</span> <span class="n">PIXCLK</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">MEMCLK_EN</span><span class="p">,</span> <span class="n">MEMCLK</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">M24CLK</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">MBXCLK</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">SDCLK_EN</span><span class="p">,</span> <span class="n">SDCLK</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">PIXCLKDIV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">setup_graphics</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gsctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vscadr</span><span class="p">;</span>

	<span class="n">gsctrl</span> <span class="o">=</span> <span class="n">GSCTRL_GAMMA_EN</span> <span class="o">|</span> <span class="n">Gsctrl_Width</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">Gsctrl_Height</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_ARGB1555</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_RGB565</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_RGB888</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">gsctrl</span> <span class="o">|=</span> <span class="n">GSCTRL_GPIXFMT_ARGB8888</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">gsctrl</span><span class="p">,</span> <span class="n">GSCTRL</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">GBBASE</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00ffffff</span><span class="p">,</span> <span class="n">GDRCTRL</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">GSCADR_STR_EN</span> <span class="o">|</span> <span class="n">Gscadr_Gbase_Adr</span><span class="p">(</span><span class="mh">0x6000</span><span class="p">)),</span> <span class="n">GSCADR</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">GPLUT</span><span class="p">);</span>

	<span class="n">vscadr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">VSCADR</span><span class="p">);</span>
	<span class="n">vscadr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">VSCADR_BLEND_POS</span><span class="p">)</span> <span class="o">|</span> <span class="n">FMsk</span><span class="p">(</span><span class="n">VSCADR_BLEND_M</span><span class="p">));</span>
	<span class="n">vscadr</span> <span class="o">|=</span> <span class="n">VSCADR_BLEND_VID</span> <span class="o">|</span> <span class="n">VSCADR_BLEND_NONE</span><span class="p">;</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">vscadr</span><span class="p">,</span> <span class="n">VSCADR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">setup_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dsctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dsctrl</span> <span class="o">=</span> <span class="n">DSCTRL_BLNK_POL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">dsctrl</span> <span class="o">|=</span> <span class="n">DSCTRL_HS_POL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">dsctrl</span> <span class="o">|=</span> <span class="n">DSCTRL_VS_POL</span><span class="p">;</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">dsctrl</span><span class="p">,</span> <span class="n">DSCTRL</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0xd0303010</span><span class="p">,</span> <span class="n">DMCTRL</span><span class="p">);</span>
	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">DSCTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DSCTRL_SYNCGEN_EN</span><span class="p">),</span> <span class="n">DSCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">enable_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">svctrl</span><span class="p">,</span> <span class="n">shctrl</span><span class="p">;</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">SYSRST_RST</span><span class="p">,</span> <span class="n">SYSRST</span><span class="p">);</span>

	<span class="cm">/* setup a timeout, raise drive strength */</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="mh">0xffffff0c</span><span class="p">,</span> <span class="n">SYSCFG</span><span class="p">);</span>

	<span class="n">enable_clocks</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">setup_memc</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">setup_graphics</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">setup_display</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">shctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SHCTRL</span><span class="p">);</span>
	<span class="n">shctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMsk</span><span class="p">(</span><span class="n">SHCTRL_HINITIAL</span><span class="p">));</span>
	<span class="n">shctrl</span> <span class="o">|=</span> <span class="n">Shctrl_Hinitial</span><span class="p">(</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">shctrl</span><span class="p">,</span> <span class="n">SHCTRL</span><span class="p">);</span>

	<span class="n">svctrl</span> <span class="o">=</span> <span class="n">Svctrl_Initial1</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">Svctrl_Initial2</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">svctrl</span><span class="p">,</span> <span class="n">SVCTRL</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">SPOCTRL_H_SC_BP</span> <span class="o">|</span> <span class="n">SPOCTRL_V_SC_BP</span> <span class="o">|</span> <span class="n">SPOCTRL_VORDER_4TAP</span>
			<span class="p">,</span> <span class="n">SPOCTRL</span><span class="p">);</span>

	<span class="cm">/* Those coefficients are good for scaling up. For scaling</span>
<span class="cm">	 * down, the application has to calculate them. */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0xff000100</span><span class="p">,</span> <span class="n">VSCOEFF0</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0xfdfcfdfe</span><span class="p">,</span> <span class="n">VSCOEFF1</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x170d0500</span><span class="p">,</span> <span class="n">VSCOEFF2</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x3d372d22</span><span class="p">,</span> <span class="n">VSCOEFF3</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x00000040</span><span class="p">,</span> <span class="n">VSCOEFF4</span><span class="p">);</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0xff010100</span><span class="p">,</span> <span class="n">HSCOEFF0</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">HSCOEFF1</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x02010000</span><span class="p">,</span> <span class="n">HSCOEFF2</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x01020302</span><span class="p">,</span> <span class="n">HSCOEFF3</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0xf9fbfe00</span><span class="p">,</span> <span class="n">HSCOEFF4</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0xfbf7f6f7</span><span class="p">,</span> <span class="n">HSCOEFF5</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x1c110700</span><span class="p">,</span> <span class="n">HSCOEFF6</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x3e393127</span><span class="p">,</span> <span class="n">HSCOEFF7</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mh">0x00000040</span><span class="p">,</span> <span class="n">HSCOEFF8</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * Power management hooks.  Note that we won&#39;t be called from IRQ context,</span>
<span class="cm"> * unlike the blank functions above, so we may sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* make frame buffer memory enter self-refresh mode */</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">LMPWR_MC_PWR_SRM</span><span class="p">,</span> <span class="n">LMPWR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">LMPWRSTAT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LMPWRSTAT_MC_PWR_SRM</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* empty statement */</span>

	<span class="cm">/* reset the device, since it&#39;s initial state is &#39;mostly sleeping&#39; */</span>
	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">SYSRST_RST</span><span class="p">,</span> <span class="n">SYSRST</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mbxfb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">enable_clocks</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
<span class="cm">/* 	setup_graphics(fbi); */</span>
<span class="cm">/* 	setup_display(fbi); */</span>

	<span class="n">write_reg_dly</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">DSCTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DSCTRL_SYNCGEN_EN</span><span class="p">),</span> <span class="n">DSCTRL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define mbxfb_suspend	NULL</span>
<span class="cp">#define mbxfb_resume	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* debugfs entries */</span>
<span class="cp">#ifndef CONFIG_FB_MBX_DEBUG</span>
<span class="cp">#define mbxfb_debugfs_init(x)	do {} while(0)</span>
<span class="cp">#define mbxfb_debugfs_remove(x)	do {} while(0)</span>
<span class="cp">#endif</span>

<span class="cp">#define res_size(_r) (((_r)-&gt;end - (_r)-&gt;start) + 1)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mbxfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mbxfb_info</span> <span class="o">*</span><span class="n">mfbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mbxfb_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mbxfb_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform data is required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbxfb_info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;framebuffer_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mfbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">platform_probe</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">platform_remove</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">;</span>

	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_res</span> <span class="o">||</span> <span class="o">!</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no resources found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_req</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					  <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_res</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to claim framebuffer memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_phys_addr</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_req</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					   <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_res</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to claim Marathon registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_phys_addr</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_virt_addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_phys_addr</span><span class="p">,</span>
					      <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_req</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_virt_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to ioremap Marathon registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">virt_base_2700</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_virt_addr</span><span class="p">;</span>

	<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_virt_addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_phys_addr</span><span class="p">,</span>
					     <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_req</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_virt_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to ioremap frame buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_virt_addr</span> <span class="o">+</span> <span class="mh">0x60000</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbxfb_ops</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">mbxfb_default</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">mbxfb_fix</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_phys_addr</span> <span class="o">+</span> <span class="mh">0x60000</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">mbxfb_default</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span>
					<span class="n">mbxfb_default</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fb_alloc_cmap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: mbx frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">platform_probe</span><span class="p">)</span>
		<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">platform_probe</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">enable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">mbxfb_debugfs_init</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;register_framebuffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err6:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">err5:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_virt_addr</span><span class="p">);</span>
<span class="nl">err4:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_virt_addr</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_res</span><span class="p">));</span>
<span class="nl">err2:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_res</span><span class="p">));</span>
<span class="nl">err1:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">mbxfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_reg_dly</span><span class="p">(</span><span class="n">SYSRST_RST</span><span class="p">,</span> <span class="n">SYSRST</span><span class="p">);</span>

	<span class="n">mbxfb_debugfs_remove</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mbxfb_info</span> <span class="o">*</span><span class="n">mfbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">platform_remove</span><span class="p">)</span>
				<span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">platform_remove</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_virt_addr</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_virt_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_virt_addr</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_virt_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_req</span><span class="p">)</span>
				<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_req</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						   <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">reg_req</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_req</span><span class="p">)</span>
				<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_req</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						   <span class="n">res_size</span><span class="p">(</span><span class="n">mfbi</span><span class="o">-&gt;</span><span class="n">fb_req</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mbxfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mbxfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mbxfb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">mbxfb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">mbxfb_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mbx-fb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mbxfb_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;loadable framebuffer driver for Marathon device&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mike Rapoport, Compulab&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
