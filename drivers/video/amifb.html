<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › amifb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>amifb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/amifb.c -- Amiga builtin chipset frame buffer device</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 1995-2003 Geert Uytterhoeven</span>
<span class="cm"> *</span>
<span class="cm"> *          with work by Roman Zippel</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This file is based on the Atari frame buffer device (atafb.c):</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 1994 Martin Schaller</span>
<span class="cm"> *                       Roman Hodek</span>
<span class="cm"> *</span>
<span class="cm"> *          with work by Andreas Schwab</span>
<span class="cm"> *                       Guenther Kelleter</span>
<span class="cm"> *</span>
<span class="cm"> * and on the original Amiga console driver (amicon.c):</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 1993 Hamish Macdonald</span>
<span class="cm"> *                       Greg Harp</span>
<span class="cm"> *    Copyright (C) 1994 David Carter [carter@compsci.bristol.ac.uk]</span>
<span class="cm"> *</span>
<span class="cm"> *          with work by William Rucklidge (wjr@cs.cornell.edu)</span>
<span class="cm"> *                       Geert Uytterhoeven</span>
<span class="cm"> *                       Jes Sorensen (jds@kom.auc.dk)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> *</span>
<span class="cm"> *   - 24 Jul 96: Copper generates now vblank interrupt and</span>
<span class="cm"> *                VESA Power Saving Protocol is fully implemented</span>
<span class="cm"> *   - 14 Jul 96: Rework and hopefully last ECS bugs fixed</span>
<span class="cm"> *   -  7 Mar 96: Hardware sprite support by Roman Zippel</span>
<span class="cm"> *   - 18 Feb 96: OCS and ECS support by Roman Zippel</span>
<span class="cm"> *                Hardware functions completely rewritten</span>
<span class="cm"> *   -  2 Dec 95: AGA version by Geert Uytterhoeven</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License. See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/amigahw.h&gt;</span>
<span class="cp">#include &lt;asm/amigaints.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="cp">#include &quot;c2p.h&quot;</span>


<span class="cp">#define DEBUG</span>

<span class="cp">#if !defined(CONFIG_FB_AMIGA_OCS) &amp;&amp; !defined(CONFIG_FB_AMIGA_ECS) &amp;&amp; !defined(CONFIG_FB_AMIGA_AGA)</span>
<span class="cp">#define CONFIG_FB_AMIGA_OCS   </span><span class="cm">/* define at least one fb driver, this will change later */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(CONFIG_FB_AMIGA_OCS)</span>
<span class="cp">#  define IS_OCS (0)</span>
<span class="cp">#elif defined(CONFIG_FB_AMIGA_ECS) || defined(CONFIG_FB_AMIGA_AGA)</span>
<span class="cp">#  define IS_OCS (chipset == TAG_OCS)</span>
<span class="cp">#else</span>
<span class="cp">#  define CONFIG_FB_AMIGA_OCS_ONLY</span>
<span class="cp">#  define IS_OCS (1)</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(CONFIG_FB_AMIGA_ECS)</span>
<span class="cp">#  define IS_ECS (0)</span>
<span class="cp">#elif defined(CONFIG_FB_AMIGA_OCS) || defined(CONFIG_FB_AMIGA_AGA)</span>
<span class="cp">#  define IS_ECS (chipset == TAG_ECS)</span>
<span class="cp">#else</span>
<span class="cp">#  define CONFIG_FB_AMIGA_ECS_ONLY</span>
<span class="cp">#  define IS_ECS (1)</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(CONFIG_FB_AMIGA_AGA)</span>
<span class="cp">#  define IS_AGA (0)</span>
<span class="cp">#elif defined(CONFIG_FB_AMIGA_OCS) || defined(CONFIG_FB_AMIGA_ECS)</span>
<span class="cp">#  define IS_AGA (chipset == TAG_AGA)</span>
<span class="cp">#else</span>
<span class="cp">#  define CONFIG_FB_AMIGA_AGA_ONLY</span>
<span class="cp">#  define IS_AGA (1)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#  define DPRINTK(fmt, args...)	printk(KERN_DEBUG &quot;%s: &quot; fmt, __func__ , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#  define DPRINTK(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cm">/*******************************************************************************</span>


<span class="cm">   Generic video timings</span>
<span class="cm">   ---------------------</span>

<span class="cm">   Timings used by the frame buffer interface:</span>

<span class="cm">   +----------+---------------------------------------------+----------+-------+</span>
<span class="cm">   |          |                ^                            |          |       |</span>
<span class="cm">   |          |                |upper_margin                |          |       |</span>
<span class="cm">   |          |                v                            |          |       |</span>
<span class="cm">   +----------###############################################----------+-------+</span>
<span class="cm">   |          #                ^                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |   left   #                |                            #  right   | hsync |</span>
<span class="cm">   |  margin  #                |       xres                 #  margin  |  len  |</span>
<span class="cm">   |&lt;--------&gt;#&lt;---------------+---------------------------&gt;#&lt;--------&gt;|&lt;-----&gt;|</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |yres                        #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                |                            #          |       |</span>
<span class="cm">   |          #                v                            #          |       |</span>
<span class="cm">   +----------###############################################----------+-------+</span>
<span class="cm">   |          |                ^                            |          |       |</span>
<span class="cm">   |          |                |lower_margin                |          |       |</span>
<span class="cm">   |          |                v                            |          |       |</span>
<span class="cm">   +----------+---------------------------------------------+----------+-------+</span>
<span class="cm">   |          |                ^                            |          |       |</span>
<span class="cm">   |          |                |vsync_len                   |          |       |</span>
<span class="cm">   |          |                v                            |          |       |</span>
<span class="cm">   +----------+---------------------------------------------+----------+-------+</span>


<span class="cm">   Amiga video timings</span>
<span class="cm">   -------------------</span>

<span class="cm">   The Amiga native chipsets uses another timing scheme:</span>

<span class="cm">      - hsstrt:   Start of horizontal synchronization pulse</span>
<span class="cm">      - hsstop:   End of horizontal synchronization pulse</span>
<span class="cm">      - htotal:   Last value on the line (i.e. line length = htotal + 1)</span>
<span class="cm">      - vsstrt:   Start of vertical synchronization pulse</span>
<span class="cm">      - vsstop:   End of vertical synchronization pulse</span>
<span class="cm">      - vtotal:   Last line value (i.e. number of lines = vtotal + 1)</span>
<span class="cm">      - hcenter:  Start of vertical retrace for interlace</span>

<span class="cm">   You can specify the blanking timings independently. Currently I just set</span>
<span class="cm">   them equal to the respective synchronization values:</span>

<span class="cm">      - hbstrt:   Start of horizontal blank</span>
<span class="cm">      - hbstop:   End of horizontal blank</span>
<span class="cm">      - vbstrt:   Start of vertical blank</span>
<span class="cm">      - vbstop:   End of vertical blank</span>

<span class="cm">   Horizontal values are in color clock cycles (280 ns), vertical values are in</span>
<span class="cm">   scanlines.</span>

<span class="cm">   (0, 0) is somewhere in the upper-left corner :-)</span>


<span class="cm">   Amiga visible window definitions</span>
<span class="cm">   --------------------------------</span>

<span class="cm">   Currently I only have values for AGA, SHRES (28 MHz dotclock). Feel free to</span>
<span class="cm">   make corrections and/or additions.</span>

<span class="cm">   Within the above synchronization specifications, the visible window is</span>
<span class="cm">   defined by the following parameters (actual register resolutions may be</span>
<span class="cm">   different; all horizontal values are normalized with respect to the pixel</span>
<span class="cm">   clock):</span>

<span class="cm">      - diwstrt_h:   Horizontal start of the visible window</span>
<span class="cm">      - diwstop_h:   Horizontal stop + 1(*) of the visible window</span>
<span class="cm">      - diwstrt_v:   Vertical start of the visible window</span>
<span class="cm">      - diwstop_v:   Vertical stop of the visible window</span>
<span class="cm">      - ddfstrt:     Horizontal start of display DMA</span>
<span class="cm">      - ddfstop:     Horizontal stop of display DMA</span>
<span class="cm">      - hscroll:     Horizontal display output delay</span>

<span class="cm">   Sprite positioning:</span>

<span class="cm">      - sprstrt_h:   Horizontal start - 4 of sprite</span>
<span class="cm">      - sprstrt_v:   Vertical start of sprite</span>

<span class="cm">   (*) Even Commodore did it wrong in the AGA monitor drivers by not adding 1.</span>

<span class="cm">   Horizontal values are in dotclock cycles (35 ns), vertical values are in</span>
<span class="cm">   scanlines.</span>

<span class="cm">   (0, 0) is somewhere in the upper-left corner :-)</span>


<span class="cm">   Dependencies (AGA, SHRES (35 ns dotclock))</span>
<span class="cm">   -------------------------------------------</span>

<span class="cm">   Since there are much more parameters for the Amiga display than for the</span>
<span class="cm">   frame buffer interface, there must be some dependencies among the Amiga</span>
<span class="cm">   display parameters. Here&#39;s what I found out:</span>

<span class="cm">      - ddfstrt and ddfstop are best aligned to 64 pixels.</span>
<span class="cm">      - the chipset needs 64 + 4 horizontal pixels after the DMA start before</span>
<span class="cm">	the first pixel is output, so diwstrt_h = ddfstrt + 64 + 4 if you want</span>
<span class="cm">	to display the first pixel on the line too. Increase diwstrt_h for</span>
<span class="cm">	virtual screen panning.</span>
<span class="cm">      - the display DMA always fetches 64 pixels at a time (fmode = 3).</span>
<span class="cm">      - ddfstop is ddfstrt+#pixels - 64.</span>
<span class="cm">      - diwstop_h = diwstrt_h + xres + 1. Because of the additional 1 this can</span>
<span class="cm">	be 1 more than htotal.</span>
<span class="cm">      - hscroll simply adds a delay to the display output. Smooth horizontal</span>
<span class="cm">	panning needs an extra 64 pixels on the left to prefetch the pixels that</span>
<span class="cm">	`fall off&#39; on the left.</span>
<span class="cm">      - if ddfstrt &lt; 192, the sprite DMA cycles are all stolen by the bitplane</span>
<span class="cm">	DMA, so it&#39;s best to make the DMA start as late as possible.</span>
<span class="cm">      - you really don&#39;t want to make ddfstrt &lt; 128, since this will steal DMA</span>
<span class="cm">	cycles from the other DMA channels (audio, floppy and Chip RAM refresh).</span>
<span class="cm">      - I make diwstop_h and diwstop_v as large as possible.</span>

<span class="cm">   General dependencies</span>
<span class="cm">   --------------------</span>

<span class="cm">      - all values are SHRES pixel (35ns)</span>

<span class="cm">		  table 1:fetchstart  table 2:prefetch    table 3:fetchsize</span>
<span class="cm">		  ------------------  ----------------    -----------------</span>
<span class="cm">   Pixclock     # SHRES|HIRES|LORES # SHRES|HIRES|LORES # SHRES|HIRES|LORES</span>
<span class="cm">   -------------#------+-----+------#------+-----+------#------+-----+------</span>
<span class="cm">   Bus width 1x #   16 |  32 |  64  #   16 |  32 |  64  #   64 |  64 |  64</span>
<span class="cm">   Bus width 2x #   32 |  64 | 128  #   32 |  64 |  64  #   64 |  64 | 128</span>
<span class="cm">   Bus width 4x #   64 | 128 | 256  #   64 |  64 |  64  #   64 | 128 | 256</span>

<span class="cm">      - chipset needs 4 pixels before the first pixel is output</span>
<span class="cm">      - ddfstrt must be aligned to fetchstart (table 1)</span>
<span class="cm">      - chipset needs also prefetch (table 2) to get first pixel data, so</span>
<span class="cm">	ddfstrt = ((diwstrt_h - 4) &amp; -fetchstart) - prefetch</span>
<span class="cm">      - for horizontal panning decrease diwstrt_h</span>
<span class="cm">      - the length of a fetchline must be aligned to fetchsize (table 3)</span>
<span class="cm">      - if fetchstart is smaller than fetchsize, then ddfstrt can a little bit</span>
<span class="cm">	moved to optimize use of dma (useful for OCS/ECS overscan displays)</span>
<span class="cm">      - ddfstop is ddfstrt + ddfsize - fetchsize</span>
<span class="cm">      - If C= didn&#39;t change anything for AGA, then at following positions the</span>
<span class="cm">	dma bus is already used:</span>
<span class="cm">	ddfstrt &lt;  48 -&gt; memory refresh</span>
<span class="cm">		&lt;  96 -&gt; disk dma</span>
<span class="cm">		&lt; 160 -&gt; audio dma</span>
<span class="cm">		&lt; 192 -&gt; sprite 0 dma</span>
<span class="cm">		&lt; 416 -&gt; sprite dma (32 per sprite)</span>
<span class="cm">      - in accordance with the hardware reference manual a hardware stop is at</span>
<span class="cm">	192, but AGA (ECS?) can go below this.</span>

<span class="cm">   DMA priorities</span>
<span class="cm">   --------------</span>

<span class="cm">   Since there are limits on the earliest start value for display DMA and the</span>
<span class="cm">   display of sprites, I use the following policy on horizontal panning and</span>
<span class="cm">   the hardware cursor:</span>

<span class="cm">      - if you want to start display DMA too early, you lose the ability to</span>
<span class="cm">	do smooth horizontal panning (xpanstep 1 -&gt; 64).</span>
<span class="cm">      - if you want to go even further, you lose the hardware cursor too.</span>

<span class="cm">   IMHO a hardware cursor is more important for X than horizontal scrolling,</span>
<span class="cm">   so that&#39;s my motivation.</span>


<span class="cm">   Implementation</span>
<span class="cm">   --------------</span>

<span class="cm">   ami_decode_var() converts the frame buffer values to the Amiga values. It&#39;s</span>
<span class="cm">   just a `straightforward&#39; implementation of the above rules.</span>


<span class="cm">   Standard VGA timings</span>
<span class="cm">   --------------------</span>

<span class="cm">	       xres  yres    left  right  upper  lower    hsync    vsync</span>
<span class="cm">	       ----  ----    ----  -----  -----  -----    -----    -----</span>
<span class="cm">      80x25     720   400      27     45     35     12      108        2</span>
<span class="cm">      80x30     720   480      27     45     30      9      108        2</span>

<span class="cm">   These were taken from a XFree86 configuration file, recalculated for a 28 MHz</span>
<span class="cm">   dotclock (Amigas don&#39;t have a 25 MHz dotclock) and converted to frame buffer</span>
<span class="cm">   generic timings.</span>

<span class="cm">   As a comparison, graphics/monitor.h suggests the following:</span>

<span class="cm">	       xres  yres    left  right  upper  lower    hsync    vsync</span>
<span class="cm">	       ----  ----    ----  -----  -----  -----    -----    -----</span>

<span class="cm">      VGA       640   480      52    112     24     19    112 -      2 +</span>
<span class="cm">      VGA70     640   400      52    112     27     21    112 -      2 -</span>


<span class="cm">   Sync polarities</span>
<span class="cm">   ---------------</span>

<span class="cm">      VSYNC    HSYNC    Vertical size    Vertical total</span>
<span class="cm">      -----    -----    -------------    --------------</span>
<span class="cm">	+        +           Reserved          Reserved</span>
<span class="cm">	+        -                400               414</span>
<span class="cm">	-        +                350               362</span>
<span class="cm">	-        -                480               496</span>

<span class="cm">   Source: CL-GD542X Technical Reference Manual, Cirrus Logic, Oct 1992</span>


<span class="cm">   Broadcast video timings</span>
<span class="cm">   -----------------------</span>

<span class="cm">   According to the CCIR and RETMA specifications, we have the following values:</span>

<span class="cm">   CCIR -&gt; PAL</span>
<span class="cm">   -----------</span>

<span class="cm">      - a scanline is 64 µs long, of which 52.48 µs are visible. This is about</span>
<span class="cm">	736 visible 70 ns pixels per line.</span>
<span class="cm">      - we have 625 scanlines, of which 575 are visible (interlaced); after</span>
<span class="cm">	rounding this becomes 576.</span>

<span class="cm">   RETMA -&gt; NTSC</span>
<span class="cm">   -------------</span>

<span class="cm">      - a scanline is 63.5 µs long, of which 53.5 µs are visible.  This is about</span>
<span class="cm">	736 visible 70 ns pixels per line.</span>
<span class="cm">      - we have 525 scanlines, of which 485 are visible (interlaced); after</span>
<span class="cm">	rounding this becomes 484.</span>

<span class="cm">   Thus if you want a PAL compatible display, you have to do the following:</span>

<span class="cm">      - set the FB_SYNC_BROADCAST flag to indicate that standard broadcast</span>
<span class="cm">	timings are to be used.</span>
<span class="cm">      - make sure upper_margin + yres + lower_margin + vsync_len = 625 for an</span>
<span class="cm">	interlaced, 312 for a non-interlaced and 156 for a doublescanned</span>
<span class="cm">	display.</span>
<span class="cm">      - make sure left_margin + xres + right_margin + hsync_len = 1816 for a</span>
<span class="cm">	SHRES, 908 for a HIRES and 454 for a LORES display.</span>
<span class="cm">      - the left visible part begins at 360 (SHRES; HIRES:180, LORES:90),</span>
<span class="cm">	left_margin + 2 * hsync_len must be greater or equal.</span>
<span class="cm">      - the upper visible part begins at 48 (interlaced; non-interlaced:24,</span>
<span class="cm">	doublescanned:12), upper_margin + 2 * vsync_len must be greater or</span>
<span class="cm">	equal.</span>
<span class="cm">      - ami_encode_var() calculates margins with a hsync of 5320 ns and a vsync</span>
<span class="cm">	of 4 scanlines</span>

<span class="cm">   The settings for a NTSC compatible display are straightforward.</span>

<span class="cm">   Note that in a strict sense the PAL and NTSC standards only define the</span>
<span class="cm">   encoding of the color part (chrominance) of the video signal and don&#39;t say</span>
<span class="cm">   anything about horizontal/vertical synchronization nor refresh rates.</span>


<span class="cm">							    -- Geert --</span>

<span class="cm">*******************************************************************************/</span>


	<span class="cm">/*</span>
<span class="cm">	 * Custom Chipset Definitions</span>
<span class="cm">	 */</span>

<span class="cp">#define CUSTOM_OFS(fld) ((long)&amp;((struct CUSTOM*)0)-&gt;fld)</span>

	<span class="cm">/*</span>
<span class="cm">	 * BPLCON0 -- Bitplane Control Register 0</span>
<span class="cm">	 */</span>

<span class="cp">#define BPC0_HIRES	(0x8000)</span>
<span class="cp">#define BPC0_BPU2	(0x4000) </span><span class="cm">/* Bit plane used count */</span><span class="cp"></span>
<span class="cp">#define BPC0_BPU1	(0x2000)</span>
<span class="cp">#define BPC0_BPU0	(0x1000)</span>
<span class="cp">#define BPC0_HAM	(0x0800) </span><span class="cm">/* HAM mode */</span><span class="cp"></span>
<span class="cp">#define BPC0_DPF	(0x0400) </span><span class="cm">/* Double playfield */</span><span class="cp"></span>
<span class="cp">#define BPC0_COLOR	(0x0200) </span><span class="cm">/* Enable colorburst */</span><span class="cp"></span>
<span class="cp">#define BPC0_GAUD	(0x0100) </span><span class="cm">/* Genlock audio enable */</span><span class="cp"></span>
<span class="cp">#define BPC0_UHRES	(0x0080) </span><span class="cm">/* Ultrahi res enable */</span><span class="cp"></span>
<span class="cp">#define BPC0_SHRES	(0x0040) </span><span class="cm">/* Super hi res mode */</span><span class="cp"></span>
<span class="cp">#define BPC0_BYPASS	(0x0020) </span><span class="cm">/* Bypass LUT - AGA */</span><span class="cp"></span>
<span class="cp">#define BPC0_BPU3	(0x0010) </span><span class="cm">/* AGA */</span><span class="cp"></span>
<span class="cp">#define BPC0_LPEN	(0x0008) </span><span class="cm">/* Light pen enable */</span><span class="cp"></span>
<span class="cp">#define BPC0_LACE	(0x0004) </span><span class="cm">/* Interlace */</span><span class="cp"></span>
<span class="cp">#define BPC0_ERSY	(0x0002) </span><span class="cm">/* External resync */</span><span class="cp"></span>
<span class="cp">#define BPC0_ECSENA	(0x0001) </span><span class="cm">/* ECS enable */</span><span class="cp"></span>

	<span class="cm">/*</span>
<span class="cm">	 * BPLCON2 -- Bitplane Control Register 2</span>
<span class="cm">	 */</span>

<span class="cp">#define BPC2_ZDBPSEL2	(0x4000) </span><span class="cm">/* Bitplane to be used for ZD - AGA */</span><span class="cp"></span>
<span class="cp">#define BPC2_ZDBPSEL1	(0x2000)</span>
<span class="cp">#define BPC2_ZDBPSEL0	(0x1000)</span>
<span class="cp">#define BPC2_ZDBPEN	(0x0800) </span><span class="cm">/* Enable ZD with ZDBPSELx - AGA */</span><span class="cp"></span>
<span class="cp">#define BPC2_ZDCTEN	(0x0400) </span><span class="cm">/* Enable ZD with palette bit #31 - AGA */</span><span class="cp"></span>
<span class="cp">#define BPC2_KILLEHB	(0x0200) </span><span class="cm">/* Kill EHB mode - AGA */</span><span class="cp"></span>
<span class="cp">#define BPC2_RDRAM	(0x0100) </span><span class="cm">/* Color table accesses read, not write - AGA */</span><span class="cp"></span>
<span class="cp">#define BPC2_SOGEN	(0x0080) </span><span class="cm">/* SOG output pin high - AGA */</span><span class="cp"></span>
<span class="cp">#define BPC2_PF2PRI	(0x0040) </span><span class="cm">/* PF2 priority over PF1 */</span><span class="cp"></span>
<span class="cp">#define BPC2_PF2P2	(0x0020) </span><span class="cm">/* PF2 priority wrt sprites */</span><span class="cp"></span>
<span class="cp">#define BPC2_PF2P1	(0x0010)</span>
<span class="cp">#define BPC2_PF2P0	(0x0008)</span>
<span class="cp">#define BPC2_PF1P2	(0x0004) </span><span class="cm">/* ditto PF1 */</span><span class="cp"></span>
<span class="cp">#define BPC2_PF1P1	(0x0002)</span>
<span class="cp">#define BPC2_PF1P0	(0x0001)</span>

	<span class="cm">/*</span>
<span class="cm">	 * BPLCON3 -- Bitplane Control Register 3 (AGA)</span>
<span class="cm">	 */</span>

<span class="cp">#define BPC3_BANK2	(0x8000) </span><span class="cm">/* Bits to select color register bank */</span><span class="cp"></span>
<span class="cp">#define BPC3_BANK1	(0x4000)</span>
<span class="cp">#define BPC3_BANK0	(0x2000)</span>
<span class="cp">#define BPC3_PF2OF2	(0x1000) </span><span class="cm">/* Bits for color table offset when PF2 */</span><span class="cp"></span>
<span class="cp">#define BPC3_PF2OF1	(0x0800)</span>
<span class="cp">#define BPC3_PF2OF0	(0x0400)</span>
<span class="cp">#define BPC3_LOCT	(0x0200) </span><span class="cm">/* Color register writes go to low bits */</span><span class="cp"></span>
<span class="cp">#define BPC3_SPRES1	(0x0080) </span><span class="cm">/* Sprite resolution bits */</span><span class="cp"></span>
<span class="cp">#define BPC3_SPRES0	(0x0040)</span>
<span class="cp">#define BPC3_BRDRBLNK	(0x0020) </span><span class="cm">/* Border blanked? */</span><span class="cp"></span>
<span class="cp">#define BPC3_BRDRTRAN	(0x0010) </span><span class="cm">/* Border transparent? */</span><span class="cp"></span>
<span class="cp">#define BPC3_ZDCLKEN	(0x0004) </span><span class="cm">/* ZD pin is 14 MHz (HIRES) clock output */</span><span class="cp"></span>
<span class="cp">#define BPC3_BRDRSPRT	(0x0002) </span><span class="cm">/* Sprites in border? */</span><span class="cp"></span>
<span class="cp">#define BPC3_EXTBLKEN	(0x0001) </span><span class="cm">/* BLANK programmable */</span><span class="cp"></span>

	<span class="cm">/*</span>
<span class="cm">	 * BPLCON4 -- Bitplane Control Register 4 (AGA)</span>
<span class="cm">	 */</span>

<span class="cp">#define BPC4_BPLAM7	(0x8000) </span><span class="cm">/* bitplane color XOR field */</span><span class="cp"></span>
<span class="cp">#define BPC4_BPLAM6	(0x4000)</span>
<span class="cp">#define BPC4_BPLAM5	(0x2000)</span>
<span class="cp">#define BPC4_BPLAM4	(0x1000)</span>
<span class="cp">#define BPC4_BPLAM3	(0x0800)</span>
<span class="cp">#define BPC4_BPLAM2	(0x0400)</span>
<span class="cp">#define BPC4_BPLAM1	(0x0200)</span>
<span class="cp">#define BPC4_BPLAM0	(0x0100)</span>
<span class="cp">#define BPC4_ESPRM7	(0x0080) </span><span class="cm">/* 4 high bits for even sprite colors */</span><span class="cp"></span>
<span class="cp">#define BPC4_ESPRM6	(0x0040)</span>
<span class="cp">#define BPC4_ESPRM5	(0x0020)</span>
<span class="cp">#define BPC4_ESPRM4	(0x0010)</span>
<span class="cp">#define BPC4_OSPRM7	(0x0008) </span><span class="cm">/* 4 high bits for odd sprite colors */</span><span class="cp"></span>
<span class="cp">#define BPC4_OSPRM6	(0x0004)</span>
<span class="cp">#define BPC4_OSPRM5	(0x0002)</span>
<span class="cp">#define BPC4_OSPRM4	(0x0001)</span>

	<span class="cm">/*</span>
<span class="cm">	 * BEAMCON0 -- Beam Control Register</span>
<span class="cm">	 */</span>

<span class="cp">#define BMC0_HARDDIS	(0x4000) </span><span class="cm">/* Disable hardware limits */</span><span class="cp"></span>
<span class="cp">#define BMC0_LPENDIS	(0x2000) </span><span class="cm">/* Disable light pen latch */</span><span class="cp"></span>
<span class="cp">#define BMC0_VARVBEN	(0x1000) </span><span class="cm">/* Enable variable vertical blank */</span><span class="cp"></span>
<span class="cp">#define BMC0_LOLDIS	(0x0800) </span><span class="cm">/* Disable long/short line toggle */</span><span class="cp"></span>
<span class="cp">#define BMC0_CSCBEN	(0x0400) </span><span class="cm">/* Composite sync/blank */</span><span class="cp"></span>
<span class="cp">#define BMC0_VARVSYEN	(0x0200) </span><span class="cm">/* Enable variable vertical sync */</span><span class="cp"></span>
<span class="cp">#define BMC0_VARHSYEN	(0x0100) </span><span class="cm">/* Enable variable horizontal sync */</span><span class="cp"></span>
<span class="cp">#define BMC0_VARBEAMEN	(0x0080) </span><span class="cm">/* Enable variable beam counters */</span><span class="cp"></span>
<span class="cp">#define BMC0_DUAL	(0x0040) </span><span class="cm">/* Enable alternate horizontal beam counter */</span><span class="cp"></span>
<span class="cp">#define BMC0_PAL	(0x0020) </span><span class="cm">/* Set decodes for PAL */</span><span class="cp"></span>
<span class="cp">#define BMC0_VARCSYEN	(0x0010) </span><span class="cm">/* Enable variable composite sync */</span><span class="cp"></span>
<span class="cp">#define BMC0_BLANKEN	(0x0008) </span><span class="cm">/* Blank enable (no longer used on AGA) */</span><span class="cp"></span>
<span class="cp">#define BMC0_CSYTRUE	(0x0004) </span><span class="cm">/* CSY polarity */</span><span class="cp"></span>
<span class="cp">#define BMC0_VSYTRUE	(0x0002) </span><span class="cm">/* VSY polarity */</span><span class="cp"></span>
<span class="cp">#define BMC0_HSYTRUE	(0x0001) </span><span class="cm">/* HSY polarity */</span><span class="cp"></span>


	<span class="cm">/*</span>
<span class="cm">	 * FMODE -- Fetch Mode Control Register (AGA)</span>
<span class="cm">	 */</span>

<span class="cp">#define FMODE_SSCAN2	(0x8000) </span><span class="cm">/* Sprite scan-doubling */</span><span class="cp"></span>
<span class="cp">#define FMODE_BSCAN2	(0x4000) </span><span class="cm">/* Use PF2 modulus every other line */</span><span class="cp"></span>
<span class="cp">#define FMODE_SPAGEM	(0x0008) </span><span class="cm">/* Sprite page mode */</span><span class="cp"></span>
<span class="cp">#define FMODE_SPR32	(0x0004) </span><span class="cm">/* Sprite 32 bit fetch */</span><span class="cp"></span>
<span class="cp">#define FMODE_BPAGEM	(0x0002) </span><span class="cm">/* Bitplane page mode */</span><span class="cp"></span>
<span class="cp">#define FMODE_BPL32	(0x0001) </span><span class="cm">/* Bitplane 32 bit fetch */</span><span class="cp"></span>

	<span class="cm">/*</span>
<span class="cm">	 * Tags used to indicate a specific Pixel Clock</span>
<span class="cm">	 *</span>
<span class="cm">	 * clk_shift is the shift value to get the timings in 35 ns units</span>
<span class="cm">	 */</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="n">TAG_HIRES</span><span class="p">,</span> <span class="n">TAG_LORES</span> <span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tags used to indicate the specific chipset</span>
<span class="cm">	 */</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">TAG_OCS</span><span class="p">,</span> <span class="n">TAG_ECS</span><span class="p">,</span> <span class="n">TAG_AGA</span> <span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tags used to indicate the memory bandwidth</span>
<span class="cm">	 */</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">TAG_FMODE_1</span><span class="p">,</span> <span class="n">TAG_FMODE_2</span><span class="p">,</span> <span class="n">TAG_FMODE_4</span> <span class="p">};</span>


	<span class="cm">/*</span>
<span class="cm">	 * Clock Definitions, Maximum Display Depth</span>
<span class="cm">	 *</span>
<span class="cm">	 * These depend on the E-Clock or the Chipset, so they are filled in</span>
<span class="cm">	 * dynamically</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">u_long</span> <span class="n">pixclock</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* SHRES/HIRES/LORES: index = clk_shift */</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">maxdepth</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* SHRES/HIRES/LORES: index = clk_shift */</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">chipset</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * Broadcast Video Timings</span>
<span class="cm">	 *</span>
<span class="cm">	 * Horizontal values are in 35 ns (SHRES) units</span>
<span class="cm">	 * Vertical values are in interlaced scanlines</span>
<span class="cm">	 */</span>

<span class="cp">#define PAL_DIWSTRT_H	(360)	</span><span class="cm">/* PAL Window Limits */</span><span class="cp"></span>
<span class="cp">#define PAL_DIWSTRT_V	(48)</span>
<span class="cp">#define PAL_HTOTAL	(1816)</span>
<span class="cp">#define PAL_VTOTAL	(625)</span>

<span class="cp">#define NTSC_DIWSTRT_H	(360)	</span><span class="cm">/* NTSC Window Limits */</span><span class="cp"></span>
<span class="cp">#define NTSC_DIWSTRT_V	(40)</span>
<span class="cp">#define NTSC_HTOTAL	(1816)</span>
<span class="cp">#define NTSC_VTOTAL	(525)</span>


	<span class="cm">/*</span>
<span class="cm">	 * Various macros</span>
<span class="cm">	 */</span>

<span class="cp">#define up2(v)		(((v) + 1) &amp; -2)</span>
<span class="cp">#define down2(v)	((v) &amp; -2)</span>
<span class="cp">#define div2(v)		((v)&gt;&gt;1)</span>
<span class="cp">#define mod2(v)		((v) &amp; 1)</span>

<span class="cp">#define up4(v)		(((v) + 3) &amp; -4)</span>
<span class="cp">#define down4(v)	((v) &amp; -4)</span>
<span class="cp">#define mul4(v)		((v) &lt;&lt; 2)</span>
<span class="cp">#define div4(v)		((v)&gt;&gt;2)</span>
<span class="cp">#define mod4(v)		((v) &amp; 3)</span>

<span class="cp">#define up8(v)		(((v) + 7) &amp; -8)</span>
<span class="cp">#define down8(v)	((v) &amp; -8)</span>
<span class="cp">#define div8(v)		((v)&gt;&gt;3)</span>
<span class="cp">#define mod8(v)		((v) &amp; 7)</span>

<span class="cp">#define up16(v)		(((v) + 15) &amp; -16)</span>
<span class="cp">#define down16(v)	((v) &amp; -16)</span>
<span class="cp">#define div16(v)	((v)&gt;&gt;4)</span>
<span class="cp">#define mod16(v)	((v) &amp; 15)</span>

<span class="cp">#define up32(v)		(((v) + 31) &amp; -32)</span>
<span class="cp">#define down32(v)	((v) &amp; -32)</span>
<span class="cp">#define div32(v)	((v)&gt;&gt;5)</span>
<span class="cp">#define mod32(v)	((v) &amp; 31)</span>

<span class="cp">#define up64(v)		(((v) + 63) &amp; -64)</span>
<span class="cp">#define down64(v)	((v) &amp; -64)</span>
<span class="cp">#define div64(v)	((v)&gt;&gt;6)</span>
<span class="cp">#define mod64(v)	((v) &amp; 63)</span>

<span class="cp">#define upx(x, v)	(((v) + (x) - 1) &amp; -(x))</span>
<span class="cp">#define downx(x, v)	((v) &amp; -(x))</span>
<span class="cp">#define modx(x, v)	((v) &amp; ((x) - 1))</span>

<span class="cm">/* if x1 is not a constant, this macro won&#39;t make real sense :-) */</span>
<span class="cp">#ifdef __mc68000__</span>
<span class="cp">#define DIVUL(x1, x2) ({int res; asm(&quot;divul %1,%2,%3&quot;: &quot;=d&quot; (res): \</span>
<span class="cp">	&quot;d&quot; (x2), &quot;d&quot; ((long)((x1) / 0x100000000ULL)), &quot;0&quot; ((long)(x1))); res;})</span>
<span class="cp">#else</span>
<span class="cm">/* We know a bit about the numbers, so we can do it this way */</span>
<span class="cp">#define DIVUL(x1, x2) ((((long)((unsigned long long)x1 &gt;&gt; 8) / x2) &lt;&lt; 8) + \</span>
<span class="cp">	((((long)((unsigned long long)x1 &gt;&gt; 8) % x2) &lt;&lt; 8) / x2))</span>
<span class="cp">#endif</span>

<span class="cp">#define highw(x)	((u_long)(x)&gt;&gt;16 &amp; 0xffff)</span>
<span class="cp">#define loww(x)		((u_long)(x) &amp; 0xffff)</span>

<span class="cp">#define custom		amiga_custom</span>

<span class="cp">#define VBlankOn()	custom.intena = IF_SETCLR|IF_COPER</span>
<span class="cp">#define VBlankOff()	custom.intena = IF_COPER</span>


	<span class="cm">/*</span>
<span class="cm">	 * Chip RAM we reserve for the Frame Buffer</span>
<span class="cm">	 *</span>
<span class="cm">	 * This defines the Maximum Virtual Screen Size</span>
<span class="cm">	 * (Setable per kernel options?)</span>
<span class="cm">	 */</span>

<span class="cp">#define VIDEOMEMSIZE_AGA_2M	(1310720) </span><span class="cm">/* AGA (2MB) : max 1280*1024*256  */</span><span class="cp"></span>
<span class="cp">#define VIDEOMEMSIZE_AGA_1M	(786432)  </span><span class="cm">/* AGA (1MB) : max 1024*768*256   */</span><span class="cp"></span>
<span class="cp">#define VIDEOMEMSIZE_ECS_2M	(655360)  </span><span class="cm">/* ECS (2MB) : max 1280*1024*16   */</span><span class="cp"></span>
<span class="cp">#define VIDEOMEMSIZE_ECS_1M	(393216)  </span><span class="cm">/* ECS (1MB) : max 1024*768*16    */</span><span class="cp"></span>
<span class="cp">#define VIDEOMEMSIZE_OCS	(262144)  </span><span class="cm">/* OCS       : max ca. 800*600*16 */</span><span class="cp"></span>

<span class="cp">#define SPRITEMEMSIZE		(64 * 64 / 4) </span><span class="cm">/* max 64*64*4 */</span><span class="cp"></span>
<span class="cp">#define DUMMYSPRITEMEMSIZE	(8)</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="n">spritememory</span><span class="p">;</span>

<span class="cp">#define CHIPRAM_SAFETY_LIMIT	(16384)</span>

<span class="k">static</span> <span class="n">u_long</span> <span class="n">videomemory</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is the earliest allowed start of fetching display data.</span>
<span class="cm">	 * Only if you really want no hardware cursor and audio,</span>
<span class="cm">	 * set this to 128, but let it better at 192</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">u_long</span> <span class="n">min_fstrt</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>

<span class="cp">#define assignchunk(name, type, ptr, size) \</span>
<span class="cp">{ \</span>
<span class="cp">	(name) = (type)(ptr); \</span>
<span class="cp">	ptr += size; \</span>
<span class="cp">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Copper Instructions</span>
<span class="cm">	 */</span>

<span class="cp">#define CMOVE(val, reg)		(CUSTOM_OFS(reg) &lt;&lt; 16 | (val))</span>
<span class="cp">#define CMOVE2(val, reg)	((CUSTOM_OFS(reg) + 2) &lt;&lt; 16 | (val))</span>
<span class="cp">#define CWAIT(x, y)		(((y) &amp; 0x1fe) &lt;&lt; 23 | ((x) &amp; 0x7f0) &lt;&lt; 13 | 0x0001fffe)</span>
<span class="cp">#define CEND			(0xfffffffe)</span>


<span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
	<span class="n">u_long</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">copins</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">copdisplay</span> <span class="p">{</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">wait</span><span class="p">;</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">rebuild</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">copdisplay</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">currentcop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware Cursor API Definitions</span>
<span class="cm">	 * These used to be in linux/fb.h, but were preliminary and used by</span>
<span class="cm">	 * amifb only anyway</span>
<span class="cm">	 */</span>

<span class="cp">#define FBIOGET_FCURSORINFO     0x4607</span>
<span class="cp">#define FBIOGET_VCURSORINFO     0x4608</span>
<span class="cp">#define FBIOPUT_VCURSORINFO     0x4609</span>
<span class="cp">#define FBIOGET_CURSORSTATE     0x460A</span>
<span class="cp">#define FBIOPUT_CURSORSTATE     0x460B</span>


<span class="k">struct</span> <span class="n">fb_fix_cursorinfo</span> <span class="p">{</span>
	<span class="n">__u16</span> <span class="n">crsr_width</span><span class="p">;</span>		<span class="cm">/* width and height of the cursor in */</span>
	<span class="n">__u16</span> <span class="n">crsr_height</span><span class="p">;</span>		<span class="cm">/* pixels (zero if no cursor)	*/</span>
	<span class="n">__u16</span> <span class="n">crsr_xsize</span><span class="p">;</span>		<span class="cm">/* cursor size in display pixels */</span>
	<span class="n">__u16</span> <span class="n">crsr_ysize</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">crsr_color1</span><span class="p">;</span>		<span class="cm">/* colormap entry for cursor color1 */</span>
	<span class="n">__u16</span> <span class="n">crsr_color2</span><span class="p">;</span>		<span class="cm">/* colormap entry for cursor color2 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fb_var_cursorinfo</span> <span class="p">{</span>
	<span class="n">__u16</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">xspot</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">yspot</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>			<span class="cm">/* field with [height][width]        */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fb_cursorstate</span> <span class="p">{</span>
	<span class="n">__s16</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">__s16</span> <span class="n">yoffset</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FB_CURSOR_OFF		0</span>
<span class="cp">#define FB_CURSOR_ON		1</span>
<span class="cp">#define FB_CURSOR_FLASH		2</span>


	<span class="cm">/*</span>
<span class="cm">	 * Hardware Cursor</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cursorrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>	<span class="cm">/* Number of frames/flash toggle */</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">cursorstate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">cursormode</span> <span class="o">=</span> <span class="n">FB_CURSOR_OFF</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="o">*</span><span class="n">lofsprite</span><span class="p">,</span> <span class="o">*</span><span class="n">shfsprite</span><span class="p">,</span> <span class="o">*</span><span class="n">dummysprite</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Current Video Mode</span>
<span class="cm">	 */</span>

<span class="k">struct</span> <span class="n">amifb_par</span> <span class="p">{</span>

	<span class="cm">/* General Values */</span>

	<span class="kt">int</span> <span class="n">xres</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="kt">int</span> <span class="n">yres</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="kt">int</span> <span class="n">vxres</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="kt">int</span> <span class="n">vyres</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="kt">int</span> <span class="n">xoffset</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="kt">int</span> <span class="n">yoffset</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">bpp</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">clk_shift</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">line_shift</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="kt">int</span> <span class="n">vmode</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">diwstrt_h</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">diwstop_h</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">diwstrt_v</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">diwstop_v</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_long</span> <span class="n">next_line</span><span class="p">;</span>	<span class="cm">/* modulo for next line */</span>
	<span class="n">u_long</span> <span class="n">next_plane</span><span class="p">;</span>	<span class="cm">/* modulo for next plane */</span>

	<span class="cm">/* Cursor Values */</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">crsr_x</span><span class="p">;</span>	<span class="cm">/* movecursor */</span>
		<span class="kt">short</span> <span class="n">crsr_y</span><span class="p">;</span>	<span class="cm">/* movecursor */</span>
		<span class="kt">short</span> <span class="n">spot_x</span><span class="p">;</span>
		<span class="kt">short</span> <span class="n">spot_y</span><span class="p">;</span>
		<span class="n">u_short</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">u_short</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">u_short</span> <span class="n">fmode</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">crsr</span><span class="p">;</span>

	<span class="cm">/* OCS Hardware Registers */</span>

	<span class="n">u_long</span> <span class="n">bplpt0</span><span class="p">;</span>		<span class="cm">/* vmode, pan (Note: physical address) */</span>
	<span class="n">u_long</span> <span class="n">bplpt0wrap</span><span class="p">;</span>	<span class="cm">/* vmode, pan (Note: physical address) */</span>
	<span class="n">u_short</span> <span class="n">ddfstrt</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">ddfstop</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">bpl1mod</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">bpl2mod</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">bplcon0</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">bplcon1</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">htotal</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">vtotal</span><span class="p">;</span>		<span class="cm">/* vmode */</span>

	<span class="cm">/* Additional ECS Hardware Registers */</span>

	<span class="n">u_short</span> <span class="n">bplcon3</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">beamcon0</span><span class="p">;</span>	<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">hsstrt</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">hsstop</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">hbstrt</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">hbstop</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">vsstrt</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">vsstop</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">vbstrt</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">vbstop</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
	<span class="n">u_short</span> <span class="n">hcenter</span><span class="p">;</span>	<span class="cm">/* vmode */</span>

	<span class="cm">/* Additional AGA Hardware Registers */</span>

	<span class="n">u_short</span> <span class="n">fmode</span><span class="p">;</span>		<span class="cm">/* vmode */</span>
<span class="p">};</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Saved color entry 0 so we can restore it when unblanking</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">red0</span><span class="p">,</span> <span class="n">green0</span><span class="p">,</span> <span class="n">blue0</span><span class="p">;</span>


<span class="cp">#if defined(CONFIG_FB_AMIGA_ECS)</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">ecs_palette</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="cp">#endif</span>


	<span class="cm">/*</span>
<span class="cm">	 * Latches for Display Changes during VBlank</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">do_vmode_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Change the Video Mode */</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">do_vmode_pan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Update the Video Mode */</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">do_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* (Un)Blank the Screen (±1) */</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">do_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Move the Cursor */</span>


	<span class="cm">/*</span>
<span class="cm">	 * Various Flags</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">is_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Screen is Blanked */</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">is_lace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Screen is laced */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Predefined Video Modes</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">ami_modedb</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 *  AmigaOS Video Modes</span>
<span class="cm">	 *</span>
<span class="cm">	 *  If you change these, make sure to update DEFMODE_* as well!</span>
<span class="cm">	 */</span>

	<span class="p">{</span>
		<span class="cm">/* 640x200, 15 kHz, 60 Hz (NTSC) */</span>
		<span class="s">&quot;ntsc&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">TAG_HIRES</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">FB_SYNC_BROADCAST</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x400, 15 kHz, 60 Hz interlaced (NTSC) */</span>
		<span class="s">&quot;ntsc-lace&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">TAG_HIRES</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="n">FB_SYNC_BROADCAST</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x256, 15 kHz, 50 Hz (PAL) */</span>
		<span class="s">&quot;pal&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">TAG_HIRES</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">FB_SYNC_BROADCAST</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x512, 15 kHz, 50 Hz interlaced (PAL) */</span>
		<span class="s">&quot;pal-lace&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">TAG_HIRES</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="n">FB_SYNC_BROADCAST</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x480, 29 kHz, 57 Hz */</span>
		<span class="s">&quot;multiscan&quot;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x960, 29 kHz, 57 Hz interlaced */</span>
		<span class="s">&quot;multiscan-lace&quot;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">960</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span>
		<span class="mi">16</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x200, 15 kHz, 72 Hz */</span>
		<span class="s">&quot;euro36&quot;</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">TAG_HIRES</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x400, 15 kHz, 72 Hz interlaced */</span>
		<span class="s">&quot;euro36-lace&quot;</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">TAG_HIRES</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span>
		<span class="mi">10</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x400, 29 kHz, 68 Hz */</span>
		<span class="s">&quot;euro72&quot;</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x800, 29 kHz, 68 Hz interlaced */</span>
		<span class="s">&quot;euro72-lace&quot;</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
		<span class="mi">16</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 800x300, 23 kHz, 70 Hz */</span>
		<span class="s">&quot;super72&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 800x600, 23 kHz, 70 Hz interlaced */</span>
		<span class="s">&quot;super72-lace&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
		<span class="mi">14</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x200, 27 kHz, 57 Hz doublescan */</span>
		<span class="s">&quot;dblntsc&quot;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_DOUBLE</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x400, 27 kHz, 57 Hz */</span>
		<span class="s">&quot;dblntsc-ff&quot;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x800, 27 kHz, 57 Hz interlaced */</span>
		<span class="s">&quot;dblntsc-lace&quot;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
		<span class="mi">14</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x256, 27 kHz, 47 Hz doublescan */</span>
		<span class="s">&quot;dblpal&quot;</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_DOUBLE</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x512, 27 kHz, 47 Hz */</span>
		<span class="s">&quot;dblpal-ff&quot;</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x1024, 27 kHz, 47 Hz interlaced */</span>
		<span class="s">&quot;dblpal-lace&quot;</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
		<span class="mi">14</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 *  VGA Video Modes</span>
<span class="cm">	 */</span>

	<span class="p">{</span>
		<span class="cm">/* 640x480, 31 kHz, 60 Hz (VGA) */</span>
		<span class="s">&quot;vga&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x400, 31 kHz, 70 Hz (VGA) */</span>
		<span class="s">&quot;vga70&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">TAG_SHRES</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">,</span>
		<span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span>

<span class="cp">#if 0</span><span class="c"></span>

<span class="c">	/*</span>
<span class="c">	 *  A2024 video modes</span>
<span class="c">	 *  These modes don&#39;t work yet because there&#39;s no A2024 driver.</span>
<span class="c">	 */</span>

<span class="c">	{</span>
<span class="c">		/* 1024x800, 10 Hz */</span>
<span class="c">		&quot;a2024-10&quot;, 10, 1024, 800, TAG_HIRES, 0, 0, 0, 0, 0, 0,</span>
<span class="c">		0, FB_VMODE_NONINTERLACED | FB_VMODE_YWRAP</span>
<span class="c">	}, {</span>
<span class="c">		/* 1024x800, 15 Hz */</span>
<span class="c">		&quot;a2024-15&quot;, 15, 1024, 800, TAG_HIRES, 0, 0, 0, 0, 0, 0,</span>
<span class="c">		0, FB_VMODE_NONINTERLACED | FB_VMODE_YWRAP</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#define NUM_TOTAL_MODES  ARRAY_SIZE(ami_modedb)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">round_down_bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* for mode probing */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some default modes</span>
<span class="cm">	 */</span>


<span class="cp">#define DEFMODE_PAL	    2	</span><span class="cm">/* &quot;pal&quot; for PAL OCS/ECS */</span><span class="cp"></span>
<span class="cp">#define DEFMODE_NTSC	    0	</span><span class="cm">/* &quot;ntsc&quot; for NTSC OCS/ECS */</span><span class="cp"></span>
<span class="cp">#define DEFMODE_AMBER_PAL   3	</span><span class="cm">/* &quot;pal-lace&quot; for flicker fixed PAL (A3000) */</span><span class="cp"></span>
<span class="cp">#define DEFMODE_AMBER_NTSC  1	</span><span class="cm">/* &quot;ntsc-lace&quot; for flicker fixed NTSC (A3000) */</span><span class="cp"></span>
<span class="cp">#define DEFMODE_AGA	    19	</span><span class="cm">/* &quot;vga70&quot; for AGA */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">amifb_ilbm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* interleaved or normal bitplanes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">amifb_inverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">amifb_hfmin</span> <span class="n">__initdata</span><span class="p">;</span>	<span class="cm">/* monitor hfreq lower limit (Hz) */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">amifb_hfmax</span> <span class="n">__initdata</span><span class="p">;</span>	<span class="cm">/* monitor hfreq upper limit (Hz) */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">amifb_vfmin</span> <span class="n">__initdata</span><span class="p">;</span>	<span class="cm">/* monitor vfreq lower limit (Hz) */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">amifb_vfmax</span> <span class="n">__initdata</span><span class="p">;</span>	<span class="cm">/* monitor vfreq upper limit (Hz) */</span>


	<span class="cm">/*</span>
<span class="cm">	 * Macros for the conversion from real world values to hardware register</span>
<span class="cm">	 * values</span>
<span class="cm">	 *</span>
<span class="cm">	 * This helps us to keep our attention on the real stuff...</span>
<span class="cm">	 *</span>
<span class="cm">	 * Hardware limits for AGA:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	parameter  min    max  step</span>
<span class="cm">	 *	---------  ---   ----  ----</span>
<span class="cm">	 *	diwstrt_h    0   2047     1</span>
<span class="cm">	 *	diwstrt_v    0   2047     1</span>
<span class="cm">	 *	diwstop_h    0   4095     1</span>
<span class="cm">	 *	diwstop_v    0   4095     1</span>
<span class="cm">	 *</span>
<span class="cm">	 *	ddfstrt      0   2032    16</span>
<span class="cm">	 *	ddfstop      0   2032    16</span>
<span class="cm">	 *</span>
<span class="cm">	 *	htotal       8   2048     8</span>
<span class="cm">	 *	hsstrt       0   2040     8</span>
<span class="cm">	 *	hsstop       0   2040     8</span>
<span class="cm">	 *	vtotal       1   4096     1</span>
<span class="cm">	 *	vsstrt       0   4095     1</span>
<span class="cm">	 *	vsstop       0   4095     1</span>
<span class="cm">	 *	hcenter      0   2040     8</span>
<span class="cm">	 *</span>
<span class="cm">	 *	hbstrt       0   2047     1</span>
<span class="cm">	 *	hbstop       0   2047     1</span>
<span class="cm">	 *	vbstrt       0   4095     1</span>
<span class="cm">	 *	vbstop       0   4095     1</span>
<span class="cm">	 *</span>
<span class="cm">	 * Horizontal values are in 35 ns (SHRES) pixels</span>
<span class="cm">	 * Vertical values are in half scanlines</span>
<span class="cm">	 */</span>

<span class="cm">/* bplcon1 (smooth scrolling) */</span>

<span class="cp">#define hscroll2hw(hscroll) \</span>
<span class="cp">	(((hscroll) &lt;&lt; 12 &amp; 0x3000) | ((hscroll) &lt;&lt; 8 &amp; 0xc300) | \</span>
<span class="cp">	 ((hscroll) &lt;&lt; 4 &amp; 0x0c00) | ((hscroll) &lt;&lt; 2 &amp; 0x00f0) | \</span>
<span class="cp">	 ((hscroll)&gt;&gt;2 &amp; 0x000f))</span>

<span class="cm">/* diwstrt/diwstop/diwhigh (visible display window) */</span>

<span class="cp">#define diwstrt2hw(diwstrt_h, diwstrt_v) \</span>
<span class="cp">	(((diwstrt_v) &lt;&lt; 7 &amp; 0xff00) | ((diwstrt_h)&gt;&gt;2 &amp; 0x00ff))</span>
<span class="cp">#define diwstop2hw(diwstop_h, diwstop_v) \</span>
<span class="cp">	(((diwstop_v) &lt;&lt; 7 &amp; 0xff00) | ((diwstop_h)&gt;&gt;2 &amp; 0x00ff))</span>
<span class="cp">#define diwhigh2hw(diwstrt_h, diwstrt_v, diwstop_h, diwstop_v) \</span>
<span class="cp">	(((diwstop_h) &lt;&lt; 3 &amp; 0x2000) | ((diwstop_h) &lt;&lt; 11 &amp; 0x1800) | \</span>
<span class="cp">	 ((diwstop_v)&gt;&gt;1 &amp; 0x0700) | ((diwstrt_h)&gt;&gt;5 &amp; 0x0020) | \</span>
<span class="cp">	 ((diwstrt_h) &lt;&lt; 3 &amp; 0x0018) | ((diwstrt_v)&gt;&gt;9 &amp; 0x0007))</span>

<span class="cm">/* ddfstrt/ddfstop (display DMA) */</span>

<span class="cp">#define ddfstrt2hw(ddfstrt)	div8(ddfstrt)</span>
<span class="cp">#define ddfstop2hw(ddfstop)	div8(ddfstop)</span>

<span class="cm">/* hsstrt/hsstop/htotal/vsstrt/vsstop/vtotal/hcenter (sync timings) */</span>

<span class="cp">#define hsstrt2hw(hsstrt)	(div8(hsstrt))</span>
<span class="cp">#define hsstop2hw(hsstop)	(div8(hsstop))</span>
<span class="cp">#define htotal2hw(htotal)	(div8(htotal) - 1)</span>
<span class="cp">#define vsstrt2hw(vsstrt)	(div2(vsstrt))</span>
<span class="cp">#define vsstop2hw(vsstop)	(div2(vsstop))</span>
<span class="cp">#define vtotal2hw(vtotal)	(div2(vtotal) - 1)</span>
<span class="cp">#define hcenter2hw(htotal)	(div8(htotal))</span>

<span class="cm">/* hbstrt/hbstop/vbstrt/vbstop (blanking timings) */</span>

<span class="cp">#define hbstrt2hw(hbstrt)	(((hbstrt) &lt;&lt; 8 &amp; 0x0700) | ((hbstrt)&gt;&gt;3 &amp; 0x00ff))</span>
<span class="cp">#define hbstop2hw(hbstop)	(((hbstop) &lt;&lt; 8 &amp; 0x0700) | ((hbstop)&gt;&gt;3 &amp; 0x00ff))</span>
<span class="cp">#define vbstrt2hw(vbstrt)	(div2(vbstrt))</span>
<span class="cp">#define vbstop2hw(vbstop)	(div2(vbstop))</span>

<span class="cm">/* colour */</span>

<span class="cp">#define rgb2hw8_high(red, green, blue) \</span>
<span class="cp">	(((red &amp; 0xf0) &lt;&lt; 4) | (green &amp; 0xf0) | ((blue &amp; 0xf0)&gt;&gt;4))</span>
<span class="cp">#define rgb2hw8_low(red, green, blue) \</span>
<span class="cp">	(((red &amp; 0x0f) &lt;&lt; 8) | ((green &amp; 0x0f) &lt;&lt; 4) | (blue &amp; 0x0f))</span>
<span class="cp">#define rgb2hw4(red, green, blue) \</span>
<span class="cp">	(((red &amp; 0xf0) &lt;&lt; 4) | (green &amp; 0xf0) | ((blue &amp; 0xf0)&gt;&gt;4))</span>
<span class="cp">#define rgb2hw2(red, green, blue) \</span>
<span class="cp">	(((red &amp; 0xc0) &lt;&lt; 4) | (green &amp; 0xc0) | ((blue &amp; 0xc0)&gt;&gt;4))</span>

<span class="cm">/* sprpos/sprctl (sprite positioning) */</span>

<span class="cp">#define spr2hw_pos(start_v, start_h) \</span>
<span class="cp">	(((start_v) &lt;&lt; 7 &amp; 0xff00) | ((start_h)&gt;&gt;3 &amp; 0x00ff))</span>
<span class="cp">#define spr2hw_ctl(start_v, start_h, stop_v) \</span>
<span class="cp">	(((stop_v) &lt;&lt; 7 &amp; 0xff00) | ((start_v)&gt;&gt;4 &amp; 0x0040) | \</span>
<span class="cp">	 ((stop_v)&gt;&gt;5 &amp; 0x0020) | ((start_h) &lt;&lt; 3 &amp; 0x0018) | \</span>
<span class="cp">	 ((start_v)&gt;&gt;7 &amp; 0x0004) | ((stop_v)&gt;&gt;8 &amp; 0x0002) | \</span>
<span class="cp">	 ((start_h)&gt;&gt;2 &amp; 0x0001))</span>

<span class="cm">/* get current vertical position of beam */</span>
<span class="cp">#define get_vbpos()	((u_short)((*(u_long volatile *)&amp;custom.vposr &gt;&gt; 7) &amp; 0xffe))</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copper Initialisation List</span>
<span class="cm">	 */</span>

<span class="cp">#define COPINITSIZE (sizeof(copins) * 40)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">cip_bplcon0</span>
<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Long Frame/Short Frame Copper List</span>
<span class="cm">	 * Don&#39;t change the order, build_copper()/rebuild_copper() rely on this</span>
<span class="cm">	 */</span>

<span class="cp">#define COPLISTSIZE (sizeof(copins) * 64)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">cop_wait</span><span class="p">,</span> <span class="n">cop_bplcon0</span><span class="p">,</span>
	<span class="n">cop_spr0ptrh</span><span class="p">,</span> <span class="n">cop_spr0ptrl</span><span class="p">,</span>
	<span class="n">cop_diwstrt</span><span class="p">,</span> <span class="n">cop_diwstop</span><span class="p">,</span>
	<span class="n">cop_diwhigh</span><span class="p">,</span>
<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pixel modes for Bitplanes and Sprites</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">bplpixmode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BPC0_SHRES</span><span class="p">,</span>			<span class="cm">/*  35 ns */</span>
	<span class="n">BPC0_HIRES</span><span class="p">,</span>			<span class="cm">/*  70 ns */</span>
	<span class="mi">0</span>				<span class="cm">/* 140 ns */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">sprpixmode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BPC3_SPRES1</span> <span class="o">|</span> <span class="n">BPC3_SPRES0</span><span class="p">,</span>	<span class="cm">/*  35 ns */</span>
	<span class="n">BPC3_SPRES1</span><span class="p">,</span>			<span class="cm">/*  70 ns */</span>
	<span class="n">BPC3_SPRES0</span>			<span class="cm">/* 140 ns */</span>
<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fetch modes for Bitplanes and Sprites</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">bplfetchmode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* 1x */</span>
	<span class="n">FMODE_BPL32</span><span class="p">,</span>			<span class="cm">/* 2x */</span>
	<span class="n">FMODE_BPAGEM</span> <span class="o">|</span> <span class="n">FMODE_BPL32</span>	<span class="cm">/* 4x */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">sprfetchmode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* 1x */</span>
	<span class="n">FMODE_SPR32</span><span class="p">,</span>			<span class="cm">/* 2x */</span>
	<span class="n">FMODE_SPAGEM</span> <span class="o">|</span> <span class="n">FMODE_SPR32</span>	<span class="cm">/* 4x */</span>
<span class="p">};</span>


<span class="cm">/* --------------------------- Hardware routines --------------------------- */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the video params out of `var&#39;. If a value doesn&#39;t fit, round</span>
<span class="cm">	 * it up, if it&#39;s too big, return -EINVAL.</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ami_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">clk_shift</span><span class="p">,</span> <span class="n">line_shift</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">maxfetchstop</span><span class="p">,</span> <span class="n">fstrt</span><span class="p">,</span> <span class="n">fsize</span><span class="p">,</span> <span class="n">fconst</span><span class="p">,</span> <span class="n">xres_n</span><span class="p">,</span> <span class="n">yres_n</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find a matching Pixel Clock</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">clk_shift</span> <span class="o">=</span> <span class="n">TAG_SHRES</span><span class="p">;</span> <span class="n">clk_shift</span> <span class="o">&lt;=</span> <span class="n">TAG_LORES</span><span class="p">;</span> <span class="n">clk_shift</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&lt;=</span> <span class="n">pixclock</span><span class="p">[</span><span class="n">clk_shift</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_shift</span> <span class="o">&gt;</span> <span class="n">TAG_LORES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pixclock too high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_shift</span> <span class="o">=</span> <span class="n">clk_shift</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the Geometry Values</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vxres</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="n">maxdepth</span><span class="p">[</span><span class="n">clk_shift</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">round_down_bpp</span> <span class="o">&amp;&amp;</span> <span class="n">maxdepth</span><span class="p">[</span><span class="n">clk_shift</span><span class="p">])</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">maxdepth</span><span class="p">[</span><span class="n">clk_shift</span><span class="p">];</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid bpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">==</span> <span class="n">FB_NONSTD_HAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_AGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid bpp for ham mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;unknown nonstd mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * FB_VMODE_SMOOTH_XPAN will be cleared, if one of the folloing</span>
<span class="cm">	 * checks failed and smooth scrolling is not possible</span>
<span class="cm">	 */</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|</span> <span class="n">FB_VMODE_SMOOTH_XPAN</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VMODE_INTERLACED</span>:
		<span class="n">line_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VMODE_NONINTERLACED</span>:
		<span class="n">line_shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VMODE_DOUBLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_AGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;double mode only possible with aga</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">line_shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;unknown video mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">line_shift</span> <span class="o">=</span> <span class="n">line_shift</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Vertical and Horizontal Timings</span>
<span class="cm">	 */</span>

	<span class="n">xres_n</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">;</span>
	<span class="n">yres_n</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;&lt;</span> <span class="n">line_shift</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">down8</span><span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span>
			     <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span>
		<span class="n">down2</span><span class="p">(((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">line_shift</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">sprpixmode</span><span class="p">[</span><span class="n">clk_shift</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">-</span>
			<span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">+=</span> <span class="n">mod4</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">=</span> <span class="n">down4</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">);</span>

		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">-</span> <span class="n">xres_n</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">-</span>
			<span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">line_shift</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">-</span> <span class="n">yres_n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">&gt;=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid diwstop_h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid diwstop_v</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Initialize sync with some reasonable values for pwrsave */</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="mi">160</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstop</span> <span class="o">=</span> <span class="mi">34</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAL_VTOTAL</span> <span class="o">+</span> <span class="n">NTSC_VTOTAL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PAL video mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">!=</span> <span class="n">PAL_HTOTAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;htotal invalid for pal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">&lt;</span> <span class="n">PAL_DIWSTRT_H</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;diwstrt_h too low for pal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">&lt;</span> <span class="n">PAL_DIWSTRT_V</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;diwstrt_v too low for pal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">htotal</span> <span class="o">=</span> <span class="n">PAL_HTOTAL</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">;</span>
			<span class="n">vtotal</span> <span class="o">=</span> <span class="n">PAL_VTOTAL</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="n">BMC0_PAL</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span> <span class="o">|=</span> <span class="n">BPC3_BRDRBLNK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AMIGAHW_PRESENT</span><span class="p">(</span><span class="n">AGNUS_HR_PAL</span><span class="p">)</span> <span class="o">||</span>
				   <span class="n">AMIGAHW_PRESENT</span><span class="p">(</span><span class="n">AGNUS_HR_NTSC</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="n">BMC0_PAL</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">amiga_vblank</span> <span class="o">!=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pal not supported by this chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* NTSC video mode</span>
<span class="cm">			 * In the AGA chipset seems to be hardware bug with BPC3_BRDRBLNK</span>
<span class="cm">			 * and NTSC activated, so than better let diwstop_h &lt;= 1812</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">!=</span> <span class="n">NTSC_HTOTAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;htotal invalid for ntsc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">&lt;</span> <span class="n">NTSC_DIWSTRT_H</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;diwstrt_h too low for ntsc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">&lt;</span> <span class="n">NTSC_DIWSTRT_V</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;diwstrt_v too low for ntsc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">htotal</span> <span class="o">=</span> <span class="n">NTSC_HTOTAL</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">;</span>
			<span class="n">vtotal</span> <span class="o">=</span> <span class="n">NTSC_VTOTAL</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span> <span class="o">|=</span> <span class="n">BPC3_BRDRBLNK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AMIGAHW_PRESENT</span><span class="p">(</span><span class="n">AGNUS_HR_PAL</span><span class="p">)</span> <span class="o">||</span>
				   <span class="n">AMIGAHW_PRESENT</span><span class="p">(</span><span class="n">AGNUS_HR_NTSC</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">amiga_vblank</span> <span class="o">!=</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ntsc not supported by this chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">&gt;=</span> <span class="mi">1024</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">||</span>
			    <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">&gt;=</span>  <span class="mi">512</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">&lt;</span>  <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid position for display on ocs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Programmable video mode */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">-</span> <span class="n">mod8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_AGA</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">=</span> <span class="n">down4</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">-</span> <span class="n">xres_n</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hbstop</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hbstrt</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hbstrt</span> <span class="o">&gt;=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hbstrt</span> <span class="o">-=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hcenter</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span> <span class="o">+</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">&lt;&lt;</span> <span class="n">line_shift</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstop</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">line_shift</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">-</span> <span class="n">yres_n</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbstop</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbstrt</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;vtotal too high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;htotal too high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span> <span class="o">|=</span> <span class="n">BPC3_EXTBLKEN</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="n">BMC0_HARDDIS</span> <span class="o">|</span> <span class="n">BMC0_VARVBEN</span> <span class="o">|</span> <span class="n">BMC0_LOLDIS</span> <span class="o">|</span>
				<span class="n">BMC0_VARVSYEN</span> <span class="o">|</span> <span class="n">BMC0_VARHSYEN</span> <span class="o">|</span> <span class="n">BMC0_VARBEAMEN</span> <span class="o">|</span>
				<span class="n">BMC0_PAL</span> <span class="o">|</span> <span class="n">BMC0_VARCSYEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">|=</span> <span class="n">BMC0_HSYTRUE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">|=</span> <span class="n">BMC0_VSYTRUE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">|=</span> <span class="n">BMC0_CSYTRUE</span><span class="p">;</span>
		<span class="n">htotal</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;only broadcast modes possible for ocs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Checking the DMA timing</span>
<span class="cm">	 */</span>

	<span class="n">fconst</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * smallest window start value without turn off other dma cycles</span>
<span class="cm">	 * than sprite1-7, unless you change min_fstrt</span>
<span class="cm">	 */</span>


	<span class="n">fsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">maxfmode</span> <span class="o">+</span> <span class="n">clk_shift</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">fconst</span> <span class="o">:</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">fstrt</span> <span class="o">=</span> <span class="n">downx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">fsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fstrt</span> <span class="o">&lt;</span> <span class="n">min_fstrt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;fetch start too low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * smallest window start value where smooth scrolling is possible</span>
<span class="cm">	 */</span>

	<span class="n">fstrt</span> <span class="o">=</span> <span class="n">downx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">-</span> <span class="n">fconst</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span>
		<span class="n">fsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fstrt</span> <span class="o">&lt;</span> <span class="n">min_fstrt</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_SMOOTH_XPAN</span><span class="p">;</span>

	<span class="n">maxfetchstop</span> <span class="o">=</span> <span class="n">down16</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">-</span> <span class="mi">80</span><span class="p">);</span>

	<span class="n">fstrt</span> <span class="o">=</span> <span class="n">downx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">fconst</span><span class="p">;</span>
	<span class="n">fsize</span> <span class="o">=</span> <span class="n">upx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">xres_n</span> <span class="o">+</span>
		    <span class="n">modx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">downx</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fstrt</span> <span class="o">+</span> <span class="n">fsize</span> <span class="o">&gt;</span> <span class="n">maxfetchstop</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_SMOOTH_XPAN</span><span class="p">;</span>

	<span class="n">fsize</span> <span class="o">=</span> <span class="n">upx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">xres_n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fstrt</span> <span class="o">+</span> <span class="n">fsize</span> <span class="o">&gt;</span> <span class="n">maxfetchstop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;fetch stop too high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maxfmode</span> <span class="o">+</span> <span class="n">clk_shift</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fsize</span> <span class="o">=</span> <span class="n">up64</span><span class="p">(</span><span class="n">xres_n</span> <span class="o">+</span> <span class="n">fconst</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min_fstrt</span> <span class="o">+</span> <span class="n">fsize</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">&gt;</span> <span class="n">maxfetchstop</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_SMOOTH_XPAN</span><span class="p">;</span>

		<span class="n">fsize</span> <span class="o">=</span> <span class="n">up64</span><span class="p">(</span><span class="n">xres_n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min_fstrt</span> <span class="o">+</span> <span class="n">fsize</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">&gt;</span> <span class="n">maxfetchstop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;fetch size too high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fsize</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fsize</span> <span class="o">-=</span> <span class="n">fconst</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if there is enough time to update the bitplane pointers for ywrap</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">-</span> <span class="n">fsize</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bitplane calculations and check the Memory Requirements</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amifb_ilbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span> <span class="o">=</span> <span class="n">div8</span><span class="p">(</span><span class="n">upx</span><span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vxres</span><span class="p">));</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;too few video mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">=</span> <span class="n">div8</span><span class="p">(</span><span class="n">upx</span><span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vxres</span><span class="p">));</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;too few video mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware Register Values</span>
<span class="cm">	 */</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">=</span> <span class="n">BPC0_COLOR</span> <span class="o">|</span> <span class="n">bplpixmode</span><span class="p">[</span><span class="n">clk_shift</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">|=</span> <span class="n">BPC0_ECSENA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">|=</span> <span class="n">BPC0_BPU3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">|=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">==</span> <span class="n">FB_NONSTD_HAM</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">|=</span> <span class="n">BPC0_HAM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_EXT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">|=</span> <span class="n">BPC0_ERSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span> <span class="o">=</span> <span class="n">bplfetchmode</span><span class="p">[</span><span class="n">maxfmode</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VMODE_INTERLACED</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">|=</span> <span class="n">BPC0_LACE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VMODE_DOUBLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span> <span class="o">|=</span> <span class="n">FMODE_SSCAN2</span> <span class="o">|</span> <span class="n">FMODE_BSCAN2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">^</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span><span class="p">)</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">upx</span><span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vxres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_x</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_x</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill the `var&#39; structure based on the values in `par&#39; and maybe</span>
<span class="cm">	 * other values read out of the hardware.</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_encode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">clk_shift</span><span class="p">,</span> <span class="n">line_shift</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="p">));</span>

	<span class="n">clk_shift</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_shift</span><span class="p">;</span>
	<span class="n">line_shift</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">line_shift</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vxres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_HAM</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_HAM</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="n">FB_NONSTD_HAM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">pixclock</span><span class="p">[</span><span class="n">clk_shift</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_BSCAN2</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">&amp;</span> <span class="n">BMC0_VARBEAMEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstop</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">line_shift</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span><span class="o">&gt;&gt;</span><span class="n">line_shift</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="o">&gt;&gt;</span><span class="n">line_shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">&amp;</span> <span class="n">BMC0_HSYTRUE</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">&amp;</span> <span class="n">BMC0_VSYTRUE</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">&amp;</span> <span class="n">BMC0_CSYTRUE</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">FB_SYNC_BROADCAST</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">152</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">mod4</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">-</span> <span class="n">down4</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">4</span><span class="o">&gt;&gt;</span><span class="n">line_shift</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">line_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="p">(((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">line_shift</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span>
				    <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_ERSY</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_EXT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Update hardware</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_update_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">clk_shift</span><span class="p">,</span> <span class="n">vshift</span><span class="p">,</span> <span class="n">fstrt</span><span class="p">,</span> <span class="n">fsize</span><span class="p">,</span> <span class="n">fstop</span><span class="p">,</span> <span class="n">fconst</span><span class="p">,</span>  <span class="n">shift</span><span class="p">,</span> <span class="n">move</span><span class="p">,</span> <span class="n">mod</span><span class="p">;</span>

	<span class="n">clk_shift</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_SMOOTH_XPAN</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">upx</span><span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">);</span>

	<span class="n">fconst</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">;</span>
	<span class="n">vshift</span> <span class="o">=</span> <span class="n">modx</span><span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">);</span>
	<span class="n">fstrt</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">-</span> <span class="p">(</span><span class="n">vshift</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">fsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">vshift</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">clk_shift</span><span class="p">;</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">modx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">fstrt</span><span class="p">);</span>
	<span class="n">move</span> <span class="o">=</span> <span class="n">downx</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">div8</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxfmode</span> <span class="o">+</span> <span class="n">clk_shift</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fstrt</span> <span class="o">=</span> <span class="n">downx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">fstrt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">fsize</span> <span class="o">=</span> <span class="n">upx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">fsize</span><span class="p">);</span>
		<span class="n">fstop</span> <span class="o">=</span> <span class="n">fstrt</span> <span class="o">+</span> <span class="n">fsize</span> <span class="o">-</span> <span class="n">fconst</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mod</span> <span class="o">=</span> <span class="n">fstrt</span> <span class="o">=</span> <span class="n">downx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">fstrt</span><span class="p">)</span> <span class="o">-</span> <span class="n">fconst</span><span class="p">;</span>
		<span class="n">fstop</span> <span class="o">=</span> <span class="n">fstrt</span> <span class="o">+</span> <span class="n">upx</span><span class="p">(</span><span class="n">fconst</span><span class="p">,</span> <span class="n">fsize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">fsize</span> <span class="o">=</span> <span class="n">up64</span><span class="p">(</span><span class="n">fsize</span><span class="p">);</span>
		<span class="n">fstrt</span> <span class="o">=</span> <span class="n">fstop</span> <span class="o">-</span> <span class="n">fsize</span> <span class="o">+</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fstrt</span> <span class="o">&lt;</span> <span class="n">min_fstrt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fstop</span> <span class="o">+=</span> <span class="n">min_fstrt</span> <span class="o">-</span> <span class="n">fstrt</span><span class="p">;</span>
			<span class="n">fstrt</span> <span class="o">=</span> <span class="n">min_fstrt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">move</span> <span class="o">=</span> <span class="n">move</span> <span class="o">-</span> <span class="n">div8</span><span class="p">((</span><span class="n">mod</span> <span class="o">-</span> <span class="n">fstrt</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mod</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">-</span> <span class="n">div8</span><span class="p">(</span><span class="n">fsize</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ddfstrt</span> <span class="o">=</span> <span class="n">fstrt</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ddfstop</span> <span class="o">=</span> <span class="n">fstop</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon1</span> <span class="o">=</span> <span class="n">hscroll2hw</span><span class="p">(</span><span class="n">shift</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpl2mod</span> <span class="o">=</span> <span class="n">mod</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpl2mod</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_BSCAN2</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpl1mod</span> <span class="o">=</span> <span class="o">-</span><span class="n">div8</span><span class="p">(</span><span class="n">fsize</span><span class="o">&gt;&gt;</span><span class="n">clk_shift</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bpl1mod</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpl2mod</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span>
			      <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">move</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0wrap</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">move</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span> <span class="o">&amp;&amp;</span>
				    <span class="n">mod2</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span>
					 <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">))</span>
					<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0wrap</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">move</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span> <span class="o">&amp;&amp;</span> <span class="n">mod2</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Pan or Wrap the Display</span>
<span class="cm">	 *</span>
<span class="cm">	 * This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag</span>
<span class="cm">	 * in `var&#39;.</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_pan_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>

	<span class="n">do_vmode_pan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ami_update_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">do_vmode_pan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_update_display</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">bplcon1</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon1</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">bpl1mod</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpl1mod</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">bpl2mod</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bpl2mod</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">ddfstrt</span> <span class="o">=</span> <span class="n">ddfstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ddfstrt</span><span class="p">);</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">ddfstop</span> <span class="o">=</span> <span class="n">ddfstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ddfstop</span><span class="p">);</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change the video mode (called by VBlank interrupt)</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_init_display</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">bplcon0</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BPC0_LACE</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">bplcon2</span> <span class="o">=</span> <span class="p">(</span><span class="n">IS_OCS</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">BPC2_KILLEHB</span><span class="p">)</span> <span class="o">|</span> <span class="n">BPC2_PF2P2</span> <span class="o">|</span> <span class="n">BPC2_PF1P2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">bplcon4</span> <span class="o">=</span> <span class="n">BPC4_ESPRM4</span> <span class="o">|</span> <span class="n">BPC4_OSPRM4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">&amp;</span> <span class="n">BMC0_VARBEAMEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">htotal2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">hbstrt</span> <span class="o">=</span> <span class="n">hbstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hbstrt</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">hbstop</span> <span class="o">=</span> <span class="n">hbstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hbstop</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="n">hsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">hsstop</span> <span class="o">=</span> <span class="n">hsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">hcenter</span> <span class="o">=</span> <span class="n">hcenter2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hcenter</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">vtotal2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">vbstrt</span> <span class="o">=</span> <span class="n">vbstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbstrt</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">vbstop</span> <span class="o">=</span> <span class="n">vbstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbstop</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="n">vsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">vsstop</span> <span class="o">=</span> <span class="n">vsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstop</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span><span class="p">)</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">fmode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The minimum period for audio depends on htotal</span>
<span class="cm">	 */</span>

	<span class="n">amiga_audio_min_period</span> <span class="o">=</span> <span class="n">div16</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>

	<span class="n">is_lace</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lace</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">vposr</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">vposw</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">vposr</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">vposw</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">vposr</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">cop2lc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">currentcop</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (Un)Blank the screen (called by VBlank interrupt)</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_do_blank</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_FB_AMIGA_AGA)</span>
	<span class="n">u_short</span> <span class="n">bplcon3</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u_char</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_blank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">DMAF_RASTER</span> <span class="o">|</span> <span class="n">DMAF_SPRITE</span><span class="p">;</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span> <span class="o">&amp;&amp;</span> <span class="n">do_blank</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">do_blank</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
				<span class="n">custom</span><span class="p">.</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="n">hsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">hsstop</span> <span class="o">=</span> <span class="n">hsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="n">vsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">vsstop</span> <span class="o">=</span> <span class="n">vsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
				<span class="n">custom</span><span class="p">.</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="n">hsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">hsstop</span> <span class="o">=</span> <span class="n">hsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="n">vsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">vsstop</span> <span class="o">=</span> <span class="n">vsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstop</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
				<span class="n">custom</span><span class="p">.</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="n">hsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">hsstop</span> <span class="o">=</span> <span class="n">hsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="n">vsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">vsstop</span> <span class="o">=</span> <span class="n">vsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span> <span class="o">&amp;</span> <span class="n">BMC0_VARBEAMEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">htotal2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">vtotal2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="n">BMC0_HARDDIS</span> <span class="o">|</span> <span class="n">BMC0_VARBEAMEN</span> <span class="o">|</span>
						  <span class="n">BMC0_VARVSYEN</span> <span class="o">|</span> <span class="n">BMC0_VARHSYEN</span> <span class="o">|</span> <span class="n">BMC0_VARCSYEN</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">DMAF_SETCLR</span> <span class="o">|</span> <span class="n">DMAF_RASTER</span> <span class="o">|</span> <span class="n">DMAF_SPRITE</span><span class="p">;</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">red0</span><span class="p">;</span>
		<span class="n">green</span> <span class="o">=</span> <span class="n">green0</span><span class="p">;</span>
		<span class="n">blue</span> <span class="o">=</span> <span class="n">blue0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">hsstrt</span> <span class="o">=</span> <span class="n">hsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstrt</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">hsstop</span> <span class="o">=</span> <span class="n">hsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hsstop</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">vsstrt</span> <span class="o">=</span> <span class="n">vsstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstrt</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">vsstop</span> <span class="o">=</span> <span class="n">vsstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsstop</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">beamcon0</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">beamcon0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if defined(CONFIG_FB_AMIGA_AGA)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">bplcon3</span><span class="p">;</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb2hw8_high</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">bplcon3</span> <span class="o">|</span> <span class="n">BPC3_LOCT</span><span class="p">;</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb2hw8_low</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">bplcon3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_FB_AMIGA_ECS)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_SHRES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="n">color</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3333</span><span class="p">;</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">rgb2hw2</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">color</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">color</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">color</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb2hw4</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
	<span class="n">is_blanked</span> <span class="o">=</span> <span class="n">do_blank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">do_blank</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ami_get_fix_cursorinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_cursorinfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">crsr_width</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">crsr_xsize</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">crsr_height</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">crsr_ysize</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">crsr_color1</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">crsr_color2</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ami_get_var_cursorinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_cursorinfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				  <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_short</span> <span class="o">*</span><span class="n">lspr</span><span class="p">,</span> <span class="o">*</span><span class="n">sspr</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
	<span class="k">register</span> <span class="n">u_long</span> <span class="n">datawords</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;d2&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">register</span> <span class="n">u_long</span> <span class="n">datawords</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">register</span> <span class="kt">short</span> <span class="n">delta</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">color</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">words</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">alloc</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">alloc</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xspot</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_x</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yspot</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_y</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fmode</span><span class="p">;</span>
	<span class="n">lspr</span> <span class="o">=</span> <span class="n">lofsprite</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span>
		<span class="n">sspr</span> <span class="o">=</span> <span class="n">shfsprite</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sspr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">words</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span> <span class="n">datawords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">width</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="o">--</span><span class="n">words</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
				<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;movew %1@(%3:w:2),%0 ; swap %0 ; movew %1@+,%0&quot;</span>
					<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">datawords</span><span class="p">),</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">delta</span><span class="p">));</span>
<span class="cp">#else</span>
				<span class="n">datawords</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">lspr</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">lspr</span><span class="o">++</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="o">--</span><span class="n">bits</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
			<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
				<span class="s">&quot;clrb %0 ; swap %1 ; lslw #1,%1 ; roxlb #1,%0 ; &quot;</span>
				<span class="s">&quot;swap %1 ; lslw #1,%1 ; roxlb #1,%0&quot;</span>
				<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">datawords</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">datawords</span><span class="p">));</span>
<span class="cp">#else</span>
			<span class="n">color</span> <span class="o">=</span> <span class="p">(((</span><span class="n">datawords</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
				 <span class="o">|</span> <span class="p">((</span><span class="n">datawords</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">datawords</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">put_user</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">data</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">--</span><span class="n">words</span><span class="p">;</span> <span class="o">++</span><span class="n">lspr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">words</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">++</span><span class="n">lspr</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;lea %0@(%4:w:2),%0 ; tstl %1 ; jeq 1f ; exg %0,%1</span><span class="se">\n</span><span class="s">1:&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">sspr</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">sspr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">delta</span><span class="p">));</span>
<span class="cp">#else</span>
		<span class="n">lspr</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sspr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">lspr</span><span class="p">;</span>
			<span class="n">lspr</span> <span class="o">=</span> <span class="n">sspr</span><span class="p">;</span>
			<span class="n">sspr</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ami_set_var_cursorinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_cursorinfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				  <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_short</span> <span class="o">*</span><span class="n">lspr</span><span class="p">,</span> <span class="o">*</span><span class="n">sspr</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
	<span class="k">register</span> <span class="n">u_long</span> <span class="n">datawords</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;d2&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">register</span> <span class="n">u_long</span> <span class="n">datawords</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">register</span> <span class="kt">short</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">fmode</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">words</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">fmode</span> <span class="o">=</span> <span class="n">TAG_FMODE_1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">fmode</span> <span class="o">=</span> <span class="n">TAG_FMODE_2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">fmode</span> <span class="o">=</span> <span class="n">TAG_FMODE_4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmode</span> <span class="o">&gt;</span> <span class="n">maxfmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fmode</span><span class="p">;</span>
	<span class="n">lofsprite</span> <span class="o">=</span> <span class="n">shfsprite</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">spritememory</span><span class="p">;</span>
	<span class="n">lspr</span> <span class="o">=</span> <span class="n">lofsprite</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">fmode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SPRITEMEMSIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lspr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">fmode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">shfsprite</span> <span class="o">+=</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span><span class="o">&amp;-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">fmode</span><span class="p">;</span>
		<span class="n">sspr</span> <span class="o">=</span> <span class="n">shfsprite</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">fmode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SPRITEMEMSIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lspr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">fmode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">sspr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">words</span> <span class="o">=</span> <span class="n">delta</span><span class="p">;</span> <span class="n">datawords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">width</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">get_user</span><span class="p">(</span><span class="n">tdata</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">data</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
			<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
				<span class="s">&quot;lsrb #1,%2 ; roxlw #1,%0 ; swap %0 ; &quot;</span>
				<span class="s">&quot;lsrb #1,%2 ; roxlw #1,%0 ; swap %0&quot;</span>
				<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">datawords</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">datawords</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">tdata</span><span class="p">));</span>
<span class="cp">#else</span>
			<span class="n">datawords</span> <span class="o">=</span> <span class="p">((</span><span class="n">datawords</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffefffe</span><span class="p">);</span>
			<span class="n">datawords</span> <span class="o">|=</span> <span class="n">tdata</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">datawords</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tdata</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="o">--</span><span class="n">words</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
				<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;swap %2 ; movew %2,%0@(%3:w:2) ; swap %2 ; movew %2,%0@+&quot;</span>
					<span class="o">:</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">datawords</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">delta</span><span class="p">));</span>
<span class="cp">#else</span>
				<span class="o">*</span><span class="p">(</span><span class="n">lspr</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">datawords</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="o">*</span><span class="n">lspr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">datawords</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">--</span><span class="n">words</span><span class="p">;</span>
<span class="cp">#ifdef __mc68000__</span>
			<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
				<span class="s">&quot;swap %2 ; lslw %4,%2 ; movew %2,%0@(%3:w:2) ; &quot;</span>
				<span class="s">&quot;swap %2 ; lslw %4,%2 ; movew %2,%0@+&quot;</span>
				<span class="o">:</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">datawords</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">bits</span><span class="p">));</span>
<span class="cp">#else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">lspr</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">datawords</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="n">bits</span><span class="p">));</span>
			<span class="o">*</span><span class="n">lspr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">((</span><span class="n">datawords</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">bits</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">words</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __mc68000__</span>
			<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;moveql #0,%%d0 ; movew %%d0,%0@(%2:w:2) ; movew %%d0,%0@+&quot;</span>
				<span class="o">:</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;d0&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">lspr</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">lspr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
<span class="cp">#ifdef __mc68000__</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;lea %0@(%4:w:2),%0 ; tstl %1 ; jeq 1f ; exg %0,%1</span><span class="se">\n</span><span class="s">1:&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">sspr</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">lspr</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">sspr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">delta</span><span class="p">));</span>
<span class="cp">#else</span>
		<span class="n">lspr</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sspr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">lspr</span><span class="p">;</span>
			<span class="n">lspr</span> <span class="o">=</span> <span class="n">sspr</span><span class="p">;</span>
			<span class="n">sspr</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_x</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xspot</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_y</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yspot</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fmode</span> <span class="o">=</span> <span class="n">fmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMODE_SPAGEM</span> <span class="o">|</span> <span class="n">FMODE_SPR32</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span> <span class="o">|=</span> <span class="n">sprfetchmode</span><span class="p">[</span><span class="n">fmode</span><span class="p">];</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">fmode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ami_get_cursorstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_cursorstate</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_x</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_y</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cursormode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ami_set_cursorstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_cursorstate</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_x</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_y</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cursormode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_CURSOR_OFF</span><span class="p">)</span>
		<span class="n">cursorstate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">do_cursor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_set_sprite</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">copl</span><span class="p">,</span> <span class="o">*</span><span class="n">cops</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">hs</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">ve</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">pl</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">pt</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">mx</span><span class="p">,</span> <span class="n">my</span><span class="p">;</span>

	<span class="n">cops</span> <span class="o">=</span> <span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">currentcop</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">copl</span> <span class="o">=</span> <span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">currentcop</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">dummysprite</span><span class="p">);</span>
	<span class="n">mx</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_x</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_x</span><span class="p">;</span>
	<span class="n">my</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">crsr_y</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">spot_y</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mx</span> <span class="o">-=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">my</span> <span class="o">-=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_blanked</span> <span class="o">&amp;&amp;</span> <span class="n">cursorstate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;&amp;</span> <span class="n">mx</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;&amp;</span>
	    <span class="n">my</span> <span class="o">&gt;</span> <span class="o">-</span><span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span> <span class="o">&amp;&amp;</span> <span class="n">my</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pl</span> <span class="o">=</span> <span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">lofsprite</span><span class="p">);</span>
		<span class="n">hs</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">+</span> <span class="p">(</span><span class="n">mx</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">vs</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">+</span> <span class="p">(</span><span class="n">my</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">line_shift</span><span class="p">);</span>
		<span class="n">ve</span> <span class="o">=</span> <span class="n">vs</span> <span class="o">+</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">line_shift</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ps</span> <span class="o">=</span> <span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">shfsprite</span><span class="p">);</span>
			<span class="n">lofsprite</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_pos</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">hs</span><span class="p">);</span>
			<span class="n">shfsprite</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_pos</span><span class="p">(</span><span class="n">vs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mod2</span><span class="p">(</span><span class="n">vs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lofsprite</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fmode</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_ctl</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">ve</span><span class="p">);</span>
				<span class="n">shfsprite</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fmode</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_ctl</span><span class="p">(</span><span class="n">vs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">ve</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">pt</span> <span class="o">=</span> <span class="n">pl</span><span class="p">;</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">ps</span><span class="p">;</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">pt</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">lofsprite</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fmode</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_ctl</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">ve</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">shfsprite</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fmode</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_ctl</span><span class="p">(</span><span class="n">vs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">ve</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lofsprite</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_pos</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">hs</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">IS_AGA</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_BSCAN2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">lofsprite</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fmode</span><span class="p">]</span> <span class="o">=</span> <span class="n">spr2hw_ctl</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">ve</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">copl</span><span class="p">[</span><span class="n">cop_spr0ptrh</span><span class="p">].</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">highw</span><span class="p">(</span><span class="n">pl</span><span class="p">);</span>
	<span class="n">copl</span><span class="p">[</span><span class="n">cop_spr0ptrl</span><span class="p">].</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loww</span><span class="p">(</span><span class="n">pl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cops</span><span class="p">[</span><span class="n">cop_spr0ptrh</span><span class="p">].</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">highw</span><span class="p">(</span><span class="n">ps</span><span class="p">);</span>
		<span class="n">cops</span><span class="p">[</span><span class="n">cop_spr0ptrl</span><span class="p">].</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">loww</span><span class="p">(</span><span class="n">ps</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Initialise the Copper Initialisation List</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ami_init_copper</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">cop</span> <span class="o">=</span> <span class="n">copdisplay</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">BPC0_COLOR</span> <span class="o">|</span> <span class="n">BPC0_SHRES</span> <span class="o">|</span> <span class="n">BPC0_ECSENA</span><span class="p">,</span> <span class="n">bplcon0</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="mh">0x0181</span><span class="p">,</span> <span class="n">diwstrt</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="mh">0x0281</span><span class="p">,</span> <span class="n">diwstop</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">diwhigh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">BPC0_COLOR</span><span class="p">,</span> <span class="n">bplcon0</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">dummysprite</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">highw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">sprpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="n">loww</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">sprpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_COPER</span><span class="p">,</span> <span class="n">intreq</span><span class="p">);</span>
	<span class="n">copdisplay</span><span class="p">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">cop</span><span class="p">;</span>
	<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CEND</span><span class="p">;</span>
	<span class="p">(</span><span class="n">cop</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">copjmp2</span><span class="p">);</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CEND</span><span class="p">;</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">cop1lc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">init</span><span class="p">);</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">copjmp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_reinit_copper</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">copdisplay</span><span class="p">.</span><span class="n">init</span><span class="p">[</span><span class="n">cip_bplcon0</span><span class="p">].</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">BPC0_BPU3</span> <span class="o">|</span> <span class="n">BPC0_BPU2</span> <span class="o">|</span> <span class="n">BPC0_BPU1</span> <span class="o">|</span> <span class="n">BPC0_BPU0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span><span class="p">;</span>
	<span class="n">copdisplay</span><span class="p">.</span><span class="n">wait</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Rebuild the Copper List</span>
<span class="cm">	 *</span>
<span class="cm">	 * We only change the things that are not static</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_rebuild_copper</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">copl</span><span class="p">,</span> <span class="o">*</span><span class="n">cops</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">line</span><span class="p">,</span> <span class="n">h_end1</span><span class="p">,</span> <span class="n">h_end2</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span> <span class="o">&amp;&amp;</span> <span class="n">maxfmode</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">h_end1</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">h_end1</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">h_end2</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ddfstop</span> <span class="o">+</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">ami_set_sprite</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">copl</span> <span class="o">=</span> <span class="n">copdisplay</span><span class="p">.</span><span class="n">rebuild</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">mod2</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">highw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="n">loww</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">line</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">+</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">line_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="n">h_end1</span><span class="p">,</span> <span class="mi">510</span><span class="p">);</span>
					<span class="n">line</span> <span class="o">-=</span> <span class="mi">512</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">510</span> <span class="o">&amp;&amp;</span> <span class="n">IS_AGA</span> <span class="o">&amp;&amp;</span> <span class="n">maxfmode</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="n">h_end1</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="n">h_end2</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0wrap</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0wrap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">highw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="n">loww</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">copl</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CEND</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cops</span> <span class="o">=</span> <span class="n">copdisplay</span><span class="p">.</span><span class="n">rebuild</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mod2</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">))</span>
			<span class="n">p</span> <span class="o">-=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">mod2</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">)</span> <span class="p">{</span>
						<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">highw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
						<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="n">loww</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="p">}</span>
					<span class="n">line</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">+</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">line_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
						<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="n">h_end1</span><span class="p">,</span> <span class="mi">510</span><span class="p">);</span>
						<span class="n">line</span> <span class="o">-=</span> <span class="mi">512</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;</span> <span class="mi">510</span> <span class="o">&amp;&amp;</span> <span class="n">IS_AGA</span> <span class="o">&amp;&amp;</span> <span class="n">maxfmode</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clk_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="n">h_end1</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="n">h_end2</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
					<span class="n">p</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0wrap</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mod2</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vyres</span> <span class="o">-</span>
					    <span class="n">par</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">))</span>
						<span class="n">p</span> <span class="o">-=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">p</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplpt0wrap</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">highw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="n">loww</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">bplpt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">cops</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CEND</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Build the Copper List</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ami_build_copper</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">copins</span> <span class="o">*</span><span class="n">copl</span><span class="p">,</span> <span class="o">*</span><span class="n">cops</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">currentcop</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">currentcop</span><span class="p">;</span>

	<span class="n">copl</span> <span class="o">=</span> <span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">currentcop</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

	<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span><span class="p">,</span> <span class="n">bplcon0</span><span class="p">);</span>
	<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sprpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sprpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_LACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cops</span> <span class="o">=</span> <span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">currentcop</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CWAIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span><span class="p">,</span> <span class="n">bplcon0</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sprpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sprpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">diwstrt</span><span class="p">);</span>
		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">diwstop</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">),</span> <span class="n">diwstrt</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span><span class="p">),</span> <span class="n">diwstop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwhigh2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">diwhigh</span><span class="p">);</span>
			<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwhigh2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">,</span>
					    <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span><span class="p">),</span> <span class="n">diwhigh</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			if (par-&gt;beamcon0 &amp; BMC0_VARBEAMEN) {</span>
<span class="c">				(copl++)-&gt;l = CMOVE(vtotal2hw(par-&gt;vtotal), vtotal);</span>
<span class="c">				(copl++)-&gt;l = CMOVE(vbstrt2hw(par-&gt;vbstrt + 1), vbstrt);</span>
<span class="c">				(copl++)-&gt;l = CMOVE(vbstop2hw(par-&gt;vbstop + 1), vbstop);</span>
<span class="c">				(cops++)-&gt;l = CMOVE(vtotal2hw(par-&gt;vtotal), vtotal);</span>
<span class="c">				(cops++)-&gt;l = CMOVE(vbstrt2hw(par-&gt;vbstrt), vbstrt);</span>
<span class="c">				(cops++)-&gt;l = CMOVE(vbstop2hw(par-&gt;vbstop), vbstop);</span>
<span class="c">			}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">currentcop</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">highw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">cop2lc</span><span class="p">);</span>
		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="n">loww</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">cop2lc</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">currentcop</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">highw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">cop2lc</span><span class="p">);</span>
		<span class="p">(</span><span class="n">cops</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE2</span><span class="p">(</span><span class="n">loww</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">cop2lc</span><span class="p">);</span>
		<span class="n">copdisplay</span><span class="p">.</span><span class="n">rebuild</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwstrt2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">),</span> <span class="n">diwstrt</span><span class="p">);</span>
		<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwstop2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span><span class="p">),</span> <span class="n">diwstop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_OCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">copl</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">CMOVE</span><span class="p">(</span><span class="n">diwhigh2hw</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstrt_v</span><span class="p">,</span>
					    <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_h</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">diwstop_v</span><span class="p">),</span> <span class="n">diwhigh</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			if (par-&gt;beamcon0 &amp; BMC0_VARBEAMEN) {</span>
<span class="c">				(copl++)-&gt;l = CMOVE(vtotal2hw(par-&gt;vtotal), vtotal);</span>
<span class="c">				(copl++)-&gt;l = CMOVE(vbstrt2hw(par-&gt;vbstrt), vbstrt);</span>
<span class="c">				(copl++)-&gt;l = CMOVE(vbstop2hw(par-&gt;vbstop), vbstop);</span>
<span class="c">			}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">copdisplay</span><span class="p">.</span><span class="n">rebuild</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copl</span><span class="p">;</span>

	<span class="n">ami_update_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">ami_rebuild_copper</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">amifb_setup_mcap</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">hmin</span><span class="p">,</span> <span class="n">hmax</span><span class="p">;</span>

	<span class="cm">/* Format for monitor capabilities is: &lt;Vmin&gt;;&lt;Vmax&gt;;&lt;Hmin&gt;;&lt;Hmax&gt;</span>
<span class="cm">	 * &lt;V*&gt; vertical freq. in Hz</span>
<span class="cm">	 * &lt;H*&gt; horizontal freq. in kHz</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">vmin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmin</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">vmax</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vmax</span> <span class="o">&lt;=</span> <span class="n">vmin</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">hmin</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmin</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">hmax</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmax</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hmax</span> <span class="o">&lt;=</span> <span class="n">hmin</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">amifb_hfmin</span> <span class="o">=</span> <span class="n">hmin</span><span class="p">;</span>
	<span class="n">amifb_hfmax</span> <span class="o">=</span> <span class="n">hmax</span><span class="p">;</span>
	<span class="n">amifb_vfmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">;</span>
	<span class="n">amifb_vfmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amifb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;inverse&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">amifb_inverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fb_invert_cmaps</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;ilbm&quot;</span><span class="p">))</span>
			<span class="n">amifb_ilbm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;monitorcap:&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
			<span class="n">amifb_setup_mcap</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">11</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;fstart:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">min_fstrt</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">min_fstrt</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">)</span>
		<span class="n">min_fstrt</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">amifb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="n">par</span><span class="p">;</span>

	<span class="cm">/* Validate wanted screen parameters */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ami_decode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Encode (possibly rounded) screen parameters */</span>
	<span class="n">ami_encode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">amifb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">do_vmode_pan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">do_vmode_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Decode wanted screen parameters */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ami_decode_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Set new videomode */</span>
	<span class="n">ami_build_copper</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Set VBlank trigger */</span>
	<span class="n">do_vmode_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Update fix for new screen parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">amifb_ilbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PLANES</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">div8</span><span class="p">(</span><span class="n">upx</span><span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vxres</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YWRAP</span> <span class="o">|</span>
			<span class="n">FBINFO_READS_FAST</span><span class="p">;</span> <span class="cm">/* override SCROLL_REDRAW */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_SMOOTH_XPAN</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Set a single color register. The values supplied are already</span>
<span class="cm">	 * rounded down to the hardware&#39;s capabilities (according to the</span>
<span class="cm">	 * entries in the var structure). Return != 0 for invalid regno.</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amifb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_SHRES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regno</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">red0</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
		<span class="n">green0</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
		<span class="n">blue0</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the corresponding Hardware Color Register, unless it&#39;s Color</span>
<span class="cm">	 * Register 0 and the screen is blanked.</span>
<span class="cm">	 *</span>
<span class="cm">	 * VBlank is switched off to protect bplcon3 or ecs_palette[] from</span>
<span class="cm">	 * being changed by ami_do_blank() during the VBlank.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_blanked</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_FB_AMIGA_AGA)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_AGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="n">bplcon3</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon3</span><span class="p">;</span>
			<span class="n">VBlankOff</span><span class="p">();</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">bplcon3</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="n">regno</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb2hw8_high</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span>
								<span class="n">blue</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">bplcon3</span> <span class="o">|</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BPC3_LOCT</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="n">regno</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb2hw8_low</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span>
							       <span class="n">blue</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">bplcon3</span> <span class="o">=</span> <span class="n">bplcon3</span><span class="p">;</span>
			<span class="n">VBlankOn</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_FB_AMIGA_ECS)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bplcon0</span> <span class="o">&amp;</span> <span class="n">BPC0_SHRES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="n">color</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3333</span><span class="p">;</span>
			<span class="n">color</span> <span class="o">=</span> <span class="n">rgb2hw2</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
			<span class="n">VBlankOff</span><span class="p">();</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">regno</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">regno</span><span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">color</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">color</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">regno</span> <span class="o">=</span> <span class="n">down16</span><span class="p">(</span><span class="n">regno</span><span class="p">)</span> <span class="o">+</span> <span class="n">mul4</span><span class="p">(</span><span class="n">mod4</span><span class="p">(</span><span class="n">regno</span><span class="p">));</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">regno</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">regno</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecs_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">color</span><span class="p">;</span>
			<span class="n">VBlankOn</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">color</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb2hw4</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Blank the display.</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amifb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_blank</span> <span class="o">=</span> <span class="n">blank</span> <span class="o">?</span> <span class="n">blank</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Pan or Wrap the Display</span>
<span class="cm">	 *</span>
<span class="cm">	 * This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amifb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: There will be problems when xpan!=1, so some columns</span>
<span class="cm">		 * on the right side will never be seen</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span>
		    <span class="n">upx</span><span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="n">maxfmode</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ami_pan_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if BITS_PER_LONG == 32</span>
<span class="cp">#define BYTES_PER_LONG	4</span>
<span class="cp">#define SHIFT_PER_LONG	5</span>
<span class="cp">#elif BITS_PER_LONG == 64</span>
<span class="cp">#define BYTES_PER_LONG	8</span>
<span class="cp">#define SHIFT_PER_LONG	6</span>
<span class="cp">#else</span>
<span class="cp">#define Please update me</span>
<span class="cp">#endif</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Compose two values, using a bitmask as decision value</span>
<span class="cm">	 *  This is equivalent to (a &amp; mask) | (b &amp; ~mask)</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">comp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">^</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">xor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">^</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Unaligned forward bit copy using 32-bit or 64-bit memory accesses</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitcpy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">-</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">-</span> <span class="n">src_idx</span><span class="p">;</span>
	<span class="n">first</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="n">dst_idx</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shift</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Same alignment for source and dest</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Single word</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Multiple destination words
Leading bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
				<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
				<span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>			<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Different alignment for source and dest</p></td><td class="code"><div class="highlight"><pre>		<span class="n">right</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">left</span> <span class="o">=</span> <span class="o">-</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Single destination word</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>				<span class="n">d0</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					    <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Multiple destination words</p></td><td class="code"><div class="highlight"><pre>			<span class="n">d0</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Leading bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
				<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					    <span class="n">first</span><span class="p">);</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>			<span class="n">m</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>					<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>					<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
					<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span>
						    <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Unaligned reverse bit copy using 32-bit or 64-bit memory accesses</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitcpy_rev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">-</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">dst_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">&amp;=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">src_idx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">src_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">src_idx</span> <span class="o">&amp;=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">-</span> <span class="n">src_idx</span><span class="p">;</span>
	<span class="n">first</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">);</span>
	<span class="n">last</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">dst_idx</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shift</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Same alignment for source and dest</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Single word</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Multiple destination words
Leading bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
				<span class="n">dst</span><span class="o">--</span><span class="p">;</span>
				<span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">dst_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>			<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Different alignment for source and dest</p></td><td class="code"><div class="highlight"><pre>		<span class="n">right</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">left</span> <span class="o">=</span> <span class="o">-</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Single destination word</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">src_idx</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>				<span class="n">d0</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					    <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Multiple destination words</p></td><td class="code"><div class="highlight"><pre>			<span class="n">d0</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Leading bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
				<span class="n">dst</span><span class="o">--</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">dst_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					    <span class="n">first</span><span class="p">);</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">dst</span><span class="o">--</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">dst_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>			<span class="n">m</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">--</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">left</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>					<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>					<span class="n">d1</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
					<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span>
						    <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Unaligned forward inverting bit copy using 32-bit or 64-bit memory</span>
<span class="cm">	 *  accesses</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitcpy_not</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">-</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">-</span> <span class="n">src_idx</span><span class="p">;</span>
	<span class="n">first</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="n">dst_idx</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shift</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Same alignment for source and dest</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Single word</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">~*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Multiple destination words
Leading bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">~*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
				<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
				<span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>			<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">~*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Different alignment for source and dest</p></td><td class="code"><div class="highlight"><pre>		<span class="n">right</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">left</span> <span class="o">=</span> <span class="o">-</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Single destination word</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">~*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="o">~*</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>				<span class="n">d0</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					    <span class="n">first</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Multiple destination words</p></td><td class="code"><div class="highlight"><pre>			<span class="n">d0</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Leading bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
				<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>				<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
					    <span class="n">first</span><span class="p">);</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>			<span class="n">m</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">;</span>
				<span class="n">d0</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Single source word</p></td><td class="code"><div class="highlight"><pre>					<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>2 source words</p></td><td class="code"><div class="highlight"><pre>					<span class="n">d1</span> <span class="o">=</span> <span class="o">~*</span><span class="n">src</span><span class="p">;</span>
					<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">d0</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">|</span> <span class="n">d1</span> <span class="o">&gt;&gt;</span> <span class="n">right</span><span class="p">,</span>
						    <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Unaligned 32-bit pattern fill using 32/64-bit memory accesses</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitfill32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pat</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">first</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="n">dst_idx</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Single word</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Multiple destination words
Leading bits</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>		<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">comp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Unaligned 32-bit pattern xor using 32/64-bit memory accesses</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitxor32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pat</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">first</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="n">dst_idx</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">BITS_PER_LONG</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Single word</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">&amp;=</span> <span class="n">last</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Multiple destination words
Leading bits</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="n">dst_idx</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>Main chunk</p></td><td class="code"><div class="highlight"><pre>		<span class="n">n</span> <span class="o">/=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">^=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">^=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">^=</span> <span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">^=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">^=</span> <span class="n">val</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Trailing bits</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fill_one_line</span><span class="p">(</span><span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_plane</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">dst_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bitfill32</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">color</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">bpp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">color</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">next_plane</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xor_one_line</span><span class="p">(</span><span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_plane</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">dst_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bitxor32</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">color</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">bpp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">color</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">next_plane</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">amifb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could use hardware clipping but on many cards you get around</span>
<span class="cm">	 * hardware clipping by writing to framebuffer directly.</span>
<span class="cm">	 * */</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">dst_idx</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROP_COPY</span>:
			<span class="n">fill_one_line</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
				      <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
				      <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ROP_XOR</span>:
			<span class="n">xor_one_line</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">,</span>
				     <span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">copy_one_line</span><span class="p">(</span><span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_plane</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">dst_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">src_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">src_idx</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bitcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">bpp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">next_plane</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">src_idx</span> <span class="o">+=</span> <span class="n">next_plane</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">copy_one_line_rev</span><span class="p">(</span><span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_plane</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">dst_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">src_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">src_idx</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bitcpy_rev</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">bpp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">next_plane</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">src_idx</span> <span class="o">+=</span> <span class="n">next_plane</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">amifb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rev_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clip the destination */</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">||</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">&lt;</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* update sx,sy */</span>
	<span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span> <span class="o">-</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">);</span>
	<span class="n">sy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">-</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">);</span>

	<span class="cm">/* the source must be completely inside the virtual screen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">||</span>
			<span class="n">sy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">sy</span> <span class="o">||</span> <span class="p">(</span><span class="n">dy</span> <span class="o">==</span> <span class="n">sy</span> <span class="o">&amp;&amp;</span> <span class="n">dx</span> <span class="o">&gt;</span> <span class="n">sx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dy</span> <span class="o">+=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">sy</span> <span class="o">+=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">rev_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">dst_idx</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">src_idx</span> <span class="o">=</span> <span class="n">dst_idx</span><span class="p">;</span>
	<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">src_idx</span> <span class="o">+=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">sx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rev_copy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst_idx</span> <span class="o">-=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">src_idx</span> <span class="o">-=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">copy_one_line_rev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
					  <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
					  <span class="n">src_idx</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">copy_one_line</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
				      <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
				      <span class="n">src_idx</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
			<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">src_idx</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">expand_one_line</span><span class="p">(</span><span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_plane</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bgcolor</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fgcolor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">src_idx</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">dst_idx</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_PER_LONG</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bgcolor</span> <span class="o">^</span> <span class="n">fgcolor</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">src_idx</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fgcolor</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">bitcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bitcpy_not</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="cm">/* set or clear */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bitfill32</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">fgcolor</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">bpp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">bgcolor</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fgcolor</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">next_plane</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">amifb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pitch</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could use hardware clipping but on many cards you get around</span>
<span class="cm">	 * hardware clipping by writing to framebuffer directly like we are</span>
<span class="cm">	 * doing here.</span>
<span class="cm">	 */</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">width</span>  <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">dst_idx</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">dx</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">expand_one_line</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
					<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst_idx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
					<span class="n">src</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">,</span>
					<span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
			<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">src</span> <span class="o">+=</span> <span class="n">pitch</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c2p_planar</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
			   <span class="n">height</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_plane</span><span class="p">,</span>
			   <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Amiga Frame Buffer Specific ioctls</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amifb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_fix_cursorinfo</span> <span class="n">fix</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fb_var_cursorinfo</span> <span class="n">var</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fb_cursorstate</span> <span class="n">state</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">crsr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIOGET_FCURSORINFO</span>:
		<span class="n">i</span> <span class="o">=</span> <span class="n">ami_get_fix_cursorinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fix</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">fix</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">crsr</span><span class="p">.</span><span class="n">fix</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FBIOGET_VCURSORINFO</span>:
		<span class="n">i</span> <span class="o">=</span> <span class="n">ami_get_var_cursorinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">var</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">fb_var_cursorinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">var</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">crsr</span><span class="p">.</span><span class="n">var</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FBIOPUT_VCURSORINFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crsr</span><span class="p">.</span><span class="n">var</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ami_set_var_cursorinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">var</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">fb_var_cursorinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">FBIOGET_CURSORSTATE</span>:
		<span class="n">i</span> <span class="o">=</span> <span class="n">ami_get_cursorstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">state</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">crsr</span><span class="p">.</span><span class="n">state</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FBIOPUT_CURSORSTATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crsr</span><span class="p">.</span><span class="n">state</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ami_set_cursorstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crsr</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Flash the cursor (called by VBlank interrupt)</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flash_cursor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cursorcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursormode</span> <span class="o">==</span> <span class="n">FB_CURSOR_FLASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">cursorcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cursorstate</span> <span class="o">=</span> <span class="o">-</span><span class="n">cursorstate</span><span class="p">;</span>
			<span class="n">cursorcount</span> <span class="o">=</span> <span class="n">cursorrate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_blanked</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * VBlank Display Interrupt</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">amifb_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amifb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_pan</span> <span class="o">||</span> <span class="n">do_vmode_full</span><span class="p">)</span>
		<span class="n">ami_update_display</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_full</span><span class="p">)</span>
		<span class="n">ami_init_display</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_pan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flash_cursor</span><span class="p">();</span>
		<span class="n">ami_rebuild_copper</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">do_cursor</span> <span class="o">=</span> <span class="n">do_vmode_pan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">do_cursor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flash_cursor</span><span class="p">();</span>
		<span class="n">ami_set_sprite</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">do_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flash_cursor</span><span class="p">())</span>
			<span class="n">ami_set_sprite</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ami_do_blank</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">do_blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_vmode_full</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ami_reinit_copper</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">do_vmode_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">amifb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">amifb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">amifb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">amifb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">amifb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">amifb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">amifb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">amifb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">amifb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">amifb_ioctl</span><span class="p">,</span>
<span class="p">};</span>


	<span class="cm">/*</span>
<span class="cm">	 * Allocate, Clear and Align a Block of Chip Memory</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">aligned_chipptr</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_long</span> <span class="n">__init</span> <span class="nf">chipalloc</span><span class="p">(</span><span class="n">u_long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aligned_chipptr</span> <span class="o">=</span> <span class="n">amiga_chip_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;amifb [RAM]&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aligned_chipptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;amifb: No Chip RAM for frame buffer&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">aligned_chipptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">aligned_chipptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">chipfree</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aligned_chipptr</span><span class="p">)</span>
		<span class="n">amiga_chip_free</span><span class="p">(</span><span class="n">aligned_chipptr</span><span class="p">);</span>
<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Initialisation</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amifb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">chipptr</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">defmode</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;amifb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">amifb_video_off</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">amifb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">DMAF_ALL</span> <span class="o">|</span> <span class="n">DMAF_MASTER</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amifb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;framebuffer_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Amiga &quot;</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_AMIGABLITT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">amiga_chipset</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_AMIGA_OCS</span>
	<span class="k">case</span> <span class="n">CS_OCS</span>:
		<span class="n">strcat</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;OCS&quot;</span><span class="p">);</span>
<span class="nl">default_chipset:</span>
		<span class="n">chipset</span> <span class="o">=</span> <span class="n">TAG_OCS</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_SHRES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* OCS means no SHRES */</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_HIRES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_LORES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">maxfmode</span> <span class="o">=</span> <span class="n">TAG_FMODE_1</span><span class="p">;</span>
		<span class="n">defmode</span> <span class="o">=</span> <span class="n">amiga_vblank</span> <span class="o">==</span> <span class="mi">50</span> <span class="o">?</span> <span class="n">DEFMODE_PAL</span> <span class="o">:</span> <span class="n">DEFMODE_NTSC</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">VIDEOMEMSIZE_OCS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_AMIGA_OCS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_AMIGA_ECS</span>
	<span class="k">case</span> <span class="n">CS_ECS</span>:
		<span class="n">strcat</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ECS&quot;</span><span class="p">);</span>
		<span class="n">chipset</span> <span class="o">=</span> <span class="n">TAG_ECS</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_SHRES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_HIRES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_LORES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">maxfmode</span> <span class="o">=</span> <span class="n">TAG_FMODE_1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AMIGAHW_PRESENT</span><span class="p">(</span><span class="n">AMBER_FF</span><span class="p">))</span>
			<span class="n">defmode</span> <span class="o">=</span> <span class="n">amiga_vblank</span> <span class="o">==</span> <span class="mi">50</span> <span class="o">?</span> <span class="n">DEFMODE_AMBER_PAL</span>
						     <span class="o">:</span> <span class="n">DEFMODE_AMBER_NTSC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">defmode</span> <span class="o">=</span> <span class="n">amiga_vblank</span> <span class="o">==</span> <span class="mi">50</span> <span class="o">?</span> <span class="n">DEFMODE_PAL</span>
						     <span class="o">:</span> <span class="n">DEFMODE_NTSC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amiga_chip_avail</span><span class="p">()</span> <span class="o">-</span> <span class="n">CHIPRAM_SAFETY_LIMIT</span> <span class="o">&gt;</span>
		    <span class="n">VIDEOMEMSIZE_ECS_2M</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">VIDEOMEMSIZE_ECS_2M</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">VIDEOMEMSIZE_ECS_1M</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_AMIGA_ECS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FB_AMIGA_AGA</span>
	<span class="k">case</span> <span class="n">CS_AGA</span>:
		<span class="n">strcat</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;AGA&quot;</span><span class="p">);</span>
		<span class="n">chipset</span> <span class="o">=</span> <span class="n">TAG_AGA</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_SHRES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_HIRES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">maxdepth</span><span class="p">[</span><span class="n">TAG_LORES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">maxfmode</span> <span class="o">=</span> <span class="n">TAG_FMODE_4</span><span class="p">;</span>
		<span class="n">defmode</span> <span class="o">=</span> <span class="n">DEFMODE_AGA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amiga_chip_avail</span><span class="p">()</span> <span class="o">-</span> <span class="n">CHIPRAM_SAFETY_LIMIT</span> <span class="o">&gt;</span>
		    <span class="n">VIDEOMEMSIZE_AGA_2M</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">VIDEOMEMSIZE_AGA_2M</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">VIDEOMEMSIZE_AGA_1M</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_AMIGA_AGA */</span><span class="cp"></span>

	<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_FB_AMIGA_OCS</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown graphics chipset, defaulting to OCS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">default_chipset</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_FB_AMIGA_OCS */</span><span class="cp"></span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_AMIGA_OCS */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate the Pixel Clock Values for this Machine</span>
<span class="cm">	 */</span>

	<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">DIVUL</span><span class="p">(</span><span class="mi">200000000000ULL</span><span class="p">,</span> <span class="n">amiga_eclock</span><span class="p">);</span>

	<span class="n">pixclock</span><span class="p">[</span><span class="n">TAG_SHRES</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* SHRES:  35 ns / 28 MHz */</span>
	<span class="n">pixclock</span><span class="p">[</span><span class="n">TAG_HIRES</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* HIRES:  70 ns / 14 MHz */</span>
	<span class="n">pixclock</span><span class="p">[</span><span class="n">TAG_LORES</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* LORES: 140 ns /  7 MHz */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Replace the Tag Values with the Real Pixel Clock Values</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TOTAL_MODES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ami_modedb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SHRES</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_HIRES</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_LORES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">pixclock</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amifb_hfmin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="n">amifb_hfmin</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">amifb_hfmax</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="n">amifb_vfmin</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">amifb_vfmax</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  These are for a typical Amiga monitor (e.g. A1960)</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">38000</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">49</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amifb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="n">ami_modedb</span><span class="p">,</span>
			  <span class="n">NUM_TOTAL_MODES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ami_modedb</span><span class="p">[</span><span class="n">defmode</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">ami_modedb</span><span class="p">,</span> <span class="n">NUM_TOTAL_MODES</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>

	<span class="n">round_down_bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chipptr</span> <span class="o">=</span> <span class="n">chipalloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">+</span> <span class="n">SPRITEMEMSIZE</span> <span class="o">+</span>
			    <span class="n">DUMMYSPRITEMEMSIZE</span> <span class="o">+</span> <span class="n">COPINITSIZE</span> <span class="o">+</span>
			    <span class="mi">4</span> <span class="o">*</span> <span class="n">COPLISTSIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chipptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">assignchunk</span><span class="p">(</span><span class="n">videomemory</span><span class="p">,</span> <span class="n">u_long</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">assignchunk</span><span class="p">(</span><span class="n">spritememory</span><span class="p">,</span> <span class="n">u_long</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">SPRITEMEMSIZE</span><span class="p">);</span>
	<span class="n">assignchunk</span><span class="p">(</span><span class="n">dummysprite</span><span class="p">,</span> <span class="n">u_short</span> <span class="o">*</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">DUMMYSPRITEMEMSIZE</span><span class="p">);</span>
	<span class="n">assignchunk</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">init</span><span class="p">,</span> <span class="n">copins</span> <span class="o">*</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">COPINITSIZE</span><span class="p">);</span>
	<span class="n">assignchunk</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">copins</span> <span class="o">*</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">COPLISTSIZE</span><span class="p">);</span>
	<span class="n">assignchunk</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">copins</span> <span class="o">*</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">COPLISTSIZE</span><span class="p">);</span>
	<span class="n">assignchunk</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">copins</span> <span class="o">*</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">COPLISTSIZE</span><span class="p">);</span>
	<span class="n">assignchunk</span><span class="p">(</span><span class="n">copdisplay</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">copins</span> <span class="o">*</span><span class="p">,</span> <span class="n">chipptr</span><span class="p">,</span> <span class="n">COPLISTSIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * access the videomem with writethrough cache</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">videomemory</span><span class="p">);</span>
	<span class="n">videomemory</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">ioremap_writethrough</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
						   <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">videomemory</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Unable to map videomem cached writethrough</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_VADDR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">videomemory</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dummysprite</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DUMMYSPRITEMEMSIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the Copper has something to do</span>
<span class="cm">	 */</span>
	<span class="n">ami_init_copper</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable Display DMA</span>
<span class="cm">	 */</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">DMAF_SETCLR</span> <span class="o">|</span> <span class="n">DMAF_MASTER</span> <span class="o">|</span> <span class="n">DMAF_RASTER</span> <span class="o">|</span> <span class="n">DMAF_COPPER</span> <span class="o">|</span>
			<span class="n">DMAF_BLITTER</span> <span class="o">|</span> <span class="n">DMAF_SPRITE</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_COPPER</span><span class="p">,</span> <span class="n">amifb_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="s">&quot;fb vertb handler&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_dma</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unset_drvdata</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fb%d: %s frame buffer device, using %dK of video memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unset_drvdata:</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_COPPER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
<span class="nl">disable_dma:</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">DMAF_ALL</span> <span class="o">|</span> <span class="n">DMAF_MASTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">videomemory</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">videomemory</span><span class="p">);</span>
	<span class="n">chipfree</span><span class="p">();</span>
<span class="nl">release:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">amifb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_COPPER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">DMAF_ALL</span> <span class="o">|</span> <span class="n">DMAF_MASTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">videomemory</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">videomemory</span><span class="p">);</span>
	<span class="n">chipfree</span><span class="p">();</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">amifb_video_off</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">amifb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">amifb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;amiga-video&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amifb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amifb_driver</span><span class="p">,</span> <span class="n">amifb_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">amifb_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">amifb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amifb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">amifb_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:amiga-video&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
