<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › sh_mipi_dsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sh_mipi_dsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Renesas SH-mobile MIPI DSI support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;video/mipi_display.h&gt;</span>
<span class="cp">#include &lt;video/sh_mipi_dsi.h&gt;</span>
<span class="cp">#include &lt;video/sh_mobile_lcdc.h&gt;</span>

<span class="cp">#include &quot;sh_mobile_lcdcfb.h&quot;</span>

<span class="cp">#define SYSCTRL		0x0000</span>
<span class="cp">#define SYSCONF		0x0004</span>
<span class="cp">#define TIMSET		0x0008</span>
<span class="cp">#define RESREQSET0	0x0018</span>
<span class="cp">#define RESREQSET1	0x001c</span>
<span class="cp">#define HSTTOVSET	0x0020</span>
<span class="cp">#define LPRTOVSET	0x0024</span>
<span class="cp">#define TATOVSET	0x0028</span>
<span class="cp">#define PRTOVSET	0x002c</span>
<span class="cp">#define DSICTRL		0x0030</span>
<span class="cp">#define DSIINTE		0x0060</span>
<span class="cp">#define PHYCTRL		0x0070</span>

<span class="cm">/* relative to linkbase */</span>
<span class="cp">#define DTCTR		0x0000</span>
<span class="cp">#define VMCTR1		0x0020</span>
<span class="cp">#define VMCTR2		0x0024</span>
<span class="cp">#define VMLEN1		0x0028</span>
<span class="cp">#define VMLEN2		0x002c</span>
<span class="cp">#define CMTSRTREQ	0x0070</span>
<span class="cp">#define CMTSRTCTR	0x00d0</span>

<span class="cm">/* E.g., sh7372 has 2 MIPI-DSIs - one for each LCDC */</span>
<span class="cp">#define MAX_SH_MIPI_DSI 2</span>

<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity</span> <span class="n">entity</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">linkbase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>	<span class="o">*</span><span class="n">dsit_clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define to_sh_mipi(e)	container_of(e, struct sh_mipi, entity)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi_dsi</span><span class="p">[</span><span class="n">MAX_SH_MIPI_DSI</span><span class="p">];</span>

<span class="cm">/* Protect the above array */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">array_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="nf">sh_mipi_by_handle</span><span class="p">(</span><span class="kt">int</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mipi_dsi</span><span class="p">)</span> <span class="o">||</span> <span class="n">handle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mipi_dsi</span><span class="p">[</span><span class="n">handle</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mipi_send_short</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dsi_cmd</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsi_cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">param</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* transmit a short packet to LCD panel */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">1</span> <span class="o">|</span> <span class="n">data</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">CMTSRTCTR</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">CMTSRTREQ</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">CMTSRTREQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">cnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LCD_CHAN2MIPI(c) ((c) &lt; LCDC_CHAN_MAINLCD || (c) &gt; LCDC_CHAN_SUBLCD ? \</span>
<span class="cp">				-EINVAL : (c) - 1)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mipi_dcs</span><span class="p">(</span><span class="kt">int</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span> <span class="o">=</span> <span class="n">sh_mipi_by_handle</span><span class="p">(</span><span class="n">LCD_CHAN2MIPI</span><span class="p">(</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mipi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sh_mipi_send_short</span><span class="p">(</span><span class="n">mipi</span><span class="p">,</span> <span class="n">MIPI_DSI_DCS_SHORT_WRITE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mipi_dcs_param</span><span class="p">(</span><span class="kt">int</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span> <span class="o">=</span> <span class="n">sh_mipi_by_handle</span><span class="p">(</span><span class="n">LCD_CHAN2MIPI</span><span class="p">(</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mipi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sh_mipi_send_short</span><span class="p">(</span><span class="n">mipi</span><span class="p">,</span> <span class="n">MIPI_DSI_DCS_SHORT_WRITE_PARAM</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				  <span class="n">param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_mipi_dsi_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * enable LCDC data tx, transition to LPS after completion of each HS</span>
<span class="cm">	 * packet</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000002</span> <span class="o">|</span> <span class="n">enable</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">DTCTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_mipi_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span> <span class="o">=</span> <span class="n">to_sh_mipi</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="n">sh_mipi_dsi_enable</span><span class="p">(</span><span class="n">mipi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sh_mipi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sh_mipi_dsi_info</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mobile_lcdc_chan_cfg</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lcd_chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pctype</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">pixfmt</span><span class="p">,</span> <span class="n">linelength</span><span class="p">,</span> <span class="n">vmctr2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">yuv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Select data format. MIPI DSI is not hot-pluggable, so, we just use</span>
<span class="cm">	 * the default videomode. If this ever becomes a problem, We&#39;ll have to</span>
<span class="cm">	 * move this to mipi_display_on() above and use info-&gt;var.xres</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MIPI_RGB888</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_24</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_24BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_RGB565</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_16</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_16BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_RGB666_LP</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PIXEL_STREAM_3BYTE_18</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_24BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_RGB666</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_18</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_18BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">18</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_BGR888</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_24</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_24BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_BGR565</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_16</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_16BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_BGR666_LP</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PIXEL_STREAM_3BYTE_18</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_24BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_BGR666</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_18</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_18BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">18</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_YUYV</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_YCBCR16</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_16BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_UYVY</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_YCBCR16</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_16BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_YUV420_L</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_YCBCR12</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_12BIT</span><span class="p">;</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPI_YUV420</span>:
		<span class="n">pctype</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">datatype</span> <span class="o">=</span> <span class="n">MIPI_DSI_PACKED_PIXEL_STREAM_YCBCR12</span><span class="p">;</span>
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">MIPI_DCS_PIXEL_FMT_12BIT</span><span class="p">;</span>
		<span class="cm">/* Length of U/V line */</span>
		<span class="n">linelength</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">yuv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">yuv</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">interface_type</span> <span class="o">!=</span> <span class="n">YUV422</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">yuv</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">interface_type</span> <span class="o">!=</span> <span class="n">RGB24</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lane</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* reset DSI link */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SYSCTRL</span><span class="p">);</span>
	<span class="cm">/* Hold reset for 100 cycles of the slowest of bus, HS byte and LP clock */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SYSCTRL</span><span class="p">);</span>

	<span class="cm">/* setup DSI link */</span>

	<span class="cm">/*</span>
<span class="cm">	 * T_wakeup = 0x7000</span>
<span class="cm">	 * T_hs-trail = 3</span>
<span class="cm">	 * T_hs-prepare = 3</span>
<span class="cm">	 * T_clk-trail = 3</span>
<span class="cm">	 * T_clk-prepare = 2</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x70003332</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">TIMSET</span><span class="p">);</span>
	<span class="cm">/* no responses requested */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">RESREQSET0</span><span class="p">);</span>
	<span class="cm">/* request response to packets of type 0x28 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000100</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">RESREQSET1</span><span class="p">);</span>
	<span class="cm">/* High-speed transmission timeout, default 0xffffffff */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0fffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">HSTTOVSET</span><span class="p">);</span>
	<span class="cm">/* LP reception timeout, default 0xffffffff */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0fffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">LPRTOVSET</span><span class="p">);</span>
	<span class="cm">/* Turn-around timeout, default 0xffffffff */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0fffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">TATOVSET</span><span class="p">);</span>
	<span class="cm">/* Peripheral reset timeout, default 0xffffffff */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0fffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PRTOVSET</span><span class="p">);</span>
	<span class="cm">/* Interrupts not used, disable all */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">DSIINTE</span><span class="p">);</span>
	<span class="cm">/* DSI-Tx bias on */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PHYCTRL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="cm">/* Deassert resets, power on */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x03070001</span> <span class="o">|</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">phyctrl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PHYCTRL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Default = ULPS enable |</span>
<span class="cm">	 *	Contention detection enabled |</span>
<span class="cm">	 *	EoT packet transmission enable |</span>
<span class="cm">	 *	CRC check enable |</span>
<span class="cm">	 *	ECC check enable</span>
<span class="cm">	 */</span>
	<span class="n">bitmap_fill</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lane</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x00003700</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SYSCONF</span><span class="p">);</span>

	<span class="cm">/* setup l-bridge */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable transmission of all packets,</span>
<span class="cm">	 * transmit LPS after each HS packet completion</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000006</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">DTCTR</span><span class="p">);</span>
	<span class="cm">/* VSYNC width = 2 (&lt;&lt; 17) */</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vsync_len</span> <span class="o">&lt;&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vsynw_offset</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clksrc</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pctype</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">datatype</span><span class="p">,</span>
		  <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">VMCTR1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Non-burst mode with sync pulses: VSE and HSE are output,</span>
<span class="cm">	 * HSA period allowed, no commands in LP</span>
<span class="cm">	 */</span>
	<span class="n">vmctr2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_VSEE</span><span class="p">)</span>
		<span class="n">vmctr2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HSEE</span><span class="p">)</span>
		<span class="n">vmctr2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HSAE</span><span class="p">)</span>
		<span class="n">vmctr2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_BL2E</span><span class="p">)</span>
		<span class="n">vmctr2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HSABM</span><span class="p">)</span>
		<span class="n">vmctr2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HBPBM</span><span class="p">)</span>
		<span class="n">vmctr2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HFPBM</span><span class="p">)</span>
		<span class="n">vmctr2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">vmctr2</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">VMCTR2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * VMLEN1 = RGBLEN | HSALEN</span>
<span class="cm">	 *</span>
<span class="cm">	 * see</span>
<span class="cm">	 *  Video mode - Blanking Packet setting</span>
<span class="cm">	 */</span>
	<span class="n">top</span> <span class="o">=</span> <span class="n">linelength</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* RGBLEN */</span>
	<span class="n">bottom</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HSABM</span><span class="p">)</span> <span class="cm">/* HSALEN */</span>
		<span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lane</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">top</span> <span class="o">|</span> <span class="n">bottom</span> <span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">VMLEN1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * VMLEN2 = HBPLEN | HFPLEN</span>
<span class="cm">	 *</span>
<span class="cm">	 * see</span>
<span class="cm">	 *  Video mode - Blanking Packet setting</span>
<span class="cm">	 */</span>
	<span class="n">top</span>	<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
	<span class="n">bottom</span>	<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="n">delay</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* HSbyteCLK is calculation base</span>
<span class="cm">			 * HS4divCLK = HSbyteCLK/2</span>
<span class="cm">			 * HS6divCLK is not supported for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HS4divCLK</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HFPBM</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* HBPLEN */</span>
		<span class="n">top</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hsync_len</span> <span class="o">+</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">left_margin</span><span class="p">;</span>
		<span class="n">top</span> <span class="o">=</span> <span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lane</span> <span class="o">*</span> <span class="n">top</span> <span class="o">/</span> <span class="n">div</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_MIPI_DSI_HBPBM</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* HFPLEN */</span>
		<span class="n">bottom</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">right_margin</span><span class="p">;</span>
		<span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lane</span> <span class="o">*</span> <span class="n">bottom</span> <span class="o">/</span> <span class="n">div</span><span class="p">)</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">linelength</span> <span class="o">/</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span><span class="p">;</span> <span class="cm">/* byte / pixel */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lane</span> <span class="o">/</span> <span class="n">div</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span> <span class="cm">/* output cycle */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">lcd_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xres</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span> <span class="cm">/* (input - output) cycle */</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lane</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">top</span> <span class="o">|</span> <span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">delay</span><span class="p">)</span> <span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">+</span> <span class="n">VMLEN2</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* setup LCD panel */</span>

	<span class="cm">/* cf. drivers/video/omap/lcd_mipid.c */</span>
	<span class="n">sh_mipi_dcs</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">MIPI_DCS_EXIT_SLEEP_MODE</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * [7] - Page Address Mode</span>
<span class="cm">	 * [6] - Column Address Mode</span>
<span class="cm">	 * [5] - Page / Column Address Mode</span>
<span class="cm">	 * [4] - Display Device Line Refresh Order</span>
<span class="cm">	 * [3] - RGB/BGR Order</span>
<span class="cm">	 * [2] - Display Data Latch Data Order</span>
<span class="cm">	 * [1] - Flip Horizontal</span>
<span class="cm">	 * [0] - Flip Vertical</span>
<span class="cm">	 */</span>
	<span class="n">sh_mipi_dcs_param</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">MIPI_DCS_SET_ADDRESS_MODE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* cf. set_data_lines() */</span>
	<span class="n">sh_mipi_dcs_param</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">MIPI_DCS_SET_PIXEL_FORMAT</span><span class="p">,</span>
			  <span class="n">pixfmt</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">sh_mipi_dcs</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">MIPI_DCS_SET_DISPLAY_ON</span><span class="p">);</span>

	<span class="cm">/* Enable timeout counters */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000f00</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">DSICTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mipi_display_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span> <span class="o">=</span> <span class="n">to_sh_mipi</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mipi_dsi_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_dot_clock</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mipi_display_on_fail1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_mipi_setup</span><span class="p">(</span><span class="n">mipi</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mipi_display_on_fail2</span><span class="p">;</span>

	<span class="n">sh_mipi_dsi_enable</span><span class="p">(</span><span class="n">mipi</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SH_MOBILE_LCDC_DISPLAY_CONNECTED</span><span class="p">;</span>

<span class="nl">mipi_display_on_fail1:</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">mipi_display_on_fail2:</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_dot_clock</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipi_display_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span> <span class="o">=</span> <span class="n">to_sh_mipi</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mipi_dsi_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">sh_mipi_dsi_enable</span><span class="p">(</span><span class="n">mipi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_dot_clock</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sh_mobile_lcdc_entity_ops</span> <span class="n">mipi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">display_on</span> <span class="o">=</span> <span class="n">mipi_display_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">display_off</span> <span class="o">=</span> <span class="n">mipi_display_off</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sh_mipi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_mipi_dsi_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res2</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="n">f_current</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="o">!</span><span class="n">res2</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mipi_dsi</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_dot_clock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mipi_dsi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mipi_dsi</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mipi_dsi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">efindslot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mipi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mipi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mipi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ealloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mipi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">mipi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipi_ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MIPI register region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ereqreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">emap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res2</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res2</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MIPI register region 2 already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ereqreg2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res2</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">emap2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mipi</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dsit_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eclktget</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f_current</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">);</span>
	<span class="cm">/* 80MHz required by the datasheet */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">,</span> <span class="mi">80000000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">!=</span> <span class="n">f_current</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">esettrate</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DSI-T clk %lu -&gt; %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f_current</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">eclkton</span><span class="p">;</span>

	<span class="n">mipi_dsi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mipi</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_lock</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">eclkton:</span>
<span class="nl">esettrate:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">);</span>
<span class="nl">eclktget:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span><span class="p">);</span>
<span class="nl">emap2:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res2</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res2</span><span class="p">));</span>
<span class="nl">ereqreg2:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">emap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="nl">ereqreg:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mipi</span><span class="p">);</span>
<span class="nl">ealloc:</span>
<span class="nl">efindslot:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">sh_mipi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res2</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_mipi</span> <span class="o">*</span><span class="n">mipi</span> <span class="o">=</span> <span class="n">to_sh_mipi</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mipi_dsi</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mipi_dsi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mipi</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mipi_dsi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mipi_dsi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">dsit_clk</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">linkbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res2</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res2</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res2</span><span class="p">));</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mipi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mipi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sh_mipi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">sh_mipi_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">sh_mipi_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sh-mipi-dsi&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sh_mipi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_mipi_driver</span><span class="p">,</span> <span class="n">sh_mipi_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">sh_mipi_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sh_mipi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_mipi_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sh_mipi_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SuperH / ARM-shmobile MIPI DSI driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
