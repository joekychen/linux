<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › console › vgacon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vgacon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/vgacon.c -- Low level VGA based console driver</span>
<span class="cm"> *</span>
<span class="cm"> *	Created 28 Sep 1997 by Geert Uytterhoeven</span>
<span class="cm"> *</span>
<span class="cm"> *	Rewritten by Martin Mares &lt;mj@ucw.cz&gt;, July 1998</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is based on the old console.c, vga.c and vesa_blank.c drivers.</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *			    1995  Jay Estabrook</span>
<span class="cm"> *</span>
<span class="cm"> *	User definable mapping table and font loading by Eugene G. Crosser,</span>
<span class="cm"> *	&lt;crosser@average.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Improved loadable font/UTF-8 support by H. Peter Anvin</span>
<span class="cm"> *	Feb-Sep 1995 &lt;peter.anvin@linux.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Colour palette handling, by Simon Tatham</span>
<span class="cm"> *	17-Jun-95 &lt;sgt20@cam.ac.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	if 512 char mode is already enabled don&#39;t re-enable it,</span>
<span class="cm"> *	because it causes screen to flicker, by Mitja Horvat</span>
<span class="cm"> *	5-May-96 &lt;mitja.horvat@guest.arnes.si&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Use 2 outw instead of 4 outb_p to reduce erroneous text</span>
<span class="cm"> *	flashing on RHS of screen during heavy console scrolling .</span>
<span class="cm"> *	Oct 1996, Paul Gortmaker.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License.  See the file COPYING in the main directory of this archive for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kd.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;</span>
<span class="cp">#include &lt;linux/selection.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/screen_info.h&gt;</span>
<span class="cp">#include &lt;video/vga.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="k">static</span> <span class="n">DEFINE_RAW_SPINLOCK</span><span class="p">(</span><span class="n">vga_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cursor_size_lastfrom</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cursor_size_lastto</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">vgacon_xres</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">vgacon_yres</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vgastate</span> <span class="n">state</span><span class="p">;</span>

<span class="cp">#define BLANK 0x0020</span>

<span class="cp">#define CAN_LOAD_EGA_FONTS	</span><span class="cm">/* undefine if the user must not do this */</span><span class="cp"></span>
<span class="cp">#define CAN_LOAD_PALETTE	</span><span class="cm">/* undefine if the user must not do this */</span><span class="cp"></span>

<span class="cm">/* You really do _NOT_ want to define this, unless you have buggy</span>
<span class="cm"> * Trident VGA which will resize cursor when moving it between column</span>
<span class="cm"> * 15 &amp; 16. If you define this and your VGA is OK, inverse bug will</span>
<span class="cm"> * appear.</span>
<span class="cm"> */</span>
<span class="cp">#undef TRIDENT_GLITCH</span>
<span class="cp">#define VGA_FONTWIDTH       8   </span><span class="cm">/* VGA does not support fontwidths != 8 */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> *  Interface used by the world</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vgacon_startup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vgacon_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vgacon_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vgacon_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode_switch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_set_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">table</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrolldelta</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_set_origin</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vgacon_save_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scroll</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">lines</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vgacon_invert_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vgacon_uni_pagedir</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cm">/* Description of the hardware situation */</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">vga_init_done</span>		<span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">vga_vram_base</span>		<span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* Base of video memory */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">vga_vram_end</span>		<span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* End of video memory */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">vga_vram_size</span>		<span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* Size of video memory */</span>
<span class="k">static</span> <span class="n">u16</span>		<span class="n">vga_video_port_reg</span>	<span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* Video register select port */</span>
<span class="k">static</span> <span class="n">u16</span>		<span class="n">vga_video_port_val</span>	<span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* Video register value port */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">vga_video_num_columns</span><span class="p">;</span>			<span class="cm">/* Number of text columns */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">vga_video_num_lines</span><span class="p">;</span>			<span class="cm">/* Number of text lines */</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">vga_can_do_color</span>	<span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* Do we support colors? */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">vga_default_font_height</span> <span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* Height of default screen font */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">vga_video_type</span>		<span class="n">__read_mostly</span><span class="p">;</span>	<span class="cm">/* Card type */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">vga_hardscroll_enabled</span>	<span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">vga_hardscroll_user_enable</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">vga_font_is_default</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">vga_vesa_blanked</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> 		<span class="n">vga_palette_blanked</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> 		<span class="n">vga_is_gfx</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> 		<span class="n">vga_512_chars</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> 		<span class="n">vga_video_font_height</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> 		<span class="n">vga_scan_lines</span>		<span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> 	<span class="n">vga_rolled_over</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_text_mode_force</span><span class="p">;</span>

<span class="n">bool</span> <span class="nf">vgacon_text_force</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vgacon_text_mode_force</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vgacon_text_force</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">text_mode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vgacon_text_mode_force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* force text mode - used by kernel modesetting */</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;nomodeset&quot;</span><span class="p">,</span> <span class="n">text_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">no_scroll</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disabling scrollback is required for the Braillex ib80-piezo</span>
<span class="cm">	 * Braille reader made by F.H. Papenmeier (Germany).</span>
<span class="cm">	 * Use the &quot;no-scroll&quot; bootflag.</span>
<span class="cm">	 */</span>
	<span class="n">vga_hardscroll_user_enable</span> <span class="o">=</span> <span class="n">vga_hardscroll_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;no-scroll&quot;</span><span class="p">,</span> <span class="n">no_scroll</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * By replacing the four outb_p with two back to back outw, we can reduce</span>
<span class="cm"> * the window of opportunity to see text mislocated to the RHS of the</span>
<span class="cm"> * console during heavy scrolling activity. However there is the remote</span>
<span class="cm"> * possibility that some pre-dinosaur hardware won&#39;t like the back to back</span>
<span class="cm"> * I/O. Since the Xservers get away with it, we should be able to as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_vga</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ddprintk might set the console position from interrupt</span>
<span class="cm">	 * handlers, thus the write has to be IRQ-atomic.</span>
<span class="cm">	 */</span>
	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifndef SLOW_VGA</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">);</span>
	<span class="n">v2</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vga_set_mem_top</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_vga</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">-</span> <span class="n">vga_vram_base</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VGACON_SOFT_SCROLLBACK</span>
<span class="cm">/* software scrollback */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vgacon_scrollback</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrollback_tail</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrollback_size</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrollback_rows</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrollback_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrollback_cur</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrollback_save</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vgacon_scrollback_restore</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_scrollback_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">pitch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">CONFIG_VGACON_SOFT_SCROLLBACK_SIZE</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">/</span><span class="n">pitch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vgacon_scrollback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vgacon_scrollback_cnt</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vgacon_scrollback_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vgacon_scrollback_cur</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vgacon_scrollback_rows</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vgacon_scrollback_size</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_scrollback_startup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vgacon_scrollback</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">CONFIG_VGACON_SOFT_SCROLLBACK_SIZE</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
	<span class="n">vgacon_scrollback_init</span><span class="p">(</span><span class="n">vga_video_num_columns</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_scrollback_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vgacon_scrollback_size</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_num</span> <span class="o">!=</span> <span class="n">fg_console</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_memcpyw</span><span class="p">(</span><span class="n">vgacon_scrollback</span> <span class="o">+</span> <span class="n">vgacon_scrollback_tail</span><span class="p">,</span>
			    <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
		<span class="n">vgacon_scrollback_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
		<span class="n">vgacon_scrollback_tail</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vgacon_scrollback_tail</span> <span class="o">&gt;=</span> <span class="n">vgacon_scrollback_size</span><span class="p">)</span>
			<span class="n">vgacon_scrollback_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vgacon_scrollback_cnt</span> <span class="o">&gt;</span> <span class="n">vgacon_scrollback_rows</span><span class="p">)</span>
			<span class="n">vgacon_scrollback_cnt</span> <span class="o">=</span> <span class="n">vgacon_scrollback_rows</span><span class="p">;</span>

		<span class="n">vgacon_scrollback_cur</span> <span class="o">=</span> <span class="n">vgacon_scrollback_cnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_restore_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vgacon_scrollback_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_is_gfx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vgacon_scrollback_restore</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_memcpyw</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">,</span>
			    <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">&gt;</span> <span class="n">vga_vram_size</span> <span class="o">?</span>
			    <span class="n">vga_vram_size</span> <span class="o">:</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">);</span>
		<span class="n">vgacon_scrollback_restore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vgacon_scrollback_cur</span> <span class="o">=</span> <span class="n">vgacon_scrollback_cnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_scrolldelta</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">soff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lines</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
		<span class="n">vga_set_mem_top</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vgacon_scrollback</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vgacon_scrollback_save</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vgacon_cursor</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CM_ERASE</span><span class="p">);</span>
		<span class="n">vgacon_save_screen</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">vgacon_scrollback_save</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vgacon_scrollback_restore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">vgacon_scrollback_cur</span> <span class="o">+</span> <span class="n">lines</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">abs</span><span class="p">(</span><span class="n">lines</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">vgacon_scrollback_cnt</span><span class="p">)</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">vgacon_scrollback_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">vgacon_scrollback_cnt</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">vgacon_scrollback_cnt</span><span class="p">;</span>

	<span class="n">vgacon_scrollback_cur</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">soff</span> <span class="o">=</span> <span class="n">vgacon_scrollback_tail</span> <span class="o">-</span> <span class="p">((</span><span class="n">vgacon_scrollback_cnt</span> <span class="o">-</span> <span class="n">end</span><span class="p">)</span> <span class="o">*</span>
					 <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="n">soff</span> <span class="o">-=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">soff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">soff</span> <span class="o">+=</span> <span class="n">vgacon_scrollback_size</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">vgacon_scrollback_cnt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">copysize</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">*=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
		<span class="cm">/* how much memory to end of buffer left? */</span>
		<span class="n">copysize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">vgacon_scrollback_size</span> <span class="o">-</span> <span class="n">soff</span><span class="p">);</span>
		<span class="n">scr_memcpyw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">vgacon_scrollback</span> <span class="o">+</span> <span class="n">soff</span><span class="p">,</span> <span class="n">copysize</span><span class="p">);</span>
		<span class="n">d</span> <span class="o">+=</span> <span class="n">copysize</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">copysize</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scr_memcpyw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">vgacon_scrollback</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">d</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span><span class="p">)</span>
			<span class="n">scr_memcpyw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vgacon_cursor</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CM_MOVE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define vgacon_scrollback_startup(...) do { } while (0)</span>
<span class="cp">#define vgacon_scrollback_init(...)    do { } while (0)</span>
<span class="cp">#define vgacon_scrollback_update(...)  do { } while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_restore_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span><span class="p">)</span>
		<span class="n">vgacon_scrolldelta</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_scrolldelta</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lines</span><span class="p">)</span>		<span class="cm">/* Turn scrollback off */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">margin</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ul</span><span class="p">,</span> <span class="n">we</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">st</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vga_rolled_over</span> <span class="o">&gt;</span>
		    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_scr_end</span> <span class="o">-</span> <span class="n">vga_vram_base</span><span class="p">)</span> <span class="o">+</span> <span class="n">margin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ul</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_scr_end</span> <span class="o">-</span> <span class="n">vga_vram_base</span><span class="p">;</span>
			<span class="n">we</span> <span class="o">=</span> <span class="n">vga_rolled_over</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">we</span> <span class="o">=</span> <span class="n">vga_vram_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">-</span> <span class="n">vga_vram_base</span> <span class="o">-</span> <span class="n">ul</span> <span class="o">+</span> <span class="n">we</span><span class="p">)</span> <span class="o">%</span> <span class="n">we</span> <span class="o">+</span>
		    <span class="n">lines</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
		<span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">-</span> <span class="n">vga_vram_base</span> <span class="o">-</span> <span class="n">ul</span> <span class="o">+</span> <span class="n">we</span><span class="p">)</span> <span class="o">%</span> <span class="n">we</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span>
			<span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">margin</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">st</span> <span class="o">-</span> <span class="n">margin</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">=</span> <span class="n">vga_vram_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">ul</span><span class="p">)</span> <span class="o">%</span> <span class="n">we</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vga_set_mem_top</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VGACON_SOFT_SCROLLBACK */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">vgacon_startup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">display_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">saved1</span><span class="p">,</span> <span class="n">saved2</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_isVGA</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_VLFB</span> <span class="o">||</span>
	    <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_isVGA</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_EFI</span><span class="p">)</span> <span class="p">{</span>
	      <span class="nl">no_vga:</span>
<span class="cp">#ifdef CONFIG_DUMMY_CONSOLE</span>
		<span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_con</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">conswitchp</span><span class="o">-&gt;</span><span class="n">con_startup</span><span class="p">();</span>
<span class="cp">#else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* boot_params.screen_info initialized? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_mode</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_lines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_cols</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_vga</span><span class="p">;</span>

	<span class="cm">/* VGA16 modes are not handled by VGACON */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_mode</span> <span class="o">==</span> <span class="mh">0x0D</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* 320x200/4 */</span>
	    <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_mode</span> <span class="o">==</span> <span class="mh">0x0E</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* 640x200/4 */</span>
	    <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_mode</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* 640x350/4 */</span>
	    <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_mode</span> <span class="o">==</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* 640x480/4 */</span>
	    <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_mode</span> <span class="o">==</span> <span class="mh">0x6A</span><span class="p">))</span>	<span class="cm">/* 800x600/4 (VESA) */</span>
		<span class="k">goto</span> <span class="n">no_vga</span><span class="p">;</span>

	<span class="n">vga_video_num_lines</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_lines</span><span class="p">;</span>
	<span class="n">vga_video_num_columns</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_cols</span><span class="p">;</span>
	<span class="n">state</span><span class="p">.</span><span class="n">vgabase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_mode</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Monochrome display */</span>
		<span class="n">vga_vram_base</span> <span class="o">=</span> <span class="mh">0xb0000</span><span class="p">;</span>
		<span class="n">vga_video_port_reg</span> <span class="o">=</span> <span class="n">VGA_CRT_IM</span><span class="p">;</span>
		<span class="n">vga_video_port_val</span> <span class="o">=</span> <span class="n">VGA_CRT_DM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_ega_bx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ega_console_resource</span> <span class="o">=</span>
			    <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ega&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3B0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3BF</span> <span class="p">};</span>
			<span class="n">vga_video_type</span> <span class="o">=</span> <span class="n">VIDEO_TYPE_EGAM</span><span class="p">;</span>
			<span class="n">vga_vram_size</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="n">display_desc</span> <span class="o">=</span> <span class="s">&quot;EGA+&quot;</span><span class="p">;</span>
			<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ega_console_resource</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">mda1_console_resource</span> <span class="o">=</span>
			    <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mda&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3B0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3BB</span> <span class="p">};</span>
			<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">mda2_console_resource</span> <span class="o">=</span>
			    <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mda&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3BF</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3BF</span> <span class="p">};</span>
			<span class="n">vga_video_type</span> <span class="o">=</span> <span class="n">VIDEO_TYPE_MDA</span><span class="p">;</span>
			<span class="n">vga_vram_size</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="n">display_desc</span> <span class="o">=</span> <span class="s">&quot;*MDA&quot;</span><span class="p">;</span>
			<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">mda1_console_resource</span><span class="p">);</span>
			<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">mda2_console_resource</span><span class="p">);</span>
			<span class="n">vga_video_font_height</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If not, it is color. */</span>
		<span class="n">vga_can_do_color</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vga_vram_base</span> <span class="o">=</span> <span class="mh">0xb8000</span><span class="p">;</span>
		<span class="n">vga_video_port_reg</span> <span class="o">=</span> <span class="n">VGA_CRT_IC</span><span class="p">;</span>
		<span class="n">vga_video_port_val</span> <span class="o">=</span> <span class="n">VGA_CRT_DC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_ega_bx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">vga_vram_size</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_isVGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ega_console_resource</span>
				    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ega&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3C0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3DF</span> <span class="p">};</span>
				<span class="n">vga_video_type</span> <span class="o">=</span> <span class="n">VIDEO_TYPE_EGAC</span><span class="p">;</span>
				<span class="n">display_desc</span> <span class="o">=</span> <span class="s">&quot;EGA&quot;</span><span class="p">;</span>
				<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ega_console_resource</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">vga_console_resource</span>
				    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vga+&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3C0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3DF</span> <span class="p">};</span>
				<span class="n">vga_video_type</span> <span class="o">=</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">;</span>
				<span class="n">display_desc</span> <span class="o">=</span> <span class="s">&quot;VGA+&quot;</span><span class="p">;</span>
				<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">vga_console_resource</span><span class="p">);</span>

<span class="cp">#ifdef VGA_CAN_DO_64KB</span>
				<span class="cm">/*</span>
<span class="cm">				 * get 64K rather than 32K of video RAM.</span>
<span class="cm">				 * This doesn&#39;t actually work on all &quot;VGA&quot;</span>
<span class="cm">				 * controllers (it seems like setting MM=01</span>
<span class="cm">				 * and COE=1 isn&#39;t necessarily a good idea)</span>
<span class="cm">				 */</span>
				<span class="n">vga_vram_base</span> <span class="o">=</span> <span class="mh">0xa0000</span><span class="p">;</span>
				<span class="n">vga_vram_size</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
				<span class="n">outb_p</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">VGA_GFX_I</span><span class="p">);</span>
				<span class="n">outb_p</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">VGA_GFX_D</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="cm">/*</span>
<span class="cm">				 * Normalise the palette registers, to point</span>
<span class="cm">				 * the 16 screen colours to the first 16</span>
<span class="cm">				 * DAC entries.</span>
<span class="cm">				 */</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">inb_p</span><span class="p">(</span><span class="n">VGA_IS1_RC</span><span class="p">);</span>
					<span class="n">outb_p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">VGA_ATT_W</span><span class="p">);</span>
					<span class="n">outb_p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">VGA_ATT_W</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">VGA_ATT_W</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * Now set the DAC registers back to their</span>
<span class="cm">				 * default values</span>
<span class="cm">				 */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">outb_p</span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">VGA_PEL_IW</span><span class="p">);</span>
					<span class="n">outb_p</span><span class="p">(</span><span class="n">default_red</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
					<span class="n">outb_p</span><span class="p">(</span><span class="n">default_grn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
					<span class="n">outb_p</span><span class="p">(</span><span class="n">default_blu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">VGA_PEL_D</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">cga_console_resource</span> <span class="o">=</span>
			    <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cga&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3D4</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3D5</span> <span class="p">};</span>
			<span class="n">vga_video_type</span> <span class="o">=</span> <span class="n">VIDEO_TYPE_CGA</span><span class="p">;</span>
			<span class="n">vga_vram_size</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="n">display_desc</span> <span class="o">=</span> <span class="s">&quot;*CGA&quot;</span><span class="p">;</span>
			<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">cga_console_resource</span><span class="p">);</span>
			<span class="n">vga_video_font_height</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vga_vram_base</span> <span class="o">=</span> <span class="n">VGA_MAP_MEM</span><span class="p">(</span><span class="n">vga_vram_base</span><span class="p">,</span> <span class="n">vga_vram_size</span><span class="p">);</span>
	<span class="n">vga_vram_end</span> <span class="o">=</span> <span class="n">vga_vram_base</span> <span class="o">+</span> <span class="n">vga_vram_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *      Find out if there is a graphics card present.</span>
<span class="cm">	 *      Are there smarter methods around?</span>
<span class="cm">	 */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">vga_vram_base</span><span class="p">;</span>
	<span class="n">saved1</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">saved2</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="mh">0xAA55</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="mh">0x55AA</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA55</span> <span class="o">||</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55AA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">saved1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">saved2</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">no_vga</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="mh">0x55AA</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="mh">0xAA55</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55AA</span> <span class="o">||</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA55</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">saved1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">saved2</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">no_vga</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="n">saved1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="n">saved2</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_EGAC</span>
	    <span class="o">||</span> <span class="n">vga_video_type</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_VGAC</span>
	    <span class="o">||</span> <span class="n">vga_video_type</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_EGAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_hardscroll_enabled</span> <span class="o">=</span> <span class="n">vga_hardscroll_user_enable</span><span class="p">;</span>
		<span class="n">vga_default_font_height</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_points</span><span class="p">;</span>
		<span class="n">vga_video_font_height</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_points</span><span class="p">;</span>
		<span class="cm">/* This may be suboptimal but is a safe bet - go with it */</span>
		<span class="n">vga_scan_lines</span> <span class="o">=</span>
		    <span class="n">vga_video_font_height</span> <span class="o">*</span> <span class="n">vga_video_num_lines</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vgacon_xres</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_cols</span> <span class="o">*</span> <span class="n">VGA_FONTWIDTH</span><span class="p">;</span>
	<span class="n">vgacon_yres</span> <span class="o">=</span> <span class="n">vga_scan_lines</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_init_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vgacon_scrollback_startup</span><span class="p">();</span>
		<span class="n">vga_init_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">display_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We cannot be loaded as a module, therefore init is always 1,</span>
<span class="cm">	 * but vgacon_init can be called more than once, and init will</span>
<span class="cm">	 * not be 1.</span>
<span class="cm">	 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span> <span class="o">=</span> <span class="n">vga_can_do_color</span><span class="p">;</span>

	<span class="cm">/* set dimensions manually if init != 0 since vc_resize() will fail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">=</span> <span class="n">vga_video_num_columns</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">=</span> <span class="n">vga_video_num_lines</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vc_resize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vga_video_num_columns</span><span class="p">,</span> <span class="n">vga_video_num_lines</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_scan_lines</span> <span class="o">=</span> <span class="n">vga_scan_lines</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vga_video_font_height</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span> <span class="o">=</span> <span class="mh">0x7700</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vga_512_chars</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">=</span> <span class="mh">0x0800</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir_loc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir_loc</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir</span> <span class="o">||</span>
	    <span class="o">!--</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">con_free_unimap</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir_loc</span> <span class="o">=</span> <span class="n">vgacon_uni_pagedir</span><span class="p">;</span>
	<span class="n">vgacon_uni_pagedir</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vgacon_uni_pagedir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">)</span>
		<span class="n">con_set_default_unimap</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="cm">/* Only set the default if the user didn&#39;t deliberately override it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">global_cursor_default</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">global_cursor_default</span> <span class="o">=</span>
			<span class="o">!</span><span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIDEO_FLAGS_NOCURSOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* When closing the active console, reset video origin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">=</span> <span class="n">vga_vram_base</span><span class="p">;</span>
		<span class="n">vga_set_mem_top</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">vgacon_uni_pagedir</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">con_free_unimap</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir_loc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir</span><span class="p">;</span>
	<span class="n">con_set_default_unimap</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">vgacon_build_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u8</span> <span class="n">color</span><span class="p">,</span> <span class="n">u8</span> <span class="n">intensity</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">blink</span><span class="p">,</span> <span class="n">u8</span> <span class="n">underline</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">u8</span> <span class="n">italic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vga_can_do_color</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">italic</span><span class="p">)</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_itcolor</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">underline</span><span class="p">)</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_ulcolor</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_halfcolor</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
		<span class="n">attr</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">|</span> <span class="p">((((</span><span class="n">attr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">attr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span>
				       <span class="mh">0x77</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blink</span><span class="p">)</span>
		<span class="n">attr</span> <span class="o">^=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">attr</span> <span class="o">^=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_can_do_color</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">italic</span><span class="p">)</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">underline</span><span class="p">)</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">attr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_invert_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">vga_can_do_color</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">a</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">col</span><span class="p">)</span>
			<span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0700</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">a</span> <span class="o">^=</span> <span class="p">((</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0700</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7000</span> <span class="o">:</span> <span class="mh">0x7700</span><span class="p">;</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_set_cursor_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">xpos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curs</span><span class="p">,</span> <span class="n">cure</span><span class="p">;</span>

<span class="cp">#ifdef TRIDENT_GLITCH</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpos</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">from</span><span class="o">--</span><span class="p">,</span> <span class="n">to</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">from</span> <span class="o">==</span> <span class="n">cursor_size_lastfrom</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">to</span> <span class="o">==</span> <span class="n">cursor_size_lastto</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cursor_size_lastfrom</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
	<span class="n">cursor_size_lastto</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">&gt;=</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_CURSOR_START</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">curs</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_CURSOR_END</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">cure</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">curs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">curs</span> <span class="o">=</span> <span class="p">(</span><span class="n">curs</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">|</span> <span class="n">from</span><span class="p">;</span>
	<span class="n">cure</span> <span class="o">=</span> <span class="p">(</span><span class="n">cure</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">|</span> <span class="n">to</span><span class="p">;</span>

	<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_CURSOR_START</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">curs</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_CURSOR_END</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">cure</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vgacon_restore_screen</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CM_ERASE</span>:
		<span class="n">write_vga</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-</span> <span class="n">vga_vram_base</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">&gt;=</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span>
			<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CM_MOVE</span>:
	<span class="k">case</span> <span class="n">CM_DRAW</span>:
		<span class="n">write_vga</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-</span> <span class="n">vga_vram_base</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_cursor_type</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CUR_UNDERLINE</span>:
			<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span>
					       <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span>
						<span class="mi">10</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">),</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span>
					       <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span>
						<span class="mi">10</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CUR_TWO_THIRDS</span>:
			<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span>
					       <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span>
						<span class="mi">10</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CUR_LOWER_THIRD</span>:
			<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span>
					       <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span>
						<span class="mi">10</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CUR_LOWER_HALF</span>:
			<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span>
					       <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span>
						<span class="mi">10</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CUR_NONE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">&gt;=</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span>
				<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">vgacon_set_cursor_size</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					       <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_doresize</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scanlines</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scanlines_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vsync_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">max_scan</span><span class="p">;</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">vgacon_xres</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">VGA_FONTWIDTH</span><span class="p">;</span>
	<span class="n">vgacon_yres</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">&gt;=</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">max_scan</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_scan</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">scanlines</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_MODE</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="n">scanlines</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">scanlines</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scanlines_lo</span> <span class="o">=</span> <span class="n">scanlines</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_OVERFLOW</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">r7</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x42</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scanlines</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
			<span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scanlines</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
			<span class="n">r7</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="cm">/* deprotect registers */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">vsync_end</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">vsync_end</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_H_DISP</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_OFFSET</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">&gt;=</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_V_DISP_END</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">scanlines_lo</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_OVERFLOW</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">vga_video_port_val</span><span class="p">);</span>

		<span class="cm">/* reprotect registers */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">vsync_end</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">*</span> <span class="n">VGA_FONTWIDTH</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_lines</span> <span class="o">*</span> <span class="n">vga_default_font_height</span><span class="o">/</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to save screen size here as it&#39;s the only way</span>
<span class="cm">	 * we can spot the screen has been resized and we need to</span>
<span class="cm">	 * set size of freshly allocated screens ourselves.</span>
<span class="cm">	 */</span>
	<span class="n">vga_video_num_columns</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
	<span class="n">vga_video_num_lines</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>

	<span class="cm">/* We can only copy out the size of the video buffer here,</span>
<span class="cm">	 * otherwise we get into VGA BIOS */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_is_gfx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_memcpyw</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">,</span>
			    <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">&gt;</span> <span class="n">vga_vram_size</span> <span class="o">?</span>
				<span class="n">vga_vram_size</span> <span class="o">:</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vgacon_xres</span> <span class="o">!=</span> <span class="n">x</span> <span class="o">||</span> <span class="n">vgacon_yres</span> <span class="o">!=</span> <span class="n">y</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vga_video_num_columns</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">vga_video_num_columns</span> <span class="o">&lt;=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_cols</span> <span class="o">&amp;&amp;</span>
		     <span class="n">vga_video_num_lines</span> <span class="o">&lt;=</span> <span class="n">rows</span><span class="p">))</span>
			<span class="n">vgacon_doresize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vgacon_scrollback_init</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Redrawing not needed */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_set_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_set_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CAN_LOAD_PALETTE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">!=</span> <span class="n">VIDEO_TYPE_VGAC</span> <span class="o">||</span> <span class="n">vga_palette_blanked</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">vga_set_palette</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* structure holding original VGA register settings */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SeqCtrlIndex</span><span class="p">;</span>	<span class="cm">/* Sequencer Index reg.   */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CrtCtrlIndex</span><span class="p">;</span>	<span class="cm">/* CRT-Contr. Index reg.  */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CrtMiscIO</span><span class="p">;</span>	<span class="cm">/* Miscellaneous register */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">HorizontalTotal</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:00h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">HorizDisplayEnd</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:01h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">StartHorizRetrace</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:04h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EndHorizRetrace</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:05h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Overflow</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:07h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">StartVertRetrace</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:10h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EndVertRetrace</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:11h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ModeControl</span><span class="p">;</span>	<span class="cm">/* CRT-Controller:17h */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ClockingMode</span><span class="p">;</span>	<span class="cm">/* Seq-Controller:01h */</span>
<span class="p">}</span> <span class="n">vga_state</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_vesa_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">vgastate</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* save original values of VGA controller registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_vesa_blanked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">SeqCtrlIndex</span> <span class="o">=</span> <span class="n">vga_r</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_I</span><span class="p">);</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">CrtCtrlIndex</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_reg</span><span class="p">);</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span> <span class="o">=</span> <span class="n">vga_r</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_MIS_R</span><span class="p">);</span>
		<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>

		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* HorizontalTotal */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">HorizontalTotal</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* HorizDisplayEnd */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">HorizDisplayEnd</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* StartHorizRetrace */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">StartHorizRetrace</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* EndHorizRetrace */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">EndHorizRetrace</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* Overflow */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">Overflow</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* StartVertRetrace */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">StartVertRetrace</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* EndVertRetrace */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">EndVertRetrace</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* ModeControl */</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">ModeControl</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
		<span class="n">vga_state</span><span class="p">.</span><span class="n">ClockingMode</span> <span class="o">=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* assure that video is enabled */</span>
	<span class="cm">/* &quot;0x20&quot; is VIDEO_ENABLE_bit in register 01 of sequencer */</span>
	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">,</span> <span class="n">vga_state</span><span class="p">.</span><span class="n">ClockingMode</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/* test for vertical retrace in process.... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_MIS_W</span><span class="p">,</span> <span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span> <span class="o">&amp;</span> <span class="mh">0xEF</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set &lt;End of vertical retrace&gt; to minimum (0) and</span>
<span class="cm">	 * &lt;Start of vertical Retrace&gt; to maximum (incl. overflow)</span>
<span class="cm">	 * Result: turn off vertical sync (VSync) pulse.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">VESA_VSYNC_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* StartVertRetrace */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>	<span class="cm">/* maximum value */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* EndVertRetrace */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>	<span class="cm">/* minimum (bits 0..3)  */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* Overflow */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">Overflow</span> <span class="o">|</span> <span class="mh">0x84</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>	<span class="cm">/* bits 9,10 of vert. retrace */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">VESA_HSYNC_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set &lt;End of horizontal retrace&gt; to minimum (0) and</span>
<span class="cm">		 *  &lt;Start of horizontal Retrace&gt; to maximum</span>
<span class="cm">		 * Result: turn off horizontal sync (HSync) pulse.</span>
<span class="cm">		 */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* StartHorizRetrace */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>	<span class="cm">/* maximum */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* EndHorizRetrace */</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>	<span class="cm">/* minimum (0) */</span>
	<span class="p">}</span>

	<span class="cm">/* restore both index registers */</span>
	<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_I</span><span class="p">,</span> <span class="n">vga_state</span><span class="p">.</span><span class="n">SeqCtrlIndex</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">CrtCtrlIndex</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_vesa_unblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">vgastate</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* restore original values of VGA controller registers */</span>
	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_MIS_W</span><span class="p">,</span> <span class="n">vga_state</span><span class="p">.</span><span class="n">CrtMiscIO</span><span class="p">);</span>

	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* HorizontalTotal */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">HorizontalTotal</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* HorizDisplayEnd */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">HorizDisplayEnd</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* StartHorizRetrace */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">StartHorizRetrace</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* EndHorizRetrace */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">EndHorizRetrace</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* Overflow */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">Overflow</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* StartVertRetrace */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">StartVertRetrace</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* EndVertRetrace */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">EndVertRetrace</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* ModeControl */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">ModeControl</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="cm">/* ClockingMode */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_CLOCK_MODE</span><span class="p">,</span> <span class="n">vga_state</span><span class="p">.</span><span class="n">ClockingMode</span><span class="p">);</span>

	<span class="cm">/* restore index/control registers */</span>
	<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_I</span><span class="p">,</span> <span class="n">vga_state</span><span class="p">.</span><span class="n">SeqCtrlIndex</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vga_state</span><span class="p">.</span><span class="n">CrtCtrlIndex</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vga_pal_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">vgastate</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_MSK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_IW</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vga_w</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_PEL_D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_blank</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode_switch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* Unblank */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vga_vesa_blanked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_vesa_unblank</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">vga_vesa_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vga_palette_blanked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_set_palette</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">color_table</span><span class="p">);</span>
			<span class="n">vga_palette_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vga_is_gfx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Tell console.c that it has to restore the screen itself */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* Normal blanking */</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:	<span class="cm">/* Obsolete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_switch</span> <span class="o">&amp;&amp;</span> <span class="n">vga_video_type</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_pal_blank</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">vga_palette_blanked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vgacon_set_origin</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">scr_memsetw</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">vga_vram_base</span><span class="p">,</span> <span class="n">BLANK</span><span class="p">,</span>
			    <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_switch</span><span class="p">)</span>
			<span class="n">vga_is_gfx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* VESA blanking */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_vesa_blank</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">blank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">vga_vesa_blanked</span> <span class="o">=</span> <span class="n">blank</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PIO_FONT support.</span>
<span class="cm"> *</span>
<span class="cm"> * The font loading code goes back to the codepage package by</span>
<span class="cm"> * Joel Hoffman (joel@wam.umd.edu). (He reports that the original</span>
<span class="cm"> * reference is: &quot;From: p. 307 of _Programmer&#39;s Guide to PC &amp; PS/2</span>
<span class="cm"> * Video Systems_ by Richard Wilton. 1987.  Microsoft Press&quot;.)</span>
<span class="cm"> *</span>
<span class="cm"> * Change for certain monochrome monitors by Yury Shevchuck</span>
<span class="cm"> * (sizif@botik.yaroslavl.su).</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CAN_LOAD_EGA_FONTS</span>

<span class="cp">#define colourmap 0xa0000</span>
<span class="cm">/* Pauline Middelink &lt;middelin@polyware.iaf.nl&gt; reports that we</span>
<span class="cm">   should use 0xA0000 for the bwmap as well.. */</span>
<span class="cp">#define blackwmap 0xa0000</span>
<span class="cp">#define cmapsz 8192</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_do_font_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">vgastate</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="kt">int</span> <span class="n">set</span><span class="p">,</span><span class="kt">int</span> <span class="n">ch512</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">video_port_status</span> <span class="o">=</span> <span class="n">vga_video_port_reg</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">font_select</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">charmap</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">!=</span> <span class="n">VIDEO_TYPE_EGAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">charmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">VGA_MAP_MEM</span><span class="p">(</span><span class="n">colourmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">beg</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">;</span>
<span class="cp">#ifdef VGA_CAN_DO_64KB</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">==</span> <span class="n">VIDEO_TYPE_VGAC</span><span class="p">)</span>
			<span class="n">beg</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">charmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">VGA_MAP_MEM</span><span class="p">(</span><span class="n">blackwmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">beg</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef BROKEN_GRAPHICS_PROGRAMS</span>
	<span class="cm">/*</span>
<span class="cm">	 * All fonts are loaded in slot 0 (0:1 for 512 ch)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* Return to default font not supported */</span>

	<span class="n">vga_font_is_default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">font_select</span> <span class="o">=</span> <span class="n">ch512</span> <span class="o">?</span> <span class="mh">0x04</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/*</span>
<span class="cm">	 * The default font is kept in slot 0 and is never touched.</span>
<span class="cm">	 * A custom font is loaded in slot 2 (256 ch) or 2:3 (512 ch)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_font_is_default</span> <span class="o">=</span> <span class="o">!</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
			<span class="n">ch512</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Default font is always 256 */</span>
		<span class="n">font_select</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">?</span> <span class="p">(</span><span class="n">ch512</span> <span class="o">?</span> <span class="mh">0x0e</span> <span class="o">:</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_font_is_default</span><span class="p">)</span>
		<span class="n">charmap</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">cmapsz</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="cm">/* First, the Sequencer */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_RESET</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="cm">/* CPU writes only to map 2 */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_PLANE_WRITE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>	
	<span class="cm">/* Sequential addressing */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_MEMORY_MODE</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>	
	<span class="cm">/* Clear synchronous reset */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_RESET</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="cm">/* Now, the graphics controller, select map 2 */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_GFX_PLANE_READ</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>		
	<span class="cm">/* disable odd-even addressing */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* map start at A000:0000 */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_GFX_MISC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmapsz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">vga_writeb</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">charmap</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmapsz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vga_readb</span><span class="p">(</span><span class="n">charmap</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * In 512-character mode, the character map is not contiguous if</span>
<span class="cm">		 * we want to remain EGA compatible -- which we do</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch512</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">charmap</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cmapsz</span><span class="p">;</span>
			<span class="n">arg</span> <span class="o">+=</span> <span class="n">cmapsz</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmapsz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">vga_writeb</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">charmap</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmapsz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vga_readb</span><span class="p">(</span><span class="n">charmap</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="cm">/* First, the sequencer, Synchronous reset */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_RESET</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>	
	<span class="cm">/* CPU writes to maps 0 and 1 */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_PLANE_WRITE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="cm">/* odd-even addressing */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_MEMORY_MODE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="cm">/* Character Map Select */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_CHARACTER_MAP</span><span class="p">,</span> <span class="n">font_select</span><span class="p">);</span>
	<span class="cm">/* clear synchronous reset */</span>
	<span class="n">vga_wseq</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_SEQ_RESET</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="cm">/* Now, the graphics controller, select map 0 for CPU */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_GFX_PLANE_READ</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* enable even-odd addressing */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="cm">/* map starts at b800:0 or b000:0 */</span>
	<span class="n">vga_wgfx</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_GFX_MISC</span><span class="p">,</span> <span class="n">beg</span><span class="p">);</span>

	<span class="cm">/* if 512 char mode is already enabled don&#39;t re-enable it. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">set</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch512</span> <span class="o">!=</span> <span class="n">vga_512_chars</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* attribute controller */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_sw</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">vga_con</span><span class="p">)</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">=</span> <span class="n">ch512</span> <span class="o">?</span> <span class="mh">0x0800</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vga_512_chars</span> <span class="o">=</span> <span class="n">ch512</span><span class="p">;</span>
		<span class="cm">/* 256-char: enable intensity bit</span>
<span class="cm">		   512-char: disable intensity bit */</span>
		<span class="n">inb_p</span><span class="p">(</span><span class="n">video_port_status</span><span class="p">);</span>	<span class="cm">/* clear address flip-flop */</span>
		<span class="cm">/* color plane enable register */</span>
		<span class="n">vga_wattr</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_ATC_PLANE_ENABLE</span><span class="p">,</span> <span class="n">ch512</span> <span class="o">?</span> <span class="mh">0x07</span> <span class="o">:</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="cm">/* Wilton (1987) mentions the following; I don&#39;t know what</span>
<span class="cm">		   it means, but it works, and it appears necessary */</span>
		<span class="n">inb_p</span><span class="p">(</span><span class="n">video_port_status</span><span class="p">);</span>
		<span class="n">vga_wattr</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">vgabase</span><span class="p">,</span> <span class="n">VGA_AR_ENABLE_DISPLAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	
	<span class="p">}</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adjust the screen to fit a font of a certain height</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_adjust_height</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">fontheight</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ovr</span><span class="p">,</span> <span class="n">vde</span><span class="p">,</span> <span class="n">fsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rows</span><span class="p">,</span> <span class="n">maxscan</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rows</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_scan_lines</span> <span class="o">/</span> <span class="n">fontheight</span><span class="p">;</span>	<span class="cm">/* Number of video rows we end up with */</span>
	<span class="n">maxscan</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">fontheight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Scan lines to actually display-1 */</span>

	<span class="cm">/* Reprogram the CRTC for the new font size</span>
<span class="cm">	   Note: the attempt to read the overflow register will fail</span>
<span class="cm">	   on an EGA, but using 0xff for the previous value appears to</span>
<span class="cm">	   be OK for EGA text modes in the range 257-512 scan lines, so I</span>
<span class="cm">	   guess we don&#39;t need to worry about it.</span>

<span class="cm">	   The same applies for the spill bits in the font size and cursor</span>
<span class="cm">	   registers; they are write-only on EGA, but it appears that they</span>
<span class="cm">	   are all don&#39;t care bits on EGA, so I guess it doesn&#39;t matter. */</span>

	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* CRTC overflow register */</span>
	<span class="n">ovr</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* Font size register */</span>
	<span class="n">fsr</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>

	<span class="n">vde</span> <span class="o">=</span> <span class="n">maxscan</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* Vertical display end reg */</span>
	<span class="n">ovr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ovr</span> <span class="o">&amp;</span> <span class="mh">0xbd</span><span class="p">)</span> <span class="o">+</span>	<span class="cm">/* Overflow register */</span>
	    <span class="p">((</span><span class="n">maxscan</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">maxscan</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">fsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fontheight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/*  Font size register */</span>

	<span class="n">raw_spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* CRTC overflow register */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">ovr</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* Font size */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">fsr</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="n">vga_video_port_reg</span><span class="p">);</span>	<span class="cm">/* Vertical display limit */</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">vde</span><span class="p">,</span> <span class="n">vga_video_port_val</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vga_lock</span><span class="p">);</span>
	<span class="n">vga_video_font_height</span> <span class="o">=</span> <span class="n">fontheight</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_sw</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">vga_con</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			        <span class="cm">/* void size to cause regs to be rewritten */</span>
				<span class="n">cursor_size_lastfrom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cursor_size_lastto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_cursor</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CM_DRAW</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fontheight</span><span class="p">;</span>
			<span class="n">vc_resize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rows</span><span class="p">);</span>	<span class="cm">/* Adjust console size */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_font_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">console_font</span> <span class="o">*</span><span class="n">font</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">charcount</span> <span class="o">=</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">charcount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">&lt;</span> <span class="n">VIDEO_TYPE_EGAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">!=</span> <span class="n">VGA_FONTWIDTH</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">charcount</span> <span class="o">!=</span> <span class="mi">256</span> <span class="o">&amp;&amp;</span> <span class="n">charcount</span> <span class="o">!=</span> <span class="mi">512</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">vgacon_do_font_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">charcount</span> <span class="o">==</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KD_FONT_FLAG_DONT_RECALC</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">vgacon_adjust_height</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_font_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">console_font</span> <span class="o">*</span><span class="n">font</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vga_video_type</span> <span class="o">&lt;</span> <span class="n">VIDEO_TYPE_EGAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">font</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">VGA_FONTWIDTH</span><span class="p">;</span>
	<span class="n">font</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">font</span><span class="o">-&gt;</span><span class="n">charcount</span> <span class="o">=</span> <span class="n">vga_512_chars</span> <span class="o">?</span> <span class="mi">512</span> <span class="o">:</span> <span class="mi">256</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">vgacon_do_font_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vga_512_chars</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define vgacon_font_set NULL</span>
<span class="cp">#define vgacon_font_get NULL</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_cols</span> <span class="o">||</span>
	    <span class="n">height</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">screen_info</span><span class="p">.</span><span class="n">orig_video_lines</span> <span class="o">*</span> <span class="n">vga_default_font_height</span><span class="p">)</span><span class="o">/</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_font</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
		<span class="cm">/* let svgatextmode tinker with video timings and</span>
<span class="cm">		   return success */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vga_is_gfx</span><span class="p">)</span> <span class="cm">/* who knows */</span>
		<span class="n">vgacon_doresize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_set_origin</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vga_is_gfx</span> <span class="o">||</span>	<span class="cm">/* We don&#39;t play origin tricks in graphic modes */</span>
	    <span class="p">(</span><span class="n">console_blanked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vga_palette_blanked</span><span class="p">))</span>	<span class="cm">/* Nor we write to blanked screens */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">=</span> <span class="n">vga_vram_base</span><span class="p">;</span>
	<span class="n">vga_set_mem_top</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">vga_rolled_over</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgacon_save_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">vga_bootup_console</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_bootup_console</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is a gross hack, but here is the only place we can</span>
<span class="cm">		 * set bootup console parameters without messing up generic</span>
<span class="cm">		 * console initialization routines.</span>
<span class="cm">		 */</span>
		<span class="n">vga_bootup_console</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_x</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">=</span> <span class="n">screen_info</span><span class="p">.</span><span class="n">orig_y</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We can&#39;t copy in more than the size of the video buffer,</span>
<span class="cm">	 * or we&#39;ll be copying in VGA BIOS */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_is_gfx</span><span class="p">)</span>
		<span class="n">scr_memcpyw</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">,</span>
			    <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">&gt;</span> <span class="n">vga_vram_size</span> <span class="o">?</span> <span class="n">vga_vram_size</span> <span class="o">:</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_scroll</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">||</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">||</span> <span class="n">vga_is_gfx</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vga_hardscroll_enabled</span> <span class="o">||</span> <span class="n">lines</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vgacon_restore_screen</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">oldo</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">lines</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">SM_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vgacon_scrollback_update</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">lines</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_scr_end</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">&gt;=</span> <span class="n">vga_vram_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scr_memcpyw</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">vga_vram_base</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">oldo</span> <span class="o">+</span> <span class="n">delta</span><span class="p">),</span>
				    <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">-</span> <span class="n">delta</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">=</span> <span class="n">vga_vram_base</span><span class="p">;</span>
			<span class="n">vga_rolled_over</span> <span class="o">=</span> <span class="n">oldo</span> <span class="o">-</span> <span class="n">vga_vram_base</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">scr_memsetw</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">-</span>
				     <span class="n">delta</span><span class="p">),</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span>
			    <span class="n">delta</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldo</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">vga_vram_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scr_memmovew</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">vga_vram_end</span> <span class="o">-</span>
					      <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">+</span>
					      <span class="n">delta</span><span class="p">),</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">oldo</span><span class="p">,</span>
				     <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">-</span> <span class="n">delta</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">=</span> <span class="n">vga_vram_end</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">;</span>
			<span class="n">vga_rolled_over</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_scr_end</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">;</span>
		<span class="n">scr_memsetw</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">),</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span>
			    <span class="n">delta</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_scr_end</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="n">vga_set_mem_top</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-</span> <span class="n">oldo</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  The console `switch&#39; structure for the VGA based console</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vgacon_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DUMMY (void *) vgacon_dummy</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="n">vga_con</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_startup</span> <span class="o">=</span> <span class="n">vgacon_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_init</span> <span class="o">=</span> <span class="n">vgacon_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_deinit</span> <span class="o">=</span> <span class="n">vgacon_deinit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_clear</span> <span class="o">=</span> <span class="n">DUMMY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_putc</span> <span class="o">=</span> <span class="n">DUMMY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_putcs</span> <span class="o">=</span> <span class="n">DUMMY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_cursor</span> <span class="o">=</span> <span class="n">vgacon_cursor</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_scroll</span> <span class="o">=</span> <span class="n">vgacon_scroll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_bmove</span> <span class="o">=</span> <span class="n">DUMMY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_switch</span> <span class="o">=</span> <span class="n">vgacon_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_blank</span> <span class="o">=</span> <span class="n">vgacon_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_font_set</span> <span class="o">=</span> <span class="n">vgacon_font_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_font_get</span> <span class="o">=</span> <span class="n">vgacon_font_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_resize</span> <span class="o">=</span> <span class="n">vgacon_resize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_set_palette</span> <span class="o">=</span> <span class="n">vgacon_set_palette</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_scrolldelta</span> <span class="o">=</span> <span class="n">vgacon_scrolldelta</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_set_origin</span> <span class="o">=</span> <span class="n">vgacon_set_origin</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_save_screen</span> <span class="o">=</span> <span class="n">vgacon_save_screen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_build_attr</span> <span class="o">=</span> <span class="n">vgacon_build_attr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">con_invert_region</span> <span class="o">=</span> <span class="n">vgacon_invert_region</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
