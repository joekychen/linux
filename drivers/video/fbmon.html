<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › fbmon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fbmon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/fbmon.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002 James Simmons &lt;jsimmons@users.sf.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Credits:</span>
<span class="cm"> *</span>
<span class="cm"> * The EDID Parser is a conglomeration from the following sources:</span>
<span class="cm"> *</span>
<span class="cm"> *   1. SciTech SNAP Graphics Architecture</span>
<span class="cm"> *      Copyright (C) 1991-2002 SciTech Software, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *   2. XFree86 4.3.0, interpret_edid.c</span>
<span class="cm"> *      Copyright 1998 by Egbert Eich &lt;Egbert.Eich@Physik.TU-Darmstadt.DE&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   3. John Fremlin &lt;vii@users.sourceforge.net&gt; and</span>
<span class="cm"> *      Ani Joshi &lt;ajoshi@unixbox.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Generalized Timing Formula is derived from:</span>
<span class="cm"> *</span>
<span class="cm"> *      GTF Spreadsheet by Andy Morrish (1/5/97)</span>
<span class="cm"> *      available at http://www.vesa.org</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;video/edid.h&gt;</span>
<span class="cp">#ifdef CONFIG_PPC_OF</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &quot;edid.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * EDID parser</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG  </span><span class="cm">/* define this for verbose EDID parsing output */</span><span class="cp"></span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DPRINTK(fmt, args...) printk(fmt,## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define FBMON_FIX_HEADER  1</span>
<span class="cp">#define FBMON_FIX_INPUT   2</span>
<span class="cp">#define FBMON_FIX_TIMINGS 3</span>

<span class="cp">#ifdef CONFIG_FB_MODE_HELPERS</span>
<span class="k">struct</span> <span class="n">broken_edid</span> <span class="p">{</span>
	<span class="n">u8</span>  <span class="n">manufacturer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">model</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fix</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">broken_edid</span> <span class="n">brokendb</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* DEC FR-PCXAV-YZ */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="s">&quot;DEC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">model</span>        <span class="o">=</span> <span class="mh">0x073a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fix</span>          <span class="o">=</span> <span class="n">FBMON_FIX_HEADER</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* ViewSonic PF775a */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="s">&quot;VSC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">model</span>        <span class="o">=</span> <span class="mh">0x5a44</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fix</span>          <span class="o">=</span> <span class="n">FBMON_FIX_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Sharp UXGA? */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="s">&quot;SHP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">model</span>        <span class="o">=</span> <span class="mh">0x138e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fix</span>          <span class="o">=</span> <span class="n">FBMON_FIX_TIMINGS</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">edid_v1_header</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">c</span> <span class="o">!=</span> <span class="mh">0x0A</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">);</span>
  <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*--</span><span class="n">s</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">))</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edid_is_serial_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edid_is_ascii_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edid_is_limits_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edid_is_monitor_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edid_is_timing_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_edid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">ID_MANUFACTURER_NAME</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">model</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">manufacturer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
	<span class="n">manufacturer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
	<span class="n">manufacturer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
	<span class="n">manufacturer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">model</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">brokendb</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">brokendb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">manufacturer</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">brokendb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">==</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fix</span> <span class="o">=</span> <span class="n">brokendb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fix</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fix</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBMON_FIX_HEADER</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edid_v1_header</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">fix</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBMON_FIX_INPUT</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">EDID_STRUCT_DISPLAY</span><span class="p">;</span>
		<span class="cm">/* Only if display is GTF capable will</span>
<span class="cm">		   the input type be reset to analog */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fix</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBMON_FIX_TIMINGS</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">DETAILED_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fix</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edid_is_limits_block</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">b</span> <span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fbmon: The EDID Block of &quot;</span>
		       <span class="s">&quot;Manufacturer: %s Model: 0x%x is known to &quot;</span>
		       <span class="s">&quot;be broken,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">manufacturer</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_edid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fix</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBMON_FIX_HEADER</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fbmon: trying a header reconstruct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">edid_v1_header</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBMON_FIX_INPUT</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fbmon: trying to fix input type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">EDID_STRUCT_DISPLAY</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="n">edid</span><span class="p">[</span><span class="mi">127</span><span class="p">]</span> <span class="o">+=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBMON_FIX_TIMINGS</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fbmon: trying to fix monitor timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">DETAILED_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edid_is_serial_block</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">||</span>
			      <span class="n">edid_is_ascii_block</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">||</span>
			      <span class="n">edid_is_monitor_block</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">||</span>
			      <span class="n">edid_is_timing_block</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfd</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>   <span class="cm">/* vfmin */</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>   <span class="cm">/* vfmax */</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>   <span class="cm">/* hfmin */</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>   <span class="cm">/* hfmax */</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>   <span class="cm">/* pixclock - 170 MHz*/</span>
				<span class="n">b</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* GTF */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">b</span> <span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EDID_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">csum</span> <span class="o">+=</span> <span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">edid</span><span class="p">[</span><span class="mi">127</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">csum</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edid_checksum</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">all_null</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fix</span> <span class="o">=</span> <span class="n">check_edid</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fix</span><span class="p">)</span>
		<span class="n">fix_edid</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">fix</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EDID_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">all_null</span> <span class="o">|=</span> <span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">all_null</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* checksum passed, everything&#39;s good */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edid_check_header</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fix</span> <span class="o">=</span> <span class="n">check_edid</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fix</span><span class="p">)</span>
		<span class="n">fix_edid</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">fix</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edid_v1_header</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_vendor_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
	       <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">year</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1990</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">week</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Manufacturer: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Model: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Serial#: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Year: %u Week %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">year</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">week</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_dpms_capabilities</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DPMS_ACTIVE_OFF</span><span class="p">)</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">|=</span> <span class="n">FB_DPMS_ACTIVE_OFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DPMS_SUSPEND</span><span class="p">)</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">|=</span> <span class="n">FB_DPMS_SUSPEND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DPMS_STANDBY</span><span class="p">)</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">|=</span> <span class="n">FB_DPMS_STANDBY</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      DPMS: Active %s, Suspend %s, Standby %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DPMS_ACTIVE_OFF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DPMS_SUSPEND</span><span class="p">)</span>    <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DPMS_STANDBY</span><span class="p">)</span>    <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_chroma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Chroma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Chromaticity data */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0x7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">redx</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;         RedX:     0.%03d &quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">redx</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0x8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">redy</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;RedY:     0.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">redy</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0x9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">greenx</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;         GreenX:   0.%03d &quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">greenx</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0xa</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">greeny</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;GreenY:   0.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">greeny</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0xb</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">bluex</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;         BlueX:    0.%03d &quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">bluex</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0xc</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">bluey</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;BlueY:    0.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">bluey</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0xd</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">whitex</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;         WhiteX:   0.%03d &quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">whitex</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mh">0xe</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">whitey</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;WhiteY:   0.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">chroma</span><span class="p">.</span><span class="n">whitey</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_mode_timings</span><span class="p">(</span><span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refresh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>

	<span class="n">var</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
		<span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_VSYNCTIMINGS</span> <span class="o">|</span> <span class="n">FB_IGNOREMON</span><span class="p">,</span>
			    <span class="n">refresh</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">=</span> <span class="n">refresh</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_est_timing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">calc_mode_timings</span><span class="p">(</span><span class="mi">720</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="n">FB_MODE_IS_CALCULATED</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      720x400@70Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">calc_mode_timings</span><span class="p">(</span><span class="mi">720</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="n">FB_MODE_IS_CALCULATED</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      720x400@88Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      640x480@60Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">calc_mode_timings</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="n">FB_MODE_IS_CALCULATED</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      640x480@67Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      640x480@72Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      640x480@75Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      800x600@56Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      800x600@60Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      800x600@72Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      800x600@75Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">calc_mode_timings</span><span class="p">(</span><span class="mi">832</span><span class="p">,</span> <span class="mi">624</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="n">FB_MODE_IS_CALCULATED</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      832x624@75Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      1024x768@87Hz Interlaced</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      1024x768@60Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      1024x768@70Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      1024x768@75Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      1280x1024@75Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      1152x870@75Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Manufacturer&#39;s mask: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_std_timing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">ver</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* in EDID 1.3 the meaning of 0 changed to 16:10 (prior 1:1) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">9</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">refresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">60</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      %dx%d@%dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">refresh</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VESA_MODEDB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vesa_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span> <span class="o">==</span> <span class="n">xres</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vesa_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span> <span class="o">==</span> <span class="n">yres</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vesa_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span> <span class="o">==</span> <span class="n">refresh</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">vesa_modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">FB_MODE_IS_STANDARD</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">calc_mode_timings</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dst_timing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ver</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span> <span class="o">+=</span> <span class="n">STD_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span>
		<span class="n">num</span> <span class="o">+=</span> <span class="n">get_std_timing</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="n">ver</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_detailed_timing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">H_ACTIVE</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">V_ACTIVE</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">PIXEL_CLOCK</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">H_SYNC_OFFSET</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_BLANKING</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_SYNC_OFFSET</span> <span class="o">+</span> <span class="n">H_SYNC_WIDTH</span><span class="p">);</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">V_BLANKING</span> <span class="o">-</span> <span class="n">V_SYNC_OFFSET</span> <span class="o">-</span>
		<span class="n">V_SYNC_WIDTH</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">V_SYNC_OFFSET</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">H_SYNC_WIDTH</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">V_SYNC_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HSYNC_POSITIVE</span><span class="p">)</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VSYNC_POSITIVE</span><span class="p">)</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">=</span> <span class="n">PIXEL_CLOCK</span><span class="o">/</span><span class="p">((</span><span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_BLANKING</span><span class="p">)</span> <span class="o">*</span>
				     <span class="p">(</span><span class="n">V_ACTIVE</span> <span class="o">+</span> <span class="n">V_BLANKING</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">FB_MODE_IS_DETAILED</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      %d MHz &quot;</span><span class="p">,</span>  <span class="n">PIXEL_CLOCK</span><span class="o">/</span><span class="mi">1000000</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d %d %d %d &quot;</span><span class="p">,</span> <span class="n">H_ACTIVE</span><span class="p">,</span> <span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_SYNC_OFFSET</span><span class="p">,</span>
	       <span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_SYNC_OFFSET</span> <span class="o">+</span> <span class="n">H_SYNC_WIDTH</span><span class="p">,</span> <span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_BLANKING</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d %d %d %d &quot;</span><span class="p">,</span> <span class="n">V_ACTIVE</span><span class="p">,</span> <span class="n">V_ACTIVE</span> <span class="o">+</span> <span class="n">V_SYNC_OFFSET</span><span class="p">,</span>
	       <span class="n">V_ACTIVE</span> <span class="o">+</span> <span class="n">V_SYNC_OFFSET</span> <span class="o">+</span> <span class="n">V_SYNC_WIDTH</span><span class="p">,</span> <span class="n">V_ACTIVE</span> <span class="o">+</span> <span class="n">V_BLANKING</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%sHSync %sVSync</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">HSYNC_POSITIVE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;+&quot;</span> <span class="o">:</span> <span class="s">&quot;-&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">VSYNC_POSITIVE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;+&quot;</span> <span class="o">:</span> <span class="s">&quot;-&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fb_create_modedb - create video mode database</span>
<span class="cm"> * @edid: EDID data</span>
<span class="cm"> * @dbsize: database size</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS: struct fb_videomode, @dbsize contains length of database</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * This function builds a mode database using the contents of the EDID</span>
<span class="cm"> * data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="nf">fb_create_modedb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dbsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ver</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">ver</span> <span class="o">=</span> <span class="n">edid</span><span class="p">[</span><span class="n">EDID_STRUCT_VERSION</span><span class="p">];</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">edid</span><span class="p">[</span><span class="n">EDID_STRUCT_REVISION</span><span class="p">];</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">edid_checksum</span><span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">edid_check_header</span><span class="p">(</span><span class="n">edid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dbsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Detailed Timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">DETAILED_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span><span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">get_detailed_timing</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			        <span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">FB_MODE_IS_FIRST</span><span class="p">;</span>
				<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">num</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Supported VESA Modes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">ESTABLISHED_TIMING_1</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="n">get_est_timing</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Standard Timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">STD_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STD_TIMING</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span> <span class="o">+=</span> <span class="n">STD_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span>
		<span class="n">num</span> <span class="o">+=</span> <span class="n">get_std_timing</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="n">ver</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">DETAILED_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span><span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfa</span><span class="p">)</span>
			<span class="n">num</span> <span class="o">+=</span> <span class="n">get_dst_timing</span><span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="n">ver</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Yikes, EDID data is totally useless */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dbsize</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fb_destroy_modedb - destroys mode database</span>
<span class="cm"> * @modedb: mode database to destroy</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Destroy mode database created by fb_create_modedb</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fb_destroy_modedb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">modedb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">modedb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_get_monitor_limits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">DETAILED_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Monitor Operating Limits: &quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span> <span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid_is_limits_block</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmin</span> <span class="o">=</span> <span class="n">H_MIN_RATE</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">H_MAX_RATE</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmin</span> <span class="o">=</span> <span class="n">V_MIN_RATE</span><span class="p">;</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">V_MAX_RATE</span><span class="p">;</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmax</span> <span class="o">=</span> <span class="n">MAX_PIXEL_CLOCK</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">gtf</span> <span class="o">=</span> <span class="p">(</span><span class="n">GTF_SUPPORT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;From EDID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* estimate monitor limits based on modes supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">modes</span><span class="p">,</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">num_modes</span><span class="p">,</span> <span class="n">hz</span><span class="p">,</span> <span class="n">hscan</span><span class="p">,</span> <span class="n">pixclock</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">htotal</span><span class="p">;</span>

		<span class="n">modes</span> <span class="o">=</span> <span class="n">fb_create_modedb</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_modes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;None Available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_modes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">pixclock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">htotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span>
				<span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
			<span class="n">vtotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span>
				<span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
				<span class="n">vtotal</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
				<span class="n">vtotal</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">hscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">+</span> <span class="n">htotal</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">htotal</span><span class="p">;</span>
			<span class="n">hscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">hscan</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">hz</span> <span class="o">=</span> <span class="p">(</span><span class="n">hscan</span> <span class="o">+</span> <span class="n">vtotal</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">vtotal</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmax</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmax</span> <span class="o">&lt;</span> <span class="n">pixclock</span><span class="p">)</span>
				<span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmax</span> <span class="o">=</span> <span class="n">pixclock</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmin</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmin</span> <span class="o">&gt;</span> <span class="n">pixclock</span><span class="p">)</span>
				<span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmin</span> <span class="o">=</span> <span class="n">pixclock</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmax</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmax</span> <span class="o">&lt;</span> <span class="n">hscan</span><span class="p">)</span>
				<span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">hscan</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmin</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmin</span> <span class="o">&gt;</span> <span class="n">hscan</span><span class="p">)</span>
				<span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmin</span> <span class="o">=</span> <span class="n">hscan</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmax</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmax</span> <span class="o">&lt;</span> <span class="n">hz</span><span class="p">)</span>
				<span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">hz</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmin</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmin</span> <span class="o">&gt;</span> <span class="n">hz</span><span class="p">)</span>
				<span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmin</span> <span class="o">=</span> <span class="n">hz</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Extrapolated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fb_destroy_modedb</span><span class="p">(</span><span class="n">modes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;           H: %d-%dKHz V: %d-%dHz DCLK: %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmin</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">hfmax</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmin</span><span class="p">,</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">vfmax</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">dclkmax</span><span class="o">/</span><span class="mi">1000000</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_monspecs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">EDID_STRUCT_DISPLAY</span><span class="p">;</span>

	<span class="n">fb_get_monitor_limits</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_DDI</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Digital Display Input&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Analog Display Input: Input Voltage - &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;0.700V/0.300V&quot;</span><span class="p">);</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_ANA_700_300</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;0.714V/0.286V&quot;</span><span class="p">);</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_ANA_714_286</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;1.000V/0.400V&quot;</span><span class="p">);</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_ANA_1000_400</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;0.700V/0.000V&quot;</span><span class="p">);</span>
			<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_ANA_700_000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">      Sync: &quot;</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Configurable signal level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Blank to Blank &quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">|=</span> <span class="n">FB_SIGNAL_BLANK_BLANK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Separate &quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">|=</span> <span class="n">FB_SIGNAL_SEPARATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Composite &quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">|=</span> <span class="n">FB_SIGNAL_COMPOSITE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Sync on Green &quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">|=</span> <span class="n">FB_SIGNAL_SYNC_ON_GREEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Serration on &quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">|=</span> <span class="n">FB_SIGNAL_SERRATION_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">max_x</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">max_y</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Max H-size in cm: &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">max_x</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">max_x</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;variable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Max V-size in cm: &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">max_y</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">max_y</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;variable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">c</span><span class="o">+</span><span class="mi">100</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Gamma: &quot;</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">gamma</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">gamma</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">get_dpms_capabilities</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">specs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Monochrome/Grayscale</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_MONO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      RGB Color Display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_RGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Non-RGB Multicolor Display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_MULTI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">|=</span> <span class="n">FB_DISP_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">get_chroma</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>

	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      Default color format is primary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">FB_MISC_PRIM_COLOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;      First DETAILED Timing is preferred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">FB_MISC_1ST_DETAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      Display is GTF capable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">gtf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fb_parse_edid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">var</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edid_checksum</span><span class="p">(</span><span class="n">edid</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edid_check_header</span><span class="p">(</span><span class="n">edid</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">DETAILED_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span> <span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid_is_timing_block</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">H_ACTIVE</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">V_ACTIVE</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">H_SYNC_OFFSET</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_BLANKING</span><span class="p">)</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">H_ACTIVE</span> <span class="o">+</span> <span class="n">H_SYNC_OFFSET</span> <span class="o">+</span> <span class="n">H_SYNC_WIDTH</span><span class="p">);</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">V_BLANKING</span> <span class="o">-</span> <span class="n">V_SYNC_OFFSET</span> <span class="o">-</span>
				<span class="n">V_SYNC_WIDTH</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">V_SYNC_OFFSET</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">H_SYNC_WIDTH</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">V_SYNC_WIDTH</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">PIXEL_CLOCK</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">HSYNC_POSITIVE</span><span class="p">)</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">VSYNC_POSITIVE</span><span class="p">)</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fb_edid_to_monspecs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edid_checksum</span><span class="p">(</span><span class="n">edid</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">edid_check_header</span><span class="p">(</span><span class="n">edid</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_monspecs</span><span class="p">));</span>

	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">edid</span><span class="p">[</span><span class="n">EDID_STRUCT_VERSION</span><span class="p">];</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">edid</span><span class="p">[</span><span class="n">EDID_STRUCT_REVISION</span><span class="p">];</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;========================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Display Information (EDID)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;========================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   EDID Version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>

	<span class="n">parse_vendor_block</span><span class="p">(</span><span class="n">edid</span> <span class="o">+</span> <span class="n">ID_MANUFACTURER_NAME</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">DETAILED_TIMING_DESCRIPTIONS_START</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span> <span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid_is_serial_block</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">copy_string</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Serial Number: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">edid_is_ascii_block</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">copy_string</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">ascii</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   ASCII Block: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">ascii</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">edid_is_monitor_block</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">copy_string</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Monitor Name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;   Display Characteristics:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">get_monspecs</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>

	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span> <span class="o">=</span> <span class="n">fb_create_modedb</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Workaround for buggy EDIDs that sets that the first</span>
<span class="cm">	 * detailed timing is preferred but has not detailed</span>
<span class="cm">	 * timing specified</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">FB_MODE_IS_DETAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">specs</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_MISC_1ST_DETAIL</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;========================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fb_edid_add_monspecs() - add monitor video modes from E-EDID data</span>
<span class="cm"> * @edid:	128 byte array with an E-EDID block</span>
<span class="cm"> * @spacs:	monitor specs to be extended</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fb_edid_add_monspecs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">svd</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">edt</span><span class="p">[(</span><span class="mi">128</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">svd_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edid_checksum</span><span class="p">(</span><span class="n">edid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x2</span> <span class="o">||</span>
	    <span class="n">edid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">edid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">128</span> <span class="o">-</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;  Short Video Descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">edid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">len</span> <span class="o">=</span> <span class="n">edid</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">edid</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Data block %u of %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">edid</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
				<span class="n">svd</span><span class="p">[</span><span class="n">svd_n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;N%sative mode #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">edid</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;on-n&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">edid</span> <span class="o">+</span> <span class="n">edid</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;  Extended Detailed Timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">edid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">block</span> <span class="o">+=</span> <span class="n">DETAILED_TIMING_DESCRIPTION_SIZE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PIXEL_CLOCK</span><span class="p">)</span>
			<span class="n">edt</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span> <span class="o">-</span> <span class="n">edid</span><span class="p">;</span>

	<span class="cm">/* Yikes, EDID data is totally useless */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="n">svd_n</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="n">svd_n</span><span class="p">)</span> <span class="o">*</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">,</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_detailed_timing</span><span class="p">(</span><span class="n">edid</span> <span class="o">+</span> <span class="n">edt</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">)</span>
			<span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">FB_MODE_IS_FIRST</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Adding %ux%u@%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="n">svd_n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">svd</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">-</span> <span class="n">num</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idx</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Reserved SVD code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cea_modes</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">cea_modes</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">xres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unimplemented SVD code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cea_modes</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Adding SVD #%d: %ux%u@%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
				 <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xres</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">yres</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">);</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">=</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">modedb_len</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="n">svd_n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * VESA Generalized Timing Formula (GTF)</span>
<span class="cm"> */</span>

<span class="cp">#define FLYBACK                     550</span>
<span class="cp">#define V_FRONTPORCH                1</span>
<span class="cp">#define H_OFFSET                    40</span>
<span class="cp">#define H_SCALEFACTOR               20</span>
<span class="cp">#define H_BLANKSCALE                128</span>
<span class="cp">#define H_GRADIENT                  600</span>
<span class="cp">#define C_VAL                       30</span>
<span class="cp">#define M_VAL                       300</span>

<span class="k">struct</span> <span class="n">__fb_timings</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">dclk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hfreq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vfreq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hactive</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vactive</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hblank</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vblank</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">htotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vtotal</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fb_get_vblank - get vertical blank time</span>
<span class="cm"> * @hfreq: horizontal freq</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * vblank = right_margin + vsync_len + left_margin</span>
<span class="cm"> *</span>
<span class="cm"> *    given: right_margin = 1 (V_FRONTPORCH)</span>
<span class="cm"> *           vsync_len    = 3</span>
<span class="cm"> *           flyback      = 550</span>
<span class="cm"> *</span>
<span class="cm"> *                          flyback * hfreq</span>
<span class="cm"> *           left_margin  = --------------- - vsync_len</span>
<span class="cm"> *                           1000000</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">fb_get_vblank</span><span class="p">(</span><span class="n">u32</span> <span class="n">hfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vblank</span><span class="p">;</span>

	<span class="n">vblank</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfreq</span> <span class="o">*</span> <span class="n">FLYBACK</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
	<span class="n">vblank</span> <span class="o">=</span> <span class="p">(</span><span class="n">vblank</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vblank</span> <span class="o">+</span> <span class="n">V_FRONTPORCH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fb_get_hblank_by_freq - get horizontal blank time given hfreq</span>
<span class="cm"> * @hfreq: horizontal freq</span>
<span class="cm"> * @xres: horizontal resolution in pixels</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> *</span>
<span class="cm"> *           xres * duty_cycle</span>
<span class="cm"> * hblank = ------------------</span>
<span class="cm"> *           100 - duty_cycle</span>
<span class="cm"> *</span>
<span class="cm"> * duty cycle = percent of htotal assigned to inactive display</span>
<span class="cm"> * duty cycle = C - (M/Hfreq)</span>
<span class="cm"> *</span>
<span class="cm"> * where: C = ((offset - scale factor) * blank_scale)</span>
<span class="cm"> *            -------------------------------------- + scale factor</span>
<span class="cm"> *                        256</span>
<span class="cm"> *        M = blank_scale * gradient</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">fb_get_hblank_by_hfreq</span><span class="p">(</span><span class="n">u32</span> <span class="n">hfreq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">xres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">c_val</span><span class="p">,</span> <span class="n">m_val</span><span class="p">,</span> <span class="n">duty_cycle</span><span class="p">,</span> <span class="n">hblank</span><span class="p">;</span>

	<span class="n">c_val</span> <span class="o">=</span> <span class="p">(((</span><span class="n">H_OFFSET</span> <span class="o">-</span> <span class="n">H_SCALEFACTOR</span><span class="p">)</span> <span class="o">*</span> <span class="n">H_BLANKSCALE</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span> <span class="o">+</span>
		 <span class="n">H_SCALEFACTOR</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">m_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">H_BLANKSCALE</span> <span class="o">*</span> <span class="n">H_GRADIENT</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">;</span>
	<span class="n">m_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_val</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span><span class="o">/</span><span class="n">hfreq</span><span class="p">;</span>
	<span class="n">duty_cycle</span> <span class="o">=</span> <span class="n">c_val</span> <span class="o">-</span> <span class="n">m_val</span><span class="p">;</span>
	<span class="n">hblank</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="n">duty_cycle</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">100000</span> <span class="o">-</span> <span class="n">duty_cycle</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hblank</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fb_get_hblank_by_dclk - get horizontal blank time given pixelclock</span>
<span class="cm"> * @dclk: pixelclock in Hz</span>
<span class="cm"> * @xres: horizontal resolution in pixels</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> *</span>
<span class="cm"> *           xres * duty_cycle</span>
<span class="cm"> * hblank = ------------------</span>
<span class="cm"> *           100 - duty_cycle</span>
<span class="cm"> *</span>
<span class="cm"> * duty cycle = percent of htotal assigned to inactive display</span>
<span class="cm"> * duty cycle = C - (M * h_period)</span>
<span class="cm"> *</span>
<span class="cm"> * where: h_period = SQRT(100 - C + (0.4 * xres * M)/dclk) + C - 100</span>
<span class="cm"> *                   -----------------------------------------------</span>
<span class="cm"> *                                    2 * M</span>
<span class="cm"> *        M = 300;</span>
<span class="cm"> *        C = 30;</span>

<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">fb_get_hblank_by_dclk</span><span class="p">(</span><span class="n">u32</span> <span class="n">dclk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">xres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">duty_cycle</span><span class="p">,</span> <span class="n">h_period</span><span class="p">,</span> <span class="n">hblank</span><span class="p">;</span>

	<span class="n">dclk</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">h_period</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">C_VAL</span><span class="p">;</span>
	<span class="n">h_period</span> <span class="o">*=</span> <span class="n">h_period</span><span class="p">;</span>
	<span class="n">h_period</span> <span class="o">+=</span> <span class="p">(</span><span class="n">M_VAL</span> <span class="o">*</span> <span class="n">xres</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dclk</span><span class="p">);</span>
	<span class="n">h_period</span> <span class="o">*=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">h_period</span> <span class="o">=</span> <span class="n">int_sqrt</span><span class="p">(</span><span class="n">h_period</span><span class="p">);</span>
	<span class="n">h_period</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">C_VAL</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">h_period</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">h_period</span> <span class="o">/=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_VAL</span><span class="p">;</span>

	<span class="n">duty_cycle</span> <span class="o">=</span> <span class="n">C_VAL</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">-</span> <span class="p">(</span><span class="n">M_VAL</span> <span class="o">*</span> <span class="n">h_period</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
	<span class="n">hblank</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">*</span> <span class="n">duty_cycle</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">100000</span> <span class="o">-</span> <span class="n">duty_cycle</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hblank</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hblank</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fb_get_hfreq - estimate hsync</span>
<span class="cm"> * @vfreq: vertical refresh rate</span>
<span class="cm"> * @yres: vertical resolution</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> *</span>
<span class="cm"> *          (yres + front_port) * vfreq * 1000000</span>
<span class="cm"> * hfreq = -------------------------------------</span>
<span class="cm"> *          (1000000 - (vfreq * FLYBACK)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fb_get_hfreq</span><span class="p">(</span><span class="n">u32</span> <span class="n">vfreq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">hfreq</span><span class="p">;</span>

	<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">-</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">*</span> <span class="n">FLYBACK</span><span class="p">))</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
	<span class="n">hfreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">yres</span> <span class="o">+</span> <span class="n">V_FRONTPORCH</span><span class="p">)</span> <span class="o">*</span> <span class="n">vfreq</span>  <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hfreq</span><span class="o">/</span><span class="n">divisor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_timings_vfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">__fb_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span> <span class="o">=</span> <span class="n">fb_get_hfreq</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span><span class="p">,</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vactive</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vblank</span> <span class="o">=</span> <span class="n">fb_get_vblank</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vactive</span> <span class="o">+</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span> <span class="o">=</span> <span class="n">fb_get_hblank_by_hfreq</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="p">,</span>
						 <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hactive</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hactive</span> <span class="o">+</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">*</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_timings_hfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">__fb_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vblank</span> <span class="o">=</span> <span class="n">fb_get_vblank</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vactive</span> <span class="o">+</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="o">/</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span> <span class="o">=</span> <span class="n">fb_get_hblank_by_hfreq</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="p">,</span>
						 <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hactive</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hactive</span> <span class="o">+</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">*</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fb_timings_dclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">__fb_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span> <span class="o">=</span> <span class="n">fb_get_hblank_by_dclk</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span><span class="p">,</span>
						<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hactive</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hactive</span> <span class="o">+</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span><span class="o">/</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vblank</span> <span class="o">=</span> <span class="n">fb_get_vblank</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="p">);</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vactive</span> <span class="o">+</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span><span class="o">/</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fb_get_mode - calculates video mode using VESA GTF</span>
<span class="cm"> * @flags: if: 0 - maximize vertical refresh rate</span>
<span class="cm"> *             1 - vrefresh-driven calculation;</span>
<span class="cm"> *             2 - hscan-driven calculation;</span>
<span class="cm"> *             3 - pixelclock-driven calculation;</span>
<span class="cm"> * @val: depending on @flags, ignored, vrefresh, hsync or pixelclock</span>
<span class="cm"> * @var: pointer to fb_var_screeninfo</span>
<span class="cm"> * @info: pointer to fb_info</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Calculates video mode based on monitor specs using VESA GTF.</span>
<span class="cm"> * The GTF is best for VESA GTF compliant monitors but is</span>
<span class="cm"> * specifically formulated to work for older monitors as well.</span>
<span class="cm"> *</span>
<span class="cm"> * If @flag==0, the function will attempt to maximize the</span>
<span class="cm"> * refresh rate.  Otherwise, it will calculate timings based on</span>
<span class="cm"> * the flag and accompanying value.</span>
<span class="cm"> *</span>
<span class="cm"> * If FB_IGNOREMON bit is set in @flags, monitor specs will be</span>
<span class="cm"> * ignored and @var will be filled with the calculated timings.</span>
<span class="cm"> *</span>
<span class="cm"> * All calculations are based on the VESA GTF Spreadsheet</span>
<span class="cm"> * available at VESA&#39;s public ftp (http://www.vesa.org).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTES:</span>
<span class="cm"> * The timings generated by the GTF will be different from VESA</span>
<span class="cm"> * DMT.  It might be a good idea to keep a table of standard</span>
<span class="cm"> * VESA modes as well.  The GTF may also not work for some displays,</span>
<span class="cm"> * such as, and especially, analog TV.</span>
<span class="cm"> *</span>
<span class="cm"> * REQUIRES:</span>
<span class="cm"> * A valid info-&gt;monspecs, otherwise &#39;safe numbers&#39; will be used.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fb_get_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__fb_timings</span> <span class="o">*</span><span class="n">timings</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">interlace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dscan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hfmin</span><span class="p">,</span> <span class="n">hfmax</span><span class="p">,</span> <span class="n">vfmin</span><span class="p">,</span> <span class="n">vfmax</span><span class="p">,</span> <span class="n">dclkmin</span><span class="p">,</span> <span class="n">dclkmax</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">timings</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__fb_timings</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timings</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If monspecs are invalid, use values that are enough</span>
<span class="cm">	 * for 640x480@60</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hfmin</span> <span class="o">=</span> <span class="mi">29000</span><span class="p">;</span> <span class="n">hfmax</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
		<span class="n">vfmin</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span> <span class="n">vfmax</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">dclkmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dclkmax</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hfmin</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span><span class="p">;</span>
		<span class="n">hfmax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span><span class="p">;</span>
		<span class="n">vfmin</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span><span class="p">;</span>
		<span class="n">vfmax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">;</span>
		<span class="n">dclkmin</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmin</span><span class="p">;</span>
		<span class="n">dclkmax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hactive</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vactive</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vactive</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">interlace</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vactive</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">dscan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FB_IGNOREMON</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_MAXTIMINGS</span>: <span class="cm">/* maximize refresh rate */</span>
		<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span> <span class="o">=</span> <span class="n">hfmax</span><span class="p">;</span>
		<span class="n">fb_timings_hfreq</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span> <span class="o">&gt;</span> <span class="n">vfmax</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span> <span class="o">=</span> <span class="n">vfmax</span><span class="p">;</span>
			<span class="n">fb_timings_vfreq</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span> <span class="o">&gt;</span> <span class="n">dclkmax</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span> <span class="o">=</span> <span class="n">dclkmax</span><span class="p">;</span>
			<span class="n">fb_timings_dclk</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VSYNCTIMINGS</span>: <span class="cm">/* vrefresh driven */</span>
		<span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">fb_timings_vfreq</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_HSYNCTIMINGS</span>: <span class="cm">/* hsync driven */</span>
		<span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">fb_timings_hfreq</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_DCLKTIMINGS</span>: <span class="cm">/* pixelclock driven */</span>
		<span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">fb_timings_dclk</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FB_IGNOREMON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span> <span class="o">&lt;</span> <span class="n">vfmin</span> <span class="o">||</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">vfreq</span> <span class="o">&gt;</span> <span class="n">vfmax</span> <span class="o">||</span>
	     <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span> <span class="o">&lt;</span> <span class="n">hfmin</span> <span class="o">||</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hfreq</span> <span class="o">&gt;</span> <span class="n">hfmax</span> <span class="o">||</span>
	     <span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span> <span class="o">&lt;</span> <span class="n">dclkmin</span> <span class="o">||</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span> <span class="o">&gt;</span> <span class="n">dclkmax</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">dclk</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">hblank</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">interlace</span><span class="p">)</span><span class="o">/</span><span class="n">dscan</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">interlace</span><span class="p">)</span><span class="o">/</span><span class="n">dscan</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">vblank</span> <span class="o">*</span> <span class="n">interlace</span><span class="p">)</span><span class="o">/</span><span class="n">dscan</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">timings</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="nf">fb_parse_edid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">fb_edid_to_monspecs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">specs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">fb_edid_add_monspecs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">fb_destroy_modedb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">modedb</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">fb_get_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_MODE_HELPERS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * fb_validate_mode - validates var against monitor capabilities</span>
<span class="cm"> * @var: pointer to fb_var_screeninfo</span>
<span class="cm"> * @info: pointer to fb_info</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Validates video mode against monitor capabilities specified in</span>
<span class="cm"> * info-&gt;monspecs.</span>
<span class="cm"> *</span>
<span class="cm"> * REQUIRES:</span>
<span class="cm"> * A valid info-&gt;monspecs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fb_validate_mode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hfreq</span><span class="p">,</span> <span class="n">vfreq</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hfmin</span><span class="p">,</span> <span class="n">hfmax</span><span class="p">,</span> <span class="n">vfmin</span><span class="p">,</span> <span class="n">vfmax</span><span class="p">,</span> <span class="n">dclkmin</span><span class="p">,</span> <span class="n">dclkmax</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If monspecs are invalid, use values that are enough</span>
<span class="cm">	 * for 640x480@60</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hfmin</span> <span class="o">=</span> <span class="mi">29000</span><span class="p">;</span> <span class="n">hfmax</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
		<span class="n">vfmin</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span> <span class="n">vfmax</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">dclkmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dclkmax</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hfmin</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span><span class="p">;</span>
		<span class="n">hfmax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span><span class="p">;</span>
		<span class="n">vfmin</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span><span class="p">;</span>
		<span class="n">vfmax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">;</span>
		<span class="n">dclkmin</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmin</span><span class="p">;</span>
		<span class="n">dclkmax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pixclock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">htotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">+</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">vtotal</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">vtotal</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">hfreq</span> <span class="o">=</span> <span class="n">pixclock</span><span class="o">/</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">hfreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfreq</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">vfreq</span> <span class="o">=</span> <span class="n">hfreq</span><span class="o">/</span><span class="n">vtotal</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">&lt;</span> <span class="n">vfmin</span> <span class="o">||</span> <span class="n">vfreq</span> <span class="o">&gt;</span> <span class="n">vfmax</span> <span class="o">||</span>
		<span class="n">hfreq</span> <span class="o">&lt;</span> <span class="n">hfmin</span> <span class="o">||</span> <span class="n">hfreq</span> <span class="o">&gt;</span> <span class="n">hfmax</span> <span class="o">||</span>
		<span class="n">pixclock</span> <span class="o">&lt;</span> <span class="n">dclkmin</span> <span class="o">||</span> <span class="n">pixclock</span> <span class="o">&gt;</span> <span class="n">dclkmax</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_FIRMWARE_EDID) &amp;&amp; defined(CONFIG_X86)</span>

<span class="cm">/*</span>
<span class="cm"> * We need to ensure that the EDID block is only returned for</span>
<span class="cm"> * the primary graphics adapter.</span>
<span class="cm"> */</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fb_firmware_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_ROM_SHADOW</span><span class="p">)</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">edid_info</span><span class="p">.</span><span class="n">dummy</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">edid</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fb_firmware_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_firmware_edid</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_parse_edid</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_edid_to_monspecs</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_edid_add_monspecs</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_get_mode</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_validate_mode</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fb_destroy_modedb</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
