<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › da8xx-fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>da8xx-fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2008-2009 MontaVista Software Inc.</span>
<span class="cm"> * Copyright (C) 2008-2009 Texas Instruments Inc</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the LCD driver for TI Avalanche processors written by</span>
<span class="cm"> * Ajay Singh and Shalom Hai.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option)any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;video/da8xx-fb.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#define DRIVER_NAME &quot;da8xx_lcdc&quot;</span>

<span class="cp">#define LCD_VERSION_1	1</span>
<span class="cp">#define LCD_VERSION_2	2</span>

<span class="cm">/* LCD Status Register */</span>
<span class="cp">#define LCD_END_OF_FRAME1		BIT(9)</span>
<span class="cp">#define LCD_END_OF_FRAME0		BIT(8)</span>
<span class="cp">#define LCD_PL_LOAD_DONE		BIT(6)</span>
<span class="cp">#define LCD_FIFO_UNDERFLOW		BIT(5)</span>
<span class="cp">#define LCD_SYNC_LOST			BIT(2)</span>

<span class="cm">/* LCD DMA Control Register */</span>
<span class="cp">#define LCD_DMA_BURST_SIZE(x)		((x) &lt;&lt; 4)</span>
<span class="cp">#define LCD_DMA_BURST_1			0x0</span>
<span class="cp">#define LCD_DMA_BURST_2			0x1</span>
<span class="cp">#define LCD_DMA_BURST_4			0x2</span>
<span class="cp">#define LCD_DMA_BURST_8			0x3</span>
<span class="cp">#define LCD_DMA_BURST_16		0x4</span>
<span class="cp">#define LCD_V1_END_OF_FRAME_INT_ENA	BIT(2)</span>
<span class="cp">#define LCD_V2_END_OF_FRAME0_INT_ENA	BIT(8)</span>
<span class="cp">#define LCD_V2_END_OF_FRAME1_INT_ENA	BIT(9)</span>
<span class="cp">#define LCD_DUAL_FRAME_BUFFER_ENABLE	BIT(0)</span>

<span class="cm">/* LCD Control Register */</span>
<span class="cp">#define LCD_CLK_DIVISOR(x)		((x) &lt;&lt; 8)</span>
<span class="cp">#define LCD_RASTER_MODE			0x01</span>

<span class="cm">/* LCD Raster Control Register */</span>
<span class="cp">#define LCD_PALETTE_LOAD_MODE(x)	((x) &lt;&lt; 20)</span>
<span class="cp">#define PALETTE_AND_DATA		0x00</span>
<span class="cp">#define PALETTE_ONLY			0x01</span>
<span class="cp">#define DATA_ONLY			0x02</span>

<span class="cp">#define LCD_MONO_8BIT_MODE		BIT(9)</span>
<span class="cp">#define LCD_RASTER_ORDER		BIT(8)</span>
<span class="cp">#define LCD_TFT_MODE			BIT(7)</span>
<span class="cp">#define LCD_V1_UNDERFLOW_INT_ENA	BIT(6)</span>
<span class="cp">#define LCD_V2_UNDERFLOW_INT_ENA	BIT(5)</span>
<span class="cp">#define LCD_V1_PL_INT_ENA		BIT(4)</span>
<span class="cp">#define LCD_V2_PL_INT_ENA		BIT(6)</span>
<span class="cp">#define LCD_MONOCHROME_MODE		BIT(1)</span>
<span class="cp">#define LCD_RASTER_ENABLE		BIT(0)</span>
<span class="cp">#define LCD_TFT_ALT_ENABLE		BIT(23)</span>
<span class="cp">#define LCD_STN_565_ENABLE		BIT(24)</span>
<span class="cp">#define LCD_V2_DMA_CLK_EN		BIT(2)</span>
<span class="cp">#define LCD_V2_LIDD_CLK_EN		BIT(1)</span>
<span class="cp">#define LCD_V2_CORE_CLK_EN		BIT(0)</span>
<span class="cp">#define LCD_V2_LPP_B10			26</span>

<span class="cm">/* LCD Raster Timing 2 Register */</span>
<span class="cp">#define LCD_AC_BIAS_TRANSITIONS_PER_INT(x)	((x) &lt;&lt; 16)</span>
<span class="cp">#define LCD_AC_BIAS_FREQUENCY(x)		((x) &lt;&lt; 8)</span>
<span class="cp">#define LCD_SYNC_CTRL				BIT(25)</span>
<span class="cp">#define LCD_SYNC_EDGE				BIT(24)</span>
<span class="cp">#define LCD_INVERT_PIXEL_CLOCK			BIT(22)</span>
<span class="cp">#define LCD_INVERT_LINE_CLOCK			BIT(21)</span>
<span class="cp">#define LCD_INVERT_FRAME_CLOCK			BIT(20)</span>

<span class="cm">/* LCD Block */</span>
<span class="cp">#define  LCD_PID_REG				0x0</span>
<span class="cp">#define  LCD_CTRL_REG				0x4</span>
<span class="cp">#define  LCD_STAT_REG				0x8</span>
<span class="cp">#define  LCD_RASTER_CTRL_REG			0x28</span>
<span class="cp">#define  LCD_RASTER_TIMING_0_REG		0x2C</span>
<span class="cp">#define  LCD_RASTER_TIMING_1_REG		0x30</span>
<span class="cp">#define  LCD_RASTER_TIMING_2_REG		0x34</span>
<span class="cp">#define  LCD_DMA_CTRL_REG			0x40</span>
<span class="cp">#define  LCD_DMA_FRM_BUF_BASE_ADDR_0_REG	0x44</span>
<span class="cp">#define  LCD_DMA_FRM_BUF_CEILING_ADDR_0_REG	0x48</span>
<span class="cp">#define  LCD_DMA_FRM_BUF_BASE_ADDR_1_REG	0x4C</span>
<span class="cp">#define  LCD_DMA_FRM_BUF_CEILING_ADDR_1_REG	0x50</span>

<span class="cm">/* Interrupt Registers available only in Version 2 */</span>
<span class="cp">#define  LCD_RAW_STAT_REG			0x58</span>
<span class="cp">#define  LCD_MASKED_STAT_REG			0x5c</span>
<span class="cp">#define  LCD_INT_ENABLE_SET_REG			0x60</span>
<span class="cp">#define  LCD_INT_ENABLE_CLR_REG			0x64</span>
<span class="cp">#define  LCD_END_OF_INT_IND_REG			0x68</span>

<span class="cm">/* Clock registers available only on Version 2 */</span>
<span class="cp">#define  LCD_CLK_ENABLE_REG			0x6c</span>
<span class="cp">#define  LCD_CLK_RESET_REG			0x70</span>
<span class="cp">#define  LCD_CLK_MAIN_RESET			BIT(3)</span>

<span class="cp">#define LCD_NUM_BUFFERS	2</span>

<span class="cp">#define WSI_TIMEOUT	50</span>
<span class="cp">#define PALETTE_SIZE	256</span>
<span class="cp">#define LEFT_MARGIN	64</span>
<span class="cp">#define RIGHT_MARGIN	64</span>
<span class="cp">#define UPPER_MARGIN	32</span>
<span class="cp">#define LOWER_MARGIN	32</span>

<span class="k">static</span> <span class="n">resource_size_t</span> <span class="n">da8xx_fb_reg_base</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">lcdc_regs</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcd_revision</span><span class="p">;</span>
<span class="k">static</span> <span class="n">irq_handler_t</span> <span class="n">lcdc_irq_handler</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">lcdc_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">da8xx_fb_reg_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lcdc_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">da8xx_fb_reg_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">p_palette_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v_palette_base</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">vram_phys</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">vram_size</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">vram_virt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dma_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dma_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">lcdc_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">palette_sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pxl_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blank</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">vsync_wait</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">vsync_flag</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">vsync_timeout</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="k">struct</span> <span class="n">notifier_block</span>	<span class="n">freq_transition</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">lcd_fck_rate</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">panel_power_ctrl</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* Variable Screen Information */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">da8xx_fb_var</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">transp</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">LEFT_MARGIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">RIGHT_MARGIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">UPPER_MARGIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">LOWER_MARGIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">da8xx_fb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;DA8xx FB Drv&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">da8xx_panel</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="n">name</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>	<span class="cm">/* Full name &lt;vendor&gt;_&lt;model&gt; */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">hfp</span><span class="p">;</span>		<span class="cm">/* Horizontal front porch */</span>
	<span class="kt">int</span>		<span class="n">hbp</span><span class="p">;</span>		<span class="cm">/* Horizontal back porch */</span>
	<span class="kt">int</span>		<span class="n">hsw</span><span class="p">;</span>		<span class="cm">/* Horizontal Sync Pulse Width */</span>
	<span class="kt">int</span>		<span class="n">vfp</span><span class="p">;</span>		<span class="cm">/* Vertical front porch */</span>
	<span class="kt">int</span>		<span class="n">vbp</span><span class="p">;</span>		<span class="cm">/* Vertical back porch */</span>
	<span class="kt">int</span>		<span class="n">vsw</span><span class="p">;</span>		<span class="cm">/* Vertical Sync Pulse Width */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">pxl_clk</span><span class="p">;</span>	<span class="cm">/* Pixel clock */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">invert_pxl_clk</span><span class="p">;</span>	<span class="cm">/* Invert Pixel clock */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">da8xx_panel</span> <span class="n">known_lcd_panels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Sharp LCD035Q3DG01 */</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sharp_LCD035Q3DG01&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hbp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pxl_clk</span> <span class="o">=</span> <span class="mi">4608000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">invert_pxl_clk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Sharp LK043T1DG01 */</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sharp_LK043T1DG01&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">272</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hbp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsw</span> <span class="o">=</span> <span class="mi">41</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsw</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pxl_clk</span> <span class="o">=</span> <span class="mi">7833600</span><span class="p">,</span>
		<span class="p">.</span><span class="n">invert_pxl_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Hitachi SP10Q010 */</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SP10Q010&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hfp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hbp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsw</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vfp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsw</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pxl_clk</span> <span class="o">=</span> <span class="mi">7833600</span><span class="p">,</span>
		<span class="p">.</span><span class="n">invert_pxl_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Enable the Raster Engine of the LCD Controller */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lcd_enable_raster</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Bring LCDC out of reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_2</span><span class="p">)</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_CLK_RESET_REG</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LCD_RASTER_ENABLE</span><span class="p">))</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="n">LCD_RASTER_ENABLE</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Disable the Raster Engine of the LCD Controller */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lcd_disable_raster</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LCD_RASTER_ENABLE</span><span class="p">)</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCD_RASTER_ENABLE</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_2</span><span class="p">)</span>
		<span class="cm">/* Write 1 to reset LCDC */</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">LCD_CLK_MAIN_RESET</span><span class="p">,</span> <span class="n">LCD_CLK_RESET_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lcd_blit</span><span class="p">(</span><span class="kt">int</span> <span class="n">load_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_ras</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_int</span><span class="p">;</span>

	<span class="cm">/* init reg to clear PLM (loading mode) fields */</span>
	<span class="n">reg_ras</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>
	<span class="n">reg_ras</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

	<span class="n">reg_dma</span>  <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_DMA_CTRL_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">load_mode</span> <span class="o">==</span> <span class="n">LOAD_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span>    <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span><span class="p">;</span>
		<span class="n">end</span>      <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">;</span>

		<span class="n">reg_ras</span> <span class="o">|=</span> <span class="n">LCD_PALETTE_LOAD_MODE</span><span class="p">(</span><span class="n">DATA_ONLY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_dma</span> <span class="o">|=</span> <span class="n">LCD_V1_END_OF_FRAME_INT_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg_int</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_INT_ENABLE_SET_REG</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">LCD_V2_END_OF_FRAME0_INT_ENA</span> <span class="o">|</span>
				<span class="n">LCD_V2_END_OF_FRAME1_INT_ENA</span><span class="p">;</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg_int</span><span class="p">,</span> <span class="n">LCD_INT_ENABLE_SET_REG</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">reg_dma</span> <span class="o">|=</span> <span class="n">LCD_DUAL_FRAME_BUFFER_ENABLE</span><span class="p">;</span>

		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">LCD_DMA_FRM_BUF_BASE_ADDR_0_REG</span><span class="p">);</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">LCD_DMA_FRM_BUF_CEILING_ADDR_0_REG</span><span class="p">);</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">LCD_DMA_FRM_BUF_BASE_ADDR_1_REG</span><span class="p">);</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">LCD_DMA_FRM_BUF_CEILING_ADDR_1_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load_mode</span> <span class="o">==</span> <span class="n">LOAD_PALETTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span>    <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">p_palette_base</span><span class="p">;</span>
		<span class="n">end</span>      <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">reg_ras</span> <span class="o">|=</span> <span class="n">LCD_PALETTE_LOAD_MODE</span><span class="p">(</span><span class="n">PALETTE_ONLY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_ras</span> <span class="o">|=</span> <span class="n">LCD_V1_PL_INT_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg_int</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_INT_ENABLE_SET_REG</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">LCD_V2_PL_INT_ENA</span><span class="p">;</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg_int</span><span class="p">,</span> <span class="n">LCD_INT_ENABLE_SET_REG</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">LCD_DMA_FRM_BUF_BASE_ADDR_0_REG</span><span class="p">);</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">LCD_DMA_FRM_BUF_CEILING_ADDR_0_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg_dma</span><span class="p">,</span> <span class="n">LCD_DMA_CTRL_REG</span><span class="p">);</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg_ras</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Raster enable bit must be set after all other control fields are</span>
<span class="cm">	 * set.</span>
<span class="cm">	 */</span>
	<span class="n">lcd_enable_raster</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Configure the Burst Size of DMA */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcd_cfg_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">burst_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_DMA_CTRL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">burst_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_DMA_BURST_SIZE</span><span class="p">(</span><span class="n">LCD_DMA_BURST_1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_DMA_BURST_SIZE</span><span class="p">(</span><span class="n">LCD_DMA_BURST_2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_DMA_BURST_SIZE</span><span class="p">(</span><span class="n">LCD_DMA_BURST_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_DMA_BURST_SIZE</span><span class="p">(</span><span class="n">LCD_DMA_BURST_8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_DMA_BURST_SIZE</span><span class="p">(</span><span class="n">LCD_DMA_BURST_16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_DMA_CTRL_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lcd_cfg_ac_bias</span><span class="p">(</span><span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="kt">int</span> <span class="n">transitions_per_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Set the AC Bias Period and Number of Transisitons per Interrupt */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF00000</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_AC_BIAS_FREQUENCY</span><span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">LCD_AC_BIAS_TRANSITIONS_PER_INT</span><span class="p">(</span><span class="n">transitions_per_int</span><span class="p">);</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lcd_cfg_horizontal_sync</span><span class="p">(</span><span class="kt">int</span> <span class="n">back_porch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pulse_width</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">front_porch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_0_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">((</span><span class="n">back_porch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">front_porch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">pulse_width</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_TIMING_0_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lcd_cfg_vertical_sync</span><span class="p">(</span><span class="kt">int</span> <span class="n">back_porch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pulse_width</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">front_porch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_1_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">((</span><span class="n">back_porch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">front_porch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">pulse_width</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_TIMING_1_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcd_cfg_display</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lcd_ctrl_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_int</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_CTRL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LCD_TFT_MODE</span> <span class="o">|</span>
						<span class="n">LCD_MONO_8BIT_MODE</span> <span class="o">|</span>
						<span class="n">LCD_MONOCHROME_MODE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_disp_panel</span><span class="o">-&gt;</span><span class="n">panel_shade</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MONOCHROME</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_MONOCHROME_MODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mono_8bit_mode</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_MONO_8BIT_MODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COLOR_ACTIVE</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_TFT_MODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">tft_alt_mode</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_TFT_ALT_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">COLOR_PASSIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">stn_565_mode</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_STN_565_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable additional interrupts here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_V1_UNDERFLOW_INT_ENA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg_int</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_INT_ENABLE_SET_REG</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">LCD_V2_UNDERFLOW_INT_ENA</span><span class="p">;</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg_int</span><span class="p">,</span> <span class="n">LCD_INT_ENABLE_SET_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">sync_ctrl</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_SYNC_CTRL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCD_SYNC_CTRL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">sync_edge</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_SYNC_EDGE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCD_SYNC_EDGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">invert_line_clock</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_INVERT_LINE_CLOCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCD_INVERT_LINE_CLOCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">invert_frm_clock</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_INVERT_FRAME_CLOCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCD_INVERT_FRAME_CLOCK</span><span class="p">;</span>

	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcd_cfg_frame_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">raster_order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Set the Panel Width */</span>
	<span class="cm">/* Pixels per line = (PPL + 1)*16 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0x3F in bits 4..9 gives max horizontal resolution = 1024</span>
<span class="cm">		 * pixels.</span>
<span class="cm">		 */</span>
		<span class="n">width</span> <span class="o">&amp;=</span> <span class="mh">0x3f0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0x7F in bits 4..10 gives max horizontal resolution = 2048</span>
<span class="cm">		 * pixels.</span>
<span class="cm">		 */</span>
		<span class="n">width</span> <span class="o">&amp;=</span> <span class="mh">0x7f0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_0_REG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xfffffc00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">((</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">((</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_TIMING_0_REG</span><span class="p">);</span>

	<span class="cm">/* Set the Panel Height */</span>
	<span class="cm">/* Set bits 9:0 of Lines Per Pixel */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_1_REG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xfffffc00</span><span class="p">);</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_TIMING_1_REG</span><span class="p">);</span>

	<span class="cm">/* Set bit 10 of Lines Per Pixel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">((</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set the Raster Order of the Frame Buffer */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_CTRL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raster_order</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LCD_RASTER_ORDER</span><span class="p">;</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_sz</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_sz</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">palette</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">v_palette_base</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">pal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">update_hw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pal</span> <span class="o">=</span> <span class="n">regno</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="n">pal</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">);</span>
			<span class="n">pal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0x00f0</span><span class="p">);</span>
			<span class="n">pal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pal</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
		<span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>

		<span class="n">pal</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">);</span>
		<span class="n">pal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0x00f0</span><span class="p">);</span>
		<span class="n">pal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">update_hw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">red</span> <span class="o">&lt;&lt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">green</span> <span class="o">&lt;&lt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">blue</span> <span class="o">&lt;&lt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span> <span class="o">|</span> <span class="n">green</span> <span class="o">|</span> <span class="n">blue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">update_hw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Update the palette in the h/w as needed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_hw</span><span class="p">)</span>
		<span class="n">lcd_blit</span><span class="p">(</span><span class="n">LOAD_PALETTE</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lcd_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable the Raster if previously Enabled */</span>
	<span class="n">lcd_disable_raster</span><span class="p">();</span>

	<span class="cm">/* DMA has to be disabled */</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_DMA_CTRL_REG</span><span class="p">);</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_INT_ENABLE_SET_REG</span><span class="p">);</span>
		<span class="cm">/* Write 1 to reset */</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">LCD_CLK_MAIN_RESET</span><span class="p">,</span> <span class="n">LCD_CLK_RESET_REG</span><span class="p">);</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_CLK_RESET_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lcd_calc_clk_divider</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcd_clk</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">lcd_clk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">lcd_clk</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pxl_clk</span><span class="p">;</span>

	<span class="cm">/* Configure the LCD clock divisor. */</span>
	<span class="n">lcdc_write</span><span class="p">(</span><span class="n">LCD_CLK_DIVISOR</span><span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">LCD_RASTER_MODE</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">),</span> <span class="n">LCD_CTRL_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_2</span><span class="p">)</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">LCD_V2_DMA_CLK_EN</span> <span class="o">|</span> <span class="n">LCD_V2_LIDD_CLK_EN</span> <span class="o">|</span>
				<span class="n">LCD_V2_CORE_CLK_EN</span><span class="p">,</span> <span class="n">LCD_CLK_ENABLE_REG</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">lcd_ctrl_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">da8xx_panel</span> <span class="o">*</span><span class="n">panel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lcd_reset</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Calculate the divider */</span>
	<span class="n">lcd_calc_clk_divider</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">invert_pxl_clk</span><span class="p">)</span>
		<span class="n">lcdc_write</span><span class="p">((</span><span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">LCD_INVERT_PIXEL_CLOCK</span><span class="p">),</span> <span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lcdc_write</span><span class="p">((</span><span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">LCD_INVERT_PIXEL_CLOCK</span><span class="p">),</span> <span class="n">LCD_RASTER_TIMING_2_REG</span><span class="p">);</span>

	<span class="cm">/* Configure the DMA burst size. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lcd_cfg_dma</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dma_burst_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Configure the AC bias properties. */</span>
	<span class="n">lcd_cfg_ac_bias</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ac_bias</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ac_bias_intrpt</span><span class="p">);</span>

	<span class="cm">/* Configure the vertical and horizontal sync properties. */</span>
	<span class="n">lcd_cfg_vertical_sync</span><span class="p">(</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">vbp</span><span class="p">,</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">vsw</span><span class="p">,</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">vfp</span><span class="p">);</span>
	<span class="n">lcd_cfg_horizontal_sync</span><span class="p">(</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">hbp</span><span class="p">,</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">hsw</span><span class="p">,</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">hfp</span><span class="p">);</span>

	<span class="cm">/* Configure for disply */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lcd_cfg_display</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">QVGA</span> <span class="o">!=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_disp_panel</span><span class="o">-&gt;</span><span class="n">panel_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_disp_panel</span><span class="o">-&gt;</span><span class="n">max_bpp</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&gt;=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_disp_panel</span><span class="o">-&gt;</span><span class="n">min_bpp</span><span class="p">)</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_disp_panel</span><span class="o">-&gt;</span><span class="n">max_bpp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lcd_cfg_frame_buffer</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span>
				<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">raster_order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Configure FDD */</span>
	<span class="n">lcdc_write</span><span class="p">((</span><span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_CTRL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff00fff</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fdd</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* IRQ handler for version 2 of LCDC */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lcdc_irq_handler_rev02</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_MASKED_STAT_REG</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg_int</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_SYNC_LOST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_FIFO_UNDERFLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lcd_disable_raster</span><span class="p">();</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">LCD_MASKED_STAT_REG</span><span class="p">);</span>
		<span class="n">lcd_enable_raster</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_PL_LOAD_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Must disable raster before changing state of any control bit.</span>
<span class="cm">		 * And also must be disabled before clearing the PL loading</span>
<span class="cm">		 * interrupt via the following write to the status register. If</span>
<span class="cm">		 * this is done after then one gets multiple PL done interrupts.</span>
<span class="cm">		 */</span>
		<span class="n">lcd_disable_raster</span><span class="p">();</span>

		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">LCD_MASKED_STAT_REG</span><span class="p">);</span>

		<span class="cm">/* Disable PL completion inerrupt */</span>
		<span class="n">reg_int</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_INT_ENABLE_CLR_REG</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">LCD_V2_PL_INT_ENA</span><span class="p">);</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg_int</span><span class="p">,</span> <span class="n">LCD_INT_ENABLE_CLR_REG</span><span class="p">);</span>

		<span class="cm">/* Setup and start data loading mode */</span>
		<span class="n">lcd_blit</span><span class="p">(</span><span class="n">LOAD_DATA</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">LCD_MASKED_STAT_REG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_END_OF_FRAME0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_BASE_ADDR_0_REG</span><span class="p">);</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_CEILING_ADDR_0_REG</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_wait</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_END_OF_FRAME1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_BASE_ADDR_1_REG</span><span class="p">);</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_CEILING_ADDR_1_REG</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_wait</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_END_OF_INT_IND_REG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* IRQ handler for version 1 LCDC */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lcdc_irq_handler_rev01</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_STAT_REG</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg_ras</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_SYNC_LOST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_FIFO_UNDERFLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lcd_disable_raster</span><span class="p">();</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">LCD_STAT_REG</span><span class="p">);</span>
		<span class="n">lcd_enable_raster</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_PL_LOAD_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Must disable raster before changing state of any control bit.</span>
<span class="cm">		 * And also must be disabled before clearing the PL loading</span>
<span class="cm">		 * interrupt via the following write to the status register. If</span>
<span class="cm">		 * this is done after then one gets multiple PL done interrupts.</span>
<span class="cm">		 */</span>
		<span class="n">lcd_disable_raster</span><span class="p">();</span>

		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">LCD_STAT_REG</span><span class="p">);</span>

		<span class="cm">/* Disable PL completion inerrupt */</span>
		<span class="n">reg_ras</span>  <span class="o">=</span> <span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>
		<span class="n">reg_ras</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCD_V1_PL_INT_ENA</span><span class="p">;</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">reg_ras</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

		<span class="cm">/* Setup and start data loading mode */</span>
		<span class="n">lcd_blit</span><span class="p">(</span><span class="n">LOAD_DATA</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">LCD_STAT_REG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_END_OF_FRAME0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_BASE_ADDR_0_REG</span><span class="p">);</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_CEILING_ADDR_0_REG</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_wait</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">LCD_END_OF_FRAME1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_BASE_ADDR_1_REG</span><span class="p">);</span>
			<span class="n">lcdc_write</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_end</span><span class="p">,</span>
				   <span class="n">LCD_DMA_FRM_BUF_CEILING_ADDR_1_REG</span><span class="p">);</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_wait</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="n">FB_NONSTD_REV_PIX_IN_B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:		<span class="cm">/* RGB 565 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcd_da8xx_cpufreq_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">da8xx_fb_par</span><span class="p">,</span> <span class="n">freq_transition</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_fck_rate</span> <span class="o">!=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_fck_rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">);</span>
			<span class="n">lcd_disable_raster</span><span class="p">();</span>
			<span class="n">lcd_calc_clk_divider</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
			<span class="n">lcd_enable_raster</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">lcd_da8xx_cpufreq_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">lcd_da8xx_cpufreq_transition</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span>
					 <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lcd_da8xx_cpufreq_deregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpufreq_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span>
				    <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">fb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
		<span class="n">lcd_da8xx_cpufreq_deregister</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">lcd_disable_raster</span><span class="p">();</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_RASTER_CTRL_REG</span><span class="p">);</span>

		<span class="cm">/* disable DMA  */</span>
		<span class="n">lcdc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">LCD_DMA_CTRL_REG</span><span class="p">);</span>

		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PALETTE_SIZE</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">v_palette_base</span><span class="p">,</span>
				  <span class="n">par</span><span class="o">-&gt;</span><span class="n">p_palette_base</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_virt</span><span class="p">,</span>
				  <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_phys</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">da8xx_fb_reg_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">lcdc_regs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">lcdc_regs</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function to wait for vertical sync which for this LCD peripheral</span>
<span class="cm"> * translates into waiting for the current raster frame to complete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_wait_for_vsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set flag to 0 and wait for isr to set to 1. It would seem there is a</span>
<span class="cm">	 * race condition here where the ISR could have occurred just before or</span>
<span class="cm">	 * just after this set. But since we are just coarsely waiting for</span>
<span class="cm">	 * a frame to complete then that&#39;s OK. i.e. if the frame completed</span>
<span class="cm">	 * just before this code executed then we have to wait another full</span>
<span class="cm">	 * frame time but there is no way to avoid such a situation. On the</span>
<span class="cm">	 * other hand if the frame completed just after then we don&#39;t need</span>
<span class="cm">	 * to wait long at all. Either way we are guaranteed to return to the</span>
<span class="cm">	 * user immediately after a frame completion which is all that is</span>
<span class="cm">	 * required.</span>
<span class="cm">	 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_wait</span><span class="p">,</span>
					       <span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcd_sync_arg</span> <span class="n">sync_arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIOGET_CONTRAST</span>:
	<span class="k">case</span> <span class="n">FBIOPUT_CONTRAST</span>:
	<span class="k">case</span> <span class="n">FBIGET_BRIGHTNESS</span>:
	<span class="k">case</span> <span class="n">FBIPUT_BRIGHTNESS</span>:
	<span class="k">case</span> <span class="n">FBIGET_COLOR</span>:
	<span class="k">case</span> <span class="n">FBIPUT_COLOR</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIPUT_HSYNC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sync_arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_sync_arg</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">lcd_cfg_horizontal_sync</span><span class="p">(</span><span class="n">sync_arg</span><span class="p">.</span><span class="n">back_porch</span><span class="p">,</span>
					<span class="n">sync_arg</span><span class="p">.</span><span class="n">pulse_width</span><span class="p">,</span>
					<span class="n">sync_arg</span><span class="p">.</span><span class="n">front_porch</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIPUT_VSYNC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sync_arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_sync_arg</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">lcd_cfg_vertical_sync</span><span class="p">(</span><span class="n">sync_arg</span><span class="p">.</span><span class="n">back_porch</span><span class="p">,</span>
					<span class="n">sync_arg</span><span class="p">.</span><span class="n">pulse_width</span><span class="p">,</span>
					<span class="n">sync_arg</span><span class="p">.</span><span class="n">front_porch</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIO_WAITFORVSYNC</span>:
		<span class="k">return</span> <span class="n">fb_wait_for_vsync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="n">blank</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">=</span> <span class="n">blank</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">lcd_enable_raster</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">lcd_disable_raster</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set new x,y offsets in the virtual display for the visible area and switch</span>
<span class="cm"> * to the new mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">da8xx_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">new_var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span>         <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span>    <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">||</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_var</span><span class="p">));</span>
		<span class="n">new_var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">new_var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_var</span><span class="p">,</span> <span class="n">fbi</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_var</span><span class="p">));</span>

			<span class="n">start</span>	<span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">+</span>
				<span class="n">new_var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">+</span>
				<span class="n">new_var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">end</span>	<span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">*</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span>	<span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_end</span>	<span class="o">=</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">da8xx_fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="n">fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">da8xx_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span> <span class="o">=</span> <span class="n">fb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span> <span class="n">cfb_blank</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Calculate and return pixel clock period in pico seconds */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">da8xxfb_pixel_clk_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcd_clk</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">configured_pix_clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pix_clk_period_picosec</span> <span class="o">=</span> <span class="mi">1000000000000ULL</span><span class="p">;</span>

	<span class="n">lcd_clk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">lcd_clk</span> <span class="o">/</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pxl_clk</span><span class="p">;</span>
	<span class="n">configured_pix_clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcd_clk</span> <span class="o">/</span> <span class="n">div</span><span class="p">);</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">pix_clk_period_picosec</span><span class="p">,</span> <span class="n">configured_pix_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pix_clk_period_picosec</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">da8xx_lcdc_platform_data</span> <span class="o">*</span><span class="n">fb_pdata</span> <span class="o">=</span>
						<span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcd_ctrl_config</span> <span class="o">*</span><span class="n">lcd_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">da8xx_panel</span> <span class="o">*</span><span class="n">lcdc_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">da8xx_fb_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">fb_clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can not get platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lcdc_regs</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcdc_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Can not get memory resource for LCD controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">lcdc_regs</span><span class="p">);</span>

	<span class="n">lcdc_regs</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">lcdc_regs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">lcdc_regs</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcdc_regs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">da8xx_fb_reg_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">resource_size_t</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">lcdc_regs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">da8xx_fb_reg_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_request_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fb_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can not get device clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">fb_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_clk_put</span><span class="p">;</span>

	<span class="cm">/* Determine LCD IP Version */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_PID_REG</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4C100102</span>:
		<span class="n">lcd_revision</span> <span class="o">=</span> <span class="n">LCD_VERSION_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4F200800</span>:
		<span class="n">lcd_revision</span> <span class="o">=</span> <span class="n">LCD_VERSION_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown PID Reg value 0x%x, &quot;</span>
				<span class="s">&quot;defaulting to LCD revision 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">lcdc_read</span><span class="p">(</span><span class="n">LCD_PID_REG</span><span class="p">));</span>
		<span class="n">lcd_revision</span> <span class="o">=</span> <span class="n">LCD_VERSION_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lcdc_info</span> <span class="o">=</span> <span class="n">known_lcd_panels</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">known_lcd_panels</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">lcdc_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fb_pdata</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">known_lcd_panels</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GLCD: No valid panel found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_clk_disable</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GLCD: Found %s panel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">fb_pdata</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">lcd_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcd_ctrl_config</span> <span class="o">*</span><span class="p">)</span><span class="n">fb_pdata</span><span class="o">-&gt;</span><span class="n">controller_data</span><span class="p">;</span>

	<span class="n">da8xx_fb_info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">da8xx_fb_par</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">da8xx_fb_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed for fb_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_clk_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span> <span class="o">=</span> <span class="n">fb_clk</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcd_fck_rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">fb_clk</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pxl_clk</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">pxl_clk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_pdata</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span> <span class="o">=</span> <span class="n">fb_pdata</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_init</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">lcd_cfg</span><span class="p">,</span> <span class="n">lcdc_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lcd_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate frame buffer */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">lcd_cfg</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span> <span class="o">*</span> <span class="n">LCD_NUM_BUFFERS</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
					    <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">resource_size_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_phys</span><span class="p">,</span>
					    <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;GLCD: kmalloc for frame buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_virt</span><span class="p">;</span>
	<span class="n">da8xx_fb_fix</span><span class="p">.</span><span class="n">smem_start</span>    <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_phys</span><span class="p">;</span>
	<span class="n">da8xx_fb_fix</span><span class="p">.</span><span class="n">smem_len</span>      <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">;</span>
	<span class="n">da8xx_fb_fix</span><span class="p">.</span><span class="n">line_length</span>   <span class="o">=</span> <span class="p">(</span><span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">lcd_cfg</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_phys</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_end</span>   <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dma_start</span> <span class="o">+</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span>
		<span class="n">da8xx_fb_fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* allocate palette buffer */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">v_palette_base</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
					       <span class="n">PALETTE_SIZE</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">resource_size_t</span> <span class="o">*</span><span class="p">)</span>
					       <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">p_palette_base</span><span class="p">,</span>
					       <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">v_palette_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;GLCD: kmalloc for palette buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_fb_mem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">v_palette_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PALETTE_SIZE</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_pl_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize par */</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">lcd_cfg</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>

	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">yres</span>         <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">LCD_NUM_BUFFERS</span><span class="p">;</span>

	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">grayscale</span> <span class="o">=</span>
	    <span class="n">lcd_cfg</span><span class="o">-&gt;</span><span class="n">p_disp_panel</span><span class="o">-&gt;</span><span class="n">panel_shade</span> <span class="o">==</span> <span class="n">MONOCHROME</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">lcd_cfg</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>

	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">hsw</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">vsw</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">hfp</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">left_margin</span>  <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">hbp</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">vfp</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">lcdc_info</span><span class="o">-&gt;</span><span class="n">vbp</span><span class="p">;</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">da8xxfb_pixel_clk_period</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Initialize fbinfo */</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">da8xx_fb_fix</span><span class="p">;</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">da8xx_fb_var</span><span class="p">;</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da8xx_fb_ops</span><span class="p">;</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="p">(</span><span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">PALETTE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_pl_mem</span><span class="p">;</span>
	<span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette_sz</span><span class="p">;</span>

	<span class="cm">/* initialize var_screeninfo */</span>
	<span class="n">da8xx_fb_var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_FORCE</span><span class="p">;</span>
	<span class="n">fb_set_var</span><span class="p">(</span><span class="n">da8xx_fb_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da8xx_fb_var</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">da8xx_fb_info</span><span class="p">);</span>

	<span class="cm">/* initialize the vsync wait queue */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_wait</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vsync_timeout</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* Register the Frame Buffer  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">da8xx_fb_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;GLCD: Frame Buffer Registration Failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dealloc_cmap</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lcd_da8xx_cpufreq_register</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register cpufreq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cpu_freq</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_revision</span> <span class="o">==</span> <span class="n">LCD_VERSION_1</span><span class="p">)</span>
		<span class="n">lcdc_irq_handler</span> <span class="o">=</span> <span class="n">lcdc_irq_handler_rev01</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lcdc_irq_handler</span> <span class="o">=</span> <span class="n">lcdc_irq_handler_rev02</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lcdc_irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">irq_freq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">irq_freq:</span>
<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="n">lcd_da8xx_cpufreq_deregister</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="nl">err_cpu_freq:</span>
<span class="cp">#endif</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">da8xx_fb_info</span><span class="p">);</span>

<span class="nl">err_dealloc_cmap:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da8xx_fb_info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

<span class="nl">err_release_pl_mem:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PALETTE_SIZE</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">v_palette_base</span><span class="p">,</span>
			  <span class="n">par</span><span class="o">-&gt;</span><span class="n">p_palette_base</span><span class="p">);</span>

<span class="nl">err_release_fb_mem:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_virt</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vram_phys</span><span class="p">);</span>

<span class="nl">err_release_fb:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">da8xx_fb_info</span><span class="p">);</span>

<span class="nl">err_clk_disable:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">fb_clk</span><span class="p">);</span>

<span class="nl">err_clk_put:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">fb_clk</span><span class="p">);</span>

<span class="nl">err_ioremap:</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">da8xx_fb_reg_base</span><span class="p">);</span>

<span class="nl">err_request_mem:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">lcdc_regs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lcd_disable_raster</span><span class="p">();</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">da8xx_fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">panel_power_ctrl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcdc_clk</span><span class="p">);</span>
	<span class="n">lcd_enable_raster</span><span class="p">();</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define fb_suspend NULL</span>
<span class="cp">#define fb_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">da8xx_fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">fb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">fb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">fb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">fb_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		   <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">da8xx_fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da8xx_fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">da8xx_fb_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da8xx_fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">da8xx_fb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">da8xx_fb_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for TI da8xx/omap-l1xx&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
