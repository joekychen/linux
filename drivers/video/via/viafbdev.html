<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › via › viafbdev.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>viafbdev.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 1998-2009 VIA Technologies, Inc. All Rights Reserved.</span>
<span class="cm"> * Copyright 2001-2008 S3 Graphics, Inc. All Rights Reserved.</span>

<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public</span>
<span class="cm"> * License as published by the Free Software Foundation;</span>
<span class="cm"> * either version 2, or (at your option) any later version.</span>

<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTIES OR REPRESENTATIONS; without even</span>
<span class="cm"> * the implied warranty of MERCHANTABILITY or FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE.See the GNU General Public License</span>
<span class="cm"> * for more details.</span>

<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc.,</span>
<span class="cm"> * 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/via-core.h&gt;</span>
<span class="cp">#include &lt;linux/via_i2c.h&gt;</span>
<span class="cp">#include &lt;asm/olpc.h&gt;</span>

<span class="cp">#define _MASTER_FILE</span>
<span class="cp">#include &quot;global.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">viafb_name</span> <span class="o">=</span> <span class="s">&quot;Via&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">pseudo_pal</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>

<span class="cm">/* video mode */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">viafb_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">viafb_mode1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">viafb_bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">viafb_bpp1</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">viafb_second_offset</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">viafb_second_size</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">viafb_accel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Added for specifying active devices.*/</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">viafb_active_dev</span><span class="p">;</span>

<span class="cm">/*Added for specify lcd output port*/</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">viafb_lcd_port</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">viafb_dvi_port</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">retrieve_device_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_ioctl_setting</span>
	<span class="o">*</span><span class="n">setting_info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">viafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">viafb_ops</span><span class="p">;</span>

<span class="cm">/* supported output devices on each IGP</span>
<span class="cm"> * only CX700, VX800, VX855, VX900 were documented</span>
<span class="cm"> * VIA_CRT should be everywhere</span>
<span class="cm"> * VIA_6C can be onle pre-CX700 (probably only on CLE266) as 6C is used for PLL</span>
<span class="cm"> * source selection on CX700 and later</span>
<span class="cm"> * K400 seems to support VIA_96, VIA_DVP1, VIA_LVDS{1,2} as in viamode.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">supported_odev_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">UNICHROME_CLE266</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_LDVP0</span> <span class="o">|</span> <span class="n">VIA_LDVP1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_K400</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP0</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span>
				<span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_K800</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP0</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span>
				<span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_PM800</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP0</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span>
				<span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_CN700</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP0</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span>
				<span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_CX700</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_CN750</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_K8M890</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_P4M890</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_P4M900</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_VX800</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_VX855</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">UNICHROME_VX900</span><span class="p">]</span>	<span class="o">=</span> <span class="n">VIA_CRT</span> <span class="o">|</span> <span class="n">VIA_DVP1</span> <span class="o">|</span> <span class="n">VIA_LVDS1</span> <span class="o">|</span> <span class="n">VIA_LVDS2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_fill_var_color_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="n">u8</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">30</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_update_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span>
		<span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
		<span class="n">VIA_PITCH_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_setup_fixinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viaparinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">viafb_name</span><span class="p">);</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Just tell the accel name */</span>
	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_VIA_UNICHROME</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_open!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_release!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_var_refresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">;</span>

	<span class="n">htotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span>
		<span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span>
		<span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">*</span> <span class="n">vtotal</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="n">refresh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">ppar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">line</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_check_var!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Sanity check */</span>
	<span class="cm">/* HW neither support interlacte nor double-scaned mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* the refresh rate is not important here, as we only want to know</span>
<span class="cm">	 * whether the resolution exists</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafb_get_best_mode</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span>
			  <span class="s">&quot;viafb: Mode %dx%dx%d not supported!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">depth</span> <span class="o">=</span> <span class="n">fb_get_color_depth</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">depth</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">depth</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">viafb_dual_fb</span> <span class="o">&amp;&amp;</span> <span class="n">ppar</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA1</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">viafb_fill_var_color_info</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
		<span class="n">VIA_PITCH_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;</span> <span class="n">VIA_PITCH_MAX</span> <span class="o">||</span> <span class="n">line</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">ppar</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Based on var passed in to calculate the refresh,</span>
<span class="cm">	 * because our driver use some modes special.</span>
<span class="cm">	 */</span>
	<span class="n">refresh</span> <span class="o">=</span> <span class="n">viafb_get_refresh</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		<span class="n">get_var_refresh</span><span class="p">(</span><span class="n">var</span><span class="p">));</span>

	<span class="cm">/* Adjust var according to our driver&#39;s own table */</span>
	<span class="n">viafb_fill_var_timing_info</span><span class="p">(</span><span class="n">var</span><span class="p">,</span>
		<span class="n">viafb_get_best_mode</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">refresh</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">ppar</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_mmio</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viapar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refresh</span><span class="p">;</span>
	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_set_par!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">viafb_update_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">viapar</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">fb_get_color_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">);</span>
	<span class="n">viafb_update_device_setting</span><span class="p">(</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
		<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">viafb_update_device_setting</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span>
			<span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">viafb_SAMM_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;viafb_second_xres = %d, viafb_second_yres = %d, bpp = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">viafb_second_xres</span><span class="p">,</span> <span class="n">viafb_second_yres</span><span class="p">,</span> <span class="n">viafb_bpp1</span><span class="p">);</span>

		<span class="n">viafb_update_device_setting</span><span class="p">(</span><span class="n">viafb_second_xres</span><span class="p">,</span>
			<span class="n">viafb_second_yres</span><span class="p">,</span> <span class="n">viafb_bpp1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">refresh</span> <span class="o">=</span> <span class="n">get_var_refresh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span> <span class="o">&amp;&amp;</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">viafb_bpp1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">viafb_refresh1</span> <span class="o">=</span> <span class="n">refresh</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">viafb_bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">viafb_refresh</span> <span class="o">=</span> <span class="n">refresh</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">&amp;</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
	<span class="n">viafb_setmode</span><span class="p">();</span>
	<span class="n">viafb_pan_display</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set one color register */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
<span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viapar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafb_dual_fb</span> <span class="o">||</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA1</span><span class="p">)</span>
			<span class="n">viafb_set_primary_color_register</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				<span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafb_dual_fb</span> <span class="o">||</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA2</span><span class="p">)</span>
			<span class="n">viafb_set_secondary_color_register</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				<span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">))</span>
			<span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">))</span>
			<span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">))</span>
			<span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> <span class="o">|</span> <span class="n">g</span> <span class="o">|</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viapar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vram_addr</span> <span class="o">=</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">vram_addr</span>
		<span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span>
		<span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;viafb_pan_display, address = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vram_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafb_dual_fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_set_primary_address</span><span class="p">(</span><span class="n">vram_addr</span><span class="p">);</span>
		<span class="n">via_set_secondary_address</span><span class="p">(</span><span class="n">vram_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">viapar</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA1</span><span class="p">)</span>
		<span class="n">via_set_primary_address</span><span class="p">(</span><span class="n">vram_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">via_set_secondary_address</span><span class="p">(</span><span class="n">vram_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_blank!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* clear DPMS setting */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="cm">/* Screen: On, HSync: On, VSync: On */</span>
		<span class="cm">/* control CRT monitor power management */</span>
		<span class="n">via_set_state</span><span class="p">(</span><span class="n">VIA_CRT</span><span class="p">,</span> <span class="n">VIA_STATE_ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="cm">/* Screen: Off, HSync: Off, VSync: On */</span>
		<span class="cm">/* control CRT monitor power management */</span>
		<span class="n">via_set_state</span><span class="p">(</span><span class="n">VIA_CRT</span><span class="p">,</span> <span class="n">VIA_STATE_STANDBY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="cm">/* Screen: Off, HSync: On, VSync: Off */</span>
		<span class="cm">/* control CRT monitor power management */</span>
		<span class="n">via_set_state</span><span class="p">(</span><span class="n">VIA_CRT</span><span class="p">,</span> <span class="n">VIA_STATE_SUSPEND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="cm">/* Screen: Off, HSync: Off, VSync: Off */</span>
		<span class="cm">/* control CRT monitor power management */</span>
		<span class="n">via_set_state</span><span class="p">(</span><span class="n">VIA_CRT</span><span class="p">,</span> <span class="n">VIA_STATE_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">viafb_ioctl_mode</span> <span class="n">viamode</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">viafb_ioctl_samm</span> <span class="n">viasamm</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">viafb_driver_version</span> <span class="n">driver_version</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">sec_var</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">_panel_size_pos_info</span> <span class="n">panel_pos_size_para</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">viafb_ioctl_setting</span> <span class="n">viafb_setting</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">device_t</span> <span class="n">active_dev</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">viafb_gamma_table</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;viafb&quot;</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpu32</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_ioctl: 0x%X !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;viafb_ioctl: Please avoid this interface as it is unstable and might change or vanish at any time!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_CHIP_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chip_information</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_INFO_SIZE</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_ioctl_info</span><span class="p">),</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_INFO</span>:
		<span class="k">return</span> <span class="n">viafb_ioctl_get_viafb_info</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">VIAFB_HOTPLUG</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">viafb_ioctl_hotplug</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span>
					      <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
					      <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">),</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">VIAFB_SET_HOTPLUG_FLAG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpu32</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpu32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">viafb_hotplug</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpu32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_RESOLUTION</span>:
		<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">viafb_hotplug_Xres</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">viafb_hotplug_Yres</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">refresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">viafb_hotplug_refresh</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">viafb_hotplug_bpp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">viafb_SAMM_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">xres_sec</span> <span class="o">=</span> <span class="n">viafb_second_xres</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">yres_sec</span> <span class="o">=</span> <span class="n">viafb_second_yres</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">virtual_xres_sec</span> <span class="o">=</span> <span class="n">viafb_dual_fb</span> <span class="o">?</span> <span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">:</span> <span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">virtual_yres_sec</span> <span class="o">=</span> <span class="n">viafb_dual_fb</span> <span class="o">?</span> <span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">:</span> <span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">refresh_sec</span> <span class="o">=</span> <span class="n">viafb_refresh1</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">bpp_sec</span> <span class="o">=</span> <span class="n">viafb_bpp1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">xres_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">yres_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">virtual_xres_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">virtual_yres_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">refresh_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">.</span><span class="n">bpp_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">viamode</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_SAMM_INFO</span>:
		<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">samm_status</span> <span class="o">=</span> <span class="n">viafb_SAMM_ON</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">viafb_SAMM_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_prim</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span><span class="p">;</span>
				<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_sec</span> <span class="o">=</span> <span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">fbmem_free</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">viafb_second_size</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_prim</span> <span class="o">=</span>
					    <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">-</span>
					    <span class="n">viafb_second_size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
					<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_sec</span> <span class="o">=</span>
					    <span class="n">viafb_second_size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_prim</span> <span class="o">=</span>
					    <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_sec</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">offset_sec</span> <span class="o">=</span> <span class="n">viafb_second_offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_prim</span> <span class="o">=</span>
			    <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">memsize</span> <span class="o">-</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_used</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">size_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">.</span><span class="n">offset_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">viasamm</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_TURN_ON_OUTPUT_DEVICE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpu32</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpu32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpu32</span> <span class="o">&amp;</span> <span class="n">CRT_Device</span><span class="p">)</span>
			<span class="n">via_set_state</span><span class="p">(</span><span class="n">VIA_CRT</span><span class="p">,</span> <span class="n">VIA_STATE_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpu32</span> <span class="o">&amp;</span> <span class="n">DVI_Device</span><span class="p">)</span>
			<span class="n">viafb_dvi_enable</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpu32</span> <span class="o">&amp;</span> <span class="n">LCD_Device</span><span class="p">)</span>
			<span class="n">viafb_lcd_enable</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_TURN_OFF_OUTPUT_DEVICE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpu32</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpu32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpu32</span> <span class="o">&amp;</span> <span class="n">CRT_Device</span><span class="p">)</span>
			<span class="n">via_set_state</span><span class="p">(</span><span class="n">VIA_CRT</span><span class="p">,</span> <span class="n">VIA_STATE_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpu32</span> <span class="o">&amp;</span> <span class="n">DVI_Device</span><span class="p">)</span>
			<span class="n">viafb_dvi_disable</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpu32</span> <span class="o">&amp;</span> <span class="n">LCD_Device</span><span class="p">)</span>
			<span class="n">viafb_lcd_disable</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_DEVICE</span>:
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">crt</span> <span class="o">=</span> <span class="n">viafb_CRT_ON</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">dvi</span> <span class="o">=</span> <span class="n">viafb_DVI_ON</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">lcd</span> <span class="o">=</span> <span class="n">viafb_LCD_ON</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">samm</span> <span class="o">=</span> <span class="n">viafb_SAMM_ON</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">primary_dev</span> <span class="o">=</span> <span class="n">viafb_primary_dev</span><span class="p">;</span>

		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">lcd_dsp_cent</span> <span class="o">=</span> <span class="n">viafb_lcd_dsp_method</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">lcd_panel_id</span> <span class="o">=</span> <span class="n">viafb_lcd_panel_id</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">lcd_mode</span> <span class="o">=</span> <span class="n">viafb_lcd_mode</span><span class="p">;</span>

		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">viafb_hotplug_Xres</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">viafb_hotplug_Yres</span><span class="p">;</span>

		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">xres1</span> <span class="o">=</span> <span class="n">viafb_second_xres</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">yres1</span> <span class="o">=</span> <span class="n">viafb_second_yres</span><span class="p">;</span>

		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">viafb_bpp</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">bpp1</span> <span class="o">=</span> <span class="n">viafb_bpp1</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">refresh</span> <span class="o">=</span> <span class="n">viafb_refresh</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">refresh1</span> <span class="o">=</span> <span class="n">viafb_refresh1</span><span class="p">;</span>

		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">epia_dvi</span> <span class="o">=</span> <span class="n">viafb_platform_epia_dvi</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">lcd_dual_edge</span> <span class="o">=</span> <span class="n">viafb_device_lcd_dualedge</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">.</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">viafb_bus_width</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">active_dev</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_DRIVER_VERSION</span>:
		<span class="n">u</span><span class="p">.</span><span class="n">driver_version</span><span class="p">.</span><span class="n">iMajorNum</span> <span class="o">=</span> <span class="n">VERSION_MAJOR</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">driver_version</span><span class="p">.</span><span class="n">iKernelNum</span> <span class="o">=</span> <span class="n">VERSION_KERNEL</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">driver_version</span><span class="p">.</span><span class="n">iOSNum</span> <span class="o">=</span> <span class="n">VERSION_OS</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">driver_version</span><span class="p">.</span><span class="n">iMinorNum</span> <span class="o">=</span> <span class="n">VERSION_MINOR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">driver_version</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">driver_version</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_DEVICE_INFO</span>:

		<span class="n">retrieve_device_setting</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">viafb_setting</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">viafb_setting</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">viafb_setting</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_DEVICE_SUPPORT</span>:
		<span class="n">viafb_get_device_support_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_DEVICE_CONNECT</span>:
		<span class="n">viafb_get_device_connect_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_PANEL_SUPPORT_EXPAND</span>:
		<span class="n">state_info</span> <span class="o">=</span>
		    <span class="n">viafb_lcd_get_support_expand_state</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span>
						 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_DRIVER_NAME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">driver_name</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_SET_GAMMA_LUT</span>:
		<span class="n">viafb_gamma_table</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">viafb_gamma_table</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">viafb_gamma_table</span><span class="p">);</span>
		<span class="n">viafb_set_gamma_table</span><span class="p">(</span><span class="n">viafb_bpp</span><span class="p">,</span> <span class="n">viafb_gamma_table</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">viafb_gamma_table</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_GAMMA_LUT</span>:
		<span class="n">viafb_gamma_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafb_gamma_table</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">viafb_get_gamma_table</span><span class="p">(</span><span class="n">viafb_gamma_table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">viafb_gamma_table</span><span class="p">,</span>
			<span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">viafb_gamma_table</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">viafb_gamma_table</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_GAMMA_SUPPORT_STATE</span>:
		<span class="n">viafb_get_gamma_support_state</span><span class="p">(</span><span class="n">viafb_bpp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">state_info</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_SYNC_SURFACE</span>:
		<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;lobo VIAFB_SYNC_SURFACE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_DRIVER_CAPS</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_PANEL_MAX_SIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_PANEL_MAX_POSITION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_GET_PANEL_POSITION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_GET_PANEL_SIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIAFB_SET_PANEL_POSITION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VIAFB_SET_PANEL_SIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">panel_pos_size_para</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viapar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">viafb_shared</span> <span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fg_color</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span> <span class="o">||</span> <span class="o">!</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">hw_bitblt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span>
		<span class="n">fg_color</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">fg_color</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_XOR</span><span class="p">)</span>
		<span class="n">rop</span> <span class="o">=</span> <span class="mh">0x5A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rop</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;viafb 2D engine: fillrect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">hw_bitblt</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_mmio</span><span class="p">,</span> <span class="n">VIA_BITBLT_FILL</span><span class="p">,</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
		<span class="n">viapar</span><span class="o">-&gt;</span><span class="n">vram_addr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rop</span><span class="p">))</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viapar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">viafb_shared</span> <span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span> <span class="o">||</span> <span class="o">!</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">hw_bitblt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;viafb 2D engine: copyarea</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">hw_bitblt</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_mmio</span><span class="p">,</span> <span class="n">VIA_BITBLT_COLOR</span><span class="p">,</span>
		<span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
		<span class="n">viapar</span><span class="o">-&gt;</span><span class="n">vram_addr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">vram_addr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span>
		<span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viapar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">viafb_shared</span> <span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fg_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bg_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span> <span class="o">||</span> <span class="o">!</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">hw_bitblt</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">VIA_BITBLT_MONO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fg_color</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">];</span>
			<span class="n">bg_color</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fg_color</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">;</span>
			<span class="n">bg_color</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">VIA_BITBLT_COLOR</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;viafb 2D engine: imageblit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">hw_bitblt</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_mmio</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
		<span class="n">viapar</span><span class="o">-&gt;</span><span class="n">vram_addr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">,</span> <span class="n">bg_color</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_cursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="n">viapar</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">bg_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fg_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">chip_name</span> <span class="o">=</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">.</span><span class="n">gfx_chip_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span> <span class="o">||</span> <span class="n">info</span> <span class="o">!=</span> <span class="n">viafbinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* LCD ouput does not support hw cursors (at least on VN896) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip_name</span> <span class="o">==</span> <span class="n">UNICHROME_CLE266</span> <span class="o">&amp;&amp;</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA2</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">viafb_LCD_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">viafb_show_hw_cursor</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">HW_Cursor_OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">hot</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">hot</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">engine</span> <span class="o">+</span> <span class="n">VIA_REG_CURSOR_ORG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETPOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">yy</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dy</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">;</span>
		<span class="n">xx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dx</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">xx</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">engine</span> <span class="o">+</span> <span class="n">VIA_REG_CURSOR_POS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">cur_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">cur_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;viafb_cursor: The cursor is too large &quot;</span>
			<span class="s">&quot;%dx%d&quot;</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">engine</span> <span class="o">+</span> <span class="n">VIA_REG_CURSOR_MODE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">engine</span> <span class="o">+</span> <span class="n">VIA_REG_CURSOR_MODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETCMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fg_color</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">bg_color</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_name</span> <span class="o">==</span> <span class="n">UNICHROME_CX700</span> <span class="o">||</span>
			<span class="n">chip_name</span> <span class="o">==</span> <span class="n">UNICHROME_VX800</span> <span class="o">||</span>
			<span class="n">chip_name</span> <span class="o">==</span> <span class="n">UNICHROME_VX855</span> <span class="o">||</span>
			<span class="n">chip_name</span> <span class="o">==</span> <span class="n">UNICHROME_VX900</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fg_color</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">fg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">fg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">fg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">bg_color</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">bg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">bg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">bg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fg_color</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">fg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">fg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">fg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">bg_color</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">bg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">bg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">bg_color</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">engine</span> <span class="o">+</span> <span class="n">VIA_REG_CURSOR_BG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fg_color</span><span class="p">,</span> <span class="n">engine</span> <span class="o">+</span> <span class="n">VIA_REG_CURSOR_FG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETSHAPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="n">CURSOR_SIZE</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">bak</span><span class="p">[</span><span class="n">CURSOR_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>
		<span class="p">}</span> <span class="o">*</span><span class="n">cr_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cr_data</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cr_data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">CURSOR_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">CURSOR_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROP_XOR</span>:
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROP_COPY</span>:

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">viapar</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span>
			<span class="n">cursor_vram_addr</span><span class="p">,</span> <span class="n">cr_data</span><span class="o">-&gt;</span><span class="n">bak</span><span class="p">,</span> <span class="n">CURSOR_SIZE</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cr_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">viafb_show_hw_cursor</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">HW_Cursor_ON</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">))</span>
		<span class="n">viafb_wait_engine_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_primary_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">primary_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Rule: device on iga1 path are the primary device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_SAMM_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">viafb_CRT_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_devices</span> <span class="o">&amp;</span> <span class="n">VIA_CRT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CRT IGA Path:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IGA1</span><span class="p">);</span>
				<span class="n">primary_device</span> <span class="o">=</span> <span class="n">CRT_Device</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">viafb_DVI_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">tmds_setting_info</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DVI IGA Path:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">viaparinfo</span><span class="o">-&gt;</span>
					<span class="n">tmds_setting_info</span><span class="o">-&gt;</span><span class="n">iga_path</span><span class="p">);</span>
				<span class="n">primary_device</span> <span class="o">=</span> <span class="n">DVI_Device</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">viafb_LCD_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LCD IGA Path:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">viaparinfo</span><span class="o">-&gt;</span>
					<span class="n">lvds_setting_info</span><span class="o">-&gt;</span><span class="n">iga_path</span><span class="p">);</span>
				<span class="n">primary_device</span> <span class="o">=</span> <span class="n">LCD_Device</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">viafb_LCD2_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info2</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">==</span> <span class="n">IGA1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LCD2 IGA Path:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">viaparinfo</span><span class="o">-&gt;</span>
					<span class="n">lvds_setting_info2</span><span class="o">-&gt;</span><span class="n">iga_path</span><span class="p">);</span>
				<span class="n">primary_device</span> <span class="o">=</span> <span class="n">LCD2_Device</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">primary_device</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">retrieve_device_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_ioctl_setting</span>
	<span class="o">*</span><span class="n">setting_info</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* get device status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_CRT_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">device_status</span> <span class="o">=</span> <span class="n">CRT_Device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_DVI_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">device_status</span> <span class="o">|=</span> <span class="n">DVI_Device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_LCD_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">device_status</span> <span class="o">|=</span> <span class="n">LCD_Device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_LCD2_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">device_status</span> <span class="o">|=</span> <span class="n">LCD2_Device</span><span class="p">;</span>

	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">samm_status</span> <span class="o">=</span> <span class="n">viafb_SAMM_ON</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">primary_device</span> <span class="o">=</span> <span class="n">get_primary_device</span><span class="p">();</span>

	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">first_dev_bpp</span> <span class="o">=</span> <span class="n">viafb_bpp</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">second_dev_bpp</span> <span class="o">=</span> <span class="n">viafb_bpp1</span><span class="p">;</span>

	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">first_dev_refresh</span> <span class="o">=</span> <span class="n">viafb_refresh</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">second_dev_refresh</span> <span class="o">=</span> <span class="n">viafb_refresh1</span><span class="p">;</span>

	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">first_dev_hor_res</span> <span class="o">=</span> <span class="n">viafb_hotplug_Xres</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">first_dev_ver_res</span> <span class="o">=</span> <span class="n">viafb_hotplug_Yres</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">second_dev_hor_res</span> <span class="o">=</span> <span class="n">viafb_second_xres</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">second_dev_ver_res</span> <span class="o">=</span> <span class="n">viafb_second_yres</span><span class="p">;</span>

	<span class="cm">/* Get lcd attributes */</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">lcd_attributes</span><span class="p">.</span><span class="n">display_center</span> <span class="o">=</span> <span class="n">viafb_lcd_dsp_method</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">lcd_attributes</span><span class="p">.</span><span class="n">panel_id</span> <span class="o">=</span> <span class="n">viafb_lcd_panel_id</span><span class="p">;</span>
	<span class="n">setting_info</span><span class="o">-&gt;</span><span class="n">lcd_attributes</span><span class="p">.</span><span class="n">lcd_mode</span> <span class="o">=</span> <span class="n">viafb_lcd_mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_active_dev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">viafb_CRT_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
	<span class="n">viafb_DVI_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
	<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
	<span class="n">viafb_LCD2_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
	<span class="cm">/* 1. Modify the active status of devices. */</span>
	<span class="cm">/* 2. Keep the order of devices, so we can set corresponding</span>
<span class="cm">	   IGA path to devices in SAMM case. */</span>
	<span class="cm">/*    Note: The previous of active_dev is primary device,</span>
<span class="cm">	   and the following is secondary device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafb_active_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_olpc</span><span class="p">())</span> <span class="p">{</span> <span class="cm">/* LCD only */</span>
			<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
			<span class="n">viafb_SAMM_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">viafb_CRT_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
			<span class="n">viafb_SAMM_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;CRT+DVI&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* CRT+DVI */</span>
		<span class="n">viafb_CRT_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_DVI_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">CRT_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;DVI+CRT&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DVI+CRT */</span>
		<span class="n">viafb_CRT_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_DVI_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">DVI_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;CRT+LCD&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* CRT+LCD */</span>
		<span class="n">viafb_CRT_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">CRT_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;LCD+CRT&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* LCD+CRT */</span>
		<span class="n">viafb_CRT_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">LCD_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;DVI+LCD&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DVI+LCD */</span>
		<span class="n">viafb_DVI_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">DVI_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;LCD+DVI&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* LCD+DVI */</span>
		<span class="n">viafb_DVI_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">LCD_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;LCD+LCD2&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_LCD2_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">LCD_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;LCD2+LCD&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_LCD2_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_primary_dev</span> <span class="o">=</span> <span class="n">LCD2_Device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;CRT&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* CRT only */</span>
		<span class="n">viafb_CRT_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_SAMM_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;DVI&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DVI only */</span>
		<span class="n">viafb_DVI_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_SAMM_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;LCD&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* LCD only */</span>
		<span class="n">viafb_LCD_ON</span> <span class="o">=</span> <span class="n">STATE_ON</span><span class="p">;</span>
		<span class="n">viafb_SAMM_ON</span> <span class="o">=</span> <span class="n">STATE_OFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parse_port</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opt_str</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">output_interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt_str</span><span class="p">,</span> <span class="s">&quot;DVP0&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="o">*</span><span class="n">output_interface</span> <span class="o">=</span> <span class="n">INTERFACE_DVP0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt_str</span><span class="p">,</span> <span class="s">&quot;DVP1&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="o">*</span><span class="n">output_interface</span> <span class="o">=</span> <span class="n">INTERFACE_DVP1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt_str</span><span class="p">,</span> <span class="s">&quot;DFP_HIGHLOW&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
		<span class="o">*</span><span class="n">output_interface</span> <span class="o">=</span> <span class="n">INTERFACE_DFP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt_str</span><span class="p">,</span> <span class="s">&quot;DFP_HIGH&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="o">*</span><span class="n">output_interface</span> <span class="o">=</span> <span class="n">INTERFACE_DFP_HIGH</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt_str</span><span class="p">,</span> <span class="s">&quot;DFP_LOW&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
		<span class="o">*</span><span class="n">output_interface</span> <span class="o">=</span> <span class="n">INTERFACE_DFP_LOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">output_interface</span> <span class="o">=</span> <span class="n">INTERFACE_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">parse_lcd_port</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">parse_port</span><span class="p">(</span><span class="n">viafb_lcd_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">.</span>
		<span class="n">output_interface</span><span class="p">);</span>
	<span class="cm">/*Initialize to avoid unexpected behavior */</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info2</span><span class="p">.</span><span class="n">output_interface</span> <span class="o">=</span>
	<span class="n">INTERFACE_NONE</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parse_lcd_port: viafb_lcd_port:%s,interface:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">viafb_lcd_port</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">.</span>
		  <span class="n">output_interface</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">parse_dvi_port</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">parse_port</span><span class="p">(</span><span class="n">viafb_dvi_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">tmds_chip_info</span><span class="p">.</span>
		<span class="n">output_interface</span><span class="p">);</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parse_dvi_port: viafb_dvi_port:%s,interface:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">viafb_dvi_port</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">tmds_chip_info</span><span class="p">.</span>
		  <span class="n">output_interface</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_VIA_DIRECT_PROCFS</span>

<span class="cm">/*</span>
<span class="cm"> * The proc filesystem read/write function, a simple proc implement to</span>
<span class="cm"> * get/set the value of DPA  DVP0,   DVP0DataDriving,  DVP0ClockDriving, DVP1,</span>
<span class="cm"> * DVP1Driving, DFPHigh, DFPLow CR96,   SR2A[5], SR1B[1], SR2A[4], SR1E[2],</span>
<span class="cm"> * CR9B,    SR65,    CR97,    CR99</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dvp0_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dvp0_data_dri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dvp0_clk_dri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dvp0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dvp0_data_dri</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIASR</span><span class="p">,</span> <span class="n">SR2A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT5</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIASR</span><span class="p">,</span> <span class="n">SR1B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dvp0_clk_dri</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIASR</span><span class="p">,</span> <span class="n">SR2A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIASR</span><span class="p">,</span> <span class="n">SR1E</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dvp0</span> <span class="o">=</span> <span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIACR</span><span class="p">,</span> <span class="n">CR96</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dvp0</span><span class="p">,</span> <span class="n">dvp0_data_dri</span><span class="p">,</span> <span class="n">dvp0_clk_dri</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dvp0_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_dvp0_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">viafb_dvp0_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">?</span> <span class="mi">20</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/*Ensure end string */</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbuf</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DVP0:reg_val[%l]=:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				  <span class="n">reg_val</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">CR96</span><span class="p">,</span> <span class="n">VIACR</span><span class="p">,</span>
					<span class="n">reg_val</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">SR2A</span><span class="p">,</span> <span class="n">VIASR</span><span class="p">,</span>
					<span class="n">reg_val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">BIT5</span><span class="p">);</span>
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">SR1B</span><span class="p">,</span> <span class="n">VIASR</span><span class="p">,</span>
					<span class="n">reg_val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BIT1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">SR2A</span><span class="p">,</span> <span class="n">VIASR</span><span class="p">,</span>
					<span class="n">reg_val</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">BIT4</span><span class="p">);</span>
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">SR1E</span><span class="p">,</span> <span class="n">VIASR</span><span class="p">,</span>
					<span class="n">reg_val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">BIT2</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_dvp0_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_dvp0_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">viafb_dvp0_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dvp1_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dvp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dvp1_data_dri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dvp1_clk_dri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dvp1</span> <span class="o">=</span> <span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIACR</span><span class="p">,</span> <span class="n">CR9B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">dvp1_data_dri</span> <span class="o">=</span> <span class="p">(</span><span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIASR</span><span class="p">,</span> <span class="n">SR65</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dvp1_clk_dri</span> <span class="o">=</span> <span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIASR</span><span class="p">,</span> <span class="n">SR65</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dvp1</span><span class="p">,</span> <span class="n">dvp1_data_dri</span><span class="p">,</span> <span class="n">dvp1_clk_dri</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dvp1_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_dvp1_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">viafb_dvp1_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">?</span> <span class="mi">20</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/*Ensure end string */</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbuf</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">CR9B</span><span class="p">,</span> <span class="n">VIACR</span><span class="p">,</span>
					<span class="n">reg_val</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">SR65</span><span class="p">,</span> <span class="n">VIASR</span><span class="p">,</span>
					<span class="n">reg_val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">SR65</span><span class="p">,</span> <span class="n">VIASR</span><span class="p">,</span>
					<span class="n">reg_val</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_dvp1_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_dvp1_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">viafb_dvp1_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dfph_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dfp_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dfp_high</span> <span class="o">=</span> <span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIACR</span><span class="p">,</span> <span class="n">CR97</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dfp_high</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dfph_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_dfph_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">viafb_dfph_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtou8_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">CR97</span><span class="p">,</span> <span class="n">VIACR</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_dfph_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_dfph_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">viafb_dfph_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dfpl_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dfp_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dfp_low</span> <span class="o">=</span> <span class="n">viafb_read_reg</span><span class="p">(</span><span class="n">VIACR</span><span class="p">,</span> <span class="n">CR99</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dfp_low</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_dfpl_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_dfpl_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">viafb_dfpl_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtou8_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">viafb_write_reg_mask</span><span class="p">(</span><span class="n">CR99</span><span class="p">,</span> <span class="n">VIACR</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_dfpl_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_dfpl_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">viafb_dfpl_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_vt1636_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">vt1636_08</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vt1636_09</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">.</span><span class="n">lvds_chip_name</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VT1636_LVDS</span>:
		<span class="n">vt1636_08</span> <span class="o">=</span>
		    <span class="n">viafb_gpio_i2c_read_lvds</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">vt1636_09</span> <span class="o">=</span>
		    <span class="n">viafb_gpio_i2c_read_lvds</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vt1636_08</span><span class="p">,</span> <span class="n">vt1636_09</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info2</span><span class="p">.</span><span class="n">lvds_chip_name</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VT1636_LVDS</span>:
		<span class="n">vt1636_08</span> <span class="o">=</span>
		    <span class="n">viafb_gpio_i2c_read_lvds</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info2</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info2</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">vt1636_09</span> <span class="o">=</span>
		    <span class="n">viafb_gpio_i2c_read_lvds</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info2</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info2</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vt1636_08</span><span class="p">,</span> <span class="n">vt1636_09</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_vt1636_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_vt1636_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">viafb_vt1636_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IODATA</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">30</span> <span class="o">?</span> <span class="mi">30</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/*Ensure end string */</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">.</span><span class="n">lvds_chip_name</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VT1636_LVDS</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbuf</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">.</span><span class="n">Data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Index</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Mask</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
					<span class="n">viafb_gpio_i2c_write_mask_lvds</span>
					    <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span>
					    <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">,</span>
					     <span class="n">reg_val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Index</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
					<span class="n">viafb_gpio_i2c_write_mask_lvds</span>
					    <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span>
					    <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info</span><span class="p">,</span>
					     <span class="n">reg_val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info2</span><span class="p">.</span><span class="n">lvds_chip_name</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VT1636_LVDS</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbuf</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">kstrtou8</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">.</span><span class="n">Data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Index</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Mask</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
					<span class="n">viafb_gpio_i2c_write_mask_lvds</span>
					    <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info2</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span>
					    <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info2</span><span class="p">,</span>
					     <span class="n">reg_val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Index</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
					<span class="n">reg_val</span><span class="p">.</span><span class="n">Mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
					<span class="n">viafb_gpio_i2c_write_mask_lvds</span>
					    <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info2</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span>
					    <span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">lvds_chip_info2</span><span class="p">,</span>
					     <span class="n">reg_val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_vt1636_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_vt1636_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">viafb_vt1636_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_VIA_DIRECT_PROCFS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_sup_odev_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">via_odev_to_seq</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">supported_odev_map</span><span class="p">[</span>
		<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">.</span><span class="n">gfx_chip_name</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_sup_odev_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_sup_odev_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_sup_odev_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_sup_odev_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">odev_update</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">odev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devices</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">add</span><span class="p">,</span> <span class="n">sub</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">add</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">;</span>
	<span class="n">sub</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add</span> <span class="o">||</span> <span class="n">sub</span><span class="p">)</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">devices</span> <span class="o">=</span> <span class="n">via_parse_odev</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add</span><span class="p">)</span>
		<span class="o">*</span><span class="n">odev</span> <span class="o">|=</span> <span class="n">devices</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span>
		<span class="o">*</span><span class="n">odev</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">devices</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">odev</span> <span class="o">=</span> <span class="n">devices</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_iga1_odev_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">via_odev_to_seq</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_devices</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_iga1_odev_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_iga1_odev_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">viafb_iga1_odev_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dev_on</span><span class="p">,</span> <span class="n">dev_off</span><span class="p">,</span> <span class="n">dev_old</span><span class="p">,</span> <span class="n">dev_new</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">dev_old</span> <span class="o">=</span> <span class="n">dev_new</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_devices</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">odev_update</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">dev_off</span> <span class="o">=</span> <span class="n">dev_old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dev_new</span><span class="p">;</span>
	<span class="n">dev_on</span> <span class="o">=</span> <span class="n">dev_new</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dev_old</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_devices</span> <span class="o">=</span> <span class="n">dev_new</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga2_devices</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dev_new</span><span class="p">;</span>
	<span class="n">via_set_state</span><span class="p">(</span><span class="n">dev_off</span><span class="p">,</span> <span class="n">VIA_STATE_OFF</span><span class="p">);</span>
	<span class="n">via_set_source</span><span class="p">(</span><span class="n">dev_new</span><span class="p">,</span> <span class="n">IGA1</span><span class="p">);</span>
	<span class="n">via_set_state</span><span class="p">(</span><span class="n">dev_on</span><span class="p">,</span> <span class="n">VIA_STATE_ON</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_iga1_odev_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_iga1_odev_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">viafb_iga1_odev_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_iga2_odev_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">via_odev_to_seq</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga2_devices</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_iga2_odev_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">viafb_iga2_odev_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">viafb_iga2_odev_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dev_on</span><span class="p">,</span> <span class="n">dev_off</span><span class="p">,</span> <span class="n">dev_old</span><span class="p">,</span> <span class="n">dev_new</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">dev_old</span> <span class="o">=</span> <span class="n">dev_new</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga2_devices</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">odev_update</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">dev_off</span> <span class="o">=</span> <span class="n">dev_old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dev_new</span><span class="p">;</span>
	<span class="n">dev_on</span> <span class="o">=</span> <span class="n">dev_new</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dev_old</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga2_devices</span> <span class="o">=</span> <span class="n">dev_new</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_devices</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dev_new</span><span class="p">;</span>
	<span class="n">via_set_state</span><span class="p">(</span><span class="n">dev_off</span><span class="p">,</span> <span class="n">VIA_STATE_OFF</span><span class="p">);</span>
	<span class="n">via_set_source</span><span class="p">(</span><span class="n">dev_new</span><span class="p">,</span> <span class="n">IGA2</span><span class="p">);</span>
	<span class="n">via_set_state</span><span class="p">(</span><span class="n">dev_on</span><span class="p">,</span> <span class="n">VIA_STATE_ON</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">viafb_iga2_odev_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">viafb_iga2_odev_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">viafb_iga2_odev_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IS_VT1636(lvds_chip)	((lvds_chip).lvds_chip_name == VT1636_LVDS)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_init_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_shared</span> <span class="o">*</span><span class="n">shared</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">iga1_entry</span><span class="p">,</span> <span class="o">*</span><span class="n">iga2_entry</span><span class="p">,</span>
		<span class="o">*</span><span class="n">viafb_entry</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;viafb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">shared</span><span class="o">-&gt;</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="n">viafb_entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_entry</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_FB_VIA_DIRECT_PROCFS</span>
		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;dvp0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_dvp0_proc_fops</span><span class="p">);</span>
		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;dvp1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_dvp1_proc_fops</span><span class="p">);</span>
		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;dfph&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_dfph_proc_fops</span><span class="p">);</span>
		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;dfpl&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_dfpl_proc_fops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_VT1636</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">.</span><span class="n">lvds_chip_info</span><span class="p">)</span>
			<span class="o">||</span> <span class="n">IS_VT1636</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">.</span><span class="n">lvds_chip_info2</span><span class="p">))</span>
			<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;vt1636&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">viafb_vt1636_proc_fops</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_VIA_DIRECT_PROCFS */</span><span class="cp"></span>

		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;supported_output_devices&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">viafb_sup_odev_proc_fops</span><span class="p">);</span>
		<span class="n">iga1_entry</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;iga1&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
		<span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_proc_entry</span> <span class="o">=</span> <span class="n">iga1_entry</span><span class="p">;</span>
		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;output_devices&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iga1_entry</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">viafb_iga1_odev_proc_fops</span><span class="p">);</span>
		<span class="n">iga2_entry</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;iga2&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
		<span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga2_proc_entry</span> <span class="o">=</span> <span class="n">iga2_entry</span><span class="p">;</span>
		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;output_devices&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iga2_entry</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">viafb_iga2_odev_proc_fops</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">viafb_remove_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_shared</span> <span class="o">*</span><span class="n">shared</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">viafb_entry</span> <span class="o">=</span> <span class="n">shared</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span>
		<span class="o">*</span><span class="n">iga1_entry</span> <span class="o">=</span> <span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_proc_entry</span><span class="p">,</span>
		<span class="o">*</span><span class="n">iga2_entry</span> <span class="o">=</span> <span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga2_proc_entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafb_entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;output_devices&quot;</span><span class="p">,</span> <span class="n">iga2_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;iga2&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;output_devices&quot;</span><span class="p">,</span> <span class="n">iga1_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;iga1&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;supported_output_devices&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_VIA_DIRECT_PROCFS</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;dvp0&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span><span class="cm">/* parent dir */</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;dvp1&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;dfph&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;dfpl&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VT1636</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">.</span><span class="n">lvds_chip_info</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">IS_VT1636</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">.</span><span class="n">lvds_chip_info2</span><span class="p">))</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;vt1636&quot;</span><span class="p">,</span> <span class="n">viafb_entry</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB_VIA_DIRECT_PROCFS */</span><span class="cp"></span>

	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;viafb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#undef IS_VT1636</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_mode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">u32</span> <span class="n">devices</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">xres</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devices</span> <span class="o">==</span> <span class="n">VIA_CRT</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">via_aux_get_preferred_mode</span><span class="p">(</span>
				<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_26</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devices</span> <span class="o">==</span> <span class="n">VIA_DVP1</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">via_aux_get_preferred_mode</span><span class="p">(</span>
				<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_31</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">xres</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
			<span class="o">*</span><span class="n">yres</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">machine_is_olpc</span><span class="p">())</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">;</span>
			<span class="o">*</span><span class="n">yres</span> <span class="o">=</span> <span class="mi">900</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
			<span class="o">*</span><span class="n">yres</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">xres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">yres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_suspend</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">viafb_sync</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">viafb_resume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_mmio</span><span class="p">)</span>
		<span class="n">viafb_reset_engine</span><span class="p">(</span><span class="n">viaparinfo</span><span class="p">);</span>
	<span class="n">viafb_set_par</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">)</span>
		<span class="n">viafb_set_par</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">viafb_pm_hooks</span> <span class="n">viafb_fb_pm_hooks</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">viafb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">viafb_resume</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">i2c_bus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_shared</span> <span class="o">*</span><span class="n">shared</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* should be always CRT */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb: Probing I2C bus 0x26</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_26</span> <span class="o">=</span> <span class="n">via_aux_probe</span><span class="p">(</span><span class="n">viafb_find_i2c_adapter</span><span class="p">(</span><span class="n">VIA_PORT_26</span><span class="p">));</span>

	<span class="cm">/* seems to be usually DVP1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb: Probing I2C bus 0x31</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_31</span> <span class="o">=</span> <span class="n">via_aux_probe</span><span class="p">(</span><span class="n">viafb_find_i2c_adapter</span><span class="p">(</span><span class="n">VIA_PORT_31</span><span class="p">));</span>

	<span class="cm">/* FIXME: what is this? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is_olpc</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb: Probing I2C bus 0x2C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_2C</span> <span class="o">=</span> <span class="n">via_aux_probe</span><span class="p">(</span><span class="n">viafb_find_i2c_adapter</span><span class="p">(</span><span class="n">VIA_PORT_2C</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb: Finished I2C bus probing&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_bus_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_shared</span> <span class="o">*</span><span class="n">shared</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">via_aux_free</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_26</span><span class="p">);</span>
	<span class="n">via_aux_free</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_31</span><span class="p">);</span>
	<span class="n">via_aux_free</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">i2c_2C</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">via_fb_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_dev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">default_xres</span><span class="p">,</span> <span class="n">default_yres</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">default_var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">viafb_par_length</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;VIAFB PCI Probe!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">default_var</span><span class="p">));</span>
	<span class="n">viafb_par_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_par</span><span class="p">),</span> <span class="n">BITS_PER_LONG</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Allocate fb_info and ***_par here, also including some other needed</span>
<span class="cm">	 * variables</span>
<span class="cm">	*/</span>
	<span class="n">viafbinfo</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="n">viafb_par_length</span> <span class="o">+</span>
		<span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_shared</span><span class="p">),</span> <span class="n">BITS_PER_LONG</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafbinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;Could not allocate memory for viafb_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">viaparinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">viafb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span> <span class="o">=</span> <span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">+</span> <span class="n">viafb_par_length</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">vram_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">tmds_setting_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">tmds_setting_info</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">lvds_setting_info</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">lvds_setting_info2</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">lvds_setting_info2</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="p">;</span>

	<span class="n">i2c_bus_probe</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">)</span>
		<span class="n">viafb_SAMM_ON</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">parse_lcd_port</span><span class="p">();</span>
	<span class="n">parse_dvi_port</span><span class="p">();</span>

	<span class="n">viafb_init_chip_info</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The framebuffer will have been successfully mapped by</span>
<span class="cm">	 * the core (or we&#39;d not be here), but we still need to</span>
<span class="cm">	 * set up our own accounting.</span>
<span class="cm">	 */</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">fbmem_start</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">memsize</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">fbmem_len</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">;</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">fbmem</span><span class="p">;</span>

	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_start</span><span class="p">;</span>
	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">engine_len</span><span class="p">;</span>
	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">viafb_ops</span><span class="p">;</span>
	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>

	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">pseudo_pal</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_accel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">viafb_setup_engine</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>
			<span class="n">FBINFO_HWACCEL_FILLRECT</span> <span class="o">|</span>  <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span><span class="p">;</span>
		<span class="n">default_var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
		<span class="n">default_var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_second_size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">viafb_second_size</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">viafb_second_offset</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">-</span>
			<span class="n">viafb_second_size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">viafb_second_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">viafb_second_offset</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">-</span>
			<span class="n">viafb_second_size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">parse_mode</span><span class="p">(</span><span class="n">viafb_mode</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga1_devices</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">default_xres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_yres</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_SAMM_ON</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">parse_mode</span><span class="p">(</span><span class="n">viafb_mode1</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">iga2_devices</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">viafb_second_xres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_second_yres</span><span class="p">);</span>

	<span class="n">default_var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">default_xres</span><span class="p">;</span>
	<span class="n">default_var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">default_yres</span><span class="p">;</span>
	<span class="n">default_var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">default_xres</span><span class="p">;</span>
	<span class="n">default_var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">default_yres</span><span class="p">;</span>
	<span class="n">default_var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">viafb_bpp</span><span class="p">;</span>
	<span class="n">viafb_fill_var_timing_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_var</span><span class="p">,</span> <span class="n">viafb_get_best_mode</span><span class="p">(</span>
		<span class="n">default_var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">default_var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">viafb_refresh</span><span class="p">));</span>
	<span class="n">viafb_setup_fixinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="p">);</span>
	<span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">viafbinfo1</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="n">viafb_par_length</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viafbinfo1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;allocate the second framebuffer struct error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_fb_release</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">viaparinfo1</span> <span class="o">=</span> <span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">viaparinfo1</span><span class="p">,</span> <span class="n">viaparinfo</span><span class="p">,</span> <span class="n">viafb_par_length</span><span class="p">);</span>
		<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">vram_addr</span> <span class="o">=</span> <span class="n">viafb_second_offset</span><span class="p">;</span>
		<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">memsize</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">memsize</span> <span class="o">-</span>
			<span class="n">viafb_second_offset</span><span class="p">;</span>
		<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">memsize</span> <span class="o">=</span> <span class="n">viafb_second_offset</span><span class="p">;</span>
		<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">fbmem</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem</span> <span class="o">+</span> <span class="n">viafb_second_offset</span><span class="p">;</span>

		<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">fbmem_used</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_used</span><span class="p">;</span>
		<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">=</span> <span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">memsize</span> <span class="o">-</span>
			<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">fbmem_used</span><span class="p">;</span>
		<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_free</span> <span class="o">=</span> <span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">memsize</span><span class="p">;</span>
		<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">fbmem_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">=</span> <span class="n">IGA1</span><span class="p">;</span>
		<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">iga_path</span> <span class="o">=</span> <span class="n">IGA2</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">,</span> <span class="n">viafbinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span><span class="p">));</span>
		<span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">viaparinfo1</span><span class="p">;</span>
		<span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span>
			<span class="n">viafb_second_offset</span><span class="p">;</span>

		<span class="n">default_var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">viafb_second_xres</span><span class="p">;</span>
		<span class="n">default_var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">viafb_second_yres</span><span class="p">;</span>
		<span class="n">default_var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">viafb_second_xres</span><span class="p">;</span>
		<span class="n">default_var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">viafb_second_yres</span><span class="p">;</span>
		<span class="n">default_var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">viafb_bpp1</span><span class="p">;</span>
		<span class="n">viafb_fill_var_timing_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_var</span><span class="p">,</span> <span class="n">viafb_get_best_mode</span><span class="p">(</span>
			<span class="n">default_var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">default_var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">viafb_refresh1</span><span class="p">));</span>

		<span class="n">viafb_setup_fixinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">,</span> <span class="n">viaparinfo1</span><span class="p">);</span>
		<span class="n">viafb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_var</span><span class="p">,</span> <span class="n">viafbinfo1</span><span class="p">);</span>
		<span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">default_var</span><span class="p">;</span>
		<span class="n">viafb_update_fix</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
		<span class="n">viaparinfo1</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">fb_get_color_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">viafbinfo1</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">viafb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">viafbinfo</span><span class="p">);</span>
	<span class="n">viafb_update_fix</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
	<span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">fb_get_color_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">);</span>
	<span class="n">default_var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fb1_release</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">viafb_primary_dev</span> <span class="o">==</span> <span class="n">LCD_Device</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">gfx_chip_name</span> <span class="o">==</span> <span class="n">UNICHROME_CLE266</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dealloc_cmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fb1_unreg_lcd_cle266</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">viafb_primary_dev</span> <span class="o">!=</span> <span class="n">LCD_Device</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">gfx_chip_name</span> <span class="o">!=</span>
			<span class="n">UNICHROME_CLE266</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_fb_unreg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device %dx%d-%dbpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">default_var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span>
		  <span class="n">default_var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">default_var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">viafb_init_proc</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">);</span>
	<span class="n">viafb_init_dac</span><span class="p">(</span><span class="n">IGA2</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">viafb_pm_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafb_fb_pm_hooks</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_fb_unreg:</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
<span class="nl">out_fb1_unreg_lcd_cle266:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">viafb_primary_dev</span> <span class="o">==</span> <span class="n">LCD_Device</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">chip_info</span><span class="o">-&gt;</span><span class="n">gfx_chip_name</span> <span class="o">==</span> <span class="n">UNICHROME_CLE266</span><span class="p">))</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
<span class="nl">out_dealloc_cmap:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">out_fb1_release:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafbinfo1</span><span class="p">)</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
<span class="nl">out_fb_release:</span>
	<span class="n">i2c_bus_free</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">via_fb_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;via_pci_remove!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viafbinfo</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">)</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
	<span class="n">viafb_remove_proc</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">);</span>
	<span class="n">i2c_bus_free</span><span class="p">(</span><span class="n">viaparinfo</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">viafbinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">)</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">viafbinfo1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">viafb_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">;</span>

	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_setup!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;viafb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_mode1=&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">viafb_mode1</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_mode=&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">viafb_mode</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_bpp1=&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtouint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_bpp1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_bpp=&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtouint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_bpp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_refresh1=&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_refresh1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_refresh=&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_refresh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_lcd_dsp_method=&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">viafb_lcd_dsp_method</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_lcd_panel_id=&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">viafb_lcd_panel_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_accel=&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_accel</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_SAMM_ON=&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_SAMM_ON</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_active_dev=&quot;</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">viafb_active_dev</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">17</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span>
			<span class="s">&quot;viafb_display_hardware_layout=&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">viafb_display_hardware_layout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_second_size=&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_second_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span>
			<span class="s">&quot;viafb_platform_epia_dvi=&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">viafb_platform_epia_dvi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span>
			<span class="s">&quot;viafb_device_lcd_dualedge=&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">viafb_device_lcd_dualedge</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_bus_width=&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_bus_width</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_lcd_mode=&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viafb_lcd_mode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_lcd_port=&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">viafb_lcd_port</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;viafb_dvi_port=&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">viafb_dvi_port</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * These are called out of via-core for now.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">viafb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dummy_x</span><span class="p">,</span> <span class="n">dummy_y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_olpc</span><span class="p">())</span>
		<span class="cm">/* Apply XO-1.5-specific configuration. */</span>
		<span class="n">viafb_lcd_panel_id</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">viafb_setup</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parse_mode</span><span class="p">(</span><span class="n">viafb_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_y</span><span class="p">)</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">viafb_get_best_mode</span><span class="p">(</span><span class="n">dummy_x</span><span class="p">,</span> <span class="n">dummy_y</span><span class="p">,</span> <span class="n">viafb_refresh</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">parse_mode</span><span class="p">(</span><span class="n">viafb_mode1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_y</span><span class="p">)</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">viafb_get_best_mode</span><span class="p">(</span><span class="n">dummy_x</span><span class="p">,</span> <span class="n">dummy_y</span><span class="p">,</span> <span class="n">viafb_refresh1</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">viafb_bpp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">viafb_bpp</span> <span class="o">&gt;</span> <span class="mi">32</span>
		<span class="o">||</span> <span class="n">viafb_bpp1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">viafb_bpp1</span> <span class="o">&gt;</span> <span class="mi">32</span>
		<span class="o">||</span> <span class="n">parse_active_dev</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
       <span class="s">&quot;VIA Graphics Integration Chipset framebuffer %d.%d initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">VERSION_MAJOR</span><span class="p">,</span> <span class="n">VERSION_MINOR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">viafb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG_MSG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;viafb_exit!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">viafb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span> <span class="o">=</span> <span class="n">viafb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span> <span class="o">=</span> <span class="n">viafb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">viafb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> <span class="o">=</span> <span class="n">viafb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="n">viafb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">viafb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span> <span class="n">viafb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">viafb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">viafb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">viafb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_cursor</span> <span class="o">=</span> <span class="n">viafb_cursor</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span> <span class="o">=</span> <span class="n">viafb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span> <span class="o">=</span> <span class="n">viafb_sync</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#ifdef MODULE</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_mode</span><span class="p">,</span> <span class="s">&quot;Set resolution (default=640x480)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_mode1</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_mode1</span><span class="p">,</span> <span class="s">&quot;Set resolution (default=640x480)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_bpp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_bpp</span><span class="p">,</span> <span class="s">&quot;Set color depth (default=32bpp)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_bpp1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_bpp1</span><span class="p">,</span> <span class="s">&quot;Set color depth (default=32bpp)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_refresh</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_refresh</span><span class="p">,</span>
	<span class="s">&quot;Set CRT viafb_refresh rate (default = 60)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_refresh1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_refresh1</span><span class="p">,</span>
	<span class="s">&quot;Set CRT refresh rate (default = 60)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_lcd_panel_id</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_lcd_panel_id</span><span class="p">,</span>
	<span class="s">&quot;Set Flat Panel type(Default=1024x768)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_lcd_dsp_method</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_lcd_dsp_method</span><span class="p">,</span>
	<span class="s">&quot;Set Flat Panel display scaling method.(Default=Expandsion)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_SAMM_ON</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_SAMM_ON</span><span class="p">,</span>
	<span class="s">&quot;Turn on/off flag of SAMM(Default=OFF)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_accel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_accel</span><span class="p">,</span>
	<span class="s">&quot;Set 2D Hardware Acceleration: 0 = OFF, 1 = ON (default)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_active_dev</span><span class="p">,</span> <span class="s">&quot;Specify active devices.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_display_hardware_layout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_display_hardware_layout</span><span class="p">,</span>
	<span class="s">&quot;Display Hardware Layout (LCD Only, DVI Only...,etc)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_second_size</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_second_size</span><span class="p">,</span>
	<span class="s">&quot;Set secondary device memory size&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_dual_fb</span><span class="p">,</span>
	<span class="s">&quot;Turn on/off flag of dual framebuffer devices.(Default = OFF)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_platform_epia_dvi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_platform_epia_dvi</span><span class="p">,</span>
	<span class="s">&quot;Turn on/off flag of DVI devices on EPIA board.(Default = OFF)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_device_lcd_dualedge</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_device_lcd_dualedge</span><span class="p">,</span>
	<span class="s">&quot;Turn on/off flag of dual edge panel.(Default = OFF)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_bus_width</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_bus_width</span><span class="p">,</span>
	<span class="s">&quot;Set bus width of panel.(Default = 12)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_lcd_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_lcd_mode</span><span class="p">,</span>
	<span class="s">&quot;Set Flat Panel mode(Default=OPENLDI)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_lcd_port</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_lcd_port</span><span class="p">,</span> <span class="s">&quot;Specify LCD output port.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">viafb_dvi_port</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">viafb_dvi_port</span><span class="p">,</span> <span class="s">&quot;Specify DVI output port.&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
