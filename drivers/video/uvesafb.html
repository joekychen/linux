<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › uvesafb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>uvesafb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * A framebuffer driver for VBE 2.0+ compliant video cards</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2007 Michal Januszewski &lt;spock@gentoo.org&gt;</span>
<span class="cm"> *     Loosely based upon the vesafb driver.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/connector.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/limits.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;video/edid.h&gt;</span>
<span class="cp">#include &lt;video/uvesafb.h&gt;</span>
<span class="cp">#ifdef CONFIG_X86</span>
<span class="cp">#include &lt;video/vga.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &quot;edid.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cb_id</span> <span class="n">uvesafb_cn_id</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">CN_IDX_V86D</span><span class="p">,</span>
	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">CN_VAL_V86D_UVESAFB</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">v86d_path</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;/sbin/v86d&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">v86d_started</span><span class="p">;</span>	<span class="cm">/* has v86d been started by uvesafb? */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">uvesafb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="s">&quot;VESA VGA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mtrr</span>		<span class="n">__devinitdata</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* enable mtrr by default */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">blank</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		   <span class="cm">/* enable blanking by default */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ypan</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 		 <span class="cm">/* 0: scroll, 1: ypan, 2: ywrap */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">pmi_setpal</span>	<span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* use PMI for palette changes */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nocrtc</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* ignore CRTC settings */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">noedid</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* don&#39;t try DDC transfers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vram_remap</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* set amt. of memory to be used */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vram_total</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* set total amount of memory */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">maxclk</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* maximum pixel clock */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">maxvf</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* maximum vertical frequency */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">maxhf</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* maximum horizontal frequency */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">vbemode</span>	<span class="n">__devinitdata</span><span class="p">;</span> <span class="cm">/* force use of a specific VBE mode */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>  <span class="n">dac_width</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">uvfb_tasks</span><span class="p">[</span><span class="n">UVESAFB_TASKS_MAX</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">uvfb_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * A handler for replies from userspace.</span>
<span class="cm"> *</span>
<span class="cm"> * Make sure each message passes consistency checks and if it does,</span>
<span class="cm"> * find the kernel part of the task struct, copy the registers and</span>
<span class="cm"> * the buffer contents and then complete the task.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvesafb_cn_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netlink_skb_parms</span> <span class="o">*</span><span class="n">nsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_task</span> <span class="o">*</span><span class="n">utask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&gt;=</span> <span class="n">UVESAFB_TASKS_MAX</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">uvfb_tasks</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span> <span class="o">||</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">!=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">utask</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_task</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Sanity checks for the buffer length. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">utask</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">||</span>
	    <span class="n">utask</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">utask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uvfb_tasks</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">,</span> <span class="n">utask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">utask</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">utask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_helper_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;HOME=/&quot;</span><span class="p">,</span>
		<span class="s">&quot;PATH=/sbin:/bin&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">v86d_path</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">call_usermodehelper</span><span class="p">(</span><span class="n">v86d_path</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">,</span> <span class="n">UMH_WAIT_PROC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Execute a uvesafb task.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the task is executed successfully.</span>
<span class="cm"> *</span>
<span class="cm"> * A message sent to the userspace consists of the uvesafb_task</span>
<span class="cm"> * struct and (optionally) a buffer. The uvesafb_task struct is</span>
<span class="cm"> * a simplified version of uvesafb_ktask (its kernel counterpart)</span>
<span class="cm"> * containing only the register values, flags and the length of</span>
<span class="cm"> * the buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Each message is assigned a sequence number (increased linearly)</span>
<span class="cm"> * and a random ack number. The sequence number is used as a key</span>
<span class="cm"> * for the uvfb_tasks array which holds pointers to uvesafb_ktask</span>
<span class="cm"> * structs for all requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cn_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether the message isn&#39;t longer than the maximum</span>
<span class="cm">	 * allowed by connector.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">CONNECTOR_MAX_MSG_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: message too long (%d), &quot;</span>
			<span class="s">&quot;can&#39;t execute task</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uvesafb_cn_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="n">random32</span><span class="p">();</span>

	<span class="cm">/* uvesafb_task structure */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">));</span>

	<span class="cm">/* Buffer */</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save the message ack number so that we can find the kernel</span>
<span class="cm">	 * part of this task when a reply is received from userspace.</span>
<span class="cm">	 */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>

	<span class="cm">/* If all slots are taken -- bail out. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvfb_tasks</span><span class="p">[</span><span class="n">seq</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save a pointer to the kernel part of the task struct. */</span>
	<span class="n">uvfb_tasks</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Try to start the userspace helper if sending</span>
<span class="cm">		 * the request failed the first time.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_helper_start</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: failed to execute %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">v86d_path</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: make sure that the v86d &quot;</span>
					<span class="s">&quot;helper is installed and executable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">v86d_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cn_netlink_send</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gfp_any</span><span class="p">());</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TF_EXIT</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">UVESAFB_TIMEOUT</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>
	<span class="n">uvfb_tasks</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvfb_lock</span><span class="p">);</span>

	<span class="n">seq</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">&gt;=</span> <span class="n">UVESAFB_TASKS_MAX</span><span class="p">)</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free a uvesafb_ktask struct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvesafb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare a uvesafb_ktask struct to be used again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvesafb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">cpl</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">task</span><span class="p">));</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">cpl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate and prepare a uvesafb_ktask struct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="nf">uvesafb_prep</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">task</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">task</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvesafb_setup_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vbe_mode_ib</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bytes_per_scan_line</span> <span class="o">:</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">red_off</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">red_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">green_off</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">green_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">blue_off</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">blue_len</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">rsvd_off</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">rsvd_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_vbe_find_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">yres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x_res</span> <span class="o">-</span> <span class="n">xres</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">abs</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y_res</span> <span class="o">-</span> <span class="n">yres</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">abs</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">depth</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We have an exact match in terms of resolution</span>
<span class="cm">		 * and depth.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">d</span> <span class="o">||</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="n">depth</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
			<span class="n">match</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVESAFB_EXACT_DEPTH</span> <span class="o">&amp;&amp;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">depth</span> <span class="o">!=</span> <span class="n">depth</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVESAFB_EXACT_RES</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">match</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">uvesafb_vbe_state_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f04</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="mh">0x000f</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_BUF_RET</span> <span class="o">|</span> <span class="n">TF_BUF_ESBX</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_size</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: VBE get state call &quot;</span>
				<span class="s">&quot;failed (eax=0x%x, err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvesafb_vbe_state_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">state_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state_buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f04</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="mh">0x000f</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_size</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_BUF_ESBX</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state_buf</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: VBE state restore call &quot;</span>
				<span class="s">&quot;failed (eax=0x%x, err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_getinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f00</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_VBEIB</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vbe_ib</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_signature</span><span class="p">,</span> <span class="s">&quot;VBE2&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: Getting VBE info block failed &quot;</span>
				<span class="s">&quot;(eax=0x%x, err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">,</span>
				<span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span> <span class="o">&lt;</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: Sorry, pre-VBE 2.0 cards are &quot;</span>
				<span class="s">&quot;not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">mode_list_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: Missing mode list!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: &quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert string pointers and the mode list pointer into</span>
<span class="cm">	 * usable addresses. Print informational messages about the</span>
<span class="cm">	 * video adapter and its vendor.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_vendor_name_ptr</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, &quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_vendor_name_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_name_ptr</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, &quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_name_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_rev_ptr</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, &quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_rev_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_string_ptr</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;OEM: %s, &quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_string_ptr</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;VBE v%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_getmodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Count available modes. */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">mode_list_ptr</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vbe_mode_ib</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Get info about all available modes. */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">mode_list_ptr</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vbe_mode_ib</span> <span class="o">*</span><span class="n">mib</span><span class="p">;</span>

		<span class="n">uvesafb_reset</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f01</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_BUF_RET</span> <span class="o">|</span> <span class="n">TF_BUF_ESDI</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vbe_mode_ib</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: Getting mode info block &quot;</span>
				<span class="s">&quot;for mode 0x%x failed (eax=0x%x, err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">mode</span><span class="o">++</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mib</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">mode_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We only want modes that are supported with the current</span>
<span class="cm">		 * hardware configuration, color, graphics and that have</span>
<span class="cm">		 * support for the LFB.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">mode_attr</span> <span class="o">&amp;</span> <span class="n">VBE_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">VBE_MODE_MASK</span> <span class="o">&amp;&amp;</span>
				 <span class="n">mib</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">off</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="o">--</span><span class="p">;</span>

		<span class="n">mode</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">red_len</span> <span class="o">+</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">green_len</span> <span class="o">+</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">blue_len</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Handle 8bpp modes and modes with broken color component</span>
<span class="cm">		 * lengths.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">24</span> <span class="o">&amp;&amp;</span>
					<span class="n">mib</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Protected Mode Interface is 32-bit x86 code, so we only run it on</span>
<span class="cm"> * x86 and not x86_64.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_getpmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">uvesafb_reset</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f0a</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4f</span> <span class="o">||</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">es</span> <span class="o">&lt;</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_setpal</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">es</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
						<span class="o">+</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">edi</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_pal</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: protected mode interface info at &quot;</span>
				 <span class="s">&quot;%04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">es</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">edi</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: pmi: set display start = %p, &quot;</span>
				 <span class="s">&quot;set palette = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_start</span><span class="p">,</span>
				 <span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_pal</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: pmi: ports = &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
					<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x &quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: can&#39;t handle memory&quot;</span>
						 <span class="s">&quot; requests, pmi disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_setpal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Check whether a video mode is supported by the Video BIOS and is</span>
<span class="cm"> * compatible with the monitor limits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_is_valid_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb_validate_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uvesafb_vbe_find_mode</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
				<span class="n">UVESAFB_EXACT_RES</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_getedid</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">noedid</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span> <span class="o">&lt;</span> <span class="mh">0x0300</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f15</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span> <span class="o">||</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: VBIOS/hardware supports both &quot;</span>
				 <span class="s">&quot;DDC1 and DDC2 transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: VBIOS/hardware supports DDC2 &quot;</span>
				 <span class="s">&quot;transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: VBIOS/hardware supports DDC1 &quot;</span>
				 <span class="s">&quot;transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: VBIOS/hardware doesn&#39;t support &quot;</span>
				 <span class="s">&quot;DDC transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f15</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_BUF_RET</span> <span class="o">|</span> <span class="n">TF_BUF_ESDI</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">EDID_LENGTH</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">EDID_LENGTH</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x004f</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_edid_to_monspecs</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the maximum pixel clock wasn&#39;t specified in</span>
<span class="cm">			 * the EDID block, set it to 300 MHz.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_getmonspecs</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t get all necessary data from the EDID block,</span>
<span class="cm">	 * mark it as incompatible with the GTF and set nocrtc so</span>
<span class="cm">	 * that we always use the default BIOS refresh rate.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvesafb_vbe_getedid</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Kernel command line overrides. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxclk</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">=</span> <span class="n">maxclk</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxvf</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">maxvf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxhf</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">maxhf</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case DDC transfers are not supported, the user can provide</span>
<span class="cm">	 * monitor limits manually. Lower limits are set to &quot;safe&quot; values.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">maxclk</span> <span class="o">&amp;&amp;</span> <span class="n">maxvf</span> <span class="o">&amp;&amp;</span> <span class="n">maxhf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">29000</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;uvesafb: monitor limits: vf = %d Hz, hf = %d kHz, &quot;</span>
			<span class="s">&quot;clk = %d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: no monitor limits have been set, &quot;</span>
				 <span class="s">&quot;default refresh rate will be used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Add VBE modes to the modelist. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">vbe_mode_ib</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">vmode</span><span class="p">;</span>

		<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">var</span><span class="p">));</span>

		<span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>

		<span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_VSYNCTIMINGS</span> <span class="o">|</span> <span class="n">FB_IGNOREMON</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">fb_var_to_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var</span><span class="p">);</span>
		<span class="n">fb_add_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add valid VESA modes to our modelist. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VESA_MODEDB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvesafb_is_valid_mode</span><span class="p">((</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="p">)</span>
						<span class="o">&amp;</span><span class="n">vesa_modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">info</span><span class="p">))</span>
			<span class="n">fb_add_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vesa_modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvesafb_is_valid_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">info</span><span class="p">))</span>
			<span class="n">fb_add_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_getstatesize</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">uvesafb_reset</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the VBE state buffer size. We want all available</span>
<span class="cm">	 * hardware state data (CL = 0x0f).</span>
<span class="cm">	 */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f04</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="mh">0x000f</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: VBE state buffer size &quot;</span>
			<span class="s">&quot;cannot be determined (eax=0x%x, err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_vbe_getinfo</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_vbe_getmodes</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span> <span class="o">=</span> <span class="n">nocrtc</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_setpal</span> <span class="o">=</span> <span class="n">pmi_setpal</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">=</span> <span class="n">ypan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_setpal</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__supported_pte_mask</span> <span class="o">&amp;</span> <span class="n">_PAGE_NX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_setpal</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: NX protection is actively.&quot;</span>
				<span class="s">&quot;We have better not to use the PMI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">uvesafb_vbe_getpmi</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="cm">/* The protected mode interface is not available on non-x86. */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_setpal</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="n">uvesafb_vbe_getmonspecs</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">uvesafb_vbe_getstatesize</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

<span class="nl">out:</span>	<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_vbe_init_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_modelist</span> <span class="o">*</span><span class="n">modelist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">modeid</span><span class="p">;</span>

	<span class="cm">/* Has the user requested a specific VESA mode? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vbemode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_id</span> <span class="o">==</span> <span class="n">vbemode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">modeid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">uvesafb_setup_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">modeid</span><span class="p">]);</span>
				<span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_VSYNCTIMINGS</span> <span class="o">|</span> <span class="n">FB_IGNOREMON</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * With pixclock set to 0, the default BIOS</span>
<span class="cm">				 * timings will be used in set_par().</span>
<span class="cm">				 */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">gotmode</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: requested VBE mode 0x%x is &quot;</span>
				 <span class="s">&quot;unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vbemode</span><span class="p">);</span>
		<span class="n">vbemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Count the modes in the modelist */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">)</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert the modelist into a modedb so that we can use it with</span>
<span class="cm">	 * fb_find_mode().</span>
<span class="cm">	 */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">modelist</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_modelist</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelist</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_option</span><span class="p">)</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">UVESAFB_DEFAULT_MODE</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* fb_find_mode() failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">fb_find_best_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">modeid</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode_id</span><span class="p">;</span>
			<span class="n">uvesafb_setup_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">modeid</span><span class="p">]);</span>
			<span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_VSYNCTIMINGS</span> <span class="o">|</span> <span class="n">FB_IGNOREMON</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">gotmode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Look for a matching VBE mode. */</span>
	<span class="n">modeid</span> <span class="o">=</span> <span class="n">uvesafb_vbe_find_mode</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="n">UVESAFB_EXACT_RES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modeid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">uvesafb_setup_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">modeid</span><span class="p">]);</span>

<span class="nl">gotmode:</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we are not VBE3.0+ compliant, we&#39;re done -- the BIOS will</span>
<span class="cm">	 * ignore our timings anyway.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span> <span class="o">&lt;</span> <span class="mh">0x0300</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span><span class="p">)</span>
		<span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_VSYNCTIMINGS</span> <span class="o">|</span> <span class="n">FB_IGNOREMON</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">modeid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_setpalette</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_pal_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mode_idx</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We support palette modifications for 8 bpp modes only, so</span>
<span class="cm">	 * there can never be more than 256 entries.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86</span>
	<span class="cm">/* Use VGA registers if mode is VGA-compatible. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span> <span class="o">&amp;&amp;</span>
	    <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_attr</span> <span class="o">&amp;</span> <span class="n">VBE_MODE_VGACOMPAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>        <span class="n">dac_reg</span><span class="p">);</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">red</span><span class="p">,</span>   <span class="n">dac_val</span><span class="p">);</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">green</span><span class="p">,</span> <span class="n">dac_val</span><span class="p">);</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blue</span><span class="p">,</span>  <span class="n">dac_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_setpal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;call *(%%esi)&quot;</span>
		<span class="o">:</span> <span class="cm">/* no return value */</span>
		<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="mh">0x4f09</span><span class="p">),</span>         <span class="cm">/* EAX */</span>
		  <span class="s">&quot;b&quot;</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span>              <span class="cm">/* EBX */</span>
		  <span class="s">&quot;c&quot;</span> <span class="p">(</span><span class="n">count</span><span class="p">),</span>          <span class="cm">/* ECX */</span>
		  <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">start</span><span class="p">),</span>          <span class="cm">/* EDX */</span>
		  <span class="s">&quot;D&quot;</span> <span class="p">(</span><span class="n">entries</span><span class="p">),</span>        <span class="cm">/* EDI */</span>
		  <span class="s">&quot;S&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_pal</span><span class="p">));</span> <span class="cm">/* ESI */</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>
	<span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86 */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f09</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_BUF_ESDI</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_pal_entry</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_pal_entry</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">dac_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="p">.</span><span class="n">red</span>   <span class="o">=</span> <span class="n">red</span>   <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="n">entry</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="n">entry</span><span class="p">.</span><span class="n">blue</span>  <span class="o">=</span> <span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="n">entry</span><span class="p">.</span><span class="n">pad</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_setpalette</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 1:5:5:5 */</span>
				<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
						<span class="p">((</span><span class="n">red</span>   <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">((</span><span class="n">blue</span>  <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* 0:5:6:5 */</span>
				<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
						<span class="p">((</span><span class="n">red</span>   <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span>      <span class="p">)</span> <span class="o">|</span>
						<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">((</span><span class="n">blue</span>  <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">red</span>   <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">blue</span>  <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">red</span>   <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>   <span class="o">|</span>
				<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">blue</span>  <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_setcmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_cmap</span> <span class="o">*</span><span class="n">cmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_pal_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">dac_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">||</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">entries</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)</span> <span class="o">*</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">red</span>   <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">green</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blue</span>  <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pad</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_setpalette</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For modes with bpp &gt; 8, we only set the pseudo palette in</span>
<span class="cm">		 * the fb_info struct. We rely on uvesafb_setcolreg to do all</span>
<span class="cm">		 * sanity checking.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">uvesafb_setcolreg</span><span class="p">(</span><span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">cmap</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It turns out it&#39;s not the best idea to do panning via vm86,</span>
<span class="cm">	 * so we only allow it if we have a PMI.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
			<span class="s">&quot;call *(%%edi)&quot;</span>
			<span class="o">:</span> <span class="cm">/* no return value */</span>
			<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="mh">0x4f07</span><span class="p">),</span>         <span class="cm">/* EAX */</span>
			  <span class="s">&quot;b&quot;</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span>              <span class="cm">/* EBX */</span>
			  <span class="s">&quot;c&quot;</span> <span class="p">(</span><span class="n">offset</span><span class="p">),</span>         <span class="cm">/* ECX */</span>
			  <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>   <span class="cm">/* EDX */</span>
			  <span class="s">&quot;D&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pmi_start</span><span class="p">));</span>    <span class="cm">/* EDI */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">VBE_CAP_VGACOMPAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">crtc17</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blank</span> <span class="o">==</span> <span class="n">FB_BLANK_POWERDOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">crtc17</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">seq</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">crtc17</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">blank</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vga_wseq</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">seq</span> <span class="o">|=</span> <span class="n">vga_rseq</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>

		<span class="n">crtc17</span> <span class="o">|=</span> <span class="n">vga_rcrt</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="o">--</span><span class="p">);</span>
		<span class="n">vga_wcrt</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">crtc17</span><span class="p">);</span>
		<span class="n">vga_wseq</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86 */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f10</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mh">0x0101</span><span class="p">;</span>	<span class="cm">/* standby */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mh">0x0401</span><span class="p">;</span>	<span class="cm">/* powerdown */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>		<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span>  <span class="n">uvesafb_vbe_state_save</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: save hardware state&quot;</span>
				<span class="s">&quot;failed, error code is %ld!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_orig</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* First, try to set the standard 80x25 text mode. */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">;</span>
	<span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now try to restore whatever hardware state we might have</span>
<span class="cm">	 * saved when the fb device was first opened.</span>
<span class="cm">	 */</span>
	<span class="n">uvesafb_vbe_state_restore</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_orig</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span>
		<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vbe_crtc_ib</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vbe_mode_ib</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">uvesafb_vbe_find_mode</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span>
				 <span class="n">UVESAFB_EXACT_RES</span> <span class="o">|</span> <span class="n">UVESAFB_EXACT_DEPTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="nl">setmode:</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f02</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">mode_id</span> <span class="o">|</span> <span class="mh">0x4000</span><span class="p">;</span>	<span class="cm">/* use LFB */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span> <span class="o">&gt;=</span> <span class="mh">0x0300</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">|=</span> <span class="mh">0x0800</span><span class="p">;</span>		<span class="cm">/* use CRTC data */</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_BUF_ESDI</span><span class="p">;</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vbe_crtc_ib</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horiz_start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horiz_end</span>	  <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horiz_start</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horiz_total</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horiz_end</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">;</span>

		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_start</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_end</span>    <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_start</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_total</span>  <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_end</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">;</span>

		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">refresh_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">vert_total</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">horiz_total</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">))</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">))</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">crtc</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">crtc</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">buf_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vbe_crtc_ib</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The mode switch might have failed because we tried to</span>
<span class="cm">		 * use our own timings.  Try again with the default timings.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: mode switch failed &quot;</span>
				<span class="s">&quot;(eax=0x%x, err=%d). Trying again with &quot;</span>
				<span class="s">&quot;default timings.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">uvesafb_reset</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
			<span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">setmode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: mode switch failed (eax=&quot;</span>
				<span class="s">&quot;0x%x, err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mode_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* For 8bpp modes, always try to set the DAC to 8 bits. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">VBE_CAP_CAN_SWITCH_DAC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvesafb_reset</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x4f08</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mh">0x0800</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x004f</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dac_width</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dac_width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bytes_per_scan_line</span><span class="p">;</span>

<span class="nl">out:</span>	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvesafb_check_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If pixclock is set to 0, then we&#39;re using default BIOS timings</span>
<span class="cm">	 * and thus don&#39;t have to perform any checks here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span> <span class="o">&lt;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_VSYNCTIMINGS</span> <span class="o">|</span> <span class="n">FB_IGNOREMON</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_validate_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">fb_find_best_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_MAXTIMINGS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Use default refresh rate */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vbe_mode_ib</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Various apps will use bits_per_pixel to set the color depth,</span>
<span class="cm">	 * which is theoretically incorrect, but which we&#39;ll try to handle</span>
<span class="cm">	 * here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">abs</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">uvesafb_vbe_find_mode</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span>
						<span class="n">UVESAFB_EXACT_RES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">match</span><span class="p">];</span>
	<span class="n">uvesafb_setup_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether we have remapped enough memory for this mode.</span>
<span class="cm">	 * We might be called at an early stage, when we haven&#39;t remapped</span>
<span class="cm">	 * any memory yet, in which case we simply skip the check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">*</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bytes_per_scan_line</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>
						<span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">mode_attr</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">mode_attr</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>

	<span class="n">uvesafb_check_limits</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bytes_per_scan_line</span> <span class="o">:</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">uvesafb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>	<span class="o">=</span> <span class="n">uvesafb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>	<span class="o">=</span> <span class="n">uvesafb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">uvesafb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcmap</span>	<span class="o">=</span> <span class="n">uvesafb_setcmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">uvesafb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">uvesafb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">uvesafb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">uvesafb_set_par</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">uvesafb_init_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">vbe_mode_ib</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size_vmode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size_remap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size_total</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvesafb_par</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">uvesafb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable blanking if the user requested so. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blank</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_blank</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find out how much IO memory is required for the mode with</span>
<span class="cm">	 * the highest resolution.</span>
<span class="cm">	 */</span>
	<span class="n">size_remap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes_per_scan_line</span> <span class="o">*</span>
					<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y_res</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">size_remap</span><span class="p">)</span>
			<span class="n">size_remap</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size_remap</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *   size_vmode -- that is the amount of memory needed for the</span>
<span class="cm">	 *                 used video mode, i.e. the minimum amount of</span>
<span class="cm">	 *                 memory we need.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size_vmode</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">*</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bytes_per_scan_line</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size_vmode</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span>
			     <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *   size_total -- all video memory we have. Used for mtrr</span>
<span class="cm">	 *                 entries, resource allocation and bounds</span>
<span class="cm">	 *                 checking.</span>
<span class="cm">	 */</span>
	<span class="n">size_total</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">total_memory</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vram_total</span><span class="p">)</span>
		<span class="n">size_total</span> <span class="o">=</span> <span class="n">vram_total</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size_total</span> <span class="o">&lt;</span> <span class="n">size_vmode</span><span class="p">)</span>
		<span class="n">size_total</span> <span class="o">=</span> <span class="n">size_vmode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *   size_remap -- the amount of video memory we are going to</span>
<span class="cm">	 *                 use for vesafb.  With modern cards it is no</span>
<span class="cm">	 *                 option to simply use size_total as th</span>
<span class="cm">	 *                 wastes plenty of kernel address space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vram_remap</span><span class="p">)</span>
		<span class="n">size_remap</span> <span class="o">=</span> <span class="n">vram_remap</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size_remap</span> <span class="o">&lt;</span> <span class="n">size_vmode</span><span class="p">)</span>
		<span class="n">size_remap</span> <span class="o">=</span> <span class="n">size_vmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size_remap</span> <span class="o">&gt;</span> <span class="n">size_total</span><span class="p">)</span>
		<span class="n">size_remap</span> <span class="o">=</span> <span class="n">size_total</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">size_remap</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">phys_base_ptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to set yres_virtual here because when setup_var() was</span>
<span class="cm">	 * called, smem_len wasn&#39;t defined yet.</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span>
				 <span class="n">mode</span><span class="o">-&gt;</span><span class="n">bytes_per_scan_line</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: scrolling: %s &quot;</span>
			<span class="s">&quot;using protected mode interface, &quot;</span>
			<span class="s">&quot;yres_virtual=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ywrap&quot;</span> <span class="o">:</span> <span class="s">&quot;ypan&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: scrolling: redraw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span> <span class="o">?</span> <span class="n">FBINFO_HWACCEL_YPAN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ypan</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">uvesafb_init_mtrr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtrr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">temp_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mtrr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="n">MTRR_TYPE_UNCACHABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="n">MTRR_TYPE_WRBACK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="n">MTRR_TYPE_WRTHROUGH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

			<span class="cm">/* Find the largest power-of-two */</span>
			<span class="n">temp_size</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">temp_size</span><span class="p">);</span>

			<span class="cm">/* Try and find a power of two to add */</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
					      <span class="n">temp_size</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">temp_size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">temp_size</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MTRR */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">uvesafb_ioremap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mtrr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* uncachable */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* write-back */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_cache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* write-combining */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_wc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* write-through */</span>
	<span class="nl">default:</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86 */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_show_vbe_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">vbe_version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vbe_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">uvesafb_show_vbe_ver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_show_vbe_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span>
			<span class="s">&quot;%dx%d-%d, 0x%.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x_res</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y_res</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">depth</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vbe_modes</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">uvesafb_show_vbe_modes</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_show_vendor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_vendor_name_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_vendor_name_ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">oem_vendor</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">uvesafb_show_vendor</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_show_product_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_name_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_name_ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">oem_product_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">uvesafb_show_product_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_show_product_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_rev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_product_rev_ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">oem_product_rev</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">uvesafb_show_product_rev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_show_oem_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_string_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">)</span> <span class="o">+</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">oem_string_ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">oem_string</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">uvesafb_show_oem_string</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_show_nocrtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvesafb_store_nocrtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">nocrtc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">nocrtc</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">uvesafb_show_nocrtc</span><span class="p">,</span>
			<span class="n">uvesafb_store_nocrtc</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">uvesafb_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vbe_version</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vbe_modes</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_oem_vendor</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_oem_product_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_oem_product_rev</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_oem_string</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_nocrtc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">uvesafb_dev_attgrp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">uvesafb_dev_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vbe_mode_ib</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="o">+</span>	<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uvesafb_vbe_init</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: vbe_init() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uvesafb_ops</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">uvesafb_vbe_init_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uvesafb_init_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="mh">0x3c0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;uvesafb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: request region 0x3c0-0x3e0 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				<span class="s">&quot;uvesafb&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;uvesafb: cannot reserve video memory at &quot;</span>
				<span class="s">&quot;0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uvesafb_init_mtrr</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">uvesafb_ioremap</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;uvesafb: abort, cannot ioremap 0x%x bytes of video &quot;</span>
			<span class="s">&quot;memory at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;uvesafb: failed to register framebuffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;uvesafb: framebuffer at 0x%lx, mapped to 0x%p, &quot;</span>
			<span class="s">&quot;using %dk, total %dk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_ib</span><span class="p">.</span><span class="n">total_memory</span> <span class="o">*</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uvesafb_dev_attgrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;fb%d: failed to register attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="nl">out_mem:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
<span class="nl">out_reg:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3c0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
<span class="nl">out_mode:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">))</span>
		<span class="n">fb_destroy_modelist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
	<span class="n">fb_destroy_modedb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">);</span>

	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvesafb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uvesafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uvesafb_dev_attgrp</span><span class="p">);</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3c0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="n">fb_destroy_modedb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_modes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_orig</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_orig</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_saved</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vbe_state_saved</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">uvesafb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>  <span class="o">=</span> <span class="n">uvesafb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">uvesafb_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;uvesafb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">uvesafb_device</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;redraw&quot;</span><span class="p">))</span>
			<span class="n">ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;ypan&quot;</span><span class="p">))</span>
			<span class="n">ypan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;ywrap&quot;</span><span class="p">))</span>
			<span class="n">ypan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vgapal&quot;</span><span class="p">))</span>
			<span class="n">pmi_setpal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;pmipal&quot;</span><span class="p">))</span>
			<span class="n">pmi_setpal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mtrr:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">mtrr</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nomtrr&quot;</span><span class="p">))</span>
			<span class="n">mtrr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nocrtc&quot;</span><span class="p">))</span>
			<span class="n">nocrtc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noedid&quot;</span><span class="p">))</span>
			<span class="n">noedid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noblank&quot;</span><span class="p">))</span>
			<span class="n">blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vtotal:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">vram_total</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vremap:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">vram_remap</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;maxhf:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">maxhf</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;maxvf:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">maxvf</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;maxclk:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">maxclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vbemode:&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">vbemode</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">this_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;uvesafb: unrecognized option %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_v86d</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v86d_path</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_v86d</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">v86d_path</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">v86d</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_v86d</span><span class="p">,</span> <span class="n">store_v86d</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">uvesafb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;uvesafb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">uvesafb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cn_add_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_cn_id</span><span class="p">,</span> <span class="s">&quot;uvesafb&quot;</span><span class="p">,</span> <span class="n">uvesafb_cn_callback</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvesafb_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;uvesafb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvesafb_device</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">uvesafb_device</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">platform_device_put</span><span class="p">(</span><span class="n">uvesafb_device</span><span class="p">);</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_driver</span><span class="p">);</span>
			<span class="n">cn_del_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_cn_id</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">driver_attr_v86d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;uvesafb: failed to register &quot;</span>
					<span class="s">&quot;attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">uvesafb_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">uvesafb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvesafb_ktask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v86d_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span> <span class="o">=</span> <span class="n">uvesafb_prep</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TF_EXIT</span><span class="p">;</span>
			<span class="n">uvesafb_exec</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="n">uvesafb_free</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cn_del_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_cn_id</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_v86d</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">uvesafb_device</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvesafb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">uvesafb_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_set_scroll</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;redraw&quot;</span><span class="p">))</span>
		<span class="n">ypan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;ypan&quot;</span><span class="p">))</span>
		<span class="n">ypan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;ywrap&quot;</span><span class="p">))</span>
		<span class="n">ypan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kernel_param_ops</span> <span class="n">param_ops_scroll</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">param_set_scroll</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define param_check_scroll(name, p) __param_check(name, p, void)</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">scroll</span><span class="p">,</span> <span class="n">ypan</span><span class="p">,</span> <span class="n">scroll</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">scroll</span><span class="p">,</span>
	<span class="s">&quot;Scrolling mode, set to &#39;redraw&#39;, &#39;ypan&#39;, or &#39;ywrap&#39;&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">vgapal</span><span class="p">,</span> <span class="n">pmi_setpal</span><span class="p">,</span> <span class="n">invbool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vgapal</span><span class="p">,</span> <span class="s">&quot;Set palette using VGA registers&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">pmipal</span><span class="p">,</span> <span class="n">pmi_setpal</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pmipal</span><span class="p">,</span> <span class="s">&quot;Set palette using PMI calls&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mtrr</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mtrr</span><span class="p">,</span>
	<span class="s">&quot;Memory Type Range Registers setting. Use 0 to disable.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">blank</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">blank</span><span class="p">,</span> <span class="s">&quot;Enable hardware blanking&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nocrtc</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nocrtc</span><span class="p">,</span> <span class="s">&quot;Ignore CRTC timings when setting modes&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noedid</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noedid</span><span class="p">,</span>
	<span class="s">&quot;Ignore EDID-provided monitor limits when setting modes&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vram_remap</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vram_remap</span><span class="p">,</span> <span class="s">&quot;Set amount of video memory to be used [MiB]&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vram_total</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vram_total</span><span class="p">,</span> <span class="s">&quot;Set total amount of video memoery [MiB]&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">maxclk</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">maxclk</span><span class="p">,</span> <span class="s">&quot;Maximum pixelclock [MHz], overrides EDID data&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">maxhf</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">maxhf</span><span class="p">,</span>
	<span class="s">&quot;Maximum horizontal frequency [kHz], overrides EDID data&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">maxvf</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">maxvf</span><span class="p">,</span>
	<span class="s">&quot;Maximum vertical frequency [Hz], overrides EDID data&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span>
	<span class="s">&quot;Specify initial video mode as </span><span class="se">\&quot;</span><span class="s">&lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vbemode</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vbemode</span><span class="p">,</span>
	<span class="s">&quot;VBE mode number to set, overrides the &#39;mode&#39; option&quot;</span><span class="p">);</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">v86d</span><span class="p">,</span> <span class="n">v86d_path</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="mo">0660</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">v86d</span><span class="p">,</span> <span class="s">&quot;Path to the v86d userspace helper.&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Michal Januszewski &lt;spock@gentoo.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for VBE2.0+ compliant graphics boards&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
