<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › macfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>macfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * macfb.c: Generic framebuffer for Macs whose colourmaps/modes we</span>
<span class="cm"> * don&#39;t know how to set.</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 1999 David Huggins-Daines &lt;dhd@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Primarily based on vesafb.c, by Gerd Knorr</span>
<span class="cm"> * (c) 1998 Gerd Knorr &lt;kraxel@cs.tu-berlin.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Also uses information and code from:</span>
<span class="cm"> *</span>
<span class="cm"> * The original macfb.c from Linux/mac68k 2.0, by Alan Cox, Juergen</span>
<span class="cm"> * Mellinger, Mikael Forselius, Michael Schmitz, and others.</span>
<span class="cm"> *</span>
<span class="cm"> * valkyriefb.c, by Martin Costabel, Kevin Schoedel, Barry Nathan, Dan</span>
<span class="cm"> * Jacobowitz, Paul Mackerras, Fabio Riccardi, and Geert Uytterhoeven.</span>
<span class="cm"> *</span>
<span class="cm"> * The VideoToolbox &quot;Bugs&quot; web page at</span>
<span class="cm"> * http://rajsky.psych.nyu.edu/Tips/VideoBugs.html</span>
<span class="cm"> *</span>
<span class="cm"> * This code is free software.  You may copy, modify, and distribute</span>
<span class="cm"> * it subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License, version 2, or any later version, at your convenience.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/nubus.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/bootinfo.h&gt;</span>
<span class="cp">#include &lt;asm/macintosh.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/* Common DAC base address for the LC, RBV, Valkyrie, and IIvx */</span>
<span class="cp">#define DAC_BASE 0x50f24000</span>

<span class="cm">/* Some addresses for the DAFB */</span>
<span class="cp">#define DAFB_BASE 0xf9800200</span>

<span class="cm">/* Address for the built-in Civic framebuffer in Quadra AVs */</span>
<span class="cp">#define CIVIC_BASE 0x50f30800</span>

<span class="cm">/* GSC (Gray Scale Controller) base address */</span>
<span class="cp">#define GSC_BASE 0x50F20000</span>

<span class="cm">/* CSC (Color Screen Controller) base address */</span>
<span class="cp">#define CSC_BASE 0x50F20000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">macfb_setpalette</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lut</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">v8_brazil_cmap_regs</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pad1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* word aligned */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lut</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* word aligned */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cntl</span><span class="p">;</span> <span class="cm">/* a guess as to purpose */</span>
<span class="p">}</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rbv_cmap_regs</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pad1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lut</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dafb_cmap_regs</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">;</span>	<span class="cm">/* OFFSET: 0x00 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pad1</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lut</span><span class="p">;</span>	<span class="cm">/* OFFSET: 0x10 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>	<span class="cm">/* OFFSET: 0x20 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pad3</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vbl_addr</span><span class="p">;</span>	<span class="cm">/* OFFSET: 0x28 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">status2</span><span class="p">;</span>	<span class="cm">/* OFFSET: 0x2C */</span>
<span class="p">}</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">civic_cmap_regs</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">pad1</span><span class="p">[</span><span class="mh">0x40</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clut_waddr</span><span class="p">;</span>	<span class="cm">/* 0x40 */</span>
	<span class="kt">char</span> <span class="n">pad2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clut_data</span><span class="p">;</span>	<span class="cm">/* 0x42 */</span>
	<span class="kt">char</span> <span class="n">pad3</span><span class="p">[</span><span class="mh">0x3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clut_raddr</span><span class="p">;</span>	<span class="cm">/* 0x46 */</span>
<span class="p">}</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">csc_cmap_regs</span><span class="p">;</span>

<span class="cm">/* The registers in these structs are in NuBus slot space */</span>
<span class="k">struct</span> <span class="n">mdc_cmap_regs</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">pad1</span><span class="p">[</span><span class="mh">0x200200</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lut</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">toby_cmap_regs</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">pad1</span><span class="p">[</span><span class="mh">0x90018</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lut</span><span class="p">;</span> <span class="cm">/* TFBClutWDataReg, offset 0x90018 */</span>
	<span class="kt">char</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">;</span> <span class="cm">/* TFBClutAddrReg, offset 0x9001C */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">jet_cmap_regs</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">pad1</span><span class="p">[</span><span class="mh">0xe0e000</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lut</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PIXEL_TO_MM(a)	(((a)*10)/28)	</span><span class="cm">/* width in mm at 72 dpi */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">macfb_defined</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">macfb_fix</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">slot_addr</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="n">fb_info</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">inverse</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vidtest</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Unlike the Valkyrie, the DAFB cannot set individual colormap</span>
<span class="cm"> * registers.  Therefore, we do what the MacOS driver does (no</span>
<span class="cm"> * kidding!) and simply set them one by one until we hit the one we</span>
<span class="cm"> * want.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dafb_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">lastreg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * fbdev will set an entire colourmap, but X won&#39;t.  Hopefully</span>
<span class="cm">	 * this should accommodate both of them</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">!=</span> <span class="n">lastreg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Stab in the dark trying to reset the CLUT pointer */</span>
		<span class="n">nubus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dafb_cmap_regs</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>

		<span class="cm">/* Loop until we get to the register we want */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">regno</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dafb_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
			<span class="n">nop</span><span class="p">();</span>
			<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dafb_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
			<span class="n">nop</span><span class="p">();</span>
			<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dafb_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
			<span class="n">nop</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dafb_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dafb_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dafb_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">lastreg</span> <span class="o">=</span> <span class="n">regno</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* V8 and Brazil seem to use the same DAC.  Sonora does as well. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">v8_brazil_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* failsafe */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* On these chips, the CLUT register numbers are spread out</span>
<span class="cm">	 * across the register space.  Thus:</span>
<span class="cm">	 * In 8bpp, all regnos are valid.</span>
<span class="cm">	 * In 4bpp, the regnos are 0x0f, 0x1f, 0x2f, etc, etc</span>
<span class="cm">	 * In 2bpp, the regnos are 0x3f, 0x7f, 0xbf, 0xff</span>
<span class="cm">	 */</span>
	<span class="n">regno</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bpp</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">&gt;&gt;</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8_brazil_cmap_regs</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>

	<span class="cm">/* send one color channel at a time */</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8_brazil_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8_brazil_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8_brazil_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* RAM-Based Video */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rbv_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* failsafe */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* From the VideoToolbox driver.  Seems to be saying that</span>
<span class="cm">	 * regno #254 and #255 are the important ones for 1-bit color,</span>
<span class="cm">	 * regno #252-255 are the important ones for 2-bit color, etc.</span>
<span class="cm">	 */</span>
	<span class="n">regno</span> <span class="o">+=</span> <span class="mi">256</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="cm">/* reset clut? (VideoToolbox sez &quot;not necessary&quot;) */</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbv_cmap_regs</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>

	<span class="cm">/* tell clut which address to use. */</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbv_cmap_regs</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>

	<span class="cm">/* send one color channel at a time. */</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbv_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbv_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbv_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Macintosh Display Card (8*24) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdc_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdc_cmap_regs</span> <span class="o">*</span><span class="n">cmap_regs</span> <span class="o">=</span> <span class="n">slot_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* the nop&#39;s are there to order writes. */</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Toby frame buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">toby_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">toby_cmap_regs</span> <span class="o">*</span><span class="n">cmap_regs</span> <span class="o">=</span> <span class="n">slot_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">red</span> <span class="o">=</span> <span class="o">~</span><span class="n">red</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">=</span> <span class="o">~</span><span class="n">green</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">=</span> <span class="o">~</span><span class="n">blue</span><span class="p">;</span>
	<span class="n">regno</span> <span class="o">=</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bpp</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">&gt;&gt;</span> <span class="n">bpp</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Jet frame buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jet_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jet_cmap_regs</span> <span class="o">*</span><span class="n">cmap_regs</span> <span class="o">=</span> <span class="n">slot_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Civic framebuffer -- Quadra AV built-in video.  A chip</span>
<span class="cm"> * called Sebastian holds the actual color palettes, and</span>
<span class="cm"> * apparently, there are two different banks of 512K RAM</span>
<span class="cm"> * which can act as separate framebuffers for doing video</span>
<span class="cm"> * input and viewing the screen at the same time!  The 840AV</span>
<span class="cm"> * Can add another 1MB RAM to give the two framebuffers</span>
<span class="cm"> * 1MB RAM apiece.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">civic_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clut_status</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* failsafe */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Set the register address */</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">nop</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab a status word and do some checking;</span>
<span class="cm">	 * Then finally write the clut!</span>
<span class="cm">	 */</span>
	<span class="n">clut_status</span> <span class="o">=</span>  <span class="n">nubus_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">clut_status</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if ((clut_status &amp; 0x000D) != 0)</span>
<span class="c">		{</span>
<span class="c">			nubus_writeb(0x00, &amp;civic_cmap_regs-&gt;lut);</span>
<span class="c">			nop();</span>
<span class="c">			nubus_writeb(0x00, &amp;civic_cmap_regs-&gt;lut);</span>
<span class="c">			nop();</span>
<span class="c">		}</span>
<span class="cp">#endif</span>

		<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">nubus_writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">junk</span><span class="p">;</span>

		<span class="n">junk</span> <span class="o">=</span> <span class="n">nubus_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">junk</span> <span class="o">=</span> <span class="n">nubus_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">junk</span> <span class="o">=</span> <span class="n">nubus_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">junk</span> <span class="o">=</span> <span class="n">nubus_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">clut_status</span> <span class="o">&amp;</span> <span class="mh">0x000D</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">nubus_writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
			<span class="n">nop</span><span class="p">();</span>
			<span class="n">nubus_writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
			<span class="n">nop</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
		<span class="n">nop</span><span class="p">();</span>
		<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">junk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">civic_cmap_regs</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The CSC is the framebuffer on the PowerBook 190 series</span>
<span class="cm"> * (and the 5300 too, but that&#39;s a PowerMac). This function</span>
<span class="cm"> * brought to you in part by the ECSC driver for MkLinux.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csc_setpalette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* mklinux on PB 5300 waits for 260 ns */</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csc_cmap_regs</span><span class="o">-&gt;</span><span class="n">clut_waddr</span><span class="p">);</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csc_cmap_regs</span><span class="o">-&gt;</span><span class="n">clut_data</span><span class="p">);</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csc_cmap_regs</span><span class="o">-&gt;</span><span class="n">clut_data</span><span class="p">);</span>
	<span class="n">nubus_writeb</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csc_cmap_regs</span><span class="o">-&gt;</span><span class="n">clut_data</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">macfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set a single color register. The values supplied are</span>
<span class="cm">	 * already rounded down to the hardware&#39;s capabilities</span>
<span class="cm">	 * (according to the entries in the `var&#39; structure).</span>
<span class="cm">	 * Return non-zero for invalid regno.</span>
<span class="cm">	 */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* We shouldn&#39;t get here */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">macfb_setpalette</span><span class="p">)</span>
				<span class="n">macfb_setpalette</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
						 <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 1:5:5:5 */</span>
				<span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">red</span>   <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">blue</span>  <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">transp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* 0:5:6:5 */</span>
				<span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">red</span>   <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">blue</span>  <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * 24-bit colour almost doesn&#39;t exist on 68k Macs --</span>
<span class="cm">		 * http://support.apple.com/kb/TA28634 (Old Article: 10992)</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">red</span>   <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">blue</span>  <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">red</span>   <span class="o">&lt;&lt;</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">blue</span>  <span class="o">&lt;&lt;</span> <span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">macfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">macfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">macfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;inverse&quot;</span><span class="p">))</span>
			<span class="n">inverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vidtest&quot;</span><span class="p">))</span>
				<span class="n">vidtest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* enable experimental CLUT code */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">iounmap_macfb</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dafb_cmap_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dafb_cmap_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v8_brazil_cmap_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">v8_brazil_cmap_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbv_cmap_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">rbv_cmap_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">civic_cmap_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">civic_cmap_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csc_cmap_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">csc_cmap_regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">macfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">video_cmap_len</span><span class="p">,</span> <span class="n">video_is_nubus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;macfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">macfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_MAC</span><span class="p">)</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_bi_data</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">MAC_MODEL_Q630</span> <span class="o">||</span>
	    <span class="n">mac_bi_data</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">MAC_MODEL_P588</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="cm">/* See valkyriefb.c */</span>

	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">mac_bi_data</span><span class="p">.</span><span class="n">dimensions</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">mac_bi_data</span><span class="p">.</span><span class="n">dimensions</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">mac_bi_data</span><span class="p">.</span><span class="n">videodepth</span><span class="p">;</span>

	<span class="n">macfb_fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">mac_bi_data</span><span class="p">.</span><span class="n">videorow</span><span class="p">;</span>
	<span class="n">macfb_fix</span><span class="p">.</span><span class="n">smem_len</span>    <span class="o">=</span> <span class="n">macfb_fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="cm">/* Note: physical address (since 2.1.127) */</span>
	<span class="n">macfb_fix</span><span class="p">.</span><span class="n">smem_start</span>  <span class="o">=</span> <span class="n">mac_bi_data</span><span class="p">.</span><span class="n">videoaddr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is actually redundant with the initial mappings.</span>
<span class="cm">	 * However, there are some non-obvious aspects to the way</span>
<span class="cm">	 * those mappings are set up, so this is in fact the safest</span>
<span class="cm">	 * way to ensure that this driver will work on every possible Mac</span>
<span class="cm">	 */</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mac_bi_data</span><span class="p">.</span><span class="n">videoaddr</span><span class="p">,</span>
				      <span class="n">macfb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_info</span><span class="p">.</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;macfb: framebuffer at 0x%08lx, mapped to 0x%p, size %dk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">macfb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">screen_base</span><span class="p">,</span>
	        <span class="n">macfb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;macfb: mode is %dx%dx%d, linelength=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
	        <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="n">macfb_fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">);</span>

	<span class="cm">/* Fill in the available video resolution */</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">height</span>       <span class="o">=</span> <span class="n">PIXEL_TO_MM</span><span class="p">(</span><span class="n">macfb_defined</span><span class="p">.</span><span class="n">yres</span><span class="p">);</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">width</span>        <span class="o">=</span> <span class="n">PIXEL_TO_MM</span><span class="p">(</span><span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres</span><span class="p">);</span>

	<span class="cm">/* Some dummy values for timing to make fbset happy */</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">pixclock</span>     <span class="o">=</span> <span class="mi">10000000</span> <span class="o">/</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span>
				     <span class="mi">1000</span> <span class="o">/</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">left_margin</span>  <span class="o">=</span> <span class="p">(</span><span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">;</span>
	<span class="n">macfb_defined</span><span class="p">.</span><span class="n">hsync_len</span>    <span class="o">=</span> <span class="p">(</span><span class="n">macfb_defined</span><span class="p">.</span><span class="n">xres</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">macfb_fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">macfb_fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Should actually be FB_VISUAL_DIRECTCOLOR, but this</span>
<span class="cm">		 * works too</span>
<span class="cm">		 */</span>
		<span class="n">macfb_fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">macfb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">video_cmap_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">macfb_fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;macfb: unknown or unsupported bit depth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">macfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_unmap</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * We take a wild guess that if the video physical address is</span>
<span class="cm">	 * in nubus slot space, that the nubus card is driving video.</span>
<span class="cm">	 * Penguin really ought to tell us whether we are using internal</span>
<span class="cm">	 * video or not.</span>
<span class="cm">	 * Hopefully we only find one of them.  Otherwise our NuBus</span>
<span class="cm">	 * code is really broken :-)</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">nubus_find_type</span><span class="p">(</span><span class="n">NUBUS_CAT_DISPLAY</span><span class="p">,</span>
				       <span class="n">NUBUS_TYPE_VIDEO</span><span class="p">,</span> <span class="n">ndev</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mac_bi_data</span><span class="p">.</span><span class="n">videoaddr</span> <span class="o">&lt;</span> <span class="n">base</span> <span class="o">||</span>
		    <span class="n">mac_bi_data</span><span class="p">.</span><span class="n">videoaddr</span> <span class="o">-</span> <span class="n">base</span> <span class="o">&gt;</span> <span class="mh">0xFFFFFF</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">video_is_nubus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">slot_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dr_hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NUBUS_DRHW_APPLE_MDC</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Mac Disp. Card&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">mdc_setpalette</span><span class="p">;</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_DRHW_APPLE_TFB</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Toby&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">toby_setpalette</span><span class="p">;</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_DRHW_APPLE_JET</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Jet&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">jet_setpalette</span><span class="p">;</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Generic NuBus&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If it&#39;s not a NuBus card, it must be internal video */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">video_is_nubus</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mac_bi_data</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * DAFB Quadras</span>
<span class="cm">		 * Note: these first four have the v7 DAFB, which is</span>
<span class="cm">		 * known to be rather unlike the ones used in the</span>
<span class="cm">		 * other models</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_P475</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_P475F</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_P575</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q605</span>:

		<span class="k">case</span> <span class="n">MAC_MODEL_Q800</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q650</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q610</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_C650</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_C610</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q700</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q900</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q950</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;DAFB&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">dafb_setpalette</span><span class="p">;</span>
			<span class="n">dafb_cmap_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">DAFB_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * LC II uses the V8 framebuffer</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_LCII</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;V8&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">v8_brazil_setpalette</span><span class="p">;</span>
			<span class="n">v8_brazil_cmap_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">DAC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * IIvi, IIvx use the &quot;Brazil&quot; framebuffer (which is</span>
<span class="cm">		 * very much like the V8, it seems, and probably uses</span>
<span class="cm">		 * the same DAC)</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_IIVI</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_IIVX</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_P600</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Brazil&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">v8_brazil_setpalette</span><span class="p">;</span>
			<span class="n">v8_brazil_cmap_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">DAC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * LC III (and friends) use the Sonora framebuffer</span>
<span class="cm">		 * Incidentally this is also used in the non-AV models</span>
<span class="cm">		 * of the x100 PowerMacs</span>
<span class="cm">		 * These do in fact seem to use the same DAC interface</span>
<span class="cm">		 * as the LC II.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_LCIII</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_P520</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_P550</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_P460</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Sonora&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">v8_brazil_setpalette</span><span class="p">;</span>
			<span class="n">v8_brazil_cmap_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">DAC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * IIci and IIsi use the infamous RBV chip</span>
<span class="cm">		 * (the IIsi is just a rebadged and crippled</span>
<span class="cm">		 * IIci in a different case, BTW)</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_IICI</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_IISI</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;RBV&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">rbv_setpalette</span><span class="p">;</span>
			<span class="n">rbv_cmap_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">DAC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * AVs use the Civic framebuffer</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_Q840</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_C660</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Civic&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">civic_setpalette</span><span class="p">;</span>
			<span class="n">civic_cmap_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">CIVIC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		
		<span class="cm">/*</span>
<span class="cm">		 * Assorted weirdos</span>
<span class="cm">		 * We think this may be like the LC II</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_LC</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;LC&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vidtest</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">v8_brazil_setpalette</span><span class="p">;</span>
				<span class="n">v8_brazil_cmap_regs</span> <span class="o">=</span>
					<span class="n">ioremap</span><span class="p">(</span><span class="n">DAC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
				<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We think this may be like the LC II</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_CCL</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Color Classic&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vidtest</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">v8_brazil_setpalette</span><span class="p">;</span>
				<span class="n">v8_brazil_cmap_regs</span> <span class="o">=</span>
					<span class="n">ioremap</span><span class="p">(</span><span class="n">DAC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
				<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * And we *do* mean &quot;weirdos&quot;</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_TV</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Mac TV&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * These don&#39;t have colour, so no need to worry</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_SE30</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_CLII</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Monochrome&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Powerbooks are particularly difficult.  Many of</span>
<span class="cm">		 * them have separate framebuffers for external and</span>
<span class="cm">		 * internal video, which is admittedly pretty cool,</span>
<span class="cm">		 * but will be a bit of a headache to support here.</span>
<span class="cm">		 * Also, many of them are grayscale, and we don&#39;t</span>
<span class="cm">		 * really support that.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Slot 0 ROM says TIM. No external video. B&amp;W.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_PB140</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB145</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB170</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;DDC&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Internal is GSC, External (if present) is ViSC</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_PB150</span>:	<span class="cm">/* no external video */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_PB160</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB165</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB180</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB210</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB230</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;GSC&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Internal is TIM, External is ViSC</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_PB165C</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB180C</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;TIM&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Internal is CSC, External is Keystone+Ariel.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_PB190</span>:	<span class="cm">/* external video is optional */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_PB520</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB250</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB270C</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB280</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_PB280C</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;CSC&quot;</span><span class="p">);</span>
			<span class="n">macfb_setpalette</span> <span class="o">=</span> <span class="n">csc_setpalette</span><span class="p">;</span>
			<span class="n">csc_cmap_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">CSC_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">macfb_defined</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">macfb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">macfb_ops</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">var</span>		<span class="o">=</span> <span class="n">macfb_defined</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span>		<span class="o">=</span> <span class="n">macfb_fix</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">video_cmap_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_unmap</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_dealloc</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">fb_info</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_dealloc:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">fail_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">iounmap_macfb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">macfb_init</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
