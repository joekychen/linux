<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › omap › omapfb_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omapfb_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Framebuffer driver for TI OMAP boards</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Nokia Corporation</span>
<span class="cm"> * Author: Imre Deak &lt;imre.deak@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Acknowledgements:</span>
<span class="cm"> *   Alex McMains &lt;aam@ridgerun.com&gt;       - Original driver</span>
<span class="cm"> *   Juha Yrjola &lt;juha.yrjola@nokia.com&gt;   - Original driver and improvements</span>
<span class="cm"> *   Dirk Behme &lt;dirk.behme@de.bosch.com&gt;  - changes for 2.6 kernel API</span>
<span class="cm"> *   Texas Instruments                     - H3 support</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;plat/dma.h&gt;</span>

<span class="cp">#include &quot;omapfb.h&quot;</span>
<span class="cp">#include &quot;lcdc.h&quot;</span>

<span class="cp">#define MODULE_NAME	&quot;omapfb&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">def_accel</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">def_vram</span><span class="p">[</span><span class="n">OMAPFB_PLANE_NUM</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">def_vram_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">def_vxres</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">def_vyres</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">def_rotate</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">def_mirror</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_OMAP_MANUAL_UPDATE</span>
<span class="k">static</span> <span class="n">bool</span>		<span class="n">manual_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">bool</span>		<span class="n">manual_update</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">fbdev_pdev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lcd_panel</span>		<span class="o">*</span><span class="n">fbdev_panel</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">omapfb_device</span>	<span class="o">*</span><span class="n">omapfb_dev</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">caps_table_struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">caps_table_struct</span> <span class="n">ctrl_caps</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_MANUAL_UPDATE</span><span class="p">,</span>  <span class="s">&quot;manual update&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_TEARSYNC</span><span class="p">,</span>       <span class="s">&quot;tearing synchronization&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_PLANE_RELOCATE_MEM</span><span class="p">,</span> <span class="s">&quot;relocate plane memory&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_PLANE_SCALE</span><span class="p">,</span>    <span class="s">&quot;scale plane&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_WINDOW_PIXEL_DOUBLE</span><span class="p">,</span> <span class="s">&quot;pixel double window&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_WINDOW_SCALE</span><span class="p">,</span>   <span class="s">&quot;scale window&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_WINDOW_OVERLAY</span><span class="p">,</span> <span class="s">&quot;overlay window&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_WINDOW_ROTATE</span><span class="p">,</span>  <span class="s">&quot;rotate window&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">OMAPFB_CAPS_SET_BACKLIGHT</span><span class="p">,</span>  <span class="s">&quot;backlight setting&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">caps_table_struct</span> <span class="n">color_caps</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_RGB565</span><span class="p">,</span>	<span class="s">&quot;RGB565&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_YUV422</span><span class="p">,</span>	<span class="s">&quot;YUV422&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_YUV420</span><span class="p">,</span>	<span class="s">&quot;YUV420&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_CLUT_8BPP</span><span class="p">,</span>	<span class="s">&quot;CLUT8&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_CLUT_4BPP</span><span class="p">,</span>	<span class="s">&quot;CLUT4&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_CLUT_2BPP</span><span class="p">,</span>	<span class="s">&quot;CLUT2&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_CLUT_1BPP</span><span class="p">,</span>	<span class="s">&quot;CLUT1&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_RGB444</span><span class="p">,</span>	<span class="s">&quot;RGB444&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAPFB_COLOR_YUY422</span><span class="p">,</span>	<span class="s">&quot;YUY422&quot;</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapdss_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/* dummy device for clocks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">omapdss_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;omapdss_dss&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>            <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">omapdss_release</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * LCD panel</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">lcd_ctrl</span> <span class="n">hwa742_ctrl</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">lcd_ctrl</span> <span class="o">*</span><span class="n">ctrls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">omap1_int_ctrl</span><span class="p">,</span>

<span class="cp">#ifdef CONFIG_FB_OMAP_LCDC_HWA742</span>
	<span class="o">&amp;</span><span class="n">hwa742_ctrl</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_FB_OMAP_LCDC_EXTERNAL</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">lcd_ctrl_extif</span> <span class="n">omap1_ext_if</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_rqueue_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">rqueue_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_rqueue_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">rqueue_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * LCD controller and LCD DMA</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="cm">/* Lookup table to map elem size to elem type. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">dma_elem_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">OMAP_DMA_DATA_TYPE_S8</span><span class="p">,</span>
	<span class="n">OMAP_DMA_DATA_TYPE_S16</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">OMAP_DMA_DATA_TYPE_S32</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate resources needed for LCD controller and LCD DMA operations. Video</span>
<span class="cm"> * memory is allocated from system memory according to the virtual display</span>
<span class="cm"> * size, except if a bigger memory size is specified explicitly as a kernel</span>
<span class="cm"> * parameter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* kernel/module vram parameters override boot tags/board config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_vram_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">def_vram_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span>
				<span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">def_vram</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lcd_panel</span> <span class="o">*</span><span class="n">panel</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">def_size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>

		<span class="cm">/* 12 bpp is packed in 16 bits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">def_size</span> <span class="o">=</span> <span class="n">def_vxres</span> <span class="o">*</span> <span class="n">def_vyres</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">def_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller initialization failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;region%d phys %08x virt %p size=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span>
			 <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">paddr</span><span class="p">,</span>
			 <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vaddr</span><span class="p">,</span>
			 <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctrl_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Must be called with fbdev-&gt;rqueue_mutex held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_change_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">+</span>
		 <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">();</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">setup_plane</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">channel_out</span><span class="p">,</span>
				 <span class="n">offset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span>
				 <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pos_y</span><span class="p">,</span>
				 <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">set_rotate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">set_rotate</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">set_scale</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">set_scale</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
				   <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
				   <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">out_width</span><span class="p">,</span>
				   <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">out_height</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * fbdev framework callbacks and the ioctl interface</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="cm">/* Called each time the omapfb device is opened */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">omapfb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/* Called when the omapfb device is closed. We make sure that any pending</span>
<span class="cm"> * gfx DMA operations are ended, before we return. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omapfb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Store a single color palette entry into a pseudo palette or the hardware</span>
<span class="cm"> * palette if one is available. For now we support only 16bpp and thus store</span>
<span class="cm"> * the entry only to the pseudo palette.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_setcolreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span>
			<span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">update_hw_pal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV422</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV420</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUY422</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_8BPP</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_4BPP</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_2BPP</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_CLUT_1BPP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">setcolreg</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">setcolreg</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span>
							<span class="n">transp</span><span class="p">,</span> <span class="n">update_hw_pal</span><span class="p">);</span>
		<span class="cm">/* Fallthrough */</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_RGB565</span>:
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_RGB444</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">pal</span><span class="p">;</span>
			<span class="n">pal</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
					<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
					<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			    <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_setcolreg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">transp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_setcmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_cmap</span> <span class="o">*</span><span class="n">cmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="o">*</span><span class="n">transp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">trans</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">red</span>     <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">green</span>   <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">;</span>
	<span class="n">blue</span>    <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">;</span>
	<span class="n">transp</span>  <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">;</span>
	<span class="n">index</span>   <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">transp</span><span class="p">)</span>
			<span class="n">trans</span> <span class="o">=</span> <span class="o">*</span><span class="n">transp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">_setcolreg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">red</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">green</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">blue</span><span class="o">++</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span>
				<span class="n">count</span> <span class="o">==</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">omapfb_update_full_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAPFB_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
				<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">();</span>
			<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">);</span>
			<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OMAPFB_ACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_update_mode</span><span class="p">()</span> <span class="o">==</span>
					<span class="n">OMAPFB_MANUAL_UPDATE</span><span class="p">)</span>
				<span class="n">do_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OMAPFB_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">();</span>
			<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OMAPFB_SUSPENDED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">do_update</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_update_full_screen</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">();</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set fb_info.fix fields and also updates fbdev.</span>
<span class="cm"> * When calling this fb_info.var must be set up already.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_fb_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from_init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_mem_region</span> <span class="o">*</span><span class="n">rg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="n">rg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span>	<span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">from_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span>		<span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span>		<span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span>		<span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span>		<span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="cm">/* 12bpp is stored in 16 bits */</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span>		<span class="o">=</span> <span class="n">FB_ACCEL_OMAP1610</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_color_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV422</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUV420</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_COLOR_YUY422</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_CLUT_1BPP</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_CLUT_2BPP</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_CLUT_4BPP</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_CLUT_8BPP</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_RGB444</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">OMAPFB_COLOR_RGB565</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check the values in var against our capabilities and in case of out of</span>
<span class="cm"> * bound values try to adjust them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_fb_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">max_frame_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">line_size</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">xres_min</span><span class="p">,</span> <span class="n">xres_max</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">yres_min</span><span class="p">,</span> <span class="n">yres_max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcd_panel</span> <span class="o">*</span><span class="n">panel</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_color_mode</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAPFB_COLOR_RGB444</span><span class="p">)</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">180</span>:
		<span class="n">xres_min</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_XRES_MIN</span><span class="p">;</span>
		<span class="n">xres_max</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="n">yres_min</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_YRES_MIN</span><span class="p">;</span>
		<span class="n">yres_max</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">90</span>:
	<span class="k">case</span> <span class="mi">270</span>:
		<span class="n">xres_min</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_YRES_MIN</span><span class="p">;</span>
		<span class="n">xres_max</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
		<span class="n">yres_min</span> <span class="o">=</span> <span class="n">OMAPFB_PLANE_XRES_MIN</span><span class="p">;</span>
		<span class="n">yres_max</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">xres_min</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres_min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">yres_min</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres_min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">xres_max</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres_max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">yres_max</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">line_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line_size</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">max_frame_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Try to keep yres_virtual first */</span>
		<span class="n">line_size</span> <span class="o">=</span> <span class="n">max_frame_size</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">line_size</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Still doesn&#39;t fit. Shrink yres_virtual too */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
			<span class="n">line_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max_frame_size</span> <span class="o">/</span> <span class="n">line_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Recheck this, as the virtual size changed. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">xres_min</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">yres_min</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">OMAPFB_COLOR_RGB444</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	 <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	 <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	 <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
						<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>  <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
						<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
						<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* pixclock in ps, the rest in pixclock */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span>		<span class="o">=</span> <span class="mi">10000000</span> <span class="o">/</span> <span class="p">(</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">hfp</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">hbp</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">vfp</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">vbp</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span>		<span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">hsw</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span>		<span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">vsw</span><span class="p">;</span>

	<span class="cm">/* TODO: get these from panel-&gt;config */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Set rotation (0, 90, 180, 270 degree), and switch to the new mode. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_rotate</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rotate</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rotate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">new_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">new_var</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">new_var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_var</span><span class="p">));</span>
		<span class="n">new_var</span><span class="o">-&gt;</span><span class="n">rotate</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_fb_var</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">new_var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">new_var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_var</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">new_var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_var</span><span class="p">));</span>
			<span class="n">ctrl_change_mode</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set new x,y offsets in the virtual display for the visible area and switch</span>
<span class="cm"> * to the new mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">new_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">new_var</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">new_var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_var</span><span class="p">));</span>
		<span class="n">new_var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">new_var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_fb_var</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">new_var</span><span class="p">))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">new_var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_var</span><span class="p">));</span>
			<span class="n">ctrl_change_mode</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set mirror to vertical axis and switch to the new mode. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_mirror</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mirror</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">mirror</span> <span class="o">=</span> <span class="n">mirror</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mirror</span> <span class="o">!=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mirror</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ctrl_change_mode</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check values in var, try to adjust them in case of out of bound values if</span>
<span class="cm"> * possible, or return error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">();</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">set_fb_var</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch to a new mode. The parameters for it has been check already by</span>
<span class="cm"> * omapfb_check_var.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">set_fb_fix</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ctrl_change_mode</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapfb_update_window_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">omapfb_update_window</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span>
				<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">callback_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">180</span>:
		<span class="n">xres</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">90</span>:
	<span class="k">case</span> <span class="mi">270</span>:
		<span class="n">xres</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">xres</span> <span class="o">||</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">yres</span> <span class="o">||</span>
	    <span class="n">win</span><span class="o">-&gt;</span><span class="n">out_x</span> <span class="o">&gt;</span> <span class="n">xres</span> <span class="o">||</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">out_y</span> <span class="o">&gt;</span> <span class="n">yres</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">update_window</span> <span class="o">||</span>
	    <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_update_mode</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAPFB_MANUAL_UPDATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">+</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">xres</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">+</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">yres</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">out_x</span> <span class="o">+</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">out_width</span> <span class="o">&gt;</span> <span class="n">xres</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">out_width</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">out_x</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">out_y</span> <span class="o">+</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">out_height</span> <span class="o">&gt;</span> <span class="n">yres</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">out_height</span> <span class="o">=</span> <span class="n">yres</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">out_y</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span> <span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">out_width</span> <span class="o">||</span> <span class="o">!</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">out_height</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">update_window</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapfb_update_window_async</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_update_win</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">omapfb_update_window</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omapfb_update_window_async</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_update_full_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_update_window</span> <span class="n">win</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">update_window</span> <span class="o">||</span>
	    <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_update_mode</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAPFB_MANUAL_UPDATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">win</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">out_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">out_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">out_width</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">out_height</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">win</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">update_window</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">win</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_setup_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omapfb_plane_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcd_panel</span> <span class="o">*</span><span class="n">panel</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_info</span> <span class="n">old_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pos_x</span> <span class="o">+</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">out_width</span> <span class="o">&gt;</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">||</span>
	    <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pos_y</span> <span class="o">+</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">out_height</span> <span class="o">&gt;</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This plane&#39;s memory was freed, can&#39;t enable it</span>
<span class="cm">		 * until it&#39;s reallocated.</span>
<span class="cm">		 */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">old_info</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ctrl_change_mode</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">old_info</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">enable_plane</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">old_info</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_query_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omapfb_plane_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_setup_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omapfb_mem_info</span> <span class="o">*</span><span class="n">mi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_mem_region</span> <span class="o">*</span><span class="n">rg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">setup_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OMAPFB_MEMTYPE_SDRAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">mi</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">||</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">new_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">new_var</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_size</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">u8</span>	      <span class="n">old_type</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">;</span>

		<span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">rg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * size == 0 is a special case, for which we</span>
<span class="cm">		 * don&#39;t check / adjust the screen parameters.</span>
<span class="cm">		 * This isn&#39;t a problem since the plane can&#39;t</span>
<span class="cm">		 * be reenabled unless its size is &gt; 0.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">new_var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_var</span><span class="p">));</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">set_fb_var</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">new_var</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span>
			<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">();</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">setup_mem</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Revert changes. */</span>
			<span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">old_size</span><span class="p">;</span>
			<span class="n">rg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">old_type</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rg</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">new_var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">));</span>
				<span class="n">set_fb_fix</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Set these explicitly to indicate that the</span>
<span class="cm">				 * plane memory is dealloce&#39;d, the other</span>
<span class="cm">				 * screen parameters in var / fix are invalid.</span>
<span class="cm">				 */</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
				<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_query_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omapfb_mem_info</span> <span class="o">*</span><span class="n">mi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_mem_region</span> <span class="o">*</span><span class="n">rg</span><span class="p">;</span>

	<span class="n">rg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mi</span><span class="p">));</span>
	<span class="n">mi</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">mi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_set_color_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">omapfb_color_key</span> <span class="o">*</span><span class="n">ck</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">set_color_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">set_color_key</span><span class="p">(</span><span class="n">ck</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_get_color_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">omapfb_color_key</span> <span class="o">*</span><span class="n">ck</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_color_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_color_key</span><span class="p">(</span><span class="n">ck</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">blocking_notifier_head</span> <span class="n">omapfb_client_list</span><span class="p">[</span><span class="n">OMAPFB_PLANE_NUM</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">notifier_inited</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_init_notifier</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OMAPFB_PLANE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">BLOCKING_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapfb_client_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omapfb_register_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_notifier_block</span> <span class="o">*</span><span class="n">omapfb_nb</span><span class="p">,</span>
				<span class="n">omapfb_notifier_callback_t</span> <span class="n">callback</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">callback_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">omapfb_nb</span><span class="o">-&gt;</span><span class="n">plane_idx</span> <span class="o">&gt;</span> <span class="n">OMAPFB_PLANE_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">notifier_inited</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omapfb_init_notifier</span><span class="p">();</span>
		<span class="n">notifier_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omapfb_nb</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">))</span><span class="n">callback</span><span class="p">;</span>
	<span class="n">omapfb_nb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">callback_data</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">omapfb_client_list</span><span class="p">[</span><span class="n">omapfb_nb</span><span class="o">-&gt;</span><span class="n">plane_idx</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">omapfb_nb</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omapfb_dev</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">omapfb_dev</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">omapfb_dev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bind_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omapfb_dev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bind_client</span><span class="p">(</span><span class="n">omapfb_nb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapfb_register_client</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omapfb_unregister_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_notifier_block</span> <span class="o">*</span><span class="n">omapfb_nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">omapfb_client_list</span><span class="p">[</span><span class="n">omapfb_nb</span><span class="o">-&gt;</span><span class="n">plane_idx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">omapfb_nb</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapfb_unregister_client</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omapfb_notify_clients</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">notifier_inited</span><span class="p">)</span>
		<span class="cm">/* no client registered yet */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OMAPFB_PLANE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapfb_client_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">event</span><span class="p">,</span>
				    <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapfb_notify_clients</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_set_update_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">omapfb_update_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">set_update_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">omapfb_update_mode</span> <span class="nf">omapfb_get_update_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_update_mode</span><span class="p">();</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_get_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">omapfb_caps</span> <span class="o">*</span><span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">caps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">caps</span><span class="p">));</span>
	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_caps</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">caps</span><span class="p">);</span>
	<span class="n">caps</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">get_caps</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* For lcd testing */</span>
<span class="kt">void</span> <span class="nf">omapfb_write_first_pixel</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pixval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">pixval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">get_update_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">OMAPFB_MANUAL_UPDATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_update_window</span> <span class="n">win</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">win</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">win</span><span class="p">));</span>
		<span class="n">win</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">win</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">win</span><span class="p">.</span><span class="n">out_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">win</span><span class="p">.</span><span class="n">out_height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">update_window</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">win</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omapfb_write_first_pixel</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Ioctl interface. Part of the kernel mode frame buffer API is duplicated</span>
<span class="cm"> * here to be accessible by user mode code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span>	<span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_ops</span>		<span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_update_window</span>	<span class="n">update_window</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omapfb_plane_info</span>	<span class="n">plane_info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omapfb_mem_info</span>		<span class="n">mem_info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omapfb_color_key</span>		<span class="n">color_key</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">omapfb_update_mode</span>		<span class="n">update_mode</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omapfb_caps</span>		<span class="n">caps</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mirror</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">plane_out</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">enable_plane</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAPFB_MIRROR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">mirror</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">omapfb_mirror</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">mirror</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_SYNC_GFX</span>:
		<span class="n">omapfb_sync</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_VSYNC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_SET_UPDATE_MODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">update_mode</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_set_update_mode</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">update_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_GET_UPDATE_MODE</span>:
		<span class="n">p</span><span class="p">.</span><span class="n">update_mode</span> <span class="o">=</span> <span class="n">omapfb_get_update_mode</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">update_mode</span><span class="p">,</span>
					<span class="p">(</span><span class="k">enum</span> <span class="n">omapfb_update_mode</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_UPDATE_WINDOW_OLD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">update_window</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_update_window_old</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omapfb_update_window</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">update_window</span><span class="p">;</span>
			<span class="n">u</span><span class="o">-&gt;</span><span class="n">out_x</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
			<span class="n">u</span><span class="o">-&gt;</span><span class="n">out_y</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
			<span class="n">u</span><span class="o">-&gt;</span><span class="n">out_width</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
			<span class="n">u</span><span class="o">-&gt;</span><span class="n">out_height</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_update_win</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_UPDATE_WINDOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">update_window</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">update_window</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_update_win</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">update_window</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_SETUP_PLANE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">plane_info</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">plane_info</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_setup_plane</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">plane_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_QUERY_PLANE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_query_plane</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">plane_info</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">plane_info</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">plane_info</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_SETUP_MEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">mem_info</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">mem_info</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_setup_mem</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">mem_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_QUERY_MEM</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_query_mem</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">mem_info</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">mem_info</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">mem_info</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_SET_COLOR_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">color_key</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">color_key</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_set_color_key</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">color_key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_GET_COLOR_KEY</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_get_color_key</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">color_key</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">color_key</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">color_key</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_GET_CAPS</span>:
		<span class="n">omapfb_get_caps</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">caps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">caps</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">caps</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAPFB_LCD_TEST</span>:
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">test_num</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">test_num</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">run_test</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">run_test</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">,</span> <span class="n">test_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OMAPFB_CTRL_TEST</span>:
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">test_num</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">test_num</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">run_test</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">run_test</span><span class="p">(</span><span class="n">test_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">omapfb_rqueue_lock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="n">omapfb_rqueue_unlock</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback table for the frame buffer framework. Some of these pointers</span>
<span class="cm"> * will be changed according to the current setting of fb_info-&gt;accel_flags.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">omapfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>        <span class="o">=</span> <span class="n">omapfb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>     <span class="o">=</span> <span class="n">omapfb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">omapfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcmap</span>	<span class="o">=</span> <span class="n">omapfb_setcmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>       <span class="o">=</span> <span class="n">omapfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">omapfb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">omapfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">omapfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_rotate</span>	<span class="o">=</span> <span class="n">omapfb_rotate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">omapfb_pan_display</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Sysfs interface</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="cm">/* omapfbX sysfs entries */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">omapfb_show_caps_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">plane</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_caps</span> <span class="n">caps</span><span class="p">;</span>

	<span class="n">plane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">plane</span> <span class="o">&lt;</span> <span class="n">OMAPFB_PLANE_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omapfb_get_caps</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;plane#%d %#010x %#010x %#010x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">plane</span><span class="p">,</span> <span class="n">caps</span><span class="p">.</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">caps</span><span class="p">.</span><span class="n">plane_color</span><span class="p">,</span> <span class="n">caps</span><span class="p">.</span><span class="n">wnd_color</span><span class="p">);</span>
		<span class="n">plane</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">omapfb_show_caps_text</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omapfb_caps</span> <span class="n">caps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">plane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">plane</span> <span class="o">&lt;</span> <span class="n">OMAPFB_PLANE_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omapfb_get_caps</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
				 <span class="s">&quot;plane#%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ctrl_caps</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_caps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">caps</span><span class="p">.</span><span class="n">ctrl</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl_caps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
				 <span class="s">&quot; plane colors:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">color_caps</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">color_caps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">caps</span><span class="p">.</span><span class="n">plane_color</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot;  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">color_caps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
				 <span class="s">&quot; window colors:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">color_caps</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">color_caps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">caps</span><span class="p">.</span><span class="n">wnd_color</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot;  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">color_caps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">plane</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">caps_num</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">omapfb_show_caps_num</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">caps_text</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">omapfb_show_caps_text</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* panel sysfs entries */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">omapfb_show_panel_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">omapfb_show_bklight_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">get_bklight_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">get_bklight_level</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">omapfb_store_bklight_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">set_bklight_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%10d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">set_bklight_level</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">,</span>
							    <span class="n">level</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">omapfb_show_bklight_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">get_bklight_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">get_bklight_max</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_panel_name</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">omapfb_show_panel_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">backlight_level</span><span class="p">,</span> <span class="mo">0664</span><span class="p">,</span>
		   <span class="n">omapfb_show_bklight_level</span><span class="p">,</span> <span class="n">omapfb_store_bklight_level</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">backlight_max</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">omapfb_show_bklight_max</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">panel_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_panel_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_backlight_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_backlight_max</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">panel_attr_grp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;panel&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">panel_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ctrl sysfs entries */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">omapfb_show_ctrl_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_ctrl_name</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">omapfb_show_ctrl_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ctrl_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ctrl_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">ctrl_attr_grp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;ctrl&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ctrl_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_register_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_caps_num</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_caps_text</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">panel_attr_grp</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl_attr_grp</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail3:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">panel_attr_grp</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_caps_text</span><span class="p">);</span>
<span class="nl">fail1:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_caps_num</span><span class="p">);</span>
<span class="nl">fail0:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register sysfs interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_unregister_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl_attr_grp</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">panel_attr_grp</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_caps_num</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_caps_text</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * LDM callbacks</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="cm">/* Initialize system fb_info object and set the default video mode.</span>
<span class="cm"> * The frame buffer memory already allocated by lcddma_init</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fbinfo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span>	<span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span>	<span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omapfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span>  <span class="o">=</span> <span class="n">def_accel</span> <span class="o">?</span> <span class="n">FB_ACCELF_TEXT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">def_vxres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">def_vyres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">def_vxres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">def_vyres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span>	  <span class="o">=</span> <span class="n">def_rotate</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>

	<span class="n">set_fb_var</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="n">set_fb_fix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate color map memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release the fb_info object */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fbinfo_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">planes_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">fbinfo_cleanup</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">planes_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omapfb_plane_struct</span> <span class="o">*</span><span class="n">plane</span><span class="p">;</span>
		<span class="n">fbi</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_plane_struct</span><span class="p">),</span>
					<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to allocate memory for plane info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">planes_cleanup</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plane</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">fbdev</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">def_mirror</span><span class="p">;</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fbi</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">fbinfo_init</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">fbi</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">planes_cleanup</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">out_width</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">out_height</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free driver resources. Can be called to rollback an aborted initialization</span>
<span class="cm"> * sequence.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omapfb_free_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAPFB_ACTIVE</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">omapfb_unregister_sysfs</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">omapfb_set_update_mode</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">OMAPFB_UPDATE_DISABLED</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">planes_cleanup</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ctrl_cleanup</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* nothing to free */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_find_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_platform_data</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">ctrl_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;internal&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">int_ctrl</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ctrls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ctrl %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ctrl %s not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_required_callbacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define _C(x) (fbdev-&gt;ctrl-&gt;x != NULL)</span>
<span class="cp">#define _P(x) (fbdev-&gt;panel-&gt;x != NULL)</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_C</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_C</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_C</span><span class="p">(</span><span class="n">get_caps</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">_C</span><span class="p">(</span><span class="n">set_update_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_C</span><span class="p">(</span><span class="n">setup_plane</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_C</span><span class="p">(</span><span class="n">enable_plane</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">_P</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_P</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_P</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_P</span><span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">_P</span><span class="p">(</span><span class="n">get_caps</span><span class="p">)));</span>
<span class="cp">#undef _P</span>
<span class="cp">#undef _C</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by LDM binding to probe and attach a new device.</span>
<span class="cm"> * Initialization sequence:</span>
<span class="cm"> *   1. allocate system omapfb_device structure</span>
<span class="cm"> *   2. select controller type according to platform configuration</span>
<span class="cm"> *      init LCD panel</span>
<span class="cm"> *   3. init LCD controller and LCD DMA</span>
<span class="cm"> *   4. init system fb_info structure for all planes</span>
<span class="cm"> *   5. setup video mode for first plane and enable it</span>
<span class="cm"> *   6. enable LCD panel</span>
<span class="cm"> *   7. register sysfs attributes</span>
<span class="cm"> *   OMAPFB_ACTIVE: register system fb_info structure for all planes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_do_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">lcd_panel</span> <span class="o">*</span><span class="n">panel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span>	<span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">init_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">phz</span><span class="p">,</span> <span class="n">hhz</span><span class="p">,</span> <span class="n">vhz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">vram</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probed for an unknown device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;missing platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omapfb_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unable to allocate memory for device info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_state</span><span class="o">++</span><span class="p">;</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span> <span class="o">=</span> <span class="n">panel</span><span class="p">;</span>
	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dssdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omapdss_device</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">fbdev</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">rqueue_mutex</span><span class="p">);</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">int_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap1_int_ctrl</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FB_OMAP_LCDC_EXTERNAL</span>
	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ext_if</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap1_ext_if</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omapfb_find_ctrl</span><span class="p">(</span><span class="n">fbdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;LCD controller not found, board not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">,</span> <span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;omapfb: configured for panel %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">def_vxres</span> <span class="o">=</span> <span class="n">def_vxres</span> <span class="o">?</span> <span class="n">def_vxres</span> <span class="o">:</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">;</span>
	<span class="n">def_vyres</span> <span class="o">=</span> <span class="n">def_vyres</span> <span class="o">?</span> <span class="n">def_vyres</span> <span class="o">:</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">;</span>

	<span class="n">init_state</span><span class="o">++</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ctrl_init</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omapfb_ops</span><span class="p">.</span><span class="n">fb_mmap</span> <span class="o">=</span> <span class="n">omapfb_mmap</span><span class="p">;</span>
	<span class="n">init_state</span><span class="o">++</span><span class="p">;</span>

	<span class="n">check_required_callbacks</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">planes_init</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="n">init_state</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_OMAP_DMA_TUNE</span>
	<span class="cm">/* Set DMA priority for EMIFF access to highest */</span>
	<span class="n">omap_set_dma_priority</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">OMAP_DMA_PORT_EMIFF</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ctrl_change_mode</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mode setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* GFX plane is enabled by default */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">enable_plane</span><span class="p">(</span><span class="n">OMAPFB_PLANE_GFX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">omapfb_set_update_mode</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">manual_update</span> <span class="o">?</span>
				   <span class="n">OMAPFB_MANUAL_UPDATE</span> <span class="o">:</span> <span class="n">OMAPFB_AUTO_UPDATE</span><span class="p">);</span>
	<span class="n">init_state</span><span class="o">++</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="n">init_state</span><span class="o">++</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">omapfb_register_sysfs</span><span class="p">(</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="n">init_state</span><span class="o">++</span><span class="p">;</span>

	<span class="n">vram</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;registering framebuffer %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vram</span> <span class="o">+=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OMAPFB_ACTIVE</span><span class="p">;</span>

	<span class="n">panel</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">panel</span><span class="p">;</span>
	<span class="n">phz</span> <span class="o">=</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">hhz</span> <span class="o">=</span> <span class="n">phz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">hfp</span> <span class="o">+</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">+</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">hbp</span> <span class="o">+</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">hsw</span><span class="p">);</span>
	<span class="n">vhz</span> <span class="o">=</span> <span class="n">hhz</span> <span class="o">/</span> <span class="p">(</span><span class="n">panel</span><span class="o">-&gt;</span><span class="n">vfp</span> <span class="o">+</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">+</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">vbp</span> <span class="o">+</span> <span class="n">panel</span><span class="o">-&gt;</span><span class="n">vsw</span><span class="p">);</span>

	<span class="n">omapfb_dev</span> <span class="o">=</span> <span class="n">fbdev</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;omapfb: Framebuffer initialized. Total vram %lu planes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vram</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">mem_desc</span><span class="p">.</span><span class="n">region_cnt</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;omapfb: Pixclock %lu kHz hfreq %lu.%lu kHz &quot;</span>
			<span class="s">&quot;vfreq %lu.%lu Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">hhz</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">hhz</span> <span class="o">%</span> <span class="mi">10</span><span class="p">,</span> <span class="n">vhz</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">vhz</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">omapfb_free_resources</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">init_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fbdev_pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapdss_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t register omapdss device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Delay actual initialization until the LCD is registered */</span>
	<span class="n">fbdev_pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev_panel</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omapfb_do_probe</span><span class="p">(</span><span class="n">fbdev_pdev</span><span class="p">,</span> <span class="n">fbdev_panel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omapfb_register_panel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_panel</span> <span class="o">*</span><span class="n">panel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fbdev_panel</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">fbdev_panel</span> <span class="o">=</span> <span class="n">panel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev_pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omapfb_do_probe</span><span class="p">(</span><span class="n">fbdev_pdev</span><span class="p">,</span> <span class="n">fbdev_panel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called when the device is being detached from the driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">omapfb_state</span> <span class="n">saved_state</span> <span class="o">=</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="cm">/* FIXME: wait till completion of pending events */</span>

	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OMAPFB_DISABLED</span><span class="p">;</span>
	<span class="n">omapfb_free_resources</span><span class="p">(</span><span class="n">fbdev</span><span class="p">,</span> <span class="n">saved_state</span><span class="p">);</span>

	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapdss_device</span><span class="p">);</span>
	<span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">dssdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PM suspend */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omapfb_blank</span><span class="p">(</span><span class="n">FB_BLANK_POWERDOWN</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PM resume */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omapfb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omapfb_device</span> <span class="o">*</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omapfb_blank</span><span class="p">(</span><span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omapfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">omapfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">omapfb_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">omapfb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">omapfb_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifndef MODULE</span>

<span class="cm">/* Process kernel command line parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omapfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;omapfb: options %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;accel&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">def_accel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vram:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vram</span><span class="p">;</span>
			<span class="n">vram</span> <span class="o">=</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">suffix</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">suffix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;\0&#39;</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
				<span class="n">vram</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>
				<span class="cm">/* Fall through */</span>
			<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
				<span class="n">vram</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;omapfb: invalid vram suffix %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">suffix</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">def_vram</span><span class="p">[</span><span class="n">def_vram_cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vram</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vxres:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">def_vxres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vyres:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">def_vyres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;rotate:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">def_rotate</span> <span class="o">=</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mirror:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">def_mirror</span> <span class="o">=</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;manual_update&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
			<span class="n">manual_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;omapfb: invalid option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* Register both the driver and the device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omapfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;omapfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">omapfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Register the driver with LDM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapfb_driver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to register omapfb driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">omapfb_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omapfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">accel</span><span class="p">,</span> <span class="n">def_accel</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">module_param_array_named</span><span class="p">(</span><span class="n">vram</span><span class="p">,</span> <span class="n">def_vram</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">def_vram_cnt</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">vxres</span><span class="p">,</span> <span class="n">def_vxres</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">vyres</span><span class="p">,</span> <span class="n">def_vyres</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">rotate</span><span class="p">,</span> <span class="n">def_rotate</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">def_mirror</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">manual_update</span><span class="p">,</span> <span class="n">manual_update</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">omapfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">omapfb_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TI OMAP framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Imre Deak &lt;imre.deak@nokia.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
