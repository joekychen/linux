<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › pm2fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pm2fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Permedia2 framebuffer driver.</span>
<span class="cm"> *</span>
<span class="cm"> * 2.5/2.6 driver:</span>
<span class="cm"> * Copyright (c) 2003 Jim Hague (jim.hague@acm.org)</span>
<span class="cm"> *</span>
<span class="cm"> * based on 2.4 driver:</span>
<span class="cm"> * Copyright (c) 1998-2000 Ilario Nardinocchi (nardinoc@CS.UniBO.IT)</span>
<span class="cm"> * Copyright (c) 1999 Jakub Jelinek (jakub@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * and additional input from James Simmon&#39;s port of Hannu Mallat&#39;s tdfx</span>
<span class="cm"> * driver.</span>
<span class="cm"> *</span>
<span class="cm"> * I have a Creative Graphics Blaster Exxtreme card - pm2fb on x86. I</span>
<span class="cm"> * have no access to other pm2fb implementations. Sparc (and thus</span>
<span class="cm"> * hopefully other big-endian) devices now work, thanks to a lot of</span>
<span class="cm"> * testing work by Ron Murray. I have no access to CVision hardware,</span>
<span class="cm"> * and therefore for now I am omitting the CVision code.</span>
<span class="cm"> *</span>
<span class="cm"> * Multiple boards support has been on the TODO list for ages.</span>
<span class="cm"> * Don&#39;t expect this to change.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;video/permedia2.h&gt;</span>
<span class="cp">#include &lt;video/cvisionppc.h&gt;</span>

<span class="cp">#if !defined(__LITTLE_ENDIAN) &amp;&amp; !defined(__BIG_ENDIAN)</span>
<span class="cp">#error	&quot;The endianness of the target host has not been defined.&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(CONFIG_PCI)</span>
<span class="cp">#error &quot;Only generic PCI cards supported.&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#undef PM2FB_MASTER_DEBUG</span>
<span class="cp">#ifdef PM2FB_MASTER_DEBUG</span>
<span class="cp">#define DPRINTK(a, b...)	\</span>
<span class="cp">	printk(KERN_DEBUG &quot;pm2fb: %s: &quot; a, __func__ , ## b)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(a, b...)</span>
<span class="cp">#endif</span>

<span class="cp">#define PM2_PIXMAP_SIZE	(1600 * 4)</span>

<span class="cm">/*</span>
<span class="cm"> * Driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwcursor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The XFree GLINT driver will (I think to implement hardware cursor</span>
<span class="cm"> * support on TVP4010 and similar where there is no RAMDAC - see</span>
<span class="cm"> * comment in set_video) always request +ve sync regardless of what</span>
<span class="cm"> * the mode requires. This screws me because I have a Sun</span>
<span class="cm"> * fixed-frequency monitor which absolutely has to have -ve sync. So</span>
<span class="cm"> * these flags allow the user to specify that requests for +ve sync</span>
<span class="cm"> * should be silently turned in -ve sync.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">lowhsync</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">lowvsync</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">noaccel</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="cm">/* mtrr option */</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nomtrr</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * The hardware state of the graphics card that isn&#39;t part of the</span>
<span class="cm"> * screeninfo.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pm2fb_par</span>
<span class="p">{</span>
	<span class="n">pm2type_t</span>	<span class="n">type</span><span class="p">;</span>		<span class="cm">/* Board type */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">v_regs</span><span class="p">;</span><span class="cm">/* virtual address of p_regs */</span>
	<span class="n">u32</span>		<span class="n">memclock</span><span class="p">;</span>	<span class="cm">/* memclock */</span>
	<span class="n">u32</span>		<span class="n">video</span><span class="p">;</span>		<span class="cm">/* video flags before blanking */</span>
	<span class="n">u32</span>		<span class="n">mem_config</span><span class="p">;</span>	<span class="cm">/* MemConfig reg at probe */</span>
	<span class="n">u32</span>		<span class="n">mem_control</span><span class="p">;</span>	<span class="cm">/* MemControl reg at probe */</span>
	<span class="n">u32</span>		<span class="n">boot_address</span><span class="p">;</span>	<span class="cm">/* BootAddress reg at probe */</span>
	<span class="n">u32</span>		<span class="n">palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span>		<span class="n">mtrr_handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Here we define the default structs fb_fix_screeninfo and fb_var_screeninfo</span>
<span class="cm"> * if we don&#39;t use modedb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">pm2fb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span>		<span class="s">&quot;&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>		<span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span>	<span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span>	<span class="n">FB_ACCEL_3DLABS_PERMEDIA2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Default video mode. In case the modedb doesn&#39;t work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">pm2fb_var</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* &quot;640x480, 8 bpp @ 60 Hz */</span>
	<span class="p">.</span><span class="n">xres</span> <span class="o">=</span>			<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> <span class="o">=</span>			<span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span>		<span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span>		<span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span>	<span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span> <span class="o">=</span>			<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span> <span class="o">=</span>			<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">green</span> <span class="o">=</span>		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span>		<span class="n">FB_ACTIVATE_NOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span> <span class="o">=</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span> <span class="o">=</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span>		<span class="mi">39721</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span>		<span class="mi">40</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span>		<span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span>		<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span>		<span class="mi">11</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span>		<span class="mi">96</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span>		<span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Utility functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">pm2_RD</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fb_readl</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pm2_WR</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">pm2_RDAC_RD</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_WRITE_ADDRESS</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">pm2_RD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_INDEXED_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">pm2v_RDAC_RD</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_LOW</span><span class="p">,</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">pm2_RD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">PM2VR_RD_INDEXED_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pm2_RDAC_WR</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_WRITE_ADDRESS</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_INDEXED_DATA</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pm2v_RDAC_WR</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_LOW</span><span class="p">,</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEXED_DATA</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_PM2_FIFO_DISCONNECT</span>
<span class="cp">#define WAIT_FIFO(p, a)</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">WAIT_FIFO</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pm2_RD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_IN_FIFO_SPACE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * partial products for the supported horizontal resolutions.</span>
<span class="cm"> */</span>
<span class="cp">#define PACKPP(p0, p1, p2)	(((p2) &lt;&lt; 6) | ((p1) &lt;&lt; 3) | (p0))</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pp</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pp_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">32</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">96</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">128</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">160</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">224</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">256</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">288</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">320</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">384</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">416</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">448</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">512</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">544</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">576</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">640</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">768</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">800</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">832</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">896</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">1024</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1056</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">1088</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1152</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">1280</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1536</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">1568</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1600</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">1664</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1792</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2048</span><span class="p">,</span>	<span class="n">PACKPP</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">partprod</span><span class="p">(</span><span class="n">u32</span> <span class="n">xres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pp_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">&amp;&amp;</span> <span class="n">pp_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">!=</span> <span class="n">xres</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;invalid width %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xres</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pp_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">to3264</span><span class="p">(</span><span class="n">u32</span> <span class="n">timing</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is64</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">timing</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">timing</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">timing</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is64</span><span class="p">)</span>
		<span class="n">timing</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">timing</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm2_mnp</span><span class="p">(</span><span class="n">u32</span> <span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nn</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">curr</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">m</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">PM2_REFERENCE_CLOCK</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">n</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="mi">150000</span> <span class="o">&amp;&amp;</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="mi">300000</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">f</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk</span> <span class="o">&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="o">?</span> <span class="n">clk</span> <span class="o">-</span> <span class="n">f</span> <span class="o">:</span> <span class="n">f</span> <span class="o">-</span> <span class="n">clk</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">delta</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
						<span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
						<span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
						<span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm2v_mnp</span><span class="p">(</span><span class="n">u32</span> <span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nn</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">PM2_REFERENCE_CLOCK</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">m</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">&gt;</span> <span class="n">f</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">&amp;&amp;</span> <span class="n">clk</span> <span class="o">&lt;</span> <span class="n">f</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk</span> <span class="o">&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="o">?</span> <span class="n">clk</span> <span class="o">-</span> <span class="n">f</span> <span class="o">:</span> <span class="n">f</span> <span class="o">-</span> <span class="n">clk</span><span class="p">;</span>
					<span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
					<span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
					<span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_WRITE_ADDRESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PM2_TYPE_PERMEDIA2V</span><span class="p">)</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RESET_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pm2_RD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RESET_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM2F_BEING_RESET</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_FB_PM2_FIFO_DISCONNECT</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;FIFO disconnect enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FIFO_DISCON</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/* Restore stashed memory config information from probe */</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_MEM_CONTROL</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mem_control</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_BOOT_ADDRESS</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">boot_address</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_MEM_CONFIG</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mem_config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">53</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_CHIP_CONFIG</span><span class="p">,</span> <span class="n">pm2_RD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_CHIP_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">PM2F_VGA_ENABLE</span> <span class="o">|</span> <span class="n">PM2F_VGA_FIXED</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_BYPASS_WRITE_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FRAMEBUFFER_WRITE_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FIFO_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_APERTURE_ONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_APERTURE_TWO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RASTERIZER_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_DELTA_MODE</span><span class="p">,</span> <span class="n">PM2F_DELTA_ORDER_RGB</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_LB_READ_FORMAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_LB_WRITE_FORMAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_LB_READ_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_LB_SOURCE_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FB_SOURCE_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FB_PIXEL_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FB_WINDOW_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_LB_WINDOW_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FB_SOFT_WRITE_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FB_HARD_WRITE_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">0L</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FB_READ_PIXEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_DITHER_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_AREA_STIPPLE_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_DEPTH_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_STENCIL_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_TEXTURE_ADDRESS_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_TEXTURE_READ_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_TEXEL_LUT_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_YUV_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_COLOR_DDA_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_TEXTURE_COLOR_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FOG_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_ALPHA_BLEND_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_LOGICAL_OP_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_STATISTICS_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_SCISSOR_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_FILTER_MODE</span><span class="p">,</span> <span class="n">PM2F_SYNCHRONIZATION</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PIXEL_MASK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2</span>:
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_MODE_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* no overlay */</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_CURSOR_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_MISC_CONTROL</span><span class="p">,</span> <span class="n">PM2F_RD_PALETTE_WIDTH_8</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_COLOR_KEY_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_OVERLAY_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_RED_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_GREEN_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_BLUE_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2V</span>:
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2VI_RD_MISC_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* 8bit */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_aperture</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The hardware is little-endian. When used in big-endian</span>
<span class="cm">	 * hosts, the on-chip aperture settings are used where</span>
<span class="cm">	 * possible to translate from host to card byte order.</span>
<span class="cm">	 */</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#ifdef __LITTLE_ENDIAN</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_APERTURE_ONE</span><span class="p">,</span> <span class="n">PM2F_APERTURE_STANDARD</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">24</span>:	<span class="cm">/* RGB-&gt;BGR */</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can&#39;t use the aperture to translate host to</span>
<span class="cm">		 * card byte order here, so we switch to BGR mode</span>
<span class="cm">		 * in pm2fb_set_par().</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="mi">8</span>:		<span class="cm">/* B-&gt;B */</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_APERTURE_ONE</span><span class="p">,</span> <span class="n">PM2F_APERTURE_STANDARD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:	<span class="cm">/* HL-&gt;LH */</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_APERTURE_ONE</span><span class="p">,</span> <span class="n">PM2F_APERTURE_HALFWORDSWAP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:	<span class="cm">/* RGBA-&gt;ABGR */</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_APERTURE_ONE</span><span class="p">,</span> <span class="n">PM2F_APERTURE_BYTESWAP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* We don&#39;t use aperture two, so this may be superflous */</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_APERTURE_TWO</span><span class="p">,</span> <span class="n">PM2F_APERTURE_STANDARD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_color</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regno</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_WRITE_ADDRESS</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_DATA</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_DATA</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_DATA</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_memclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2V</span>:
		<span class="n">pm2v_mnp</span><span class="p">(</span><span class="n">clk</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="n">PM2VI_RD_MCLK_CONTROL</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_MCLK_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_MCLK_PRESCALE</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_MCLK_FEEDBACK</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_MCLK_POSTSCALE</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_MCLK_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pm2v_RDAC_RD</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_MCLK_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2</span>:
		<span class="n">pm2_mnp</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_MEMORY_CLOCK_3</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_MEMORY_CLOCK_1</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_MEMORY_CLOCK_2</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_MEMORY_CLOCK_3</span><span class="p">,</span> <span class="mi">8</span><span class="o">|</span><span class="n">p</span><span class="p">);</span>
		<span class="n">pm2_RDAC_RD</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_MEMORY_CLOCK_STATUS</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pm2_RD</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_INDEXED_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM2F_PLL_LOCKED</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pixclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2</span>:
		<span class="n">pm2_mnp</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_PIXEL_CLOCK_A3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_PIXEL_CLOCK_A1</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_PIXEL_CLOCK_A2</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_PIXEL_CLOCK_A3</span><span class="p">,</span> <span class="mi">8</span><span class="o">|</span><span class="n">p</span><span class="p">);</span>
		<span class="n">pm2_RDAC_RD</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_PIXEL_CLOCK_STATUS</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pm2_RD</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_INDEXED_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM2F_PLL_LOCKED</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2V</span>:
		<span class="n">pm2v_mnp</span><span class="p">(</span><span class="n">clk</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="n">PM2VI_RD_CLK0_PRESCALE</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CLK0_PRESCALE</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CLK0_FEEDBACK</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CLK0_POSTSCALE</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">video</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vsync</span> <span class="o">=</span> <span class="n">video</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;video = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">video</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The hardware cursor needs +vsync to recognise vert retrace.</span>
<span class="cm">	 * We may not be using the hardware cursor, but the X Glint</span>
<span class="cm">	 * driver may well. So always set +hsync/+vsync and then set</span>
<span class="cm">	 * the RAMDAC to invert the sync if necessary.</span>
<span class="cm">	 */</span>
	<span class="n">vsync</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM2F_HSYNC_MASK</span> <span class="o">|</span> <span class="n">PM2F_VSYNC_MASK</span><span class="p">);</span>
	<span class="n">vsync</span> <span class="o">|=</span> <span class="n">PM2F_HSYNC_ACT_HIGH</span> <span class="o">|</span> <span class="n">PM2F_VSYNC_ACT_HIGH</span><span class="p">;</span>

	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_VIDEO_CONTROL</span><span class="p">,</span> <span class="n">vsync</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">PM2F_RD_PALETTE_WIDTH_8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">video</span> <span class="o">&amp;</span> <span class="n">PM2F_HSYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PM2F_HSYNC_ACT_LOW</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* invert hsync */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">video</span> <span class="o">&amp;</span> <span class="n">PM2F_VSYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PM2F_VSYNC_ACT_LOW</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* invert vsync */</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2I_RD_MISC_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2V</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">video</span> <span class="o">&amp;</span> <span class="n">PM2F_HSYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PM2F_HSYNC_ACT_LOW</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* invert hsync */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">video</span> <span class="o">&amp;</span> <span class="n">PM2F_VSYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PM2F_VSYNC_ACT_LOW</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* invert vsync */</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2VI_RD_SYNC_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	pm2fb_check_var - Optional function. Validates a var passed in.</span>
<span class="cm"> *	@var: frame buffer variable screen structure</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *	Checks to see if the hardware supports the state requested by</span>
<span class="cm"> *	var passed in.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lpitch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">8</span>  <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">24</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;depth not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;virtual x resolution != &quot;</span>
			<span class="s">&quot;physical x resolution not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;virtual y resolution &lt; &quot;</span>
			<span class="s">&quot;physical y resolution not possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* permedia cannot blit over 2048 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="mi">2047</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">2047</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;xoffset not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;interlace not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span> <span class="cm">/* could sometimes be 8 */</span>
	<span class="n">lpitch</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">320</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="mi">1600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;width not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">1200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;height not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpitch</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no memory for screen (%ux%ux%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PM2_MAX_PIXCLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pixclock too high (%ldKHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	  <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t mmap if this is on */</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Checking graphics mode at %dx%d depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pm2fb_set_par - Alters the hardware state.</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *	Using the fb_var_screeninfo in fb_info we set the resolution of the</span>
<span class="cm"> *	this particular framebuffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsstart</span><span class="p">,</span> <span class="n">hsend</span><span class="p">,</span> <span class="n">hbend</span><span class="p">,</span> <span class="n">htotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vsstart</span><span class="p">,</span> <span class="n">vsend</span><span class="p">,</span> <span class="n">vbend</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">video</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clrmode</span> <span class="o">=</span> <span class="n">PM2F_RD_COLOR_MODE_RGB</span> <span class="o">|</span> <span class="n">PM2F_RD_GUI_ACTIVE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txtmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pixsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clrformat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 8-bit DAC */</span>
	<span class="n">u32</span> <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data64</span><span class="p">;</span>

	<span class="n">reset_card</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">reset_config</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">clear_palette</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">memclock</span><span class="p">)</span>
		<span class="n">set_memclock</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">memclock</span><span class="p">);</span>

	<span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">data64</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PM2_TYPE_PERMEDIA2V</span><span class="p">;</span>

	<span class="n">pixclock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixclock</span> <span class="o">&gt;</span> <span class="n">PM2_MAX_PIXCLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pixclock too high (%uKHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixclock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsstart</span> <span class="o">=</span> <span class="n">to3264</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">data64</span><span class="p">);</span>
	<span class="n">hsend</span> <span class="o">=</span> <span class="n">hsstart</span> <span class="o">+</span> <span class="n">to3264</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">data64</span><span class="p">);</span>
	<span class="n">hbend</span> <span class="o">=</span> <span class="n">hsend</span> <span class="o">+</span> <span class="n">to3264</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">data64</span><span class="p">);</span>
	<span class="n">htotal</span> <span class="o">=</span> <span class="n">to3264</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">data64</span><span class="p">)</span> <span class="o">+</span> <span class="n">hbend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="o">:</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FIXME! */</span>
	<span class="n">vsend</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vbend</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">+</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">+</span> <span class="n">vbend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stride</span> <span class="o">=</span> <span class="n">to3264</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">to3264</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data64</span><span class="p">)</span>
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_DATA_64_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lowhsync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ignoring +hsync, using -hsync.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_HSYNC_ACT_LOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_HSYNC_ACT_HIGH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_HSYNC_ACT_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lowvsync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ignoring +vsync, using -vsync.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_VSYNC_ACT_LOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_VSYNC_ACT_HIGH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_VSYNC_ACT_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;interlaced not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_LINE_DOUBLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">)</span>
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_VIDEO_ENABLE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Settings calculated. Now write them out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PM2_TYPE_PERMEDIA2V</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_aperture</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_READ_PIXEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">clrformat</span> <span class="o">=</span> <span class="mh">0x2e</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_READ_PIXEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">clrmode</span> <span class="o">|=</span> <span class="n">PM2F_RD_TRUECOLOR</span> <span class="o">|</span> <span class="n">PM2F_RD_PIXELFORMAT_RGB565</span><span class="p">;</span>
		<span class="n">txtmap</span> <span class="o">=</span> <span class="n">PM2F_TEXTEL_SIZE_16</span><span class="p">;</span>
		<span class="n">pixsize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clrformat</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">misc</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_READ_PIXEL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">clrmode</span> <span class="o">|=</span> <span class="n">PM2F_RD_TRUECOLOR</span> <span class="o">|</span> <span class="n">PM2F_RD_PIXELFORMAT_RGBA8888</span><span class="p">;</span>
		<span class="n">txtmap</span> <span class="o">=</span> <span class="n">PM2F_TEXTEL_SIZE_32</span><span class="p">;</span>
		<span class="n">pixsize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">clrformat</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">misc</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_READ_PIXEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">clrmode</span> <span class="o">|=</span> <span class="n">PM2F_RD_TRUECOLOR</span> <span class="o">|</span> <span class="n">PM2F_RD_PIXELFORMAT_RGB888</span><span class="p">;</span>
		<span class="n">txtmap</span> <span class="o">=</span> <span class="n">PM2F_TEXTEL_SIZE_24</span><span class="p">;</span>
		<span class="n">pixsize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">clrformat</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">misc</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_WRITE_MODE</span><span class="p">,</span> <span class="n">PM2F_FB_WRITE_ENABLE</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_READ_MODE</span><span class="p">,</span> <span class="n">partprod</span><span class="p">(</span><span class="n">xres</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_LB_READ_MODE</span><span class="p">,</span> <span class="n">partprod</span><span class="p">(</span><span class="n">xres</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_TEXTURE_MAP_FORMAT</span><span class="p">,</span> <span class="n">txtmap</span> <span class="o">|</span> <span class="n">partprod</span><span class="p">(</span><span class="n">xres</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_H_TOTAL</span><span class="p">,</span> <span class="n">htotal</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_HS_START</span><span class="p">,</span> <span class="n">hsstart</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_HS_END</span><span class="p">,</span> <span class="n">hsend</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_HG_END</span><span class="p">,</span> <span class="n">hbend</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_HB_END</span><span class="p">,</span> <span class="n">hbend</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_V_TOTAL</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_VS_START</span><span class="p">,</span> <span class="n">vsstart</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_VS_END</span><span class="p">,</span> <span class="n">vsend</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_VB_END</span><span class="p">,</span> <span class="n">vbend</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCREEN_STRIDE</span><span class="p">,</span> <span class="n">stride</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_WINDOW_ORIGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCREEN_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">width</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCISSOR_MODE</span><span class="p">,</span> <span class="n">PM2F_SCREEN_SCISSOR_ENABLE</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCREEN_BASE</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">set_video</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">video</span><span class="p">);</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2</span>:
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_COLOR_MODE</span><span class="p">,</span> <span class="n">clrmode</span><span class="p">);</span>
		<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_COLOR_KEY_CONTROL</span><span class="p">,</span>
				<span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">PM2F_COLOR_KEY_TEST_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2_TYPE_PERMEDIA2V</span>:
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_DAC_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_PIXEL_SIZE</span><span class="p">,</span> <span class="n">pixsize</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_COLOR_FORMAT</span><span class="p">,</span> <span class="n">clrformat</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_MISC_CONTROL</span><span class="p">,</span> <span class="n">misc</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_OVERLAY_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_pixclock</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pixclock</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Setting graphics mode at %dx%d depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pm2fb_setcolreg - Sets a color register.</span>
<span class="cm"> *	@regno: boolean, 0 copy local, 1 get_user() function</span>
<span class="cm"> *	@red: frame buffer colormap structure</span>
<span class="cm"> *	@green: The green value which can be up to 16 bits wide</span>
<span class="cm"> *	@blue:  The blue value which can be up to 16 bits wide.</span>
<span class="cm"> *	@transp: If supported the alpha value which can be up to 16 bits wide.</span>
<span class="cm"> *	@info: frame buffer info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Set a single color register. The values supplied have a 16 bit</span>
<span class="cm"> *	magnitude which needs to be scaled in this function for the hardware.</span>
<span class="cm"> *	Pretty much a direct lift from tdfxfb.c.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>  <span class="cm">/* no. of hw registers */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Program hardware... do anything you want with transp</span>
<span class="cm">	 */</span>

	<span class="cm">/* grayscale works only partially under directcolor */</span>
	<span class="cm">/* grayscale = 0.30*R + 0.59*G + 0.11*B */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">77</span> <span class="o">+</span> <span class="n">green</span> <span class="o">*</span> <span class="mi">151</span> <span class="o">+</span> <span class="n">blue</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Directcolor:</span>
<span class="cm">	 *   var-&gt;{color}.offset contains start of bitfield</span>
<span class="cm">	 *   var-&gt;{color}.length contains length of bitfield</span>
<span class="cm">	 *   {hardwarespecific} contains width of DAC</span>
<span class="cm">	 *   cmap[X] is programmed to</span>
<span class="cm">	 *   (X &lt;&lt; red.offset) | (X &lt;&lt; green.offset) | (X &lt;&lt; blue.offset)</span>
<span class="cm">	 *   RAMDAC[X] is programmed to (red, green, blue)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Pseudocolor:</span>
<span class="cm">	 *    uses offset = 0 &amp;&amp; length = DAC register width.</span>
<span class="cm">	 *    var-&gt;{color}.offset is 0</span>
<span class="cm">	 *    var-&gt;{color}.length contains width of DAC</span>
<span class="cm">	 *    cmap is not used</span>
<span class="cm">	 *    DAC[X] is programmed to (red, green, blue)</span>
<span class="cm">	 * Truecolor:</span>
<span class="cm">	 *    does not use RAMDAC (usually has 3 of them).</span>
<span class="cm">	 *    var-&gt;{color}.offset contains start of bitfield</span>
<span class="cm">	 *    var-&gt;{color}.length contains length of bitfield</span>
<span class="cm">	 *    cmap is programmed to</span>
<span class="cm">	 *    (red &lt;&lt; red.offset) | (green &lt;&lt; green.offset) |</span>
<span class="cm">	 *    (blue &lt;&lt; blue.offset) | (transp &lt;&lt; transp.offset)</span>
<span class="cm">	 *    RAMDAC does not exist</span>
<span class="cm">	 */</span>
<span class="cp">#define CNVT_TOHW(val, width) ((((val) &lt;&lt; (width)) + 0x7FFF -(val)) &gt;&gt; 16)</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="n">red</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">green</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">blue</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">transp</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">transp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span>:
		<span class="cm">/* example here assumes 8 bit DAC. Might be different</span>
<span class="cm">		 * for your hardware */</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">green</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">blue</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="cm">/* hey, there is bug in transp handling... */</span>
		<span class="n">transp</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">transp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#undef CNVT_TOHW</span>
	<span class="cm">/* Truecolor has hardware independent palette */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">)</span>
		<span class="n">set_color</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pm2fb_pan_display - Pans the display.</span>
<span class="cm"> *	@var: frame buffer variable screen structure</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *	Pan (or wrap, depending on the `vmode&#39; field) the display using the</span>
<span class="cm"> *	`xoffset&#39; and `yoffset&#39; fields of the `var&#39; structure.</span>
<span class="cm"> *	If the values don&#39;t fit, return -EINVAL.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero on success.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>

	<span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">to3264</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PM2R_SCREEN_BASE</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pm2fb_blank - Blanks the display.</span>
<span class="cm"> *	@blank_mode: the blank mode we want.</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *	Blank the screen if blank_mode != 0, else unblank. Return 0 if</span>
<span class="cm"> *	blanking succeeded, != 0 if un-/blanking failed due to e.g. a</span>
<span class="cm"> *	video mode which doesn&#39;t support it. Implements VESA suspend</span>
<span class="cm"> *	and powerdown modes on hardware that supports disabling hsync/vsync:</span>
<span class="cm"> *	blank_mode == 2: suspend vsync</span>
<span class="cm"> *	blank_mode == 3: suspend hsync</span>
<span class="cm"> *	blank_mode == 4: powerdown</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero on success.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">video</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;blank_mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank_mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="cm">/* Screen: On */</span>
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM2F_VIDEO_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="cm">/* Screen: Off */</span>
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM2F_VIDEO_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="cm">/* VSync: Off */</span>
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM2F_VSYNC_MASK</span> <span class="o">|</span> <span class="n">PM2F_BLANK_LOW</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="cm">/* HSync: Off */</span>
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM2F_HSYNC_MASK</span> <span class="o">|</span> <span class="n">PM2F_BLANK_LOW</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="cm">/* HSync: Off, VSync: Off */</span>
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM2F_VSYNC_MASK</span> <span class="o">|</span> <span class="n">PM2F_HSYNC_MASK</span> <span class="o">|</span> <span class="n">PM2F_BLANK_LOW</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_video</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">video</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2fb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SYNC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pm2_RD</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_OUT_FIFO_WORDS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pm2_RD</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_OUT_FIFO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PM2TAG</span><span class="p">(</span><span class="n">PM2R_SYNC</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm2fb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">region</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="n">modded</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">]</span> <span class="o">:</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">region</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">!=</span> <span class="n">ROP_COPY</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">region</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modded</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fillrect</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span>  <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">color</span> <span class="o">|=</span> <span class="n">color</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">color</span> <span class="o">|=</span> <span class="n">color</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_CONFIG</span><span class="p">,</span> <span class="n">PM2F_CONFIG_FB_WRITE_ENABLE</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RECTANGLE_ORIGIN</span><span class="p">,</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RECTANGLE_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_BLOCK_COLOR</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RENDER</span><span class="p">,</span>
				<span class="n">PM2F_RENDER_RECTANGLE</span> <span class="o">|</span> <span class="n">PM2F_RENDER_FASTFILL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_COLOR_DDA_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_CONSTANT_COLOR</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RENDER</span><span class="p">,</span>
				<span class="n">PM2F_RENDER_RECTANGLE</span> <span class="o">|</span>
				<span class="n">PM2F_INCREASE_X</span> <span class="o">|</span> <span class="n">PM2F_INCREASE_Y</span> <span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_COLOR_DDA_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm2fb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="n">modded</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modded</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_copyarea</span><span class="p">));</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">&gt;=</span> <span class="n">vyres</span> <span class="o">||</span>
	    <span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">sx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>

	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_CONFIG</span><span class="p">,</span> <span class="n">PM2F_CONFIG_FB_WRITE_ENABLE</span> <span class="o">|</span>
		<span class="n">PM2F_CONFIG_FB_READ_SOURCE_ENABLE</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_SOURCE_DELTA</span><span class="p">,</span>
			<span class="p">((</span><span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RECTANGLE_ORIGIN</span><span class="p">,</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RECTANGLE_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RENDER</span><span class="p">,</span> <span class="n">PM2F_RENDER_RECTANGLE</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&lt;</span> <span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">?</span> <span class="n">PM2F_INCREASE_X</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&lt;</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">?</span> <span class="n">PM2F_INCREASE_Y</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm2fb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fgx</span><span class="p">,</span> <span class="n">bgx</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raster_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* invert bits */</span>

<span class="cp">#ifdef __LITTLE_ENDIAN</span>
	<span class="n">raster_mode</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* reverse byte order */</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span> <span class="o">||</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="n">fgx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">bgx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
	<span class="nl">default:</span>
		<span class="n">fgx</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">];</span>
		<span class="n">bgx</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fgx</span> <span class="o">|=</span> <span class="n">fgx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bgx</span> <span class="o">|=</span> <span class="n">bgx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fgx</span> <span class="o">|=</span> <span class="n">fgx</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">bgx</span> <span class="o">|=</span> <span class="n">bgx</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_READ_MODE</span><span class="p">,</span> <span class="n">partprod</span><span class="p">(</span><span class="n">xres</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCISSOR_MIN_XY</span><span class="p">,</span>
			<span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCISSOR_MAX_XY</span><span class="p">,</span>
			<span class="p">(((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCISSOR_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* GXcopy &amp; UNIT_ENABLE */</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_LOGICAL_OP_MODE</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RECTANGLE_ORIGIN</span><span class="p">,</span>
			<span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RECTANGLE_SIZE</span><span class="p">,</span>
			<span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_COLOR_DDA_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* clear area */</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_CONSTANT_COLOR</span><span class="p">,</span> <span class="n">bgx</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RENDER</span><span class="p">,</span>
			<span class="n">PM2F_RENDER_RECTANGLE</span> <span class="o">|</span>
			<span class="n">PM2F_INCREASE_X</span> <span class="o">|</span> <span class="n">PM2F_INCREASE_Y</span><span class="p">);</span>
		<span class="cm">/* BitMapPackEachScanline */</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RASTERIZER_MODE</span><span class="p">,</span> <span class="n">raster_mode</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">));</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_CONSTANT_COLOR</span><span class="p">,</span> <span class="n">fgx</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RENDER</span><span class="p">,</span>
			<span class="n">PM2F_RENDER_RECTANGLE</span> <span class="o">|</span>
			<span class="n">PM2F_INCREASE_X</span> <span class="o">|</span> <span class="n">PM2F_INCREASE_Y</span> <span class="o">|</span>
			<span class="n">PM2F_RENDER_SYNC_ON_BIT_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_COLOR_DDA_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* clear area */</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_BLOCK_COLOR</span><span class="p">,</span> <span class="n">bgx</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RENDER</span><span class="p">,</span>
			<span class="n">PM2F_RENDER_RECTANGLE</span> <span class="o">|</span>
			<span class="n">PM2F_RENDER_FASTFILL</span> <span class="o">|</span>
			<span class="n">PM2F_INCREASE_X</span> <span class="o">|</span> <span class="n">PM2F_INCREASE_Y</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RASTERIZER_MODE</span><span class="p">,</span> <span class="n">raster_mode</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_FB_BLOCK_COLOR</span><span class="p">,</span> <span class="n">fgx</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RENDER</span><span class="p">,</span>
			<span class="n">PM2F_RENDER_RECTANGLE</span> <span class="o">|</span>
			<span class="n">PM2F_INCREASE_X</span> <span class="o">|</span> <span class="n">PM2F_INCREASE_Y</span> <span class="o">|</span>
			<span class="n">PM2F_RENDER_FASTFILL</span> <span class="o">|</span>
			<span class="n">PM2F_RENDER_SYNC_ON_BIT_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">width</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_BIT_MASK_PATTERN</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RASTERIZER_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_COLOR_DDA_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_SCISSOR_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Hardware cursor support.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x55</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2vfb_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_cursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">PM2F_CURSORMODE_TYPE_X</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dx</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dy</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">PM2F_CURSORMODE_CURSOR_ENABLE</span><span class="p">;</span>

	<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="mi">2047</span><span class="p">;</span>	<span class="cm">/* push it outside display */</span>
	<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_X_LOW</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_X_HIGH</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_Y_LOW</span><span class="p">,</span> <span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_Y_HIGH</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the cursor is not be changed this means either we want the</span>
<span class="cm">	 * current cursor state (if enable is set) or we want to query what</span>
<span class="cm">	 * we can do with the cursor (if enable is not set)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_X_HOT</span><span class="p">,</span>
			     <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">hot</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_Y_HOT</span><span class="p">,</span>
			     <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">hot</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETCMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fb_cmap</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">;</span>

		<span class="cm">/* the X11 driver says one should use these color registers */</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_PALETTE</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_PALETTE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_PALETTE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_PALETTE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			     <span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>

		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_PALETTE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
			     <span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_PALETTE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
			     <span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VI_RD_CURSOR_PALETTE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
			     <span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FB_CUR_SETSHAPE</span> <span class="o">|</span> <span class="n">FB_CUR_SETIMAGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">PM2VI_RD_CURSOR_PATTERN</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">^</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span><span class="p">)</span>
					<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
				<span class="cm">/* Upper 4 bits of bitmap data */</span>
				<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span>
					<span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="o">*</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
				<span class="cm">/* Lower 4 bits of bitmap */</span>
				<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span>
					<span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="o">*</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">bitmap</span><span class="o">++</span><span class="p">;</span>
				<span class="n">mask</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">+</span> <span class="n">PM2VI_RD_CURSOR_PATTERN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">pm2v_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2VR_RD_INDEX_HIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm2fb_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_cursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwcursor</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* just to force soft_cursor() call */</span>

	<span class="cm">/* Too large of a cursor or wrong bpp :-( */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
	    <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
	    <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PM2_TYPE_PERMEDIA2V</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pm2vfb_cursor</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">cursor</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		 <span class="n">mode</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span>

	<span class="n">pm2_RDAC_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2I_RD_CURSOR_CONTROL</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the cursor is not be changed this means either we want the</span>
<span class="cm">	 * current cursor state (if enable is set) or we want to query what</span>
<span class="cm">	 * we can do with the cursor (if enable is not set)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETPOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dx</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">+</span> <span class="mi">63</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dy</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">+</span> <span class="mi">63</span><span class="p">;</span>

		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_X_LSB</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_X_MSB</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_Y_LSB</span><span class="p">,</span> <span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_Y_MSB</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETCMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">bg_color</span><span class="p">;</span>

		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_COLOR_ADDRESS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_COLOR_DATA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_COLOR_DATA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_COLOR_DATA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_COLOR_DATA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_COLOR_DATA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_COLOR_DATA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FB_CUR_SETSHAPE</span> <span class="o">|</span> <span class="n">FB_CUR_SETIMAGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_PALETTE_WRITE_ADDRESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">^</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span><span class="p">)</span>
					<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
				<span class="cm">/* bitmap data */</span>
				<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
				<span class="n">bitmap</span><span class="o">++</span><span class="p">;</span>
				<span class="n">mask</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span>
				<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* mask */</span>
				<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_DATA</span><span class="p">,</span> <span class="o">*</span><span class="n">mask</span><span class="p">);</span>
				<span class="n">mask</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span>
				<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">WAIT_FIFO</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pm2_WR</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM2R_RD_CURSOR_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------ Hardware Independent Functions ------------ */</span>

<span class="cm">/*</span>
<span class="cm"> *  Frame buffer operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">pm2fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">pm2fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">pm2fb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">pm2fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">pm2fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">pm2fb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">pm2fb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">pm2fb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">pm2fb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">pm2fb_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_cursor</span>	<span class="o">=</span> <span class="n">pm2fb_cursor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PCI stuff</span>
<span class="cm"> */</span>


<span class="cm">/**</span>
<span class="cm"> * Device initialisation</span>
<span class="cm"> *</span>
<span class="cm"> * Initialise and allocate resource for PCI device.</span>
<span class="cm"> *</span>
<span class="cm"> * @param	pdev	PCI device.</span>
<span class="cm"> * @param	id	PCI device ID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pm2fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">default_par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm2fb: Can&#39;t enable pdev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm2fb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">default_par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="n">PCI_DEVICE_ID_TI_TVP4020</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;TVP4020&quot;</span><span class="p">);</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PM2_TYPE_PERMEDIA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">PCI_DEVICE_ID_3DLABS_PERMEDIA2</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Permedia2&quot;</span><span class="p">);</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PM2_TYPE_PERMEDIA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">PCI_DEVICE_ID_3DLABS_PERMEDIA2V</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Permedia2v&quot;</span><span class="p">);</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PM2_TYPE_PERMEDIA2V</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">PM2_REGS_SIZE</span><span class="p">;</span>

<span class="cp">#if defined(__BIG_ENDIAN)</span>
	<span class="cm">/*</span>
<span class="cm">	 * PM2 has a 64k register file, mapped twice in 128k. Lower</span>
<span class="cm">	 * map is little-endian, upper map is big-endian.</span>
<span class="cm">	 */</span>
	<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">+=</span> <span class="n">PM2_REGS_SIZE</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Adjusting register base for big-endian.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Register base at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">);</span>

	<span class="cm">/* Registers - request region and map it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">,</span>
				<span class="s">&quot;pm2fb regbase&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm2fb: Can&#39;t reserve regbase.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_neither</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">=</span>
		<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm2fb: Can&#39;t remap %s register area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_neither</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stash away memory register info for use when we reset the board */</span>
	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_control</span> <span class="o">=</span> <span class="n">pm2_RD</span><span class="p">(</span><span class="n">default_par</span><span class="p">,</span> <span class="n">PM2R_MEM_CONTROL</span><span class="p">);</span>
	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">boot_address</span> <span class="o">=</span> <span class="n">pm2_RD</span><span class="p">(</span><span class="n">default_par</span><span class="p">,</span> <span class="n">PM2R_BOOT_ADDRESS</span><span class="p">);</span>
	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_config</span> <span class="o">=</span> <span class="n">pm2_RD</span><span class="p">(</span><span class="n">default_par</span><span class="p">,</span> <span class="n">PM2R_MEM_CONFIG</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;MemControl 0x%x BootAddress 0x%x MemConfig 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_control</span><span class="p">,</span> <span class="n">default_par</span><span class="o">-&gt;</span><span class="n">boot_address</span><span class="p">,</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_control</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">boot_address</span> <span class="o">==</span> <span class="mh">0x31</span> <span class="o">&amp;&amp;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_config</span> <span class="o">==</span> <span class="mh">0x259fffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">memclock</span> <span class="o">=</span> <span class="n">CVPPC_MEMCLOCK</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">boot_address</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_config</span> <span class="o">=</span> <span class="mh">0xe6002021</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1048</span> <span class="o">&amp;&amp;</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0a31</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subsystem_vendor: %04x, &quot;</span>
				<span class="s">&quot;subsystem_device: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;We have not been initialized by VGA BIOS and &quot;</span>
				<span class="s">&quot;are running on an Elsa Winner 2000 Office</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Initializing card timings manually...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">memclock</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x3d3d</span> <span class="o">&amp;&amp;</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;subsystem_vendor: %04x, &quot;</span>
				<span class="s">&quot;subsystem_device: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;We have not been initialized by VGA BIOS and &quot;</span>
				<span class="s">&quot;are running on an 3dlabs reference board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Initializing card timings manually...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">memclock</span> <span class="o">=</span> <span class="mi">74894</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now work out how big lfb is going to be. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mem_config</span> <span class="o">&amp;</span> <span class="n">PM2F_MEM_CONFIG_RAM_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM2F_MEM_BANKS_1</span>:
		<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x200000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2F_MEM_BANKS_2</span>:
		<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2F_MEM_BANKS_3</span>:
		<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x600000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM2F_MEM_BANKS_4</span>:
		<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Linear frame buffer - request region and map it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				<span class="s">&quot;pm2fb smem&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm2fb: Can&#39;t reserve smem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_mmio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span>
		<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm2fb: Can&#39;t ioremap smem area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_mmio</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nomtrr</span><span class="p">)</span>
		<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">=</span>
			<span class="n">mtrr_add</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
				 <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				 <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pm2fb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span>		<span class="o">=</span> <span class="n">pm2fb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="n">default_par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span>
				  <span class="n">FBINFO_HWACCEL_YPAN</span> <span class="o">|</span>
				  <span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>
				  <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span> <span class="o">|</span>
				  <span class="n">FBINFO_HWACCEL_FILLRECT</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PM2_PIXMAP_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit_pixmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PM2_PIXMAP_SIZE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">buf_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">access_align</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FB_PIXMAP_SYSTEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">noaccel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;disabling acceleration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_option</span><span class="p">)</span>
		<span class="n">mode_option</span> <span class="o">=</span> <span class="s">&quot;640x480@60&quot;</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">pm2fb_var</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit_both</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit_all</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device, memory = %dK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Our driver data</span>
<span class="cm">	 */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_exit_all:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
 <span class="nl">err_exit_both:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
 <span class="nl">err_exit_pixmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
 <span class="nl">err_exit_mmio:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm2fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
 <span class="nl">err_exit_neither:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Device removal.</span>
<span class="cm"> *</span>
<span class="cm"> * Release all device resources.</span>
<span class="cm"> *</span>
<span class="cm"> * @param	pdev	PCI device to clean up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pm2fb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm2fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			 <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MTRR */</span><span class="cp"></span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pm2fb_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_TI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TI_TVP4020</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3DLABS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3DLABS_PERMEDIA2</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3DLABS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3DLABS_PERMEDIA2V</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pm2fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pm2fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pm2fb_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pm2fb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pm2fb_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm2fb_id_table</span><span class="p">);</span>


<span class="cp">#ifndef MODULE</span>
<span class="cm">/**</span>
<span class="cm"> * Parse user specified options.</span>
<span class="cm"> *</span>
<span class="cm"> * This is, comma-separated options following `video=pm2fb:&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pm2fb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;lowhsync&quot;</span><span class="p">))</span>
			<span class="n">lowhsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;lowvsync&quot;</span><span class="p">))</span>
			<span class="n">lowvsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;hwcursor=&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">hwcursor</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nomtrr&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">nomtrr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noaccel&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">noaccel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pm2fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;pm2fb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">pm2fb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm2fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pm2fb_init</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
<span class="cm">/*</span>
<span class="cm"> *  Cleanup</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pm2fb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm2fb_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MODULE</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pm2fb_exit</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Initial video mode e.g. &#39;648x480-8@60&#39;&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;Initial video mode e.g. &#39;648x480-8@60&#39; (deprecated)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lowhsync</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lowhsync</span><span class="p">,</span> <span class="s">&quot;Force horizontal sync low regardless of mode&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lowvsync</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lowvsync</span><span class="p">,</span> <span class="s">&quot;Force vertical sync low regardless of mode&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="s">&quot;Disable acceleration&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hwcursor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwcursor</span><span class="p">,</span> <span class="s">&quot;Enable hardware cursor &quot;</span>
			<span class="s">&quot;(1=enable, 0=disable, default=1)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="s">&quot;Disable MTRR support (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jim Hague &lt;jim.hague@acm.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Permedia2 framebuffer device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
