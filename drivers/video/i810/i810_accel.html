<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › i810 › i810_accel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>i810_accel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*-*- linux-c -*-</span>
<span class="cm"> *  linux/drivers/video/i810_accel.c -- Hardware Acceleration</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 2001 Antonino Daplas&lt;adaplas@pol.net&gt;</span>
<span class="cm"> *      All Rights Reserved      </span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>

<span class="cp">#include &quot;i810_regs.h&quot;</span>
<span class="cp">#include &quot;i810.h&quot;</span>
<span class="cp">#include &quot;i810_main.h&quot;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">i810fb_rop</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">COLOR_COPY_ROP</span><span class="p">,</span> <span class="cm">/* ROP_COPY */</span>
	<span class="n">XOR_ROP</span>         <span class="cm">/* ROP_XOR  */</span>
<span class="p">};</span>

<span class="cm">/* Macros */</span>
<span class="cp">#define PUT_RING(n) {                                        \</span>
<span class="cp">	i810_writel(par-&gt;cur_tail, par-&gt;iring.virtual, n);   \</span>
<span class="cp">        par-&gt;cur_tail += 4;                                  \</span>
<span class="cp">        par-&gt;cur_tail &amp;= RING_SIZE_MASK;                     \</span>
<span class="cp">}                                                                      </span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">flush_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/************************************************************/</span>

<span class="cm">/* BLT Engine Routines */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">i810_report_error</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IIR     : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;EIR     : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;PGTBL_ER: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;IPEIR   : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;IPEHR   : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">i810_readw</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">mmio</span><span class="p">),</span>
	       <span class="n">i810_readb</span><span class="p">(</span><span class="n">EIR</span><span class="p">,</span> <span class="n">mmio</span><span class="p">),</span>
	       <span class="n">i810_readl</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">,</span> <span class="n">mmio</span><span class="p">),</span>
	       <span class="n">i810_readl</span><span class="p">(</span><span class="n">IPEIR</span><span class="p">,</span> <span class="n">mmio</span><span class="p">),</span> 
	       <span class="n">i810_readl</span><span class="p">(</span><span class="n">IPEHR</span><span class="p">,</span> <span class="n">mmio</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wait_for_space - check ring buffer free space</span>
<span class="cm"> * @space: amount of ringbuffer space needed in bytes</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * The function waits until a free space from the ringbuffer</span>
<span class="cm"> * is available </span>
<span class="cm"> */</span>	
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_for_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">WAIT_COUNT</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_start_virtual</span><span class="p">;</span>

	<span class="n">tail</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cur_tail</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">i810_readl</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mmio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RBUFFER_HEAD_MASK</span><span class="p">;</span>	
		<span class="k">if</span> <span class="p">((</span><span class="n">tail</span> <span class="o">==</span> <span class="n">head</span><span class="p">)</span> <span class="o">||</span> 
		    <span class="p">(</span><span class="n">tail</span> <span class="o">&gt;</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> 
		     <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">iring</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">tail</span> <span class="o">+</span> <span class="n">head</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">space</span><span class="p">)</span> <span class="o">||</span> 
		    <span class="p">(</span><span class="n">tail</span> <span class="o">&lt;</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">tail</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">space</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ringbuffer lockup!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">i810_report_error</span><span class="p">(</span><span class="n">mmio</span><span class="p">);</span> 
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">LOCKUP</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** </span>
<span class="cm"> * wait_for_engine_idle - waits for all hardware engines to finish</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * This waits for lring(0), iring(1), and batch(3), etc to finish and</span>
<span class="cm"> * waits until ringbuffer is empty.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_for_engine_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_start_virtual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">WAIT_COUNT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_space</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">iring</span><span class="p">.</span><span class="n">size</span><span class="p">))</span> <span class="cm">/* flush */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span><span class="p">((</span><span class="n">i810_readw</span><span class="p">(</span><span class="n">INSTDONE</span><span class="p">,</span> <span class="n">mmio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7B</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7B</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">count</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;accel engine lockup!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INSTDONE: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i810_readl</span><span class="p">(</span><span class="n">INSTDONE</span><span class="p">,</span> <span class="n">mmio</span><span class="p">));</span>
	<span class="n">i810_report_error</span><span class="p">(</span><span class="n">mmio</span><span class="p">);</span> 
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">LOCKUP</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* begin_iring - prepares the ringbuffer </span>
<span class="cm"> * @space: length of sequence in dwords</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Checks/waits for sufficient space in ringbuffer of size</span>
<span class="cm"> * space.  Returns the tail of the buffer</span>
<span class="cm"> */</span> 
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">begin_iring</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">ALWAYS_SYNC</span><span class="p">)</span> 
		<span class="n">wait_for_engine_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wait_for_space</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * end_iring - advances the buffer</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * This advances the tail of the ringbuffer, effectively</span>
<span class="cm"> * beginning the execution of the graphics instruction sequence.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">end_iring</span><span class="p">(</span><span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_start_virtual</span><span class="p">;</span>

	<span class="n">i810_writel</span><span class="p">(</span><span class="n">IRING</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cur_tail</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * source_copy_blit - BLIT transfer operation</span>
<span class="cm"> * @dwidth: width of rectangular graphics data</span>
<span class="cm"> * @dheight: height of rectangular graphics data</span>
<span class="cm"> * @dpitch: bytes per line of destination buffer</span>
<span class="cm"> * @xdir: direction of copy (left to right or right to left)</span>
<span class="cm"> * @src: address of first pixel to read from</span>
<span class="cm"> * @dest: address of first pixel to write to</span>
<span class="cm"> * @from: source address</span>
<span class="cm"> * @where: destination address</span>
<span class="cm"> * @rop: raster operation</span>
<span class="cm"> * @blit_bpp: pixel format which can be different from the </span>
<span class="cm"> *            framebuffer&#39;s pixelformat</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * This is a BLIT operation typically used when doing</span>
<span class="cm"> * a &#39;Copy and Paste&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">source_copy_blit</span><span class="p">(</span><span class="kt">int</span> <span class="n">dwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dheight</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dpitch</span><span class="p">,</span> 
				    <span class="kt">int</span> <span class="n">xdir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rop</span><span class="p">,</span> 
				    <span class="kt">int</span> <span class="n">blit_bpp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">begin_iring</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">IRING_PAD</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">BLIT</span> <span class="o">|</span> <span class="n">SOURCE_COPY_BLIT</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">xdir</span> <span class="o">|</span> <span class="n">rop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">dpitch</span> <span class="o">|</span> <span class="n">DYN_COLOR_EN</span> <span class="o">|</span> <span class="n">blit_bpp</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">dheight</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">dwidth</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">dpitch</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

	<span class="n">end_iring</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>	

<span class="cm">/**</span>
<span class="cm"> * color_blit - solid color BLIT operation</span>
<span class="cm"> * @width: width of destination</span>
<span class="cm"> * @height: height of destination</span>
<span class="cm"> * @pitch: pixels per line of the buffer</span>
<span class="cm"> * @dest: address of first pixel to write to</span>
<span class="cm"> * @where: destination</span>
<span class="cm"> * @rop: raster operation</span>
<span class="cm"> * @what: color to transfer</span>
<span class="cm"> * @blit_bpp: pixel format which can be different from the </span>
<span class="cm"> *            framebuffer&#39;s pixelformat</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * A BLIT operation which can be used for  color fill/rectangular fill</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">color_blit</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">,</span>  <span class="kt">int</span> <span class="n">dest</span><span class="p">,</span> 
			      <span class="kt">int</span> <span class="n">rop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">what</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blit_bpp</span><span class="p">,</span> 
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">begin_iring</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">IRING_PAD</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">BLIT</span> <span class="o">|</span> <span class="n">COLOR_BLT</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">rop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">pitch</span> <span class="o">|</span> <span class="n">SOLIDPATTERN</span> <span class="o">|</span> <span class="n">DYN_COLOR_EN</span> <span class="o">|</span> <span class="n">blit_bpp</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">width</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">what</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">NOP</span><span class="p">);</span>

	<span class="n">end_iring</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="cm">/**</span>
<span class="cm"> * mono_src_copy_imm_blit - color expand from system memory to framebuffer</span>
<span class="cm"> * @dwidth: width of destination</span>
<span class="cm"> * @dheight: height of destination</span>
<span class="cm"> * @dpitch: pixels per line of the buffer</span>
<span class="cm"> * @dsize: size of bitmap in double words</span>
<span class="cm"> * @dest: address of first byte of pixel;</span>
<span class="cm"> * @rop: raster operation</span>
<span class="cm"> * @blit_bpp: pixelformat to use which can be different from the </span>
<span class="cm"> *            framebuffer&#39;s pixelformat</span>
<span class="cm"> * @src: address of image data</span>
<span class="cm"> * @bg: backgound color</span>
<span class="cm"> * @fg: forground color</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * A color expand operation where the  source data is placed in the </span>
<span class="cm"> * ringbuffer itself. Useful for drawing text. </span>
<span class="cm"> *</span>
<span class="cm"> * REQUIREMENT:</span>
<span class="cm"> * The end of a scanline must be padded to the next word.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mono_src_copy_imm_blit</span><span class="p">(</span><span class="kt">int</span> <span class="n">dwidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dheight</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dpitch</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">dsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blit_bpp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rop</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bg</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">fg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">begin_iring</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">24</span> <span class="o">+</span> <span class="p">(</span><span class="n">dsize</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">IRING_PAD</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">BLIT</span> <span class="o">|</span> <span class="n">MONO_SOURCE_COPY_IMMEDIATE</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">dsize</span><span class="p">));</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">DYN_COLOR_EN</span> <span class="o">|</span> <span class="n">blit_bpp</span> <span class="o">|</span> <span class="n">rop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">dpitch</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">dheight</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">dwidth</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">bg</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">fg</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dsize</span><span class="o">--</span><span class="p">)</span> 
		<span class="n">PUT_RING</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>

	<span class="n">end_iring</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_front</span><span class="p">(</span><span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">begin_iring</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">IRING_PAD</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">PARSER</span> <span class="o">|</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">NOP</span><span class="p">);</span>

	<span class="n">end_iring</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">begin_iring</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">IRING_PAD</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">PUT_RING</span><span class="p">(</span><span class="n">PARSER</span> <span class="o">|</span> <span class="n">FRONT_BUFFER</span> <span class="o">|</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">PUT_RING</span><span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">end_iring</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i810fb_iring_enable - enables/disables the ringbuffer</span>
<span class="cm"> * @mode: enable or disable</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Enables or disables the ringbuffer, effectively enabling or</span>
<span class="cm"> * disabling the instruction/acceleration engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">i810fb_iring_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_start_virtual</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">i810_readl</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">mmio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OFF</span><span class="p">)</span> 
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flush_cache</span><span class="p">();</span>
	<span class="n">i810_writel</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>       

<span class="kt">void</span> <span class="nf">i810fb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">LOCKUP</span> <span class="o">||</span>
	    <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> 
		<span class="n">color</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">color</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">];</span>

	<span class="n">rop</span> <span class="o">=</span> <span class="n">i810fb_rop</span><span class="p">[</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">];</span>

	<span class="n">dx</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="n">dest</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">color_blit</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rop</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> 
		   <span class="n">par</span><span class="o">-&gt;</span><span class="n">blit_bpp</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
	
<span class="kt">void</span> <span class="nf">i810fb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">region</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">xdir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">LOCKUP</span> <span class="o">||</span>
	    <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">region</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dx</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
	<span class="n">sx</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
	<span class="n">sy</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&lt;=</span> <span class="n">sx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xdir</span> <span class="o">=</span> <span class="n">INCREMENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">xdir</span> <span class="o">=</span> <span class="n">DECREMENT</span><span class="p">;</span>
		<span class="n">sx</span> <span class="o">+=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dx</span> <span class="o">+=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&lt;=</span> <span class="n">sy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="n">sy</span> <span class="o">+=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dy</span> <span class="o">+=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">sy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">sx</span><span class="p">;</span>
	<span class="n">dest</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx</span><span class="p">;</span>

	<span class="n">source_copy_blit</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span>
			 <span class="n">PAT_COPY_ROP</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">blit_bpp</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i810fb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dst</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">LOCKUP</span> <span class="o">||</span>
	    <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">fg</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">bg</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">fg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">];</span>
		<span class="n">bg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>	
	
	<span class="n">dst</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">)</span> <span class="o">+</span> 
		<span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">*=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">mono_src_copy_imm_blit</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">,</span> 
			       <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> 
			       <span class="n">size</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">blit_bpp</span><span class="p">,</span>
			       <span class="n">PAT_COPY_ROP</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> 
			       <span class="n">bg</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span> 

<span class="kt">int</span> <span class="nf">i810fb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">LOCKUP</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wait_for_engine_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i810fb_load_front</span><span class="p">(</span><span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_start_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">LOCKUP</span><span class="p">)</span>
		<span class="n">i810_writel</span><span class="p">(</span><span class="n">DPLYBASE</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">physical</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span> 
		<span class="n">load_front</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i810fb_init_ringbuffer - initialize the ringbuffer</span>
<span class="cm"> * @par: pointer to i810fb_par structure</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION:</span>
<span class="cm"> * Initializes the ringbuffer by telling the device the</span>
<span class="cm"> * size and location of the ringbuffer.  It also sets </span>
<span class="cm"> * the head and tail pointers = 0</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i810fb_init_ringbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i810fb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_start_virtual</span><span class="p">;</span>
	
	<span class="n">wait_for_engine_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">i810fb_iring_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">i810_writel</span><span class="p">(</span><span class="n">IRING</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">i810_writel</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cur_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">i810_readl</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mmio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RBUFFER_START_MASK</span><span class="p">;</span> 
	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">iring</span><span class="p">.</span><span class="n">physical</span><span class="p">;</span>
	<span class="n">i810_writel</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="n">tmp2</span> <span class="o">|</span> <span class="n">tmp1</span><span class="p">);</span>

	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">i810_readl</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">mmio</span><span class="p">);</span>
	<span class="n">tmp1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBUFFER_SIZE_MASK</span><span class="p">;</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">iring</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">I810_PAGESIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RBUFFER_SIZE_MASK</span><span class="p">;</span>
	<span class="n">i810_writel</span><span class="p">(</span><span class="n">IRING</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="n">tmp1</span> <span class="o">|</span> <span class="n">tmp2</span><span class="p">);</span>
	<span class="n">i810fb_iring_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
