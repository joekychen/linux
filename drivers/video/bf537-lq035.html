<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › bf537-lq035.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>bf537-lq035.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Analog Devices Blackfin(BF537 STAMP) + SHARP TFT LCD.</span>
<span class="cm"> * http://docs.blackfin.uclinux.org/doku.php?id=hw:cards:tft-lcd</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006-2010 Analog Devices Inc.</span>
<span class="cm"> * Licensed under the GPL-2.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/lcd.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;asm/blackfin.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dpmc.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/portmux.h&gt;</span>

<span class="cp">#define NO_BL 1</span>

<span class="cp">#define MAX_BRIGHENESS	95</span>
<span class="cp">#define MIN_BRIGHENESS	5</span>
<span class="cp">#define NBR_PALETTE	256</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ppi_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">P_PPI0_CLK</span><span class="p">,</span> <span class="n">P_PPI0_D0</span><span class="p">,</span> <span class="n">P_PPI0_D1</span><span class="p">,</span> <span class="n">P_PPI0_D2</span><span class="p">,</span> <span class="n">P_PPI0_D3</span><span class="p">,</span>
	<span class="n">P_PPI0_D4</span><span class="p">,</span> <span class="n">P_PPI0_D5</span><span class="p">,</span> <span class="n">P_PPI0_D6</span><span class="p">,</span> <span class="n">P_PPI0_D7</span><span class="p">,</span>
	<span class="n">P_PPI0_D8</span><span class="p">,</span> <span class="n">P_PPI0_D9</span><span class="p">,</span> <span class="n">P_PPI0_D10</span><span class="p">,</span> <span class="n">P_PPI0_D11</span><span class="p">,</span>
	<span class="n">P_PPI0_D12</span><span class="p">,</span> <span class="n">P_PPI0_D13</span><span class="p">,</span> <span class="n">P_PPI0_D14</span><span class="p">,</span> <span class="n">P_PPI0_D15</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fb_buffer</span><span class="p">;</span>          <span class="cm">/* RGB Buffer */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dma_desc_table</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">t_conf_done</span><span class="p">,</span> <span class="n">lq035_open_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">bfin_lq035_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">landscape</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">landscape</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">landscape</span><span class="p">,</span>
	<span class="s">&quot;LANDSCAPE use 320x240 instead of Native 240x320 Resolution&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bgr</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bgr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bgr</span><span class="p">,</span>
	<span class="s">&quot;BGR use 16-bit BGR-565 instead of RGB-565&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nocursor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nocursor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nocursor</span><span class="p">,</span> <span class="s">&quot;cursor enable/disable&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">current_brightness</span><span class="p">;</span>  <span class="cm">/* backlight */</span>

<span class="cm">/* AD5280 vcomm */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vcomm_value</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">ad5280_client</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_vcomm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ad5280_client</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">ad5280_client</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">vcomm_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;i2c_smbus_write_byte_data fail: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ad5280_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				     <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SMBUS Byte Data not Supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">vcomm_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write fail: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ad5280_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ad5280_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad5280_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ad5280_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;bf537-lq035-ad5280&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ad5280_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ad5280_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bf537-lq035-ad5280&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ad5280_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ad5280_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ad5280_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PNAV10</span>
<span class="cp">#define MOD GPIO_PH13</span>

<span class="cp">#define bfin_write_TIMER_LP_CONFIG	bfin_write_TIMER0_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_LP_WIDTH	bfin_write_TIMER0_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_LP_PERIOD	bfin_write_TIMER0_PERIOD</span>
<span class="cp">#define bfin_read_TIMER_LP_COUNTER	bfin_read_TIMER0_COUNTER</span>
<span class="cp">#define TIMDIS_LP			TIMDIS0</span>
<span class="cp">#define TIMEN_LP			TIMEN0</span>

<span class="cp">#define bfin_write_TIMER_SPS_CONFIG	bfin_write_TIMER1_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_SPS_WIDTH	bfin_write_TIMER1_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_SPS_PERIOD	bfin_write_TIMER1_PERIOD</span>
<span class="cp">#define TIMDIS_SPS			TIMDIS1</span>
<span class="cp">#define TIMEN_SPS			TIMEN1</span>

<span class="cp">#define bfin_write_TIMER_SP_CONFIG	bfin_write_TIMER5_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_SP_WIDTH	bfin_write_TIMER5_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_SP_PERIOD	bfin_write_TIMER5_PERIOD</span>
<span class="cp">#define TIMDIS_SP			TIMDIS5</span>
<span class="cp">#define TIMEN_SP			TIMEN5</span>

<span class="cp">#define bfin_write_TIMER_PS_CLS_CONFIG	bfin_write_TIMER2_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_PS_CLS_WIDTH	bfin_write_TIMER2_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_PS_CLS_PERIOD	bfin_write_TIMER2_PERIOD</span>
<span class="cp">#define TIMDIS_PS_CLS			TIMDIS2</span>
<span class="cp">#define TIMEN_PS_CLS			TIMEN2</span>

<span class="cp">#define bfin_write_TIMER_REV_CONFIG	bfin_write_TIMER3_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_REV_WIDTH	bfin_write_TIMER3_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_REV_PERIOD	bfin_write_TIMER3_PERIOD</span>
<span class="cp">#define TIMDIS_REV			TIMDIS3</span>
<span class="cp">#define TIMEN_REV			TIMEN3</span>
<span class="cp">#define bfin_read_TIMER_REV_COUNTER	bfin_read_TIMER3_COUNTER</span>

<span class="cp">#define	FREQ_PPI_CLK         (5*1024*1024)  </span><span class="cm">/* PPI_CLK 5MHz */</span><span class="cp"></span>

<span class="cp">#define TIMERS {P_TMR0, P_TMR1, P_TMR2, P_TMR3, P_TMR5, 0}</span>

<span class="cp">#else</span>

<span class="cp">#define UD      GPIO_PF13	</span><span class="cm">/* Up / Down */</span><span class="cp"></span>
<span class="cp">#define MOD     GPIO_PF10</span>
<span class="cp">#define LBR     GPIO_PF14	</span><span class="cm">/* Left Right */</span><span class="cp"></span>

<span class="cp">#define bfin_write_TIMER_LP_CONFIG	bfin_write_TIMER6_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_LP_WIDTH	bfin_write_TIMER6_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_LP_PERIOD	bfin_write_TIMER6_PERIOD</span>
<span class="cp">#define bfin_read_TIMER_LP_COUNTER	bfin_read_TIMER6_COUNTER</span>
<span class="cp">#define TIMDIS_LP			TIMDIS6</span>
<span class="cp">#define TIMEN_LP			TIMEN6</span>

<span class="cp">#define bfin_write_TIMER_SPS_CONFIG	bfin_write_TIMER1_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_SPS_WIDTH	bfin_write_TIMER1_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_SPS_PERIOD	bfin_write_TIMER1_PERIOD</span>
<span class="cp">#define TIMDIS_SPS			TIMDIS1</span>
<span class="cp">#define TIMEN_SPS			TIMEN1</span>

<span class="cp">#define bfin_write_TIMER_SP_CONFIG	bfin_write_TIMER0_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_SP_WIDTH	bfin_write_TIMER0_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_SP_PERIOD	bfin_write_TIMER0_PERIOD</span>
<span class="cp">#define TIMDIS_SP			TIMDIS0</span>
<span class="cp">#define TIMEN_SP			TIMEN0</span>

<span class="cp">#define bfin_write_TIMER_PS_CLS_CONFIG	bfin_write_TIMER7_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_PS_CLS_WIDTH	bfin_write_TIMER7_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_PS_CLS_PERIOD	bfin_write_TIMER7_PERIOD</span>
<span class="cp">#define TIMDIS_PS_CLS			TIMDIS7</span>
<span class="cp">#define TIMEN_PS_CLS			TIMEN7</span>

<span class="cp">#define bfin_write_TIMER_REV_CONFIG	bfin_write_TIMER5_CONFIG</span>
<span class="cp">#define bfin_write_TIMER_REV_WIDTH	bfin_write_TIMER5_WIDTH</span>
<span class="cp">#define bfin_write_TIMER_REV_PERIOD	bfin_write_TIMER5_PERIOD</span>
<span class="cp">#define TIMDIS_REV			TIMDIS5</span>
<span class="cp">#define TIMEN_REV			TIMEN5</span>
<span class="cp">#define bfin_read_TIMER_REV_COUNTER	bfin_read_TIMER5_COUNTER</span>

<span class="cp">#define	FREQ_PPI_CLK         (6*1000*1000)  </span><span class="cm">/* PPI_CLK 6MHz */</span><span class="cp"></span>
<span class="cp">#define TIMERS {P_TMR0, P_TMR1, P_TMR5, P_TMR6, P_TMR7, 0}</span>

<span class="cp">#endif</span>

<span class="cp">#define LCD_X_RES			240 </span><span class="cm">/* Horizontal Resolution */</span><span class="cp"></span>
<span class="cp">#define LCD_Y_RES			320 </span><span class="cm">/* Vertical Resolution */</span><span class="cp"></span>

<span class="cp">#define LCD_BBP				16  </span><span class="cm">/* Bit Per Pixel */</span><span class="cp"></span>

<span class="cm">/* the LCD and the DMA start counting differently;</span>
<span class="cm"> * since one starts at 0 and the other starts at 1,</span>
<span class="cm"> * we have a difference of 1 between START_LINES</span>
<span class="cm"> * and U_LINES.</span>
<span class="cm"> */</span>
<span class="cp">#define START_LINES       8   </span><span class="cm">/* lines for field flyback or field blanking signal */</span><span class="cp"></span>
<span class="cp">#define U_LINES           9   </span><span class="cm">/* number of undisplayed blanking lines */</span><span class="cp"></span>

<span class="cp">#define FRAMES_PER_SEC    (60)</span>

<span class="cp">#define DCLKS_PER_FRAME   (FREQ_PPI_CLK/FRAMES_PER_SEC)</span>
<span class="cp">#define DCLKS_PER_LINE    (DCLKS_PER_FRAME/(LCD_Y_RES+U_LINES))</span>

<span class="cp">#define PPI_CONFIG_VALUE  (PORT_DIR|XFR_TYPE|DLEN_16|POLS)</span>
<span class="cp">#define PPI_DELAY_VALUE   (0)</span>
<span class="cp">#define TIMER_CONFIG      (PWM_OUT|PERIOD_CNT|TIN_SEL|CLK_SEL)</span>

<span class="cp">#define ACTIVE_VIDEO_MEM_OFFSET	(LCD_X_RES*START_LINES*(LCD_BBP/8))</span>
<span class="cp">#define ACTIVE_VIDEO_MEM_SIZE	(LCD_Y_RES*LCD_X_RES*(LCD_BBP/8))</span>
<span class="cp">#define TOTAL_VIDEO_MEM_SIZE	((LCD_Y_RES+U_LINES)*LCD_X_RES*(LCD_BBP/8))</span>
<span class="cp">#define TOTAL_DMA_DESC_SIZE	(2 * sizeof(u32) * (LCD_Y_RES + U_LINES))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_timers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="cm">/* CHECK with HW */</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">bfin_write_TIMER_ENABLE</span><span class="p">(</span><span class="n">TIMEN_REV</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bfin_read_TIMER_REV_COUNTER</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="n">bfin_write_TIMER_ENABLE</span><span class="p">(</span><span class="n">TIMEN_LP</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bfin_read_TIMER_LP_COUNTER</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="n">bfin_write_TIMER_ENABLE</span><span class="p">(</span><span class="n">TIMEN_SP</span><span class="o">|</span><span class="n">TIMEN_SPS</span><span class="o">|</span><span class="n">TIMEN_PS_CLS</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>
	<span class="n">t_conf_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">config_timers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Stop timers */</span>
	<span class="n">bfin_write_TIMER_DISABLE</span><span class="p">(</span><span class="n">TIMDIS_SP</span><span class="o">|</span><span class="n">TIMDIS_SPS</span><span class="o">|</span><span class="n">TIMDIS_REV</span><span class="o">|</span>
				 <span class="n">TIMDIS_LP</span><span class="o">|</span><span class="n">TIMDIS_PS_CLS</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="cm">/* LP, timer 6 */</span>
	<span class="n">bfin_write_TIMER_LP_CONFIG</span><span class="p">(</span><span class="n">TIMER_CONFIG</span><span class="o">|</span><span class="n">PULSE_HI</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_LP_WIDTH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">bfin_write_TIMER_LP_PERIOD</span><span class="p">(</span><span class="n">DCLKS_PER_LINE</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="cm">/* SPS, timer 1 */</span>
	<span class="n">bfin_write_TIMER_SPS_CONFIG</span><span class="p">(</span><span class="n">TIMER_CONFIG</span><span class="o">|</span><span class="n">PULSE_HI</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_SPS_WIDTH</span><span class="p">(</span><span class="n">DCLKS_PER_LINE</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_SPS_PERIOD</span><span class="p">((</span><span class="n">DCLKS_PER_LINE</span> <span class="o">*</span> <span class="p">(</span><span class="n">LCD_Y_RES</span><span class="o">+</span><span class="n">U_LINES</span><span class="p">)));</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="cm">/* SP, timer 0 */</span>
	<span class="n">bfin_write_TIMER_SP_CONFIG</span><span class="p">(</span><span class="n">TIMER_CONFIG</span><span class="o">|</span><span class="n">PULSE_HI</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_SP_WIDTH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_SP_PERIOD</span><span class="p">(</span><span class="n">DCLKS_PER_LINE</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="cm">/* PS &amp; CLS, timer 7 */</span>
	<span class="n">bfin_write_TIMER_PS_CLS_CONFIG</span><span class="p">(</span><span class="n">TIMER_CONFIG</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_PS_CLS_WIDTH</span><span class="p">(</span><span class="n">LCD_X_RES</span> <span class="o">+</span> <span class="n">START_LINES</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_PS_CLS_PERIOD</span><span class="p">(</span><span class="n">DCLKS_PER_LINE</span><span class="p">);</span>

	<span class="n">SSYNC</span><span class="p">();</span>

<span class="cp">#ifdef NO_BL</span>
	<span class="cm">/* REV, timer 5 */</span>
	<span class="n">bfin_write_TIMER_REV_CONFIG</span><span class="p">(</span><span class="n">TIMER_CONFIG</span><span class="o">|</span><span class="n">PULSE_HI</span><span class="p">);</span>

	<span class="n">bfin_write_TIMER_REV_WIDTH</span><span class="p">(</span><span class="n">DCLKS_PER_LINE</span><span class="p">);</span>
	<span class="n">bfin_write_TIMER_REV_PERIOD</span><span class="p">(</span><span class="n">DCLKS_PER_LINE</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">SSYNC</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">config_ppi</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_write_PPI_DELAY</span><span class="p">(</span><span class="n">PPI_DELAY_VALUE</span><span class="p">);</span>
	<span class="n">bfin_write_PPI_COUNT</span><span class="p">(</span><span class="n">LCD_X_RES</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* 0x10 -&gt; PORT_CFG -&gt; 2 or 3 frame syncs */</span>
	<span class="n">bfin_write_PPI_CONTROL</span><span class="p">((</span><span class="n">PPI_CONFIG_VALUE</span><span class="o">|</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">POLS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_dma</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">landscape</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">U_LINES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* blanking lines point to first line of fb_buffer */</span>
			<span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fb_buffer</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">U_LINES</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">U_LINES</span> <span class="o">+</span> <span class="n">LCD_Y_RES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* visible lines */</span>
			<span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fb_buffer</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">LCD_Y_RES</span><span class="o">+</span><span class="n">U_LINES</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* last descriptor points to first */</span>
		<span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">LCD_Y_RES</span><span class="o">+</span><span class="n">U_LINES</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">set_dma_x_count</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">LCD_X_RES</span><span class="p">);</span>
		<span class="n">set_dma_x_modify</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">LCD_Y_RES</span> <span class="o">*</span> <span class="p">(</span><span class="n">LCD_BBP</span> <span class="o">/</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">set_dma_y_count</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_dma_y_modify</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_dma_next_desc_addr</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dma_desc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">set_dma_config</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">DMAFLOW_LARGE</span> <span class="o">|</span> <span class="n">NDSIZE_4</span> <span class="o">|</span> <span class="n">WDSIZE_16</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">set_dma_config</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">set_bfin_dma_config</span><span class="p">(</span><span class="n">DIR_READ</span><span class="p">,</span>
				<span class="n">DMA_FLOW_AUTO</span><span class="p">,</span>
				<span class="n">INTR_DISABLE</span><span class="p">,</span>
				<span class="n">DIMENSION_2D</span><span class="p">,</span>
				<span class="n">DATA_SIZE_16</span><span class="p">,</span>
				<span class="n">DMA_NOSYNC_KEEP_DMA_BUF</span><span class="p">));</span>
		<span class="n">set_dma_x_count</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">LCD_X_RES</span><span class="p">);</span>
		<span class="n">set_dma_x_modify</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">LCD_BBP</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">set_dma_y_count</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">LCD_Y_RES</span><span class="o">+</span><span class="n">U_LINES</span><span class="p">);</span>
		<span class="n">set_dma_y_modify</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">LCD_BBP</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">set_dma_start_addr</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fb_buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">request_ports</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmr_req</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TIMERS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">		UD:      PF13</span>
<span class="cm">		MOD:     PF10</span>
<span class="cm">		LBR:     PF14</span>
<span class="cm">		PPI_CLK: PF15</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peripheral_request_list</span><span class="p">(</span><span class="n">ppi_pins</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;requesting PPI peripheral failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peripheral_request_list</span><span class="p">(</span><span class="n">tmr_req</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">peripheral_free_list</span><span class="p">(</span><span class="n">ppi_pins</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;requesting timer peripheral failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if (defined(UD) &amp;&amp; defined(LBR))</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request_one</span><span class="p">(</span><span class="n">UD</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_LOW</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;requesting GPIO %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">UD</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request_one</span><span class="p">(</span><span class="n">LBR</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_HIGH</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;requesting GPIO %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LBR</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">UD</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request_one</span><span class="p">(</span><span class="n">MOD</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_HIGH</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;requesting GPIO %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MOD</span><span class="p">);</span>
<span class="cp">#if (defined(UD) &amp;&amp; defined(LBR))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">LBR</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">UD</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SSYNC</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_ports</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmr_req</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TIMERS</span><span class="p">;</span>

	<span class="n">peripheral_free_list</span><span class="p">(</span><span class="n">ppi_pins</span><span class="p">);</span>
	<span class="n">peripheral_free_list</span><span class="p">(</span><span class="n">tmr_req</span><span class="p">);</span>

<span class="cp">#if defined(UD) &amp;&amp; defined(LBR)</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">LBR</span><span class="p">);</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">UD</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">MOD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="n">bfin_lq035_fb</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">bfin_lq035_fb_defined</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span>		<span class="o">=</span> <span class="n">LCD_BBP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span>		<span class="o">=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres</span>			<span class="o">=</span> <span class="n">LCD_X_RES</span><span class="p">,</span>	<span class="cm">/*default portrait mode RGB*/</span>
	<span class="p">.</span><span class="n">yres</span>			<span class="o">=</span> <span class="n">LCD_Y_RES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span>		<span class="o">=</span> <span class="n">LCD_X_RES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span>		<span class="o">=</span> <span class="n">LCD_Y_RES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span>			<span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">green</span>			<span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span>			<span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">transp</span>		<span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">bfin_lq035_fb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">smem_len</span>	<span class="o">=</span> <span class="n">ACTIVE_VIDEO_MEM_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span>		<span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_length</span>	<span class="o">=</span> <span class="n">LCD_X_RES</span><span class="o">*</span><span class="p">(</span><span class="n">LCD_BBP</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span>
	<span class="p">.</span><span class="n">accel</span>		<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lq035_fb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lq035_open_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lq035_open_cnt</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_write_PPI_CONTROL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>

		<span class="n">set_vcomm</span><span class="p">();</span>
		<span class="n">config_dma</span><span class="p">();</span>
		<span class="n">config_ppi</span><span class="p">();</span>

		<span class="cm">/* start dma */</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="n">bfin_write_PPI_CONTROL</span><span class="p">(</span><span class="n">bfin_read_PPI_CONTROL</span><span class="p">()</span> <span class="o">|</span> <span class="n">PORT_EN</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t_conf_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config_timers</span><span class="p">();</span>
			<span class="n">start_timers</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="cm">/* gpio_set_value(MOD,1); */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lq035_fb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lq035_open_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">lq035_open_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">bfin_write_PPI_CONTROL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>

		<span class="n">disable_dma</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lq035_fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:<span class="cm">/* DIRECTCOLOUR, 64k */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: depth not supported: %u BPP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Resolution not supported: X%u x Y%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Memory limit</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Memory Limit requested yres_virtual = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* fb_rotate</span>
<span class="cm"> * Rotate the display of this angle. This doesn&#39;t seems to be used by the core,</span>
<span class="cm"> * but as our hardware supports it, so why not implementing it...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_lq035_fb_rotate</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">angle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %p %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fbi</span><span class="p">,</span> <span class="n">angle</span><span class="p">);</span>
<span class="cp">#if (defined(UD) &amp;&amp; defined(LBR))</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="mi">180</span>:
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">LBR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">UD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">LBR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">UD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lq035_fb_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_cursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nocursor</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* just to force soft_cursor() call */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lq035_fb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span>
				   <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">NBR_PALETTE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
		<span class="cm">/* grayscale = 0.30*R + 0.59*G + 0.11*B */</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">77</span> <span class="o">+</span> <span class="n">green</span> <span class="o">*</span> <span class="mi">151</span> <span class="o">+</span> <span class="n">blue</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
		<span class="cm">/* Place color in the pseudopalette */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">red</span>   <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">blue</span>  <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span>   <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span><span class="o">|</span>
			<span class="p">(</span><span class="n">blue</span>  <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">bfin_lq035_fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>		<span class="o">=</span> <span class="n">bfin_lq035_fb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>		<span class="o">=</span> <span class="n">bfin_lq035_fb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>		<span class="o">=</span> <span class="n">bfin_lq035_fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_rotate</span>		<span class="o">=</span> <span class="n">bfin_lq035_fb_rotate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>		<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>		<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>		<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_cursor</span>		<span class="o">=</span> <span class="n">bfin_lq035_fb_cursor</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>		<span class="o">=</span> <span class="n">bfin_lq035_fb_setcolreg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bl_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">current_brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">bfin_lq035fb_bl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span>	<span class="o">=</span> <span class="n">bl_get_brightness</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bl_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lcd_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lcd_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lcd_get_contrast</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vcomm_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lcd_set_contrast</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">contrast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">contrast</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">contrast</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">contrast</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">contrast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vcomm_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">contrast</span><span class="p">;</span>
	<span class="n">set_vcomm</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lcd_check_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">lcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fi</span> <span class="o">||</span> <span class="p">(</span><span class="n">fi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">bfin_lq035_fb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lcd_ops</span> <span class="n">bfin_lcd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_power</span>	<span class="o">=</span> <span class="n">bfin_lcd_get_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_power</span>	<span class="o">=</span> <span class="n">bfin_lcd_set_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_contrast</span>	<span class="o">=</span> <span class="n">bfin_lcd_get_contrast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_contrast</span>	<span class="o">=</span> <span class="n">bfin_lcd_set_contrast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_fb</span>	<span class="o">=</span> <span class="n">bfin_lcd_check_fb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">lcd_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bfin_lq035_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t request PPI DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_ports</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t request gpio port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_ports</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_buffer</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TOTAL_VIDEO_MEM_SIZE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t allocate dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_dma_coherent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span>
		<span class="n">dma_desc_table</span> <span class="o">=</span> <span class="n">l1_data_sram_zalloc</span><span class="p">(</span><span class="n">TOTAL_DMA_DESC_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma_desc_table</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TOTAL_DMA_DESC_SIZE</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_desc_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;couldn&#39;t allocate dma descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_table</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fb_buffer</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb_fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fb_buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">landscape</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">LCD_Y_RES</span><span class="p">;</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">LCD_X_RES</span><span class="p">;</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">LCD_Y_RES</span><span class="p">;</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">LCD_X_RES</span><span class="p">;</span>

		<span class="n">bfin_lq035_fb_fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">LCD_Y_RES</span><span class="o">*</span><span class="p">(</span><span class="n">LCD_BBP</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">+=</span> <span class="n">ACTIVE_VIDEO_MEM_OFFSET</span><span class="p">;</span>
		<span class="n">bfin_lq035_fb_fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+=</span> <span class="n">ACTIVE_VIDEO_MEM_OFFSET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>      <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">bfin_lq035_fb_defined</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfin_lq035_fb_ops</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">bfin_lq035_fb_defined</span><span class="p">;</span>

	<span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">fix</span> <span class="o">=</span> <span class="n">bfin_lq035_fb_fix</span><span class="p">;</span>
	<span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>


	<span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">pseudo_palette</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to allocate pseudo_palette</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_palette</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">NBR_PALETTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to allocate colormap (%d entries)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">NBR_PALETTE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_fb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad5280_driver</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">props</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_RAW</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">MAX_BRIGHENESS</span><span class="p">;</span>
	<span class="n">bl_dev</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="s">&quot;bf537-bl&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">bfin_lq035fb_bl_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>

	<span class="n">lcd_dev</span> <span class="o">=</span> <span class="n">lcd_device_register</span><span class="p">(</span><span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bfin_lcd_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lcd_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register lcd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lcd_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_lcd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lcd_dev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">max_contrast</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;initialized&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_lcd:</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_fb</span><span class="p">);</span>
<span class="nl">out_reg:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">out_cmap:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">);</span>
<span class="nl">out_palette:</span>
<span class="nl">out_table:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TOTAL_VIDEO_MEM_SIZE</span><span class="p">,</span> <span class="n">fb_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fb_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_dma_coherent:</span>
	<span class="n">free_ports</span><span class="p">();</span>
<span class="nl">out_ports:</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">bfin_lq035_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TOTAL_VIDEO_MEM_SIZE</span><span class="p">,</span> <span class="n">fb_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span>
		<span class="n">l1_data_sram_free</span><span class="p">(</span><span class="n">dma_desc_table</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TOTAL_DMA_DESC_SIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bfin_write_TIMER_DISABLE</span><span class="p">(</span><span class="n">TIMEN_SP</span><span class="o">|</span><span class="n">TIMEN_SPS</span><span class="o">|</span><span class="n">TIMEN_PS_CLS</span><span class="o">|</span>
				 <span class="n">TIMEN_LP</span><span class="o">|</span><span class="n">TIMEN_REV</span><span class="p">);</span>
	<span class="n">t_conf_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">free_dma</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">);</span>


	<span class="n">kfree</span><span class="p">(</span><span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">);</span>


	<span class="n">lcd_device_unregister</span><span class="p">(</span><span class="n">lcd_dev</span><span class="p">);</span>
	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">bl_dev</span><span class="p">);</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_fb</span><span class="p">);</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad5280_driver</span><span class="p">);</span>

	<span class="n">free_ports</span><span class="p">();</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;unregistered LCD driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lq035_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq035_open_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_write_PPI_CONTROL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_lq035_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq035_open_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_write_PPI_CONTROL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>

		<span class="n">config_dma</span><span class="p">();</span>
		<span class="n">config_ppi</span><span class="p">();</span>

		<span class="n">enable_dma</span><span class="p">(</span><span class="n">CH_PPI</span><span class="p">);</span>
		<span class="n">bfin_write_PPI_CONTROL</span><span class="p">(</span><span class="n">bfin_read_PPI_CONTROL</span><span class="p">()</span> <span class="o">|</span> <span class="n">PORT_EN</span><span class="p">);</span>
		<span class="n">SSYNC</span><span class="p">();</span>

		<span class="n">config_timers</span><span class="p">();</span>
		<span class="n">start_timers</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t_conf_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp"># define bfin_lq035_suspend	NULL</span>
<span class="cp"># define bfin_lq035_resume	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">bfin_lq035_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">bfin_lq035_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bfin_lq035_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">bfin_lq035_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">bfin_lq035_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bfin_lq035_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;i2c-bfin-twi&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">bfin_lq035_driver_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">bfin_lq035_driver_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_lq035_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">bfin_lq035_driver_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SHARP LQ035Q7DB03 TFT LCD Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
