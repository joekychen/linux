<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › carminefb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>carminefb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Frame buffer driver for the Carmine GPU.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver configures the GPU as follows</span>
<span class="cm"> * - FB0 is display 0 with unique memory area</span>
<span class="cm"> * - FB1 is display 1 with unique memory area</span>
<span class="cm"> * - both display use 32 bit colors</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;carminefb.h&quot;</span>
<span class="cp">#include &quot;carminefb_regs.h&quot;</span>

<span class="cp">#if !defined(__LITTLE_ENDIAN) &amp;&amp; !defined(__BIG_ENDIAN)</span>
<span class="cp">#error  &quot;The endianness of the target host has not been defined.&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * The initial video mode can be supplied via two different ways:</span>
<span class="cm"> * - as a string that is passed to fb_find_mode() (module option fb_mode_str)</span>
<span class="cm"> * - as an integer that picks the video mode from carmine_modedb[] (module</span>
<span class="cm"> *   option fb_mode)</span>
<span class="cm"> *</span>
<span class="cm"> * If nothing is used than the initial video mode will be the</span>
<span class="cm"> * CARMINEFB_DEFAULT_VIDEO_MODE member of the carmine_modedb[].</span>
<span class="cm"> */</span>
<span class="cp">#define CARMINEFB_DEFAULT_VIDEO_MODE	1</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fb_mode</span> <span class="o">=</span> <span class="n">CARMINEFB_DEFAULT_VIDEO_MODE</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fb_mode</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fb_mode</span><span class="p">,</span> <span class="s">&quot;Initial video mode as integer.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fb_mode_str</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fb_mode_str</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fb_mode_str</span><span class="p">,</span> <span class="s">&quot;Initial video mode in characters.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Carminefb displays:</span>
<span class="cm"> * 0b000 None</span>
<span class="cm"> * 0b001 Display 0</span>
<span class="cm"> * 0b010 Display 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fb_displays</span> <span class="o">=</span> <span class="n">CARMINE_USE_DISPLAY0</span> <span class="o">|</span> <span class="n">CARMINE_USE_DISPLAY1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fb_displays</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fb_displays</span><span class="p">,</span> <span class="s">&quot;Bit mode, which displays are used&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">carmine_hw</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">v_regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">screen_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">[</span><span class="n">MAX_DISPLAY</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">carmine_resolution</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">htp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hdp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vtr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vsp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vsw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vdp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">disp_mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">carmine_fb</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">display_reg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">screen_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">smem_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carmine_resolution</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">carminefb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;Carmine&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">carmine_modedb</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;640x480&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;800x600&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">carmine_resolution</span> <span class="n">car_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* 640x480 */</span>
		<span class="p">.</span><span class="n">htp</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsp</span> <span class="o">=</span> <span class="mi">672</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsw</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdp</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vtr</span> <span class="o">=</span> <span class="mi">525</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsp</span> <span class="o">=</span> <span class="mi">490</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdp</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">disp_mode</span> <span class="o">=</span> <span class="mh">0x1400</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* 800x600 */</span>
		<span class="p">.</span><span class="n">htp</span> <span class="o">=</span> <span class="mi">1060</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsp</span> <span class="o">=</span> <span class="mi">864</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsw</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdp</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vtr</span> <span class="o">=</span> <span class="mi">628</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsp</span> <span class="o">=</span> <span class="mi">601</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdp</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
		<span class="p">.</span><span class="n">disp_mode</span> <span class="o">=</span> <span class="mh">0x0d00</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carmine_find_mode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">car_modes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">car_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hdp</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;&amp;</span>
		    <span class="n">car_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vdp</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">c_set_disp_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">carmine_fb</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">display_reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">c_get_disp_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">carmine_fb</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display_reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">c_set_hw_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">carmine_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">c_get_hw_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">carmine_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carmine_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">transp</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
		<span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carmine_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">carmine_find_mode</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carmine_init_display_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">carmine_fb</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">window_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">soffset</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">smem_offset</span><span class="p">;</span>

	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_C_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_MLMR_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_CURSOR_MODE</span><span class="p">,</span>
			<span class="n">CARMINE_CURSOR0_PRIORITY_MASK</span> <span class="o">|</span>
			<span class="n">CARMINE_CURSOR1_PRIORITY_MASK</span> <span class="o">|</span>
			<span class="n">CARMINE_CURSOR_CUTZ_MASK</span><span class="p">);</span>

	<span class="cm">/* Set default cursor position */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_CUR1_POS</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_CUR2_POS</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set default display mode */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_EXT_MODE</span><span class="p">,</span> <span class="n">CARMINE_WINDOW_MODE</span> <span class="o">|</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L1_EXT_MODE</span><span class="p">,</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_EXT_MODE</span><span class="p">,</span> <span class="n">CARMINE_EXTEND_MODE</span> <span class="o">|</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_EXT_MODE</span><span class="p">,</span> <span class="n">CARMINE_EXTEND_MODE</span> <span class="o">|</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_EXT_MODE</span><span class="p">,</span> <span class="n">CARMINE_EXTEND_MODE</span> <span class="o">|</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_EXT_MODE</span><span class="p">,</span> <span class="n">CARMINE_EXTEND_MODE</span> <span class="o">|</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_EXT_MODE</span><span class="p">,</span> <span class="n">CARMINE_EXTEND_MODE</span> <span class="o">|</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_EXT_MODE</span><span class="p">,</span> <span class="n">CARMINE_EXTEND_MODE</span> <span class="o">|</span>
			<span class="n">CARMINE_EXT_CMODE_DIRECT24_RGBA</span><span class="p">);</span>

	<span class="cm">/* Set default frame size to layer mode register */</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">hdp</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">CARMINE_DISP_WIDTH_UNIT</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_WIDTH_SHIFT</span><span class="p">;</span>

	<span class="n">height</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vdp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">width</span> <span class="o">|</span> <span class="n">height</span><span class="p">;</span>

	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_MODE_W_H</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L1_WIDTH</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_MODE_W_H</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_MODE_W_H</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_MODE_W_H</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_MODE_W_H</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_MODE_W_H</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_MODE_W_H</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="cm">/* Set default pos and size */</span>
	<span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vdp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_WIN_H_SHIFT</span><span class="p">;</span>
	<span class="n">window_size</span> <span class="o">|=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">hdp</span><span class="p">;</span>

	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L1_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L1_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_WIN_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_WIN_SIZE</span><span class="p">,</span> <span class="n">window_size</span><span class="p">);</span>

	<span class="cm">/* Set default origin address */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_ORG_ADR</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L1_ORG_ADR</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_ORG_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_ORG_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_ORG_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_ORG_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_ORG_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_ORG_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>

	<span class="cm">/* Set default display address */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_DISP_ADR</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_DISP_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_DISP_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_DISP_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_DISP_ADR1</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_DISP_ADR0</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_DISP_ADR0</span><span class="p">,</span> <span class="n">soffset</span><span class="p">);</span>

	<span class="cm">/* Set default display position */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_DISP_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_DISP_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_DISP_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_DISP_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_DISP_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_DISP_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_DISP_POS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set default blend mode */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_BLEND_MODE_L7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* default transparency mode */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L1_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7_TRANS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set default read skip parameter */</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0RM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2RM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3RM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4RM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5RM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6RM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7RM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L0PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L2PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L3PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L4PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L5PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L6PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_L7PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_display_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">carmine_fb</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hdp</span><span class="p">,</span> <span class="n">vdp</span><span class="p">,</span> <span class="n">htp</span><span class="p">,</span> <span class="n">hsp</span><span class="p">,</span> <span class="n">hsw</span><span class="p">,</span> <span class="n">vtr</span><span class="p">,</span> <span class="n">vsp</span><span class="p">,</span> <span class="n">vsw</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * display timing. Parameters are decreased by one because hardware</span>
<span class="cm">	 * spec is 0 to (n - 1)</span>
<span class="cm">	 * */</span>
	<span class="n">hdp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">hdp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vdp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vdp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">htp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">htp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">hsp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsw</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">hsw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vtr</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vtr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vsp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsw</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">vsw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_H_TOTAL</span><span class="p">,</span>
			<span class="n">htp</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_HTP_SHIFT</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_H_PERIOD</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hdp</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_HDB_SHIFT</span><span class="p">)</span>	<span class="o">|</span> <span class="n">hdp</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_V_H_W_H_POS</span><span class="p">,</span>
			<span class="p">(</span><span class="n">vsw</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_VSW_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">hsw</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_HSW_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">hsp</span><span class="p">));</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_V_TOTAL</span><span class="p">,</span>
			<span class="n">vtr</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_VTR_SHIFT</span><span class="p">);</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_V_PERIOD_POS</span><span class="p">,</span>
			<span class="p">(</span><span class="n">vdp</span> <span class="o">&lt;&lt;</span> <span class="n">CARMINE_DISP_VDP_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">vsp</span><span class="p">);</span>

	<span class="cm">/* clock */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">c_get_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_DCM1</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CARMINE_DISP_DCM_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">disp_mode</span> <span class="o">&amp;</span> <span class="n">CARMINE_DISP_DCM_MASK</span><span class="p">);</span>
	<span class="cm">/* enable video output and layer 0 */</span>
	<span class="n">mode</span> <span class="o">|=</span> <span class="n">CARMINE_DEN</span> <span class="o">|</span> <span class="n">CARMINE_L0E</span><span class="p">;</span>
	<span class="n">c_set_disp_reg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">CARMINE_DISP_REG_DCM1</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carmine_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carmine_fb</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">carmine_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cur_mode</span> <span class="o">!=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cur_mode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">car_modes</span><span class="p">[</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">];</span>

		<span class="n">carmine_init_display_param</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">set_display_parameters</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">carmine_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Initialize Carmine */</span>
	<span class="cm">/* Sets internal clock */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_CTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_CTL_REG_CLOCK_ENABLE</span><span class="p">,</span>
			<span class="n">CARMINE_DFLT_IP_CLOCK_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Video signal output is turned off */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DISP0_REG</span> <span class="o">+</span> <span class="n">CARMINE_DISP_REG_DCM1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DISP1_REG</span> <span class="o">+</span> <span class="n">CARMINE_DISP_REG_DCM1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Software reset */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_CTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_CTL_REG_SOFTWARE_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_CTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_CTL_REG_SOFTWARE_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* I/O mode settings */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_IO_CONT1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">CARMINE_DFLT_IP_DCTL_IO_CONT0</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_IOCONT1_IOCONT0</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* DRAM initial sequence */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_MODE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">CARMINE_DFLT_IP_DCTL_ADD</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_MODE_ADD</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_SET_TIME1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">CARMINE_DFLT_IP_DCTL_EMODE</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_SETTIME1_EMODE</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_REFRESH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">CARMINE_DFLT_IP_DCTL_SET_TIME2</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_REFRESH_SETTIME2</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_RESERVE2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">CARMINE_DFLT_IP_DCTL_FIFO_DEPTH</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_RSV2_RSV1</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_DDRIF2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">CARMINE_DFLT_IP_DCTL_DDRIF1</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_DDRIF2_DDRIF1</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_RESERVE0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">CARMINE_DFLT_IP_DCTL_STATES</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_RSV0_STATES</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Executes DLL reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CARMINE_DCTL_DLL_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loops</span> <span class="o">&lt;</span> <span class="n">CARMINE_DCTL_INIT_WAIT_LIMIT</span><span class="p">;</span> <span class="n">loops</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">c_get_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span>
					<span class="n">CARMINE_DCTL_REG_RSV0_STATES</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">CARMINE_DCTL_REG_STATES_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">mdelay</span><span class="p">(</span><span class="n">CARMINE_DCTL_INIT_WAIT_INTERVAL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&gt;=</span> <span class="n">CARMINE_DCTL_INIT_WAIT_LIMIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DRAM init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_MODE_AFT_RST</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">CARMINE_DFLT_IP_DCTL_ADD</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_MODE_ADD</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">CARMINE_DFLT_IP_DCTL_RESERVE0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">CARMINE_DFLT_IP_DCTL_STATES_AFT_RST</span><span class="p">;</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DCTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_DCTL_REG_RSV0_STATES</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Initialize the write back register */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_WB_REG</span> <span class="o">+</span> <span class="n">CARMINE_WB_REG_WBM</span><span class="p">,</span>
			<span class="n">CARMINE_WB_REG_WBM_DEFAULT</span><span class="p">);</span>

	<span class="cm">/* Initialize the Kottos registers */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_VRINTM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_VRERRM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set DC offsets */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_DC_OFFSET_PX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_DC_OFFSET_PY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_DC_OFFSET_LX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_DC_OFFSET_LY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_DC_OFFSET_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_GRAPH_REG</span> <span class="o">+</span> <span class="n">CARMINE_GRAPH_REG_DC_OFFSET_TY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">carminefb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>

	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">carmine_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">carmine_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">carmine_setcolreg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">alloc_carmine_fb</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smem_base</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">smem_offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">**</span><span class="n">rinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carmine_fb</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">display_reg</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">smem_offset</span> <span class="o">=</span> <span class="n">smem_offset</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">smem_base</span> <span class="o">+</span> <span class="n">smem_offset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">CARMINE_DISPLAY_MEM</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">carminefb_ops</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">carminefb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_fb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_mode</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">carmine_modedb</span><span class="p">))</span>
		<span class="n">fb_mode</span> <span class="o">=</span> <span class="n">CARMINEFB_DEFAULT_VIDEO_MODE</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">cur_mode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fb_mode_str</span><span class="p">,</span> <span class="n">carmine_modedb</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">carmine_modedb</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">carmine_modedb</span><span class="p">[</span><span class="n">fb_mode</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dealloc_cmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">carmine_modedb</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">carmine_modedb</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dealloc_cmap</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rinfo</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_dealloc_cmap:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">err_free_fb:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_fb_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">carminefb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carmine_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_enable_pci</span><span class="p">;</span>

	<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CARMINE_CONFIG_BAR</span><span class="p">);</span>
	<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CARMINE_CONFIG_BAR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span>
				<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">,</span>
				<span class="s">&quot;carminefb regbase&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;carminefb: Can&#39;t reserve regbase.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_hw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span>
			<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;carminefb: Can&#39;t remap %s register.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_reg_mmio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CARMINE_MEMORY_BAR</span><span class="p">);</span>
	<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CARMINE_MEMORY_BAR</span><span class="p">);</span>

	<span class="cm">/* The memory area tends to be very large (256 MiB). Remap only what</span>
<span class="cm">	 * is required for that largest resolution to avoid remaps at run</span>
<span class="cm">	 * time</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&gt;</span> <span class="n">CARMINE_TOTAL_DIPLAY_MEM</span><span class="p">)</span>
		<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">CARMINE_TOTAL_DIPLAY_MEM</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&lt;</span> <span class="n">CARMINE_TOTAL_DIPLAY_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;carminefb: Memory bar is only %d bytes, %d &quot;</span>
				<span class="s">&quot;are required.&quot;</span><span class="p">,</span> <span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				<span class="n">CARMINE_TOTAL_DIPLAY_MEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_vregs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
				<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>	<span class="s">&quot;carminefb smem&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;carminefb: Can&#39;t reserve smem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap_vregs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">screen_mem</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			<span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">screen_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;carmine: Can&#39;t ioremap smem area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_reg_smem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_hardware</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap_screen</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_displays</span> <span class="o">&amp;</span> <span class="n">CARMINE_USE_DISPLAY0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_carmine_fb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">CARMINE_DISP0_REG</span><span class="p">,</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">screen_mem</span><span class="p">,</span> <span class="n">CARMINE_DISPLAY_MEM</span> <span class="o">*</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_deinit_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_displays</span> <span class="o">&amp;</span> <span class="n">CARMINE_USE_DISPLAY1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_carmine_fb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">CARMINE_DISP1_REG</span><span class="p">,</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">screen_mem</span><span class="p">,</span> <span class="n">CARMINE_DISPLAY_MEM</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_cleanup_fb0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_cleanup_fb0:</span>
	<span class="n">cleanup_fb_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">err_deinit_hw:</span>
	<span class="cm">/* disable clock, etc */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_CTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_CTL_REG_CLOCK_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err_unmap_screen:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">screen_mem</span><span class="p">);</span>
<span class="nl">err_reg_smem:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">carminefb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
<span class="nl">err_unmap_vregs:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">);</span>
<span class="nl">err_free_reg_mmio:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">carminefb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
<span class="nl">err_free_hw:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="nl">err_enable_pci:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">carminefb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carmine_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">fix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* in case we use only fb1 and not fb1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">fix</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fix</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>

	<span class="cm">/* deactivate display(s) and switch clocks */</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DISP0_REG</span> <span class="o">+</span> <span class="n">CARMINE_DISP_REG_DCM1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_DISP1_REG</span> <span class="o">+</span> <span class="n">CARMINE_DISP_REG_DCM1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c_set_hw_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CARMINE_CTL_REG</span> <span class="o">+</span> <span class="n">CARMINE_CTL_REG_CLOCK_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DISPLAY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cleanup_fb_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">screen_mem</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PCI_VENDOR_ID_FUJITU_LIMITED 0x10cf</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">carmine_devices</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_FUJITU_LIMITED</span><span class="p">,</span> <span class="mh">0x202b</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">carmine_devices</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">carmine_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;carminefb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">carmine_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">carminefb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">carminefb_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">carminefb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fb_displays</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">CARMINE_USE_DISPLAY0</span> <span class="o">|</span> <span class="n">CARMINE_USE_DISPLAY1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;If you disable both displays than you don&#39;t &quot;</span>
				<span class="s">&quot;need the driver at all</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carmine_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">carminefb_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">carminefb_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">carmine_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">carminefb_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sebastian Siewior &lt;bigeasy@linutronix.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for Fujitsu Carmine based devices&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
