<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › sa1100fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sa1100fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/sa1100fb.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1999 Eric A. Thomas</span>
<span class="cm"> *   Based on acornfb.c Copyright (C) Russell King.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> *	        StrongARM 1100 LCD Controller Frame Buffer Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Please direct your questions and comments on this driver to the following</span>
<span class="cm"> * email address:</span>
<span class="cm"> *</span>
<span class="cm"> *	linux-arm-kernel@lists.arm.linux.org.uk</span>
<span class="cm"> *</span>
<span class="cm"> * Clean patches should be sent to the ARM Linux Patch System.  Please see the</span>
<span class="cm"> * following web page for more information:</span>
<span class="cm"> *</span>
<span class="cm"> *	http://www.arm.linux.org.uk/developer/patches/info.shtml</span>
<span class="cm"> *</span>
<span class="cm"> * Thank you.</span>
<span class="cm"> *</span>
<span class="cm"> * Known problems:</span>
<span class="cm"> *	- With the Neponset plugged into an Assabet, LCD powerdown</span>
<span class="cm"> *	  doesn&#39;t work (LCD stays powered up).  Therefore we shouldn&#39;t</span>
<span class="cm"> *	  blank the screen.</span>
<span class="cm"> *	- We don&#39;t limit the CPU clock rate nor the mode selection</span>
<span class="cm"> *	  according to the available SDRAM bandwidth.</span>
<span class="cm"> *</span>
<span class="cm"> * Other notes:</span>
<span class="cm"> *	- Linear grayscale palettes and the kernel.</span>
<span class="cm"> *	  Such code does not belong in the kernel.  The kernel frame buffer</span>
<span class="cm"> *	  drivers do not expect a linear colourmap, but a colourmap based on</span>
<span class="cm"> *	  the VT100 standard mapping.</span>
<span class="cm"> *</span>
<span class="cm"> *	  If your _userspace_ requires a linear colourmap, then the setup of</span>
<span class="cm"> *	  such a colourmap belongs _in userspace_, not in the kernel.  Code</span>
<span class="cm"> *	  to set the colourmap correctly from user space has been sent to</span>
<span class="cm"> *	  David Neuer.  It&#39;s around 8 lines of C code, plus another 4 to</span>
<span class="cm"> *	  detect if we are using grayscale.</span>
<span class="cm"> *</span>
<span class="cm"> *	- The following must never be specified in a panel definition:</span>
<span class="cm"> *	     LCCR0_LtlEnd, LCCR3_PixClkDiv, LCCR3_VrtSnchL, LCCR3_HorSnchL</span>
<span class="cm"> *</span>
<span class="cm"> *	- The following should be specified:</span>
<span class="cm"> *	     either LCCR0_Color or LCCR0_Mono</span>
<span class="cm"> *	     either LCCR0_Sngl or LCCR0_Dual</span>
<span class="cm"> *	     either LCCR0_Act or LCCR0_Pas</span>
<span class="cm"> *	     either LCCR3_OutEnH or LCCD3_OutEnL</span>
<span class="cm"> *	     either LCCR3_PixRsEdg or LCCR3_PixFlEdg</span>
<span class="cm"> *	     either LCCR3_ACBsDiv or LCCR3_ACBsCntOff</span>
<span class="cm"> *</span>
<span class="cm"> * Code Status:</span>
<span class="cm"> * 1999/04/01:</span>
<span class="cm"> *	- Driver appears to be working for Brutus 320x200x8bpp mode.  Other</span>
<span class="cm"> *	  resolutions are working, but only the 8bpp mode is supported.</span>
<span class="cm"> *	  Changes need to be made to the palette encode and decode routines</span>
<span class="cm"> *	  to support 4 and 16 bpp modes.  </span>
<span class="cm"> *	  Driver is not designed to be a module.  The FrameBuffer is statically</span>
<span class="cm"> *	  allocated since dynamic allocation of a 300k buffer cannot be </span>
<span class="cm"> *	  guaranteed. </span>
<span class="cm"> *</span>
<span class="cm"> * 1999/06/17:</span>
<span class="cm"> *	- FrameBuffer memory is now allocated at run-time when the</span>
<span class="cm"> *	  driver is initialized.    </span>
<span class="cm"> *</span>
<span class="cm"> * 2000/04/10: Nicolas Pitre &lt;nico@fluxnic.net&gt;</span>
<span class="cm"> *	- Big cleanup for dynamic selection of machine type at run time.</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/07/19: Jamey Hicks &lt;jamey@crl.dec.com&gt;</span>
<span class="cm"> *	- Support for Bitsy aka Compaq iPAQ H3600 added.</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/08/07: Tak-Shing Chan &lt;tchan.rd@idthk.com&gt;</span>
<span class="cm"> *	       Jeff Sutherland &lt;jsutherland@accelent.com&gt;</span>
<span class="cm"> *	- Resolved an issue caused by a change made to the Assabet&#39;s PLD </span>
<span class="cm"> *	  earlier this year which broke the framebuffer driver for newer </span>
<span class="cm"> *	  Phase 4 Assabets.  Some other parameters were changed to optimize</span>
<span class="cm"> *	  for the Sharp display.</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/08/09: Kunihiko IMAI &lt;imai@vasara.co.jp&gt;</span>
<span class="cm"> *	- XP860 support added</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/08/19: Mark Huang &lt;mhuang@livetoy.com&gt;</span>
<span class="cm"> *	- Allows standard options to be passed on the kernel command line</span>
<span class="cm"> *	  for most common passive displays.</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/08/29:</span>
<span class="cm"> *	- s/save_flags_cli/local_irq_save/</span>
<span class="cm"> *	- remove unneeded extra save_flags_cli in sa1100fb_enable_lcd_controller</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/10/10: Erik Mouw &lt;J.A.K.Mouw@its.tudelft.nl&gt;</span>
<span class="cm"> *	- Updated LART stuff. Fixed some minor bugs.</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/10/30: Murphy Chen &lt;murphy@mail.dialogue.com.tw&gt;</span>
<span class="cm"> *	- Pangolin support added</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/10/31: Roman Jordan &lt;jor@hoeft-wessel.de&gt;</span>
<span class="cm"> *	- Huw Webpanel support added</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/11/23: Eric Peng &lt;ericpeng@coventive.com&gt;</span>
<span class="cm"> *	- Freebird add</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/02/07: Jamey Hicks &lt;jamey.hicks@compaq.com&gt; </span>
<span class="cm"> *	       Cliff Brake &lt;cbrake@accelent.com&gt;</span>
<span class="cm"> *	- Added PM callback</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/05/26: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Fix 16bpp so that (a) we use the right colours rather than some</span>
<span class="cm"> *	  totally random colour depending on what was in page 0, and (b)</span>
<span class="cm"> *	  we don&#39;t de-reference a NULL pointer.</span>
<span class="cm"> *	- remove duplicated implementation of consistent_alloc()</span>
<span class="cm"> *	- convert dma address types to dma_addr_t</span>
<span class="cm"> *	- remove unused &#39;montype&#39; stuff</span>
<span class="cm"> *	- remove redundant zero inits of init_var after the initial</span>
<span class="cm"> *	  memset.</span>
<span class="cm"> *	- remove allow_modeset (acornfb idea does not belong here)</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/05/28: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- massive cleanup - move machine dependent data into structures</span>
<span class="cm"> *	- I&#39;ve left various #warnings in - if you see one, and know</span>
<span class="cm"> *	  the hardware concerned, please get in contact with me.</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/05/31: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Fix LCCR1 HSW value, fix all machine type specifications to</span>
<span class="cm"> *	  keep values in line.  (Please check your machine type specs)</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/06/10: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Fiddle with the LCD controller from task context only; mainly</span>
<span class="cm"> *	  so that we can run with interrupts on, and sleep.</span>
<span class="cm"> *	- Convert #warnings into #errors.  No pain, no gain. ;)</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/06/14: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Make the palette BPS value for 12bpp come out correctly.</span>
<span class="cm"> *	- Take notice of &quot;greyscale&quot; on any colour depth.</span>
<span class="cm"> *	- Make truecolor visuals use the RGB channel encoding information.</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/07/02: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Fix colourmap problems.</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/07/13: &lt;abraham@2d3d.co.za&gt;</span>
<span class="cm"> *	- Added support for the ICP LCD-Kit01 on LART. This LCD is</span>
<span class="cm"> *	  manufactured by Prime View, model no V16C6448AB</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/07/23: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Hand merge version from handhelds.org CVS tree.  See patch</span>
<span class="cm"> *	  notes for 595/1 for more information.</span>
<span class="cm"> *	- Drop 12bpp (it&#39;s 16bpp with different colour register mappings).</span>
<span class="cm"> *	- This hardware can not do direct colour.  Therefore we don&#39;t</span>
<span class="cm"> *	  support it.</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/07/27: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Halve YRES on dual scan LCDs.</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/08/22: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Add b/w iPAQ pixclock value.</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/10/12: &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *	- Add patch 681/1 and clean up stork definitions.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;video/sa1100fb.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;mach/shannon.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Complain if VAR is out of range.</span>
<span class="cm"> */</span>
<span class="cp">#define DEBUG_VAR 1</span>

<span class="cp">#include &quot;sa1100fb.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sa1100fb_rgb</span> <span class="n">rgb_4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sa1100fb_rgb</span> <span class="n">rgb_8</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sa1100fb_rgb</span> <span class="n">def_rgb_16</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">red</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">green</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">transp</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">int</span> <span class="n">sa1100fb_activate_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_ctrlr_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">state</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sa1100fb_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to handle two requests being made at the same time.</span>
<span class="cm">	 * There are two important cases:</span>
<span class="cm">	 *  1. When we are changing VT (C_REENABLE) while unblanking (C_ENABLE)</span>
<span class="cm">	 *     We must perform the unblanking, which will do our REENABLE for us.</span>
<span class="cm">	 *  2. When we are blanking, but immediately unblank before we have</span>
<span class="cm">	 *     blanked.  We do the &quot;REENABLE&quot; thing here as well, just to be sure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span> <span class="o">==</span> <span class="n">C_ENABLE</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">C_REENABLE</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span> <span class="o">==</span> <span class="n">C_DISABLE</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">C_ENABLE</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">C_REENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_int</span> <span class="nf">chan_to_field</span><span class="p">(</span><span class="n">u_int</span> <span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert bits-per-pixel to a hardware palette PBS value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_int</span> <span class="nf">palette_pbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>: <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sa1100fb_setpalettereg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		       <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">val</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00f</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">palette_pbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>

		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sa1100fb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
		   <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If inverse mode was selected, invert all the colours</span>
<span class="cm">	 * rather than the register number.  The register number</span>
<span class="cm">	 * is what you poke into the framebuffer to produce the</span>
<span class="cm">	 * colour you requested.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">cmap_inverse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">red</span>   <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="n">red</span><span class="p">;</span>
		<span class="n">green</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="n">green</span><span class="p">;</span>
		<span class="n">blue</span>  <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="n">blue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If greyscale is true, then we convert the RGB value</span>
<span class="cm">	 * to greyscale no mater what visual we are using.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">19595</span> <span class="o">*</span> <span class="n">red</span> <span class="o">+</span> <span class="mi">38470</span> <span class="o">*</span> <span class="n">green</span> <span class="o">+</span>
					<span class="mi">7471</span> <span class="o">*</span> <span class="n">blue</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 12 or 16-bit True Colour.  We encode the RGB value</span>
<span class="cm">		 * according to the RGB bitfield information.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">;</span>

			<span class="n">val</span>  <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>

			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span>:
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sa1100fb_setpalettereg</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="cm">/*</span>
<span class="cm"> *  sa1100fb_display_dma_period()</span>
<span class="cm"> *    Calculate the minimum period (in picoseconds) between two DMA</span>
<span class="cm"> *    requests for the LCD controller.  If we hit this, it means we&#39;re</span>
<span class="cm"> *    doing nothing but LCD DMA.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sa1100fb_display_dma_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Period = pixclock * bits_per_byte * bytes_per_transfer</span>
<span class="cm">	 *		/ memory_bits_per_pixel;</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  sa1100fb_check_var():</span>
<span class="cm"> *    Round up in the following order: bits_per_pixel, xres,</span>
<span class="cm"> *    yres, xres_virtual, yres_virtual, xoffset, yoffset, grayscale,</span>
<span class="cm"> *    bitfields, horizontal timing, vertical timing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sa1100fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rgbidx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">MIN_XRES</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">MIN_XRES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">MIN_YRES</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">MIN_YRES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;var-&gt;bits_per_pixel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">rgbidx</span> <span class="o">=</span> <span class="n">RGB_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">rgbidx</span> <span class="o">=</span> <span class="n">RGB_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">rgbidx</span> <span class="o">=</span> <span class="n">RGB_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the RGB parameters for this display</span>
<span class="cm">	 * from the machine specific parameters.</span>
<span class="cm">	 */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span>    <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">rgbidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span>  <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">rgbidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span>   <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">rgbidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">rgbidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RGBT length = %d:%d:%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RGBT offset = %d:%d:%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma period = %d ps, clock = %d kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sa1100fb_display_dma_period</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
		<span class="n">cpufreq_get</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()));</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1100fb_set_visual</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">visual</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">set_visual</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">set_visual</span><span class="p">(</span><span class="n">visual</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sa1100fb_set_par():</span>
<span class="cm"> *	Set the user defined part of the display for the specified console</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1100fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">palette_mem_size</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set_par</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">cmap_static</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Some people have weird ideas about wanting static</span>
<span class="cm">		 * pseudocolor maps.  I suspect their user space</span>
<span class="cm">		 * applications are broken.</span>
<span class="cm">		 */</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span>
				  <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">palette_mem_size</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;palette_mem_size = 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">palette_mem_size</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_cpu</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">palette_mem_size</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_dma</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_dma</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">palette_mem_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set (any) board control register to handle new color depth</span>
<span class="cm">	 */</span>
	<span class="n">sa1100fb_set_visual</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">);</span>
	<span class="n">sa1100fb_activate_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int</span>
<span class="c">sa1100fb_set_cmap(struct fb_cmap *cmap, int kspc, int con,</span>
<span class="c">		  struct fb_info *info)</span>
<span class="c">{</span>
<span class="c">	struct sa1100fb_info *fbi = (struct sa1100fb_info *)info;</span>

<span class="c">	/*</span>
<span class="c">	 * Make sure the user isn&#39;t doing something stupid.</span>
<span class="c">	 */</span>
<span class="c">	if (!kspc &amp;&amp; (fbi-&gt;fb.var.bits_per_pixel == 16 || fbi-&gt;inf-&gt;cmap_static))</span>
<span class="c">		return -EINVAL;</span>

<span class="c">	return gen_set_cmap(cmap, kspc, con, info);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Formal definition of the VESA spec:</span>
<span class="cm"> *  On</span>
<span class="cm"> *  	This refers to the state of the display when it is in full operation</span>
<span class="cm"> *  Stand-By</span>
<span class="cm"> *  	This defines an optional operating state of minimal power reduction with</span>
<span class="cm"> *  	the shortest recovery time</span>
<span class="cm"> *  Suspend</span>
<span class="cm"> *  	This refers to a level of power management in which substantial power</span>
<span class="cm"> *  	reduction is achieved by the display.  The display can have a longer </span>
<span class="cm"> *  	recovery time from this state than from the Stand-by state</span>
<span class="cm"> *  Off</span>
<span class="cm"> *  	This indicates that the display is consuming the lowest level of power</span>
<span class="cm"> *  	and is non-operational. Recovery from this state may optionally require</span>
<span class="cm"> *  	the user to manually power on the monitor</span>
<span class="cm"> *</span>
<span class="cm"> *  Now, the fbdev driver adds an additional state, (blank), where they</span>
<span class="cm"> *  turn off the video (maybe by colormap tricks), but don&#39;t mess with the</span>
<span class="cm"> *  video itself: think of it semantically between on and Stand-By.</span>
<span class="cm"> *</span>
<span class="cm"> *  So here&#39;s what we should do in our fbdev blank routine:</span>
<span class="cm"> *</span>
<span class="cm"> *  	VESA_NO_BLANKING (mode 0)	Video on,  front/back light on</span>
<span class="cm"> *  	VESA_VSYNC_SUSPEND (mode 1)  	Video on,  front/back light off</span>
<span class="cm"> *  	VESA_HSYNC_SUSPEND (mode 2)  	Video on,  front/back light off</span>
<span class="cm"> *  	VESA_POWERDOWN (mode 3)		Video off, front/back light off</span>
<span class="cm"> *</span>
<span class="cm"> *  This will match the matrox implementation.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * sa1100fb_blank():</span>
<span class="cm"> *	Blank the display by setting all palette values to zero.  Note, the </span>
<span class="cm"> * 	12 and 16 bpp modes don&#39;t really use the palette, so this will not</span>
<span class="cm"> *      blank the display in all modes.  </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1100fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sa1100fb_blank: blank=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">||</span>
		    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">sa1100fb_setpalettereg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">sa1100fb_schedule_work</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">||</span>
		    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">)</span>
			<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">sa1100fb_schedule_work</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1100fb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">off</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* skip over the palette */</span>
		<span class="k">return</span> <span class="n">dma_mmap_writecombine</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_cpu</span><span class="p">,</span>
					     <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_dma</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="n">start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">+=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_IO</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span> <span class="o">=</span> <span class="n">pgprot_noncached</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">io_remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
				   <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
				   <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">sa1100fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">sa1100fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">sa1100fb_set_par</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>.fb<em>set</em>cmap    = sa1100fb<em>set</em>cmap,</p></td><td class="code"><div class="highlight"><pre>	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">sa1100fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">sa1100fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_mmap</span>	<span class="o">=</span> <span class="n">sa1100fb_mmap</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the PCD value from the clock rate (in picoseconds).</span>
<span class="cm"> * We take account of the PPCR clock setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_pcd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpuclock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcd</span> <span class="o">=</span> <span class="n">cpuclock</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">pcd</span> <span class="o">*=</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="n">pcd</span> <span class="o">/=</span> <span class="mi">10000000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pcd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* make up for integer math truncations */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sa1100fb_activate_var():</span>
<span class="cm"> *	Configures LCD Controller based on entries in var parameter.  Settings are      </span>
<span class="cm"> *	only written to the controller if changes were made.  </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1100fb_activate_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_lcd_reg</span> <span class="n">new_regs</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">half_screen_size</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">pcd</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Configuring SA1100 LCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;var: xres=%d hslen=%d lm=%d rm=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;var: yres=%d vslen=%d um=%d bm=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">);</span>

<span class="cp">#if DEBUG_VAR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">16</span>        <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid xres %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&lt;</span> <span class="mi">1</span>    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid hsync_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">&lt;</span> <span class="mi">1</span>  <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid left_margin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid right_margin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">1</span>         <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid yres %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">&lt;</span> <span class="mi">1</span>    <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid vsync_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid upper_margin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid lower_margin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">new_regs</span><span class="p">.</span><span class="n">lccr0</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">|</span>
		<span class="n">LCCR0_LEN</span> <span class="o">|</span> <span class="n">LCCR0_LDM</span> <span class="o">|</span> <span class="n">LCCR0_BAM</span> <span class="o">|</span>
		<span class="n">LCCR0_ERM</span> <span class="o">|</span> <span class="n">LCCR0_LtlEnd</span> <span class="o">|</span> <span class="n">LCCR0_DMADel</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">new_regs</span><span class="p">.</span><span class="n">lccr1</span> <span class="o">=</span>
		<span class="n">LCCR1_DisWdth</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR1_HorSnchWdth</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR1_BegLnDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR1_EndLnDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have a dual scan LCD, then we need to halve</span>
<span class="cm">	 * the YRES parameter.</span>
<span class="cm">	 */</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_Dual</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">new_regs</span><span class="p">.</span><span class="n">lccr2</span> <span class="o">=</span>
		<span class="n">LCCR2_DisHght</span><span class="p">(</span><span class="n">yres</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR2_VrtSnchWdth</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR2_BegFrmDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">LCCR2_EndFrmDel</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">);</span>

	<span class="n">pcd</span> <span class="o">=</span> <span class="n">get_pcd</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">,</span> <span class="n">cpufreq_get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">new_regs</span><span class="p">.</span><span class="n">lccr3</span> <span class="o">=</span> <span class="n">LCCR3_PixClkDiv</span><span class="p">(</span><span class="n">pcd</span><span class="p">)</span> <span class="o">|</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">?</span> <span class="n">LCCR3_HorSnchH</span> <span class="o">:</span> <span class="n">LCCR3_HorSnchL</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">?</span> <span class="n">LCCR3_VrtSnchH</span> <span class="o">:</span> <span class="n">LCCR3_VrtSnchL</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nlccr0 = 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr0</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nlccr1 = 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr1</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nlccr2 = 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr2</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nlccr3 = 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr3</span><span class="p">);</span>

	<span class="n">half_screen_size</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">half_screen_size</span> <span class="o">=</span> <span class="n">half_screen_size</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* Update shadow copy atomically */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dbar1</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_dma</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dbar2</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_dma</span> <span class="o">+</span> <span class="n">half_screen_size</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">=</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span> <span class="o">=</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span> <span class="o">=</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr2</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">=</span> <span class="n">new_regs</span><span class="p">.</span><span class="n">lccr3</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only update the registers if the controller is enabled</span>
<span class="cm">	 * and something has changed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">||</span>
	    <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span> <span class="o">||</span>
	    <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span> <span class="o">||</span>
	    <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">||</span>
	    <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DBAR1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dbar1</span> <span class="o">||</span>
	    <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DBAR2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dbar2</span><span class="p">)</span>
		<span class="n">sa1100fb_schedule_work</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_REENABLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE!  The following functions are purely helpers for set_ctrlr_state.</span>
<span class="cm"> * Do not call them directly; set_ctrlr_state does the correct serialisation</span>
<span class="cm"> * to ensure that things happen in the right way 100% of time time.</span>
<span class="cm"> *	-- rmk</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__sa1100fb_backlight_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;backlight o%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">on</span> <span class="o">?</span> <span class="s">&quot;n&quot;</span> <span class="o">:</span> <span class="s">&quot;ff&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">backlight_power</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">backlight_power</span><span class="p">(</span><span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__sa1100fb_lcd_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LCD power o%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">on</span> <span class="o">?</span> <span class="s">&quot;n&quot;</span> <span class="o">:</span> <span class="s">&quot;ff&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lcd_power</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lcd_power</span><span class="p">(</span><span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1100fb_setup_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable GPIO&lt;9:2&gt; for LCD use if:</span>
<span class="cm">	 *  1. Active display, or</span>
<span class="cm">	 *  2. Color Dual Passive display</span>
<span class="cm">	 *</span>
<span class="cm">	 * see table 11.8 on page 11-27 in the SA1100 manual</span>
<span class="cm">	 *   -- Erik.</span>
<span class="cm">	 *</span>
<span class="cm">	 * SA1110 spec update nr. 25 says we can and should</span>
<span class="cm">	 * clear LDD15 to 12 for 4 or 8bpp modes with active</span>
<span class="cm">	 * panels.  </span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">&amp;</span> <span class="n">LCCR0_CMS</span><span class="p">)</span> <span class="o">==</span> <span class="n">LCCR0_Color</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCCR0_Dual</span><span class="o">|</span><span class="n">LCCR0_Act</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">GPIO_LDD11</span> <span class="o">|</span> <span class="n">GPIO_LDD10</span> <span class="o">|</span> <span class="n">GPIO_LDD9</span>  <span class="o">|</span> <span class="n">GPIO_LDD8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCCR0_Dual</span><span class="o">|</span><span class="n">LCCR0_Act</span><span class="p">))</span> <span class="o">==</span> <span class="n">LCCR0_Dual</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">GPIO_LDD15</span> <span class="o">|</span> <span class="n">GPIO_LDD14</span> <span class="o">|</span> <span class="n">GPIO_LDD13</span> <span class="o">|</span> <span class="n">GPIO_LDD12</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * SA-1100 requires the GPIO direction register set</span>
<span class="cm">		 * appropriately for the alternate function.  Hence</span>
<span class="cm">		 * we set it here via bitmask rather than excessive</span>
<span class="cm">		 * fiddling via the GPIO subsystem - and even then</span>
<span class="cm">		 * we&#39;ll still have to deal with GAFR.</span>
<span class="cm">		 */</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">GPDR</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">GAFR</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1100fb_enable_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling LCD controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the mode bits are present in the first palette entry</span>
<span class="cm">	 */</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xcfff</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">palette_cpu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">palette_pbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>

	<span class="cm">/* Sequence from 11.7.10 */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR3</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr2</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR2</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR1</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCCR0_LEN</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dbar1</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DBAR1</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dbar2</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DBAR2</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr0</span> <span class="o">|</span> <span class="n">LCCR0_LEN</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_shannon</span><span class="p">())</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">SHANNON_GPIO_DISP_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DBAR1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DBAR1</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DBAR2: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DBAR2</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LCCR0: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LCCR1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR1</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LCCR2: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR2</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LCCR3: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR3</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1100fb_disable_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lccr0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling LCD controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_shannon</span><span class="p">())</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">SHANNON_GPIO_DISP_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* Clear LCD Status Register */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCSR</span><span class="p">);</span>

	<span class="n">lccr0</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">);</span>
	<span class="n">lccr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCCR0_LDM</span><span class="p">;</span>	<span class="cm">/* Enable LCD Disable Done Interrupt */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">lccr0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">);</span>
	<span class="n">lccr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LCCR0_LEN</span><span class="p">;</span>	<span class="cm">/* Disable LCD Controller */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">lccr0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">);</span>

	<span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  sa1100fb_handle_irq: Handle &#39;LCD DONE&#39; interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sa1100fb_handle_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcsr</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcsr</span> <span class="o">&amp;</span> <span class="n">LCSR_LDD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">lccr0</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR0_LDM</span><span class="p">;</span>
		<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">lccr0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCCR0</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">lcsr</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LCSR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function must be called from task context only, since it will</span>
<span class="cm"> * sleep when disabling the LCD controller, or if we get two contending</span>
<span class="cm"> * processes trying to alter state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ctrlr_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">old_state</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>

	<span class="n">old_state</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hack around fbcon initialisation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">C_STARTUP</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">C_REENABLE</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">C_ENABLE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C_DISABLE_CLKCHANGE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Disable controller for clock change.  If the</span>
<span class="cm">		 * controller is already disabled, then do nothing.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE</span> <span class="o">&amp;&amp;</span> <span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE_PM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">sa1100fb_disable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_DISABLE_PM</span>:
	<span class="k">case</span> <span class="n">C_DISABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Disable controller</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

			<span class="n">__sa1100fb_backlight_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE_CLKCHANGE</span><span class="p">)</span>
				<span class="n">sa1100fb_disable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">__sa1100fb_lcd_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_ENABLE_CLKCHANGE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Enable the controller after clock change.  Only</span>
<span class="cm">		 * do this if we were disabled for the clock change.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">C_DISABLE_CLKCHANGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">C_ENABLE</span><span class="p">;</span>
			<span class="n">sa1100fb_enable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_REENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Re-enable the controller only if it was already</span>
<span class="cm">		 * enabled.  This is so we reprogram the control</span>
<span class="cm">		 * registers.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">C_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sa1100fb_disable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">sa1100fb_setup_gpio</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">sa1100fb_enable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">C_ENABLE_PM</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Re-enable the controller after PM.  This is not</span>
<span class="cm">		 * perfect - think about the case where we were doing</span>
<span class="cm">		 * a clock change, and we suspended half-way through.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_DISABLE_PM</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>

	<span class="k">case</span> <span class="n">C_ENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Power up the LCD screen, enable controller, and</span>
<span class="cm">		 * turn on the backlight.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">!=</span> <span class="n">C_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">C_ENABLE</span><span class="p">;</span>
			<span class="n">sa1100fb_setup_gpio</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">__sa1100fb_lcd_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sa1100fb_enable_controller</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
			<span class="n">__sa1100fb_backlight_power</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Our LCD controller task (which is called when we blank or unblank)</span>
<span class="cm"> * via keventd.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1100fb_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sa1100fb_info</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">u_int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="cm">/*</span>
<span class="cm"> * Calculate the minimum DMA period over all displays that we own.</span>
<span class="cm"> * This, together with the SDRAM bandwidth defines the slowest CPU</span>
<span class="cm"> * frequency that can be selected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sa1100fb_min_dma_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	unsigned int min_period = (unsigned int)-1;</span>
<span class="c">	int i;</span>

<span class="c">	for (i = 0; i &lt; MAX_NR_CONSOLES; i++) {</span>
<span class="c">		struct display *disp = &amp;fb_display[i];</span>
<span class="c">		unsigned int period;</span>

<span class="c">		/*</span>
<span class="c">		 * Do we own this display?</span>
<span class="c">		 */</span>
<span class="c">		if (disp-&gt;fb_info != &amp;fbi-&gt;fb)</span>
<span class="c">			continue;</span>

<span class="c">		/*</span>
<span class="c">		 * Ok, calculate its DMA period</span>
<span class="c">		 */</span>
<span class="c">		period = sa1100fb_display_dma_period(&amp;disp-&gt;var);</span>
<span class="c">		if (period &lt; min_period)</span>
<span class="c">			min_period = period;</span>
<span class="c">	}</span>

<span class="c">	return min_period;</span>
<span class="cp">#else</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: we need to verify _all_ consoles.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">sa1100fb_display_dma_period</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPU clock speed change handler.  We need to adjust the LCD timing</span>
<span class="cm"> * parameters when the CPU clock is adjusted by the power management</span>
<span class="cm"> * subsystem.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sa1100fb_freq_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">TO_INF</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">freq_transition</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">pcd</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPUFREQ_PRECHANGE</span>:
		<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_DISABLE_CLKCHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPUFREQ_POSTCHANGE</span>:
		<span class="n">pcd</span> <span class="o">=</span> <span class="n">get_pcd</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">reg_lccr3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCCR3_PixClkDiv</span><span class="p">(</span><span class="n">pcd</span><span class="p">);</span>
		<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_ENABLE_CLKCHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sa1100fb_freq_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">TO_INF</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">freq_policy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPUFREQ_ADJUST</span>:
	<span class="k">case</span> <span class="n">CPUFREQ_INCOMPATIBLE</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;min dma period: %d ps, &quot;</span>
			<span class="s">&quot;new clock %d kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sa1100fb_min_dma_period</span><span class="p">(</span><span class="n">fbi</span><span class="p">),</span>
			<span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
		<span class="cm">/* todo: fill in min/max values */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPUFREQ_NOTIFY</span>:
		<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* todo: panic if min/max values aren&#39;t fulfilled </span>
<span class="cm">		 * [can&#39;t really happen unless there&#39;s a bug in the</span>
<span class="cm">		 * CPU policy verififcation process *</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * Power management hooks.  Note that we won&#39;t be called from IRQ context,</span>
<span class="cm"> * unlike the blank functions above, so we may sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1100fb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_DISABLE_PM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1100fb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">set_ctrlr_state</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">C_ENABLE_PM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define sa1100fb_suspend	NULL</span>
<span class="cp">#define sa1100fb_resume		NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * sa1100fb_map_video_memory():</span>
<span class="cm"> *      Allocates the DRAM memory for the frame buffer.  This buffer is  </span>
<span class="cm"> *	remapped into a non-cached, non-buffered, memory region to  </span>
<span class="cm"> *      allow palette and pixel writes to occur without flushing the </span>
<span class="cm"> *      cache.  Once this area is remapped, all virtual memory</span>
<span class="cm"> *      access to the video memory should occur at the new region.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sa1100fb_map_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We reserve one page for the palette, plus the size</span>
<span class="cm">	 * of the framebuffer.</span>
<span class="cm">	 */</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_cpu</span> <span class="o">=</span> <span class="n">dma_alloc_writecombine</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_size</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_cpu</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_dma</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_dma</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: this is actually the wrong thing to place in</span>
<span class="cm">		 * smem_start.  But fbdev suffers from the problem that</span>
<span class="cm">		 * it needs an API which doesn&#39;t exist (in this case,</span>
<span class="cm">		 * dma_writecombine_mmap)</span>
<span class="cm">		 */</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">map_cpu</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fake monspecs to fill in fbinfo structure */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="n">monspecs</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hfmin</span>	<span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hfmax</span>	<span class="o">=</span> <span class="mi">70000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfmin</span>	<span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfmax</span>	<span class="o">=</span> <span class="mi">65</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">sa1100fb_init_fbinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_mach_info</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fbi</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span>
		      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1100fb_info</span><span class="p">));</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">SA1100_NAME</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span>	<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sa1100fb_ops</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">monspecs</span>	<span class="o">=</span> <span class="n">monspecs</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="p">(</span><span class="n">fbi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">RGB_4</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">rgb_4</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">RGB_8</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">rgb_8</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">RGB_16</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">def_rgb_16</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * People just don&#39;t seem to get this.  We don&#39;t support</span>
<span class="cm">	 * anything but correct entries now, so panic if someone</span>
<span class="cm">	 * does something stupid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">lccr3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCCR3_VrtSnchL</span><span class="o">|</span><span class="n">LCCR3_HorSnchL</span><span class="o">|</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">inf</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;sa1100fb error: invalid LCCR3 fields set or zero &quot;</span>
			<span class="s">&quot;pixclock.&quot;</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">cmap_greyscale</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span>			<span class="o">=</span> <span class="n">C_STARTUP</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task_state</span>			<span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>		<span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">*</span>
					  <span class="n">inf</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">inf</span>			<span class="o">=</span> <span class="n">inf</span><span class="p">;</span>

	<span class="cm">/* Copy the RGB bitfield overrides */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_RGB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">rgb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_wait</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">sa1100fb_task</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">ctrlr_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fbi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sa1100fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1100fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform LCD data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;LCD&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">fbi</span> <span class="o">=</span> <span class="n">sa1100fb_init_fbinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="cm">/* Initialize video memory */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sa1100fb_map_video_memory</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sa1100fb_handle_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;LCD&quot;</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_shannon</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request_one</span><span class="p">(</span><span class="n">SHANNON_GPIO_DISP_EN</span><span class="p">,</span>
			<span class="n">GPIOF_OUT_INIT_LOW</span><span class="p">,</span> <span class="s">&quot;display enable&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This makes sure that our colour bitfield</span>
<span class="cm">	 * descriptors are correctly initialised.</span>
<span class="cm">	 */</span>
	<span class="n">sa1100fb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reg_fb</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">sa1100fb_freq_transition</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_policy</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">sa1100fb_freq_policy</span><span class="p">;</span>
	<span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span> <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
	<span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">freq_policy</span><span class="p">,</span> <span class="n">CPUFREQ_POLICY_NOTIFIER</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* This driver cannot be unloaded at the moment */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_reg_fb:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_shannon</span><span class="p">())</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">SHANNON_GPIO_DISP_EN</span><span class="p">);</span>
 <span class="nl">err_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>
 <span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sa1100fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sa1100fb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">sa1100fb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">sa1100fb_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sa11x0-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">sa1100fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;sa1100fb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa1100fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">sa1100fb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	char *this_opt;</span>

<span class="c">	if (!options || !*options)</span>
<span class="c">		return 0;</span>

<span class="c">	while ((this_opt = strsep(&amp;options, &quot;,&quot;)) != NULL) {</span>

<span class="c">		if (!strncmp(this_opt, &quot;bpp:&quot;, 4))</span>
<span class="c">			current_par.max_bpp =</span>
<span class="c">			    simple_strtoul(this_opt + 4, NULL, 0);</span>

<span class="c">		if (!strncmp(this_opt, &quot;lccr0:&quot;, 6))</span>
<span class="c">			lcd_shadow.lccr0 =</span>
<span class="c">			    simple_strtoul(this_opt + 6, NULL, 0);</span>
<span class="c">		if (!strncmp(this_opt, &quot;lccr1:&quot;, 6)) {</span>
<span class="c">			lcd_shadow.lccr1 =</span>
<span class="c">			    simple_strtoul(this_opt + 6, NULL, 0);</span>
<span class="c">			current_par.max_xres =</span>
<span class="c">			    (lcd_shadow.lccr1 &amp; 0x3ff) + 16;</span>
<span class="c">		}</span>
<span class="c">		if (!strncmp(this_opt, &quot;lccr2:&quot;, 6)) {</span>
<span class="c">			lcd_shadow.lccr2 =</span>
<span class="c">			    simple_strtoul(this_opt + 6, NULL, 0);</span>
<span class="c">			current_par.max_yres =</span>
<span class="c">			    (lcd_shadow.</span>
<span class="c">			     lccr0 &amp; LCCR0_SDS) ? ((lcd_shadow.</span>
<span class="c">						    lccr2 &amp; 0x3ff) +</span>
<span class="c">						   1) *</span>
<span class="c">			    2 : ((lcd_shadow.lccr2 &amp; 0x3ff) + 1);</span>
<span class="c">		}</span>
<span class="c">		if (!strncmp(this_opt, &quot;lccr3:&quot;, 6))</span>
<span class="c">			lcd_shadow.lccr3 =</span>
<span class="c">			    simple_strtoul(this_opt + 6, NULL, 0);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sa1100fb_init</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;StrongARM-1100/1110 framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
