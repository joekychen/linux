<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › ffb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ffb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* ffb.c: Creator/Elite3D frame buffer driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003, 2006 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> * Copyright (C) 1997,1998,1999 Jakub Jelinek (jj@ultra.linux.cz)</span>
<span class="cm"> *</span>
<span class="cm"> * Driver layout based loosely on tgafb.c, see that file for credits.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/upa.h&gt;</span>
<span class="cp">#include &lt;asm/fbio.h&gt;</span>

<span class="cp">#include &quot;sbuslib.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Local functions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ffb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span>
			 <span class="kt">unsigned</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ffb_blank</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ffb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ffb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ffb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ffb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ffb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ffb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ffb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Frame buffer operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">ffb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>		<span class="o">=</span> <span class="n">ffb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>		<span class="o">=</span> <span class="n">ffb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>		<span class="o">=</span> <span class="n">ffb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>		<span class="o">=</span> <span class="n">ffb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>		<span class="o">=</span> <span class="n">ffb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>		<span class="o">=</span> <span class="n">ffb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>		<span class="o">=</span> <span class="n">ffb_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_mmap</span>		<span class="o">=</span> <span class="n">ffb_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>		<span class="o">=</span> <span class="n">ffb_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">fb_compat_ioctl</span>	<span class="o">=</span> <span class="n">sbusfb_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* Register layout and definitions */</span>
<span class="cp">#define	FFB_SFB8R_VOFF		0x00000000</span>
<span class="cp">#define	FFB_SFB8G_VOFF		0x00400000</span>
<span class="cp">#define	FFB_SFB8B_VOFF		0x00800000</span>
<span class="cp">#define	FFB_SFB8X_VOFF		0x00c00000</span>
<span class="cp">#define	FFB_SFB32_VOFF		0x01000000</span>
<span class="cp">#define	FFB_SFB64_VOFF		0x02000000</span>
<span class="cp">#define	FFB_FBC_REGS_VOFF	0x04000000</span>
<span class="cp">#define	FFB_BM_FBC_REGS_VOFF	0x04002000</span>
<span class="cp">#define	FFB_DFB8R_VOFF		0x04004000</span>
<span class="cp">#define	FFB_DFB8G_VOFF		0x04404000</span>
<span class="cp">#define	FFB_DFB8B_VOFF		0x04804000</span>
<span class="cp">#define	FFB_DFB8X_VOFF		0x04c04000</span>
<span class="cp">#define	FFB_DFB24_VOFF		0x05004000</span>
<span class="cp">#define	FFB_DFB32_VOFF		0x06004000</span>
<span class="cp">#define	FFB_DFB422A_VOFF	0x07004000	</span><span class="cm">/* DFB 422 mode write to A */</span><span class="cp"></span>
<span class="cp">#define	FFB_DFB422AD_VOFF	0x07804000	</span><span class="cm">/* DFB 422 mode with line doubling */</span><span class="cp"></span>
<span class="cp">#define	FFB_DFB24B_VOFF		0x08004000	</span><span class="cm">/* DFB 24bit mode write to B */</span><span class="cp"></span>
<span class="cp">#define	FFB_DFB422B_VOFF	0x09004000	</span><span class="cm">/* DFB 422 mode write to B */</span><span class="cp"></span>
<span class="cp">#define	FFB_DFB422BD_VOFF	0x09804000	</span><span class="cm">/* DFB 422 mode with line doubling */</span><span class="cp"></span>
<span class="cp">#define	FFB_SFB16Z_VOFF		0x0a004000	</span><span class="cm">/* 16bit mode Z planes */</span><span class="cp"></span>
<span class="cp">#define	FFB_SFB8Z_VOFF		0x0a404000	</span><span class="cm">/* 8bit mode Z planes */</span><span class="cp"></span>
<span class="cp">#define	FFB_SFB422_VOFF		0x0ac04000	</span><span class="cm">/* SFB 422 mode write to A/B */</span><span class="cp"></span>
<span class="cp">#define	FFB_SFB422D_VOFF	0x0b404000	</span><span class="cm">/* SFB 422 mode with line doubling */</span><span class="cp"></span>
<span class="cp">#define	FFB_FBC_KREGS_VOFF	0x0bc04000</span>
<span class="cp">#define	FFB_DAC_VOFF		0x0bc06000</span>
<span class="cp">#define	FFB_PROM_VOFF		0x0bc08000</span>
<span class="cp">#define	FFB_EXP_VOFF		0x0bc18000</span>

<span class="cp">#define	FFB_SFB8R_POFF		0x04000000UL</span>
<span class="cp">#define	FFB_SFB8G_POFF		0x04400000UL</span>
<span class="cp">#define	FFB_SFB8B_POFF		0x04800000UL</span>
<span class="cp">#define	FFB_SFB8X_POFF		0x04c00000UL</span>
<span class="cp">#define	FFB_SFB32_POFF		0x05000000UL</span>
<span class="cp">#define	FFB_SFB64_POFF		0x06000000UL</span>
<span class="cp">#define	FFB_FBC_REGS_POFF	0x00600000UL</span>
<span class="cp">#define	FFB_BM_FBC_REGS_POFF	0x00600000UL</span>
<span class="cp">#define	FFB_DFB8R_POFF		0x01000000UL</span>
<span class="cp">#define	FFB_DFB8G_POFF		0x01400000UL</span>
<span class="cp">#define	FFB_DFB8B_POFF		0x01800000UL</span>
<span class="cp">#define	FFB_DFB8X_POFF		0x01c00000UL</span>
<span class="cp">#define	FFB_DFB24_POFF		0x02000000UL</span>
<span class="cp">#define	FFB_DFB32_POFF		0x03000000UL</span>
<span class="cp">#define	FFB_FBC_KREGS_POFF	0x00610000UL</span>
<span class="cp">#define	FFB_DAC_POFF		0x00400000UL</span>
<span class="cp">#define	FFB_PROM_POFF		0x00000000UL</span>
<span class="cp">#define	FFB_EXP_POFF		0x00200000UL</span>
<span class="cp">#define FFB_DFB422A_POFF	0x09000000UL</span>
<span class="cp">#define FFB_DFB422AD_POFF	0x09800000UL</span>
<span class="cp">#define FFB_DFB24B_POFF		0x0a000000UL</span>
<span class="cp">#define FFB_DFB422B_POFF	0x0b000000UL</span>
<span class="cp">#define FFB_DFB422BD_POFF	0x0b800000UL</span>
<span class="cp">#define FFB_SFB16Z_POFF		0x0c800000UL</span>
<span class="cp">#define FFB_SFB8Z_POFF		0x0c000000UL</span>
<span class="cp">#define FFB_SFB422_POFF		0x0d000000UL</span>
<span class="cp">#define FFB_SFB422D_POFF	0x0d800000UL</span>

<span class="cm">/* Draw operations */</span>
<span class="cp">#define FFB_DRAWOP_DOT		0x00</span>
<span class="cp">#define FFB_DRAWOP_AADOT	0x01</span>
<span class="cp">#define FFB_DRAWOP_BRLINECAP	0x02</span>
<span class="cp">#define FFB_DRAWOP_BRLINEOPEN	0x03</span>
<span class="cp">#define FFB_DRAWOP_DDLINE	0x04</span>
<span class="cp">#define FFB_DRAWOP_AALINE	0x05</span>
<span class="cp">#define FFB_DRAWOP_TRIANGLE	0x06</span>
<span class="cp">#define FFB_DRAWOP_POLYGON	0x07</span>
<span class="cp">#define FFB_DRAWOP_RECTANGLE	0x08</span>
<span class="cp">#define FFB_DRAWOP_FASTFILL	0x09</span>
<span class="cp">#define FFB_DRAWOP_BCOPY	0x0a</span>
<span class="cp">#define FFB_DRAWOP_VSCROLL	0x0b</span>

<span class="cm">/* Pixel processor control */</span>
<span class="cm">/* Force WID */</span>
<span class="cp">#define FFB_PPC_FW_DISABLE	0x800000</span>
<span class="cp">#define FFB_PPC_FW_ENABLE	0xc00000</span>
<span class="cm">/* Auxiliary clip */</span>
<span class="cp">#define FFB_PPC_ACE_DISABLE	0x040000</span>
<span class="cp">#define FFB_PPC_ACE_AUX_SUB	0x080000</span>
<span class="cp">#define FFB_PPC_ACE_AUX_ADD	0x0c0000</span>
<span class="cm">/* Depth cue */</span>
<span class="cp">#define FFB_PPC_DCE_DISABLE	0x020000</span>
<span class="cp">#define FFB_PPC_DCE_ENABLE	0x030000</span>
<span class="cm">/* Alpha blend */</span>
<span class="cp">#define FFB_PPC_ABE_DISABLE	0x008000</span>
<span class="cp">#define FFB_PPC_ABE_ENABLE	0x00c000</span>
<span class="cm">/* View clip */</span>
<span class="cp">#define FFB_PPC_VCE_DISABLE	0x001000</span>
<span class="cp">#define FFB_PPC_VCE_2D		0x002000</span>
<span class="cp">#define FFB_PPC_VCE_3D		0x003000</span>
<span class="cm">/* Area pattern */</span>
<span class="cp">#define FFB_PPC_APE_DISABLE	0x000800</span>
<span class="cp">#define FFB_PPC_APE_ENABLE	0x000c00</span>
<span class="cm">/* Transparent background */</span>
<span class="cp">#define FFB_PPC_TBE_OPAQUE	0x000200</span>
<span class="cp">#define FFB_PPC_TBE_TRANSPARENT	0x000300</span>
<span class="cm">/* Z source */</span>
<span class="cp">#define FFB_PPC_ZS_VAR		0x000080</span>
<span class="cp">#define FFB_PPC_ZS_CONST	0x0000c0</span>
<span class="cm">/* Y source */</span>
<span class="cp">#define FFB_PPC_YS_VAR		0x000020</span>
<span class="cp">#define FFB_PPC_YS_CONST	0x000030</span>
<span class="cm">/* X source */</span>
<span class="cp">#define FFB_PPC_XS_WID		0x000004</span>
<span class="cp">#define FFB_PPC_XS_VAR		0x000008</span>
<span class="cp">#define FFB_PPC_XS_CONST	0x00000c</span>
<span class="cm">/* Color (BGR) source */</span>
<span class="cp">#define FFB_PPC_CS_VAR		0x000002</span>
<span class="cp">#define FFB_PPC_CS_CONST	0x000003</span>

<span class="cp">#define FFB_ROP_NEW		0x83</span>
<span class="cp">#define FFB_ROP_OLD		0x85</span>
<span class="cp">#define FFB_ROP_NEW_XOR_OLD	0x86</span>

<span class="cp">#define FFB_UCSR_FIFO_MASK	0x00000fff</span>
<span class="cp">#define FFB_UCSR_FB_BUSY	0x01000000</span>
<span class="cp">#define FFB_UCSR_RP_BUSY	0x02000000</span>
<span class="cp">#define FFB_UCSR_ALL_BUSY	(FFB_UCSR_RP_BUSY|FFB_UCSR_FB_BUSY)</span>
<span class="cp">#define FFB_UCSR_READ_ERR	0x40000000</span>
<span class="cp">#define FFB_UCSR_FIFO_OVFL	0x80000000</span>
<span class="cp">#define FFB_UCSR_ALL_ERRORS	(FFB_UCSR_READ_ERR|FFB_UCSR_FIFO_OVFL)</span>

<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="p">{</span>
	<span class="cm">/* Next vertex registers */</span>
	<span class="n">u32</span>	<span class="n">xxx1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">alpha</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">red</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">green</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">blue</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">depth</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">y</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">ryf</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rxf</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">u32</span>	<span class="n">dmyf</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dmxf</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx4</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">ebyi</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ebxi</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx5</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">by</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">bx</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dy</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dx</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">bh</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">bw</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx6</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">u32</span>	<span class="n">xxx7</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* Setup unit vertex state register */</span>
	<span class="n">u32</span>	<span class="n">suvtx</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx8</span><span class="p">[</span><span class="mi">63</span><span class="p">];</span>

	<span class="cm">/* Control registers */</span>
	<span class="n">u32</span>	<span class="n">ppc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">wid</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">bg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">consty</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">constz</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xclip</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcss</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">vclipmin</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">vclipmax</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">vclipzmin</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">vclipzmax</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcsf</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcsb</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dczf</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dczb</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">xxx9</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">blendc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">blendc1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">blendc2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbramitc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rop</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cmp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">matchab</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">matchc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">magnab</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">magnc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbcfg0</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbcfg1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbcfg2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbcfg3</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">ppcfg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pick</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fillmode</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbramwac</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pmask</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xpmask</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ypmask</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">zpmask</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip0min</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip0max</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip1min</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip1max</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip2min</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip2max</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip3min</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">clip3max</span><span class="p">;</span>

	<span class="cm">/* New 3dRAM III support regs */</span>
	<span class="n">u32</span>	<span class="n">rawblend2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawpreblend</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawstencil</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawstencilctl</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">threedram1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">threedram2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">passin</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawclrdepth</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawpmask</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawcsrc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawmatch</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawmagn</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawropblend</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawcmp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">rawwac</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fbramid</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">drawop</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx10</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">fontlpat</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx11</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fontxy</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fontw</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fontinc</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">font</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx12</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">blend2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">preblend</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">stencil</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">stencilctl</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">xxx13</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">dcss1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcss2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcss3</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">widpmask</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcs2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcs3</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcs4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx14</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcd2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcd3</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">dcd4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx15</span><span class="p">;</span>

	<span class="n">u32</span>	<span class="n">pattern</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">u32</span>	<span class="n">xxx16</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">u32</span>	<span class="n">devid</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx17</span><span class="p">[</span><span class="mi">63</span><span class="p">];</span>

	<span class="n">u32</span>	<span class="n">ucsr</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">xxx18</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>

	<span class="n">u32</span>	<span class="n">mer</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ffb_dac</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">type2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">value2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FFB_DAC_UCTRL		0x1001 </span><span class="cm">/* User Control */</span><span class="cp"></span>
<span class="cp">#define FFB_DAC_UCTRL_MANREV	0x00000f00 </span><span class="cm">/* 4-bit Manufacturing Revision */</span><span class="cp"></span>
<span class="cp">#define FFB_DAC_UCTRL_MANREV_SHIFT 8</span>
<span class="cp">#define FFB_DAC_TGEN		0x6000 </span><span class="cm">/* Timing Generator */</span><span class="cp"></span>
<span class="cp">#define FFB_DAC_TGEN_VIDE	0x00000001 </span><span class="cm">/* Video Enable */</span><span class="cp"></span>
<span class="cp">#define FFB_DAC_DID		0x8000 </span><span class="cm">/* Device Identification */</span><span class="cp"></span>
<span class="cp">#define FFB_DAC_DID_PNUM	0x0ffff000 </span><span class="cm">/* Device Part Number */</span><span class="cp"></span>
<span class="cp">#define FFB_DAC_DID_PNUM_SHIFT	12</span>
<span class="cp">#define FFB_DAC_DID_REV		0xf0000000 </span><span class="cm">/* Device Revision */</span><span class="cp"></span>
<span class="cp">#define FFB_DAC_DID_REV_SHIFT	28</span>

<span class="cp">#define FFB_DAC_CUR_CTRL	0x100</span>
<span class="cp">#define FFB_DAC_CUR_CTRL_P0	0x00000001</span>
<span class="cp">#define FFB_DAC_CUR_CTRL_P1	0x00000002</span>

<span class="k">struct</span> <span class="n">ffb_par</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">fbc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_dac</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">dac</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define FFB_FLAG_AFB		0x00000001 </span><span class="cm">/* AFB m3 or m6 */</span><span class="cp"></span>
<span class="cp">#define FFB_FLAG_BLANKED	0x00000002 </span><span class="cm">/* screen is blanked */</span><span class="cp"></span>
<span class="cp">#define FFB_FLAG_INVCURSOR	0x00000004 </span><span class="cm">/* DAC has inverted cursor logic */</span><span class="cp"></span>

	<span class="n">u32</span>			<span class="n">fg_cache</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">8</span><span class="p">)));</span>
	<span class="n">u32</span>			<span class="n">bg_cache</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rop_cache</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">fifo_cache</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">physbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">fbsize</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">board_type</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FFBFifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_cache</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="o">-</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">cache</span> <span class="o">=</span> <span class="p">(</span><span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">ucsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FFB_UCSR_FIFO_MASK</span><span class="p">);</span>
			<span class="n">cache</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cache</span> <span class="o">-</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_cache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FFBWait</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">fbc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">ucsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FFB_UCSR_ALL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">ucsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FFB_UCSR_ALL_ERRORS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_UCSR_ALL_ERRORS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">ucsr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ffb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">FFBWait</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">ffb_rop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">rop_cache</span> <span class="o">!=</span> <span class="n">rop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">rop_cache</span> <span class="o">=</span> <span class="n">rop</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ffb_switch_from_graph</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_dac</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dac</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dac</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">FFBWait</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fifo_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_PPC_VCE_DISABLE</span> <span class="o">|</span> <span class="n">FFB_PPC_TBE_OPAQUE</span> <span class="o">|</span>
		   <span class="n">FFB_PPC_APE_DISABLE</span> <span class="o">|</span> <span class="n">FFB_PPC_CS_CONST</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">ppc</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="mh">0x2000707f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">rop_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">pmask</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fontinc</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fg_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">bg_cache</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">bg</span><span class="p">);</span>
	<span class="n">FFBWait</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Disable cursor.  */</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DAC_CUR_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">type2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FFB_FLAG_INVCURSOR</span><span class="p">)</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">value2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">upa_writel</span><span class="p">((</span><span class="n">FFB_DAC_CUR_CTRL_P0</span> <span class="o">|</span>
			    <span class="n">FFB_DAC_CUR_CTRL_P1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">value2</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ffb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/* We just use this to catch switches out of</span>
<span class="cm">	 * graphics mode.</span>
<span class="cm">	 */</span>
	<span class="n">ffb_switch_from_graph</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ffb_fillrect - Draws a rectangle on the screen.</span>
<span class="cm"> *</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *	@rect: structure defining the rectagle and operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ffb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fg</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">!=</span> <span class="n">ROP_COPY</span> <span class="o">&amp;&amp;</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">!=</span> <span class="n">ROP_XOR</span><span class="p">);</span>

	<span class="n">fg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fg</span> <span class="o">!=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fg_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">fg_cache</span> <span class="o">=</span> <span class="n">fg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ffb_rop</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span> <span class="o">?</span>
		     <span class="n">FFB_ROP_NEW</span> <span class="o">:</span>
		     <span class="n">FFB_ROP_NEW_XOR_OLD</span><span class="p">);</span>

	<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DRAWOP_RECTANGLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">drawop</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">by</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">bx</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ffb_copyarea - Copies on area of the screen to another area.</span>
<span class="cm"> *</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *	@area: structure defining the source and destination.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ffb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">!=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">||</span>
	    <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">==</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ffb_rop</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FFB_ROP_OLD</span><span class="p">);</span>

	<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DRAWOP_VSCROLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">drawop</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">by</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">bx</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">bw</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ffb_imageblit - Copies a image from system memory to the screen.</span>
<span class="cm"> *</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *	@image: structure defining the image.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ffb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">xy</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fgbg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">stride</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">];</span>
	<span class="n">bg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">];</span>
	<span class="n">fgbg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">fg</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">bg</span><span class="p">;</span>
	<span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">stride</span> <span class="o">=</span> <span class="p">((</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fgbg</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fg_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">fgbg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fg_cache</span> <span class="o">=</span> <span class="n">fgbg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fontw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fontxy</span><span class="p">);</span>
		<span class="n">xy</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">));</span>
			<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">upa_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">font</span><span class="p">);</span>

			<span class="n">data</span> <span class="o">+=</span> <span class="n">stride</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">next_data</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fontw</span><span class="p">);</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">fontxy</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">));</span>
			<span class="n">FFBFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">upa_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">font</span><span class="p">);</span>

			<span class="n">data</span> <span class="o">+=</span> <span class="n">stride</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ffb_fixup_var_rgb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ffb_setcolreg - Sets a color register.</span>
<span class="cm"> *</span>
<span class="cm"> *	@regno: boolean, 0 copy local, 1 get_user() function</span>
<span class="cm"> *	@red: frame buffer colormap structure</span>
<span class="cm"> *	@green: The green value which can be up to 16 bits wide</span>
<span class="cm"> *	@blue:  The blue value which can be up to 16 bits wide.</span>
<span class="cm"> *	@transp: If supported the alpha value which can be up to 16 bits wide.</span>
<span class="cm"> *	@info: frame buffer info structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ffb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">red</span><span class="p">;</span>
	<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ffb_blank - Optional function.  Blanks the display.</span>
<span class="cm"> *	@blank_mode: the blank mode we want.</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ffb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_dac</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dac</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dac</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">FFBWait</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DAC_TGEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>: <span class="cm">/* Unblanking */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">FFB_DAC_TGEN_VIDE</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FFB_FLAG_BLANKED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>: <span class="cm">/* Normal blanking */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>: <span class="cm">/* VESA blank (vsync off) */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>: <span class="cm">/* VESA blank (hsync off) */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>: <span class="cm">/* Poweroff */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FFB_DAC_TGEN_VIDE</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FFB_FLAG_BLANKED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DAC_TGEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DAC_TGEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sbus_mmap_map</span> <span class="n">ffb_mmap_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB8R_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB8R_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB8G_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB8G_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB8B_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB8B_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB8X_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB8X_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB32_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB32_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x1000000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB64_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB64_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x2000000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_FBC_REGS_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_FBC_REGS_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0002000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_BM_FBC_REGS_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_BM_FBC_REGS_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0002000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB8R_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB8R_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB8G_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB8G_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB8B_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB8B_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB8X_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB8X_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0400000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB24_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB24_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x1000000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB32_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB32_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x1000000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_FBC_KREGS_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_FBC_KREGS_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0002000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DAC_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DAC_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0002000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_PROM_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_PROM_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0010000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_EXP_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_EXP_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0002000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB422A_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB422A_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB422AD_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB422AD_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB24B_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB24B_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x1000000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB422B_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB422B_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_DFB422BD_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_DFB422BD_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB16Z_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB16Z_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB8Z_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB8Z_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB422_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB422_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">voff</span>	<span class="o">=</span> <span class="n">FFB_SFB422D_VOFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">poff</span>	<span class="o">=</span> <span class="n">FFB_SFB422D_POFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x0800000</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ffb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sbusfb_mmap_helper</span><span class="p">(</span><span class="n">ffb_mmap_map</span><span class="p">,</span>
				  <span class="n">par</span><span class="o">-&gt;</span><span class="n">physbase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbsize</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ffb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sbusfb_ioctl_helper</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
				   <span class="n">FBTYPE_CREATOR</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Initialisation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ffb_init_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ffb_type_name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FFB_FLAG_AFB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">)</span>
			<span class="n">ffb_type_name</span> <span class="o">=</span> <span class="s">&quot;Creator 3D&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ffb_type_name</span> <span class="o">=</span> <span class="s">&quot;Creator&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ffb_type_name</span> <span class="o">=</span> <span class="s">&quot;Elite 3D&quot;</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ffb_type_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>

	<span class="cm">/* Framebuffer length is the same regardless of resolution. */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_SUN_CREATOR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ffb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_fbc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_dac</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dac_pnum</span><span class="p">,</span> <span class="n">dac_rev</span><span class="p">,</span> <span class="n">dac_mrev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_fbc</span><span class="p">),</span> <span class="s">&quot;ffb fbc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_release_fb</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_dac</span><span class="p">),</span> <span class="s">&quot;ffb dac&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dac</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unmap_fbc</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">rop_cache</span> <span class="o">=</span> <span class="n">FFB_ROP_NEW</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">physbase</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t mention copyarea, so SCROLL_REDRAW is always</span>
<span class="cm">	 * used.  It is the fastest on this chip.</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">FBINFO_DEFAULT</span> <span class="o">|</span>
		       <span class="cm">/* FBINFO_HWACCEL_COPYAREA | */</span>
		       <span class="n">FBINFO_HWACCEL_FILLRECT</span> <span class="o">|</span>
		       <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ffb_ops</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">physbase</span> <span class="o">+</span> <span class="n">FFB_DFB24_POFF</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">sbusfb_fill_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">fbsize</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ffb_fixup_var_rgb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;SUNW,afb&quot;</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FFB_FLAG_AFB</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;board_type&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">fbc</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">ucsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FFB_UCSR_ALL_ERRORS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_UCSR_ALL_ERRORS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbc</span><span class="o">-&gt;</span><span class="n">ucsr</span><span class="p">);</span>

	<span class="n">dac</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dac</span><span class="p">;</span>
	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DAC_DID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">dac_pnum</span> <span class="o">=</span> <span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">dac_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">dac_pnum</span> <span class="o">&amp;</span> <span class="n">FFB_DAC_DID_REV</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FFB_DAC_DID_REV_SHIFT</span><span class="p">;</span>
	<span class="n">dac_pnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">dac_pnum</span> <span class="o">&amp;</span> <span class="n">FFB_DAC_DID_PNUM</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FFB_DAC_DID_PNUM_SHIFT</span><span class="p">;</span>

	<span class="n">upa_writel</span><span class="p">(</span><span class="n">FFB_DAC_UCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">dac_mrev</span> <span class="o">=</span> <span class="n">upa_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dac</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">dac_mrev</span> <span class="o">=</span> <span class="p">(</span><span class="n">dac_mrev</span> <span class="o">&amp;</span> <span class="n">FFB_DAC_UCTRL_MANREV</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">FFB_DAC_UCTRL_MANREV_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Elite3D has different DAC revision numbering, and no DAC revisions</span>
<span class="cm">	 * have the reversed meaning of cursor enable.  Otherwise, Pacifica 1</span>
<span class="cm">	 * ramdacs with manufacturing revision less than 3 have inverted</span>
<span class="cm">	 * cursor logic.  We identify Pacifica 1 as not Pacifica 2, the</span>
<span class="cm">	 * latter having a part number value of 0x236e.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FFB_FLAG_AFB</span><span class="p">)</span> <span class="o">||</span> <span class="n">dac_pnum</span> <span class="o">==</span> <span class="mh">0x236e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FFB_FLAG_INVCURSOR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dac_mrev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FFB_FLAG_INVCURSOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ffb_switch_from_graph</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Unblank it just to be sure.  When there are multiple</span>
<span class="cm">	 * FFB/AFB cards in the system, or it is not the OBP</span>
<span class="cm">	 * chosen console, it will have video outputs off in</span>
<span class="cm">	 * the DAC.</span>
<span class="cm">	 */</span>
	<span class="n">ffb_blank</span><span class="p">(</span><span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unmap_dac</span><span class="p">;</span>

	<span class="n">ffb_init_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dealloc_cmap</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s at %016lx, type %d, &quot;</span>
	       <span class="s">&quot;DAC pnum[%x] rev[%d] manuf_rev[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FFB_FLAG_AFB</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;AFB&quot;</span> <span class="o">:</span> <span class="s">&quot;FFB&quot;</span><span class="p">),</span>
	       <span class="n">par</span><span class="o">-&gt;</span><span class="n">physbase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">,</span>
	       <span class="n">dac_pnum</span><span class="p">,</span> <span class="n">dac_rev</span><span class="p">,</span> <span class="n">dac_mrev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_dealloc_cmap:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

<span class="nl">out_unmap_dac:</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_dac</span><span class="p">));</span>

<span class="nl">out_unmap_fbc:</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_fbc</span><span class="p">));</span>

<span class="nl">out_release_fb:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ffb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ffb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">fbc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_fbc</span><span class="p">));</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffb_dac</span><span class="p">));</span>

	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">ffb_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,ffb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,afb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">ffb_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ffb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ffb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">ffb_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ffb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ffb_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ffb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;ffb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ffb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ffb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ffb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ffb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ffb_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;framebuffer driver for Creator/Elite3D chipsets&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David S. Miller &lt;davem@davemloft.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;2.0&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
