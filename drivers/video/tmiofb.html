<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › tmiofb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tmiofb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Frame Buffer Device for Toshiba Mobile IO(TMIO) controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(C) 2005-2006 Chris Humbert</span>
<span class="cm"> * Copyright(C) 2005 Dirk Opfer</span>
<span class="cm"> * Copytight(C) 2007,2008 Dmitry Baryshkov</span>
<span class="cm"> *</span>
<span class="cm"> * Based on:</span>
<span class="cm"> *	drivers/video/w100fb.c</span>
<span class="cm"> *	code written by Sharp/Lineo for 2.4 kernels</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cm">/* Why should fb driver call console functions? because console_lock() */</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/tmio.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * accelerator commands</span>
<span class="cm"> */</span>
<span class="cp">#define TMIOFB_ACC_CSADR(x)	(0x00000000 | ((x) &amp; 0x001ffffe))</span>
<span class="cp">#define TMIOFB_ACC_CHPIX(x)	(0x01000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_CVPIX(x)	(0x02000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_PSADR(x)	(0x03000000 | ((x) &amp; 0x00fffffe))</span>
<span class="cp">#define TMIOFB_ACC_PHPIX(x)	(0x04000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_PVPIX(x)	(0x05000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_PHOFS(x)	(0x06000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_PVOFS(x)	(0x07000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_POADR(x)	(0x08000000 | ((x) &amp; 0x00fffffe))</span>
<span class="cp">#define TMIOFB_ACC_RSTR(x)	(0x09000000 | ((x) &amp; 0x000000ff))</span>
<span class="cp">#define TMIOFB_ACC_TCLOR(x)	(0x0A000000 | ((x) &amp; 0x0000ffff))</span>
<span class="cp">#define TMIOFB_ACC_FILL(x)	(0x0B000000 | ((x) &amp; 0x0000ffff))</span>
<span class="cp">#define TMIOFB_ACC_DSADR(x)	(0x0C000000 | ((x) &amp; 0x00fffffe))</span>
<span class="cp">#define TMIOFB_ACC_SSADR(x)	(0x0D000000 | ((x) &amp; 0x00fffffe))</span>
<span class="cp">#define TMIOFB_ACC_DHPIX(x)	(0x0E000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_DVPIX(x)	(0x0F000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_SHPIX(x)	(0x10000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_SVPIX(x)	(0x11000000 | ((x) &amp; 0x000003ff))</span>
<span class="cp">#define TMIOFB_ACC_LBINI(x)	(0x12000000 | ((x) &amp; 0x0000ffff))</span>
<span class="cp">#define TMIOFB_ACC_LBK2(x)	(0x13000000 | ((x) &amp; 0x0000ffff))</span>
<span class="cp">#define TMIOFB_ACC_SHBINI(x)	(0x14000000 | ((x) &amp; 0x0000ffff))</span>
<span class="cp">#define TMIOFB_ACC_SHBK2(x)	(0x15000000 | ((x) &amp; 0x0000ffff))</span>
<span class="cp">#define TMIOFB_ACC_SVBINI(x)	(0x16000000 | ((x) &amp; 0x0000ffff))</span>
<span class="cp">#define TMIOFB_ACC_SVBK2(x)	(0x17000000 | ((x) &amp; 0x0000ffff))</span>

<span class="cp">#define TMIOFB_ACC_CMGO		0x20000000</span>
<span class="cp">#define TMIOFB_ACC_CMGO_CEND	0x00000001</span>
<span class="cp">#define TMIOFB_ACC_CMGO_INT	0x00000002</span>
<span class="cp">#define TMIOFB_ACC_CMGO_CMOD	0x00000010</span>
<span class="cp">#define TMIOFB_ACC_CMGO_CDVRV	0x00000020</span>
<span class="cp">#define TMIOFB_ACC_CMGO_CDHRV	0x00000040</span>
<span class="cp">#define TMIOFB_ACC_CMGO_RUND	0x00008000</span>
<span class="cp">#define TMIOFB_ACC_SCGO		0x21000000</span>
<span class="cp">#define TMIOFB_ACC_SCGO_CEND	0x00000001</span>
<span class="cp">#define TMIOFB_ACC_SCGO_INT	0x00000002</span>
<span class="cp">#define TMIOFB_ACC_SCGO_ROP3	0x00000004</span>
<span class="cp">#define TMIOFB_ACC_SCGO_TRNS	0x00000008</span>
<span class="cp">#define TMIOFB_ACC_SCGO_DVRV	0x00000010</span>
<span class="cp">#define TMIOFB_ACC_SCGO_DHRV	0x00000020</span>
<span class="cp">#define TMIOFB_ACC_SCGO_SVRV	0x00000040</span>
<span class="cp">#define TMIOFB_ACC_SCGO_SHRV	0x00000080</span>
<span class="cp">#define TMIOFB_ACC_SCGO_DSTXY	0x00008000</span>
<span class="cp">#define TMIOFB_ACC_SBGO		0x22000000</span>
<span class="cp">#define TMIOFB_ACC_SBGO_CEND	0x00000001</span>
<span class="cp">#define TMIOFB_ACC_SBGO_INT	0x00000002</span>
<span class="cp">#define TMIOFB_ACC_SBGO_DVRV	0x00000010</span>
<span class="cp">#define TMIOFB_ACC_SBGO_DHRV	0x00000020</span>
<span class="cp">#define TMIOFB_ACC_SBGO_SVRV	0x00000040</span>
<span class="cp">#define TMIOFB_ACC_SBGO_SHRV	0x00000080</span>
<span class="cp">#define TMIOFB_ACC_SBGO_SBMD	0x00000100</span>
<span class="cp">#define TMIOFB_ACC_FLGO		0x23000000</span>
<span class="cp">#define TMIOFB_ACC_FLGO_CEND	0x00000001</span>
<span class="cp">#define TMIOFB_ACC_FLGO_INT	0x00000002</span>
<span class="cp">#define TMIOFB_ACC_FLGO_ROP3	0x00000004</span>
<span class="cp">#define TMIOFB_ACC_LDGO		0x24000000</span>
<span class="cp">#define TMIOFB_ACC_LDGO_CEND	0x00000001</span>
<span class="cp">#define TMIOFB_ACC_LDGO_INT	0x00000002</span>
<span class="cp">#define TMIOFB_ACC_LDGO_ROP3	0x00000004</span>
<span class="cp">#define TMIOFB_ACC_LDGO_ENDPX	0x00000008</span>
<span class="cp">#define TMIOFB_ACC_LDGO_LVRV	0x00000010</span>
<span class="cp">#define TMIOFB_ACC_LDGO_LHRV	0x00000020</span>
<span class="cp">#define TMIOFB_ACC_LDGO_LDMOD	0x00000040</span>

<span class="cm">/* a FIFO is always allocated, even if acceleration is not used */</span>
<span class="cp">#define TMIOFB_FIFO_SIZE	512</span>

<span class="cm">/*</span>
<span class="cm"> * LCD Host Controller Configuration Register</span>
<span class="cm"> *</span>
<span class="cm"> * This iomem area supports only 16-bit IO.</span>
<span class="cm"> */</span>
<span class="cp">#define CCR_CMD			0x04 </span><span class="cm">/* Command				*/</span><span class="cp"></span>
<span class="cp">#define CCR_REVID		0x08 </span><span class="cm">/* Revision ID			*/</span><span class="cp"></span>
<span class="cp">#define CCR_BASEL		0x10 </span><span class="cm">/* LCD Control Reg Base Addr Low	*/</span><span class="cp"></span>
<span class="cp">#define CCR_BASEH		0x12 </span><span class="cm">/* LCD Control Reg Base Addr High	*/</span><span class="cp"></span>
<span class="cp">#define CCR_UGCC		0x40 </span><span class="cm">/* Unified Gated Clock Control	*/</span><span class="cp"></span>
<span class="cp">#define CCR_GCC			0x42 </span><span class="cm">/* Gated Clock Control		*/</span><span class="cp"></span>
<span class="cp">#define CCR_USC			0x50 </span><span class="cm">/* Unified Software Clear		*/</span><span class="cp"></span>
<span class="cp">#define CCR_VRAMRTC		0x60 </span><span class="cm">/* VRAM Timing Control		*/</span><span class="cp"></span>
				<span class="cm">/* 0x61 VRAM Refresh Control		*/</span>
<span class="cp">#define CCR_VRAMSAC		0x62 </span><span class="cm">/* VRAM Access Control		*/</span><span class="cp"></span>
				<span class="cm">/* 0x63	VRAM Status			*/</span>
<span class="cp">#define CCR_VRAMBC		0x64 </span><span class="cm">/* VRAM Block Control		*/</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * LCD Control Register</span>
<span class="cm"> *</span>
<span class="cm"> * This iomem area supports only 16-bit IO.</span>
<span class="cm"> */</span>
<span class="cp">#define LCR_UIS			0x000 </span><span class="cm">/* Unified Interrupt Status	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VHPN		0x008 </span><span class="cm">/* VRAM Horizontal Pixel Number	*/</span><span class="cp"></span>
<span class="cp">#define LCR_CFSAL		0x00a </span><span class="cm">/* Command FIFO Start Address Low	*/</span><span class="cp"></span>
<span class="cp">#define LCR_CFSAH		0x00c </span><span class="cm">/* Command FIFO Start Address High */</span><span class="cp"></span>
<span class="cp">#define LCR_CFS			0x00e </span><span class="cm">/* Command FIFO Size		*/</span><span class="cp"></span>
<span class="cp">#define LCR_CFWS		0x010 </span><span class="cm">/* Command FIFO Writeable Size	*/</span><span class="cp"></span>
<span class="cp">#define LCR_BBIE		0x012 </span><span class="cm">/* BitBLT Interrupt Enable	*/</span><span class="cp"></span>
<span class="cp">#define LCR_BBISC		0x014 </span><span class="cm">/* BitBLT Interrupt Status and Clear */</span><span class="cp"></span>
<span class="cp">#define LCR_CCS			0x016 </span><span class="cm">/* Command Count Status		*/</span><span class="cp"></span>
<span class="cp">#define LCR_BBES		0x018 </span><span class="cm">/* BitBLT Execution Status	*/</span><span class="cp"></span>
<span class="cp">#define LCR_CMDL		0x01c </span><span class="cm">/* Command Low			*/</span><span class="cp"></span>
<span class="cp">#define LCR_CMDH		0x01e </span><span class="cm">/* Command High			*/</span><span class="cp"></span>
<span class="cp">#define LCR_CFC			0x022 </span><span class="cm">/* Command FIFO Clear		*/</span><span class="cp"></span>
<span class="cp">#define LCR_CCIFC		0x024 </span><span class="cm">/* CMOS Camera IF Control		*/</span><span class="cp"></span>
<span class="cp">#define LCR_HWT			0x026 </span><span class="cm">/* Hardware Test			*/</span><span class="cp"></span>
<span class="cp">#define LCR_LCDCCRC		0x100 </span><span class="cm">/* LCDC Clock and Reset Control	*/</span><span class="cp"></span>
<span class="cp">#define LCR_LCDCC		0x102 </span><span class="cm">/* LCDC Control			*/</span><span class="cp"></span>
<span class="cp">#define LCR_LCDCOPC		0x104 </span><span class="cm">/* LCDC Output Pin Control	*/</span><span class="cp"></span>
<span class="cp">#define LCR_LCDIS		0x108 </span><span class="cm">/* LCD Interrupt Status		*/</span><span class="cp"></span>
<span class="cp">#define LCR_LCDIM		0x10a </span><span class="cm">/* LCD Interrupt Mask		*/</span><span class="cp"></span>
<span class="cp">#define LCR_LCDIE		0x10c </span><span class="cm">/* LCD Interrupt Enable		*/</span><span class="cp"></span>
<span class="cp">#define LCR_GDSAL		0x122 </span><span class="cm">/* Graphics Display Start Address Low */</span><span class="cp"></span>
<span class="cp">#define LCR_GDSAH		0x124 </span><span class="cm">/* Graphics Display Start Address High */</span><span class="cp"></span>
<span class="cp">#define LCR_VHPCL		0x12a </span><span class="cm">/* VRAM Horizontal Pixel Count Low */</span><span class="cp"></span>
<span class="cp">#define LCR_VHPCH		0x12c </span><span class="cm">/* VRAM Horizontal Pixel Count High */</span><span class="cp"></span>
<span class="cp">#define LCR_GM			0x12e </span><span class="cm">/* Graphic Mode(VRAM access enable) */</span><span class="cp"></span>
<span class="cp">#define LCR_HT			0x140 </span><span class="cm">/* Horizontal Total		*/</span><span class="cp"></span>
<span class="cp">#define LCR_HDS			0x142 </span><span class="cm">/* Horizontal Display Start	*/</span><span class="cp"></span>
<span class="cp">#define LCR_HSS			0x144 </span><span class="cm">/* H-Sync Start			*/</span><span class="cp"></span>
<span class="cp">#define LCR_HSE			0x146 </span><span class="cm">/* H-Sync End			*/</span><span class="cp"></span>
<span class="cp">#define LCR_HNP			0x14c </span><span class="cm">/* Horizontal Number of Pixels	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VT			0x150 </span><span class="cm">/* Vertical Total			*/</span><span class="cp"></span>
<span class="cp">#define LCR_VDS			0x152 </span><span class="cm">/* Vertical Display Start		*/</span><span class="cp"></span>
<span class="cp">#define LCR_VSS			0x154 </span><span class="cm">/* V-Sync Start			*/</span><span class="cp"></span>
<span class="cp">#define LCR_VSE			0x156 </span><span class="cm">/* V-Sync End			*/</span><span class="cp"></span>
<span class="cp">#define LCR_CDLN		0x160 </span><span class="cm">/* Current Display Line Number	*/</span><span class="cp"></span>
<span class="cp">#define LCR_ILN			0x162 </span><span class="cm">/* Interrupt Line Number		*/</span><span class="cp"></span>
<span class="cp">#define LCR_SP			0x164 </span><span class="cm">/* Sync Polarity			*/</span><span class="cp"></span>
<span class="cp">#define LCR_MISC		0x166 </span><span class="cm">/* MISC(RGB565 mode)		*/</span><span class="cp"></span>
<span class="cp">#define LCR_VIHSS		0x16a </span><span class="cm">/* Video Interface H-Sync Start	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VIVS		0x16c </span><span class="cm">/* Video Interface Vertical Start	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VIVE		0x16e </span><span class="cm">/* Video Interface Vertical End	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VIVSS		0x170 </span><span class="cm">/* Video Interface V-Sync Start	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VCCIS		0x17e </span><span class="cm">/* Video / CMOS Camera Interface Select */</span><span class="cp"></span>
<span class="cp">#define LCR_VIDWSAL		0x180 </span><span class="cm">/* VI Data Write Start Address Low */</span><span class="cp"></span>
<span class="cp">#define LCR_VIDWSAH		0x182 </span><span class="cm">/* VI Data Write Start Address High */</span><span class="cp"></span>
<span class="cp">#define LCR_VIDRSAL		0x184 </span><span class="cm">/* VI Data Read Start Address Low	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VIDRSAH		0x186 </span><span class="cm">/* VI Data Read Start Address High */</span><span class="cp"></span>
<span class="cp">#define LCR_VIPDDST		0x188 </span><span class="cm">/* VI Picture Data Display Start Timing */</span><span class="cp"></span>
<span class="cp">#define LCR_VIPDDET		0x186 </span><span class="cm">/* VI Picture Data Display End Timing */</span><span class="cp"></span>
<span class="cp">#define LCR_VIE			0x18c </span><span class="cm">/* Video Interface Enable		*/</span><span class="cp"></span>
<span class="cp">#define LCR_VCS			0x18e </span><span class="cm">/* Video/Camera Select		*/</span><span class="cp"></span>
<span class="cp">#define LCR_VPHWC		0x194 </span><span class="cm">/* Video Picture Horizontal Wait Count */</span><span class="cp"></span>
<span class="cp">#define LCR_VPHS		0x196 </span><span class="cm">/* Video Picture Horizontal Size	*/</span><span class="cp"></span>
<span class="cp">#define LCR_VPVWC		0x198 </span><span class="cm">/* Video Picture Vertical Wait Count */</span><span class="cp"></span>
<span class="cp">#define LCR_VPVS		0x19a </span><span class="cm">/* Video Picture Vertical Size	*/</span><span class="cp"></span>
<span class="cp">#define LCR_PLHPIX		0x1a0 </span><span class="cm">/* PLHPIX				*/</span><span class="cp"></span>
<span class="cp">#define LCR_XS			0x1a2 </span><span class="cm">/* XStart				*/</span><span class="cp"></span>
<span class="cp">#define LCR_XCKHW		0x1a4 </span><span class="cm">/* XCK High Width			*/</span><span class="cp"></span>
<span class="cp">#define LCR_STHS		0x1a8 </span><span class="cm">/* STH Start			*/</span><span class="cp"></span>
<span class="cp">#define LCR_VT2			0x1aa </span><span class="cm">/* Vertical Total			*/</span><span class="cp"></span>
<span class="cp">#define LCR_YCKSW		0x1ac </span><span class="cm">/* YCK Start Wait			*/</span><span class="cp"></span>
<span class="cp">#define LCR_YSTS		0x1ae </span><span class="cm">/* YST Start			*/</span><span class="cp"></span>
<span class="cp">#define LCR_PPOLS		0x1b0 </span><span class="cm">/* #PPOL Start			*/</span><span class="cp"></span>
<span class="cp">#define LCR_PRECW		0x1b2 </span><span class="cm">/* PREC Width			*/</span><span class="cp"></span>
<span class="cp">#define LCR_VCLKHW		0x1b4 </span><span class="cm">/* VCLK High Width		*/</span><span class="cp"></span>
<span class="cp">#define LCR_OC			0x1b6 </span><span class="cm">/* Output Control			*/</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="p">{</span>
	<span class="n">u32</span>				<span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
	<span class="n">wait_queue_head_t</span>		<span class="n">wait_acc</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">use_polling</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">ccr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">lcr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * reasons for an interrupt:</span>
<span class="cm"> *	uis	bbisc	lcdis</span>
<span class="cm"> *	0100	0001	accelerator command completed</span>
<span class="cm"> * 	2000	0001	vsync start</span>
<span class="cm"> * 	2000	0002	display start</span>
<span class="cm"> * 	2000	0004	line number match(0x1ff mask???)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tmiofb_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">__info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bbisc</span> <span class="o">=</span> <span class="n">tmio_ioread16</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_BBISC</span><span class="p">);</span>


	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">bbisc</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_BBISC</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
	<span class="cm">/*</span>
<span class="cm">	 * We were in polling mode and now we got correct irq.</span>
<span class="cm">	 * Switch back to IRQ-based sync of command FIFO</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">use_polling</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tmiofb: switching to waitq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">use_polling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bbisc</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">wait_acc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*--------------------------------------------------------------------------*/</span>


<span class="cm">/*</span>
<span class="cm"> * Turns off the LCD controller and LCD host controller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_hw_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_fb_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_UGCC</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_GM</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_set_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0010</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_LCDCCRC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initializes the LCD host controller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="n">mfd_get_cell</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">nlcr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">vram</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlcr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">vram</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">nlcr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x003a</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_UGCC</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x003a</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_GCC</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x3f00</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_USC</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* wait for device to settle */</span>

	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_USC</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_BASEH</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_BASEL</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0002</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_CMD</span><span class="p">);</span> <span class="cm">/* base address enable */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x40a8</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_VRAMRTC</span><span class="p">);</span> <span class="cm">/* VRAMRC, VRAMTC */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0018</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_VRAMSAC</span><span class="p">);</span> <span class="cm">/* VRAMSTS, VRAMAC */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0002</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_VRAMBC</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* wait for device to settle */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x000b</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">+</span> <span class="n">CCR_VRAMBC</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">vram</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span><span class="p">;</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CFSAH</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CFSAL</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">TMIOFB_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CFS</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CFC</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_BBIE</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CFWS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sets the LCD controller&#39;s output resolution and pixel clock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmiofb_hw_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_fb_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_GM</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_set_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0010</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_LCDCCRC</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_set_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VHPN</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_GDSAH</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_GDSAL</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VHPCH</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VHPCL</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_HSS</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">+=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_HSE</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">+=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_HDS</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">+=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_HT</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_HNP</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VSS</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">+=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VSE</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">+=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VDS</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">+=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_ILN</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="n">i</span> <span class="o">+=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VT</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_MISC</span><span class="p">);</span> <span class="cm">/* RGB565 mode */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_GM</span><span class="p">);</span> <span class="cm">/* VRAM enable */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x4007</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_LCDCC</span><span class="p">);</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_SP</span><span class="p">);</span>  <span class="cm">/* sync polarity */</span>

	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0010</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_LCDCCRC</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="cm">/* wait for device to settle */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0014</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_LCDCCRC</span><span class="p">);</span> <span class="cm">/* STOP_CKP */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="cm">/* wait for device to settle */</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0x0015</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_LCDCCRC</span><span class="p">);</span> <span class="cm">/* STOP_CKP|SOFT_RESET*/</span>
	<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="mh">0xfffa</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_VCS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__must_check</span>
<span class="nf">tmiofb_acc_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * This code can be called with interrupts disabled.</span>
<span class="cm">	 * So instead of relaying on irq to trigger the event,</span>
<span class="cm">	 * poll the state till the necessary command is executed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqs_disabled</span><span class="p">()</span> <span class="o">||</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">use_polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmio_ioread16</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CCS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ccs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;tmiofb: timeout waiting for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ccs</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmiofb_irq</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">wait_acc</span><span class="p">,</span>
				<span class="n">tmio_ioread16</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CCS</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ccs</span><span class="p">,</span>
				<span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;tmiofb: timeout waiting for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ccs</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Writes an accelerator command to the accelerator&#39;s FIFO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tmiofb_acc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tmiofb_acc_wait</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TMIOFB_FIFO_SIZE</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">,</span> <span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CMDH</span><span class="p">);</span>
		<span class="n">tmio_iowrite16</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CMDL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the accelerator to finish its operations before writing</span>
<span class="cm"> * to the framebuffer for consistent display output.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tmiofb_acc_wait</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tmio_ioread16</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_BBES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* blit active */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;timeout waiting for blit to end!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tmiofb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">TMIOFB_ACC_DSADR</span><span class="p">((</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_DHPIX</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_DVPIX</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_FILL</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_FLGO</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span> <span class="o">||</span>
	    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmiofb_acc_write</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tmiofb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">TMIOFB_ACC_DSADR</span><span class="p">((</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_DHPIX</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_DVPIX</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_SSADR</span><span class="p">((</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">TMIOFB_ACC_SCGO</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span> <span class="o">||</span>
	    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmiofb_acc_write</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmiofb_clearscreen</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="n">rect</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dx</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dy</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		<span class="p">.</span><span class="n">color</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rop</span>	<span class="o">=</span> <span class="n">ROP_COPY</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rect</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_vblank</span> <span class="o">*</span><span class="n">vblank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vcount</span> <span class="o">=</span> <span class="n">tmio_ioread16</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">+</span> <span class="n">LCR_CDLN</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vds</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>

	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">vcount</span><span class="p">;</span>
	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FB_VBLANK_HAVE_VBLANK</span> <span class="o">|</span> <span class="n">FB_VBLANK_HAVE_VCOUNT</span>
						<span class="o">|</span> <span class="n">FB_VBLANK_HAVE_VSYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcount</span> <span class="o">&lt;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">)</span>
		<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VSYNCING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcount</span> <span class="o">&lt;</span> <span class="n">vds</span> <span class="o">||</span> <span class="n">vcount</span> <span class="o">&gt;</span> <span class="n">vds</span> <span class="o">+</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VBLANKING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIOGET_VBLANK</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_vblank</span> <span class="n">vblank</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

		<span class="n">tmiofb_vblank</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vblank</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vblank</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">vblank</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
	<span class="k">case</span> <span class="n">FBIO_TMIO_ACC_SYNC</span>:
		<span class="n">tmiofb_sync</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FBIO_TMIO_ACC_WRITE</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">acc</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">argp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">tmiofb_acc_write</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="cm">/* Select the smallest mode that allows the desired resolution to be</span>
<span class="cm"> * displayed.  If desired, the x and y parameters can be rounded up to</span>
<span class="cm"> * match the selected mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span>
<span class="nf">tmiofb_find_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_fb_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">best</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">best</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">xres</span>
					   <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)))</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">best</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmio_fb_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">tmiofb_find_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fb_videomode_to_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="cm">/* mm */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="cm">/* mm */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">rotate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">tmiofb_find_mode</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">tmiofb_hw_mode</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="n">tmiofb_clearscreen</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">))</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * everything is done in lcd/bl drivers.</span>
<span class="cm">	 * this is purely to make sysfs happy and work.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">tmiofb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">tmiofb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">tmiofb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">tmiofb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">tmiofb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">tmiofb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">tmiofb_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">tmiofb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">tmiofb_copyarea</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tmiofb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="n">mfd_get_cell</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmio_fb_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ccr</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">vram</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is the only way ATM to disable the fb</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NULL platform data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmiofb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">wait_acc</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">use_polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_COPYAREA</span>
			<span class="o">|</span> <span class="n">FBINFO_HWACCEL_FILLRECT</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmiofb_ops</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;tmio-fb&quot;</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">vram</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">vram</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">lcr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">lcr</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">TMIOFB_FIFO_SIZE</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ccr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">ccr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap_ccr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap_lcr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap_vram</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmiofb_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_request_irq</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_find_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tmiofb_hw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_hw_init</span><span class="p">;</span>

	<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register_framebuffer</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_register_framebuffer:</span>
<span class="cm">/*err_set_par:*/</span>
	<span class="n">tmiofb_hw_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_hw_init:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
		<span class="n">cell</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_enable:</span>
<span class="nl">err_find_mode:</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="nl">err_request_irq:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="nl">err_ioremap_vram:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>
<span class="nl">err_ioremap_lcr:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>
<span class="nl">err_ioremap_ccr:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">tmiofb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="n">mfd_get_cell</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">tmiofb_hw_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
			<span class="n">cell</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>

		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmiofb_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;lhccr:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#define CCR_PR(n)	printk(KERN_DEBUG &quot;\t&quot; #n &quot; = \t%04x\n&quot;,\</span>
<span class="cp">		tmio_ioread16(par-&gt;ccr + CCR_ ## n));</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">CMD</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">REVID</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">BASEL</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">BASEH</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">UGCC</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">GCC</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">USC</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">VRAMRTC</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">VRAMSAC</span><span class="p">);</span>
	<span class="n">CCR_PR</span><span class="p">(</span><span class="n">VRAMBC</span><span class="p">);</span>
<span class="cp">#undef CCR_PR</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;lcr: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#define LCR_PR(n)	printk(KERN_DEBUG &quot;\t&quot; #n &quot; = \t%04x\n&quot;,\</span>
<span class="cp">		tmio_ioread16(par-&gt;lcr + LCR_ ## n));</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">UIS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VHPN</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CFSAL</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CFSAH</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CFS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CFWS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">BBIE</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">BBISC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CCS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">BBES</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CMDL</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CMDH</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CFC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CCIFC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">HWT</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">LCDCCRC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">LCDCC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">LCDCOPC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">LCDIS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">LCDIM</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">LCDIE</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">GDSAL</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">GDSAH</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VHPCL</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VHPCH</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">GM</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">HT</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">HDS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">HSS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">HSE</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">HNP</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VT</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VDS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VSS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VSE</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">CDLN</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">ILN</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">SP</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">MISC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIHSS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIVS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIVE</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIVSS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VCCIS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIDWSAL</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIDWSAH</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIDRSAL</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIDRSAH</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIPDDST</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIPDDET</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VIE</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VCS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VPHWC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VPHS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VPVWC</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VPVS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">PLHPIX</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">XS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">XCKHW</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">STHS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VT2</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">YCKSW</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">YSTS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">PPOLS</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">PRECW</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">VCLKHW</span><span class="p">);</span>
	<span class="n">LCR_PR</span><span class="p">(</span><span class="n">OC</span><span class="p">);</span>
<span class="cp">#undef LCR_PR</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
	<span class="k">struct</span> <span class="n">tmiofb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="n">mfd_get_cell</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_FB_TMIO_ACCELL</span>
	<span class="cm">/*</span>
<span class="cm">	 * The fb should be usable even if interrupts are disabled (and they are</span>
<span class="cm">	 * during suspend/resume). Switch temporary to forced polling.</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tmiofb: switching to polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">use_polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">tmiofb_hw_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmiofb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="n">mfd_get_cell</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmiofb_irq</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">tmiofb_hw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tmiofb_hw_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define tmiofb_suspend	NULL</span>
<span class="cp">#define tmiofb_resume	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">tmiofb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;tmio-fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tmiofb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tmiofb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">tmiofb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">tmiofb_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">tmiofb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tmiofb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;tmiofb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">tmiofb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmiofb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tmiofb_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmiofb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tmiofb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tmiofb_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TMIO framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Chris Humbert, Dirk Opfer, Dmitry Baryshkov&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
