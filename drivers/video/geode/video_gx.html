<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › geode › video_gx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>video_gx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Geode GX video processor device.</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2006 Arcom Control Systems Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *   Portions from AMD&#39;s original 2.4 driver:</span>
<span class="cm"> *     Copyright (C) 2004 Advanced Micro Devices, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *   under the terms of the GNU General Public License as published by the</span>
<span class="cm"> *   Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> *   option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/msr.h&gt;</span>
<span class="cp">#include &lt;linux/cs5535.h&gt;</span>

<span class="cp">#include &quot;gxfb.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * Tables of register settings for various DOTCLKs.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">gx_pll_entry</span> <span class="p">{</span>
	<span class="kt">long</span> <span class="n">pixclock</span><span class="p">;</span> <span class="cm">/* ps */</span>
	<span class="n">u32</span> <span class="n">sys_rstpll_bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dotpll_value</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define POSTDIV3 ((u32)MSR_GLCP_SYS_RSTPLL_DOTPOSTDIV3)</span>
<span class="cp">#define PREMULT2 ((u32)MSR_GLCP_SYS_RSTPLL_DOTPREMULT2)</span>
<span class="cp">#define PREDIV2  ((u32)MSR_GLCP_SYS_RSTPLL_DOTPOSTDIV3)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gx_pll_entry</span> <span class="n">gx_pll_table_48MHz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">40123</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="p">,</span>	    <span class="mh">0x00000BF2</span> <span class="p">},</span>	<span class="cm">/*  24.9230 */</span>
	<span class="p">{</span> <span class="mi">39721</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x00000037</span> <span class="p">},</span>	<span class="cm">/*  25.1750 */</span>
	<span class="p">{</span> <span class="mi">35308</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000B1A</span> <span class="p">},</span>	<span class="cm">/*  28.3220 */</span>
	<span class="p">{</span> <span class="mi">31746</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="p">,</span>	    <span class="mh">0x000002D2</span> <span class="p">},</span>	<span class="cm">/*  31.5000 */</span>
	<span class="p">{</span> <span class="mi">27777</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000FE2</span> <span class="p">},</span>	<span class="cm">/*  36.0000 */</span>
	<span class="p">{</span> <span class="mi">26666</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="p">,</span>	    <span class="mh">0x0000057A</span> <span class="p">},</span>	<span class="cm">/*  37.5000 */</span>
	<span class="p">{</span> <span class="mi">25000</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="p">,</span>	    <span class="mh">0x0000030A</span> <span class="p">},</span>	<span class="cm">/*  40.0000 */</span>
	<span class="p">{</span> <span class="mi">22271</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x00000063</span> <span class="p">},</span>	<span class="cm">/*  44.9000 */</span>
	<span class="p">{</span> <span class="mi">20202</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x0000054B</span> <span class="p">},</span>	<span class="cm">/*  49.5000 */</span>
	<span class="p">{</span> <span class="mi">20000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x0000026E</span> <span class="p">},</span>	<span class="cm">/*  50.0000 */</span>
	<span class="p">{</span> <span class="mi">19860</span><span class="p">,</span> <span class="n">PREMULT2</span><span class="p">,</span>	    <span class="mh">0x00000037</span> <span class="p">},</span>	<span class="cm">/*  50.3500 */</span>
	<span class="p">{</span> <span class="mi">18518</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000B0D</span> <span class="p">},</span>	<span class="cm">/*  54.0000 */</span>
	<span class="p">{</span> <span class="mi">17777</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x00000577</span> <span class="p">},</span>	<span class="cm">/*  56.2500 */</span>
	<span class="p">{</span> <span class="mi">17733</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x000007F7</span> <span class="p">},</span>	<span class="cm">/*  56.3916 */</span>
	<span class="p">{</span> <span class="mi">17653</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x0000057B</span> <span class="p">},</span>	<span class="cm">/*  56.6444 */</span>
	<span class="p">{</span> <span class="mi">16949</span><span class="p">,</span> <span class="n">PREMULT2</span><span class="p">,</span>	    <span class="mh">0x00000707</span> <span class="p">},</span>	<span class="cm">/*  59.0000 */</span>
	<span class="p">{</span> <span class="mi">15873</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000B39</span> <span class="p">},</span>	<span class="cm">/*  63.0000 */</span>
	<span class="p">{</span> <span class="mi">15384</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000B45</span> <span class="p">},</span>	<span class="cm">/*  65.0000 */</span>
	<span class="p">{</span> <span class="mi">14814</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000FC1</span> <span class="p">},</span>	<span class="cm">/*  67.5000 */</span>
	<span class="p">{</span> <span class="mi">14124</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="p">,</span>	    <span class="mh">0x00000561</span> <span class="p">},</span>	<span class="cm">/*  70.8000 */</span>
	<span class="p">{</span> <span class="mi">13888</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="p">,</span>	    <span class="mh">0x000007E1</span> <span class="p">},</span>	<span class="cm">/*  72.0000 */</span>
	<span class="p">{</span> <span class="mi">13426</span><span class="p">,</span> <span class="n">PREMULT2</span><span class="p">,</span>	    <span class="mh">0x00000F4A</span> <span class="p">},</span>	<span class="cm">/*  74.4810 */</span>
	<span class="p">{</span> <span class="mi">13333</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x00000052</span> <span class="p">},</span>	<span class="cm">/*  75.0000 */</span>
	<span class="p">{</span> <span class="mi">12698</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x00000056</span> <span class="p">},</span>	<span class="cm">/*  78.7500 */</span>
	<span class="p">{</span> <span class="mi">12500</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000709</span> <span class="p">},</span>	<span class="cm">/*  80.0000 */</span>
	<span class="p">{</span> <span class="mi">11135</span><span class="p">,</span> <span class="n">PREMULT2</span><span class="p">,</span>	    <span class="mh">0x00000262</span> <span class="p">},</span>	<span class="cm">/*  89.8000 */</span>
	<span class="p">{</span> <span class="mi">10582</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x000002D2</span> <span class="p">},</span>	<span class="cm">/*  94.5000 */</span>
	<span class="p">{</span> <span class="mi">10101</span><span class="p">,</span> <span class="n">PREMULT2</span><span class="p">,</span>	    <span class="mh">0x00000B4A</span> <span class="p">},</span>	<span class="cm">/*  99.0000 */</span>
	<span class="p">{</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">PREMULT2</span><span class="p">,</span>	    <span class="mh">0x00000036</span> <span class="p">},</span>	<span class="cm">/* 100.0000 */</span>
	<span class="p">{</span>  <span class="mi">9259</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x000007E2</span> <span class="p">},</span>	<span class="cm">/* 108.0000 */</span>
	<span class="p">{</span>  <span class="mi">8888</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x000007F6</span> <span class="p">},</span>	<span class="cm">/* 112.5000 */</span>
	<span class="p">{</span>  <span class="mi">7692</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000FB0</span> <span class="p">},</span>	<span class="cm">/* 130.0000 */</span>
	<span class="p">{</span>  <span class="mi">7407</span><span class="p">,</span> <span class="n">POSTDIV3</span><span class="o">|</span><span class="n">PREMULT2</span><span class="p">,</span> <span class="mh">0x00000B50</span> <span class="p">},</span>	<span class="cm">/* 135.0000 */</span>
	<span class="p">{</span>  <span class="mi">6349</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x00000055</span> <span class="p">},</span>	<span class="cm">/* 157.5000 */</span>
	<span class="p">{</span>  <span class="mi">6172</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x000009C1</span> <span class="p">},</span>	<span class="cm">/* 162.0000 */</span>
	<span class="p">{</span>  <span class="mi">5787</span><span class="p">,</span> <span class="n">PREMULT2</span><span class="p">,</span>	    <span class="mh">0x0000002D</span> <span class="p">},</span>	<span class="cm">/* 172.798  */</span>
	<span class="p">{</span>  <span class="mi">5698</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x000002C1</span> <span class="p">},</span>	<span class="cm">/* 175.5000 */</span>
	<span class="p">{</span>  <span class="mi">5291</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x000002D1</span> <span class="p">},</span>	<span class="cm">/* 189.0000 */</span>
	<span class="p">{</span>  <span class="mi">4938</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x00000551</span> <span class="p">},</span>	<span class="cm">/* 202.5000 */</span>
	<span class="p">{</span>  <span class="mi">4357</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		    <span class="mh">0x0000057D</span> <span class="p">},</span>	<span class="cm">/* 229.5000 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gx_pll_entry</span> <span class="n">gx_pll_table_14MHz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">39721</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000037</span> <span class="p">},</span>	<span class="cm">/*  25.1750 */</span>
	<span class="p">{</span> <span class="mi">35308</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000B7B</span> <span class="p">},</span>	<span class="cm">/*  28.3220 */</span>
	<span class="p">{</span> <span class="mi">31746</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000004D3</span> <span class="p">},</span>	<span class="cm">/*  31.5000 */</span>
	<span class="p">{</span> <span class="mi">27777</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000BE3</span> <span class="p">},</span>	<span class="cm">/*  36.0000 */</span>
	<span class="p">{</span> <span class="mi">26666</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000074F</span> <span class="p">},</span>	<span class="cm">/*  37.5000 */</span>
	<span class="p">{</span> <span class="mi">25000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000050B</span> <span class="p">},</span>	<span class="cm">/*  40.0000 */</span>
	<span class="p">{</span> <span class="mi">22271</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000063</span> <span class="p">},</span>	<span class="cm">/*  44.9000 */</span>
	<span class="p">{</span> <span class="mi">20202</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000054B</span> <span class="p">},</span>	<span class="cm">/*  49.5000 */</span>
	<span class="p">{</span> <span class="mi">20000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000026E</span> <span class="p">},</span>	<span class="cm">/*  50.0000 */</span>
	<span class="p">{</span> <span class="mi">19860</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000007C3</span> <span class="p">},</span>	<span class="cm">/*  50.3500 */</span>
	<span class="p">{</span> <span class="mi">18518</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000007E3</span> <span class="p">},</span>	<span class="cm">/*  54.0000 */</span>
	<span class="p">{</span> <span class="mi">17777</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000577</span> <span class="p">},</span>	<span class="cm">/*  56.2500 */</span>
	<span class="p">{</span> <span class="mi">17733</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000002FB</span> <span class="p">},</span>	<span class="cm">/*  56.3916 */</span>
	<span class="p">{</span> <span class="mi">17653</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000057B</span> <span class="p">},</span>	<span class="cm">/*  56.6444 */</span>
	<span class="p">{</span> <span class="mi">16949</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000058B</span> <span class="p">},</span>	<span class="cm">/*  59.0000 */</span>
	<span class="p">{</span> <span class="mi">15873</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000095E</span> <span class="p">},</span>	<span class="cm">/*  63.0000 */</span>
	<span class="p">{</span> <span class="mi">15384</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000096A</span> <span class="p">},</span>	<span class="cm">/*  65.0000 */</span>
	<span class="p">{</span> <span class="mi">14814</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000BC2</span> <span class="p">},</span>	<span class="cm">/*  67.5000 */</span>
	<span class="p">{</span> <span class="mi">14124</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000098A</span> <span class="p">},</span>	<span class="cm">/*  70.8000 */</span>
	<span class="p">{</span> <span class="mi">13888</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000BE2</span> <span class="p">},</span>	<span class="cm">/*  72.0000 */</span>
	<span class="p">{</span> <span class="mi">13333</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000052</span> <span class="p">},</span>	<span class="cm">/*  75.0000 */</span>
	<span class="p">{</span> <span class="mi">12698</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000056</span> <span class="p">},</span>	<span class="cm">/*  78.7500 */</span>
	<span class="p">{</span> <span class="mi">12500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000050A</span> <span class="p">},</span>	<span class="cm">/*  80.0000 */</span>
	<span class="p">{</span> <span class="mi">11135</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000078E</span> <span class="p">},</span>	<span class="cm">/*  89.8000 */</span>
	<span class="p">{</span> <span class="mi">10582</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000002D2</span> <span class="p">},</span>	<span class="cm">/*  94.5000 */</span>
	<span class="p">{</span> <span class="mi">10101</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000011F6</span> <span class="p">},</span>	<span class="cm">/*  99.0000 */</span>
	<span class="p">{</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000054E</span> <span class="p">},</span>	<span class="cm">/* 100.0000 */</span>
	<span class="p">{</span>  <span class="mi">9259</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000007E2</span> <span class="p">},</span>	<span class="cm">/* 108.0000 */</span>
	<span class="p">{</span>  <span class="mi">8888</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000002FA</span> <span class="p">},</span>	<span class="cm">/* 112.5000 */</span>
	<span class="p">{</span>  <span class="mi">7692</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000BB1</span> <span class="p">},</span>	<span class="cm">/* 130.0000 */</span>
	<span class="p">{</span>  <span class="mi">7407</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000975</span> <span class="p">},</span>	<span class="cm">/* 135.0000 */</span>
	<span class="p">{</span>  <span class="mi">6349</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000055</span> <span class="p">},</span>	<span class="cm">/* 157.5000 */</span>
	<span class="p">{</span>  <span class="mi">6172</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000009C1</span> <span class="p">},</span>	<span class="cm">/* 162.0000 */</span>
	<span class="p">{</span>  <span class="mi">5698</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x000002C1</span> <span class="p">},</span>	<span class="cm">/* 175.5000 */</span>
	<span class="p">{</span>  <span class="mi">5291</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000539</span> <span class="p">},</span>	<span class="cm">/* 189.0000 */</span>
	<span class="p">{</span>  <span class="mi">4938</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000551</span> <span class="p">},</span>	<span class="cm">/* 202.5000 */</span>
	<span class="p">{</span>  <span class="mi">4357</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000057D</span> <span class="p">},</span>	<span class="cm">/* 229.5000 */</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">gx_set_dclk_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">gx_pll_entry</span> <span class="o">*</span><span class="n">pll_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pll_table_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">best_i</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">min</span><span class="p">,</span> <span class="n">diff</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dotpll</span><span class="p">,</span> <span class="n">sys_rstpll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* Rev. 1 Geode GXs use a 14 MHz reference clock instead of 48 MHz. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_data</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll_table</span> <span class="o">=</span> <span class="n">gx_pll_table_14MHz</span><span class="p">;</span>
		<span class="n">pll_table_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gx_pll_table_14MHz</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pll_table</span> <span class="o">=</span> <span class="n">gx_pll_table_48MHz</span><span class="p">;</span>
		<span class="n">pll_table_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gx_pll_table_48MHz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Search the table for the closest pixclock. */</span>
	<span class="n">best_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">pll_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pixclock</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pll_table_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">pll_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixclock</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">min</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
			<span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_GLCP_SYS_RSTPLL</span><span class="p">,</span> <span class="n">sys_rstpll</span><span class="p">);</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_GLCP_DOTPLL</span><span class="p">,</span> <span class="n">dotpll</span><span class="p">);</span>

	<span class="cm">/* Program new M, N and P. */</span>
	<span class="n">dotpll</span> <span class="o">&amp;=</span> <span class="mh">0x00000000ffffffffull</span><span class="p">;</span>
	<span class="n">dotpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pll_table</span><span class="p">[</span><span class="n">best_i</span><span class="p">].</span><span class="n">dotpll_value</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">dotpll</span> <span class="o">|=</span> <span class="n">MSR_GLCP_DOTPLL_DOTRESET</span><span class="p">;</span>
	<span class="n">dotpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_GLCP_DOTPLL_BYPASS</span><span class="p">;</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_GLCP_DOTPLL</span><span class="p">,</span> <span class="n">dotpll</span><span class="p">);</span>

	<span class="cm">/* Program dividers. */</span>
	<span class="n">sys_rstpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span> <span class="n">MSR_GLCP_SYS_RSTPLL_DOTPREDIV2</span>
			 <span class="o">|</span> <span class="n">MSR_GLCP_SYS_RSTPLL_DOTPREMULT2</span>
			 <span class="o">|</span> <span class="n">MSR_GLCP_SYS_RSTPLL_DOTPOSTDIV3</span> <span class="p">);</span>
	<span class="n">sys_rstpll</span> <span class="o">|=</span> <span class="n">pll_table</span><span class="p">[</span><span class="n">best_i</span><span class="p">].</span><span class="n">sys_rstpll_bits</span><span class="p">;</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_GLCP_SYS_RSTPLL</span><span class="p">,</span> <span class="n">sys_rstpll</span><span class="p">);</span>

	<span class="cm">/* Clear reset bit to start PLL. */</span>
	<span class="n">dotpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MSR_GLCP_DOTPLL_DOTRESET</span><span class="p">);</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_GLCP_DOTPLL</span><span class="p">,</span> <span class="n">dotpll</span><span class="p">);</span>

	<span class="cm">/* Wait for LOCK bit. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_GLCP_DOTPLL</span><span class="p">,</span> <span class="n">dotpll</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dotpll</span> <span class="o">&amp;</span> <span class="n">MSR_GLCP_DOTPLL_LOCK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gx_configure_tft</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fp</span><span class="p">;</span>

	<span class="cm">/* Set up the DF pad select MSR */</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_GX_MSR_PADSEL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_GX_MSR_PADSEL_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MSR_GX_MSR_PADSEL_TFT</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_GX_MSR_PADSEL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Turn off the panel */</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">read_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PM</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FP_PM_P</span><span class="p">;</span>
	<span class="n">write_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PM</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="cm">/* Set timing 1 */</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">read_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PT1</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">&amp;=</span> <span class="n">FP_PT1_VSIZE_MASK</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">|=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&lt;&lt;</span> <span class="n">FP_PT1_VSIZE_SHIFT</span><span class="p">;</span>
	<span class="n">write_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PT1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="cm">/* Timing 2 */</span>
	<span class="cm">/* Set bits that are always on for TFT */</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="mh">0x0F100000</span><span class="p">;</span>

	<span class="cm">/* Configure sync polarity */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">))</span>
		<span class="n">fp</span> <span class="o">|=</span> <span class="n">FP_PT2_VSP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">))</span>
		<span class="n">fp</span> <span class="o">|=</span> <span class="n">FP_PT2_HSP</span><span class="p">;</span>

	<span class="n">write_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PT2</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="cm">/*  Set the dither control */</span>
	<span class="n">write_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_DFC</span><span class="p">,</span> <span class="n">FP_DFC_NFI</span><span class="p">);</span>

	<span class="cm">/* Enable the FP data and power (in case the BIOS didn&#39;t) */</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">read_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_DCFG</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">|=</span> <span class="n">VP_DCFG_FP_PWR_EN</span> <span class="o">|</span> <span class="n">VP_DCFG_FP_DATA_EN</span><span class="p">;</span>
	<span class="n">write_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_DCFG</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="cm">/* Unblank the panel */</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">read_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PM</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">|=</span> <span class="n">FP_PM_P</span><span class="p">;</span>
	<span class="n">write_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PM</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gx_configure_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dcfg</span><span class="p">,</span> <span class="n">misc</span><span class="p">;</span>

	<span class="cm">/* Write the display configuration */</span>
	<span class="n">dcfg</span> <span class="o">=</span> <span class="n">read_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_DCFG</span><span class="p">);</span>

	<span class="cm">/* Disable hsync and vsync */</span>
	<span class="n">dcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VP_DCFG_VSYNC_EN</span> <span class="o">|</span> <span class="n">VP_DCFG_HSYNC_EN</span><span class="p">);</span>
	<span class="n">write_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_DCFG</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">);</span>

	<span class="cm">/* Clear bits from existing mode. */</span>
	<span class="n">dcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VP_DCFG_CRT_SYNC_SKW</span>
		  <span class="o">|</span> <span class="n">VP_DCFG_CRT_HSYNC_POL</span>   <span class="o">|</span> <span class="n">VP_DCFG_CRT_VSYNC_POL</span>
		  <span class="o">|</span> <span class="n">VP_DCFG_VSYNC_EN</span>        <span class="o">|</span> <span class="n">VP_DCFG_HSYNC_EN</span><span class="p">);</span>

	<span class="cm">/* Set default sync skew.  */</span>
	<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_CRT_SYNC_SKW_DEFAULT</span><span class="p">;</span>

	<span class="cm">/* Enable hsync and vsync. */</span>
	<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_HSYNC_EN</span> <span class="o">|</span> <span class="n">VP_DCFG_VSYNC_EN</span><span class="p">;</span>

	<span class="n">misc</span> <span class="o">=</span> <span class="n">read_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_MISC</span><span class="p">);</span>

	<span class="cm">/* Disable gamma correction */</span>
	<span class="n">misc</span> <span class="o">|=</span> <span class="n">VP_MISC_GAM_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">enable_crt</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Power up the CRT DACs */</span>
		<span class="n">misc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VP_MISC_APWRDN</span> <span class="o">|</span> <span class="n">VP_MISC_DACPWRDN</span><span class="p">);</span>
		<span class="n">write_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_MISC</span><span class="p">,</span> <span class="n">misc</span><span class="p">);</span>

		<span class="cm">/* Only change the sync polarities if we are running</span>
<span class="cm">		 * in CRT mode.  The FP polarities will be handled in</span>
<span class="cm">		 * gxfb_configure_tft */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">))</span>
			<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_CRT_HSYNC_POL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">))</span>
			<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_CRT_VSYNC_POL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Power down the CRT DACs if in FP mode */</span>
		<span class="n">misc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VP_MISC_APWRDN</span> <span class="o">|</span> <span class="n">VP_MISC_DACPWRDN</span><span class="p">);</span>
		<span class="n">write_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_MISC</span><span class="p">,</span> <span class="n">misc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the display logic */</span>
	<span class="cm">/* Set up the DACS to blank normally */</span>

	<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_CRT_EN</span> <span class="o">|</span> <span class="n">VP_DCFG_DAC_BL_EN</span><span class="p">;</span>

	<span class="cm">/* Enable the external DAC VREF? */</span>

	<span class="n">write_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_DCFG</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">);</span>

	<span class="cm">/* Set up the flat panel (if it is enabled) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">enable_crt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gx_configure_tft</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gx_blank_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blank_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dcfg</span><span class="p">,</span> <span class="n">fp_pm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="n">hsync</span><span class="p">,</span> <span class="n">vsync</span><span class="p">,</span> <span class="n">crt</span><span class="p">;</span>

	<span class="cm">/* CRT power saving modes. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">blank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">vsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">crt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">hsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">vsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">crt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">hsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">vsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">crt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="n">blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">hsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">crt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">blank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">hsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">crt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dcfg</span> <span class="o">=</span> <span class="n">read_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_DCFG</span><span class="p">);</span>
	<span class="n">dcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VP_DCFG_DAC_BL_EN</span> <span class="o">|</span> <span class="n">VP_DCFG_HSYNC_EN</span> <span class="o">|</span> <span class="n">VP_DCFG_VSYNC_EN</span> <span class="o">|</span>
			<span class="n">VP_DCFG_CRT_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blank</span><span class="p">)</span>
		<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_DAC_BL_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsync</span><span class="p">)</span>
		<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_HSYNC_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vsync</span><span class="p">)</span>
		<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_VSYNC_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crt</span><span class="p">)</span>
		<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">VP_DCFG_CRT_EN</span><span class="p">;</span>
	<span class="n">write_vp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">VP_DCFG</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">);</span>

	<span class="cm">/* Power on/off flat panel. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">enable_crt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fp_pm</span> <span class="o">=</span> <span class="n">read_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blank_mode</span> <span class="o">==</span> <span class="n">FB_BLANK_POWERDOWN</span><span class="p">)</span>
			<span class="n">fp_pm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FP_PM_P</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fp_pm</span> <span class="o">|=</span> <span class="n">FP_PM_P</span><span class="p">;</span>
		<span class="n">write_fp</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">FP_PM</span><span class="p">,</span> <span class="n">fp_pm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
