<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › sstfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sstfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/sstfb.c -- voodoo graphics frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *     Copyright (c) 2000-2002 Ghozlane Toumi &lt;gtoumi@laposte.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *     Created 15 Jan 2000 by Ghozlane Toumi</span>
<span class="cm"> *</span>
<span class="cm"> * Contributions (and many thanks) :</span>
<span class="cm"> *</span>
<span class="cm"> * 03/2001 James Simmons   &lt;jsimmons@infradead.org&gt;</span>
<span class="cm"> * 04/2001 Paul Mundt      &lt;lethal@chaoticdreams.org&gt;</span>
<span class="cm"> * 05/2001 Urs Ganse       &lt;ursg@uni.de&gt;</span>
<span class="cm"> *	(initial work on voodoo2 port, interlace)</span>
<span class="cm"> * 09/2002 Helge Deller    &lt;deller@gmx.de&gt;</span>
<span class="cm"> *	(enable driver on big-endian machines (hppa), ioctl fixes)</span>
<span class="cm"> * 12/2002 Helge Deller    &lt;deller@gmx.de&gt;</span>
<span class="cm"> *	(port driver to new frambuffer infrastructure)</span>
<span class="cm"> * 01/2003 Helge Deller    &lt;deller@gmx.de&gt;</span>
<span class="cm"> *	(initial work on fb hardware acceleration for voodoo2)</span>
<span class="cm"> * 08/2006 Alan Cox 	   &lt;alan@redhat.com&gt;</span>
<span class="cm"> *	Remove never finished and bogus 24/32bit support</span>
<span class="cm"> *	Clean up macro abuse</span>
<span class="cm"> *	Minor tidying for format.</span>
<span class="cm"> * 12/2006 Helge Deller    &lt;deller@gmx.de&gt;</span>
<span class="cm"> *	add /sys/class/graphics/fbX/vgapass sysfs-interface</span>
<span class="cm"> *	add module option &quot;mode_option&quot; to set initial screen mode</span>
<span class="cm"> *	use fbdev default videomode database</span>
<span class="cm"> *	remove debug functions from ioctl</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The voodoo1 has the following memory mapped address space:</span>
<span class="cm"> * 0x000000 - 0x3fffff : registers              (4MB)</span>
<span class="cm"> * 0x400000 - 0x7fffff : linear frame buffer    (4MB)</span>
<span class="cm"> * 0x800000 - 0xffffff : texture memory         (8MB)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * misc notes, TODOs, toASKs, and deep thoughts</span>

<span class="cm">-TODO: at one time or another test that the mode is acceptable by the monitor</span>
<span class="cm">-ASK: Can I choose different ordering for the color bitfields (rgba argb ...)</span>
<span class="cm">      which one should i use ? is there any preferred one ? It seems ARGB is</span>
<span class="cm">      the one ...</span>
<span class="cm">-TODO: in  set_var check the validity of timings (hsync vsync)...</span>
<span class="cm">-TODO: check and recheck the use of sst_wait_idle : we don&#39;t flush the fifo via</span>
<span class="cm">       a nop command. so it&#39;s ok as long as the commands we pass don&#39;t go</span>
<span class="cm">       through the fifo. warning: issuing a nop command seems to need pci_fifo</span>
<span class="cm">-FIXME: in case of failure in the init sequence, be sure we return to a safe</span>
<span class="cm">        state.</span>
<span class="cm">- FIXME: Use accelerator for 2D scroll</span>
<span class="cm">-FIXME: 4MB boards have banked memory (FbiInit2 bits 1 &amp; 20)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * debug info</span>
<span class="cm"> * SST_DEBUG : enable debugging</span>
<span class="cm"> * SST_DEBUG_REG : debug registers</span>
<span class="cm"> *   0 :  no debug</span>
<span class="cm"> *   1 : dac calls, [un]set_bits, FbiInit</span>
<span class="cm"> *   2 : insane debug level (log every register read/write)</span>
<span class="cm"> * SST_DEBUG_FUNC : functions</span>
<span class="cm"> *   0 : no debug</span>
<span class="cm"> *   1 : function call / debug ioctl</span>
<span class="cm"> *   2 : variables</span>
<span class="cm"> *   3 : flood . you don&#39;t want to do that. trust me.</span>
<span class="cm"> * SST_DEBUG_VAR : debug display/var structs</span>
<span class="cm"> *   0 : no debug</span>
<span class="cm"> *   1 : dumps display, fb_var</span>
<span class="cm"> *</span>
<span class="cm"> * sstfb specific ioctls:</span>
<span class="cm"> *   		toggle vga (0x46db) : toggle vga_pass_through</span>
<span class="cm"> */</span>

<span class="cp">#undef SST_DEBUG</span>


<span class="cm">/*</span>
<span class="cm"> * Includes</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;video/sstfb.h&gt;</span>


<span class="cm">/* initialized by setup */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">vgapass</span><span class="p">;</span>		<span class="cm">/* enable VGA passthrough cable */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mem</span><span class="p">;</span>			<span class="cm">/* mem size in MB, 0 = autodetect */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">clipping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* use clipping (slower, safer) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gfxclk</span><span class="p">;</span>		<span class="cm">/* force FBI freq in Mhz . Dangerous */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">slowpci</span><span class="p">;</span>		<span class="cm">/* slow PCI settings */</span>

<span class="cm">/*</span>
<span class="cm">  Possible default video modes: 800x600@60, 640x480@75, 1024x768@76, 640x480@60</span>
<span class="cm">*/</span>
<span class="cp">#define DEFAULT_VIDEO_MODE &quot;640x480@60&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="n">DEFAULT_VIDEO_MODE</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ID_VOODOO1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ID_VOODOO2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IS_VOODOO2(par) ((par)-&gt;type == ID_VOODOO2)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sst_spec</span> <span class="n">voodoo_spec</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
 <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Voodoo Graphics&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">default_gfx_clock</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span> <span class="p">.</span><span class="n">max_gfxclk</span> <span class="o">=</span> <span class="mi">60</span> <span class="p">},</span>
 <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Voodoo2&quot;</span><span class="p">,</span>	      <span class="p">.</span><span class="n">default_gfx_clock</span> <span class="o">=</span> <span class="mi">75000</span><span class="p">,</span> <span class="p">.</span><span class="n">max_gfxclk</span> <span class="o">=</span> <span class="mi">85</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * debug functions</span>
<span class="cm"> */</span>

<span class="cp">#if (SST_DEBUG_REG &gt; 0)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sst_dbg_print_read_reg</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regname</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIINIT0</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit0&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT1</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit1&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT2</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit2&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT3</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit3&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT4</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit4&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT5</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit5&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT6</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit6&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="n">regname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>       <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">r_ddprintk</span><span class="p">(</span><span class="s">&quot;sst_read(%#x): %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot; sst_read(%s): %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sst_dbg_print_write_reg</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regname</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FBIINIT0</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit0&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT1</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit1&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT2</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit2&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT3</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit3&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT4</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit4&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT5</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit5&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FBIINIT6</span>:	<span class="n">regname</span> <span class="o">=</span> <span class="s">&quot;FbiInit6&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="n">regname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>       <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">r_ddprintk</span><span class="p">(</span><span class="s">&quot;sst_write(%#x, %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot; sst_write(%s, %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/*  (SST_DEBUG_REG &gt; 0) */</span><span class="cp"></span>
<span class="cp">#  define sst_dbg_print_read_reg(reg, val)	do {} while(0)</span>
<span class="cp">#  define sst_dbg_print_write_reg(reg, val)	do {} while(0)</span>
<span class="cp">#endif </span><span class="cm">/*  (SST_DEBUG_REG &gt; 0) */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * hardware access functions</span>
<span class="cm"> */</span>

<span class="cm">/* register access */</span>
<span class="cp">#define sst_read(reg)		__sst_read(par-&gt;mmio_vbase, reg)</span>
<span class="cp">#define sst_write(reg,val)	__sst_write(par-&gt;mmio_vbase, reg, val)</span>
<span class="cp">#define sst_set_bits(reg,val)	__sst_set_bits(par-&gt;mmio_vbase, reg, val)</span>
<span class="cp">#define sst_unset_bits(reg,val)	__sst_unset_bits(par-&gt;mmio_vbase, reg, val)</span>
<span class="cp">#define sst_dac_read(reg)	__sst_dac_read(par-&gt;mmio_vbase, reg)</span>
<span class="cp">#define sst_dac_write(reg,val)	__sst_dac_write(par-&gt;mmio_vbase, reg, val)</span>
<span class="cp">#define dac_i_read(reg)		__dac_i_read(par-&gt;mmio_vbase, reg)</span>
<span class="cp">#define dac_i_write(reg,val)	__dac_i_write(par-&gt;mmio_vbase, reg, val)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">__sst_read</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">sst_dbg_print_read_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__sst_write</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sst_dbg_print_write_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">vbase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__sst_set_bits</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot;sst_set_bits(%#x, %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">__sst_write</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">__sst_read</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__sst_unset_bits</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot;sst_unset_bits(%#x, %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">__sst_write</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">__sst_read</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wait for the fbi chip. ASK: what happens if the fbi is stuck ?</span>
<span class="cm"> *</span>
<span class="cm"> * the FBI is supposed to be ready if we receive 5 time</span>
<span class="cm"> * in a row a &quot;idle&quot; answer to our requests</span>
<span class="cm"> */</span>

<span class="cp">#define sst_wait_idle() __sst_wait_idle(par-&gt;mmio_vbase)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__sst_wait_idle</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if (doFBINOP) __sst_write(vbase, NOPCMD, 0); */</span>

	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__sst_read</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STATUS_FBI_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f_dddprintk</span><span class="p">(</span><span class="s">&quot;status: busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cm">/* FIXME basically, this is a busy wait. maybe not that good. oh well;</span>
<span class="cm"> * this is a small loop after all.</span>
<span class="cm"> * Or maybe we should use mdelay() or udelay() here instead ? */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">f_dddprintk</span><span class="p">(</span><span class="s">&quot;status: idle(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* XXX  do something to avoid hanging the machine if the voodoo is out */</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* dac access */</span>
<span class="cm">/* dac_read should be remaped to FbiInit2 (via the pci reg init_enable) */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">__sst_dac_read</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">__sst_write</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">DAC_DATA</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">DAC_READ_CMD</span> <span class="p">);</span>
	<span class="n">__sst_wait_idle</span><span class="p">(</span><span class="n">vbase</span><span class="p">);</span>
	<span class="cm">/* udelay(10); */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__sst_read</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">DAC_READ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot;sst_dac_read(%#x): %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__sst_dac_write</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot;sst_dac_write(%#x, %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">__sst_write</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">DAC_DATA</span><span class="p">,(((</span><span class="n">u32</span><span class="p">)</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
	<span class="n">__sst_wait_idle</span><span class="p">(</span><span class="n">vbase</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* indexed access to ti/att dacs */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">__dac_i_read</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">__sst_dac_write</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">DACREG_ADDR_I</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__sst_dac_read</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">DACREG_DATA_I</span><span class="p">);</span>
	<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot;sst_dac_read_i(%#x): %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__dac_i_write</span><span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span><span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r_dprintk</span><span class="p">(</span><span class="s">&quot;sst_dac_write_i(%#x, %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">__sst_dac_write</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">DACREG_ADDR_I</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">__sst_dac_write</span><span class="p">(</span><span class="n">vbase</span><span class="p">,</span> <span class="n">DACREG_DATA_I</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* compute the m,n,p  , returns the real freq</span>
<span class="cm"> * (ics datasheet :  N &lt;-&gt; N1 , P &lt;-&gt; N2)</span>
<span class="cm"> *</span>
<span class="cm"> * Fout= Fref * (M+2)/( 2^P * (N+2))</span>
<span class="cm"> *  we try to get close to the asked freq</span>
<span class="cm"> *  with P as high, and M as low as possible</span>
<span class="cm"> * range:</span>
<span class="cm"> * ti/att : 0 &lt;= M &lt;= 255; 0 &lt;= P &lt;= 3; 0&lt;= N &lt;= 63</span>
<span class="cm"> * ics    : 1 &lt;= M &lt;= 127; 0 &lt;= P &lt;= 3; 1&lt;= N &lt;= 31</span>
<span class="cm"> * we&#39;ll use the lowest limitation, should be precise enouth</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sst_calc_pll</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">freq_out</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pll_timing</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">best_err</span><span class="p">,</span> <span class="n">fout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_m</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">best_err</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* f * 2^P = vco should be less than VCOmax ~ 250 MHz for ics*/</span>
	<span class="k">while</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">VCO_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">p</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* calc 2 * m so we can round it later*/</span>
		<span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">freq</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">DAC_FREF</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">;</span>

		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">m2</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">?</span> <span class="n">m2</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="n">m2</span><span class="o">/</span><span class="mi">2</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">fout</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC_FREF</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">abs</span><span class="p">(</span><span class="n">fout</span> <span class="o">-</span> <span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">best_err</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">best_n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">best_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
			<span class="n">best_err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">fout</span> <span class="o">-</span> <span class="n">freq</span><span class="p">);</span>
			<span class="cm">/* we get the lowest m , allowing 0.5% error in freq*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="n">best_err</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best_n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="cm">/* unlikely, but who knows ? */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="n">best_n</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">best_m</span><span class="p">;</span>
	<span class="o">*</span><span class="n">freq_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC_FREF</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">f_ddprintk</span> <span class="p">(</span><span class="s">&quot;m: %d, n: %d, p: %d, F: %dKhz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">t</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">freq_out</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear lfb screen</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sstfb_clear_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear screen */</span>
	<span class="n">fb_memset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *      sstfb_check_var - Optional function.  Validates a var passed in.</span>
<span class="cm"> *      @var: frame buffer variable screen structure</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *	Limit to the abilities of a single chip as SLI is not supported</span>
<span class="cm"> *	by this driver.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sstfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hSyncOff</span>   <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vSyncOff</span>   <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vBackPorch</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">yDim</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vSyncOn</span>    <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tiles_in_X</span><span class="p">,</span> <span class="n">real_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sst_calc_pll</span><span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Pixclock at %ld KHZ out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">vBackPorch</span> <span class="o">+=</span> <span class="p">(</span><span class="n">vBackPorch</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vBackPorch</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">yDim</span> <span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">vSyncOn</span> <span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">vSyncOff</span> <span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span> <span class="p">...</span> <span class="mi">16</span> :
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Unsupported bpp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* validity tests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">yDim</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&lt;=</span> <span class="mi">1</span>  <span class="o">||</span>
	    <span class="n">hSyncOff</span> <span class="o">&lt;=</span> <span class="mi">1</span>  <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">&lt;=</span> <span class="mi">2</span>  <span class="o">||</span> <span class="n">vSyncOn</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">vSyncOff</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vBackPorch</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VOODOO2</span><span class="p">(</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Voodoo 2 limits */</span>
		<span class="n">tiles_in_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">63</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>		

		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span>  <span class="o">&gt;</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">||</span> <span class="n">yDim</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Unsupported resolution %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			         <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&gt;</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">||</span> <span class="n">hSyncOff</span> <span class="o">&gt;</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">||</span> <span class="n">vSyncOn</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">vSyncOff</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">||</span> <span class="n">vBackPorch</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">tiles_in_X</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">||</span> <span class="n">tiles_in_X</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Unsupported timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Voodoo limits */</span>
		<span class="n">tiles_in_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">63</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Interlace/doublescan not supported %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Unsupported resolution %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			         <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">&gt;</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="n">hSyncOff</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="n">vSyncOn</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">vSyncOff</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">||</span> <span class="n">vBackPorch</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">tiles_in_X</span> <span class="o">&gt;=</span> <span class="n">POW2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="n">tiles_in_X</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Unsupported timings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* it seems that the fbi uses tiles of 64x16 pixels to &quot;map&quot; the mem */</span>
	<span class="cm">/* FIXME: i don&#39;t like this... looks wrong */</span>
	<span class="n">real_length</span> <span class="o">=</span> <span class="n">tiles_in_X</span>  <span class="o">*</span> <span class="p">(</span><span class="n">IS_VOODOO2</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">64</span> <span class="p">)</span>
	              <span class="o">*</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">real_length</span> <span class="o">*</span> <span class="n">yDim</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Not enough video memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * correct the color bit fields</span>
<span class="cm">	 */</span>
	<span class="cm">/* var-&gt;{red|green|blue}.msb_right = 0; */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:	<span class="cm">/* RGB 565  LfbMode 0 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>  <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>    <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      sstfb_set_par - Optional function.  Alters the hardware state.</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sstfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lfbmode</span><span class="p">,</span> <span class="n">fbiinit1</span><span class="p">,</span> <span class="n">fbiinit2</span><span class="p">,</span> <span class="n">fbiinit3</span><span class="p">,</span> <span class="n">fbiinit5</span><span class="p">,</span> <span class="n">fbiinit6</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">sst_dev</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ntiles</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hSyncOff</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">yDim</span> 	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOn</span> 	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOff</span>	<span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vBackPorch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">;</span>

	<span class="cm">/* We need par-&gt;pll */</span>
	<span class="n">sst_calc_pll</span><span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vBackPorch</span> <span class="o">+=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vBackPorch</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vBackPorch</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">yDim</span> <span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOn</span> <span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOff</span> <span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VOODOO2</span><span class="p">(</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* voodoo2 has 32 pixel wide tiles , BUT strange things</span>
<span class="cm">		   happen with odd number of tiles */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">tiles_in_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">63</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* voodoo1 has 64 pixels wide tiles. */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">tiles_in_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">63</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;hsync_len hSyncOff vsync_len vSyncOff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;%-7d %-8d %-7d %-8d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	           <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hSyncOff</span><span class="p">,</span>
	           <span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOn</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOff</span><span class="p">);</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;left_margin upper_margin xres yres Freq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;%-10d %-10d %-4d %-4d %-8ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	           <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">,</span>
	           <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">));</span>

	<span class="n">sst_write</span><span class="p">(</span><span class="n">NOPCMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">sst_dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="n">PCI_EN_INIT_WR</span><span class="p">);</span>
	<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">,</span> <span class="n">VIDEO_RESET</span><span class="p">);</span>
	<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">FBI_RESET</span> <span class="o">|</span> <span class="n">FIFO_RESET</span><span class="p">);</span>
	<span class="n">sst_unset_bits</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">,</span> <span class="n">EN_DRAM_REFRESH</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>

	<span class="cm">/*sst_unset_bits (FBIINIT0, FBI_RESET); / reenable FBI ? */</span>

	<span class="n">sst_write</span><span class="p">(</span><span class="n">BACKPORCH</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vBackPorch</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">VIDEODIMENSIONS</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yDim</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">HSYNC</span><span class="p">,</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hSyncOff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">VSYNC</span><span class="p">,</span>       <span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vSyncOn</span><span class="p">);</span>

	<span class="n">fbiinit2</span> <span class="o">=</span> <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">);</span>
	<span class="n">fbiinit3</span> <span class="o">=</span> <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT3</span><span class="p">);</span>

	<span class="cm">/* everything is reset. we enable fbiinit2/3 remap : dac access ok */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">sst_dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span>
	                       <span class="n">PCI_EN_INIT_WR</span> <span class="o">|</span> <span class="n">PCI_REMAP_DAC</span> <span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_sw</span><span class="p">.</span><span class="n">set_vidmod</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="cm">/* set video clock */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_sw</span><span class="p">.</span><span class="n">set_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="n">VID_CLOCK</span><span class="p">);</span>

	<span class="cm">/* disable fbiinit2/3 remap */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">sst_dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span>
	                       <span class="n">PCI_EN_INIT_WR</span><span class="p">);</span>

	<span class="cm">/* restore fbiinit2/3 */</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">,</span><span class="n">fbiinit2</span><span class="p">);</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT3</span><span class="p">,</span><span class="n">fbiinit3</span><span class="p">);</span>

	<span class="n">fbiinit1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VIDEO_MASK</span><span class="p">)</span>
	            <span class="o">|</span> <span class="n">EN_DATA_OE</span>
	            <span class="o">|</span> <span class="n">EN_BLANK_OE</span>
	            <span class="o">|</span> <span class="n">EN_HVSYNC_OE</span>
	            <span class="o">|</span> <span class="n">EN_DCLK_OE</span>
		 <span class="cm">/* | (15 &lt;&lt; TILES_IN_X_SHIFT) */</span>
	            <span class="o">|</span> <span class="n">SEL_INPUT_VCLK_2X</span>
		 <span class="cm">/* | (2 &lt;&lt; VCLK_2X_SEL_DEL_SHIFT)</span>
<span class="cm">	            | (2 &lt;&lt; VCLK_DEL_SHIFT) */</span><span class="p">;</span>
<span class="cm">/* try with vclk_in_delay =0 (bits 29:30) , vclk_out_delay =0 (bits(27:28)</span>
<span class="cm"> in (near) future set them accordingly to revision + resolution (cf glide)</span>
<span class="cm"> first understand what it stands for :)</span>
<span class="cm"> FIXME: there are some artefacts... check for the vclk_in_delay</span>
<span class="cm"> lets try with 6ns delay in both vclk_out &amp; in...</span>
<span class="cm"> doh... they&#39;re still there :\</span>
<span class="cm">*/</span>

	<span class="n">ntiles</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">tiles_in_X</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VOODOO2</span><span class="p">(</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fbiinit1</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ntiles</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TILES_IN_X_MSB_SHIFT</span>
		            <span class="o">|</span> <span class="p">((</span><span class="n">ntiles</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TILES_IN_X_SHIFT</span><span class="p">;</span>
<span class="cm">/* as the only value of importance for us in fbiinit6 is tiles in X (lsb),</span>
<span class="cm">   and as reading fbinit 6 will return crap (see FBIINIT6_DEFAULT) we just</span>
<span class="cm">   write our value. BTW due to the dac unable to read odd number of tiles, this</span>
<span class="cm">   field is always null ... */</span>
		<span class="n">fbiinit6</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntiles</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TILES_IN_X_LSB_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">fbiinit1</span> <span class="o">|=</span> <span class="n">ntiles</span> <span class="o">&lt;&lt;</span> <span class="n">TILES_IN_X_SHIFT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">fbiinit1</span> <span class="o">|=</span>  <span class="n">SEL_SOURCE_VCLK_2X_SEL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">,</span> <span class="n">fbiinit1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VOODOO2</span><span class="p">(</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT6</span><span class="p">,</span> <span class="n">fbiinit6</span><span class="p">);</span>
		<span class="n">fbiinit5</span><span class="o">=</span><span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FBIINIT5_MASK</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
			<span class="n">fbiinit5</span> <span class="o">|=</span> <span class="n">INTERLACE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
			<span class="n">fbiinit5</span> <span class="o">|=</span> <span class="n">VDOUBLESCAN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
			<span class="n">fbiinit5</span> <span class="o">|=</span> <span class="n">HSYNC_HIGH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
			<span class="n">fbiinit5</span> <span class="o">|=</span> <span class="n">VSYNC_HIGH</span><span class="p">;</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT5</span><span class="p">,</span> <span class="n">fbiinit5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="n">sst_unset_bits</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">,</span> <span class="n">VIDEO_RESET</span><span class="p">);</span>
	<span class="n">sst_unset_bits</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">FBI_RESET</span> <span class="o">|</span> <span class="n">FIFO_RESET</span><span class="p">);</span>
	<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">,</span> <span class="n">EN_DRAM_REFRESH</span><span class="p">);</span>
	<span class="cm">/* disables fbiinit writes */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">sst_dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="n">PCI_EN_FIFO_WR</span><span class="p">);</span>

	<span class="cm">/* set lfbmode : set mode + front buffer for reads/writes</span>
<span class="cm">	   + disable pipeline */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">lfbmode</span> <span class="o">=</span> <span class="n">LFB_565</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(__BIG_ENDIAN)</span>
	<span class="cm">/* Enable byte-swizzle functionality in hardware.</span>
<span class="cm">	 * With this enabled, all our read- and write-accesses to</span>
<span class="cm">	 * the voodoo framebuffer can be done in native format, and</span>
<span class="cm">	 * the hardware will automatically convert it to little-endian.</span>
<span class="cm">	 * - tested on HP-PARISC, Helge Deller &lt;deller@gmx.de&gt; */</span>
	<span class="n">lfbmode</span> <span class="o">|=</span> <span class="p">(</span> <span class="n">LFB_WORD_SWIZZLE_WR</span> <span class="o">|</span> <span class="n">LFB_BYTE_SWIZZLE_WR</span> <span class="o">|</span>
		     <span class="n">LFB_WORD_SWIZZLE_RD</span> <span class="o">|</span> <span class="n">LFB_BYTE_SWIZZLE_RD</span> <span class="p">);</span>
<span class="cp">#endif</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">clipping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">LFBMODE</span><span class="p">,</span> <span class="n">lfbmode</span> <span class="o">|</span> <span class="n">EN_PXL_PIPELINE</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set &quot;clipping&quot; dimensions. If clipping is disabled and</span>
<span class="cm">	 * writes to offscreen areas of the framebuffer are performed,</span>
<span class="cm">	 * the &quot;behaviour is undefined&quot; (_very_ undefined) - Urs</span>
<span class="cm">	 */</span>
	<span class="cm">/* btw, it requires enabling pixel pipeline in LFBMODE .</span>
<span class="cm">	   off screen read/writes will just wrap and read/print pixels</span>
<span class="cm">	   on screen. Ugly but not that dangerous */</span>
		<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;setting clipping dimensions 0..%d, 0..%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		            <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yDim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">sst_write</span><span class="p">(</span><span class="n">CLIP_LEFT_RIGHT</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">);</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">CLIP_LOWY_HIGHY</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yDim</span><span class="p">);</span>
		<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBZMODE</span><span class="p">,</span> <span class="n">EN_CLIPPING</span> <span class="o">|</span> <span class="n">EN_RGB_WRITE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no clipping : direct access, no pipeline */</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">LFBMODE</span><span class="p">,</span> <span class="n">lfbmode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      sstfb_setcolreg - Optional function. Sets a color register.</span>
<span class="cm"> *      @regno: hardware colormap register</span>
<span class="cm"> *      @red: frame buffer colormap structure</span>
<span class="cm"> *      @green: The green value which can be up to 16 bits wide</span>
<span class="cm"> *      @blue:  The blue value which can be up to 16 bits wide.</span>
<span class="cm"> *      @transp: If supported the alpha value which can be up to 16 bits wide.</span>
<span class="cm"> *      @info: frame buffer info structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sstfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
                           <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">col</span><span class="p">;</span>

	<span class="n">f_dddprintk</span><span class="p">(</span><span class="s">&quot;sstfb_setcolreg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">f_dddprintk</span><span class="p">(</span><span class="s">&quot;%-2d rgbt: %#x, %#x, %#x, %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	            <span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">transp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">red</span>    <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">green</span>  <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">blue</span>   <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">transp</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">blue</span>  <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sstfb_setvgapass</span><span class="p">(</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">sst_dev</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fbiinit0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vgapass</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vgapass</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">sst_dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">sst_dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span>
			       <span class="n">tmp</span> <span class="o">|</span> <span class="n">PCI_EN_INIT_WR</span> <span class="p">);</span>
	<span class="n">fbiinit0</span> <span class="o">=</span> <span class="n">sst_read</span> <span class="p">(</span><span class="n">FBIINIT0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vgapass</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">fbiinit0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DIS_VGA_PASSTHROUGH</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: Enabling VGA pass-through</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span> <span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">fbiinit0</span> <span class="o">|</span> <span class="n">DIS_VGA_PASSTHROUGH</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: Disabling VGA pass-through</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">sst_dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_vgapass</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">**</span> <span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sstfb_setvgapass</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vgapass</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vgapass</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">device_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">vgapass</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_vgapass</span><span class="p">,</span> <span class="n">store_vgapass</span><span class="p">)</span>
	<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sstfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* set/get VGA pass_through mode */</span>
	<span class="k">case</span> <span class="n">SSTFB_SET_VGAPASS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">sstfb_setvgapass</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSTFB_GET_VGAPASS</span>:
		<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vgapass</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Screen-to-Screen BitBlt 2D command (for the bmove fb op.) - Voodoo2 only</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void sstfb_copyarea(struct fb_info *info, const struct fb_copyarea *area)</span>
<span class="c">{</span>
<span class="c">	struct sstfb_par *par = info-&gt;par;</span>
<span class="c">	u32 stride = info-&gt;fix.line_length;</span>
<span class="c">   </span>
<span class="c">	if (!IS_VOODOO2(par))</span>
<span class="c">		return;</span>

<span class="c">	sst_write(BLTSRCBASEADDR, 0);</span>
<span class="c">	sst_write(BLTDSTBASEADDR, 0);</span>
<span class="c">	sst_write(BLTROP, BLTROP_COPY);</span>
<span class="c">	sst_write(BLTXYSTRIDES, stride | (stride &lt;&lt; 16));</span>
<span class="c">	sst_write(BLTSRCXY, area-&gt;sx | (area-&gt;sy &lt;&lt; 16));</span>
<span class="c">	sst_write(BLTDSTXY, area-&gt;dx | (area-&gt;dy &lt;&lt; 16));</span>
<span class="c">	sst_write(BLTSIZE, area-&gt;width | (area-&gt;height &lt;&lt; 16));</span>
<span class="c">	sst_write(BLTCOMMAND, BLT_SCR2SCR_BITBLT | LAUNCH_BITBLT |</span>
<span class="c">		(BLT_16BPP_FMT &lt;&lt; 3) /* | BIT(14) */ | BIT(15) );</span>
<span class="c">	sst_wait_idle();</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * FillRect 2D command (solidfill or invert (via ROP_XOR)) - Voodoo2 only</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void sstfb_fillrect(struct fb_info *info, const struct fb_fillrect *rect) </span>
<span class="c">{</span>
<span class="c">	struct sstfb_par *par = info-&gt;par;</span>
<span class="c">	u32 stride = info-&gt;fix.line_length;</span>

<span class="c">	if (!IS_VOODOO2(par))</span>
<span class="c">		return;</span>
<span class="c">   	</span>
<span class="c">	sst_write(BLTCLIPX, info-&gt;var.xres);</span>
<span class="c">	sst_write(BLTCLIPY, info-&gt;var.yres);</span>
<span class="c">	</span>
<span class="c">	sst_write(BLTDSTBASEADDR, 0);</span>
<span class="c">	sst_write(BLTCOLOR, rect-&gt;color);</span>
<span class="c">	sst_write(BLTROP, rect-&gt;rop == ROP_COPY ? BLTROP_COPY : BLTROP_XOR);</span>
<span class="c">	sst_write(BLTXYSTRIDES, stride | (stride &lt;&lt; 16));</span>
<span class="c">	sst_write(BLTDSTXY, rect-&gt;dx | (rect-&gt;dy &lt;&lt; 16));</span>
<span class="c">	sst_write(BLTSIZE, rect-&gt;width | (rect-&gt;height &lt;&lt; 16));</span>
<span class="c">	sst_write(BLTCOMMAND, BLT_RECFILL_BITBLT | LAUNCH_BITBLT</span>
<span class="c">		 | (BLT_16BPP_FMT &lt;&lt; 3) /* | BIT(14) */ | BIT(15) | BIT(16) );</span>
<span class="c">	sst_wait_idle();</span>
<span class="c">}</span>
<span class="cp">#endif</span>



<span class="cm">/* </span>
<span class="cm"> * get lfb size </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sst_get_memsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">__u32</span> <span class="o">*</span><span class="n">memsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbbase_virt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">;</span>

	<span class="cm">/* force memsize */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">&gt;=</span> <span class="mi">1</span>  <span class="o">&amp;&amp;</span> <span class="n">mem</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">memsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span> <span class="o">*</span> <span class="mh">0x100000</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;supplied memsize: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">memsize</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="n">fbbase_virt</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="n">fbbase_virt</span><span class="o">+</span><span class="mh">0x100000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="n">fbbase_virt</span><span class="o">+</span><span class="mh">0x200000</span><span class="p">);</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;0MB: %#x, 1MB: %#x, 2MB: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	           <span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span> <span class="o">+</span> <span class="mh">0x100000</span><span class="p">),</span>
	           <span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span> <span class="o">+</span> <span class="mh">0x200000</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0xabcdef01</span><span class="p">,</span> <span class="n">fbbase_virt</span><span class="p">);</span>

	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;0MB: %#x, 1MB: %#x, 2MB: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	           <span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span> <span class="o">+</span> <span class="mh">0x100000</span><span class="p">),</span>
	           <span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span> <span class="o">+</span> <span class="mh">0x200000</span><span class="p">));</span>

	<span class="cm">/* checks for 4mb lfb, then 2, then defaults to 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span> <span class="o">+</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xdeadbeef</span><span class="p">)</span>
		<span class="o">*</span><span class="n">memsize</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">fbbase_virt</span> <span class="o">+</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xdeadbeef</span><span class="p">)</span>
		<span class="o">*</span><span class="n">memsize</span> <span class="o">=</span> <span class="mh">0x200000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">memsize</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;detected memsize: %dMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">memsize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * DAC detection routines </span>
<span class="cm"> */</span>

<span class="cm">/* fbi should be idle, and fifo emty and mem disabled */</span>
<span class="cm">/* supposed to detect AT&amp;T ATT20C409 and Ti TVP3409 ramdacs */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sst_detect_att</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mir</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_WMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 	<span class="cm">/* backdoor */</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* read 4 times RMR */</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="cm">/* the fifth time,  CR0 is read */</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="cm">/* the 6th, manufacturer id register */</span>
		<span class="n">mir</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="cm">/*the 7th, device ID register */</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;mir: %#x, dir: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mir</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mir</span> <span class="o">==</span> <span class="n">DACREG_MIR_ATT</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">DACREG_DIR_ATT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sst_detect_ti</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mir</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_WMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 	<span class="cm">/* backdoor */</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* read 4 times RMR */</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="cm">/* the fifth time,  CR0 is read */</span>
		<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="cm">/* the 6th, manufacturer id register */</span>
		<span class="n">mir</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="cm">/*the 7th, device ID register */</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
		<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;mir: %#x, dir: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mir</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mir</span> <span class="o">==</span> <span class="n">DACREG_MIR_TI</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DACREG_DIR_TI</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * try to detect ICS5342  ramdac</span>
<span class="cm"> * we get the 1st byte (M value) of preset f1,f7 and fB</span>
<span class="cm"> * why those 3 ? mmmh... for now, i&#39;ll do it the glide way...</span>
<span class="cm"> * and ask questions later. anyway, it seems that all the freq registers are</span>
<span class="cm"> * really at their default state (cf specs) so i ask again, why those 3 regs ?</span>
<span class="cm"> * mmmmh.. it seems that&#39;s much more ugly than i thought. we use f0 and fA for</span>
<span class="cm"> * pll programming, so in fact, we *hope* that the f1, f7 &amp; fB won&#39;t be</span>
<span class="cm"> * touched...</span>
<span class="cm"> * is it really safe ? how can i reset this ramdac ? geee...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sst_detect_ics</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m_clk0_1</span><span class="p">,</span> <span class="n">m_clk0_7</span><span class="p">,</span> <span class="n">m_clk1_b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_clk0_1</span><span class="p">,</span> <span class="n">n_clk0_7</span><span class="p">,</span> <span class="n">n_clk1_b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLRMA</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>	<span class="cm">/* f1 */</span>
		<span class="n">m_clk0_1</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">);</span>
		<span class="n">n_clk0_1</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">);</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLRMA</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>	<span class="cm">/* f7 */</span>
		<span class="n">m_clk0_7</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">);</span>
		<span class="n">n_clk0_7</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">);</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLRMA</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">);</span>	<span class="cm">/* fB */</span>
		<span class="n">m_clk1_b</span><span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">);</span>
		<span class="n">n_clk1_b</span><span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">);</span>
		<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;m_clk0_1: %#x, m_clk0_7: %#x, m_clk1_b: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">m_clk0_1</span><span class="p">,</span> <span class="n">m_clk0_7</span><span class="p">,</span> <span class="n">m_clk1_b</span><span class="p">);</span>
		<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;n_clk0_1: %#x, n_clk0_7: %#x, n_clk1_b: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">n_clk0_1</span><span class="p">,</span> <span class="n">n_clk0_7</span><span class="p">,</span> <span class="n">n_clk1_b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span>   <span class="n">m_clk0_1</span> <span class="o">==</span> <span class="n">DACREG_ICS_PLL_CLK0_1_INI</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m_clk0_7</span> <span class="o">==</span> <span class="n">DACREG_ICS_PLL_CLK0_7_INI</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m_clk1_b</span> <span class="o">==</span> <span class="n">DACREG_ICS_PLL_CLK1_B_INI</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * gfx, video, pci fifo should be reset, dram refresh disabled</span>
<span class="cm"> * see detect_dac</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sst_set_pll_att_ti</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> 
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pll_timing</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr0</span><span class="p">,</span> <span class="n">cc</span><span class="p">;</span>

	<span class="cm">/* enable indexed mode */</span>
	<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_WMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 	<span class="cm">/* backdoor */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* 1 time:  RMR */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* 2 RMR */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* 3 //  */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* 4 //  */</span>
	<span class="n">cr0</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* 5 CR0 */</span>

	<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_WMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">,</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span>
	              <span class="o">|</span> <span class="n">DACREG_CR0_EN_INDEXED</span>
	              <span class="o">|</span> <span class="n">DACREG_CR0_8BIT</span>
	              <span class="o">|</span> <span class="n">DACREG_CR0_PWDOWN</span> <span class="p">);</span>
	<span class="cm">/* so, now we are in indexed mode . dunno if its common, but</span>
<span class="cm">	   i find this way of doing things a little bit weird :p */</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
	<span class="n">cc</span> <span class="o">=</span> <span class="n">dac_i_read</span><span class="p">(</span><span class="n">DACREG_CC_I</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VID_CLOCK</span>:
		<span class="n">dac_i_write</span><span class="p">(</span><span class="n">DACREG_AC0_I</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">dac_i_write</span><span class="p">(</span><span class="n">DACREG_AC1_I</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
		<span class="n">dac_i_write</span><span class="p">(</span><span class="n">DACREG_CC_I</span><span class="p">,</span>
		            <span class="p">(</span><span class="n">cc</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="n">DACREG_CC_CLKA</span> <span class="o">|</span> <span class="n">DACREG_CC_CLKA_C</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GFX_CLOCK</span>:
		<span class="n">dac_i_write</span><span class="p">(</span><span class="n">DACREG_BD0_I</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">dac_i_write</span><span class="p">(</span><span class="n">DACREG_BD1_I</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
		<span class="n">dac_i_write</span><span class="p">(</span><span class="n">DACREG_CC_I</span><span class="p">,</span>
		            <span class="p">(</span><span class="n">cc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">DACREG_CC_CLKB</span> <span class="o">|</span> <span class="n">DACREG_CC_CLKB_D</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: wrong clock code &#39;%d&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">__func__</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>

	<span class="cm">/* power up the dac &amp; return to &quot;normal&quot; non-indexed mode */</span>
	<span class="n">dac_i_write</span><span class="p">(</span><span class="n">DACREG_CR0_I</span><span class="p">,</span>
	            <span class="n">cr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DACREG_CR0_PWDOWN</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DACREG_CR0_EN_INDEXED</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sst_set_pll_ics</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pll_timing</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pll_ctrl</span><span class="p">;</span>

	<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLRMA</span><span class="p">,</span> <span class="n">DACREG_ICS_PLL_CTRL</span><span class="p">);</span>
	<span class="n">pll_ctrl</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VID_CLOCK</span>:
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLWMA</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>	<span class="cm">/* CLK0, f0 */</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
		<span class="cm">/* selects freq f0 for clock 0 */</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLWMA</span><span class="p">,</span> <span class="n">DACREG_ICS_PLL_CTRL</span><span class="p">);</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">,</span>
		              <span class="p">(</span><span class="n">pll_ctrl</span> <span class="o">&amp;</span> <span class="mh">0xd8</span><span class="p">)</span>
		              <span class="o">|</span> <span class="n">DACREG_ICS_CLK0</span>
		              <span class="o">|</span> <span class="n">DACREG_ICS_CLK0_0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GFX_CLOCK</span> :
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLWMA</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">);</span>	<span class="cm">/* CLK1, fA */</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
		<span class="cm">/* selects freq fA for clock 1 */</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLWMA</span><span class="p">,</span> <span class="n">DACREG_ICS_PLL_CTRL</span><span class="p">);</span>
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_PLLDATA</span><span class="p">,</span>
		              <span class="p">(</span><span class="n">pll_ctrl</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">)</span> <span class="o">|</span> <span class="n">DACREG_ICS_CLK1_A</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: wrong clock code &#39;%d&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">__func__</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sst_set_vidmod_att_ti</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cr0</span><span class="p">;</span>

	<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_WMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 	<span class="cm">/* backdoor */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* read 4 times RMR */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="cm">/* the fifth time,  CR0 is read */</span>
	<span class="n">cr0</span> <span class="o">=</span> <span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>

	<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_WMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 	<span class="cm">/* backdoor */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>	<span class="cm">/* read 4 times RMR */</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="n">sst_dac_read</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">);</span>
	<span class="cm">/* cr0 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_RMR</span><span class="p">,</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="n">DACREG_CR0_16BPP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: bad depth &#39;%u&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sst_set_vidmod_ics</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">sst_dac_write</span><span class="p">(</span><span class="n">DACREG_ICS_CMD</span><span class="p">,</span> <span class="n">DACREG_ICS_CMD_16BPP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: bad depth &#39;%u&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * detect dac type</span>
<span class="cm"> * prerequisite : write to FbiInitx enabled, video and fbi and pci fifo reset,</span>
<span class="cm"> * dram refresh disabled, FbiInit remaped.</span>
<span class="cm"> * TODO: mmh.. maybe i should put the &quot;prerequisite&quot; in the func ...</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dac_switch</span> <span class="n">dacs</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TI TVP3409&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">sst_detect_ti</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">sst_set_pll_att_ti</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_vidmod</span>	<span class="o">=</span> <span class="n">sst_set_vidmod_att_ti</span> <span class="p">},</span>

	<span class="p">{</span>	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;AT&amp;T ATT20C409&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">sst_detect_att</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">sst_set_pll_att_ti</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_vidmod</span>	<span class="o">=</span> <span class="n">sst_set_vidmod_att_ti</span> <span class="p">},</span>
	<span class="p">{</span>	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ICS ICS5342&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">sst_detect_ics</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_pll</span>	<span class="o">=</span> <span class="n">sst_set_pll_ics</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_vidmod</span>	<span class="o">=</span> <span class="n">sst_set_vidmod_ics</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sst_detect_dactype</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dacs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">detect</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f_dprintk</span><span class="p">(</span><span class="s">&quot;%s found %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_sw</span> <span class="o">=</span> <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Internal Routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sst_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fbiinit0</span><span class="p">,</span> <span class="n">fbiinit1</span><span class="p">,</span> <span class="n">fbiinit4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pll_timing</span> <span class="n">gfx_timings</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sst_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Fout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gfx_clock</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">voodoo_spec</span><span class="p">[</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">];</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot; fbiinit0   fbiinit1   fbiinit2   fbiinit3   fbiinit4  &quot;</span>
	           <span class="s">&quot; fbiinit6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;%0#10x %0#10x %0#10x %0#10x %0#10x %0#10x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	            <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">),</span> <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">),</span> <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">),</span>
	            <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT3</span><span class="p">),</span> <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT4</span><span class="p">),</span> <span class="n">sst_read</span><span class="p">(</span><span class="n">FBIINIT6</span><span class="p">));</span>
	<span class="cm">/* disable video clock */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_VCLK_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* enable writing to init registers, disable pci fifo */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="n">PCI_EN_INIT_WR</span><span class="p">);</span>
	<span class="cm">/* reset video */</span>
	<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">,</span> <span class="n">VIDEO_RESET</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="cm">/* reset gfx + pci fifo */</span>
	<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">FBI_RESET</span> <span class="o">|</span> <span class="n">FIFO_RESET</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>

	<span class="cm">/* unreset fifo */</span>
	<span class="cm">/*sst_unset_bits(FBIINIT0, FIFO_RESET);</span>
<span class="cm">	sst_wait_idle();*/</span>
	<span class="cm">/* unreset FBI */</span>
	<span class="cm">/*sst_unset_bits(FBIINIT0, FBI_RESET);</span>
<span class="cm">	sst_wait_idle();*/</span>

	<span class="cm">/* disable dram refresh */</span>
	<span class="n">sst_unset_bits</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">,</span> <span class="n">EN_DRAM_REFRESH</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="cm">/* remap fbinit2/3 to dac */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span>
				<span class="n">PCI_EN_INIT_WR</span> <span class="o">|</span> <span class="n">PCI_REMAP_DAC</span> <span class="p">);</span>
	<span class="cm">/* detect dac type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sst_detect_dactype</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: unknown dac type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME watch it: we are not in a safe state, bad bad bad.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set graphic clock */</span>
	<span class="n">gfx_clock</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">default_gfx_clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gfxclk</span> <span class="o">&gt;</span><span class="mi">10</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gfxclk</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">max_gfxclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sstfb: Using supplied graphic freq : %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gfxclk</span><span class="p">);</span>
		 <span class="n">gfx_clock</span> <span class="o">=</span> <span class="n">gfxclk</span> <span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gfxclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sstfb: %dMhz is way out of spec! Using default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gfxclk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sst_calc_pll</span><span class="p">(</span><span class="n">gfx_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Fout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfx_timings</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_sw</span><span class="p">.</span><span class="n">set_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfx_timings</span><span class="p">,</span> <span class="n">GFX_CLOCK</span><span class="p">);</span>

	<span class="cm">/* disable fbiinit remap */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span>
	                       <span class="n">PCI_EN_INIT_WR</span><span class="o">|</span> <span class="n">PCI_EN_FIFO_WR</span> <span class="p">);</span>
	<span class="cm">/* defaults init registers */</span>
	<span class="cm">/* FbiInit0: unreset gfx, unreset fifo */</span>
	<span class="n">fbiinit0</span> <span class="o">=</span> <span class="n">FBIINIT0_DEFAULT</span><span class="p">;</span>
	<span class="n">fbiinit1</span> <span class="o">=</span> <span class="n">FBIINIT1_DEFAULT</span><span class="p">;</span>
	<span class="n">fbiinit4</span> <span class="o">=</span> <span class="n">FBIINIT4_DEFAULT</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vgapass</span> <span class="o">=</span> <span class="n">vgapass</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vgapass</span><span class="p">)</span>
		<span class="n">fbiinit0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIS_VGA_PASSTHROUGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fbiinit0</span> <span class="o">|=</span> <span class="n">DIS_VGA_PASSTHROUGH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slowpci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbiinit1</span> <span class="o">|=</span> <span class="n">SLOW_PCI_WRITES</span><span class="p">;</span>
		<span class="n">fbiinit4</span> <span class="o">|=</span> <span class="n">SLOW_PCI_READS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fbiinit1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SLOW_PCI_WRITES</span><span class="p">;</span>
		<span class="n">fbiinit4</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SLOW_PCI_READS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">fbiinit0</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">,</span> <span class="n">fbiinit1</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">,</span> <span class="n">FBIINIT2_DEFAULT</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT3</span><span class="p">,</span> <span class="n">FBIINIT3_DEFAULT</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT4</span><span class="p">,</span> <span class="n">fbiinit4</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VOODOO2</span><span class="p">(</span><span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sst_write</span><span class="p">(</span><span class="n">FBIINIT6</span><span class="p">,</span> <span class="n">FBIINIT6_DEFAULT</span><span class="p">);</span>
		<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="n">PCI_EN_FIFO_WR</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_VCLK_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="n">__devexit</span> <span class="nf">sst_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pll_timing</span> <span class="n">gfx_timings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Fout</span><span class="p">;</span>

	<span class="cm">/* reset video, gfx, fifo, disable dram + remap fbiinit2/3 */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="n">PCI_EN_INIT_WR</span><span class="p">);</span>
	<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBIINIT1</span><span class="p">,</span> <span class="n">VIDEO_RESET</span> <span class="o">|</span> <span class="n">EN_BLANKING</span><span class="p">);</span>
	<span class="n">sst_unset_bits</span><span class="p">(</span><span class="n">FBIINIT2</span><span class="p">,</span> <span class="n">EN_DRAM_REFRESH</span><span class="p">);</span>
	<span class="n">sst_set_bits</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">FBI_RESET</span> <span class="o">|</span> <span class="n">FIFO_RESET</span><span class="p">);</span>
	<span class="n">sst_wait_idle</span><span class="p">();</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span>
	                       <span class="n">PCI_EN_INIT_WR</span> <span class="o">|</span> <span class="n">PCI_REMAP_DAC</span><span class="p">);</span>
	<span class="cm">/* set 20Mhz gfx clock */</span>
	<span class="n">sst_calc_pll</span><span class="p">(</span><span class="mi">20000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Fout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfx_timings</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_sw</span><span class="p">.</span><span class="n">set_pll</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gfx_timings</span><span class="p">,</span> <span class="n">GFX_CLOCK</span><span class="p">);</span>
	<span class="cm">/* TODO maybe shutdown the dac, vrefresh and so on... */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span>
	                       <span class="n">PCI_EN_INIT_WR</span><span class="p">);</span>
	<span class="n">sst_unset_bits</span><span class="p">(</span><span class="n">FBIINIT0</span><span class="p">,</span> <span class="n">FBI_RESET</span> <span class="o">|</span> <span class="n">FIFO_RESET</span> <span class="o">|</span> <span class="n">DIS_VGA_PASSTHROUGH</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_VCLK_DISABLE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* maybe keep fbiinit* and PCI_INIT_enable in the fb_info struct</span>
<span class="cm">	 * from start ? */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INIT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interface to the world</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">__devinit</span> <span class="nf">sstfb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;option %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this_opt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vganopass&quot;</span><span class="p">))</span>
			<span class="n">vgapass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;vgapass&quot;</span><span class="p">))</span>
			<span class="n">vgapass</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;clipping&quot;</span><span class="p">))</span>
		        <span class="n">clipping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noclipping&quot;</span><span class="p">))</span>
		        <span class="n">clipping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;fastpci&quot;</span><span class="p">))</span>
		        <span class="n">slowpci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;slowpci&quot;</span><span class="p">))</span>
		        <span class="n">slowpci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mem:&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
			<span class="n">mem</span> <span class="o">=</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;gfxclk:&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
			<span class="n">gfxclk</span> <span class="o">=</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">this_opt</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">sstfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">sstfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">sstfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">sstfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span> <span class="cm">/* sstfb_fillrect */</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span> <span class="cm">/* sstfb_copyarea */</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>	<span class="o">=</span> <span class="n">sstfb_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sstfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sst_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Enable device in PCI config. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span><span class="o">=</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate the fb and par structures.  */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sstfb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	
	<span class="n">par</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">fix</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">voodoo_spec</span><span class="p">[</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">];</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;found device : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span>	<span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span> <span class="o">+</span> <span class="mh">0x400000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">,</span> <span class="s">&quot;sstfb MMIO&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: cannot reserve mmio memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_mmio_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="mh">0x400000</span><span class="p">,</span><span class="s">&quot;sstfb FB&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: cannot reserve fb memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_fb_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span>
					<span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: cannot remap register area %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_mmio_remap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="mh">0x400000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: cannot remap framebuffer %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_fb_remap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sst_init</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: Init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sst_get_memsize</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s (revision %d) with %s dac</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dac_sw</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;framebuffer at %#lx, mapped to 0x%p, size %dMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span>
	        <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>

	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;regbase_virt: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">);</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;membase_phys: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">);</span>
	<span class="n">f_ddprintk</span><span class="p">(</span><span class="s">&quot;fbbase_virt: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sstfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span>	<span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>  <span class="cm">/* FIXME */</span>
	<span class="cm">/*</span>
<span class="cm">	 * According to the specs, the linelength must be of 1024 *pixels*</span>
<span class="cm">	 * and the 24bpp mode is in fact a 32 bpp mode (and both are in</span>
<span class="cm">	 * fact dithered to 16bit).</span>
<span class="cm">	 */</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span> <span class="cm">/* default value, for 24 or 32bit: 4096 */</span>
	
	<span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sstfb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: invalid video mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sstfb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: can&#39;t set default video mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: can&#39;t alloc cmap memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register fb */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sstfb: can&#39;t register framebuffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sstfb_clear_screen</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sstfb: can&#39;t create sysfs entry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_register:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="nl">fail_fb_remap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">);</span>
<span class="nl">fail_mmio_remap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="mh">0x400000</span><span class="p">);</span>
<span class="nl">fail_fb_mem:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
<span class="nl">fail_mmio_mem:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span> 	<span class="cm">/* no voodoo detected */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sstfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sstfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">sst_shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio_vbase</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="mh">0x400000</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">sstfb_id_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_3DFX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3DFX_VOODOO</span> <span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ID_VOODOO1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_3DFX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3DFX_VOODOO2</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ID_VOODOO2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sstfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sstfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sstfb_id_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sstfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sstfb_remove</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sstfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;sstfb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">sstfb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sstfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sstfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sstfb_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">sstfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sstfb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;(c) 2000,2002 Ghozlane Toumi &lt;gtoumi@laposte.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FBDev driver for 3dfx Voodoo Graphics and Voodoo2 based video boards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="s">&quot;Size of frame buffer memory in MB (1, 2, 4 MB, default=autodetect)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vgapass</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vgapass</span><span class="p">,</span> <span class="s">&quot;Enable VGA PassThrough mode (0 or 1) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">clipping</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">clipping</span><span class="p">,</span> <span class="s">&quot;Enable clipping (slower, safer) (0 or 1) (default=1)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gfxclk</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gfxclk</span><span class="p">,</span> <span class="s">&quot;Force graphic chip frequency in MHz. DANGEROUS. (default=auto)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">slowpci</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">slowpci</span><span class="p">,</span> <span class="s">&quot;Uses slow PCI settings (0 or 1) (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Initial video mode (default=&quot;</span> <span class="n">DEFAULT_VIDEO_MODE</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
