<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › kyro › STG4000InitDevice.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>STG4000InitDevice.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/kyro/STG4000InitDevice.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2000 Imagination Technologies Ltd</span>
<span class="cm"> *  Copyright (C) 2002 STMicroelectronics</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &quot;STG4000Reg.h&quot;</span>
<span class="cp">#include &quot;STG4000Interface.h&quot;</span>

<span class="cm">/* SDRAM fixed settings */</span>
<span class="cp">#define SDRAM_CFG_0   0x49A1</span>
<span class="cp">#define SDRAM_CFG_1   0xA732</span>
<span class="cp">#define SDRAM_CFG_2   0x31</span>
<span class="cp">#define SDRAM_ARB_CFG 0xA0</span>
<span class="cp">#define SDRAM_REFRESH 0x20</span>

<span class="cm">/* Reset values */</span>
<span class="cp">#define PMX2_SOFTRESET_DAC_RST		0x0001</span>
<span class="cp">#define PMX2_SOFTRESET_C1_RST		0x0004</span>
<span class="cp">#define PMX2_SOFTRESET_C2_RST		0x0008</span>
<span class="cp">#define PMX2_SOFTRESET_3D_RST		0x0010</span>
<span class="cp">#define PMX2_SOFTRESET_VIDIN_RST	0x0020</span>
<span class="cp">#define PMX2_SOFTRESET_TLB_RST		0x0040</span>
<span class="cp">#define PMX2_SOFTRESET_SD_RST		0x0080</span>
<span class="cp">#define PMX2_SOFTRESET_VGA_RST		0x0100</span>
<span class="cp">#define PMX2_SOFTRESET_ROM_RST		0x0200	</span><span class="cm">/* reserved bit, do not reset */</span><span class="cp"></span>
<span class="cp">#define PMX2_SOFTRESET_TA_RST		0x0400</span>
<span class="cp">#define PMX2_SOFTRESET_REG_RST		0x4000</span>
<span class="cp">#define PMX2_SOFTRESET_ALL		0x7fff</span>

<span class="cm">/* Core clock freq */</span>
<span class="cp">#define CORE_PLL_FREQ 1000000</span>

<span class="cm">/* Reference Clock freq */</span>
<span class="cp">#define REF_FREQ 14318</span>

<span class="cm">/* PCI Registers */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">CorePllControl</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>

<span class="cp">#define	PCI_CONFIG_SUBSYS_ID	0x2e</span>

<span class="cm">/* Misc */</span>
<span class="cp">#define CORE_PLL_MODE_REG_0_7      3</span>
<span class="cp">#define CORE_PLL_MODE_REG_8_15     2</span>
<span class="cp">#define CORE_PLL_MODE_CONFIG_REG   1</span>
<span class="cp">#define DAC_PLL_CONFIG_REG         0</span>

<span class="cp">#define STG_MAX_VCO 500000</span>
<span class="cp">#define STG_MIN_VCO 100000</span>

<span class="cm">/* PLL Clock */</span>
<span class="cp">#define    STG4K3_PLL_SCALER      8	</span><span class="cm">/* scale numbers by 2^8 for fixed point calc */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MIN_R       2	</span><span class="cm">/* Minimum multiplier */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MAX_R       33	</span><span class="cm">/* Max */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MIN_F       2	</span><span class="cm">/* Minimum divisor */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MAX_F       513	</span><span class="cm">/* Max */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MIN_OD      0	</span><span class="cm">/* Min output divider (shift) */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MAX_OD      2	</span><span class="cm">/* Max */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MIN_VCO_SC  (100000000 &gt;&gt; STG4K3_PLL_SCALER)	</span><span class="cm">/* Min VCO rate */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MAX_VCO_SC  (500000000 &gt;&gt; STG4K3_PLL_SCALER)	</span><span class="cm">/* Max VCO rate */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MINR_VCO_SC (100000000 &gt;&gt; STG4K3_PLL_SCALER)	</span><span class="cm">/* Min VCO rate (restricted) */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MAXR_VCO_SC (500000000 &gt;&gt; STG4K3_PLL_SCALER)	</span><span class="cm">/* Max VCO rate (restricted) */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MINR_VCO    100000000	</span><span class="cm">/* Min VCO rate (restricted) */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MAX_VCO     500000000	</span><span class="cm">/* Max VCO rate */</span><span class="cp"></span>
<span class="cp">#define    STG4K3_PLL_MAXR_VCO    500000000	</span><span class="cm">/* Max VCO rate (restricted) */</span><span class="cp"></span>

<span class="cp">#define OS_DELAY(X) \</span>
<span class="cp">{ \</span>
<span class="cp">volatile u32 i,count=0; \</span>
<span class="cp">    for(i=0;i&lt;X;i++) count++; \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">InitSDRAMRegisters</span><span class="p">(</span><span class="k">volatile</span> <span class="n">STG4000REG</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pSTGReg</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">dwSubSysID</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dwRevID</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">adwSDRAMArgCfg0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">adwSDRAMCfg1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8732</span><span class="p">,</span> <span class="mh">0x8732</span><span class="p">,</span> <span class="mh">0xa732</span><span class="p">,</span> <span class="mh">0xa732</span><span class="p">,</span> <span class="mh">0x8732</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">adwSDRAMCfg2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x87d2</span><span class="p">,</span> <span class="mh">0x87d2</span><span class="p">,</span> <span class="mh">0xa7d2</span><span class="p">,</span> <span class="mh">0x87d2</span><span class="p">,</span> <span class="mh">0xa7d2</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">adwSDRAMRsh</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">adwChipSpeed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">125</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">dwMemTypeIdx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dwChipSpeedIdx</span><span class="p">;</span>

	<span class="cm">/* Get memory tpye and chip speed indexs from the SubSysDevID */</span>
	<span class="n">dwMemTypeIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwSubSysID</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dwChipSpeedIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwSubSysID</span> <span class="o">&amp;</span> <span class="mh">0x180</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwMemTypeIdx</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">dwChipSpeedIdx</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Program SD-RAM interface */</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SDRAMArbiterConf</span><span class="p">,</span> <span class="n">adwSDRAMArgCfg0</span><span class="p">[</span><span class="n">dwMemTypeIdx</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwRevID</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SDRAMConf0</span><span class="p">,</span> <span class="mh">0x49A1</span><span class="p">);</span>
		<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SDRAMConf1</span><span class="p">,</span> <span class="n">adwSDRAMCfg1</span><span class="p">[</span><span class="n">dwMemTypeIdx</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SDRAMConf0</span><span class="p">,</span> <span class="mh">0x4DF1</span><span class="p">);</span>
		<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SDRAMConf1</span><span class="p">,</span> <span class="n">adwSDRAMCfg2</span><span class="p">[</span><span class="n">dwMemTypeIdx</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SDRAMConf2</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SDRAMRefresh</span><span class="p">,</span> <span class="n">adwSDRAMRsh</span><span class="p">[</span><span class="n">dwChipSpeedIdx</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">adwChipSpeed</span><span class="p">[</span><span class="n">dwChipSpeedIdx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ProgramClock</span><span class="p">(</span><span class="n">u32</span> <span class="n">refClock</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">coreClock</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="o">*</span> <span class="n">FOut</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ROut</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">POut</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ODIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulBestR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ulBestF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ulBestOD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulBestVCO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ulBestClk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ulBestScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulScore</span><span class="p">,</span> <span class="n">ulPhaseScore</span><span class="p">,</span> <span class="n">ulVcoScore</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulTmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ulVCO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulScaleClockReq</span><span class="p">,</span> <span class="n">ulMinClock</span><span class="p">,</span> <span class="n">ulMaxClock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ODValues</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="cm">/* Translate clock in Hz */</span>
	<span class="n">coreClock</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* in Hz */</span>
	<span class="n">refClock</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* in Hz */</span>

	<span class="cm">/* Work out acceptable clock</span>
<span class="cm">	 * The method calculates ~ +- 0.4% (1/256)</span>
<span class="cm">	 */</span>
	<span class="n">ulMinClock</span> <span class="o">=</span> <span class="n">coreClock</span> <span class="o">-</span> <span class="p">(</span><span class="n">coreClock</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ulMaxClock</span> <span class="o">=</span> <span class="n">coreClock</span> <span class="o">+</span> <span class="p">(</span><span class="n">coreClock</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Scale clock required for use in calculations */</span>
	<span class="n">ulScaleClockReq</span> <span class="o">=</span> <span class="n">coreClock</span> <span class="o">&gt;&gt;</span> <span class="n">STG4K3_PLL_SCALER</span><span class="p">;</span>

	<span class="cm">/* Iterate through post divider values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ODIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ODIndex</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">ODIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OD</span> <span class="o">=</span> <span class="n">ODValues</span><span class="p">[</span><span class="n">ODIndex</span><span class="p">];</span>
		<span class="n">R</span> <span class="o">=</span> <span class="n">STG4K3_PLL_MIN_R</span><span class="p">;</span>

		<span class="cm">/* loop for pre-divider from min to max  */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;=</span> <span class="n">STG4K3_PLL_MAX_R</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* estimate required feedback multiplier */</span>
			<span class="n">ulTmp</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="p">(</span><span class="n">ulScaleClockReq</span> <span class="o">&lt;&lt;</span> <span class="n">OD</span><span class="p">);</span>

			<span class="cm">/* F = ClkRequired * R * (2^OD) / Fref */</span>
			<span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ulTmp</span> <span class="o">/</span> <span class="p">(</span><span class="n">refClock</span> <span class="o">&gt;&gt;</span> <span class="n">STG4K3_PLL_SCALER</span><span class="p">));</span>

			<span class="cm">/* compensate for accuracy */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">F</span> <span class="o">&gt;</span> <span class="n">STG4K3_PLL_MIN_F</span><span class="p">)</span>
				<span class="n">F</span><span class="o">--</span><span class="p">;</span>


			<span class="cm">/*</span>
<span class="cm">			 * We should be close to our target frequency (if it&#39;s</span>
<span class="cm">			 * achievable with current OD &amp; R) let&#39;s iterate</span>
<span class="cm">			 * through F for best fit</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">F</span> <span class="o">&gt;=</span> <span class="n">STG4K3_PLL_MIN_F</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">F</span> <span class="o">&lt;=</span> <span class="n">STG4K3_PLL_MAX_F</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Calc VCO at full accuracy */</span>
				<span class="n">ulVCO</span> <span class="o">=</span> <span class="n">refClock</span> <span class="o">/</span> <span class="n">R</span><span class="p">;</span>
				<span class="n">ulVCO</span> <span class="o">=</span> <span class="n">F</span> <span class="o">*</span> <span class="n">ulVCO</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Check it&#39;s within restricted VCO range</span>
<span class="cm">				 * unless of course the desired frequency is</span>
<span class="cm">				 * above the restricted range, then test</span>
<span class="cm">				 * against VCO limit</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ulVCO</span> <span class="o">&gt;=</span> <span class="n">STG4K3_PLL_MINR_VCO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">((</span><span class="n">ulVCO</span> <span class="o">&lt;=</span> <span class="n">STG4K3_PLL_MAXR_VCO</span><span class="p">)</span> <span class="o">||</span>
				     <span class="p">((</span><span class="n">coreClock</span> <span class="o">&gt;</span> <span class="n">STG4K3_PLL_MAXR_VCO</span><span class="p">)</span>
				      <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ulVCO</span> <span class="o">&lt;=</span> <span class="n">STG4K3_PLL_MAX_VCO</span><span class="p">))))</span> <span class="p">{</span>
					<span class="n">ulTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulVCO</span> <span class="o">&gt;&gt;</span> <span class="n">OD</span><span class="p">);</span>	<span class="cm">/* Clock = VCO / (2^OD) */</span>

					<span class="cm">/* Is this clock good enough? */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">ulTmp</span> <span class="o">&gt;=</span> <span class="n">ulMinClock</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ulTmp</span> <span class="o">&lt;=</span> <span class="n">ulMaxClock</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">ulPhaseScore</span> <span class="o">=</span> <span class="p">(((</span><span class="n">refClock</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">refClock</span> <span class="o">/</span> <span class="n">STG4K3_PLL_MAX_R</span><span class="p">)))</span> <span class="o">/</span> <span class="p">((</span><span class="n">refClock</span> <span class="o">-</span> <span class="p">(</span><span class="n">refClock</span> <span class="o">/</span> <span class="n">STG4K3_PLL_MAX_R</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

						<span class="n">ulVcoScore</span> <span class="o">=</span> <span class="p">((</span><span class="n">ulVCO</span> <span class="o">-</span> <span class="n">STG4K3_PLL_MINR_VCO</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">STG4K3_PLL_MAXR_VCO</span> <span class="o">-</span> <span class="n">STG4K3_PLL_MINR_VCO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
						<span class="n">ulScore</span> <span class="o">=</span> <span class="n">ulPhaseScore</span> <span class="o">+</span> <span class="n">ulVcoScore</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ulBestScore</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">ulBestVCO</span> <span class="o">=</span> <span class="n">ulVCO</span><span class="p">;</span>
							<span class="n">ulBestOD</span> <span class="o">=</span> <span class="n">OD</span><span class="p">;</span>
							<span class="n">ulBestF</span> <span class="o">=</span> <span class="n">F</span><span class="p">;</span>
							<span class="n">ulBestR</span> <span class="o">=</span> <span class="n">R</span><span class="p">;</span>
							<span class="n">ulBestClk</span> <span class="o">=</span> <span class="n">ulTmp</span><span class="p">;</span>
							<span class="n">ulBestScore</span> <span class="o">=</span>
							    <span class="n">ulScore</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="cm">/* is this better, ( aim for highest Score) */</span>
			<span class="cm">/*--------------------------------------------------------------------------</span>
<span class="cm">                             Here we want to use a scoring system which will take account of both the</span>
<span class="cm">                            value at the phase comparater and the VCO output</span>
<span class="cm">                             to do this we will use a cumulative score between the two</span>
<span class="cm">                          The way this ends up is that we choose the first value in the loop anyway</span>
<span class="cm">                          but we shall keep this code in case new restrictions come into play</span>
<span class="cm">                          --------------------------------------------------------------------------*/</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">ulScore</span> <span class="o">&gt;=</span> <span class="n">ulBestScore</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">OD</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">ulBestVCO</span> <span class="o">=</span> <span class="n">ulVCO</span><span class="p">;</span>
							<span class="n">ulBestOD</span> <span class="o">=</span> <span class="n">OD</span><span class="p">;</span>
							<span class="n">ulBestF</span> <span class="o">=</span> <span class="n">F</span><span class="p">;</span>
							<span class="n">ulBestR</span> <span class="o">=</span> <span class="n">R</span><span class="p">;</span>
							<span class="n">ulBestClk</span> <span class="o">=</span> <span class="n">ulTmp</span><span class="p">;</span>
							<span class="n">ulBestScore</span> <span class="o">=</span>
							    <span class="n">ulScore</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">F</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">R</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   did we find anything?</span>
<span class="cm">	   Then return RFOD</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ulBestScore</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ROut</span> <span class="o">=</span> <span class="n">ulBestR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">FOut</span> <span class="o">=</span> <span class="n">ulBestF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ulBestOD</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ulBestOD</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">POut</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">POut</span> <span class="o">=</span> <span class="n">ulBestOD</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ulBestClk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SetCoreClockPLL</span><span class="p">(</span><span class="k">volatile</span> <span class="n">STG4000REG</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pSTGReg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pDev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">F</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">core_pll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sub</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulCoreClock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulChipSpeed</span><span class="p">;</span>

	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="cm">/* Disable Primary Core Thread0 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">STG_READ_REG</span><span class="p">(</span><span class="n">Thread0Enable</span><span class="p">);</span>
	<span class="n">CLEAR_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">Thread0Enable</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Disable Primary Core Thread1 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">STG_READ_REG</span><span class="p">(</span><span class="n">Thread1Enable</span><span class="p">);</span>
	<span class="n">CLEAR_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">Thread1Enable</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SoftwareReset</span><span class="p">,</span>
		      <span class="n">PMX2_SOFTRESET_REG_RST</span> <span class="o">|</span> <span class="n">PMX2_SOFTRESET_ROM_RST</span><span class="p">);</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SoftwareReset</span><span class="p">,</span>
		      <span class="n">PMX2_SOFTRESET_REG_RST</span> <span class="o">|</span> <span class="n">PMX2_SOFTRESET_TA_RST</span> <span class="o">|</span>
		      <span class="n">PMX2_SOFTRESET_ROM_RST</span><span class="p">);</span>

	<span class="cm">/* Need to play around to reset TA */</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">TAConfiguration</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SoftwareReset</span><span class="p">,</span>
		      <span class="n">PMX2_SOFTRESET_REG_RST</span> <span class="o">|</span> <span class="n">PMX2_SOFTRESET_ROM_RST</span><span class="p">);</span>
	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SoftwareReset</span><span class="p">,</span>
		      <span class="n">PMX2_SOFTRESET_REG_RST</span> <span class="o">|</span> <span class="n">PMX2_SOFTRESET_TA_RST</span> <span class="o">|</span>
		      <span class="n">PMX2_SOFTRESET_ROM_RST</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">PCI_CONFIG_SUBSYS_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sub</span><span class="p">);</span>

	<span class="n">ulChipSpeed</span> <span class="o">=</span> <span class="n">InitSDRAMRegisters</span><span class="p">(</span><span class="n">pSTGReg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sub</span><span class="p">,</span>
		                         <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulChipSpeed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ulCoreClock</span> <span class="o">=</span> <span class="n">ProgramClock</span><span class="p">(</span><span class="n">REF_FREQ</span><span class="p">,</span> <span class="n">CORE_PLL_FREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">R</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">P</span><span class="p">);</span>

	<span class="n">core_pll</span> <span class="o">|=</span> <span class="p">((</span><span class="n">P</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">F</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">R</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>

	<span class="cm">/* Set Core PLL Control to Core PLL Mode  */</span>

	<span class="cm">/* Send bits 0:7 of the Core PLL Mode register */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">CORE_PLL_MODE_REG_0_7</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">core_pll</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">));</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">CorePllControl</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* Without some delay between the PCI config writes the clock does</span>
<span class="cm">	   not reliably set when the code is compiled -O3</span>
<span class="cm">	 */</span>
	<span class="n">OS_DELAY</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SET_BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">CorePllControl</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">OS_DELAY</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>

	<span class="cm">/* Send bits 8:15 of the Core PLL Mode register */</span>
	<span class="n">tmp</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">CORE_PLL_MODE_REG_8_15</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">core_pll</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">CorePllControl</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">OS_DELAY</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SET_BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">CorePllControl</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">OS_DELAY</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>

	<span class="n">STG_WRITE_REG</span><span class="p">(</span><span class="n">SoftwareReset</span><span class="p">,</span> <span class="n">PMX2_SOFTRESET_ALL</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Enable Primary Core Thread0 */</span>
<span class="c">	tmp = ((STG_READ_REG(Thread0Enable)) | SET_BIT(0));</span>
<span class="c">	STG_WRITE_REG(Thread0Enable, tmp);</span>

<span class="c">	/* Enable Primary Core Thread1 */</span>
<span class="c">	tmp = ((STG_READ_REG(Thread1Enable)) | SET_BIT(0));</span>
<span class="c">	STG_WRITE_REG(Thread1Enable, tmp);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
