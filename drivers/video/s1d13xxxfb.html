<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › s1d13xxxfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>s1d13xxxfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* drivers/video/s1d13xxxfb.c</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2004 Simtec Electronics</span>
<span class="cm"> * (c) 2005 Thibaut VARENE &lt;varenet@parisc-linux.org&gt;</span>
<span class="cm"> * (c) 2009 Kristoffer Ericson &lt;kristoffer.ericson@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for Epson S1D13xxx series framebuffer chips</span>
<span class="cm"> *</span>
<span class="cm"> * Adapted from</span>
<span class="cm"> *  linux/drivers/video/skeletonfb.c</span>
<span class="cm"> *  linux/drivers/video/epson1355fb.c</span>
<span class="cm"> *  linux/drivers/video/epson/s1d13xxxfb.c (2.4 driver by Epson)</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: - handle dual screen display (CRT and LCD at the same time).</span>
<span class="cm"> *	 - check_var(), mode change, etc.</span>
<span class="cm"> *	 - probably not SMP safe :)</span>
<span class="cm"> *       - support all bitblt operations on all cards</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mman.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock_types.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;video/s1d13xxxfb.h&gt;</span>

<span class="cp">#define PFX	&quot;s1d13xxxfb: &quot;</span>
<span class="cp">#define BLIT	&quot;s1d13xxxfb_bitblt: &quot;</span>

<span class="cm">/*</span>
<span class="cm"> * set this to enable debugging on general functions</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define dbg(fmt, args...) do { printk(KERN_INFO fmt, ## args); } while(0)</span>
<span class="cp">#else</span>
<span class="cp">#define dbg(fmt, args...) do { } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * set this to enable debugging on 2D acceleration</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define dbg_blit(fmt, args...) do { printk(KERN_INFO BLIT fmt, ## args); } while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define dbg_blit(fmt, args...) do { } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * we make sure only one bitblt operation is running</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">s1d13xxxfb_bitblt_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * list of card production ids</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">s1d13xxxfb_prod_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">S1D13505_PROD_ID</span><span class="p">,</span>
	<span class="n">S1D13506_PROD_ID</span><span class="p">,</span>
	<span class="n">S1D13806_PROD_ID</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * List of card strings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s1d13xxxfb_prod_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;S1D13505&quot;</span><span class="p">,</span>
	<span class="s">&quot;S1D13506&quot;</span><span class="p">,</span>
	<span class="s">&quot;S1D13806&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * here we define the default struct fb_fix_screeninfo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">__devinitdata</span> <span class="n">s1d13xxxfb_fix</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">S1D_FBID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span>		<span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span>		<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span>
<span class="nf">s1d13xxxfb_readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_PLAT_M32700UT) || defined(CONFIG_PLAT_OPSPUT) || defined(CONFIG_PLAT_MAPPI3)</span>
	<span class="n">regno</span><span class="o">=</span><span class="p">((</span><span class="n">regno</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1L</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">regno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">regno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">s1d13xxxfb_writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_PLAT_M32700UT) || defined(CONFIG_PLAT_OPSPUT) || defined(CONFIG_PLAT_MAPPI3)</span>
	<span class="n">regno</span><span class="o">=</span><span class="p">((</span><span class="n">regno</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1L</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">regno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">regno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">s1d13xxxfb_runinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">s1d13xxxfb_regval</span> <span class="o">*</span><span class="n">initregs</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        	<span class="k">if</span> <span class="p">((</span><span class="n">initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">S1DREG_DELAYOFF</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">S1DREG_DELAYON</span><span class="p">))</span>
			<span class="n">mdelay</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
        	<span class="k">else</span> <span class="p">{</span>
			<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">initregs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
        <span class="p">}</span>

	<span class="cm">/* make sure the hardware can cope with us */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lcd_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_COM_DISP_MODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>

	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_COM_DISP_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">crt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_COM_DISP_MODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>

	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_COM_DISP_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*************************************************************</span>
<span class="cm"> framebuffer control functions</span>
<span class="cm"> *************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">s1d13xxxfb_setup_pseudocolour</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">s1d13xxxfb_setup_truecolour</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      s1d13xxxfb_set_par - Alters the hardware state.</span>
<span class="cm"> *      @info: frame buffer structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Using the fb_var_screeninfo in fb_info we set the depth of the</span>
<span class="cm"> *	framebuffer. This function alters the par AND the</span>
<span class="cm"> *	fb_fix_screeninfo stored in fb_info. It doesn&#39;t not alter var in</span>
<span class="cm"> *	fb_info since we are using that data. This means we depend on the</span>
<span class="cm"> *	data in var inside fb_info to be supported by the hardware.</span>
<span class="cm"> *	xxxfb_check_var is always called before xxxfb_set_par to ensure this.</span>
<span class="cm"> *</span>
<span class="cm"> *	XXX TODO: write proper s1d13xxxfb_check_var(), without which that</span>
<span class="cm"> *	function is quite useless.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s1d13xxxfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">s1dfb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;s1d13xxxfb_set_par: bpp=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>	<span class="cm">/* LCD */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_MODE</span><span class="p">);</span>   <span class="cm">/* read colour control */</span>
	<span class="k">else</span>	<span class="cm">/* CRT */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_MODE</span><span class="p">);</span>   <span class="cm">/* read colour control */</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;pseudo colour 4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">s1d13xxxfb_setup_pseudocolour</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;pseudo colour 8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">s1d13xxxfb_setup_pseudocolour</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;true colour</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">s1d13xxxfb_setup_truecolour</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bpp not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;writing %02x to display mode register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>	<span class="cm">/* LCD */</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>	<span class="cm">/* CRT */</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;setting line_length to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;done setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	s1d13xxxfb_setcolreg - sets a color register.</span>
<span class="cm"> *	@regno: Which register in the CLUT we are programming</span>
<span class="cm"> *	@red: The red value which can be up to 16 bits wide</span>
<span class="cm"> *	@green: The green value which can be up to 16 bits wide</span>
<span class="cm"> *	@blue:  The blue value which can be up to 16 bits wide.</span>
<span class="cm"> *	@transp: If supported the alpha value which can be up to 16 bits wide.</span>
<span class="cm"> *	@info: frame buffer info structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s1d13xxxfb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			<span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">s1dfb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pseudo_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">S1D_PALETTE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;s1d13xxxfb_setcolreg: %d: rgb=%d,%d,%d, tr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">transp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">19595</span><span class="o">*</span><span class="n">red</span> <span class="o">+</span> <span class="mi">38470</span><span class="o">*</span><span class="n">green</span> <span class="o">+</span> <span class="mi">7471</span><span class="o">*</span><span class="n">blue</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="cm">/* deal with creating pseudo-palette entries */</span>

			<span class="n">pseudo_val</span>  <span class="o">=</span> <span class="p">(</span><span class="n">red</span>   <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">pseudo_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">pseudo_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;s1d13xxxfb_setcolreg: pseudo %d, val %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">regno</span><span class="p">,</span> <span class="n">pseudo_val</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_PLAT_MAPPI)</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pseudo_val</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">pseudo_val</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
			<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_LKUP_ADDR</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
			<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_LKUP_DATA</span><span class="p">,</span> <span class="n">red</span><span class="p">);</span>
			<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_LKUP_DATA</span><span class="p">,</span> <span class="n">green</span><span class="p">);</span>
			<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_LKUP_DATA</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;s1d13xxxfb_setcolreg: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      s1d13xxxfb_blank - blanks the display.</span>
<span class="cm"> *      @blank_mode: the blank mode we want.</span>
<span class="cm"> *      @info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *      Blank the screen if blank_mode != 0, else unblank. Return 0 if</span>
<span class="cm"> *      blanking succeeded, != 0 if un-/blanking failed due to e.g. a</span>
<span class="cm"> *      video mode which doesn&#39;t support it. Implements VESA suspend</span>
<span class="cm"> *      and powerdown modes on hardware that supports disabling hsync/vsync:</span>
<span class="cm"> *      blank_mode == 2: suspend vsync</span>
<span class="cm"> *      blank_mode == 3: suspend hsync</span>
<span class="cm"> *      blank_mode == 4: powerdown</span>
<span class="cm"> *</span>
<span class="cm"> *      Returns negative errno on error, or zero on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s1d13xxxfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;s1d13xxxfb_blank: blank=%d, info=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">lcd_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">crt_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
			<span class="n">lcd_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">crt_enable</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* let fbcon do a soft blank for us */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">blank_mode</span> <span class="o">==</span> <span class="n">FB_BLANK_NORMAL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	s1d13xxxfb_pan_display - Pans the display.</span>
<span class="cm"> *	@var: frame buffer variable screen structure</span>
<span class="cm"> *	@info: frame buffer structure that represents a single frame buffer</span>
<span class="cm"> *</span>
<span class="cm"> *	Pan (or wrap, depending on the `vmode&#39; field) the display using the</span>
<span class="cm"> *	`yoffset&#39; field of the `var&#39; structure (`xoffset&#39;  not yet supported).</span>
<span class="cm"> *	If the values don&#39;t fit, return -EINVAL.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s1d13xxxfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* not yet ... */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* LCD */</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_START0</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_START1</span><span class="p">,</span> <span class="p">((</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_START2</span><span class="p">,</span> <span class="p">((</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* CRT */</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_START0</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_START1</span><span class="p">,</span> <span class="p">((</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_START2</span><span class="p">,</span> <span class="p">((</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************************</span>
<span class="cm"> functions to handle bitblt acceleration</span>
<span class="cm"> ************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> *	bltbit_wait_bitclear - waits for change in register value</span>
<span class="cm"> *	@info : frambuffer structure</span>
<span class="cm"> *	@bit  : value currently in register</span>
<span class="cm"> *	@timeout : ...</span>
<span class="cm"> *</span>
<span class="cm"> *	waits until value changes FROM bit</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">bltbit_wait_bitclear</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CTL0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;wait_bitclear timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	s1d13xxxfb_bitblt_copyarea - accelerated copyarea function</span>
<span class="cm"> *	@info : framebuffer structure</span>
<span class="cm"> *	@area : fb_copyarea structure</span>
<span class="cm"> *</span>
<span class="cm"> *	supports (atleast) S1D13506</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">s1d13xxxfb_bitblt_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">width</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1d13xxxfb_bitblt_lock</span><span class="p">);</span>

	<span class="cm">/* bytes per xres line */</span>
	<span class="n">bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">stride</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>

	<span class="cm">/* reverse, calculate the last pixel in rectangle */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">sy</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">dy</span> <span class="o">==</span> <span class="n">sy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">sx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="n">reverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* not reverse, calculate the first pixel in rectangle */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* (y * xres) + (bpp * x) */</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">dx</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">sy</span> <span class="o">*</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">sx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set source address */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_SRC_START0</span><span class="p">,</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_SRC_START1</span><span class="p">,</span> <span class="p">(</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_SRC_START2</span><span class="p">,</span> <span class="p">(</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>

	<span class="cm">/* set destination address */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_DST_START0</span><span class="p">,</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_DST_START1</span><span class="p">,</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_DST_START2</span><span class="p">,</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>

	<span class="cm">/* program height and width */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_WIDTH0</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_WIDTH1</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_HEIGHT0</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_HEIGHT1</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* negative direction ROP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reverse</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(copyarea) negative rop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_OP</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* positive direction ROP */</span> <span class="p">{</span>
		<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_OP</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(copyarea) positive rop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set for rectangel mode and not linear */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CTL0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* setup the bpp 1 = 16bpp, 0 = 8bpp*/</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* set words per xres */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_MEM_OFF0</span><span class="p">,</span> <span class="p">(</span><span class="n">stride</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_MEM_OFF1</span><span class="p">,</span> <span class="p">(</span><span class="n">stride</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">));</span>

	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(copyarea) dx=%d, dy=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">);</span>
	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(copyarea) sx=%d, sy=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">);</span>
	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(copyarea) width=%d, height=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(copyarea) stride=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stride</span><span class="p">);</span>
	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(copyarea) bpp=%d=0x0%d, mem_offset1=%d, mem_offset2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
		<span class="p">(</span><span class="n">stride</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">stride</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CC_EXP</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>

	<span class="cm">/* initialize the engine */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CTL0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* wait to complete */</span>
	<span class="n">bltbit_wait_bitclear</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1d13xxxfb_bitblt_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> *	s1d13xxxfb_bitblt_solidfill - accelerated solidfill function</span>
<span class="cm"> *	@info : framebuffer structure</span>
<span class="cm"> *	@rect : fb_fillrect structure</span>
<span class="cm"> *</span>
<span class="cm"> *	supports (atleast 13506)</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">s1d13xxxfb_bitblt_solidfill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">screen_stride</span><span class="p">,</span> <span class="n">dest</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* grab spinlock */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1d13xxxfb_bitblt_lock</span><span class="p">);</span>

	<span class="cm">/* bytes per x width */</span>
	<span class="n">screen_stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">);</span>

	<span class="cm">/* bytes to starting point */</span>
	<span class="n">dest</span> <span class="o">=</span> <span class="p">((</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">*</span> <span class="n">screen_stride</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">));</span>

	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(solidfill) dx=%d, dy=%d, stride=%d, dest=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;(solidfill) : rect_width=%d, rect_height=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">screen_stride</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span>
				<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(solidfill) : xres=%d, yres=%d, bpp=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(solidfill) : rop=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">);</span>

	<span class="cm">/* We split the destination into the three registers */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_DST_START0</span><span class="p">,</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">));</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_DST_START1</span><span class="p">,</span> <span class="p">((</span><span class="n">dest</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">));</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_DST_START2</span><span class="p">,</span> <span class="p">((</span><span class="n">dest</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">));</span>

	<span class="cm">/* give information regarding rectangel width */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_WIDTH0</span><span class="p">,</span> <span class="p">((</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_WIDTH1</span><span class="p">,</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* give information regarding rectangel height */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_HEIGHT0</span><span class="p">,</span> <span class="p">((</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_HEIGHT1</span><span class="p">,</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span> <span class="o">||</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">];</span>
		<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(solidfill) truecolor/directcolor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(solidfill) pseudo_palette[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span> <span class="n">fg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fg</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>
		<span class="n">dbg_blit</span><span class="p">(</span><span class="s">&quot;(solidfill) color = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set foreground color */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_FGC0</span><span class="p">,</span> <span class="p">(</span><span class="n">fg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_FGC1</span><span class="p">,</span> <span class="p">(</span><span class="n">fg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* set rectangual region of memory (rectangle and not linear) */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CTL0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* set operation mode SOLID_FILL */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_OP</span><span class="p">,</span> <span class="n">BBLT_SOLID_FILL</span><span class="p">);</span>

	<span class="cm">/* set bits per pixel (1 = 16bpp, 0 = 8bpp) */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* set the memory offset for the bblt in word sizes */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_MEM_OFF0</span><span class="p">,</span> <span class="p">(</span><span class="n">screen_stride</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_MEM_OFF1</span><span class="p">,</span> <span class="p">(</span><span class="n">screen_stride</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">));</span>

	<span class="cm">/* and away we go.... */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_BBLT_CTL0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* wait until its done */</span>
	<span class="n">bltbit_wait_bitclear</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>

	<span class="cm">/* let others play */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1d13xxxfb_bitblt_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* framebuffer information structures */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">s1d13xxxfb_fbops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">s1d13xxxfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">s1d13xxxfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">s1d13xxxfb_blank</span><span class="p">,</span>

	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">s1d13xxxfb_pan_display</span><span class="p">,</span>

	<span class="cm">/* gets replaced at chip detection time */</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">s1d13xxxfb_width_tab</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	s1d13xxxfb_fetch_hw_state - Configure the framebuffer according to</span>
<span class="cm"> *	hardware setup.</span>
<span class="cm"> *	@info: frame buffer structure</span>
<span class="cm"> *</span>
<span class="cm"> *	We setup the framebuffer structures according to the current</span>
<span class="cm"> *	hardware setup. On some machines, the BIOS will have filled</span>
<span class="cm"> *	the chip registers with such info, on others, these values will</span>
<span class="cm"> *	have been written in some init procedure. In any case, the</span>
<span class="cm"> *	software values needs to match the hardware ones. This is what</span>
<span class="cm"> *	this function ensures.</span>
<span class="cm"> *</span>
<span class="cm"> *	Note: some of the hardcoded values here might need some love to</span>
<span class="cm"> *	work on various chips, and might need to no longer be hardcoded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">s1d13xxxfb_fetch_hw_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">panel</span><span class="p">,</span> <span class="n">display</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xres_virtual</span><span class="p">,</span> <span class="n">yres_virtual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">lcd_bpp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_color</span><span class="p">,</span> <span class="n">is_dual</span><span class="p">,</span> <span class="n">is_tft</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lcd_enabled</span><span class="p">,</span> <span class="n">crt_enabled</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>

	<span class="cm">/* general info */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_COM_DISP_MODE</span><span class="p">);</span>
	<span class="n">crt_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lcd_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">crt_enabled</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Warning: LCD and CRT detected, using LCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_enabled</span><span class="p">)</span>
		<span class="n">display</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_MODE</span><span class="p">);</span>
	<span class="k">else</span>	<span class="cm">/* CRT */</span>
		<span class="n">display</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_MODE</span><span class="p">);</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* 4 bpp */</span>
		<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* 8 bpp */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* 16 bpp */</span>
			<span class="n">s1d13xxxfb_setup_truecolour</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bpp: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* LCD info */</span>
	<span class="n">panel</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_PANEL_TYPE</span><span class="p">);</span>
	<span class="n">is_color</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">is_dual</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">is_tft</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lcd_bpp</span> <span class="o">=</span> <span class="n">s1d13xxxfb_width_tab</span><span class="p">[</span><span class="n">is_tft</span><span class="p">][(</span><span class="n">panel</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_HWIDTH</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_VHEIGHT0</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_DISP_VHEIGHT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_MEM_OFF0</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_LCD_MEM_OFF1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* crt */</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_HWIDTH</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_VHEIGHT0</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_DISP_VHEIGHT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_MEM_OFF0</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_CRT_MEM_OFF1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">/</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span>		<span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span>		<span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span>	<span class="o">=</span> <span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span>	<span class="o">=</span> <span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span>		<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span>	<span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span>		<span class="o">=</span> <span class="o">!</span><span class="n">is_color</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span>		<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;bpp=%d, lcd_bpp=%d, &quot;</span>
		<span class="s">&quot;crt_enabled=%d, lcd_enabled=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="n">lcd_bpp</span><span class="p">,</span> <span class="n">crt_enabled</span><span class="p">,</span> <span class="n">lcd_enabled</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;xres=%d, yres=%d, vxres=%d, vyres=%d &quot;</span>
		<span class="s">&quot;is_color=%d, is_dual=%d, is_tft=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">xres_virtual</span><span class="p">,</span> <span class="n">yres_virtual</span><span class="p">,</span> <span class="n">is_color</span><span class="p">,</span> <span class="n">is_dual</span><span class="p">,</span> <span class="n">is_tft</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s1d13xxxfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable output &amp; enable powersave */</span>
			<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_COM_DISP_MODE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">S1DREG_PS_CNF</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">s1d13xxxfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">default_par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">revision</span><span class="p">,</span> <span class="n">prod_id</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;probe called: device is %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Epson S1D13XXX FB Driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* enable platform-dependent hardware glue, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">platform_init_video</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">platform_init_video</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid num_resources: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* resource[0] is VRAM, resource[1] is registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">IORESOURCE_MEM</span>
			<span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid resource type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;s1d13xxxfb mem&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_mem_region failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;s1d13xxxfb regs&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_mem_region failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s1d13xxxfb_par</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">default_par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_par</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">default_par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to map framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* production id is top 6 bits */</span>
	<span class="n">prod_id</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">default_par</span><span class="p">,</span> <span class="n">S1DREG_REV_CODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* revision id is lower 2 bits */</span>
	<span class="n">revision</span> <span class="o">=</span> <span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">default_par</span><span class="p">,</span> <span class="n">S1DREG_REV_CODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s1d13xxxfb_prod_ids</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prod_id</span> <span class="o">==</span> <span class="n">s1d13xxxfb_prod_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* looks like we got it in our list */</span>
			<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">prod_id</span> <span class="o">=</span> <span class="n">prod_id</span><span class="p">;</span>
			<span class="n">default_par</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">revision</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;chip production id %i = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">prod_id</span><span class="p">,</span> <span class="n">s1d13xxxfb_prod_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;chip revision %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">revision</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
			<span class="s">&quot;unknown chip production id %i, revision %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">prod_id</span><span class="p">,</span> <span class="n">revision</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;please contant maintainer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">s1d13xxxfb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;regs mapped at 0x%p, fb %d KiB mapped at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">default_par</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">default_par</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s1d13xxxfb_fbops</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">prod_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S1D13506_PROD_ID</span>:	<span class="cm">/* activate acceleration */</span>
		<span class="n">s1d13xxxfb_fbops</span><span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">s1d13xxxfb_bitblt_solidfill</span><span class="p">;</span>
		<span class="n">s1d13xxxfb_fbops</span><span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">s1d13xxxfb_bitblt_copyarea</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span> <span class="o">|</span>
			<span class="n">FBINFO_HWACCEL_FILLRECT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_COPYAREA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* perform &quot;manual&quot; chip initialization, if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">initregs</span><span class="p">)</span>
		<span class="n">s1d13xxxfb_runinit</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">initregs</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">initregssize</span><span class="p">);</span>

	<span class="n">s1d13xxxfb_fetch_hw_state</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bail:</span>
	<span class="n">s1d13xxxfb_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s1d13xxxfb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">s1dfb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* disable display */</span>
	<span class="n">lcd_enable</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">crt_enable</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (!s1dfb-&gt;disp_save)</span>
<span class="c">		s1dfb-&gt;disp_save = kmalloc(info-&gt;fix.smem_len, GFP_KERNEL);</span>

<span class="c">	if (!s1dfb-&gt;disp_save) {</span>
<span class="c">		printk(KERN_ERR PFX &quot;no memory to save screen&quot;);</span>
<span class="c">		return -ENOMEM;</span>
<span class="c">	}</span>

<span class="c">	memcpy_fromio(s1dfb-&gt;disp_save, info-&gt;screen_base, info-&gt;fix.smem_len);</span>
<span class="cp">#else</span>
	<span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">disp_save</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs_save</span><span class="p">)</span>
		<span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs_save</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs_save</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;no memory to save registers&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* backup all registers */</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs_save</span><span class="p">,</span> <span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>

	<span class="cm">/* now activate power save mode */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_PS_CNF</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">platform_suspend_video</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">platform_suspend_video</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s1d13xxxfb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_par</span> <span class="o">*</span><span class="n">s1dfb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s1d13xxxfb_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* awaken the chip */</span>
	<span class="n">s1d13xxxfb_writereg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_PS_CNF</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* do not let go until SDRAM &quot;wakes up&quot; */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">s1d13xxxfb_readreg</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="n">S1DREG_PS_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs_save</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* will write RO regs, *should* get away with it :) */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs_save</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">regs_save</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">disp_save</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">disp_save</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">disp_save</span><span class="p">);</span>	<span class="cm">/* XXX kmalloc()&#39;d when? */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">lcd_enable</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s1dfb</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">crt_enable</span><span class="p">(</span><span class="n">s1dfb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">platform_resume_video</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">platform_resume_video</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">s1d13xxxfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">s1d13xxxfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">s1d13xxxfb_remove</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">s1d13xxxfb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">s1d13xxxfb_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">S1D_DEVICENAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">s1d13xxxfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifndef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;s1d13xxxfb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1d13xxxfb_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">s1d13xxxfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1d13xxxfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">s1d13xxxfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">s1d13xxxfb_exit</span><span class="p">);</span>


<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for S1D13xxx devices&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Dooks &lt;ben@simtec.co.uk&gt;, Thibaut VARENE &lt;varenet@parisc-linux.org&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
