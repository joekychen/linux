<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › pm3fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pm3fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/video/pm3fb.c -- 3DLabs Permedia3 frame buffer device</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2001 Romain Dolbeau &lt;romain@dolbeau.org&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> *  Ported to 2.6 kernel on 1 May 2007 by Krzysztof Helt &lt;krzysztof.h1@wp.pl&gt;</span>
<span class="cm"> *	based on pm2fb.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on code written by:</span>
<span class="cm"> *	   Sven Luther, &lt;luther@dpt-info.u-strasbg.fr&gt;</span>
<span class="cm"> *	   Alan Hourihane, &lt;alanh@fairlite.demon.co.uk&gt;</span>
<span class="cm"> *	   Russell King, &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *  Based on linux/drivers/video/skeletonfb.c:</span>
<span class="cm"> *	Copyright (C) 1997 Geert Uytterhoeven</span>
<span class="cm"> *  Based on linux/driver/video/pm2fb.c:</span>
<span class="cm"> *	Copyright (C) 1998-1999 Ilario Nardinocchi (nardinoc@CS.UniBO.IT)</span>
<span class="cm"> *	Copyright (C) 1999 Jakub Jelinek (jakub@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;video/pm3fb.h&gt;</span>

<span class="cp">#if !defined(CONFIG_PCI)</span>
<span class="cp">#error &quot;Only generic PCI cards supported.&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#undef PM3FB_MASTER_DEBUG</span>
<span class="cp">#ifdef PM3FB_MASTER_DEBUG</span>
<span class="cp">#define DPRINTK(a, b...)	\</span>
<span class="cp">	printk(KERN_DEBUG &quot;pm3fb: %s: &quot; a, __func__ , ## b)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(a, b...)</span>
<span class="cp">#endif</span>

<span class="cp">#define PM3_PIXMAP_SIZE	(2048 * 4)</span>

<span class="cm">/*</span>
<span class="cm"> * Driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwcursor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">noaccel</span> <span class="n">__devinitdata</span><span class="p">;</span>

<span class="cm">/* mtrr option */</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nomtrr</span> <span class="n">__devinitdata</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This structure defines the hardware state of the graphics card. Normally</span>
<span class="cm"> * you place this in a header file in linux/include/video. This file usually</span>
<span class="cm"> * also includes register information. That allows other driver subsystems</span>
<span class="cm"> * and userland applications the ability to use the same header file to</span>
<span class="cm"> * avoid duplicate work and easy porting of software.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pm3_par</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">v_regs</span><span class="p">;</span><span class="cm">/* virtual address of p_regs */</span>
	<span class="n">u32</span>		<span class="n">video</span><span class="p">;</span>		<span class="cm">/* video flags before blanking */</span>
	<span class="n">u32</span>		<span class="n">base</span><span class="p">;</span>		<span class="cm">/* screen base in 128 bits unit */</span>
	<span class="n">u32</span>		<span class="n">palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span>		<span class="n">mtrr_handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Here we define the default structs fb_fix_screeninfo and fb_var_screeninfo</span>
<span class="cm"> * if we don&#39;t use modedb. If we do use modedb see pm3fb_init how to use it</span>
<span class="cm"> * to get a fb_var_screeninfo. Otherwise define a default var as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">pm3fb_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span>		<span class="s">&quot;Permedia3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span>		<span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span> <span class="o">=</span>	<span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> <span class="o">=</span>	<span class="n">FB_ACCEL_3DLABS_PERMEDIA3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Utility functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">PM3_READ_REG</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">s32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fb_readl</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">PM3_WRITE_REG</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">s32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fb_writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">PM3_WAIT</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">PM3_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3InFIFOSpace</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">r</span><span class="p">,</span> <span class="n">u8</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_IndexHigh</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_IndexLow</span><span class="p">,</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_IndexedData</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pm3fb_set_color</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regno</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PaletteWriteAddress</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PaletteData</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PaletteData</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PaletteData</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3fb_clear_colormap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pm3fb_set_color</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Calculating various clock parameters */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3fb_calculate_clock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reqclock</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prescale</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">feedback</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">postscale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">freqerr</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">currerr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pre</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pre</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">pre</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">post</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">post</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">post</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">freq</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">PM3_REF_CLOCK</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">post</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre</span><span class="p">;</span>
				<span class="n">currerr</span> <span class="o">=</span> <span class="p">(</span><span class="n">reqclock</span> <span class="o">&gt;</span> <span class="n">freq</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">reqclock</span> <span class="o">-</span> <span class="n">freq</span>
					<span class="o">:</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">reqclock</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currerr</span> <span class="o">&lt;</span> <span class="n">freqerr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">freqerr</span> <span class="o">=</span> <span class="n">currerr</span><span class="p">;</span>
					<span class="o">*</span><span class="n">feedback</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
					<span class="o">*</span><span class="n">prescale</span> <span class="o">=</span> <span class="n">pre</span><span class="p">;</span>
					<span class="o">*</span><span class="n">postscale</span> <span class="o">=</span> <span class="n">post</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pm3fb_depth</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>
			<span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pm3fb_shift_bpp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Unsupported depth %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* acceleration */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3fb_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FilterMode</span><span class="p">,</span> <span class="n">PM3FilterModeSync</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Sync</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">PM3_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3OutFIFOWords</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">PM3_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3OutputFifo</span><span class="p">))</span> <span class="o">!=</span> <span class="n">PM3Sync_Tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3fb_init_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FilterMode</span><span class="p">,</span> <span class="n">PM3FilterModeSync</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3StatisticMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3DeltaMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RasterizerMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScissorMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3LineStippleMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3AreaStippleMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3GIDMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3DepthMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3StencilMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3StencilData</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ColorDDAMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureCoordMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureIndexMode0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureIndexMode1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureReadMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3LUTMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureFilterMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureCompositeMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureApplicationMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureCompositeColorMode1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureCompositeAlphaMode1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureCompositeColorMode0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3TextureCompositeAlphaMode0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FogMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ChromaTestMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3AlphaTestMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3AntialiasMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3YUVMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3AlphaBlendColorMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3AlphaBlendAlphaMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3DitherMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3LogicalOpMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RouterMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Window</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Config2D</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3SpanColorMask</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3XBias</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3YBias</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3DeltaControl</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3BitMaskPattern</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBDestReadEnables</span><span class="p">,</span>
			   <span class="n">PM3FBDestReadEnables_E</span><span class="p">(</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">PM3FBDestReadEnables_R</span><span class="p">(</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">PM3FBDestReadEnables_ReferenceAlpha</span><span class="p">(</span><span class="mh">0xff</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBDestReadBufferAddr0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBDestReadBufferOffset0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBDestReadBufferWidth0</span><span class="p">,</span>
			   <span class="n">PM3FBDestReadBufferWidth_Width</span><span class="p">(</span><span class="n">width</span><span class="p">));</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBDestReadMode</span><span class="p">,</span>
			   <span class="n">PM3FBDestReadMode_ReadEnable</span> <span class="o">|</span>
			   <span class="n">PM3FBDestReadMode_Enable0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBSourceReadBufferAddr</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBSourceReadBufferOffset</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBSourceReadBufferWidth</span><span class="p">,</span>
			   <span class="n">PM3FBSourceReadBufferWidth_Width</span><span class="p">(</span><span class="n">width</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBSourceReadMode</span><span class="p">,</span>
			   <span class="n">PM3FBSourceReadMode_Blocking</span> <span class="o">|</span>
			   <span class="n">PM3FBSourceReadMode_ReadEnable</span><span class="p">);</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="cm">/* invert bits in bitmask */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3PixelSize</span><span class="p">,</span>
					   <span class="n">PM3PixelSize_GLOBAL_8BIT</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
			<span class="n">rm</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3PixelSize</span><span class="p">,</span>
					   <span class="n">PM3PixelSize_GLOBAL_16BIT</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
			<span class="n">rm</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3PixelSize</span><span class="p">,</span>
					   <span class="n">PM3PixelSize_GLOBAL_32BIT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RasterizerMode</span><span class="p">,</span> <span class="n">rm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBSoftwareWriteMask</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBHardwareWriteMask</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBWriteMode</span><span class="p">,</span>
			   <span class="n">PM3FBWriteMode_WriteEnable</span> <span class="o">|</span>
			   <span class="n">PM3FBWriteMode_OpaqueSpan</span> <span class="o">|</span>
			   <span class="n">PM3FBWriteMode_Enable0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBWriteBufferAddr0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBWriteBufferOffset0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBWriteBufferWidth0</span><span class="p">,</span>
			   <span class="n">PM3FBWriteBufferWidth_Width</span><span class="p">(</span><span class="n">width</span><span class="p">));</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3SizeOfFramebuffer</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="cm">/* size in lines of FB */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sofb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">/</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sofb</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span>
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3SizeOfFramebuffer</span><span class="p">,</span> <span class="mi">4095</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3SizeOfFramebuffer</span><span class="p">,</span> <span class="n">sofb</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3DitherMode</span><span class="p">,</span>
					   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3DitherMode</span><span class="p">,</span>
					   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3DitherMode</span><span class="p">,</span>
					   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unsupported depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">current_par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3dXDom</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3dXSub</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3dY</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3StartXDom</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3StartXSub</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3StartY</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Count</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

<span class="cm">/* Disable LocalBuffer. better safe than sorry */</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3LBDestReadMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3LBDestReadEnables</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3LBSourceReadMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3LBWriteMode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">pm3fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3fb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">region</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="n">modded</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">]</span> <span class="o">:</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">region</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span> <span class="p">)</span>
		<span class="n">rop</span> <span class="o">=</span> <span class="n">PM3Config2D_ForegroundROP</span><span class="p">(</span><span class="mh">0x3</span><span class="p">);</span> <span class="cm">/* GXcopy */</span>
	<span class="k">else</span>
		<span class="n">rop</span> <span class="o">=</span> <span class="n">PM3Config2D_ForegroundROP</span><span class="p">(</span><span class="mh">0x6</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* GXxor */</span>
			<span class="n">PM3Config2D_FBDestReadEnable</span><span class="p">;</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modded</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fillrect</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span>  <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">color</span> <span class="o">|=</span> <span class="n">color</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">color</span> <span class="o">|=</span> <span class="n">color</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* ROP Ox3 is GXcopy */</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Config2D</span><span class="p">,</span>
			<span class="n">PM3Config2D_UseConstantSource</span> <span class="o">|</span>
			<span class="n">PM3Config2D_ForegroundROPEnable</span> <span class="o">|</span>
			<span class="n">rop</span> <span class="o">|</span>
			<span class="n">PM3Config2D_FBWriteEnable</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ForegroundColor</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RectanglePosition</span><span class="p">,</span>
			<span class="n">PM3RectanglePosition_XOffset</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3RectanglePosition_YOffset</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">));</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Render2D</span><span class="p">,</span>
		      <span class="n">PM3Render2D_XPositive</span> <span class="o">|</span>
		      <span class="n">PM3Render2D_YPositive</span> <span class="o">|</span>
		      <span class="n">PM3Render2D_Operation_Normal</span> <span class="o">|</span>
		      <span class="n">PM3Render2D_SpanOperation</span> <span class="o">|</span>
		      <span class="n">PM3Render2D_Width</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">PM3Render2D_Height</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3fb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="n">modded</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vxres</span><span class="p">,</span> <span class="n">vyres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x_align</span><span class="p">,</span> <span class="n">o_x</span><span class="p">,</span> <span class="n">o_y</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modded</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_copyarea</span><span class="p">));</span>

	<span class="n">vxres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">vyres</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">&gt;=</span> <span class="n">vyres</span> <span class="o">||</span>
	    <span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">vxres</span> <span class="o">||</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">sx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">vxres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vxres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">vyres</span><span class="p">)</span>
		<span class="n">modded</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vyres</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>

	<span class="n">o_x</span> <span class="o">=</span> <span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>	<span class="cm">/*(sx &gt; dx ) ? (sx - dx) : (dx - sx); */</span>
	<span class="n">o_y</span> <span class="o">=</span> <span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">-</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>	<span class="cm">/*(sy &gt; dy ) ? (sy - dy) : (dy - sy); */</span>

	<span class="n">x_align</span> <span class="o">=</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Config2D</span><span class="p">,</span>
			<span class="n">PM3Config2D_UserScissorEnable</span> <span class="o">|</span>
			<span class="n">PM3Config2D_ForegroundROPEnable</span> <span class="o">|</span>
			<span class="n">PM3Config2D_Blocking</span> <span class="o">|</span>
			<span class="n">PM3Config2D_ForegroundROP</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* Ox3 is GXcopy */</span>
			<span class="n">PM3Config2D_FBWriteEnable</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScissorMinXY</span><span class="p">,</span>
			<span class="p">((</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScissorMaxXY</span><span class="p">,</span>
			<span class="p">(((</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">+</span> <span class="n">modded</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FBSourceReadBufferOffset</span><span class="p">,</span>
			<span class="n">PM3FBSourceReadBufferOffset_XOffset</span><span class="p">(</span><span class="n">o_x</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3FBSourceReadBufferOffset_YOffset</span><span class="p">(</span><span class="n">o_y</span><span class="p">));</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RectanglePosition</span><span class="p">,</span>
			<span class="n">PM3RectanglePosition_XOffset</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dx</span> <span class="o">-</span> <span class="n">x_align</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3RectanglePosition_YOffset</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">));</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Render2D</span><span class="p">,</span>
			<span class="p">((</span><span class="n">modded</span><span class="p">.</span><span class="n">sx</span> <span class="o">&gt;</span> <span class="n">modded</span><span class="p">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">?</span> <span class="n">PM3Render2D_XPositive</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">modded</span><span class="p">.</span><span class="n">sy</span> <span class="o">&gt;</span> <span class="n">modded</span><span class="p">.</span><span class="n">dy</span><span class="p">)</span> <span class="o">?</span> <span class="n">PM3Render2D_YPositive</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3Render2D_Operation_Normal</span> <span class="o">|</span>
			<span class="n">PM3Render2D_SpanOperation</span> <span class="o">|</span>
			<span class="n">PM3Render2D_FBSourceReadEnable</span> <span class="o">|</span>
			<span class="n">PM3Render2D_Width</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">x_align</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3Render2D_Height</span><span class="p">(</span><span class="n">modded</span><span class="p">.</span><span class="n">height</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3fb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fgx</span><span class="p">,</span> <span class="n">bgx</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="n">fgx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">bgx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
	<span class="nl">default:</span>
		<span class="n">fgx</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">];</span>
		<span class="n">bgx</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fgx</span> <span class="o">|=</span> <span class="n">fgx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bgx</span> <span class="o">|=</span> <span class="n">bgx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fgx</span> <span class="o">|=</span> <span class="n">fgx</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">bgx</span> <span class="o">|=</span> <span class="n">bgx</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ForegroundColor</span><span class="p">,</span> <span class="n">fgx</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3BackgroundColor</span><span class="p">,</span> <span class="n">bgx</span><span class="p">);</span>

	<span class="cm">/* ROP Ox3 is GXcopy */</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Config2D</span><span class="p">,</span>
			<span class="n">PM3Config2D_UserScissorEnable</span> <span class="o">|</span>
			<span class="n">PM3Config2D_UseConstantSource</span> <span class="o">|</span>
			<span class="n">PM3Config2D_ForegroundROPEnable</span> <span class="o">|</span>
			<span class="n">PM3Config2D_ForegroundROP</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3Config2D_OpaqueSpan</span> <span class="o">|</span>
			<span class="n">PM3Config2D_FBWriteEnable</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScissorMinXY</span><span class="p">,</span>
			<span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScissorMaxXY</span><span class="p">,</span>
			<span class="p">(((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RectanglePosition</span><span class="p">,</span>
			<span class="n">PM3RectanglePosition_XOffset</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3RectanglePosition_YOffset</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Render2D</span><span class="p">,</span>
			<span class="n">PM3Render2D_XPositive</span> <span class="o">|</span>
			<span class="n">PM3Render2D_YPositive</span> <span class="o">|</span>
			<span class="n">PM3Render2D_Operation_SyncOnBitMask</span> <span class="o">|</span>
			<span class="n">PM3Render2D_SpanOperation</span> <span class="o">|</span>
			<span class="n">PM3Render2D_Width</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PM3Render2D_Height</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">));</span>


	<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">PM3_FIFO_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">PM3_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3_FIFO_SIZE</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3BitMaskPattern</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
				<span class="n">src</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">width</span> <span class="o">-=</span> <span class="n">PM3_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">width</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3BitMaskPattern</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* end of acceleration functions */</span>

<span class="cm">/*</span>
<span class="cm"> *	Hardware Cursor support.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x55</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3fb_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_cursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwcursor</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* just to force soft_cursor() call */</span>

	<span class="cm">/* Too large of a cursor or wrong bpp :-( */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
	    <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span>
	    <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">PM3RD_CursorMode_TYPE_X</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		 <span class="n">mode</span> <span class="o">|=</span> <span class="n">PM3RD_CursorMode_CURSOR_ENABLE</span><span class="p">;</span>

	<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorMode</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the cursor is not be changed this means either we want the</span>
<span class="cm">	 * current cursor state (if enable is set) or we want to query what</span>
<span class="cm">	 * we can do with the cursor (if enable is not set)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETPOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dx</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">dy</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span><span class="p">;</span>

		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorXLow</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorXHigh</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorYLow</span><span class="p">,</span> <span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorYHigh</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorHotSpotX</span><span class="p">,</span>
				  <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">hot</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorHotSpotY</span><span class="p">,</span>
				  <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">hot</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">FB_CUR_SETCMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">fg_color</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bg_idx</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">bg_color</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fb_cmap</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">;</span>

		<span class="cm">/* the X11 driver says one should use these color registers */</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorPalette</span><span class="p">(</span><span class="mi">39</span><span class="p">),</span>
				  <span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorPalette</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
				  <span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorPalette</span><span class="p">(</span><span class="mi">41</span><span class="p">),</span>
				  <span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">fg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>

		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorPalette</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span>
				  <span class="n">cmap</span><span class="p">.</span><span class="n">red</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorPalette</span><span class="p">(</span><span class="mi">43</span><span class="p">),</span>
				  <span class="n">cmap</span><span class="p">.</span><span class="n">green</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorPalette</span><span class="p">(</span><span class="mi">44</span><span class="p">),</span>
				  <span class="n">cmap</span><span class="p">.</span><span class="n">blue</span><span class="p">[</span><span class="n">bg_idx</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FB_CUR_SETSHAPE</span> <span class="o">|</span> <span class="n">FB_CUR_SETIMAGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">PM3RD_CursorPattern</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">^</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">rop</span> <span class="o">==</span> <span class="n">ROP_COPY</span><span class="p">)</span>
					<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
				<span class="cm">/* Upper 4 bits of bitmap data */</span>
				<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span>
					<span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="o">*</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
				<span class="cm">/* Lower 4 bits of bitmap */</span>
				<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span>
					<span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cursor_bits_lookup</span><span class="p">[</span><span class="o">*</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">bitmap</span><span class="o">++</span><span class="p">;</span>
				<span class="n">mask</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">PM3RD_CursorPattern</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
			<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">pos</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write the mode to registers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm3fb_write_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tempsync</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tempmisc</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">hsstart</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">hsend</span> <span class="o">=</span> <span class="n">hsstart</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">hbend</span> <span class="o">=</span> <span class="n">hsend</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">htotal</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">hbend</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">vsstart</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">vsend</span> <span class="o">=</span> <span class="n">vsstart</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">vbend</span> <span class="o">=</span> <span class="n">vsend</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">vtotal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">+</span> <span class="n">vbend</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3MemBypassWriteMask</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Aperture0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3Aperture1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3FIFODis</span><span class="p">,</span> <span class="mh">0x00000007</span><span class="p">);</span>

	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3HTotal</span><span class="p">,</span>
			   <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3HsEnd</span><span class="p">,</span>
			   <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">hsend</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3HsStart</span><span class="p">,</span>
			   <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">hsstart</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3HbEnd</span><span class="p">,</span>
			   <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">hbend</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3HgEnd</span><span class="p">,</span>
			   <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">hbend</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScreenStride</span><span class="p">,</span>
			   <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">width</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VTotal</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VsEnd</span><span class="p">,</span> <span class="n">vsend</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VsStart</span><span class="p">,</span> <span class="n">vsstart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VbEnd</span><span class="p">,</span> <span class="n">vbend</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture1Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_8BIT</span><span class="p">);</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture2Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_8BIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
<span class="cp">#ifndef __BIG_ENDIAN</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture1Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_16BIT</span><span class="p">);</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture2Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_16BIT</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture1Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_16BIT</span> <span class="o">|</span>
				   <span class="n">PM3ByApertureMode_BYTESWAP_BADC</span><span class="p">);</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture2Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_16BIT</span> <span class="o">|</span>
				   <span class="n">PM3ByApertureMode_BYTESWAP_BADC</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* ! __BIG_ENDIAN */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">32</span>:
<span class="cp">#ifndef __BIG_ENDIAN</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture1Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_32BIT</span><span class="p">);</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture2Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_32BIT</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture1Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_32BIT</span> <span class="o">|</span>
				   <span class="n">PM3ByApertureMode_BYTESWAP_DCBA</span><span class="p">);</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ByAperture2Mode</span><span class="p">,</span>
				   <span class="n">PM3ByApertureMode_PIXELSIZE_32BIT</span> <span class="o">|</span>
				   <span class="n">PM3ByApertureMode_BYTESWAP_DCBA</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* ! __BIG_ENDIAN */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Unsupported depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Oxygen VX1 - it appears that setting PM3VideoControl and</span>
<span class="cm">	 * then PM3RD_SyncControl to the same SYNC settings undoes</span>
<span class="cm">	 * any net change - they seem to xor together.  Only set the</span>
<span class="cm">	 * sync options in PM3RD_SyncControl.  --rmk</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">video</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>

		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM3VideoControl_HSYNC_MASK</span> <span class="o">|</span>
			   <span class="n">PM3VideoControl_VSYNC_MASK</span><span class="p">);</span>
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span>
			 <span class="n">PM3VideoControl_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VideoControl</span><span class="p">,</span> <span class="n">video</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VClkCtl</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">PM3_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VClkCtl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFC</span><span class="p">));</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScreenBase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ChipConfig</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">PM3_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ChipConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFD</span><span class="p">));</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>	<span class="cm">/* ClkPreScale */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>	<span class="cm">/* ClkFeedBackScale */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>	<span class="cm">/* ClkPostScale */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">);</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pm3fb_calculate_clock</span><span class="p">(</span><span class="n">pixclock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Pixclock: %ld, Pre: %d, Feedback: %d, Post: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pixclock</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">p</span><span class="p">);</span>

		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_DClk0PreScale</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_DClk0FeedbackScale</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_DClk0PostScale</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   PM3_WRITE_DAC_REG(par, PM3RD_IndexControl, 0x00);</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	   PM3_SLOW_WRITE_REG(par, PM3RD_IndexControl, 0x00);</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">&amp;</span> <span class="n">PM3VideoControl_HSYNC_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">PM3VideoControl_HSYNC_ACTIVE_HIGH</span><span class="p">)</span>
		<span class="n">tempsync</span> <span class="o">|=</span> <span class="n">PM3RD_SyncControl_HSYNC_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">&amp;</span> <span class="n">PM3VideoControl_VSYNC_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">PM3VideoControl_VSYNC_ACTIVE_HIGH</span><span class="p">)</span>
		<span class="n">tempsync</span> <span class="o">|=</span> <span class="n">PM3RD_SyncControl_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>

	<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_SyncControl</span><span class="p">,</span> <span class="n">tempsync</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;PM3RD_SyncControl: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempsync</span><span class="p">);</span>

	<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_DACControl</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pm3fb_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PixelSize</span><span class="p">,</span>
				  <span class="n">PM3RD_PixelSize_8_BIT_PIXELS</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_ColorFormat</span><span class="p">,</span>
				  <span class="n">PM3RD_ColorFormat_CI8_COLOR</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_COLOR_ORDER_BLUE_LOW</span><span class="p">);</span>
		<span class="n">tempmisc</span> <span class="o">|=</span> <span class="n">PM3RD_MiscControl_HIGHCOLOR_RES_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PixelSize</span><span class="p">,</span>
				  <span class="n">PM3RD_PixelSize_16_BIT_PIXELS</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_ColorFormat</span><span class="p">,</span>
				  <span class="n">PM3RD_ColorFormat_4444_COLOR</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_COLOR_ORDER_BLUE_LOW</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_LINEAR_COLOR_EXT_ENABLE</span><span class="p">);</span>
		<span class="n">tempmisc</span> <span class="o">|=</span> <span class="n">PM3RD_MiscControl_DIRECTCOLOR_ENABLE</span> <span class="o">|</span>
			<span class="n">PM3RD_MiscControl_HIGHCOLOR_RES_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PixelSize</span><span class="p">,</span>
				  <span class="n">PM3RD_PixelSize_16_BIT_PIXELS</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_ColorFormat</span><span class="p">,</span>
				  <span class="n">PM3RD_ColorFormat_5551_FRONT_COLOR</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_COLOR_ORDER_BLUE_LOW</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_LINEAR_COLOR_EXT_ENABLE</span><span class="p">);</span>
		<span class="n">tempmisc</span> <span class="o">|=</span> <span class="n">PM3RD_MiscControl_DIRECTCOLOR_ENABLE</span> <span class="o">|</span>
			<span class="n">PM3RD_MiscControl_HIGHCOLOR_RES_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PixelSize</span><span class="p">,</span>
				  <span class="n">PM3RD_PixelSize_16_BIT_PIXELS</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_ColorFormat</span><span class="p">,</span>
				  <span class="n">PM3RD_ColorFormat_565_FRONT_COLOR</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_COLOR_ORDER_BLUE_LOW</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_LINEAR_COLOR_EXT_ENABLE</span><span class="p">);</span>
		<span class="n">tempmisc</span> <span class="o">|=</span> <span class="n">PM3RD_MiscControl_DIRECTCOLOR_ENABLE</span> <span class="o">|</span>
			<span class="n">PM3RD_MiscControl_HIGHCOLOR_RES_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_PixelSize</span><span class="p">,</span>
				  <span class="n">PM3RD_PixelSize_32_BIT_PIXELS</span><span class="p">);</span>
		<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_ColorFormat</span><span class="p">,</span>
				  <span class="n">PM3RD_ColorFormat_8888_COLOR</span> <span class="o">|</span>
				  <span class="n">PM3RD_ColorFormat_COLOR_ORDER_BLUE_LOW</span><span class="p">);</span>
		<span class="n">tempmisc</span> <span class="o">|=</span> <span class="n">PM3RD_MiscControl_DIRECTCOLOR_ENABLE</span> <span class="o">|</span>
			<span class="n">PM3RD_MiscControl_HIGHCOLOR_RES_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_MiscControl</span><span class="p">,</span> <span class="n">tempmisc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * hardware independent functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lpitch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>
			<span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set predefined mode for bits_per_pixel settings */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;depth not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* it is assumed BGRA order */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">!=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;virtual x resolution != &quot;</span>
			<span class="s">&quot;physical x resolution not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;virtual y resolution &lt; &quot;</span>
			<span class="s">&quot;physical y resolution not possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;xoffset not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;interlace not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span> <span class="cm">/* could sometimes be 8 */</span>
	<span class="n">lpitch</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;width not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">4095</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;height not supported: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpitch</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;no memory for screen (%ux%ux%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PM3_MAX_PIXCLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pixclock too high (%ldKHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t mmap if this is on */</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Checking graphics mode at %dx%d depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">xres</span><span class="p">)</span>
					<span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_HSYNC_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_HSYNC_ACTIVE_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_VSYNC_ACTIVE_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_LINE_DOUBLE_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;PM3Video disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_PIXELSIZE_8BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_PIXELSIZE_16BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_PIXELSIZE_32BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Unsupported depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span>  <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">;</span>

<span class="cm">/*	pm3fb_clear_memory(info, 0);*/</span>
	<span class="n">pm3fb_clear_colormap</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">PM3_WRITE_DAC_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3RD_CursorMode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm3fb_init_engine</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">pm3fb_write_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span>  <span class="cm">/* no. of hw registers */</span>
	   <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* grayscale works only partially under directcolor */</span>
	<span class="cm">/* grayscale = 0.30*R + 0.59*G + 0.11*B */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
	   <span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">77</span> <span class="o">+</span> <span class="n">green</span> <span class="o">*</span> <span class="mi">151</span> <span class="o">+</span> <span class="n">blue</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Directcolor:</span>
<span class="cm">	 *   var-&gt;{color}.offset contains start of bitfield</span>
<span class="cm">	 *   var-&gt;{color}.length contains length of bitfield</span>
<span class="cm">	 *   {hardwarespecific} contains width of DAC</span>
<span class="cm">	 *   pseudo_palette[X] is programmed to (X &lt;&lt; red.offset) |</span>
<span class="cm">	 *					(X &lt;&lt; green.offset) |</span>
<span class="cm">	 *					(X &lt;&lt; blue.offset)</span>
<span class="cm">	 *   RAMDAC[X] is programmed to (red, green, blue)</span>
<span class="cm">	 *   color depth = SUM(var-&gt;{color}.length)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Pseudocolor:</span>
<span class="cm">	 *	var-&gt;{color}.offset is 0</span>
<span class="cm">	 *	var-&gt;{color}.length contains width of DAC or the number</span>
<span class="cm">	 *			of unique colors available (color depth)</span>
<span class="cm">	 *	pseudo_palette is not used</span>
<span class="cm">	 *	RAMDAC[X] is programmed to (red, green, blue)</span>
<span class="cm">	 *	color depth = var-&gt;{color}.length</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is the point where the color is converted to something that</span>
<span class="cm">	 * is acceptable by the hardware.</span>
<span class="cm">	 */</span>
<span class="cp">#define CNVT_TOHW(val, width) ((((val) &lt;&lt; (width)) + 0x7FFF - (val)) &gt;&gt; 16)</span>
	<span class="n">red</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">green</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">blue</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">transp</span> <span class="o">=</span> <span class="n">CNVT_TOHW</span><span class="p">(</span><span class="n">transp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
<span class="cp">#undef CNVT_TOHW</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span> <span class="o">||</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">))[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">)</span>
		<span class="n">pm3fb_set_color</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pm3fb_shift_bpp</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span>
					<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">xres</span><span class="p">)</span>
					<span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">);</span>
	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3ScreenBase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm3fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">video</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Oxygen VX1 - it appears that setting PM3VideoControl and</span>
<span class="cm">	 * then PM3RD_SyncControl to the same SYNC settings undoes</span>
<span class="cm">	 * any net change - they seem to xor together.  Only set the</span>
<span class="cm">	 * sync options in PM3RD_SyncControl.  --rmk</span>
<span class="cm">	 */</span>
	<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM3VideoControl_HSYNC_MASK</span> <span class="o">|</span>
		   <span class="n">PM3VideoControl_VSYNC_MASK</span><span class="p">);</span>
	<span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span>
		 <span class="n">PM3VideoControl_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">video</span> <span class="o">|=</span> <span class="n">PM3VideoControl_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM3VideoControl_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM3VideoControl_HSYNC_MASK</span> <span class="o">|</span>
			  <span class="n">PM3VideoControl_BLANK_ACTIVE_LOW</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM3VideoControl_VSYNC_MASK</span> <span class="o">|</span>
			  <span class="n">PM3VideoControl_BLANK_ACTIVE_LOW</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">video</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PM3VideoControl_HSYNC_MASK</span> <span class="o">|</span>
			  <span class="n">PM3VideoControl_VSYNC_MASK</span> <span class="o">|</span>
			  <span class="n">PM3VideoControl_BLANK_ACTIVE_LOW</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Unsupported blanking %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VideoControl</span><span class="p">,</span> <span class="n">video</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Frame buffer operations</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">pm3fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">pm3fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">pm3fb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">pm3fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">pm3fb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">pm3fb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">pm3fb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">pm3fb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">pm3fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>	<span class="o">=</span> <span class="n">pm3fb_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_cursor</span>	<span class="o">=</span> <span class="n">pm3fb_cursor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Initialization</span>
<span class="cm">	 */</span>

<span class="cm">/* mmio register are already mapped when this function is called */</span>
<span class="cm">/* the pm3fb_fix.smem_start is also set */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__devinit</span> <span class="nf">pm3fb_size_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">memsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">tempBypass</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">screen_mem</span><span class="p">;</span>

	<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024l</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span> <span class="cm">/* request full aperture size */</span>
	<span class="cm">/* Linear frame buffer - request region and map it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				 <span class="s">&quot;pm3fb smem&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t reserve smem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">screen_mem</span> <span class="o">=</span>
		<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">screen_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t ioremap smem area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: card-specific stuff, *before* accessing *any* FB memory */</span>
	<span class="cm">/* For Appian Jeronimo 2000 board second head */</span>

	<span class="n">tempBypass</span> <span class="o">=</span> <span class="n">PM3_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3MemBypassWriteMask</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;PM3MemBypassWriteMask was: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tempBypass</span><span class="p">);</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3MemBypassWriteMask</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="cm">/* pm3 split up memory, replicates, and do a lot of</span>
<span class="cm">	 * nasty stuff IMHO ;-)</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_writel</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x00345678</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">screen_mem</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">)));</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">temp1</span> <span class="o">=</span> <span class="n">fb_readl</span><span class="p">((</span><span class="n">screen_mem</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">)));</span>

		<span class="cm">/* Let&#39;s check for wrapover, write will fail at 16MB boundary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x00345678</span><span class="p">))</span>
			<span class="n">memsize</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;First detect pass already got %ld MB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memsize</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Clear first 32MB ; 0 is 0, no need to byteswap */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000000</span><span class="p">,</span> <span class="p">(</span><span class="n">screen_mem</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fb_writel</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x00345678</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">screen_mem</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">)));</span>
			<span class="n">mb</span><span class="p">();</span>
			<span class="n">temp1</span> <span class="o">=</span>
			    <span class="n">fb_readl</span><span class="p">((</span><span class="n">screen_mem</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">)));</span>
			<span class="n">temp2</span> <span class="o">=</span>
			    <span class="n">fb_readl</span><span class="p">((</span><span class="n">screen_mem</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">)));</span>
			<span class="cm">/* different value, different RAM... */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp1</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x00345678</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">memsize</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Second detect pass got %ld MB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">PM3_WAIT</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">PM3_WRITE_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3MemBypassWriteMask</span><span class="p">,</span> <span class="n">tempBypass</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">screen_mem</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="n">memsize</span> <span class="o">=</span> <span class="mi">1048576</span> <span class="o">*</span> <span class="p">(</span><span class="n">memsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Returning 0x%08lx bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memsize</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">memsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pm3fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span> <span class="cm">/* for pci drivers */</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t enable PCI dev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Dynamically allocate info and par</span>
<span class="cm">	 */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm3_par</span><span class="p">),</span> <span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Here we set the screen_base to the virtual memory address</span>
<span class="cm">	 * for the framebuffer.</span>
<span class="cm">	 */</span>
	<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="n">PM3_REGS_SIZE</span><span class="p">;</span>
<span class="cp">#if defined(__BIG_ENDIAN)</span>
	<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">+=</span> <span class="n">PM3_REGS_SIZE</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Adjusting register base for big-endian.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Registers - request region and map it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">,</span>
				 <span class="s">&quot;pm3fb regbase&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t reserve regbase.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_neither</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">v_regs</span> <span class="o">=</span>
		<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t remap %s register area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_neither</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Linear frame buffer - request region and map it. */</span>
	<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">pm3fb_size_memory</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t find memory on board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_mmio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				 <span class="s">&quot;pm3fb smem&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t reserve smem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_mmio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span>
		<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm3fb: Can&#39;t ioremap smem area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit_mmio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nomtrr</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
						<span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
						<span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm3fb_ops</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span> <span class="o">=</span> <span class="n">PM3_READ_REG</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">PM3VideoControl</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">pm3fb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span>
			<span class="n">FBINFO_HWACCEL_XPAN</span> <span class="o">|</span>
			<span class="n">FBINFO_HWACCEL_YPAN</span> <span class="o">|</span>
			<span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>
			<span class="n">FBINFO_HWACCEL_IMAGEBLIT</span> <span class="o">|</span>
			<span class="n">FBINFO_HWACCEL_FILLRECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">noaccel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;disabling acceleration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_DISABLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PM3_PIXMAP_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit_pixmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PM3_PIXMAP_SIZE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">buf_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">access_align</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FB_PIXMAP_SYSTEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This should give a reasonable default video mode. The following is</span>
<span class="cm">	 * done when we can set a video mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_option</span><span class="p">)</span>
		<span class="n">mode_option</span> <span class="o">=</span> <span class="s">&quot;640x480@60&quot;</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span> <span class="o">||</span> <span class="n">retval</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit_both</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit_both</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For drivers that can...</span>
<span class="cm">	 */</span>
	<span class="n">pm3fb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit_all</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
	   <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_exit_all:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
 <span class="nl">err_exit_both:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
 <span class="nl">err_exit_pixmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
 <span class="nl">err_exit_mmio:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">pm3fb_fix</span><span class="p">.</span><span class="n">mmio_len</span><span class="p">);</span>
 <span class="nl">err_exit_neither:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Cleanup</span>
<span class="cm">	 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pm3fb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pm3_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mtrr_handle</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
			 <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MTRR */</span><span class="cp"></span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">v_regs</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">fix</span><span class="o">-&gt;</span><span class="n">mmio_len</span><span class="p">);</span>

		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pm3fb_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3DLABS</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* For PCI drivers */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pm3fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;pm3fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">pm3fb_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">pm3fb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">pm3fb_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm3fb_id_table</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Setup</span>
<span class="cm">	 */</span>

<span class="cm">/*</span>
<span class="cm"> * Only necessary if your driver takes special options,</span>
<span class="cm"> * otherwise we fall back on the generic fb_setup().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pm3fb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="cm">/* Parse user specified options (`video=pm3fb:&#39;) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;noaccel&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">noaccel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;hwcursor=&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">hwcursor</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;nomtrr&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">nomtrr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">else</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pm3fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  For kernel boot options (in &#39;video=pm3fb:&lt;options&gt;&#39; format)</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;pm3fb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">pm3fb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm3fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pm3fb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm3fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">pm3fb_exit</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">pm3fb_init</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Initial video mode e.g. &#39;648x480-8@60&#39;&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noaccel</span><span class="p">,</span> <span class="s">&quot;Disable acceleration&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hwcursor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwcursor</span><span class="p">,</span> <span class="s">&quot;Enable hardware cursor &quot;</span>
			<span class="s">&quot;(1=enable, 0=disable, default=1)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nomtrr</span><span class="p">,</span> <span class="s">&quot;Disable MTRR support (0 or 1=disabled) (default=0)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Permedia3 framebuffer device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
