<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › intelfb › intelfbhw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>intelfbhw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * intelfb</span>
<span class="cm"> *</span>
<span class="cm"> * Linux framebuffer driver for Intel(R) 865G integrated graphics chips.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2002, 2003 David Dawes &lt;dawes@xfree86.org&gt;</span>
<span class="cm"> *                   2004 Sylvain Meyer</span>
<span class="cm"> *</span>
<span class="cm"> * This driver consists of two parts.  The first part (intelfbdrv.c) provides</span>
<span class="cm"> * the basic fbdev interfaces, is derived in part from the radeonfb and</span>
<span class="cm"> * vesafb drivers, and is covered by the GPL.  The second part (intelfbhw.c)</span>
<span class="cm"> * provides the code to program the hardware.  Most of it is derived from</span>
<span class="cm"> * the i810/i830 XFree86 driver.  The HW-specific code is covered here</span>
<span class="cm"> * under a dual license (GPL and MIT/XFree86 license).</span>
<span class="cm"> *</span>
<span class="cm"> * Author: David Dawes</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* $DHD: intelfb/intelfbhw.c,v 1.9 2003/06/27 15:06:25 dawes Exp $ */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;intelfb.h&quot;</span>
<span class="cp">#include &quot;intelfbhw.h&quot;</span>

<span class="k">struct</span> <span class="n">pll_min_max</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">min_m</span><span class="p">,</span> <span class="n">max_m</span><span class="p">,</span> <span class="n">min_m1</span><span class="p">,</span> <span class="n">max_m1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_m2</span><span class="p">,</span> <span class="n">max_m2</span><span class="p">,</span> <span class="n">min_n</span><span class="p">,</span> <span class="n">max_n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_p</span><span class="p">,</span> <span class="n">max_p</span><span class="p">,</span> <span class="n">min_p1</span><span class="p">,</span> <span class="n">max_p1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_vco</span><span class="p">,</span> <span class="n">max_vco</span><span class="p">,</span> <span class="n">p_transition_clk</span><span class="p">,</span> <span class="n">ref_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p_inc_lo</span><span class="p">,</span> <span class="n">p_inc_hi</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PLLS_I8xx 0</span>
<span class="cp">#define PLLS_I9xx 1</span>
<span class="cp">#define PLLS_MAX 2</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pll_min_max</span> <span class="n">plls</span><span class="p">[</span><span class="n">PLLS_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
	  <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
	  <span class="mi">4</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
	  <span class="mi">930000</span><span class="p">,</span> <span class="mi">1400000</span><span class="p">,</span> <span class="mi">165000</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span>
	  <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>		<span class="cm">/* I8xx */</span>

	<span class="p">{</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
	  <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	  <span class="mi">5</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
	  <span class="mi">1400000</span><span class="p">,</span> <span class="mi">2800000</span><span class="p">,</span> <span class="mi">200000</span><span class="p">,</span> <span class="mi">96000</span><span class="p">,</span>
	  <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span> <span class="p">}</span>		<span class="cm">/* I9xx */</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">intelfbhw_get_chipset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_830M</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 830M&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_830M</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I8xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_845G</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 845G&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_845G</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I8xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_854</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 854&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_854</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_85XGM</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I8xx</span><span class="p">;</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">INTEL_85X_CAPID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">INTEL_85X_VARIANT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">INTEL_85X_VARIANT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_VAR_855GME</span>:
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 855GME&quot;</span><span class="p">;</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_855GME</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_VAR_855GM</span>:
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 855GM&quot;</span><span class="p">;</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_855GM</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_VAR_852GME</span>:
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 852GME&quot;</span><span class="p">;</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_852GME</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_VAR_852GM</span>:
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 852GM&quot;</span><span class="p">;</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_852GM</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 852GM/855GM&quot;</span><span class="p">;</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_85XGM</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_865G</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 865G&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_865G</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I8xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_915G</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 915G&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_915G</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I9xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_915GM</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 915GM&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_915GM</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I9xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_945G</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 945G&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_945G</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I9xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_945GM</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 945GM&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_945GM</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I9xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_945GME</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 945GME&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_945GME</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I9xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_965G</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 965G&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_965G</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I9xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_965GM</span>:
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel(R) 965GM&quot;</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">INTEL_965GM</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span> <span class="o">=</span> <span class="n">PLLS_I9xx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intelfbhw_get_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">aperture_size</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="o">*</span><span class="n">stolen_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge_dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stolen_overhead</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">aperture_size</span> <span class="o">||</span> <span class="o">!</span><span class="n">stolen_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Find the bridge device.  It is always 0:0.0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bridge_dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">ERR_MSG</span><span class="p">(</span><span class="s">&quot;cannot find bridge device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the fb aperture size and &quot;stolen&quot; memory amount. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">INTEL_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">bridge_dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_915G</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_915GM</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_945G</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_945GM</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_945GME</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_965G</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_965GM</span>:
		<span class="cm">/* 915, 945 and 965 chipsets support a 256MB aperture.</span>
<span class="cm">		   Aperture size is determined by inspected the</span>
<span class="cm">		   base address of the aperture. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08000000</span><span class="p">)</span>
			<span class="o">*</span><span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">INTEL_GMCH_MEM_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">INTEL_GMCH_MEM_64M</span><span class="p">)</span>
			<span class="o">*</span><span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stolen memory size is reduced by the GTT and the popup.</span>
<span class="cm">	   GTT is 1K per MB of aperture size, and popup is 4K. */</span>
	<span class="n">stolen_overhead</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">aperture_size</span> <span class="o">/</span> <span class="n">MB</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_830M</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_845G</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">INTEL_830_GMCH_GMS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_830_GMCH_GMS_STOLEN_512</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_830_GMCH_GMS_STOLEN_1024</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_830_GMCH_GMS_STOLEN_8192</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_830_GMCH_GMS_LOCAL</span>:
			<span class="n">ERR_MSG</span><span class="p">(</span><span class="s">&quot;only local memory found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_830_GMCH_GMS_DISABLED</span>:
			<span class="n">ERR_MSG</span><span class="p">(</span><span class="s">&quot;video memory is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ERR_MSG</span><span class="p">(</span><span class="s">&quot;unexpected GMCH_GMS value: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">INTEL_830_GMCH_GMS_MASK</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">INTEL_855_GMCH_GMS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_855_GMCH_GMS_STOLEN_1M</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_855_GMCH_GMS_STOLEN_4M</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_855_GMCH_GMS_STOLEN_8M</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_855_GMCH_GMS_STOLEN_16M</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_855_GMCH_GMS_STOLEN_32M</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_915G_GMCH_GMS_STOLEN_48M</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_915G_GMCH_GMS_STOLEN_64M</span>:
			<span class="o">*</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="n">KB</span><span class="p">(</span><span class="n">stolen_overhead</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_855_GMCH_GMS_DISABLED</span>:
			<span class="n">ERR_MSG</span><span class="p">(</span><span class="s">&quot;video memory is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ERR_MSG</span><span class="p">(</span><span class="s">&quot;unexpected GMCH_GMS value: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">INTEL_855_GMCH_GMS_MASK</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intelfbhw_check_non_crt</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dvo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_ENABLE</span><span class="p">)</span>
		<span class="n">dvo</span> <span class="o">|=</span> <span class="n">LVDS_PORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">DVOA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_ENABLE</span><span class="p">)</span>
		<span class="n">dvo</span> <span class="o">|=</span> <span class="n">DVOA_PORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">DVOB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_ENABLE</span><span class="p">)</span>
		<span class="n">dvo</span> <span class="o">|=</span> <span class="n">DVOB_PORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INREG</span><span class="p">(</span><span class="n">DVOC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_ENABLE</span><span class="p">)</span>
		<span class="n">dvo</span> <span class="o">|=</span> <span class="n">DVOC_PORT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dvo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">intelfbhw_dvo_to_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">dvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvo</span> <span class="o">&amp;</span> <span class="n">DVOA_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;DVO port A&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dvo</span> <span class="o">&amp;</span> <span class="n">DVOB_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;DVO port B&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dvo</span> <span class="o">&amp;</span> <span class="n">DVOC_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;DVO port C&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dvo</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;LVDS port&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">intelfbhw_validate_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_validate_mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">bytes_per_pixel</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes_per_pixel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">bytes_per_pixel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Check if enough video memory. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;Not enough video ram for mode &quot;</span>
			<span class="s">&quot;(%d KByte vs %d KByte).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">BtoKB</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">BtoKB</span><span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">size</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if x/y limits are OK. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">HACTIVE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;X resolution too large (%d vs %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">HACTIVE_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">VACTIVE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;Y resolution too large (%d vs %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">VACTIVE_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;X resolution too small (%d vs 4).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;Y resolution too small (%d vs 4).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for doublescan modes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;Mode is double-scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;Odd number of lines in interlaced mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if clock is OK. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">MIN_CLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;Pixel clock is too low (%d MHz vs %d MHz).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">MIN_CLOCK</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">MAX_CLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;Pixel clock is too high (%d MHz vs %d MHz).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">MAX_CLOCK</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intelfbhw_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span> <span class="o">=</span> <span class="n">GET_DINFO</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_pan_display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">xoffset</span> <span class="o">=</span> <span class="n">ROUND_DOWN_TO</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">)</span> <span class="o">+</span>
		 <span class="p">(</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_VBL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">intelfbhw_enable_irq</span><span class="p">(</span><span class="n">dinfo</span><span class="p">))</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Blank the screen. */</span>
<span class="kt">void</span> <span class="nf">intelfbhw_do_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span> <span class="o">=</span> <span class="n">GET_DINFO</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_do_blank: blank is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Turn plane A on or off */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* Flush */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Turn off/on the HW cursor */</span>
<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;cursor_on is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor_on</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span>
			<span class="n">intelfbhw_cursor_hide</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">intelfbhw_cursor_show</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor_blanked</span> <span class="o">=</span> <span class="n">blank</span><span class="p">;</span>

	<span class="cm">/* Set DPMS level */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ADPA_DPMS_CONTROL_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADPA_DPMS_D0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADPA_DPMS_D1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADPA_DPMS_D2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADPA_DPMS_D3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Check which pipe is connected to an active display plane. */</span>
<span class="kt">int</span> <span class="nf">intelfbhw_active_pipe</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">intelfb_hwstate</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* keep old default behaviour - prefer PIPE_A */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_ctrl</span> <span class="o">&amp;</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_ctrl</span> <span class="o">&gt;&gt;</span> <span class="n">DISPPLANE_SEL_PIPE_SHIFT</span><span class="p">);</span>
		<span class="n">pipe</span> <span class="o">&amp;=</span> <span class="n">PIPE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PIPE_A</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">&amp;</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">&gt;&gt;</span> <span class="n">DISPPLANE_SEL_PIPE_SHIFT</span><span class="p">);</span>
		<span class="n">pipe</span> <span class="o">&amp;=</span> <span class="n">PIPE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_A</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PIPE_A</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Impossible that no pipe is selected - return PIPE_A */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">PIPE_A</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pipe</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_setcolreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">palette_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_A</span><span class="p">)</span> <span class="o">?</span>
			  <span class="n">PALETTE_A</span> <span class="o">:</span> <span class="n">PALETTE_B</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_setcolreg: %d: (%d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">palette_reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">PALETTE_8_RED_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">PALETTE_8_GREEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">PALETTE_8_BLUE_SHIFT</span><span class="p">));</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">intelfbhw_read_hw_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">intelfb_hwstate</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_read_hw_state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">dinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Read in as much of the HW state as possible. */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga0_divisor</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VGA0_DIVISOR</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga1_divisor</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VGA1_DIVISOR</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga_pd</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VGAPD</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DPLL_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DPLL_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa0</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FPA0</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa1</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FPA1</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb0</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FPB0</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb1</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FPB1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* This seems to be a problem with the 852GM/855GM */</span>
<span class="c">	for (i = 0; i &lt; PALETTE_8_ENTRIES; i++) {</span>
<span class="c">		hw-&gt;palette_a[i] = INREG(PALETTE_A + (i &lt;&lt; 2));</span>
<span class="c">		hw-&gt;palette_b[i] = INREG(PALETTE_B + (i &lt;&lt; 2));</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HTOTAL_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HBLANK_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HSYNC_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VTOTAL_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VBLANK_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VSYNC_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">SRC_SIZE_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bclrpat_a</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">BCLRPAT_A</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HTOTAL_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HBLANK_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">HSYNC_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VTOTAL_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VBLANK_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VSYNC_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">SRC_SIZE_B</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bclrpat_b</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">BCLRPAT_B</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoa</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOA</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvob</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOB</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoc</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOC</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoa_srcdim</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOA_SRCDIM</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvob_srcdim</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOB_SRCDIM</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoc_srcdim</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOC_SRCDIM</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">lvds</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">LVDS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_a_conf</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PIPEACONF</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_b_conf</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PIPEBCONF</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_arb</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DISPARB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_a_control</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_A_CONTROL</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_b_control</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_B_CONTROL</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_a_base</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_A_BASEADDR</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_b_base</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_B_BASEADDR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_a_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_A_PALETTE0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_b_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_B_PALETTE0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_size</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_ctrl</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPBCNTR</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_base</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_base</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPBBASE</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPASTRIDE</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_stride</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPBSTRIDE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vgacntrl</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">add_id</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADD_ID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">swf0x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">SWF00</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">swf1x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">SWF10</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">swf3x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">SWF30</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FENCE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">instpm</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_mode</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">MEM_MODE</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fw_blc_0</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FW_BLC_0</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fw_blc_1</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">FW_BLC_1</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hwstam</span> <span class="o">=</span> <span class="n">INREG16</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">INREG16</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">=</span> <span class="n">INREG16</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">imr</span> <span class="o">=</span> <span class="n">INREG16</span><span class="p">(</span><span class="n">IMR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_vclock3</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">plls</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ref_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">n</span> <span class="o">/</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_vclock</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p2</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">lvds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pll_min_max</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plls</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">vco</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">vco</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ref_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLLS_I8xx</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="n">p1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="n">p1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">10</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">vco</span> <span class="o">/</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if REGDUMP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intelfbhw_get_p1p2</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dpll</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">o_p1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">o_p2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I9XX</span><span class="p">(</span><span class="n">dinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_P1_FORCE_DIV2</span><span class="p">)</span>
			<span class="n">p1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&gt;&gt;</span> <span class="n">DPLL_P1_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">p1</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>

		<span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&gt;&gt;</span> <span class="n">DPLL_I9XX_P2_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPLL_P2_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_P1_FORCE_DIV2</span><span class="p">)</span>
			<span class="n">p1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&gt;&gt;</span> <span class="n">DPLL_P1_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPLL_P1_MASK</span><span class="p">;</span>
		<span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&gt;&gt;</span> <span class="n">DPLL_P2_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPLL_P2_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">o_p1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">o_p2</span> <span class="o">=</span> <span class="n">p2</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="kt">void</span> <span class="nf">intelfbhw_print_hw_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">intelfb_hwstate</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if REGDUMP</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span><span class="p">;</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_print_hw_state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Read in as much of the HW state as possible. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hw state dump start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGA0_DIVISOR:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga0_divisor</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGA1_DIVISOR:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga1_divisor</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGAPD:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga_pd</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga0_divisor</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga0_divisor</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M1_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga0_divisor</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>

	<span class="n">intelfbhw_get_p1p2</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGA0: (m1, m2, n, p1, p2) = (%d, %d, %d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGA0: clock is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">calc_vclock</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga1_divisor</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga1_divisor</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M1_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga1_divisor</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>

	<span class="n">intelfbhw_get_p1p2</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vga_pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGA1: (m1, m2, n, p1, p2) = (%d, %d, %d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGA1: clock is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">calc_vclock</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DPLL_A:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DPLL_B:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	FPA0:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	FPA1:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	FPB0:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	FPB1:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb1</span><span class="p">);</span>

	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa0</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa0</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M1_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa0</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>

	<span class="n">intelfbhw_get_p1p2</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	PLLA0: (m1, m2, n, p1, p2) = (%d, %d, %d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	PLLA0: clock is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">calc_vclock</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa1</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa1</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M1_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>
	<span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa1</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">;</span>

	<span class="n">intelfbhw_get_p1p2</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	PLLA1: (m1, m2, n, p1, p2) = (%d, %d, %d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	PLLA1: clock is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">calc_vclock</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;	PALETTE_A:\n&quot;);</span>
<span class="c">	for (i = 0; i &lt; PALETTE_8_ENTRIES)</span>
<span class="c">		printk(&quot;	%3d:	0x%08x\n&quot;, i, hw-&gt;palette_a[i]);</span>
<span class="c">	printk(&quot;	PALETTE_B:\n&quot;);</span>
<span class="c">	for (i = 0; i &lt; PALETTE_8_ENTRIES)</span>
<span class="c">		printk(&quot;	%3d:	0x%08x\n&quot;, i, hw-&gt;palette_b[i]);</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	HTOTAL_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	HBLANK_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	HSYNC_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VTOTAL_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VBLANK_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VSYNC_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	SRC_SIZE_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	BCLRPAT_A:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">bclrpat_a</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	HTOTAL_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	HBLANK_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	HSYNC_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VTOTAL_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VBLANK_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VSYNC_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	SRC_SIZE_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_b</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	BCLRPAT_B:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">bclrpat_b</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	ADPA:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DVOA:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoa</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DVOB:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvob</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DVOC:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DVOA_SRCDIM:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoa_srcdim</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DVOB_SRCDIM:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvob_srcdim</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DVOC_SRCDIM:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoc_srcdim</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	LVDS:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">lvds</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	PIPEACONF:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_a_conf</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	PIPEBCONF:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_b_conf</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DISPARB:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_arb</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	CURSOR_A_CONTROL:	0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_a_control</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	CURSOR_B_CONTROL:	0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_b_control</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	CURSOR_A_BASEADDR:	0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_a_base</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	CURSOR_B_BASEADDR:	0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_b_base</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	CURSOR_A_PALETTE:	&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_a_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	CURSOR_B_PALETTE:	&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_b_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	CURSOR_SIZE:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cursor_size</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DSPACNTR:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DSPBCNTR:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_ctrl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DSPABASE:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_base</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DSPBBASE:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_base</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DSPASTRIDE:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	DSPBSTRIDE:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_b_stride</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	VGACNTRL:		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vgacntrl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	ADD_ID:			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">add_id</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	SWF0%d			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">swf0x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	SWF1%d			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">swf1x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	SWF3%d			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">swf3x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	FENCE%d			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	INSTPM			0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">instpm</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	MEM_MODE		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_mode</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	FW_BLC_0		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fw_blc_0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	FW_BLC_1		0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fw_blc_1</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	HWSTAM			0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hwstam</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	IER			0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	IIR			0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;	IMR			0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hw state dump end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>



<span class="cm">/* Split the M parameter into M1 and M2. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">splitm</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">retm1</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">retm2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">testm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pll_min_max</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plls</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* no point optimising too much - brute force m */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m1</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_m1</span><span class="p">;</span> <span class="n">m1</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_m1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m2</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_m2</span><span class="p">;</span> <span class="n">m2</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_m2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">testm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">testm</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">retm1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">m1</span><span class="p">;</span>
				<span class="o">*</span><span class="n">retm2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">m2</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Split the P parameter into P1 and P2. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">splitp</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">retp1</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">retp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pll_min_max</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plls</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">PLLS_I9xx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">p1</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">p2</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>

		<span class="o">*</span><span class="n">retp1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">p1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">retp2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">p2</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p1</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_p1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_p1</span> <span class="o">||</span> <span class="n">p1</span> <span class="o">&gt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_p1</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">retp1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">p1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">retp2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">p2</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_pll_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">retm1</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">retm2</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="o">*</span><span class="n">retn</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">retp1</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">retp2</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">retclock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">testm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_vco</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p_best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">err_max</span><span class="p">,</span> <span class="n">err_target</span><span class="p">,</span> <span class="n">err_best</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n_best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f_best</span><span class="p">,</span> <span class="n">f_err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">p_inc</span><span class="p">,</span> <span class="n">div_max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pll_min_max</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plls</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* Accept 0.5% difference, but aim for 0.1% */</span>
	<span class="n">err_max</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">clock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">err_target</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;Clock is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>

	<span class="n">div_max</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_vco</span> <span class="o">/</span> <span class="n">clock</span><span class="p">;</span>

	<span class="n">p_inc</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">p_transition_clk</span><span class="p">)</span> <span class="o">?</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">p_inc_lo</span> <span class="o">:</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">p_inc_hi</span><span class="p">;</span>
	<span class="n">p_min</span> <span class="o">=</span> <span class="n">p_inc</span><span class="p">;</span>
	<span class="n">p_max</span> <span class="o">=</span> <span class="n">ROUND_DOWN_TO</span><span class="p">(</span><span class="n">div_max</span><span class="p">,</span> <span class="n">p_inc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_min</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_p</span><span class="p">)</span>
		<span class="n">p_min</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_max</span> <span class="o">&gt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_p</span><span class="p">)</span>
		<span class="n">p_max</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_p</span><span class="p">;</span>

	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;p range is %d-%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">p_inc</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">p_min</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">splitp</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;cannot split p = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">p_inc</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_n</span><span class="p">;</span>
		<span class="n">f_vco</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">ROUND_UP_TO</span><span class="p">(</span><span class="n">f_vco</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ref_clk</span><span class="p">)</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">ref_clk</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_m</span><span class="p">)</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">min_m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_m</span><span class="p">)</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">testm</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">testm</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">;</span> <span class="n">testm</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">f_out</span> <span class="o">=</span> <span class="n">calc_vclock3</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">testm</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">splitm</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">testm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;cannot split m = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">testm</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&gt;</span> <span class="n">f_out</span><span class="p">)</span>
					<span class="n">f_err</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">-</span> <span class="n">f_out</span><span class="p">;</span>
				<span class="k">else</span><span class="cm">/* slightly bias the error for bigger clocks */</span>
					<span class="n">f_err</span> <span class="o">=</span> <span class="n">f_out</span> <span class="o">-</span> <span class="n">clock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">f_err</span> <span class="o">&lt;</span> <span class="n">err_best</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">m_best</span> <span class="o">=</span> <span class="n">testm</span><span class="p">;</span>
					<span class="n">n_best</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
					<span class="n">p_best</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
					<span class="n">f_best</span> <span class="o">=</span> <span class="n">f_out</span><span class="p">;</span>
					<span class="n">err_best</span> <span class="o">=</span> <span class="n">f_err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_n</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f_out</span> <span class="o">&gt;=</span> <span class="n">clock</span><span class="p">));</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">p_inc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="n">p_max</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_best</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;cannot find parameters for clock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">m_best</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">n_best</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">p_best</span><span class="p">;</span>
	<span class="n">splitm</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m2</span><span class="p">);</span>
	<span class="n">splitp</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">);</span>
	<span class="n">n1</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;m, n, p: %d (%d,%d), %d (%d), %d (%d,%d), &quot;</span>
		<span class="s">&quot;f: %d (%d), VCO: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">m</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span>
		<span class="n">calc_vclock3</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
		<span class="n">calc_vclock</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">calc_vclock3</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">);</span>
	<span class="o">*</span><span class="n">retm1</span> <span class="o">=</span> <span class="n">m1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">retm2</span> <span class="o">=</span> <span class="n">m2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">retn</span> <span class="o">=</span> <span class="n">n1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">retp1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">retp2</span> <span class="o">=</span> <span class="n">p2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">retclock</span> <span class="o">=</span> <span class="n">calc_vclock</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">check_overflow</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">limit</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;%s value %d exceeds limit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">description</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* It is assumed that hw is filled in with the initial state information. */</span>
<span class="kt">int</span> <span class="nf">intelfbhw_mode_to_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">intelfb_hwstate</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intelfbhw_active_pipe</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dpll</span><span class="p">,</span> <span class="o">*</span><span class="n">fp0</span><span class="p">,</span> <span class="o">*</span><span class="n">fp1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">clock_target</span><span class="p">,</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsync_start</span><span class="p">,</span> <span class="n">hsync_end</span><span class="p">,</span> <span class="n">hblank_start</span><span class="p">,</span> <span class="n">hblank_end</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">hactive</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vsync_start</span><span class="p">,</span> <span class="n">vsync_end</span><span class="p">,</span> <span class="n">vblank_start</span><span class="p">,</span> <span class="n">vblank_end</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">vactive</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vsync_pol</span><span class="p">,</span> <span class="n">hsync_pol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">vs</span><span class="p">,</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span> <span class="o">*</span><span class="n">vt</span><span class="p">,</span> <span class="o">*</span><span class="n">hs</span><span class="p">,</span> <span class="o">*</span><span class="n">hb</span><span class="p">,</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span> <span class="o">*</span><span class="n">pipe_conf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stride_alignment</span><span class="p">;</span>

	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_mode_to_hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Disable VGA */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vgacntrl</span> <span class="o">|=</span> <span class="n">VGA_DISABLE</span><span class="p">;</span>

	<span class="cm">/* Set which pipe&#39;s registers will be set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_b</span><span class="p">;</span>
		<span class="n">fp0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb0</span><span class="p">;</span>
		<span class="n">fp1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb1</span><span class="p">;</span>
		<span class="n">hs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_b</span><span class="p">;</span>
		<span class="n">hb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_b</span><span class="p">;</span>
		<span class="n">ht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_b</span><span class="p">;</span>
		<span class="n">vs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_b</span><span class="p">;</span>
		<span class="n">vb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_b</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_b</span><span class="p">;</span>
		<span class="n">ss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_b</span><span class="p">;</span>
		<span class="n">pipe_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_b_conf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_a</span><span class="p">;</span>
		<span class="n">fp0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa0</span><span class="p">;</span>
		<span class="n">fp1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa1</span><span class="p">;</span>
		<span class="n">hs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_a</span><span class="p">;</span>
		<span class="n">hb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_a</span><span class="p">;</span>
		<span class="n">ht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_a</span><span class="p">;</span>
		<span class="n">vs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_a</span><span class="p">;</span>
		<span class="n">vb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_a</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_a</span><span class="p">;</span>
		<span class="n">ss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_a</span><span class="p">;</span>
		<span class="n">pipe_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_a_conf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use ADPA register for sync control. */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADPA_USE_VGA_HVPOLARITY</span><span class="p">;</span>

	<span class="cm">/* sync polarity */</span>
	<span class="n">hsync_pol</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">ADPA_SYNC_ACTIVE_HIGH</span> <span class="o">:</span> <span class="n">ADPA_SYNC_ACTIVE_LOW</span><span class="p">;</span>
	<span class="n">vsync_pol</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">ADPA_SYNC_ACTIVE_HIGH</span> <span class="o">:</span> <span class="n">ADPA_SYNC_ACTIVE_LOW</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">ADPA_SYNC_ACTIVE_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">ADPA_VSYNC_ACTIVE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">ADPA_SYNC_ACTIVE_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">ADPA_HSYNC_ACTIVE_SHIFT</span><span class="p">));</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hsync_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ADPA_HSYNC_ACTIVE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">vsync_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ADPA_VSYNC_ACTIVE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Connect correct pipe to the analog port DAC */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PIPE_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">ADPA_PIPE_SELECT_SHIFT</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="n">ADPA_PIPE_SELECT_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Set DPMS state to D0 (on) */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADPA_DPMS_CONTROL_MASK</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">|=</span> <span class="n">ADPA_DPMS_D0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">|=</span> <span class="n">ADPA_DAC_ENABLE</span><span class="p">;</span>

	<span class="o">*</span><span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DPLL_VCO_ENABLE</span> <span class="o">|</span> <span class="n">DPLL_VGA_MODE_DISABLE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DPLL_RATE_SELECT_MASK</span> <span class="o">|</span> <span class="n">DPLL_REFERENCE_SELECT_MASK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DPLL_REFERENCE_DEFAULT</span> <span class="o">|</span> <span class="n">DPLL_RATE_SELECT_FP0</span><span class="p">);</span>

	<span class="cm">/* Desired clock in kHz */</span>
	<span class="n">clock_target</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">calc_pll_params</span><span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pll_index</span><span class="p">,</span> <span class="n">clock_target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m2</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;calc_pll_params failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for overflow. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">DPLL_P1_MASK</span><span class="p">,</span> <span class="s">&quot;PLL P1 parameter&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">DPLL_P2_MASK</span><span class="p">,</span> <span class="s">&quot;PLL P2 parameter&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">,</span> <span class="s">&quot;PLL M1 parameter&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">,</span> <span class="s">&quot;PLL M2 parameter&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">FP_DIVISOR_MASK</span><span class="p">,</span> <span class="s">&quot;PLL N parameter&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">dpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPLL_P1_FORCE_DIV2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">DPLL_P2_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_P2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">DPLL_P1_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_P1_SHIFT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I9XX</span><span class="p">(</span><span class="n">dinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p2</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_I9XX_P2_SHIFT</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_P1_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p2</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_P2_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p1</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_P1_SHIFT</span><span class="p">);</span>

	<span class="o">*</span><span class="n">fp0</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">FP_N_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="n">FP_M1_DIVISOR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">m2</span> <span class="o">&lt;&lt;</span> <span class="n">FP_M2_DIVISOR_SHIFT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">fp1</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvob</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_ENABLE</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_ENABLE</span><span class="p">;</span>

	<span class="cm">/* Use display plane A. */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">|=</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_GAMMA_ENABLE</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PIXFORMAT_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">intelfb_var_to_depth</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">|=</span> <span class="n">DISPPLANE_8BPP</span> <span class="o">|</span> <span class="n">DISPPLANE_GAMMA_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">|=</span> <span class="n">DISPPLANE_15_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">|=</span> <span class="n">DISPPLANE_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PIPE_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">DISPPLANE_SEL_PIPE_SHIFT</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="n">DISPPLANE_SEL_PIPE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Set CRTC registers. */</span>
	<span class="n">hactive</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">hsync_start</span> <span class="o">=</span> <span class="n">hactive</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">hsync_end</span> <span class="o">=</span> <span class="n">hsync_start</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">htotal</span> <span class="o">=</span> <span class="n">hsync_end</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">hblank_start</span> <span class="o">=</span> <span class="n">hactive</span><span class="p">;</span>
	<span class="n">hblank_end</span> <span class="o">=</span> <span class="n">htotal</span><span class="p">;</span>

	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;H: act %d, ss %d, se %d, tot %d bs %d, be %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hactive</span><span class="p">,</span> <span class="n">hsync_start</span><span class="p">,</span> <span class="n">hsync_end</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">hblank_start</span><span class="p">,</span>
		<span class="n">hblank_end</span><span class="p">);</span>

	<span class="n">vactive</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">vactive</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* the chip adds 2 halflines automatically */</span>
	<span class="n">vsync_start</span> <span class="o">=</span> <span class="n">vactive</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">vsync_end</span> <span class="o">=</span> <span class="n">vsync_start</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">vsync_end</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">vblank_start</span> <span class="o">=</span> <span class="n">vactive</span><span class="p">;</span>
	<span class="n">vblank_end</span> <span class="o">=</span> <span class="n">vtotal</span><span class="p">;</span>
	<span class="n">vblank_end</span> <span class="o">=</span> <span class="n">vsync_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;V: act %d, ss %d, se %d, tot %d bs %d, be %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vactive</span><span class="p">,</span> <span class="n">vsync_start</span><span class="p">,</span> <span class="n">vsync_end</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">vblank_start</span><span class="p">,</span>
		<span class="n">vblank_end</span><span class="p">);</span>

	<span class="cm">/* Adjust for register values, and check for overflow. */</span>
	<span class="n">hactive</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">hactive</span><span class="p">,</span> <span class="n">HACTIVE_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC hactive&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsync_start</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">hsync_start</span><span class="p">,</span> <span class="n">HSYNCSTART_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC hsync_start&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsync_end</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">hsync_end</span><span class="p">,</span> <span class="n">HSYNCEND_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC hsync_end&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">htotal</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">htotal</span><span class="p">,</span> <span class="n">HTOTAL_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC htotal&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hblank_start</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">hblank_start</span><span class="p">,</span> <span class="n">HBLANKSTART_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC hblank_start&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hblank_end</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">hblank_end</span><span class="p">,</span> <span class="n">HBLANKEND_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC hblank_end&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vactive</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">vactive</span><span class="p">,</span> <span class="n">VACTIVE_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC vactive&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsync_start</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">vsync_start</span><span class="p">,</span> <span class="n">VSYNCSTART_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC vsync_start&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vsync_end</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">vsync_end</span><span class="p">,</span> <span class="n">VSYNCEND_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC vsync_end&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vtotal</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">vtotal</span><span class="p">,</span> <span class="n">VTOTAL_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC vtotal&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vblank_start</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">vblank_start</span><span class="p">,</span> <span class="n">VBLANKSTART_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC vblank_start&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vblank_end</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_overflow</span><span class="p">(</span><span class="n">vblank_end</span><span class="p">,</span> <span class="n">VBLANKEND_MASK</span><span class="p">,</span> <span class="s">&quot;CRTC vblank_end&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ht</span> <span class="o">=</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">&lt;&lt;</span> <span class="n">HTOTAL_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hactive</span> <span class="o">&lt;&lt;</span> <span class="n">HACTIVE_SHIFT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">hb</span> <span class="o">=</span> <span class="p">(</span><span class="n">hblank_start</span> <span class="o">&lt;&lt;</span> <span class="n">HBLANKSTART_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">hblank_end</span> <span class="o">&lt;&lt;</span> <span class="n">HSYNCEND_SHIFT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">hs</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsync_start</span> <span class="o">&lt;&lt;</span> <span class="n">HSYNCSTART_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hsync_end</span> <span class="o">&lt;&lt;</span> <span class="n">HSYNCEND_SHIFT</span><span class="p">);</span>

	<span class="o">*</span><span class="n">vt</span> <span class="o">=</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&lt;&lt;</span> <span class="n">VTOTAL_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vactive</span> <span class="o">&lt;&lt;</span> <span class="n">VACTIVE_SHIFT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">vb</span> <span class="o">=</span> <span class="p">(</span><span class="n">vblank_start</span> <span class="o">&lt;&lt;</span> <span class="n">VBLANKSTART_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">vblank_end</span> <span class="o">&lt;&lt;</span> <span class="n">VSYNCEND_SHIFT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">vs</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsync_start</span> <span class="o">&lt;&lt;</span> <span class="n">VSYNCSTART_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vsync_end</span> <span class="o">&lt;&lt;</span> <span class="n">VSYNCEND_SHIFT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="p">(</span><span class="n">hactive</span> <span class="o">&lt;&lt;</span> <span class="n">SRC_SIZE_HORIZ_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">vactive</span> <span class="o">&lt;&lt;</span> <span class="n">SRC_SIZE_VERT_SHIFT</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">;</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;pitch is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_base</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span>
			  <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_base</span> <span class="o">+=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="cm">/* Check stride alignment. */</span>
	<span class="n">stride_alignment</span> <span class="o">=</span> <span class="n">IS_I9XX</span><span class="p">(</span><span class="n">dinfo</span><span class="p">)</span> <span class="o">?</span> <span class="n">STRIDE_ALIGNMENT_I9XX</span> <span class="o">:</span>
					    <span class="n">STRIDE_ALIGNMENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span> <span class="o">%</span> <span class="n">stride_alignment</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;display stride %d has bad alignment %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span><span class="p">,</span> <span class="n">stride_alignment</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the palette to 8-bit mode. */</span>
	<span class="o">*</span><span class="n">pipe_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_GAMMA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pipe_conf</span> <span class="o">|=</span> <span class="n">PIPECONF_INTERLACE_W_FIELD_INDICATION</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">pipe_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_INTERLACE_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Program a (non-VGA) video mode. */</span>
<span class="kt">int</span> <span class="nf">intelfbhw_program_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">intelfb_hwstate</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dpll</span><span class="p">,</span> <span class="o">*</span><span class="n">fp0</span><span class="p">,</span> <span class="o">*</span><span class="n">fp1</span><span class="p">,</span> <span class="o">*</span><span class="n">pipe_conf</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hs</span><span class="p">,</span> <span class="o">*</span><span class="n">ht</span><span class="p">,</span> <span class="o">*</span><span class="n">hb</span><span class="p">,</span> <span class="o">*</span><span class="n">vs</span><span class="p">,</span> <span class="o">*</span><span class="n">vt</span><span class="p">,</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span> <span class="o">*</span><span class="n">ss</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll_reg</span><span class="p">,</span> <span class="n">fp0_reg</span><span class="p">,</span> <span class="n">fp1_reg</span><span class="p">,</span> <span class="n">pipe_conf_reg</span><span class="p">,</span> <span class="n">pipe_stat_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hsync_reg</span><span class="p">,</span> <span class="n">htotal_reg</span><span class="p">,</span> <span class="n">hblank_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vsync_reg</span><span class="p">,</span> <span class="n">vtotal_reg</span><span class="p">,</span> <span class="n">vblank_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">src_size_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp_val</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* Assume single pipe */</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_program_mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Disable VGA */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">VGA_DISABLE</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">intelfbhw_active_pipe</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_b</span><span class="p">;</span>
		<span class="n">fp0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb0</span><span class="p">;</span>
		<span class="n">fp1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpb1</span><span class="p">;</span>
		<span class="n">pipe_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_b_conf</span><span class="p">;</span>
		<span class="n">hs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_b</span><span class="p">;</span>
		<span class="n">hb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_b</span><span class="p">;</span>
		<span class="n">ht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_b</span><span class="p">;</span>
		<span class="n">vs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_b</span><span class="p">;</span>
		<span class="n">vb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_b</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_b</span><span class="p">;</span>
		<span class="n">ss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_b</span><span class="p">;</span>
		<span class="n">dpll_reg</span> <span class="o">=</span> <span class="n">DPLL_B</span><span class="p">;</span>
		<span class="n">fp0_reg</span> <span class="o">=</span> <span class="n">FPB0</span><span class="p">;</span>
		<span class="n">fp1_reg</span> <span class="o">=</span> <span class="n">FPB1</span><span class="p">;</span>
		<span class="n">pipe_conf_reg</span> <span class="o">=</span> <span class="n">PIPEBCONF</span><span class="p">;</span>
		<span class="n">pipe_stat_reg</span> <span class="o">=</span> <span class="n">PIPEBSTAT</span><span class="p">;</span>
		<span class="n">hsync_reg</span> <span class="o">=</span> <span class="n">HSYNC_B</span><span class="p">;</span>
		<span class="n">htotal_reg</span> <span class="o">=</span> <span class="n">HTOTAL_B</span><span class="p">;</span>
		<span class="n">hblank_reg</span> <span class="o">=</span> <span class="n">HBLANK_B</span><span class="p">;</span>
		<span class="n">vsync_reg</span> <span class="o">=</span> <span class="n">VSYNC_B</span><span class="p">;</span>
		<span class="n">vtotal_reg</span> <span class="o">=</span> <span class="n">VTOTAL_B</span><span class="p">;</span>
		<span class="n">vblank_reg</span> <span class="o">=</span> <span class="n">VBLANK_B</span><span class="p">;</span>
		<span class="n">src_size_reg</span> <span class="o">=</span> <span class="n">SRC_SIZE_B</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dpll_a</span><span class="p">;</span>
		<span class="n">fp0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa0</span><span class="p">;</span>
		<span class="n">fp1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fpa1</span><span class="p">;</span>
		<span class="n">pipe_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pipe_a_conf</span><span class="p">;</span>
		<span class="n">hs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hsync_a</span><span class="p">;</span>
		<span class="n">hb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hblank_a</span><span class="p">;</span>
		<span class="n">ht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">htotal_a</span><span class="p">;</span>
		<span class="n">vs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vsync_a</span><span class="p">;</span>
		<span class="n">vb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vblank_a</span><span class="p">;</span>
		<span class="n">vt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vtotal_a</span><span class="p">;</span>
		<span class="n">ss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_size_a</span><span class="p">;</span>
		<span class="n">dpll_reg</span> <span class="o">=</span> <span class="n">DPLL_A</span><span class="p">;</span>
		<span class="n">fp0_reg</span> <span class="o">=</span> <span class="n">FPA0</span><span class="p">;</span>
		<span class="n">fp1_reg</span> <span class="o">=</span> <span class="n">FPA1</span><span class="p">;</span>
		<span class="n">pipe_conf_reg</span> <span class="o">=</span> <span class="n">PIPEACONF</span><span class="p">;</span>
		<span class="n">pipe_stat_reg</span> <span class="o">=</span> <span class="n">PIPEASTAT</span><span class="p">;</span>
		<span class="n">hsync_reg</span> <span class="o">=</span> <span class="n">HSYNC_A</span><span class="p">;</span>
		<span class="n">htotal_reg</span> <span class="o">=</span> <span class="n">HTOTAL_A</span><span class="p">;</span>
		<span class="n">hblank_reg</span> <span class="o">=</span> <span class="n">HBLANK_A</span><span class="p">;</span>
		<span class="n">vsync_reg</span> <span class="o">=</span> <span class="n">VSYNC_A</span><span class="p">;</span>
		<span class="n">vtotal_reg</span> <span class="o">=</span> <span class="n">VTOTAL_A</span><span class="p">;</span>
		<span class="n">vblank_reg</span> <span class="o">=</span> <span class="n">VBLANK_A</span><span class="p">;</span>
		<span class="n">src_size_reg</span> <span class="o">=</span> <span class="n">SRC_SIZE_A</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* turn off pipe */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">pipe_conf_reg</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_ENABLE</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">pipe_conf_reg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp_val</span><span class="p">[</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PIPEA_DSL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmp_val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmp_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">pipe_conf_reg</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_ENABLE</span><span class="p">;</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">pipe_conf_reg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ADPA_DAC_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Disable planes A and B. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPBCNTR</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPBCNTR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Wait for vblank. For now, just wait for a 50Hz cycle (20ms)) */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DVOB</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_ENABLE</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DVOC</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DVOC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_ENABLE</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ADPA_DAC_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Disable Sync */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADPA_DPMS_CONTROL_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADPA_DPMS_D3</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* do some funky magic - xyzzy */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="mh">0x61204</span><span class="p">,</span> <span class="mh">0xabcd0000</span><span class="p">);</span>

	<span class="cm">/* turn off PLL */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Set PLL parameters */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">fp0_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">fp0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">fp1_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">fp1</span><span class="p">);</span>

	<span class="cm">/* Enable PLL */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">dpll</span><span class="p">);</span>

	<span class="cm">/* Set DVOs B/C */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DVOB</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvob</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DVOC</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dvoc</span><span class="p">);</span>

	<span class="cm">/* undo funky magic */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="mh">0x61204</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/* Set ADPA */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">)</span> <span class="o">|</span> <span class="n">ADPA_DAC_ENABLE</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">,</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adpa</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ADPA_DPMS_CONTROL_MASK</span><span class="p">))</span> <span class="o">|</span> <span class="n">ADPA_DPMS_D3</span><span class="p">);</span>

	<span class="cm">/* Set pipe parameters */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">hsync_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">hs</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">hblank_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">hb</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">htotal_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">ht</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">vsync_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">vs</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">vblank_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">vb</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">vtotal_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">vt</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">src_size_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">ss</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span>
					  <span class="n">FB_VMODE_ODD_FLD_FIRST</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_ODD_FLD_FIRST</span>:
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">pipe_stat_reg</span><span class="p">,</span> <span class="mh">0xFFFF</span> <span class="o">|</span> <span class="n">PIPESTAT_FLD_EVT_ODD_EN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_VMODE_INTERLACED</span>: <span class="cm">/* even lines first */</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">pipe_stat_reg</span><span class="p">,</span> <span class="mh">0xFFFF</span> <span class="o">|</span> <span class="n">PIPESTAT_FLD_EVT_EVEN_EN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* non-interlaced */</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">pipe_stat_reg</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span> <span class="cm">/* clear all status bits only */</span>
	<span class="p">}</span>
	<span class="cm">/* Enable pipe */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">pipe_conf_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">pipe_conf</span> <span class="o">|</span> <span class="n">PIPECONF_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Enable sync */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADPA_DPMS_CONTROL_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADPA_DPMS_D0</span><span class="p">;</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">ADPA</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* setup display plane */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_830M</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *      i830M errata: the display plane must be enabled</span>
<span class="cm">		 *      to allow writes to the other bits in the plane</span>
<span class="cm">		 *      control register.</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">;</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span><span class="o">|</span><span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPASTRIDE</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_stride</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_base</span><span class="p">);</span>

	<span class="cm">/* Enable plane */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DISPPLANE_PLANE_ENABLE</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPACNTR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">disp_a_base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* forward declarations */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">refresh_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">);</span>

<span class="k">static</span>  <span class="n">u32</span> <span class="nf">get_ring_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ring_space</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_tail</span> <span class="o">&gt;=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span><span class="p">)</span>
		<span class="n">ring_space</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_tail</span> <span class="o">-</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ring_space</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span> <span class="o">-</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_tail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring_space</span> <span class="o">&gt;</span> <span class="n">RING_MIN_FREE</span><span class="p">)</span>
		<span class="n">ring_space</span> <span class="o">-=</span> <span class="n">RING_MIN_FREE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ring_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ring_space</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_head</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PRI_RING_HEAD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RING_HEAD_MASK</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;wait_ring: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_space</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PRI_RING_HEAD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RING_HEAD_MASK</span><span class="p">;</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_space</span> <span class="o">=</span> <span class="n">get_ring_space</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span> <span class="o">!=</span> <span class="n">last_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">last_head</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Try again */</span>
				<span class="n">reset_state</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
				<span class="n">refresh_ring</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
				<span class="n">do_flush</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;ring buffer : space: %d wanted %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_space</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
				<span class="n">WRN_MSG</span><span class="p">(</span><span class="s">&quot;lockup - turning off hardware &quot;</span>
					<span class="s">&quot;acceleration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_lockup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">START_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_FLUSH</span> <span class="o">|</span> <span class="n">MI_WRITE_DIRTY_STATE</span> <span class="o">|</span> <span class="n">MI_INVALIDATE_MAP_CACHE</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_NOOP</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_do_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_do_sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send a flush, then wait until the ring is empty.  This is what</span>
<span class="cm">	 * the XFree86 driver does, and actually it doesn&#39;t seem a lot worse</span>
<span class="cm">	 * than the recommended method (both have problems).</span>
<span class="cm">	 */</span>
	<span class="n">do_flush</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
	<span class="n">wait_ring</span><span class="p">(</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">RING_MIN_FREE</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_space</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">RING_MIN_FREE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">refresh_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;refresh_ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PRI_RING_HEAD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RING_HEAD_MASK</span><span class="p">;</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_tail</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PRI_RING_TAIL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RING_TAIL_MASK</span><span class="p">;</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_space</span> <span class="o">=</span> <span class="n">get_ring_space</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;reset_state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FENCE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">FENCE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Flush the ring buffer if it&#39;s enabled. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PRI_RING_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RING_ENABLE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if VERBOSE &gt; 0</span>
		<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;reset_state: ring was enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">refresh_ring</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
		<span class="n">intelfbhw_do_sync</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
		<span class="n">DO_RING_IDLE</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_HEAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_TAIL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Stop the 2D engine, and turn off the ring buffer. */</span>
<span class="kt">void</span> <span class="nf">intelfbhw_2d_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_2d_stop: accel: %d, ring_active: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_active</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reset_state</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable the ring buffer, and initialise the 2D engine.</span>
<span class="cm"> * It is assumed that the graphics engine has been stopped by previously</span>
<span class="cm"> * calling intelfb_2d_stop().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intelfbhw_2d_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_2d_start: accel: %d, ring_active: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_active</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">accel</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Initialise the primary ring buffer. */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_TAIL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_HEAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_START</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">physical</span> <span class="o">&amp;</span> <span class="n">RING_START_MASK</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PRI_RING_LENGTH</span><span class="p">,</span>
		<span class="p">((</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">GTT_PAGE_SIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RING_LENGTH_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RING_NO_REPORT</span> <span class="o">|</span> <span class="n">RING_ENABLE</span><span class="p">);</span>
	<span class="n">refresh_ring</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 2D fillrect (solid fill or invert) */</span>
<span class="kt">void</span> <span class="nf">intelfbhw_do_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">color</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">br00</span><span class="p">,</span> <span class="n">br09</span><span class="p">,</span> <span class="n">br13</span><span class="p">,</span> <span class="n">br14</span><span class="p">,</span> <span class="n">br16</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_do_fillrect: (%d,%d) %dx%d, c 0x%06x, p %d bpp %d, &quot;</span>
		<span class="s">&quot;rop 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">rop</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">br00</span> <span class="o">=</span> <span class="n">COLOR_BLT_CMD</span><span class="p">;</span>
	<span class="n">br09</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">pitch</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">br13</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span> <span class="o">&lt;&lt;</span> <span class="n">ROP_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="n">br14</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="n">HEIGHT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">WIDTH_SHIFT</span><span class="p">);</span>
	<span class="n">br16</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_32</span><span class="p">;</span>
		<span class="n">br00</span> <span class="o">|=</span> <span class="n">WRITE_ALPHA</span> <span class="o">|</span> <span class="n">WRITE_RGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">START_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br00</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br13</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br14</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br09</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br16</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_NOOP</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;ring = 0x%08x, 0x%08x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_head</span><span class="p">,</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_tail</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">ring_space</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">intelfbhw_do_bitblt</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">curx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cury</span><span class="p">,</span>
		    <span class="n">u32</span> <span class="n">dstx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dsty</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">br00</span><span class="p">,</span> <span class="n">br09</span><span class="p">,</span> <span class="n">br11</span><span class="p">,</span> <span class="n">br12</span><span class="p">,</span> <span class="n">br13</span><span class="p">,</span> <span class="n">br22</span><span class="p">,</span> <span class="n">br23</span><span class="p">,</span> <span class="n">br26</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_do_bitblt: (%d,%d)-&gt;(%d,%d) %dx%d, p %d bpp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">curx</span><span class="p">,</span> <span class="n">cury</span><span class="p">,</span> <span class="n">dstx</span><span class="p">,</span> <span class="n">dsty</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">br00</span> <span class="o">=</span> <span class="n">XY_SRC_COPY_BLT_CMD</span><span class="p">;</span>
	<span class="n">br09</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb_start</span><span class="p">;</span>
	<span class="n">br11</span> <span class="o">=</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;&lt;</span> <span class="n">PITCH_SHIFT</span><span class="p">);</span>
	<span class="n">br12</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb_start</span><span class="p">;</span>
	<span class="n">br13</span> <span class="o">=</span> <span class="p">(</span><span class="n">SRC_ROP_GXCOPY</span> <span class="o">&lt;&lt;</span> <span class="n">ROP_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;&lt;</span> <span class="n">PITCH_SHIFT</span><span class="p">);</span>
	<span class="n">br22</span> <span class="o">=</span> <span class="p">(</span><span class="n">dstx</span> <span class="o">&lt;&lt;</span> <span class="n">WIDTH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dsty</span> <span class="o">&lt;&lt;</span> <span class="n">HEIGHT_SHIFT</span><span class="p">);</span>
	<span class="n">br23</span> <span class="o">=</span> <span class="p">((</span><span class="n">dstx</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">WIDTH_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">dsty</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">HEIGHT_SHIFT</span><span class="p">);</span>
	<span class="n">br26</span> <span class="o">=</span> <span class="p">(</span><span class="n">curx</span> <span class="o">&lt;&lt;</span> <span class="n">WIDTH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cury</span> <span class="o">&lt;&lt;</span> <span class="n">HEIGHT_SHIFT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_32</span><span class="p">;</span>
		<span class="n">br00</span> <span class="o">|=</span> <span class="n">WRITE_ALPHA</span> <span class="o">|</span> <span class="n">WRITE_RGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">START_RING</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br00</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br13</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br22</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br23</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br09</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br26</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br11</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br12</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intelfbhw_do_drawglyph</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span><span class="o">*</span> <span class="n">cdat</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pitch</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ndwords</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">br00</span><span class="p">,</span> <span class="n">br09</span><span class="p">,</span> <span class="n">br13</span><span class="p">,</span> <span class="n">br18</span><span class="p">,</span> <span class="n">br19</span><span class="p">,</span> <span class="n">br22</span><span class="p">,</span> <span class="n">br23</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dat</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_do_drawglyph: (%d,%d) %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* size in bytes of a padded scanline */</span>
	<span class="n">nbytes</span> <span class="o">=</span> <span class="n">ROUND_UP_TO</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Total bytes of padded scanline data to write out. */</span>
	<span class="n">nbytes</span> <span class="o">=</span> <span class="n">nbytes</span> <span class="o">*</span> <span class="n">h</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if the glyph data exceeds the immediate mode limit.</span>
<span class="cm">	 * It would take a large font (1K pixels) to hit this limit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="n">MAX_MONO_IMM_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Src data is packaged a dword (32-bit) at a time. */</span>
	<span class="n">ndwords</span> <span class="o">=</span> <span class="n">ROUND_UP_TO</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ring has to be padded to a quad word. But because the command starts</span>
<span class="cm">	   with 7 bytes, pad only if there is an even number of ndwords</span>
<span class="cm">	 */</span>
	<span class="n">pad</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ndwords</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">XY_MONO_SRC_IMM_BLT_CMD</span> <span class="o">&amp;</span> <span class="n">DW_LENGTH_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="n">ndwords</span><span class="p">;</span>
	<span class="n">br00</span> <span class="o">=</span> <span class="p">(</span><span class="n">XY_MONO_SRC_IMM_BLT_CMD</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DW_LENGTH_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">br09</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">fb_start</span><span class="p">;</span>
	<span class="n">br13</span> <span class="o">=</span> <span class="p">(</span><span class="n">SRC_ROP_GXCOPY</span> <span class="o">&lt;&lt;</span> <span class="n">ROP_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;&lt;</span> <span class="n">PITCH_SHIFT</span><span class="p">);</span>
	<span class="n">br18</span> <span class="o">=</span> <span class="n">bg</span><span class="p">;</span>
	<span class="n">br19</span> <span class="o">=</span> <span class="n">fg</span><span class="p">;</span>
	<span class="n">br22</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">WIDTH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="n">HEIGHT_SHIFT</span><span class="p">);</span>
	<span class="n">br23</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">WIDTH_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">HEIGHT_SHIFT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">br13</span> <span class="o">|=</span> <span class="n">COLOR_DEPTH_32</span><span class="p">;</span>
		<span class="n">br00</span> <span class="o">|=</span> <span class="n">WRITE_ALPHA</span> <span class="o">|</span> <span class="n">WRITE_RGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">START_RING</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">ndwords</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br00</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br13</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br22</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br23</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br09</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br18</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">br19</span><span class="p">);</span>
	<span class="n">ix</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iw</span> <span class="o">=</span> <span class="n">ROUND_UP_TO</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ndwords</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">!=</span> <span class="n">iw</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">dat</span> <span class="o">|=</span> <span class="n">cdat</span><span class="p">[</span><span class="n">iy</span><span class="o">*</span><span class="n">iw</span> <span class="o">+</span> <span class="n">ix</span><span class="o">++</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="n">iw</span> <span class="o">&amp;&amp;</span> <span class="n">iy</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">++</span><span class="n">iy</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_NOOP</span><span class="p">);</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* HW cursor functions. */</span>
<span class="kt">void</span> <span class="nf">intelfbhw_cursor_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_cursor_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">||</span> <span class="n">IS_I9XX</span><span class="p">(</span><span class="n">dinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">physical</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_A_CONTROL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CURSOR_MODE_MASK</span> <span class="o">|</span> <span class="n">CURSOR_MOBILE_GAMMA_ENABLE</span> <span class="o">|</span>
			 <span class="n">CURSOR_MEM_TYPE_LOCAL</span> <span class="o">|</span>
			 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_PIPE_SELECT_SHIFT</span><span class="p">));</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_DISABLE</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_BASEADDR</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">physical</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_CONTROL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CURSOR_FORMAT_MASK</span> <span class="o">|</span> <span class="n">CURSOR_GAMMA_ENABLE</span> <span class="o">|</span>
			 <span class="n">CURSOR_ENABLE</span> <span class="o">|</span> <span class="n">CURSOR_STRIDE_MASK</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">CURSOR_FORMAT_3C</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_BASEADDR</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_SIZE_H_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_SIZE_V_SHIFT</span><span class="p">);</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_SIZE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_cursor_hide</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_cursor_hide</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">||</span> <span class="n">IS_I9XX</span><span class="p">(</span><span class="n">dinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">physical</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_A_CONTROL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CURSOR_MODE_MASK</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_DISABLE</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="cm">/* Flush changes */</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_BASEADDR</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">physical</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_CONTROL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CURSOR_ENABLE</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_cursor_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_cursor_show</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor_blanked</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">mobile</span> <span class="o">||</span> <span class="n">IS_I9XX</span><span class="p">(</span><span class="n">dinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">physical</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_A_CONTROL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CURSOR_MODE_MASK</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_64_4C_AX</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="cm">/* Flush changes */</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_BASEADDR</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">physical</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG</span><span class="p">(</span><span class="n">CURSOR_CONTROL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CURSOR_ENABLE</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_cursor_setpos</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_cursor_setpos: (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sets the position. The coordinates are assumed to already</span>
<span class="cm">	 * have any offset adjusted. Assume that the cursor is never</span>
<span class="cm">	 * completely off-screen, and that x, y are always &gt;= 0.</span>
<span class="cm">	 */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">CURSOR_POS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_X_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">CURSOR_POS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_Y_SHIFT</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_POSITION</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I9XX</span><span class="p">(</span><span class="n">dinfo</span><span class="p">))</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_BASEADDR</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">physical</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_cursor_setcolor</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fg</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_cursor_setcolor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_PALETTE0</span><span class="p">,</span> <span class="n">bg</span> <span class="o">&amp;</span> <span class="n">CURSOR_PALETTE_MASK</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_PALETTE1</span><span class="p">,</span> <span class="n">fg</span> <span class="o">&amp;</span> <span class="n">CURSOR_PALETTE_MASK</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_PALETTE2</span><span class="p">,</span> <span class="n">fg</span> <span class="o">&amp;</span> <span class="n">CURSOR_PALETTE_MASK</span><span class="p">);</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">CURSOR_A_PALETTE3</span><span class="p">,</span> <span class="n">bg</span> <span class="o">&amp;</span> <span class="n">CURSOR_PALETTE_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_cursor_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="k">virtual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">width</span> <span class="o">%</span> <span class="mi">8</span><span class="p">,</span> <span class="n">t_mask</span><span class="p">,</span> <span class="n">d_mask</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_cursor_load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="k">virtual</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">t_mask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&gt;&gt;</span> <span class="n">mod</span><span class="p">;</span>
	<span class="n">d_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&gt;&gt;</span> <span class="n">mod</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="o">++</span><span class="p">),</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">j</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">t_mask</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">d_mask</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">j</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_cursor_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="k">virtual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

<span class="cp">#if VERBOSE &gt; 0</span>
	<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;intelfbhw_cursor_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="k">virtual</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">j</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">j</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">intelfbhw_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">INREG16</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">PIPE_A_EVENT_INTERRUPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">VSYNC_PIPE_A_INTERRUPT</span><span class="p">;</span> <span class="cm">/* non-interlaced */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* not us */</span>
	<span class="p">}</span>

	<span class="cm">/* clear status bits 0-15 ASAP and don&#39;t touch bits 16-31 */</span>
	<span class="n">OUTREG</span><span class="p">(</span><span class="n">PIPEASTAT</span><span class="p">,</span> <span class="n">INREG</span><span class="p">(</span><span class="n">PIPEASTAT</span><span class="p">));</span>

	<span class="n">OUTREG16</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_display</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intelfbhw_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">intelfbhw_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				<span class="s">&quot;intelfb&quot;</span><span class="p">,</span> <span class="n">dinfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
		<span class="n">OUTREG16</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xfffe</span><span class="p">);</span> <span class="cm">/* i830 DRM uses ffff */</span>
		<span class="n">OUTREG16</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">PIPE_A_EVENT_INTERRUPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">VSYNC_PIPE_A_INTERRUPT</span><span class="p">;</span> <span class="cm">/* non-interlaced */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">INREG16</span><span class="p">(</span><span class="n">IER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;changing IER to 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">OUTREG16</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intelfbhw_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_display</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">OUTREG</span><span class="p">(</span><span class="n">DSPABASE</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">.</span><span class="n">pan_offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
		<span class="n">OUTREG16</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">OUTREG16</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">OUTREG16</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

		<span class="n">OUTREG16</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">INREG16</span><span class="p">(</span><span class="n">IIR</span><span class="p">));</span> <span class="cm">/* clear IRQ requests */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dinfo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intelfbhw_wait_for_vsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">intelfb_info</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intelfb_vsync</span> <span class="o">*</span><span class="n">vsync</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">vsync</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intelfbhw_enable_irq</span><span class="p">(</span><span class="n">dinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">vsync</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">vsync</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					       <span class="n">count</span> <span class="o">!=</span> <span class="n">vsync</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_MSG</span><span class="p">(</span><span class="s">&quot;wait_for_vsync timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
