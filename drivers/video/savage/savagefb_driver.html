<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › savage › savagefb_driver.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>savagefb_driver.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/savagefb.c -- S3 Savage Framebuffer Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001-2002  Denis Oliver Kropp &lt;dok@directfb.org&gt;</span>
<span class="cm"> *                          Sven Neumann &lt;neo@directfb.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Card specific code is based on XFree86&#39;s savage driver.</span>
<span class="cm"> * Framebuffer framework code is based on code of cyber2000fb and tdfxfb.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General</span>
<span class="cm"> * Public License.  See the file COPYING in the main directory of this</span>
<span class="cm"> * archive for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * 0.4.0 (neo)</span>
<span class="cm"> *  - hardware accelerated clear and move</span>
<span class="cm"> *</span>
<span class="cm"> * 0.3.2 (dok)</span>
<span class="cm"> *  - wait for vertical retrace before writing to cr67</span>
<span class="cm"> *    at the beginning of savagefb_set_par</span>
<span class="cm"> *  - use synchronization registers cr23 and cr26</span>
<span class="cm"> *</span>
<span class="cm"> * 0.3.1 (dok)</span>
<span class="cm"> *  - reset 3D engine</span>
<span class="cm"> *  - don&#39;t return alpha bits for 32bit format</span>
<span class="cm"> *</span>
<span class="cm"> * 0.3.0 (dok)</span>
<span class="cm"> *  - added WaitIdle functions for all Savage types</span>
<span class="cm"> *  - do WaitIdle before mode switching</span>
<span class="cm"> *  - code cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * 0.2.0 (dok)</span>
<span class="cm"> *  - first working version</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * TODO</span>
<span class="cm"> * - clock validations in decode_var</span>
<span class="cm"> *</span>
<span class="cm"> * BUGS</span>
<span class="cm"> * - white margin on bootup</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;savagefb.h&quot;</span>


<span class="cp">#define SAVAGEFB_VERSION &quot;0.4.0_2.6&quot;</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>


<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;(c) 2001-2002  Denis Oliver Kropp &lt;dok@directfb.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FBDev driver for S3 Savage PCI/AGP Chips&quot;</span><span class="p">);</span>

<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgaHWSeqReset</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span>
		<span class="n">VGAwSEQ</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>	<span class="cm">/* Synchronous Reset */</span>
	<span class="k">else</span>
		<span class="n">VGAwSEQ</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>	<span class="cm">/* End Reset */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgaHWProtect</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Turn off screen and disable sequencer.</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="n">vgaHWSeqReset</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	        <span class="cm">/* start synchronous reset */</span>
		<span class="n">VGAwSEQ</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span><span class="cm">/* disable the display */</span>

		<span class="n">VGAenablePalette</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Reenable sequencer, then turn on screen.</span>
<span class="cm">		 */</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="n">VGAwSEQ</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span><span class="cm">/* reenable display */</span>
		<span class="n">vgaHWSeqReset</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	        <span class="cm">/* clear synchronous reset */</span>

		<span class="n">VGAdisablePalette</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgaHWRestore</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span>  <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">savage_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">VGAwMISC</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VGAwSEQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Ensure CRTC registers 0-7 are unlocked by clearing bit 7 or</span>
<span class="cm">	   CRTC[17] */</span>
	<span class="n">VGAwCR</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VGAwCR</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VGAwGR</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">VGAenablePalette</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VGAwATTR</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">VGAdisablePalette</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vgaHWInit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">savagefb_par</span>            <span class="o">*</span><span class="n">par</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">xtimings</span>                <span class="o">*</span><span class="n">timings</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">savage_reg</span>              <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">))</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">))</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Time Sequencer</span>
<span class="cm">	 */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>          <span class="cm">/* Font select */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>          <span class="cm">/* Misc */</span>

	<span class="cm">/*</span>
<span class="cm">	 * CRTC Controller</span>
<span class="cm">	 */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">HTotal</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">HDisplay</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">HSyncStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">HSyncEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>  <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">HSyncStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">HSyncEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">HSyncEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VTotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VTotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
		<span class="mh">0x10</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VTotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">dblscan</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncEnd</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VDisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timings</span><span class="o">-&gt;</span><span class="n">VSyncEnd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc3</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * are these unnecessary?</span>
<span class="cm">	 * vgaHWHBlankKGA(mode, regp, 0, KGA_FIX_OVERSCAN|KGA_ENABLE_ON_ZERO);</span>
<span class="cm">	 * vgaHWVBlankKGA(mode, regp, 0, KGA_FIX_OVERSCAN|KGA_ENABLE_ON_ZERO);</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Graphics Display Controller</span>
<span class="cm">	 */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>   <span class="cm">/* only map 64k VGA memory !!!! */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>


	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* standard colormap translation */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0D</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------- Hardware specific routines ------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware Acceleration for SavageFB</span>
<span class="cm"> */</span>

<span class="cm">/* Wait for fifo space */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">savage3D_waitfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slots</span> <span class="o">=</span> <span class="n">MAXFIFO</span> <span class="o">-</span> <span class="n">space</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C00</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">slots</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">savage4_waitfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slots</span> <span class="o">=</span> <span class="n">MAXFIFO</span> <span class="o">-</span> <span class="n">space</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C60</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x001fffff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">slots</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">savage2000_waitfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slots</span> <span class="o">=</span> <span class="n">MAXFIFO</span> <span class="o">-</span> <span class="n">space</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C60</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">slots</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Wait for idle accelerator */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">savage3D_waitidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C00</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0008ffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">savage4_waitidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C60</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00a00000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00a00000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">savage2000_waitidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C60</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x009fffff</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FB_SAVAGE_ACCEL</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SavageSetup2DEngine</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span>  <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">GlobalBitmapDescriptor</span><span class="p">;</span>

	<span class="n">GlobalBitmapDescriptor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">BCI_BD_BW_DISABLE</span><span class="p">;</span>
	<span class="n">BCI_BD_SET_BPP</span><span class="p">(</span><span class="n">GlobalBitmapDescriptor</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">);</span>
	<span class="n">BCI_BD_SET_STRIDE</span><span class="p">(</span><span class="n">GlobalBitmapDescriptor</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">vwidth</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S3_SAVAGE3D</span>:
	<span class="k">case</span> <span class="n">S3_SAVAGE_MX</span>:
		<span class="cm">/* Disable BCI */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FF0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Setup BCI command overflow buffer */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C14</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_index</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">),</span>
			     <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Program shadow status update. */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C10</span><span class="p">,</span> <span class="mh">0x78207220</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C0C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Enable BCI and command overflow buffer */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S3_SAVAGE4</span>:
	<span class="k">case</span> <span class="n">S3_TWISTER</span>:
	<span class="k">case</span> <span class="n">S3_PROSAVAGE</span>:
	<span class="k">case</span> <span class="n">S3_PROSAVAGEDDR</span>:
	<span class="k">case</span> <span class="n">S3_SUPERSAVAGE</span>:
		<span class="cm">/* Disable BCI */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FF0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Program shadow status update */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C10</span><span class="p">,</span> <span class="mh">0x00700040</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C0C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Enable BCI without the COB */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S3_SAVAGE2000</span>:
		<span class="cm">/* Disable BCI */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Setup BCI command overflow buffer */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_index</span><span class="p">),</span>
			     <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Disable shadow status update */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48A30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* Enable BCI and command overflow buffer */</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">savage_in32</span><span class="p">(</span><span class="mh">0x48C18</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00280000</span><span class="p">,</span>
			     <span class="n">par</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Turn on 16-bit register access. */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Set stride to use GBD. */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Enable 2D engine. */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">savage_out32</span><span class="p">(</span><span class="n">MONO_PAT_0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">savage_out32</span><span class="p">(</span><span class="n">MONO_PAT_1</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Setup plane masks */</span>
	<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x8128</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* enable all write planes */</span>
	<span class="n">savage_out32</span><span class="p">(</span><span class="mh">0x812C</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* enable all read planes */</span>
	<span class="n">savage_out16</span><span class="p">(</span><span class="mh">0x8134</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">savage_out16</span><span class="p">(</span><span class="mh">0x8136</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Now set the GBD */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bci_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">BCI_CMD_SETREG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">BCI_GBD1</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">BCI_CMD_SETREG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">BCI_GBD2</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">GlobalBitmapDescriptor</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * I don&#39;t know why, sending this twice fixes the initial black screen,</span>
<span class="cm">	 * prevents X from crashing at least in Toshiba laptops with SavageIX.</span>
<span class="cm">	 * --Tony</span>
<span class="cm">	 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bci_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">BCI_CMD_SETREG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">BCI_GBD1</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">BCI_CMD_SETREG</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">BCI_GBD2</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">GlobalBitmapDescriptor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savagefb_set_clip</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">BCI_CMD_NOP</span> <span class="o">|</span> <span class="n">BCI_CMD_CLIP_NEW</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bci_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitFifo</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">BCI_CLIP_TL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">BCI_SEND</span><span class="p">(</span><span class="n">BCI_CLIP_BR</span><span class="p">(</span><span class="mh">0xfff</span><span class="p">,</span> <span class="mh">0xfff</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">SavageSetup2DEngine</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span>  <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SavageCalcClock</span><span class="p">(</span><span class="kt">long</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_n1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_n1</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">min_n2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_n2</span><span class="p">,</span> <span class="kt">long</span> <span class="n">freq_min</span><span class="p">,</span>
			    <span class="kt">long</span> <span class="n">freq_max</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mdiv</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ndiv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">diff</span><span class="p">,</span> <span class="n">best_diff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">best_n1</span><span class="o">=</span><span class="mi">16</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">best_n2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">best_m</span><span class="o">=</span><span class="mi">125</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">freq_min</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_n2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid frequency %ld Khz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">freq_min</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_n2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">freq_max</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">min_n2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid frequency %ld Khz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">freq_max</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">min_n2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* work out suitable timings */</span>
	<span class="n">best_diff</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n2</span><span class="o">=</span><span class="n">min_n2</span><span class="p">;</span> <span class="n">n2</span><span class="o">&lt;=</span><span class="n">max_n2</span><span class="p">;</span> <span class="n">n2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n1</span><span class="o">=</span><span class="n">min_n1</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="n">n1</span><span class="o">&lt;=</span><span class="n">max_n1</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="n">n1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n2</span><span class="p">)</span> <span class="o">+</span> <span class="n">HALF_BASE_FREQ</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">BASE_FREQ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">min_m</span><span class="o">+</span><span class="mi">2</span> <span class="o">||</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">BASE_FREQ</span> <span class="o">&gt;=</span> <span class="n">freq_min</span> <span class="o">*</span> <span class="n">n1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">BASE_FREQ</span> <span class="o">&lt;=</span> <span class="n">freq_max</span> <span class="o">*</span> <span class="n">n1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n2</span><span class="p">)</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">-</span> <span class="n">BASE_FREQ</span> <span class="o">*</span> <span class="n">m</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">diff</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">best_diff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">best_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
					<span class="n">best_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
					<span class="n">best_n1</span> <span class="o">=</span> <span class="n">n1</span><span class="p">;</span>
					<span class="n">best_n2</span> <span class="o">=</span> <span class="n">n2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ndiv</span> <span class="o">=</span> <span class="n">best_n1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">best_n2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">mdiv</span> <span class="o">=</span> <span class="n">best_m</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">common_calc_clock</span><span class="p">(</span><span class="kt">long</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_n1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_n1</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">min_n2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_n2</span><span class="p">,</span> <span class="kt">long</span> <span class="n">freq_min</span><span class="p">,</span>
			     <span class="kt">long</span> <span class="n">freq_max</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mdiv</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ndiv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">diff</span><span class="p">,</span> <span class="n">best_diff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">best_n1</span> <span class="o">=</span> <span class="mi">16</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">best_n2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">best_m</span> <span class="o">=</span> <span class="mi">125</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">best_diff</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n2</span> <span class="o">=</span> <span class="n">min_n2</span><span class="p">;</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="n">max_n2</span><span class="p">;</span> <span class="n">n2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n1</span> <span class="o">=</span> <span class="n">min_n1</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="n">n1</span> <span class="o">&lt;=</span> <span class="n">max_n1</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="n">n1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n2</span><span class="p">)</span> <span class="o">+</span> <span class="n">HALF_BASE_FREQ</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">BASE_FREQ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">min_m</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">BASE_FREQ</span> <span class="o">&gt;=</span> <span class="n">freq_min</span> <span class="o">*</span> <span class="n">n1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">BASE_FREQ</span> <span class="o">&lt;=</span> <span class="n">freq_max</span> <span class="o">*</span> <span class="n">n1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n2</span><span class="p">)</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">-</span> <span class="n">BASE_FREQ</span> <span class="o">*</span> <span class="n">m</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">diff</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">best_diff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">best_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
					<span class="n">best_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
					<span class="n">best_n1</span> <span class="o">=</span> <span class="n">n1</span><span class="p">;</span>
					<span class="n">best_n2</span> <span class="o">=</span> <span class="n">n2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_n1</span> <span class="o">==</span> <span class="mi">63</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ndiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_n1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">best_n2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">ndiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_n1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">best_n2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="o">*</span><span class="n">mdiv</span> <span class="o">=</span> <span class="n">best_m</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SAVAGEFB_DEBUG</span>
<span class="cm">/* This function is used to debug, it prints out the contents of s3 regs */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SavagePrintRegs</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vgaCRIndex</span> <span class="o">=</span> <span class="mh">0x3d4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vgaCRReg</span> <span class="o">=</span> <span class="mh">0x3d5</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SR    x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE &quot;</span>
	       <span class="s">&quot;xF&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x70</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">SR%xx &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">CR    x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC &quot;</span>
	       <span class="s">&quot;xD xE xF&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xB7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">CR%xx &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="n">vgaCRIndex</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">vga_in8</span><span class="p">(</span><span class="n">vgaCRReg</span><span class="p">,</span> <span class="n">par</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savage_get_default_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">savage_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">cr53</span><span class="p">,</span> <span class="n">cr66</span><span class="p">;</span>

	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x4838</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xa039</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0608</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr66</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr3a</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr53</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr53</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* unlock extended seq regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR08</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* now save all the extended regs we need */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR31</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR32</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR34</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR36</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3A</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR40</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR42</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR45</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR51</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR53</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR58</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR60</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR66</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR68</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR69</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR6F</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR33</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR86</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR88</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR90</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR91</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRB0</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/* extended mode timing regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3B</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3C</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR43</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5D</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5E</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR65</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* save seq extended regs for DCLK PLL programming */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0E</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0F</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR10</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR11</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR12</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR13</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR29</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR15</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR30</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR18</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Save flat panel expansion regsters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE_MX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x54</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR54</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr66</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr3a</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* now save MIU regs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">S3_SAVAGE_MX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR0</span> <span class="o">=</span> <span class="n">savage_in32</span><span class="p">(</span><span class="n">FIFO_CONTROL_REG</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR1</span> <span class="o">=</span> <span class="n">savage_in32</span><span class="p">(</span><span class="n">MIU_CONTROL_REG</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR2</span> <span class="o">=</span> <span class="n">savage_in32</span><span class="p">(</span><span class="n">STREAMS_TIMEOUT_REG</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR3</span> <span class="o">=</span> <span class="n">savage_in32</span><span class="p">(</span><span class="n">MISC_TIMEOUT_REG</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savage_set_default_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">savage_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">cr53</span><span class="p">,</span> <span class="n">cr66</span><span class="p">;</span>

	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x4838</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xa039</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0608</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr66</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr3a</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr53</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr53</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* unlock extended seq regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* now restore all the extended regs we need */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR32</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR34</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR36</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3A</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR42</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR45</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR51</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR58</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR60</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR68</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR69</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR6F</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR33</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR86</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR88</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR90</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR91</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRB0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* extended mode timing regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3B</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3C</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR43</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5D</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5E</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR65</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* save seq extended regs for DCLK PLL programming */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0E</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0F</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR11</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR12</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR13</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR29</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR15</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR30</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR18</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Save flat panel expansion regsters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE_MX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x54</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR54</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr66</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr3a</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* now save MIU regs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">S3_SAVAGE_MX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">FIFO_CONTROL_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">MIU_CONTROL_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR1</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">STREAMS_TIMEOUT_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR2</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">MISC_TIMEOUT_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR3</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savage_update_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">modedb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>
        <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">modedb</span><span class="o">-&gt;</span><span class="n">vmode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span>   <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">memlen</span><span class="p">,</span> <span class="n">vramlen</span><span class="p">,</span> <span class="n">mode_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_check_var&quot;</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dclkmax</span> <span class="o">||</span> <span class="o">!</span><span class="n">fb_validate_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
		<span class="n">mode_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* calculate modeline if supported by monitor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_valid</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">gtf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_get_mode</span><span class="p">(</span><span class="n">FB_MAXTIMINGS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
			<span class="n">mode_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

		<span class="n">mode</span> <span class="o">=</span> <span class="n">fb_find_best_mode</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">savage_update_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">mode_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_valid</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Is the mode larger than the LCD panel? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelWidth</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelWidth</span> <span class="o">||</span>
	     <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelHeight</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Mode (%dx%d) larger than the LCD panel &quot;</span>
		       <span class="s">&quot;(%dx%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span>  <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		       <span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelWidth</span><span class="p">,</span>
		       <span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelHeight</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="n">vramlen</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="n">memlen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">*</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memlen</span> <span class="o">&gt;</span> <span class="n">vramlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">vramlen</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span>
			<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="n">memlen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">*</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we must round yres/xres down, we already rounded y/xres_virtual up</span>
<span class="cm">	   if it was possible. We should return -EINVAL, but I disagree */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span>   <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">savagefb_par</span>        <span class="o">*</span><span class="n">par</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">savage_reg</span>          <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xtimings</span> <span class="n">timings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">dclk</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span> <span class="cm">/*, refresh; */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_decode_var&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timings</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pixclock</span><span class="p">)</span> <span class="n">pixclock</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>	<span class="cm">/* 10ns = 100MHz */</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">Clock</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">pixclock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="p">.</span><span class="n">Clock</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">timings</span><span class="p">.</span><span class="n">Clock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">dblscan</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">interlaced</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">HDisplay</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">HSyncStart</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">HDisplay</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">HSyncEnd</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">HSyncStart</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">HTotal</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">HSyncEnd</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">VDisplay</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">VSyncStart</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">VDisplay</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">VSyncEnd</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">VSyncStart</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">VTotal</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">VSyncEnd</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">timings</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>


	<span class="n">par</span><span class="o">-&gt;</span><span class="n">depth</span>  <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">vwidth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span>  <span class="o">&amp;&amp;</span>  <span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE3D</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timings</span><span class="p">.</span><span class="n">HDisplay</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">timings</span><span class="p">.</span><span class="n">HSyncStart</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">timings</span><span class="p">.</span><span class="n">HSyncEnd</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">timings</span><span class="p">.</span><span class="n">HTotal</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This will allocate the datastructure and initialize all of the</span>
<span class="cm">	 * generic VGA registers.</span>
<span class="cm">	 */</span>
	<span class="n">vgaHWInit</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timings</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* We need to set CR67 whether or not we use the BIOS. */</span>

	<span class="n">dclk</span> <span class="o">=</span> <span class="n">timings</span><span class="p">.</span><span class="n">Clock</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE2000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dclk</span> <span class="o">&gt;=</span> <span class="mi">230000</span><span class="p">))</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* 8bpp, 2 pixels/clock */</span>
		<span class="k">else</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 8bpp, 1 pixel/clock */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">S3_SAVAGE_MOBILE_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE2000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dclk</span> <span class="o">&gt;=</span> <span class="mi">230000</span><span class="p">)))</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>	<span class="cm">/* 15bpp, 2 pixel/clock */</span>
		<span class="k">else</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* 15bpp, 1 pixels/clock */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">S3_SAVAGE_MOBILE_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE2000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dclk</span> <span class="o">&gt;=</span> <span class="mi">230000</span><span class="p">)))</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>	<span class="cm">/* 16bpp, 2 pixel/clock */</span>
		<span class="k">else</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* 16bpp, 1 pixels/clock */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Either BIOS use is disabled, or we failed to find a suitable</span>
<span class="cm">	 * match.  Fall back to traditional register-crunching.</span>
<span class="cm">	 */</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="cm">/*FIXME:psav-&gt;pci_burst*/</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3A</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x15</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3A</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x95</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR53</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR31</span> <span class="o">=</span> <span class="mh">0x8c</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR66</span> <span class="o">=</span> <span class="mh">0x89</span><span class="p">;</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR58</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR58</span> <span class="o">|=</span> <span class="mh">0x13</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR15</span> <span class="o">=</span> <span class="mh">0x03</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR18</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR43</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR45</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR65</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR40</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR0</span> <span class="o">=</span> <span class="mh">0x010400</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR1</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR2</span> <span class="o">=</span> <span class="mh">0x0808</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR3</span> <span class="o">=</span> <span class="mh">0x08080810</span><span class="p">;</span>

	<span class="n">SavageCalcClock</span><span class="p">(</span><span class="n">dclk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">180000</span><span class="p">,</span> <span class="mi">360000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="cm">/* m = 107; n = 4; r = 2; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">MCLK</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR10</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR11</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">common_calc_clock</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">MCLK</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">135000</span><span class="p">,</span> <span class="mi">270000</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR10</span><span class="p">);</span>
		<span class="cm">/*      reg-&gt;SR10 = 80; // MCLK == 286000 */</span>
		<span class="cm">/*      reg-&gt;SR11 = 125; */</span>
	<span class="p">}</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR12</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR13</span> <span class="o">=</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR29</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR0</span> <span class="o">-=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR0</span> <span class="o">-=</span> <span class="mh">0x4000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timings</span><span class="p">.</span><span class="n">interlaced</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR42</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR42</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR34</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* display fifo */</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">((((</span><span class="n">timings</span><span class="p">.</span><span class="n">HTotal</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((((</span><span class="n">timings</span><span class="p">.</span><span class="n">HDisplay</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((((</span><span class="n">timings</span><span class="p">.</span><span class="n">HSyncStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">timings</span><span class="p">.</span><span class="n">HSyncStart</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">timings</span><span class="p">.</span><span class="n">HSyncEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">timings</span><span class="p">.</span><span class="n">HSyncStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">timings</span><span class="p">.</span><span class="n">HSyncEnd</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">timings</span><span class="p">.</span><span class="n">HSyncStart</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
	     <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span>
		    <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3B</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3C</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5D</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5E</span> <span class="o">=</span> <span class="p">(((</span><span class="n">timings</span><span class="p">.</span><span class="n">VTotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="p">.</span><span class="n">VDisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="p">.</span><span class="n">VSyncStart</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">timings</span><span class="p">.</span><span class="n">VSyncStart</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR91</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR51</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x300</span> <span class="o">&amp;</span> <span class="n">width</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR90</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">|=</span> <span class="mh">0x0c</span><span class="p">;</span>

	<span class="cm">/* Set frame buffer description. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;=</span> <span class="mi">640</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">==</span> <span class="mi">800</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">==</span> <span class="mi">1152</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">==</span> <span class="mi">1280</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">|=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">==</span> <span class="mi">1600</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">|=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span> <span class="o">|=</span> <span class="mh">0xc1</span><span class="p">;</span>	<span class="cm">/* Use GBD */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE2000</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR33</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR33</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xeb</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR36</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR68</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR69</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR6F</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR86</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR88</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRB0</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> *    Set a single color register. Return != 0 for invalid regno.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span>        <span class="n">regno</span><span class="p">,</span>
			      <span class="kt">unsigned</span>        <span class="n">red</span><span class="p">,</span>
			      <span class="kt">unsigned</span>        <span class="n">green</span><span class="p">,</span>
			      <span class="kt">unsigned</span>        <span class="n">blue</span><span class="p">,</span>
			      <span class="kt">unsigned</span>        <span class="n">transp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">NR_PALETTE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">].</span><span class="n">red</span>    <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">].</span><span class="n">green</span>  <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">].</span><span class="n">blue</span>   <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">].</span><span class="n">transp</span> <span class="o">=</span> <span class="n">transp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c8</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c9</span><span class="p">,</span> <span class="n">red</span>   <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c9</span><span class="p">,</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c9</span><span class="p">,</span> <span class="n">blue</span>  <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">red</span>   <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span>      <span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">blue</span>  <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">red</span>    <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">green</span>  <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span>      <span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">blue</span>   <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">transp</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">red</span>    <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">green</span>  <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span>      <span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">blue</span>   <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savagefb_set_par_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span>  <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">savage_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">cr67</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_set_par_int&quot;</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitIdle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c2</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x4838</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xa539</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0608</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vgaHWProtect</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some Savage/MX and /IX systems go nuts when trying to exit the</span>
<span class="cm">	 * server after WindowMaker has displayed a gradient background.  I</span>
<span class="cm">	 * haven&#39;t been able to find what causes it, but a non-destructive</span>
<span class="cm">	 * switch to mode 3 here seems to eliminate the issue.</span>
<span class="cm">	 */</span>

	<span class="n">VerticalRetraceWait</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr67</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr67</span><span class="cm">/*par-&gt;CR67*/</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0c</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* no STREAMS yet */</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* restore extended regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3A</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR32</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR58</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR53</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0608</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Restore DCLK registers. */</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0E</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0F</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR29</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR15</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Restore flat panel expansion regsters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE_MX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x54</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR54</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">par</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vgaHWRestore</span> <span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* extended mode timing registers */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR53</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5D</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR5E</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3B</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR3C</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR43</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR65</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* restore the desired video mode with cr67 */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="cm">/* following part not present in X11 driver */</span>
	<span class="n">cr67</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="mh">0x50</span> <span class="o">|</span> <span class="n">cr67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="cm">/* end of part */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0c</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* other mode timing and extended regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR34</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR42</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR45</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR50</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR51</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* memory timings */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR36</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR60</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR68</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR69</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR6F</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR33</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR86</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR88</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR90</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR91</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CRB0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR32</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* unlock extended seq regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Restore extended sequencer regs for MCLK. SR10 == 255 indicates</span>
<span class="cm">	 * that we should leave the default SR10 and SR11 values there.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR10</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR11</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* restore extended seq regs for dclk */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0E</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR0F</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR12</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR13</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR29</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR18</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* load new m, n pll values for dclk &amp; mclk */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x21</span><span class="p">;</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR15</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR30</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">SR08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* now write out cr67 in full, possibly starting STREAMS */</span>
	<span class="n">VerticalRetraceWait</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">CR67</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr66</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr3a</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">S3_SAVAGE_MX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VerticalRetraceWait</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">FIFO_CONTROL_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR0</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitIdle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">MIU_CONTROL_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR1</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitIdle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">STREAMS_TIMEOUT_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR2</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitIdle</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
		<span class="n">savage_out32</span><span class="p">(</span><span class="n">MISC_TIMEOUT_REG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">MMPR3</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3a</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">SavageSetup2DEngine</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">vgaHWProtect</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savagefb_update_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* program the start address registers */</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="p">((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x7f0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">savagefb_set_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span>      <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span>      <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span>    <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_set_par&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">savagefb_decode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">dacSpeedBpp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dacSpeedBpp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dacSpeedBpp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">))</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dacSpeedBpp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">dacSpeedBpp</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Set ramdac limits */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">maxClock</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dacSpeedBpp</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">minClock</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">savagefb_set_par_int</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">savagefb_set_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">savagefb_set_clip</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">SavagePrintRegs</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *    Pan or Wrap the Display</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_info</span>           <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span>
	     <span class="o">+</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">savagefb_update_start</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sr8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">srd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">DISP_CRT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">sr8</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">sr8</span> <span class="o">|=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">sr8</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">srd</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">srd</span> <span class="o">&amp;=</span> <span class="mh">0x50</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
			<span class="n">srd</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
			<span class="n">srd</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
			<span class="n">srd</span> <span class="o">|=</span> <span class="mh">0x50</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">srd</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">DISP_LCD</span> <span class="o">||</span>
	    <span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">DISP_DFP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* SR31 bit 4 - FP enable */</span>
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span> <span class="cm">/* SR31 bit 4 - FP enable */</span>
			<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">blank</span> <span class="o">==</span> <span class="n">FB_BLANK_NORMAL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vgastate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vgastate</span><span class="p">));</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vgastate</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">VGA_SAVE_CMAP</span> <span class="o">|</span> <span class="n">VGA_SAVE_FONTS</span> <span class="o">|</span>
			<span class="n">VGA_SAVE_MODE</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">vgastate</span><span class="p">.</span><span class="n">vgabase</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span> <span class="o">+</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">save_vga</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vgastate</span><span class="p">);</span>
		<span class="n">savage_get_default_par</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">initial</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">savage_set_default_par</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">initial</span><span class="p">);</span>
		<span class="n">restore_vga</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">vgastate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">savagefb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>          <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>        <span class="o">=</span> <span class="n">savagefb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>     <span class="o">=</span> <span class="n">savagefb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>   <span class="o">=</span> <span class="n">savagefb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>     <span class="o">=</span> <span class="n">savagefb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>   <span class="o">=</span> <span class="n">savagefb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">savagefb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>       <span class="o">=</span> <span class="n">savagefb_blank</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_FB_SAVAGE_ACCEL)</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>    <span class="o">=</span> <span class="n">savagefb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>    <span class="o">=</span> <span class="n">savagefb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>   <span class="o">=</span> <span class="n">savagefb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_sync</span>        <span class="o">=</span> <span class="n">savagefb_sync</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>    <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>    <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>   <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">__devinitdata</span> <span class="n">savagefb_var800x600x8</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span>	<span class="n">FB_ACCELF_TEXT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres</span> <span class="o">=</span>		<span class="mi">800</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> <span class="o">=</span>		<span class="mi">600</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span>  <span class="mi">800</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span>  <span class="mi">600</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span>	<span class="mi">25000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span>	<span class="mi">88</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span> <span class="o">=</span>	<span class="mi">40</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span>	<span class="mi">23</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span> <span class="o">=</span>	<span class="mi">128</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span> <span class="o">=</span>	<span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span> <span class="o">=</span>		<span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span> <span class="o">=</span>	<span class="n">FB_VMODE_NONINTERLACED</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savage_enable_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_enable_mmio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c3</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c3</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3cc</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c2</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">S3_SAVAGE4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">savage_disable_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_disable_mmio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&gt;=</span> <span class="n">S3_SAVAGE4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">savage_map_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_map_mmio&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S3_SAVAGE3D_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">pbase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">SAVAGE_NEWMMIO_REGBASE_S3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">pbase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">SAVAGE_NEWMMIO_REGBASE_S4</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">SAVAGE_NEWMMIO_REGSIZE</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">pbase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;savagefb: unable to map memory mapped IO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;savagefb: mapped io at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">pbase</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span>   <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bci_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">BCI_BUFFER_OFFSET</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">bci_ptr</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">savage_enable_mmio</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savage_unmap_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_unmap_mmio&quot;</span><span class="p">);</span>

	<span class="n">savage_disable_mmio</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">vbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">savage_map_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">video_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resource</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_map_video&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S3_SAVAGE3D_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">resource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">resource</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">pbase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="n">video_len</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">pbase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;savagefb: unable to map screen memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;savagefb: mapped framebuffer at %p, &quot;</span>
		       <span class="s">&quot;pbase == %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">pbase</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">pbase</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>   <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_size</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span>    <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">mtrr</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">pbase</span><span class="p">,</span> <span class="n">video_len</span><span class="p">,</span>
				   <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Clear framebuffer, it&#39;s all white in memory after boot */</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">savage_unmap_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_unmap_video&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">mtrr</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">pbase</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">vbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savage_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">config1</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">sr8</span><span class="p">,</span> <span class="n">cr3f</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RamSavage3D</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RamSavage4</span><span class="p">[]</span> <span class="o">=</span>  <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RamSavageMX</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RamSavageNB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">videoRam</span><span class="p">,</span> <span class="n">videoRambytes</span><span class="p">,</span> <span class="n">dvi</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_init_hw&quot;</span><span class="p">);</span>

	<span class="cm">/* unprotect CRTC[0-7] */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* unlock extended regs */</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x4838</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0xa039</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x0608</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* unlock sys regs */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Unlock system registers. */</span>
	<span class="n">vga_out16</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x4838</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Next go on to detect amount of installed ram */</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>            <span class="cm">/* for register CR36 (CONFG_REG1), */</span>
	<span class="n">config1</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>    <span class="cm">/* get amount of vram installed */</span>

	<span class="cm">/* Compute the amount of video memory and offscreen memory. */</span>

	<span class="k">switch</span>  <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S3_SAVAGE3D</span>:
		<span class="n">videoRam</span> <span class="o">=</span> <span class="n">RamSavage3D</span><span class="p">[(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="p">]</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3_SAVAGE4</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The Savage4 has one ugly special case to consider.  On</span>
<span class="cm">		 * systems with 4 banks of 2Mx32 SDRAM, the BIOS says 4MB</span>
<span class="cm">		 * when it really means 8MB.  Why do it the same when you</span>
<span class="cm">		 * can do it different...</span>
<span class="cm">		 */</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>	<span class="cm">/* memory control 1 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">RamSavage4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="cm">/*FALLTHROUGH*/</span>

	<span class="k">case</span> <span class="n">S3_SAVAGE2000</span>:
		<span class="n">videoRam</span> <span class="o">=</span> <span class="n">RamSavage4</span><span class="p">[(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3_SAVAGE_MX</span>:
	<span class="k">case</span> <span class="n">S3_SUPERSAVAGE</span>:
		<span class="n">videoRam</span> <span class="o">=</span> <span class="n">RamSavageMX</span><span class="p">[(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x0E</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3_PROSAVAGE</span>:
	<span class="k">case</span> <span class="n">S3_PROSAVAGEDDR</span>:
	<span class="k">case</span> <span class="n">S3_TWISTER</span>:
		<span class="n">videoRam</span> <span class="o">=</span> <span class="n">RamSavageNB</span><span class="p">[(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* How did we get here? */</span>
		<span class="n">videoRam</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">videoRambytes</span> <span class="o">=</span> <span class="n">videoRam</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;savagefb: probed videoram:  %dk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">videoRam</span><span class="p">);</span>

	<span class="cm">/* reset graphics engine to avoid memory corruption */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr66</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr66</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>	<span class="cm">/* clear reset flag */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * reset memory interface, 3D engine, AGP master, PCI master,</span>
<span class="cm">	 * master engine unit, motion compensation/LPB</span>
<span class="cm">	 */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">cr3f</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3f</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d4</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3d5</span><span class="p">,</span> <span class="n">cr3f</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>	<span class="cm">/* clear reset flags */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Savage ramdac speeds */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">numClocks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">220000</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">220000</span><span class="p">;</span>

	<span class="cm">/* detect current mclk */</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">sr8</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">sr8</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">n1</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">n2</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">MCLK</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1431818</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;savagefb: Detected current MCLK value of %d kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">MCLK</span><span class="p">);</span>

	<span class="cm">/* check for DVI/flat panel */</span>
	<span class="n">dvi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sr30</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c4</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="cm">/* clear bit 1 */</span>
		<span class="n">vga_out8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="n">sr30</span> <span class="o">=</span> <span class="n">vga_in8</span><span class="p">(</span><span class="mh">0x3c5</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sr30</span> <span class="o">&amp;</span> <span class="mh">0x02</span> <span class="cm">/*0x04 */</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;savagefb: Digital Flat Panel Detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">S3_SAVAGE_MOBILE_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">S3_MOBILE_TWISTER_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">crtonly</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">=</span> <span class="n">DISP_LCD</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dvi</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">S3_SAVAGE4</span> <span class="o">&amp;&amp;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">dvi</span><span class="p">))</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">=</span> <span class="n">DISP_DFP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">=</span> <span class="n">DISP_CRT</span><span class="p">;</span>

	<span class="cm">/* Check LCD panel parrmation */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">==</span> <span class="n">DISP_LCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cr6b</span> <span class="o">=</span> <span class="n">VGArCR</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>

		<span class="kt">int</span> <span class="n">panelX</span> <span class="o">=</span> <span class="p">(</span><span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">((</span><span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x66</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">panelY</span> <span class="o">=</span> <span class="p">(</span><span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x69</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">((</span><span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x6e</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="kt">char</span> <span class="o">*</span> <span class="n">sTechnology</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>

		<span class="cm">/* OK, I admit it.  I don&#39;t know how to limit the max dot clock</span>
<span class="cm">		 * for LCD panels of various sizes.  I thought I copied the</span>
<span class="cm">		 * formula from the BIOS, but many users have parrmed me of</span>
<span class="cm">		 * my folly.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Instead, I&#39;ll abandon any attempt to automatically limit the</span>
<span class="cm">		 * clock, and add an LCDClock option to XF86Config.  Some day,</span>
<span class="cm">		 * I should come back to this.</span>
<span class="cm">		 */</span>

		<span class="k">enum</span> <span class="n">ACTIVE_DISPLAYS</span> <span class="p">{</span> <span class="cm">/* These are the bits in CR6B */</span>
			<span class="n">ActiveCRT</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
			<span class="n">ActiveLCD</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
			<span class="n">ActiveTV</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
			<span class="n">ActiveCRT2</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
			<span class="n">ActiveDUO</span> <span class="o">=</span> <span class="mh">0x80</span>
		<span class="p">};</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x39</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sTechnology</span> <span class="o">=</span> <span class="s">&quot;TFT&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">VGArSEQ</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sTechnology</span> <span class="o">=</span> <span class="s">&quot;DSTN&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> 	<span class="p">{</span>
			<span class="n">sTechnology</span> <span class="o">=</span> <span class="s">&quot;STN&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;savagefb: %dx%d %s LCD panel detected %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">panelX</span><span class="p">,</span> <span class="n">panelY</span><span class="p">,</span> <span class="n">sTechnology</span><span class="p">,</span>
		       <span class="n">cr6b</span> <span class="o">&amp;</span> <span class="n">ActiveLCD</span> <span class="o">?</span> <span class="s">&quot;and active&quot;</span> <span class="o">:</span> <span class="s">&quot;but not active&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cr6b</span> <span class="o">&amp;</span> <span class="n">ActiveLCD</span><span class="p">)</span> 	<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the LCD is active and panel expansion is enabled,</span>
<span class="cm">			 * we probably want to kill the HW cursor.</span>
<span class="cm">			 */</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;savagefb: Limiting video mode to &quot;</span>
				<span class="s">&quot;%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">panelX</span><span class="p">,</span> <span class="n">panelY</span><span class="p">);</span>

			<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelWidth</span> <span class="o">=</span> <span class="n">panelX</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelHeight</span> <span class="o">=</span> <span class="n">panelY</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">display_type</span> <span class="o">=</span> <span class="n">DISP_CRT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">savage_get_default_par</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">save</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S3_SAVAGE4_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The Savage4 and ProSavage have COB coherency bugs which</span>
<span class="cm">		 * render the buffer useless.  We disable it.</span>
<span class="cm">		 */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_size</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_index</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_offset</span> <span class="o">=</span> <span class="n">videoRambytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We use 128kB for the COB on all chips. */</span>

		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_index</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_size</span>   <span class="o">=</span> <span class="mh">0x400</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_index</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_offset</span> <span class="o">=</span> <span class="n">videoRambytes</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">cob_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">videoRambytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">savage_init_fb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pcidev</span>  <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span>	   <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span>	   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span>	   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span>       <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SUPERSAVAGE</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;SuperSavage&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE4</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE4</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage4&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE3D</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE3D</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage3D&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE3D_MV</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE3D</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage3D-MV&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE2000</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE2000</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage2000&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE_MX_MV</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE_MX</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage/MX-MV&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE_MX</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE_MX</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage/MX&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE_IX_MV</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE_MX</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage/IX-MV&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_SAVAGE_IX</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_SAVAGE_MX</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;Savage/IX&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_PROSAVAGE_PM</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_PROSAVAGE</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;ProSavagePM&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_PROSAVAGE_KM</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_PROSAVAGE</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;ProSavageKM&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_S3TWISTER_P</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_TWISTER</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;TwisterP&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_S3TWISTER_K</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_TWISTER</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;TwisterK&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_PROSAVAGE_DDR</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_PROSAVAGEDDR</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;ProSavageDDR&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_ACCEL_PROSAVAGE_DDRK</span>:
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">S3_PROSAVAGEDDR</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;ProSavage8&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S3_SAVAGE3D_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitIdle</span> <span class="o">=</span> <span class="n">savage3D_waitidle</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitFifo</span> <span class="o">=</span> <span class="n">savage3D_waitfifo</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S3_SAVAGE4_SERIES</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">S3_SUPERSAVAGE</span> <span class="o">==</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitIdle</span> <span class="o">=</span> <span class="n">savage4_waitidle</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitFifo</span> <span class="o">=</span> <span class="n">savage4_waitfifo</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitIdle</span> <span class="o">=</span> <span class="n">savage2000_waitidle</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">SavageWaitFifo</span> <span class="o">=</span> <span class="n">savage2000_waitfifo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>    <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">width</span>       <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">height</span>      <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">savagefb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span>          <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span>
		               <span class="n">FBINFO_HWACCEL_YPAN</span> <span class="o">|</span>
		               <span class="n">FBINFO_HWACCEL_XPAN</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_FB_SAVAGE_ACCEL)</span>
	<span class="cm">/* FIFO size + padding for commands */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">scan_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">buf_align</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">access_align</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">NR_PALETTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FBINFO_HWACCEL_COPYAREA</span> <span class="o">|</span>
	                       <span class="n">FBINFO_HWACCEL_FILLRECT</span> <span class="o">|</span>
		               <span class="n">FBINFO_HWACCEL_IMAGEBLIT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">savagefb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span><span class="o">*</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">h_sync</span><span class="p">,</span> <span class="n">v_sync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">lpitch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">video_len</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_probe&quot;</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">savagefb_par</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;savagefb&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot request PCI regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">savage_init_fb_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">failed_init</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">savage_map_mmio</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_mmio</span><span class="p">;</span>

	<span class="n">video_len</span> <span class="o">=</span> <span class="n">savage_init_hw</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="cm">/* FIXME: can&#39;t be negative */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">video_len</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mmio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">savage_map_video</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">video_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_video</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_FB_SAVAGE_I2C)</span>
	<span class="n">savagefb_create_i2c_busses</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">savagefb_probe_i2c_connector</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">);</span>
	<span class="n">fb_edid_to_monspecs</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">);</span>
	<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">savagefb_var800x600x8</span><span class="p">;</span>
	<span class="cm">/* if a panel was detected, default to a CVT mode instead */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelWidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">cvt_mode</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cvt_mode</span><span class="p">));</span>
		<span class="n">cvt_mode</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelWidth</span><span class="p">;</span>
		<span class="n">cvt_mode</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">SavagePanelHeight</span><span class="p">;</span>
		<span class="n">cvt_mode</span><span class="p">.</span><span class="n">refresh</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="cm">/* FIXME: if we know there is only the panel</span>
<span class="cm">		 * we can enable reduced blanking as well */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb_find_mode_cvt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;No CVT mode found for panel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">cvt_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">savagefb_var800x600x8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_option</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb_len</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

		<span class="n">mode</span> <span class="o">=</span> <span class="n">fb_find_best_display</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>
		<span class="n">savage_update_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* maximize virtual vertical length */</span>
	<span class="n">lpitch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="o">*</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="o">/</span><span class="n">lpitch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_FB_SAVAGE_ACCEL)</span>
	<span class="cm">/*</span>
<span class="cm">	 * The clipping coordinates are masked with 0xFFF, so limit our</span>
<span class="cm">	 * virtual resolutions to these sizes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="mh">0x1000</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">&gt;</span> <span class="mh">0x1000</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">savagefb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">savagefb_set_fix</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate the hsync and vsync frequencies.  Note that</span>
<span class="cm">	 * we split the 1e12 constant up so that we can preserve</span>
<span class="cm">	 * the precision and fit the results into 32-bit registers.</span>
<span class="cm">	 *  (1953125000 * 512 = 1e12)</span>
<span class="cm">	 */</span>
	<span class="n">h_sync</span> <span class="o">=</span> <span class="mi">1953125000</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">;</span>
	<span class="n">h_sync</span> <span class="o">=</span> <span class="n">h_sync</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">/</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">+</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">+</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">);</span>
	<span class="n">v_sync</span> <span class="o">=</span> <span class="n">h_sync</span> <span class="o">/</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">+</span>
			   <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;savagefb v&quot;</span> <span class="n">SAVAGEFB_VERSION</span> <span class="s">&quot;: &quot;</span>
	       <span class="s">&quot;%dkB VRAM, using %dx%d, %d.%03dkHz, %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
	       <span class="n">h_sync</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">h_sync</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">v_sync</span><span class="p">);</span>


	<span class="n">fb_destroy_modedb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">modedb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb: S3 %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Our driver data</span>
<span class="cm">	 */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">failed:</span>
<span class="cp">#ifdef CONFIG_FB_SAVAGE_I2C</span>
	<span class="n">savagefb_delete_i2c_busses</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">savage_unmap_video</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
 <span class="nl">failed_video:</span>
	<span class="n">savage_unmap_mmio</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
 <span class="nl">failed_mmio:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
 <span class="nl">failed_init:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">failed_enable:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">savagefb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_remove&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If unregister_framebuffer fails, then</span>
<span class="cm">		 * we will be leaving hooks that could cause</span>
<span class="cm">		 * oopsen laying around.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;savagefb: danger danger! &quot;</span>
			       <span class="s">&quot;Oopsen imminent!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB_SAVAGE_I2C</span>
		<span class="n">savagefb_delete_i2c_busses</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">savage_unmap_video</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">savage_unmap_mmio</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pixmap</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Ensure that the driver data is no longer</span>
<span class="cm">		 * valid.</span>
<span class="cm">		 */</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_suspend&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_PRETHAW</span><span class="p">)</span>
		<span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">PM_EVENT_FREEZE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pm_state</span> <span class="o">=</span> <span class="n">mesg</span><span class="p">.</span><span class="n">event</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">mesg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For PM_EVENT_FREEZE, do not power down so the console</span>
<span class="cm">	 * can remain active.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_FREEZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">savagefb_blank</span><span class="p">(</span><span class="n">FB_BLANK_POWERDOWN</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">savage_set_default_par</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">);</span>
	<span class="n">savage_disable_mmio</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mesg</span><span class="p">));</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">savagefb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">savagefb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_state</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">pm_state</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_resume&quot;</span><span class="p">);</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pm_state</span> <span class="o">=</span> <span class="n">PM_EVENT_ON</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The adapter was not powered down coming back from a</span>
<span class="cm">	 * PM_EVENT_FREEZE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_state</span> <span class="o">==</span> <span class="n">PM_EVENT_FREEZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;err&quot;</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">savage_enable_mmio</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">savage_init_hw</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">savagefb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">savagefb_blank</span><span class="p">(</span><span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">savagefb_devices</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_MX128</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_MX64</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_MX64C</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_IX128SDR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_IX128DDR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_IX64SDR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_IX64DDR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_IXCSDR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SUPSAV_IXCDDR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SUPERSAVAGE</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE4</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE4</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE3D</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE3D</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE3D_MV</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE3D_MV</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE2000</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE2000</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE_MX_MV</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE_MX_MV</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE_MX</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE_MX</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE_IX_MV</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE_IX_MV</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_SAVAGE_IX</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_SAVAGE_IX</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_PROSAVAGE_PM</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_PROSAVAGE_PM</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_PROSAVAGE_KM</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_PROSAVAGE_KM</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_S3TWISTER_P</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_S3TWISTER_P</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_S3TWISTER_K</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_S3TWISTER_K</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_PROSAVAGE_DDR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_PROSAVAGE_DDR</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S3</span><span class="p">,</span> <span class="n">PCI_CHIP_PROSAVAGE_DDRK</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FB_ACCEL_PROSAVAGE_DDRK</span><span class="p">},</span>

	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">savagefb_devices</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">savagefb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>     <span class="s">&quot;savagefb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">savagefb_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>    <span class="n">savagefb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>  <span class="n">savagefb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>   <span class="n">savagefb_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>   <span class="n">__devexit_p</span><span class="p">(</span><span class="n">savagefb_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/* **************************** exit-time only **************************** */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">savage_done</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savage_done&quot;</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">savagefb_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ************************* init in-kernel code ************************** */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">savagefb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">savagefb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;savagefb_init&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;savagefb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">savagefb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">savagefb_driver</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">savagefb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">savage_done</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode_option</span><span class="p">,</span> <span class="s">&quot;Specify initial video mode&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
