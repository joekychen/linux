<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › hgafb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hgafb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/hgafb.c -- Hercules graphics adaptor frame buffer device</span>
<span class="cm"> * </span>
<span class="cm"> *      Created 25 Nov 1999 by Ferenc Bakonyi (fero@drama.obuda.kando.hu)</span>
<span class="cm"> *      Based on skeletonfb.c by Geert Uytterhoeven and</span>
<span class="cm"> *               mdacon.c by Andrew Apted</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> *</span>
<span class="cm"> * - Revision 0.1.8 (23 Oct 2002): Ported to new framebuffer api.</span>
<span class="cm"> * </span>
<span class="cm"> * - Revision 0.1.7 (23 Jan 2001): fix crash resulting from MDA only cards </span>
<span class="cm"> *				   being detected as Hercules.	 (Paul G.)</span>
<span class="cm"> * - Revision 0.1.6 (17 Aug 2000): new style structs</span>
<span class="cm"> *                                 documentation</span>
<span class="cm"> * - Revision 0.1.5 (13 Mar 2000): spinlocks instead of saveflags();cli();etc</span>
<span class="cm"> *                                 minor fixes</span>
<span class="cm"> * - Revision 0.1.4 (24 Jan 2000): fixed a bug in hga_card_detect() for </span>
<span class="cm"> *                                  HGA-only systems</span>
<span class="cm"> * - Revision 0.1.3 (22 Jan 2000): modified for the new fb_info structure</span>
<span class="cm"> *                                 screen is cleared after rmmod</span>
<span class="cm"> *                                 virtual resolutions</span>
<span class="cm"> *                                 module parameter &#39;nologo={0|1}&#39;</span>
<span class="cm"> *                                 the most important: boot logo :)</span>
<span class="cm"> * - Revision 0.1.0  (6 Dec 1999): faster scrolling and minor fixes</span>
<span class="cm"> * - First release  (25 Nov 1999)</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/vga.h&gt;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define DPRINTK(args...) printk(KERN_DEBUG __FILE__&quot;: &quot; ##args)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(args...)</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define CHKINFO(ret) if (info != &amp;fb_info) { printk(KERN_DEBUG __FILE__&quot;: This should never happen, line:%d \n&quot;, __LINE__); return ret; }</span>
<span class="cp">#else</span>
<span class="cp">#define CHKINFO(ret)</span>
<span class="cp">#endif</span>

<span class="cm">/* Description of the hardware layout */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hga_vram</span><span class="p">;</span>			<span class="cm">/* Base of video memory */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hga_vram_len</span><span class="p">;</span>		<span class="cm">/* Size of video memory */</span>

<span class="cp">#define HGA_ROWADDR(row) ((row%4)*8192 + (row&gt;&gt;2)*90)</span>
<span class="cp">#define HGA_TXT			0</span>
<span class="cp">#define HGA_GFX			1</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="nf">rowaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">row</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">HGA_ROWADDR</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hga_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* 0 = txt, 1 = gfx mode */</span>

<span class="k">static</span> <span class="k">enum</span> <span class="p">{</span> <span class="n">TYPE_HERC</span><span class="p">,</span> <span class="n">TYPE_HERCPLUS</span><span class="p">,</span> <span class="n">TYPE_HERCCOLOR</span> <span class="p">}</span> <span class="n">hga_type</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hga_type_name</span><span class="p">;</span>

<span class="cp">#define HGA_INDEX_PORT		0x3b4		</span><span class="cm">/* Register select port */</span><span class="cp"></span>
<span class="cp">#define HGA_VALUE_PORT		0x3b5		</span><span class="cm">/* Register value port */</span><span class="cp"></span>
<span class="cp">#define HGA_MODE_PORT		0x3b8		</span><span class="cm">/* Mode control port */</span><span class="cp"></span>
<span class="cp">#define HGA_STATUS_PORT		0x3ba		</span><span class="cm">/* Status and Config port */</span><span class="cp"></span>
<span class="cp">#define HGA_GFX_PORT		0x3bf		</span><span class="cm">/* Graphics control port */</span><span class="cp"></span>

<span class="cm">/* HGA register values */</span>

<span class="cp">#define HGA_CURSOR_BLINKING	0x00</span>
<span class="cp">#define HGA_CURSOR_OFF		0x20</span>
<span class="cp">#define HGA_CURSOR_SLOWBLINK	0x60</span>

<span class="cp">#define HGA_MODE_GRAPHICS	0x02</span>
<span class="cp">#define HGA_MODE_VIDEO_EN	0x08</span>
<span class="cp">#define HGA_MODE_BLINK_EN	0x20</span>
<span class="cp">#define HGA_MODE_GFX_PAGE1	0x80</span>

<span class="cp">#define HGA_STATUS_HSYNC	0x01</span>
<span class="cp">#define HGA_STATUS_VSYNC	0x80</span>
<span class="cp">#define HGA_STATUS_VIDEO	0x08</span>

<span class="cp">#define HGA_CONFIG_COL132	0x08</span>
<span class="cp">#define HGA_GFX_MODE_EN		0x01</span>
<span class="cp">#define HGA_GFX_PAGE_EN		0x02</span>

<span class="cm">/* Global locks */</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">hga_reg_lock</span><span class="p">);</span>

<span class="cm">/* Framebuffer driver structures */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">hga_default_var</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span> 		<span class="o">=</span> <span class="mi">348</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span> 	<span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span>	<span class="o">=</span> <span class="mi">348</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span> 		<span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">green</span> 		<span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span> 		<span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">transp</span> 	<span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">height</span> 	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span> 		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">hga_fix</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> 		<span class="o">=</span> <span class="s">&quot;HGA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> 		<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>	<span class="cm">/* (not sure) */</span>
	<span class="p">.</span><span class="n">visual</span> 	<span class="o">=</span> <span class="n">FB_VISUAL_MONO10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span> 	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span> 	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_length</span> 	<span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span> 		<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span>
<span class="p">};</span>

<span class="cm">/* Don&#39;t assume that tty1 will be the initial current console. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">release_io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">release_io_ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nologo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* -------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Low level hardware functions</span>
<span class="cm"> *</span>
<span class="cm"> * ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_hga_b</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HGA_INDEX_PORT</span><span class="p">);</span> 
	<span class="n">outb_p</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">HGA_VALUE_PORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_hga_w</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span>   <span class="n">HGA_INDEX_PORT</span><span class="p">);</span> <span class="n">outb_p</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>   <span class="n">HGA_VALUE_PORT</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">HGA_INDEX_PORT</span><span class="p">);</span> <span class="n">outb_p</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">HGA_VALUE_PORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_hga_b</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">HGA_INDEX_PORT</span><span class="p">);</span> 
	<span class="n">outb</span>  <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">HGA_VALUE_PORT</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">HGA_VALUE_PORT</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hga_clear_screen</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fillchar</span> <span class="o">=</span> <span class="mh">0xbf</span><span class="p">;</span> <span class="cm">/* magic */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hga_mode</span> <span class="o">==</span> <span class="n">HGA_TXT</span><span class="p">)</span>
		<span class="n">fillchar</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hga_mode</span> <span class="o">==</span> <span class="n">HGA_GFX</span><span class="p">)</span>
		<span class="n">fillchar</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fillchar</span> <span class="o">!=</span> <span class="mh">0xbf</span><span class="p">)</span>
		<span class="n">memset_io</span><span class="p">(</span><span class="n">hga_vram</span><span class="p">,</span> <span class="n">fillchar</span><span class="p">,</span> <span class="n">hga_vram_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hga_txt_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">HGA_MODE_VIDEO_EN</span> <span class="o">|</span> <span class="n">HGA_MODE_BLINK_EN</span><span class="p">,</span> <span class="n">HGA_MODE_PORT</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">HGA_GFX_PORT</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">HGA_STATUS_PORT</span><span class="p">);</span>

	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* horizontal total */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* horizontal displayed */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>	<span class="cm">/* horizontal sync pos */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* horizontal sync width */</span>

	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>	<span class="cm">/* vertical total */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>	<span class="cm">/* vertical total adjust */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>	<span class="cm">/* vertical displayed */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>	<span class="cm">/* vertical sync pos */</span>

	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>	<span class="cm">/* interlace mode */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>	<span class="cm">/* maximum scanline */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>	<span class="cm">/* cursor start */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>	<span class="cm">/* cursor end */</span>

	<span class="n">write_hga_w</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>	<span class="cm">/* start address */</span>
	<span class="n">write_hga_w</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>	<span class="cm">/* cursor location */</span>

	<span class="n">hga_mode</span> <span class="o">=</span> <span class="n">HGA_TXT</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hga_gfx_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">HGA_STATUS_PORT</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">HGA_GFX_MODE_EN</span><span class="p">,</span> <span class="n">HGA_GFX_PORT</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">HGA_MODE_VIDEO_EN</span> <span class="o">|</span> <span class="n">HGA_MODE_GRAPHICS</span><span class="p">,</span> <span class="n">HGA_MODE_PORT</span><span class="p">);</span>

	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* horizontal total */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* horizontal displayed */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>	<span class="cm">/* horizontal sync pos */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* horizontal sync width */</span>

	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>	<span class="cm">/* vertical total */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>	<span class="cm">/* vertical total adjust */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>	<span class="cm">/* vertical displayed */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>	<span class="cm">/* vertical sync pos */</span>

	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>	<span class="cm">/* interlace mode */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>	<span class="cm">/* maximum scanline */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>	<span class="cm">/* cursor start */</span>
	<span class="n">write_hga_b</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>	<span class="cm">/* cursor end */</span>

	<span class="n">write_hga_w</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>	<span class="cm">/* start address */</span>
	<span class="n">write_hga_w</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>	<span class="cm">/* cursor location */</span>

	<span class="n">hga_mode</span> <span class="o">=</span> <span class="n">HGA_GFX</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hga_show_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">	void __iomem *dest = hga_vram;</span>
<span class="cm">	char *logo = linux_logo_bw;</span>
<span class="cm">	int x, y;</span>
<span class="cm">	</span>
<span class="cm">	for (y = 134; y &lt; 134 + 80 ; y++) * this needs some cleanup *</span>
<span class="cm">		for (x = 0; x &lt; 10 ; x++)</span>
<span class="cm">			writeb(~*(logo++),(dest + HGA_ROWADDR(y) + x + 40));</span>
<span class="cm">*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hga_pan</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xoffset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yoffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">yoffset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">90</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">write_hga_w</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>	<span class="cm">/* start address */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;hga_pan: base:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hga_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">HGA_MODE_PORT</span><span class="p">);</span>	<span class="cm">/* disable video */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="n">HGA_MODE_VIDEO_EN</span> <span class="o">|</span> <span class="n">HGA_MODE_GRAPHICS</span><span class="p">,</span> <span class="n">HGA_MODE_PORT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hga_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hga_card_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">p_save</span><span class="p">,</span> <span class="n">q_save</span><span class="p">;</span>

	<span class="n">hga_vram_len</span>  <span class="o">=</span> <span class="mh">0x08000</span><span class="p">;</span>

	<span class="n">hga_vram</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="mh">0xb0000</span><span class="p">,</span> <span class="n">hga_vram_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="mh">0x3b0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;hgafb&quot;</span><span class="p">))</span>
		<span class="n">release_io_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="mh">0x3bf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;hgafb&quot;</span><span class="p">))</span>
		<span class="n">release_io_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* do a memory check */</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">hga_vram</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">hga_vram</span> <span class="o">+</span> <span class="mh">0x01000</span><span class="p">;</span>

	<span class="n">p_save</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">q_save</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="mh">0xaa55</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa55</span><span class="p">)</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x55aa</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55aa</span><span class="p">)</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">p_save</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Ok, there is definitely a card registering at the correct</span>
<span class="cm">	 * memory location, so now we do an I/O port test.</span>
<span class="cm">	 */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_hga_b</span><span class="p">(</span><span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">))</span>	    <span class="cm">/* cursor low register */</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_hga_b</span><span class="p">(</span><span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">))</span>     <span class="cm">/* cursor low register */</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* See if the card is a Hercules, by checking whether the vsync</span>
<span class="cm">	 * bit of the status register is changing.  This test lasts for</span>
<span class="cm">	 * approximately 1/10th of a second.</span>
<span class="cm">	 */</span>
	
	<span class="n">p_save</span> <span class="o">=</span> <span class="n">q_save</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HGA_STATUS_PORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HGA_STATUS_VSYNC</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">50000</span> <span class="o">&amp;&amp;</span> <span class="n">p_save</span> <span class="o">==</span> <span class="n">q_save</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q_save</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">HGA_STATUS_PORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HGA_STATUS_VSYNC</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_save</span> <span class="o">==</span> <span class="n">q_save</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">HGA_STATUS_PORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="n">hga_type</span> <span class="o">=</span> <span class="n">TYPE_HERCPLUS</span><span class="p">;</span>
			<span class="n">hga_type_name</span> <span class="o">=</span> <span class="s">&quot;HerculesPlus&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x50</span>:
			<span class="n">hga_type</span> <span class="o">=</span> <span class="n">TYPE_HERCCOLOR</span><span class="p">;</span>
			<span class="n">hga_type_name</span> <span class="o">=</span> <span class="s">&quot;HerculesColor&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">hga_type</span> <span class="o">=</span> <span class="n">TYPE_HERC</span><span class="p">;</span>
			<span class="n">hga_type_name</span> <span class="o">=</span> <span class="s">&quot;Hercules&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release_io_ports</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3b0</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">release_io_port</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3bf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hgafb_open - open the framebuffer device</span>
<span class="cm"> *	@info:pointer to fb_info object containing info for current hga board</span>
<span class="cm"> *	@int:open by console system or userland.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgafb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hga_gfx_mode</span><span class="p">();</span>
	<span class="n">hga_clear_screen</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nologo</span><span class="p">)</span> <span class="n">hga_show_logo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hgafb_open - open the framebuffer device</span>
<span class="cm"> *	@info:pointer to fb_info object containing info for current hga board</span>
<span class="cm"> *	@int:open by console system or userland.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgafb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hga_txt_mode</span><span class="p">();</span>
	<span class="n">hga_clear_screen</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hgafb_setcolreg - set color registers</span>
<span class="cm"> *	@regno:register index to set</span>
<span class="cm"> *	@red:red value, unused</span>
<span class="cm"> *	@green:green value, unused</span>
<span class="cm"> *	@blue:blue value, unused</span>
<span class="cm"> *	@transp:transparency value, unused</span>
<span class="cm"> *	@info:unused</span>
<span class="cm"> *</span>
<span class="cm"> *	This callback function is used to set the color registers of a HGA</span>
<span class="cm"> *	board. Since we have only two fixed colors only @regno is checked.</span>
<span class="cm"> *	A zero is returned on success and 1 for failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgafb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hga_pan_display - pan or wrap the display</span>
<span class="cm"> *	@var:contains new xoffset, yoffset and vmode values</span>
<span class="cm"> *	@info:pointer to fb_info object containing info for current hga board</span>
<span class="cm"> *</span>
<span class="cm"> *	This function looks only at xoffset, yoffset and the %FB_VMODE_YWRAP</span>
<span class="cm"> *	flag in @var. If input parameters are correct it calls hga_pan() to </span>
<span class="cm"> *	program the hardware. @info-&gt;var is updated to the new values.</span>
<span class="cm"> *	A zero is returned on success and %-EINVAL for failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> 
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">||</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span>
		 <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span>
		 <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hga_pan</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	hgafb_blank - (un)blank the screen</span>
<span class="cm"> *	@blank_mode:blanking method to use</span>
<span class="cm"> *	@info:unused</span>
<span class="cm"> *	</span>
<span class="cm"> *	Blank the screen if blank_mode != 0, else unblank. </span>
<span class="cm"> *	Implements VESA suspend and powerdown modes on hardware that supports </span>
<span class="cm"> *	disabling hsync/vsync:</span>
<span class="cm"> *		@blank_mode == 2 means suspend vsync,</span>
<span class="cm"> *		@blank_mode == 3 means suspend hsync,</span>
<span class="cm"> *		@blank_mode == 4 means powerdown.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgafb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hga_blank</span><span class="p">(</span><span class="n">blank_mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Accel functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgafb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">rows</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>

	<span class="n">y</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">rows</span><span class="o">--</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">rowaddr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">rop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROP_COPY</span>:
			<span class="n">memset_io</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROP_XOR</span>:
			<span class="n">fb_writeb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">fb_readb</span><span class="p">(</span><span class="n">dest</span><span class="p">)),</span> <span class="n">dest</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgafb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">rows</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&lt;=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">y1</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">;</span>
		<span class="n">y2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">rows</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">rows</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">rowaddr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">dest</span> <span class="o">=</span> <span class="n">rowaddr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">y1</span><span class="o">++</span><span class="p">;</span>
			<span class="n">y2</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">y1</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">y2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">rows</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">rows</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">rowaddr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">dest</span> <span class="o">=</span> <span class="n">rowaddr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">y1</span><span class="o">--</span><span class="p">;</span>
			<span class="n">y2</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgafb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cdat</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">rows</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rows</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span> <span class="n">rows</span><span class="o">--</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">cdat</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dest</span> <span class="o">=</span> <span class="n">rowaddr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">fb_writeb</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">hgafb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>	<span class="o">=</span> <span class="n">hgafb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>	<span class="o">=</span> <span class="n">hgafb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">hgafb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">hgafb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">hgafb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">hgafb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">hgafb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">hgafb_imageblit</span><span class="p">,</span>
<span class="p">};</span>
		
<span class="cm">/* ------------------------------------------------------------------------- *</span>
<span class="cm"> *</span>
<span class="cm"> * Functions in fb_info</span>
<span class="cm"> * </span>
<span class="cm"> * ------------------------------------------------------------------------- */</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
    
	<span class="cm">/*</span>
<span class="cm">	 *  Initialization</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hgafb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">hga_card_detect</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hgafb: HGA card not detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hga_vram</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">hga_vram</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hgafb: %s with %ldK of memory detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hga_type_name</span><span class="p">,</span> <span class="n">hga_vram_len</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hga_vram</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hga_fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hga_vram</span><span class="p">;</span>
	<span class="n">hga_fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">hga_vram_len</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_HWACCEL_YPAN</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">hga_default_var</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">hga_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">monspecs</span><span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hgafb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">hga_vram</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hga_vram</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">hgafb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">hga_txt_mode</span><span class="p">();</span>
	<span class="n">hga_clear_screen</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">hga_vram</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">release_io_ports</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3b0</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">release_io_port</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="mh">0x3bf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">hgafb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">hgafb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hgafb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hgafb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">hgafb_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hgafb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;hgafb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hgafb_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hgafb_device</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;hgafb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hgafb_device</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hgafb_driver</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hgafb_device</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hgafb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">hgafb_device</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hgafb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *  Modularization</span>
<span class="cm"> *</span>
<span class="cm"> * ------------------------------------------------------------------------- */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ferenc Bakonyi (fero@drama.obuda.kando.hu)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FBDev driver for Hercules Graphics Adaptor&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">nologo</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nologo</span><span class="p">,</span> <span class="s">&quot;Disables startup logo if != 0 (default=0)&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">hgafb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hgafb_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
