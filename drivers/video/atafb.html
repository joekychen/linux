<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › atafb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>atafb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/atafb.c -- Atari builtin chipset frame buffer device</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1994 Martin Schaller &amp; Roman Hodek</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> *   - 03 Jan 95: Original version by Martin Schaller: The TT driver and</span>
<span class="cm"> *                all the device independent stuff</span>
<span class="cm"> *   - 09 Jan 95: Roman: I&#39;ve added the hardware abstraction (hw_switch)</span>
<span class="cm"> *                and wrote the Falcon, ST(E), and External drivers</span>
<span class="cm"> *                based on the original TT driver.</span>
<span class="cm"> *   - 07 May 95: Martin: Added colormap operations for the external driver</span>
<span class="cm"> *   - 21 May 95: Martin: Added support for overscan</span>
<span class="cm"> *		  Andreas: some bug fixes for this</span>
<span class="cm"> *   -    Jul 95: Guenther Kelleter &lt;guenther@pool.informatik.rwth-aachen.de&gt;:</span>
<span class="cm"> *                Programmable Falcon video modes</span>
<span class="cm"> *                (thanks to Christian Cartus for documentation</span>
<span class="cm"> *                of VIDEL registers).</span>
<span class="cm"> *   - 27 Dec 95: Guenther: Implemented user definable video modes &quot;user[0-7]&quot;</span>
<span class="cm"> *                on minor 24...31. &quot;user0&quot; may be set on commandline by</span>
<span class="cm"> *                &quot;R&lt;x&gt;;&lt;y&gt;;&lt;depth&gt;&quot;. (Makes sense only on Falcon)</span>
<span class="cm"> *                Video mode switch on Falcon now done at next VBL interrupt</span>
<span class="cm"> *                to avoid the annoying right shift of the screen.</span>
<span class="cm"> *   - 23 Sep 97: Juergen: added xres_virtual for cards like ProMST</span>
<span class="cm"> *                The external-part is legacy, therefore hardware-specific</span>
<span class="cm"> *                functions like panning/hardwarescrolling/blanking isn&#39;t</span>
<span class="cm"> *				  supported.</span>
<span class="cm"> *   - 29 Sep 97: Juergen: added Romans suggestion for pan_display</span>
<span class="cm"> *				  (var-&gt;xoffset was changed even if no set_screen_base avail.)</span>
<span class="cm"> *	 - 05 Oct 97: Juergen: extfb (PACKED_PIXEL) is FB_PSEUDOCOLOR &#39;cause</span>
<span class="cm"> *				  we know how to set the colors</span>
<span class="cm"> *				  ext_*palette: read from ext_colors (former MV300_colors)</span>
<span class="cm"> *							    write to ext_colors and RAMDAC</span>
<span class="cm"> *</span>
<span class="cm"> * To do:</span>
<span class="cm"> *   - For the Falcon it is not possible to set random video modes on</span>
<span class="cm"> *     SM124 and SC/TV, only the bootup resolution is supported.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define ATAFB_TT</span>
<span class="cp">#define ATAFB_STE</span>
<span class="cp">#define ATAFB_EXT</span>
<span class="cp">#define ATAFB_FALCON</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;asm/atarihw.h&gt;</span>
<span class="cp">#include &lt;asm/atariints.h&gt;</span>
<span class="cp">#include &lt;asm/atari_stram.h&gt;</span>

<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;asm/atarikb.h&gt;</span>

<span class="cp">#include &quot;c2p.h&quot;</span>
<span class="cp">#include &quot;atafb.h&quot;</span>

<span class="cp">#define SWITCH_ACIA 0x01		</span><span class="cm">/* modes for switch on OverScan */</span><span class="cp"></span>
<span class="cp">#define SWITCH_SND6 0x40</span>
<span class="cp">#define SWITCH_SND7 0x80</span>
<span class="cp">#define SWITCH_NONE 0x00</span>


<span class="cp">#define up(x, r) (((x) + (r) - 1) &amp; ~((r)-1))</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interface to the world</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atafb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atafb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atafb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atafb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atafb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atafb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">region</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atafb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atafb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">default_par</span><span class="p">;</span>		<span class="cm">/* default resolution (0=none) */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">default_mem_req</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hwscroll</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_hwscroll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sttt_xres</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span> <span class="n">st_yres</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">tt_yres</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sttt_xres_virtual</span> <span class="o">=</span> <span class="mi">640</span><span class="p">,</span> <span class="n">sttt_yres_virtual</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ovsc_offset</span><span class="p">,</span> <span class="n">ovsc_addlen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware parameters for current mode</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atafb_par</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">screen_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">next_line</span><span class="p">;</span>
<span class="cp">#if defined ATAFB_TT || defined ATAFB_STE</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">sync</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">tt</span><span class="p">,</span> <span class="n">st</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ATAFB_FALCON</span>
		<span class="k">struct</span> <span class="n">falcon_hw</span> <span class="p">{</span>
			<span class="cm">/* Here are fields for storing a video mode, as direct</span>
<span class="cm">			 * parameters for the hardware.</span>
<span class="cm">			 */</span>
			<span class="kt">short</span> <span class="n">sync</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">line_width</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">line_offset</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">st_shift</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">f_shift</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">vid_control</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">vid_mode</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">xoffset</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">hht</span><span class="p">,</span> <span class="n">hbb</span><span class="p">,</span> <span class="n">hbe</span><span class="p">,</span> <span class="n">hdb</span><span class="p">,</span> <span class="n">hde</span><span class="p">,</span> <span class="n">hss</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">vft</span><span class="p">,</span> <span class="n">vbb</span><span class="p">,</span> <span class="n">vbe</span><span class="p">,</span> <span class="n">vdb</span><span class="p">,</span> <span class="n">vde</span><span class="p">,</span> <span class="n">vss</span><span class="p">;</span>
			<span class="cm">/* auxiliary information */</span>
			<span class="kt">short</span> <span class="n">mono</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">ste_mode</span><span class="p">;</span>
			<span class="kt">short</span> <span class="n">bpp</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">falcon</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="cm">/* Nothing needed for external mode */</span>
	<span class="p">}</span> <span class="n">hw</span><span class="p">;</span>
<span class="p">}</span> <span class="n">current_par</span><span class="p">;</span>

<span class="cm">/* Don&#39;t calculate an own resolution, and thus don&#39;t change the one found when</span>
<span class="cm"> * booting (currently used for the Falcon to keep settings for internal video</span>
<span class="cm"> * hardware extensions (e.g. ScreenBlaster)  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">DontCalcRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef ATAFB_FALCON</span>
<span class="cp">#define HHT hw.falcon.hht</span>
<span class="cp">#define HBB hw.falcon.hbb</span>
<span class="cp">#define HBE hw.falcon.hbe</span>
<span class="cp">#define HDB hw.falcon.hdb</span>
<span class="cp">#define HDE hw.falcon.hde</span>
<span class="cp">#define HSS hw.falcon.hss</span>
<span class="cp">#define VFT hw.falcon.vft</span>
<span class="cp">#define VBB hw.falcon.vbb</span>
<span class="cp">#define VBE hw.falcon.vbe</span>
<span class="cp">#define VDB hw.falcon.vdb</span>
<span class="cp">#define VDE hw.falcon.vde</span>
<span class="cp">#define VSS hw.falcon.vss</span>
<span class="cp">#define VCO_CLOCK25		0x04</span>
<span class="cp">#define VCO_CSYPOS		0x10</span>
<span class="cp">#define VCO_VSYPOS		0x20</span>
<span class="cp">#define VCO_HSYPOS		0x40</span>
<span class="cp">#define VCO_SHORTOFFS	0x100</span>
<span class="cp">#define VMO_DOUBLE		0x01</span>
<span class="cp">#define VMO_INTER		0x02</span>
<span class="cp">#define VMO_PREMASK		0x0c</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="n">fb_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fix</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="s">&quot;Atari &quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">visual</span>	<span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">accel</span>	<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">screen_base</span><span class="p">;</span>	<span class="cm">/* base address of screen */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">real_screen_base</span><span class="p">;</span>	<span class="cm">/* (only for Overscan) */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">screen_len</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">current_par_valid</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mono_moni</span><span class="p">;</span>


<span class="cp">#ifdef ATAFB_EXT</span>

<span class="cm">/* external video handling */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">external_xres</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">external_xres_virtual</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">external_yres</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * not needed - atafb will never support panning/hardwarescroll with external</span>
<span class="cm"> * static unsigned int external_yres_virtual;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">external_depth</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">external_pmode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">external_addr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">external_len</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">external_vgaiobase</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">external_bitspercol</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * JOE &lt;joe@amber.dinoco.de&gt;:</span>
<span class="cm"> * added card type for external driver, is only needed for</span>
<span class="cm"> * colormap handling.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">cardtype</span> <span class="p">{</span> <span class="n">IS_VGA</span><span class="p">,</span> <span class="n">IS_MV300</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">cardtype</span> <span class="n">external_card_type</span> <span class="o">=</span> <span class="n">IS_VGA</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The MV300 mixes the color registers. So we need an array of munged</span>
<span class="cm"> * indices in order to access the correct reg.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MV300_reg_1bit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MV300_reg_4bit</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MV300_reg_8bit</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span>
	<span class="mi">4</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span>
	<span class="mi">6</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span>
	<span class="mi">14</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">238</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span>
	<span class="mi">9</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">169</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span>
	<span class="mi">5</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span>
	<span class="mi">13</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span>
	<span class="mi">3</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span>
	<span class="mi">11</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span>
	<span class="mi">7</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span>
	<span class="mi">15</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">255</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="o">*</span><span class="n">MV300_reg</span> <span class="o">=</span> <span class="n">MV300_reg_8bit</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* ATAFB_EXT */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">inverse</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">fontheight_8x8</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fontwidth_8x8</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fontdata_8x8</span><span class="p">[];</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">fontheight_8x16</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fontwidth_8x16</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fontdata_8x16</span><span class="p">[];</span>

<span class="cm">/*</span>
<span class="cm"> * struct fb_ops {</span>
<span class="cm"> *	* open/release and usage marking</span>
<span class="cm"> *	struct module *owner;</span>
<span class="cm"> *	int (*fb_open)(struct fb_info *info, int user);</span>
<span class="cm"> *	int (*fb_release)(struct fb_info *info, int user);</span>
<span class="cm"> *</span>
<span class="cm"> *	* For framebuffers with strange non linear layouts or that do not</span>
<span class="cm"> *	* work with normal memory mapped access</span>
<span class="cm"> *	ssize_t (*fb_read)(struct file *file, char __user *buf, size_t count, loff_t *ppos);</span>
<span class="cm"> *	ssize_t (*fb_write)(struct file *file, const char __user *buf, size_t count, loff_t *ppos);</span>
<span class="cm"> *</span>
<span class="cm"> *	* checks var and eventually tweaks it to something supported,</span>
<span class="cm"> *	* DOES NOT MODIFY PAR *</span>
<span class="cm"> *	int (*fb_check_var)(struct fb_var_screeninfo *var, struct fb_info *info);</span>
<span class="cm"> *</span>
<span class="cm"> *	* set the video mode according to info-&gt;var *</span>
<span class="cm"> *	int (*fb_set_par)(struct fb_info *info);</span>
<span class="cm"> *</span>
<span class="cm"> *	* set color register *</span>
<span class="cm"> *	int (*fb_setcolreg)(unsigned int regno, unsigned int red, unsigned int green,</span>
<span class="cm"> *			    unsigned int blue, unsigned int transp, struct fb_info *info);</span>
<span class="cm"> *</span>
<span class="cm"> *	* set color registers in batch *</span>
<span class="cm"> *	int (*fb_setcmap)(struct fb_cmap *cmap, struct fb_info *info);</span>
<span class="cm"> *</span>
<span class="cm"> *	* blank display *</span>
<span class="cm"> *	int (*fb_blank)(int blank, struct fb_info *info);</span>
<span class="cm"> *</span>
<span class="cm"> *	* pan display *</span>
<span class="cm"> *	int (*fb_pan_display)(struct fb_var_screeninfo *var, struct fb_info *info);</span>
<span class="cm"> *</span>
<span class="cm"> *	*** The meat of the drawing engine ***</span>
<span class="cm"> *	* Draws a rectangle *</span>
<span class="cm"> *	void (*fb_fillrect) (struct fb_info *info, const struct fb_fillrect *rect);</span>
<span class="cm"> *	* Copy data from area to another *</span>
<span class="cm"> *	void (*fb_copyarea) (struct fb_info *info, const struct fb_copyarea *region);</span>
<span class="cm"> *	* Draws a image to the display *</span>
<span class="cm"> *	void (*fb_imageblit) (struct fb_info *info, const struct fb_image *image);</span>
<span class="cm"> *</span>
<span class="cm"> *	* Draws cursor *</span>
<span class="cm"> *	int (*fb_cursor) (struct fb_info *info, struct fb_cursor *cursor);</span>
<span class="cm"> *</span>
<span class="cm"> *	* Rotates the display *</span>
<span class="cm"> *	void (*fb_rotate)(struct fb_info *info, int angle);</span>
<span class="cm"> *</span>
<span class="cm"> *	* wait for blit idle, optional *</span>
<span class="cm"> *	int (*fb_sync)(struct fb_info *info);</span>
<span class="cm"> *</span>
<span class="cm"> *	* perform fb specific ioctl (optional) *</span>
<span class="cm"> *	int (*fb_ioctl)(struct fb_info *info, unsigned int cmd,</span>
<span class="cm"> *			unsigned long arg);</span>
<span class="cm"> *</span>
<span class="cm"> *	* Handle 32bit compat ioctl (optional) *</span>
<span class="cm"> *	int (*fb_compat_ioctl)(struct fb_info *info, unsigned int cmd,</span>
<span class="cm"> *			unsigned long arg);</span>
<span class="cm"> *</span>
<span class="cm"> *	* perform fb specific mmap *</span>
<span class="cm"> *	int (*fb_mmap)(struct fb_info *info, struct vm_area_struct *vma);</span>
<span class="cm"> * } ;</span>
<span class="cm"> */</span>


<span class="cm">/* ++roman: This structure abstracts from the underlying hardware (ST(e),</span>
<span class="cm"> * TT, or Falcon.</span>
<span class="cm"> *</span>
<span class="cm"> * int (*detect)(void)</span>
<span class="cm"> *   This function should detect the current video mode settings and</span>
<span class="cm"> *   store them in atafb_predefined[0] for later reference by the</span>
<span class="cm"> *   user. Return the index+1 of an equivalent predefined mode or 0</span>
<span class="cm"> *   if there is no such.</span>
<span class="cm"> *</span>
<span class="cm"> * int (*encode_fix)(struct fb_fix_screeninfo *fix,</span>
<span class="cm"> *                   struct atafb_par *par)</span>
<span class="cm"> *   This function should fill in the &#39;fix&#39; structure based on the</span>
<span class="cm"> *   values in the &#39;par&#39; structure.</span>
<span class="cm"> * !!! Obsolete, perhaps !!!</span>
<span class="cm"> *</span>
<span class="cm"> * int (*decode_var)(struct fb_var_screeninfo *var,</span>
<span class="cm"> *                   struct atafb_par *par)</span>
<span class="cm"> *   Get the video params out of &#39;var&#39;. If a value doesn&#39;t fit, round</span>
<span class="cm"> *   it up, if it&#39;s too big, return EINVAL.</span>
<span class="cm"> *   Round up in the following order: bits_per_pixel, xres, yres,</span>
<span class="cm"> *   xres_virtual, yres_virtual, xoffset, yoffset, grayscale, bitfields,</span>
<span class="cm"> *   horizontal timing, vertical timing.</span>
<span class="cm"> *</span>
<span class="cm"> * int (*encode_var)(struct fb_var_screeninfo *var,</span>
<span class="cm"> *                   struct atafb_par *par);</span>
<span class="cm"> *   Fill the &#39;var&#39; structure based on the values in &#39;par&#39; and maybe</span>
<span class="cm"> *   other values read out of the hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * void (*get_par)(struct atafb_par *par)</span>
<span class="cm"> *   Fill the hardware&#39;s &#39;par&#39; structure.</span>
<span class="cm"> *   !!! Used only by detect() !!!</span>
<span class="cm"> *</span>
<span class="cm"> * void (*set_par)(struct atafb_par *par)</span>
<span class="cm"> *   Set the hardware according to &#39;par&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * void (*set_screen_base)(void *s_base)</span>
<span class="cm"> *   Set the base address of the displayed frame buffer. Only called</span>
<span class="cm"> *   if yres_virtual &gt; yres or xres_virtual &gt; xres.</span>
<span class="cm"> *</span>
<span class="cm"> * int (*blank)(int blank_mode)</span>
<span class="cm"> *   Blank the screen if blank_mode != 0, else unblank. If blank == NULL then</span>
<span class="cm"> *   the caller blanks by setting the CLUT to all black. Return 0 if blanking</span>
<span class="cm"> *   succeeded, !=0 if un-/blanking failed due to e.g. a video mode which</span>
<span class="cm"> *   doesn&#39;t support it. Implements VESA suspend and powerdown modes on</span>
<span class="cm"> *   hardware that supports disabling hsync/vsync:</span>
<span class="cm"> *       blank_mode == 2: suspend vsync, 3:suspend hsync, 4: powerdown.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_hwswitch</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">detect</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">encode_fix</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">decode_var</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">encode_var</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">get_par</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">set_par</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">set_screen_base</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s_base</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">blank</span><span class="p">)(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pan_display</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span> <span class="o">*</span><span class="n">fbhw</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">autodetect_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;autodetect&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stlow_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;stlow&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stmid_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;stmid&quot;</span><span class="p">,</span> <span class="s">&quot;default5&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sthigh_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;sthigh&quot;</span><span class="p">,</span> <span class="s">&quot;default4&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ttlow_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ttlow&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ttmid_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ttmid&quot;</span><span class="p">,</span> <span class="s">&quot;default1&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tthigh_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;tthigh&quot;</span><span class="p">,</span> <span class="s">&quot;default2&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vga2_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;vga2&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vga4_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;vga4&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vga16_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;vga16&quot;</span><span class="p">,</span> <span class="s">&quot;default3&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vga256_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;vga256&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">falh2_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;falh2&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">falh16_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;falh16&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">**</span><span class="n">fb_var_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">autodetect_names</span><span class="p">,</span>
	<span class="n">stlow_names</span><span class="p">,</span>
	<span class="n">stmid_names</span><span class="p">,</span>
	<span class="n">sthigh_names</span><span class="p">,</span>
	<span class="n">ttlow_names</span><span class="p">,</span>
	<span class="n">ttmid_names</span><span class="p">,</span>
	<span class="n">tthigh_names</span><span class="p">,</span>
	<span class="n">vga2_names</span><span class="p">,</span>
	<span class="n">vga4_names</span><span class="p">,</span>
	<span class="n">vga16_names</span><span class="p">,</span>
	<span class="n">vga256_names</span><span class="p">,</span>
	<span class="n">falh2_names</span><span class="p">,</span>
	<span class="n">falh16_names</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">atafb_predefined</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * yres_virtual == 0 means use hw-scrolling if possible, else yres</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="cm">/* autodetect */</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* xres-grayscale */</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* red green blue tran*/</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* st low */</span>
	  <span class="mi">320</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* st mid */</span>
	  <span class="mi">640</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* st high */</span>
	  <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* tt low */</span>
	  <span class="mi">320</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* tt mid */</span>
	  <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* tt high */</span>
	  <span class="mi">1280</span><span class="p">,</span> <span class="mi">960</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* vga2 */</span>
	  <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* vga4 */</span>
	  <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* vga16 */</span>
	  <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* vga256 */</span>
	  <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* falh2 */</span>
	  <span class="mi">896</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">896</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* falh16 */</span>
	  <span class="mi">896</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">896</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">num_atafb_predefined</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atafb_predefined</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">atafb_modedb</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Atari Video Modes</span>
<span class="cm">	 *</span>
<span class="cm">	 *  If you change these, make sure to update DEFMODE_* as well!</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  ST/TT Video Modes</span>
<span class="cm">	 */</span>

	<span class="p">{</span>
		<span class="cm">/* 320x200, 15 kHz, 60 Hz (ST low) */</span>
		<span class="s">&quot;st-low&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x200, 15 kHz, 60 Hz (ST medium) */</span>
		<span class="s">&quot;st-mid&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x400, 30.25 kHz, 63.5 Hz (ST high) */</span>
		<span class="s">&quot;st-high&quot;</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 320x480, 15 kHz, 60 Hz (TT low) */</span>
		<span class="s">&quot;tt-low&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">31041</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x480, 29 kHz, 57 Hz (TT medium) */</span>
		<span class="s">&quot;tt-mid&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">31041</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 1280x960, 29 kHz, 60 Hz (TT high) */</span>
		<span class="s">&quot;tt-high&quot;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">960</span><span class="p">,</span> <span class="mi">31041</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 *  VGA Video Modes</span>
<span class="cm">	 */</span>

	<span class="p">{</span>
		<span class="cm">/* 640x480, 31 kHz, 60 Hz (VGA) */</span>
		<span class="s">&quot;vga&quot;</span><span class="p">,</span> <span class="mf">63.5</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x400, 31 kHz, 70 Hz (VGA) */</span>
		<span class="s">&quot;vga70&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_COMP_HIGH_ACT</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Falcon HiRes Video Modes</span>
<span class="cm">	 */</span>

	<span class="p">{</span>
		<span class="cm">/* 896x608, 31 kHz, 60 Hz (Falcon High) */</span>
		<span class="s">&quot;falh&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">896</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">|</span> <span class="n">FB_VMODE_YWRAP</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NUM_TOTAL_MODES  ARRAY_SIZE(atafb_modedb)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode_option</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

 <span class="cm">/* default modes */</span>

<span class="cp">#define DEFMODE_TT	5		</span><span class="cm">/* &quot;tt-high&quot; for TT */</span><span class="cp"></span>
<span class="cp">#define DEFMODE_F30	7		</span><span class="cm">/* &quot;vga70&quot; for Falcon */</span><span class="cp"></span>
<span class="cp">#define DEFMODE_STE	2		</span><span class="cm">/* &quot;st-high&quot; for ST/E */</span><span class="cp"></span>
<span class="cp">#define DEFMODE_EXT	6		</span><span class="cm">/* &quot;vga&quot; for external */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_video_mode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">vname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">***</span><span class="n">name_list</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">name_list</span> <span class="o">=</span> <span class="n">fb_var_names</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_atafb_predefined</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="o">*</span><span class="n">name_list</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span> <span class="o">||</span> <span class="o">!*</span><span class="n">name</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">name</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ------------------- TT specific functions ---------------------- */</span>

<span class="cp">#ifdef ATAFB_TT</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt_encode_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Atari Builtin&quot;</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">real_screen_base</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">screen_len</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">TT_SHIFTER_MODEMASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TT_SHIFTER_TTHIGH</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">TT_SHIFTER_STHIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TT_SHIFTER_TTHIGH</span><span class="p">)</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO01</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_ATARIBLITT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mono_moni</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">tt_yres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TT_SHIFTER_TTHIGH</span><span class="p">;</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">tt_yres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">tt_yres</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">tt_yres</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TT_SHIFTER_TTLOW</span><span class="p">;</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">tt_yres</span><span class="p">;</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">tt_yres</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TT_SHIFTER_TTMID</span><span class="p">;</span>
				<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
				<span class="n">yres</span> <span class="o">=</span> <span class="n">tt_yres</span><span class="p">;</span>
				<span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TT_SHIFTER_STLOW</span><span class="p">;</span>
				<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TT_SHIFTER_STMID</span><span class="p">;</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">st_yres</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TT_SHIFTER_STHIGH</span><span class="p">;</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span><span class="p">;</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">yres</span><span class="p">)</span>
		<span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_EXT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">linelen</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">linelen</span> <span class="o">&gt;</span> <span class="n">screen_len</span> <span class="o">&amp;&amp;</span> <span class="n">screen_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">*</span> <span class="n">linelen</span> <span class="o">&gt;</span> <span class="n">screen_len</span> <span class="o">&amp;&amp;</span> <span class="n">screen_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">yres_virtual</span> <span class="o">&amp;&amp;</span> <span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">screen_base</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt_encode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="p">));</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">31041</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>		<span class="cm">/* these may be incorrect */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="mi">140</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">FB_SYNC_EXT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">TT_SHIFTER_MODEMASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TT_SHIFTER_STLOW</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sttt_xres_virtual</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TT_SHIFTER_STMID</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sttt_xres_virtual</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TT_SHIFTER_STHIGH</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sttt_xres_virtual</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TT_SHIFTER_TTLOW</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sttt_xres_virtual</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">tt_yres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TT_SHIFTER_TTMID</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sttt_xres_virtual</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">tt_yres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TT_SHIFTER_TTHIGH</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sttt_xres_virtual</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">tt_yres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">linelen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_hwscroll</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">screen_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* yres_virtual == 0 means use maximum */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">screen_len</span> <span class="o">/</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwscroll</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">hwscroll</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">-</span> <span class="n">screen_base</span><span class="p">)</span> <span class="o">/</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tt_get_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">shifter_tt</span><span class="p">.</span><span class="n">tt_shiftmode</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">shifter</span><span class="p">.</span><span class="n">syncmode</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_hi</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_md</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span>
	       <span class="p">((</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_lo</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tt_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">shifter_tt</span><span class="p">.</span><span class="n">tt_shiftmode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">shifter</span><span class="p">.</span><span class="n">syncmode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">tt</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
	<span class="cm">/* only set screen_base if really necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">!=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_screen_base</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">shifter_tt</span><span class="p">.</span><span class="n">tt_shiftmode</span> <span class="o">&amp;</span> <span class="n">TT_SHIFTER_MODEMASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TT_SHIFTER_STHIGH</span><span class="p">)</span>
		<span class="n">regno</span> <span class="o">+=</span> <span class="mi">254</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tt_palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">shifter_tt</span><span class="p">.</span><span class="n">tt_shiftmode</span> <span class="o">&amp;</span> <span class="n">TT_SHIFTER_MODEMASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">TT_SHIFTER_STHIGH</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">==</span> <span class="mi">254</span><span class="p">)</span>
		<span class="n">tt_palette</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">par</span><span class="p">;</span>

	<span class="cm">/* Determine the connected monitor: The DMA sound must be</span>
<span class="cm">	 * disabled before reading the MFP GPIP, because the Sound</span>
<span class="cm">	 * Done Signal and the Monochrome Detect are XORed together!</span>
<span class="cm">	 *</span>
<span class="cm">	 * Even on a TT, we should look if there is a DMA sound. It was</span>
<span class="cm">	 * announced that the Eagle is TT compatible, but only the PCM is</span>
<span class="cm">	 * missing...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">PCM_8BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DMASND_CTRL_OFF</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>		<span class="cm">/* wait a while for things to settle down */</span>
	<span class="p">}</span>
	<span class="n">mono_moni</span> <span class="o">=</span> <span class="p">(</span><span class="n">st_mfp</span><span class="p">.</span><span class="n">par_dt_reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tt_get_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="n">tt_encode_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atafb_predefined</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* ATAFB_TT */</span><span class="cp"></span>

<span class="cm">/* ------------------- Falcon specific functions ---------------------- */</span>

<span class="cp">#ifdef ATAFB_FALCON</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mon_type</span><span class="p">;</span>		<span class="cm">/* Falcon connected monitor */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">f030_bus_width</span><span class="p">;</span>	<span class="cm">/* Falcon ram bus width (for vid_control) */</span>
<span class="cp">#define F_MON_SM	0</span>
<span class="cp">#define F_MON_SC	1</span>
<span class="cp">#define F_MON_VGA	2</span>
<span class="cp">#define F_MON_TV	3</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pixel_clock</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>	<span class="cm">/* f/[Hz] */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>	<span class="cm">/* t/[ps] (=1/f) */</span>
	<span class="kt">int</span> <span class="n">right</span><span class="p">,</span> <span class="n">hsync</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>	<span class="cm">/* standard timing in clock cycles, not pixel */</span>
	<span class="cm">/* hsync initialized in falcon_detect() */</span>
	<span class="kt">int</span> <span class="n">sync_mask</span><span class="p">;</span>		<span class="cm">/* or-mask for hw.falcon.sync to set this clock */</span>
	<span class="kt">int</span> <span class="n">control_mask</span><span class="p">;</span>	<span class="cm">/* ditto, for hw.falcon.vid_control */</span>
<span class="p">}</span> <span class="n">f25</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">25175000</span><span class="p">,</span> <span class="mi">39721</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">VCO_CLOCK25</span>
<span class="p">},</span> <span class="n">f32</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">32000000</span><span class="p">,</span> <span class="mi">31250</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">},</span> <span class="n">fext</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/* VIDEL-prescale values [mon_type][pixel_length from VCO] */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vdl_prescale</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Default hsync timing [mon_type] in picoseconds */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">h_syncs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3000000</span><span class="p">,</span> <span class="mi">4875000</span><span class="p">,</span> <span class="mi">4000000</span><span class="p">,</span> <span class="mi">4875000</span> <span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hxx_prescale</span><span class="p">(</span><span class="k">struct</span> <span class="n">falcon_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ste_mode</span> <span class="o">?</span> <span class="mi">16</span>
			    <span class="o">:</span> <span class="n">vdl_prescale</span><span class="p">[</span><span class="n">mon_type</span><span class="p">][</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">falcon_encode_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Atari Builtin&quot;</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">real_screen_base</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">screen_len</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">mono</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* no smooth scrolling with longword aligned video mem */</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Is this ok or should it be DIRECTCOLOR? */</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_ATARIBLITT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">falcon_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left_margin</span><span class="p">,</span> <span class="n">right_margin</span><span class="p">,</span> <span class="n">hsync_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">upper_margin</span><span class="p">,</span> <span class="n">lower_margin</span><span class="p">,</span> <span class="n">vsync_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interlace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">doubleline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pixel_clock</span> <span class="o">*</span><span class="n">pclock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plen</span><span class="p">;</span>			<span class="cm">/* width of pixel in clock cycles */</span>
	<span class="kt">int</span> <span class="n">xstretch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">longoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hfreq</span><span class="p">,</span> <span class="n">vfreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdb_off</span><span class="p">,</span> <span class="n">hde_off</span><span class="p">,</span> <span class="n">base_off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gstart</span><span class="p">,</span> <span class="n">gend1</span><span class="p">,</span> <span class="n">gend2</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">	Get the video params out of &#39;var&#39;. If a value doesn&#39;t fit, round</span>
<span class="cm">	it up, if it&#39;s too big, return EINVAL.</span>
<span class="cm">	Round up in the following order: bits_per_pixel, xres, yres,</span>
<span class="cm">	xres_virtual, yres_virtual, xoffset, yoffset, grayscale, bitfields,</span>
<span class="cm">	horizontal timing, vertical timing.</span>

<span class="cm">	There is a maximum of screen resolution determined by pixelclock</span>
<span class="cm">	and minimum frame rate -- (X+hmarg.)*(Y+vmarg.)*vfmin &lt;= pixelclock.</span>
<span class="cm">	In interlace mode this is     &quot;     *    &quot;     *vfmin &lt;= pixelclock.</span>
<span class="cm">	Additional constraints: hfreq.</span>
<span class="cm">	Frequency range for multisync monitors is given via command line.</span>
<span class="cm">	For TV and SM124 both frequencies are fixed.</span>

<span class="cm">	X % 16 == 0 to fit 8x?? font (except 1 bitplane modes must use X%32 == 0)</span>
<span class="cm">	Y % 16 == 0 to fit 8x16 font</span>
<span class="cm">	Y % 8 == 0 if Y&lt;400</span>

<span class="cm">	Currently interlace and doubleline mode in var are ignored.</span>
<span class="cm">	On SM124 and TV only the standard resolutions can be used.</span>
<span class="cm">*/</span>

	<span class="cm">/* Reject uninitialized mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xres</span> <span class="o">||</span> <span class="o">!</span><span class="n">yres</span> <span class="o">||</span> <span class="o">!</span><span class="n">bpp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mon_type</span> <span class="o">==</span> <span class="n">F_MON_SM</span> <span class="o">&amp;&amp;</span> <span class="n">bpp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">st_shift</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">st_shift</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">st_shift</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">=</span> <span class="mh">0x010</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>		<span class="cm">/* packed pixel mode */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>	<span class="cm">/* hicolor, no overlay */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mon_type</span> <span class="o">==</span> <span class="n">F_MON_SM</span> <span class="o">||</span> <span class="n">DontCalcRes</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Skip all calculations. VGA/TV/SC1224 only supported. */</span>
		<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">myvar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atafb_predefined</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="n">myvar</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">||</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">myvar</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">myvar</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">get_par</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>	<span class="cm">/* Current par will be new par */</span>
		<span class="k">goto</span> <span class="n">set_screen_base</span><span class="p">;</span>	<span class="cm">/* Don&#39;t forget this */</span>
	<span class="p">}</span>

	<span class="cm">/* Only some fixed resolutions &lt; 640x400 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="mi">320</span><span class="p">)</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="mi">640</span> <span class="o">&amp;&amp;</span> <span class="n">bpp</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&lt;=</span> <span class="mi">240</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&lt;=</span> <span class="mi">400</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>

	<span class="cm">/* 2 planes must use STE compatibility mode */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">ste_mode</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">mono</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Total and visible scanline length must be a multiple of one longword,</span>
<span class="cm">	 * this and the console fontwidth yields the alignment for xres and</span>
<span class="cm">	 * xres_virtual.</span>
<span class="cm">	 * TODO: this way &quot;odd&quot; fontheights are not supported</span>
<span class="cm">	 *</span>
<span class="cm">	 * Special case in STE mode: blank and graphic positions don&#39;t align,</span>
<span class="cm">	 * avoid trash at right margin</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">ste_mode</span><span class="p">)</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">63</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">yres</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">yres</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">xres</span><span class="p">)</span>
		<span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">xres_virtual</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xres_virtual</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">yres</span><span class="p">)</span>
		<span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>

	<span class="cm">/* backward bug-compatibility */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">line_width</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">*</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">line_offset</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">*</span> <span class="p">(</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">xres</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* single or double pixel width */</span>
	<span class="n">xstretch</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&lt;</span> <span class="mi">640</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"> /* SM124 supports only 640x400, this is rejected above */</span>
<span class="c">	if (mon_type == F_MON_SM) {</span>
<span class="c">		if (xres != 640 &amp;&amp; yres != 400)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		plen = 1;</span>
<span class="c">		pclock = &amp;f32;</span>
<span class="c">		/* SM124-mode is special */</span>
<span class="c">		par-&gt;hw.falcon.ste_mode = 1;</span>
<span class="c">		par-&gt;hw.falcon.f_shift = 0x000;</span>
<span class="c">		par-&gt;hw.falcon.st_shift = 0x200;</span>
<span class="c">		left_margin = hsync_len = 128 / plen;</span>
<span class="c">		right_margin = 0;</span>
<span class="c">		/* TODO set all margins */</span>
<span class="c">	} else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mon_type</span> <span class="o">==</span> <span class="n">F_MON_SC</span> <span class="o">||</span> <span class="n">mon_type</span> <span class="o">==</span> <span class="n">F_MON_TV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xstretch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&gt;</span> <span class="n">f32</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">plen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pclock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f32</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="mi">240</span><span class="p">)</span>
			<span class="n">interlace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set some minimal margins which center the screen */</span>
			<span class="n">left_margin</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">right_margin</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
			<span class="n">hsync_len</span> <span class="o">=</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">hsync</span> <span class="o">/</span> <span class="n">plen</span><span class="p">;</span>
			<span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="n">vsync_len</span> <span class="o">=</span> <span class="n">interlace</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">left_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
			<span class="n">right_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
			<span class="n">hsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
			<span class="n">upper_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
			<span class="n">lower_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
			<span class="n">vsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">upper_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">lower_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">vsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">upper_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">lower_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">vsync_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/* F_MON_VGA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">xstretch</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Double pixel width only for hicolor */</span>
		<span class="cm">/* Default values are used for vert./hor. timing if no pixelclock given. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">linesize</span><span class="p">;</span>

			<span class="cm">/* Choose master pixelclock depending on hor. timing */</span>
			<span class="n">plen</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">xstretch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">*</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">f25</span><span class="p">.</span><span class="n">right</span> <span class="o">+</span> <span class="n">f25</span><span class="p">.</span><span class="n">hsync</span> <span class="o">+</span> <span class="n">f25</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span>
			    <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">&lt;</span> <span class="n">f25</span><span class="p">.</span><span class="n">f</span><span class="p">)</span>
				<span class="n">pclock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f25</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">*</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">f32</span><span class="p">.</span><span class="n">right</span> <span class="o">+</span> <span class="n">f32</span><span class="p">.</span><span class="n">hsync</span> <span class="o">+</span>
				  <span class="n">f32</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">&lt;</span> <span class="n">f32</span><span class="p">.</span><span class="n">f</span><span class="p">)</span>
				<span class="n">pclock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f32</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">*</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">fext</span><span class="p">.</span><span class="n">right</span> <span class="o">+</span> <span class="n">fext</span><span class="p">.</span><span class="n">hsync</span> <span class="o">+</span>
				  <span class="n">fext</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">&lt;</span> <span class="n">fext</span><span class="p">.</span><span class="n">f</span> <span class="o">&amp;&amp;</span>
			         <span class="n">fext</span><span class="p">.</span><span class="n">f</span><span class="p">)</span>
				<span class="n">pclock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fext</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">left_margin</span> <span class="o">=</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">/</span> <span class="n">plen</span><span class="p">;</span>
			<span class="n">right_margin</span> <span class="o">=</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">/</span> <span class="n">plen</span><span class="p">;</span>
			<span class="n">hsync_len</span> <span class="o">=</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">hsync</span> <span class="o">/</span> <span class="n">plen</span><span class="p">;</span>
			<span class="n">linesize</span> <span class="o">=</span> <span class="n">left_margin</span> <span class="o">+</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">right_margin</span> <span class="o">+</span> <span class="n">hsync_len</span><span class="p">;</span>
			<span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Choose largest pixelclock &lt;= wanted clock */</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pcl</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">;</span>
			<span class="n">pclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">f25</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&amp;&amp;</span>
				    <span class="n">f25</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcl</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pcl</span> <span class="o">=</span> <span class="n">f25</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">pclock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f25</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">f32</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&amp;&amp;</span>
				    <span class="n">f32</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcl</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pcl</span> <span class="o">=</span> <span class="n">f32</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">pclock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f32</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fext</span><span class="p">.</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">fext</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&amp;&amp;</span>
				    <span class="n">fext</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pcl</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pcl</span> <span class="o">=</span> <span class="n">fext</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">pclock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fext</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pclock</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">plen</span> <span class="o">=</span> <span class="n">pcl</span> <span class="o">/</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">;</span>

			<span class="n">left_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
			<span class="n">right_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">;</span>
			<span class="n">hsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
			<span class="n">upper_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
			<span class="n">lower_margin</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span><span class="p">;</span>
			<span class="n">vsync_len</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>
			<span class="cm">/* Internal unit is [single lines per (half-)frame] */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* # lines in half frame */</span>
				<span class="cm">/* External unit is [lines per full frame] */</span>
				<span class="n">upper_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">lower_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">vsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* External unit is [double lines per frame] */</span>
				<span class="n">upper_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">lower_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">vsync_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pclock</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">fext</span><span class="p">)</span>
			<span class="n">longoffset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* VIDEL doesn&#39;t synchronize on short offset */</span>
	<span class="p">}</span>
	<span class="cm">/* Is video bus bandwidth (32MB/s) too low for this resolution? */</span>
	<span class="cm">/* this is definitely wrong if bus clock != 32MHz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pclock</span><span class="o">-&gt;</span><span class="n">f</span> <span class="o">/</span> <span class="n">plen</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">32000000L</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vsync_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* include sync lengths in right/lower margin for all calculations */</span>
	<span class="n">right_margin</span> <span class="o">+=</span> <span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">lower_margin</span> <span class="o">+=</span> <span class="n">vsync_len</span><span class="p">;</span>

	<span class="cm">/* ! In all calculations of margins we use # of lines in half frame</span>
<span class="cm">	 * (which is a full frame in non-interlace mode), so we can switch</span>
<span class="cm">	 * between interlace and non-interlace without messing around</span>
<span class="cm">	 * with these.</span>
<span class="cm">	 */</span>
<span class="nl">again:</span>
	<span class="cm">/* Set base_offset 128 and video bus width */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_control</span> <span class="o">=</span> <span class="n">mon_type</span> <span class="o">|</span> <span class="n">f030_bus_width</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">longoffset</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_control</span> <span class="o">|=</span> <span class="n">VCO_SHORTOFFS</span><span class="p">;</span>	<span class="cm">/* base_offset 64 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_control</span> <span class="o">|=</span> <span class="n">VCO_HSYPOS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_control</span> <span class="o">|=</span> <span class="n">VCO_VSYPOS</span><span class="p">;</span>
	<span class="cm">/* Pixelclock */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_control</span> <span class="o">|=</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">control_mask</span><span class="p">;</span>
	<span class="cm">/* External or internal clock */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">sync_mask</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="cm">/* Pixellength and prescale */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_mode</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">plen</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doubleline</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_mode</span> <span class="o">|=</span> <span class="n">VMO_DOUBLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interlace</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_mode</span> <span class="o">|=</span> <span class="n">VMO_INTER</span><span class="p">;</span>

	<span class="cm">/*********************</span>
<span class="cm">	 * Horizontal timing: unit = [master clock cycles]</span>
<span class="cm">	 * unit of hxx-registers: [master clock cycles * prescale]</span>
<span class="cm">	 * Hxx-registers are 9 bit wide</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1 line = ((hht + 2) * 2 * prescale) clock cycles</span>
<span class="cm">	 *</span>
<span class="cm">	 * graphic output = hdb &amp; 0x200 ?</span>
<span class="cm">	 *        ((hht + 2) * 2 - hdb + hde) * prescale - hdboff + hdeoff:</span>
<span class="cm">	 *        (hht + 2  - hdb + hde) * prescale - hdboff + hdeoff</span>
<span class="cm">	 * (this must be a multiple of plen*128/bpp, on VGA pixels</span>
<span class="cm">	 *  to the right may be cut off with a bigger right margin)</span>
<span class="cm">	 *</span>
<span class="cm">	 * start of graphics relative to start of 1st halfline = hdb &amp; 0x200 ?</span>
<span class="cm">	 *        (hdb - hht - 2) * prescale + hdboff :</span>
<span class="cm">	 *        hdb * prescale + hdboff</span>
<span class="cm">	 *</span>
<span class="cm">	 * end of graphics relative to start of 1st halfline =</span>
<span class="cm">	 *        (hde + hht + 2) * prescale + hdeoff</span>
<span class="cm">	 *********************/</span>
	<span class="cm">/* Calculate VIDEL registers */</span>
<span class="p">{</span>
	<span class="n">prescale</span> <span class="o">=</span> <span class="n">hxx_prescale</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">);</span>
	<span class="n">base_off</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">vid_control</span> <span class="o">&amp;</span> <span class="n">VCO_SHORTOFFS</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">128</span><span class="p">;</span>

	<span class="cm">/* Offsets depend on video mode */</span>
	<span class="cm">/* Offsets are in clock cycles, divide by prescale to</span>
<span class="cm">	 * calculate hd[be]-registers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hde_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdb_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_off</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">plen</span><span class="p">)</span> <span class="o">+</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">align</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">;</span>
		<span class="n">hde_off</span> <span class="o">=</span> <span class="p">((</span><span class="mi">128</span> <span class="o">/</span> <span class="n">bpp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">plen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">ste_mode</span><span class="p">)</span>
			<span class="n">hdb_off</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="n">base_off</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span> <span class="o">/</span> <span class="n">bpp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">plen</span><span class="p">)</span> <span class="o">+</span> <span class="n">prescale</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdb_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_off</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span> <span class="o">/</span> <span class="n">bpp</span> <span class="o">+</span> <span class="mi">18</span><span class="p">)</span> <span class="o">*</span> <span class="n">plen</span><span class="p">)</span> <span class="o">+</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">prescale</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">plen</span> <span class="o">*</span> <span class="n">left_margin</span><span class="p">)</span> <span class="o">/</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="cm">/* gend1 is for hde (gend-gstart multiple of align), shifter&#39;s xres */</span>
	<span class="n">gend1</span> <span class="o">=</span> <span class="n">gstart</span> <span class="o">+</span> <span class="n">roundup</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">align</span><span class="p">)</span> <span class="o">*</span> <span class="n">plen</span> <span class="o">/</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="cm">/* gend2 is for hbb, visible xres (rest to gend1 is cut off by hblank) */</span>
	<span class="n">gend2</span> <span class="o">=</span> <span class="n">gstart</span> <span class="o">+</span> <span class="n">xres</span> <span class="o">*</span> <span class="n">plen</span> <span class="o">/</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">HHT</span> <span class="o">=</span> <span class="n">plen</span> <span class="o">*</span> <span class="p">(</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">xres</span> <span class="o">+</span> <span class="n">right_margin</span><span class="p">)</span> <span class="o">/</span>
			   <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">prescale</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<span class="cm">/*	par-&gt;HHT = (gend2 + plen * right_margin / prescale) / 2 - 2;*/</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">HDB</span> <span class="o">=</span> <span class="n">gstart</span> <span class="o">-</span> <span class="n">hdb_off</span> <span class="o">/</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">HBE</span> <span class="o">=</span> <span class="n">gstart</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">HDB</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">HDB</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">HHT</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">HDE</span> <span class="o">=</span> <span class="n">gend1</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">HHT</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">hde_off</span> <span class="o">/</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">HBB</span> <span class="o">=</span> <span class="n">gend2</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">HHT</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* One more Videl constraint: data fetch of two lines must not overlap */</span>
<span class="c">	if ((par-&gt;HDB &amp; 0x200) &amp;&amp; (par-&gt;HDB &amp; ~0x200) - par-&gt;HDE &lt;= 5) {</span>
<span class="c">		/* if this happens increase margins, decrease hfreq. */</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hde_off</span> <span class="o">%</span> <span class="n">prescale</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">HBB</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* compensate for non matching hde and hbb */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">HSS</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">HHT</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">plen</span> <span class="o">*</span> <span class="n">hsync_len</span> <span class="o">/</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">HSS</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">HBB</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">HSS</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">HBB</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*  check hor. frequency */</span>
	<span class="n">hfreq</span> <span class="o">=</span> <span class="n">pclock</span><span class="o">-&gt;</span><span class="n">f</span> <span class="o">/</span> <span class="p">((</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">HHT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">prescale</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hfreq</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">&amp;&amp;</span> <span class="n">mon_type</span> <span class="o">!=</span> <span class="n">F_MON_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ++guenther:   ^^^^^^^^^^^^^^^^^^^ can&#39;t remember why I did this */</span>
		<span class="cm">/* Too high -&gt; enlarge margin */</span>
		<span class="n">left_margin</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">right_margin</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hfreq</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">||</span> <span class="n">hfreq</span> <span class="o">&lt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Vxx-registers */</span>
	<span class="cm">/* All Vxx must be odd in non-interlace, since frame starts in the middle</span>
<span class="cm">	 * of the first displayed line!</span>
<span class="cm">	 * One frame consists of VFT+1 half lines. VFT+1 must be even in</span>
<span class="cm">	 * non-interlace, odd in interlace mode for synchronisation.</span>
<span class="cm">	 * Vxx-registers are 11 bit wide</span>
<span class="cm">	 */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">VBE</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_margin</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* must begin on odd halfline */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">VDB</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">VBE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">VDE</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interlace</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">VDE</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doubleline</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">VDE</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* VDE now half lines per (half-)frame */</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">VDE</span> <span class="o">+=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">VDB</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">VBB</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">VDE</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">VFT</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">VBB</span> <span class="o">+</span> <span class="p">(</span><span class="n">lower_margin</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">VSS</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">VFT</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">vsync_len</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* vbb,vss,vft must be even in interlace mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interlace</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">VBB</span><span class="o">++</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">VSS</span><span class="o">++</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">VFT</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* V-frequency check, hope I didn&#39;t create any loop here. */</span>
	<span class="cm">/* Interlace and doubleline are mutually exclusive. */</span>
	<span class="n">vfreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfreq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">VFT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">doubleline</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">interlace</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Too high -&gt; try again with doubleline */</span>
		<span class="n">doubleline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">&lt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">interlace</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">doubleline</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Too low -&gt; try again with interlace */</span>
		<span class="n">interlace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">&lt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">&amp;&amp;</span> <span class="n">doubleline</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Doubleline too low -&gt; clear doubleline and enlarge margins */</span>
		<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">doubleline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="p">(</span><span class="n">hfreq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">VFT</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">lines</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">yres</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">;</span>
		     <span class="n">lines</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="n">upper_margin</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">lower_margin</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&amp;&amp;</span> <span class="n">doubleline</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Doubleline too high -&gt; enlarge margins */</span>
		<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="p">(</span><span class="n">hfreq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">VFT</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">;</span>
		     <span class="n">lines</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="n">upper_margin</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">lower_margin</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">&amp;&amp;</span> <span class="n">interlace</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Interlace, too high -&gt; enlarge margins */</span>
		<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="p">(</span><span class="n">hfreq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">VFT</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">;</span>
		     <span class="n">lines</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="n">upper_margin</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="n">lower_margin</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vfreq</span> <span class="o">&lt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">||</span>
		   <span class="n">vfreq</span> <span class="o">&gt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">set_screen_base:</span>
	<span class="n">linelen</span> <span class="o">=</span> <span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">linelen</span> <span class="o">&gt;</span> <span class="n">screen_len</span> <span class="o">&amp;&amp;</span> <span class="n">screen_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">*</span> <span class="n">linelen</span> <span class="o">&gt;</span> <span class="n">screen_len</span> <span class="o">&amp;&amp;</span> <span class="n">screen_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">yres_virtual</span> <span class="o">&amp;&amp;</span> <span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">screen_base</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">falcon_encode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* !!! only for VGA !!! */</span>
	<span class="kt">int</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prescale</span><span class="p">,</span> <span class="n">plen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdb_off</span><span class="p">,</span> <span class="n">hde_off</span><span class="p">,</span> <span class="n">base_off</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">falcon_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="p">));</span>
	<span class="cm">/* possible frequencies: 25.175 or 32MHz */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="n">fext</span><span class="p">.</span><span class="n">t</span> <span class="o">:</span>
	                <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_control</span> <span class="o">&amp;</span> <span class="n">VCO_CLOCK25</span> <span class="o">?</span> <span class="n">f25</span><span class="p">.</span><span class="n">t</span> <span class="o">:</span> <span class="n">f32</span><span class="p">.</span><span class="n">t</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_control</span> <span class="o">&amp;</span> <span class="n">VCO_HSYPOS</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_control</span> <span class="o">&amp;</span> <span class="n">VCO_VSYPOS</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_mode</span> <span class="o">&amp;</span> <span class="n">VMO_INTER</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_mode</span> <span class="o">&amp;</span> <span class="n">VMO_DOUBLE</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">;</span>

	<span class="cm">/* visible y resolution:</span>
<span class="cm">	 * Graphics display starts at line VDB and ends at line</span>
<span class="cm">	 * VDE. If interlace mode off unit of VC-registers is</span>
<span class="cm">	 * half lines, else lines.</span>
<span class="cm">	 */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vde</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vdb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * to get bpp, we must examine f_shift and st_shift.</span>
<span class="cm">	 * f_shift is valid if any of bits no. 10, 8 or 4</span>
<span class="cm">	 * is set. Priority in f_shift is: 10 &quot;&gt;&quot; 8 &quot;&gt;&quot; 4, i.e.</span>
<span class="cm">	 * if bit 10 set then bit 8 and bit 4 don&#39;t care...</span>
<span class="cm">	 * If all these bits are 0 get display depth from st_shift</span>
<span class="cm">	 * (as for ST and STE)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span>	<span class="cm">/* 2 colors */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>	<span class="cm">/* hicolor */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x010</span><span class="p">)</span>	<span class="cm">/* 8 bitplanes */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_shift</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>				<span class="cm">/* if (hw-&gt;st_shift == 0x200) */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">line_width</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">line_offset</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ste_mode</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">linelen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">screen_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* yres_virtual == 0 means use maximum */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">screen_len</span> <span class="o">/</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwscroll</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">hwscroll</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* TODO change this */</span>

	<span class="cm">/* hdX-offsets */</span>
	<span class="n">prescale</span> <span class="o">=</span> <span class="n">hxx_prescale</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">base_off</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_control</span> <span class="o">&amp;</span> <span class="n">VCO_SHORTOFFS</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hde_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdb_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_off</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">plen</span><span class="p">)</span> <span class="o">+</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hde_off</span> <span class="o">=</span> <span class="p">((</span><span class="mi">128</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">plen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ste_mode</span><span class="p">)</span>
			<span class="n">hdb_off</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="n">base_off</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">plen</span><span class="p">)</span>
					 <span class="o">+</span> <span class="n">prescale</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdb_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_off</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span> <span class="o">/</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">+</span> <span class="mi">18</span><span class="p">)</span> <span class="o">*</span> <span class="n">plen</span><span class="p">)</span>
					 <span class="o">+</span> <span class="n">prescale</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Right margin includes hsync */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">hdb_off</span> <span class="o">+</span> <span class="n">prescale</span> <span class="o">*</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hdb</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">-</span>
					   <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hdb</span> <span class="o">&amp;</span> <span class="mh">0x200</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hht</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ste_mode</span> <span class="o">||</span> <span class="n">mon_type</span> <span class="o">!=</span> <span class="n">F_MON_VGA</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">prescale</span> <span class="o">*</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hht</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hde</span><span class="p">)</span> <span class="o">-</span> <span class="n">hde_off</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* can&#39;t use this in ste_mode, because hbb is +1 off */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">prescale</span> <span class="o">*</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hht</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hbb</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="n">prescale</span> <span class="o">*</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hht</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hss</span><span class="p">);</span>

	<span class="cm">/* Lower margin includes vsync */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vdb</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* round down to full lines */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vft</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vde</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* round up */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vft</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vss</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* round up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">*=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">/=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">/=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">/=</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">-=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">-=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">-</span> <span class="n">screen_base</span><span class="p">)</span> <span class="o">/</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* what is this for? */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">f_change_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">falcon_hw</span> <span class="n">f_new_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">f_pan_display</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falcon_get_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">falcon_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">line_width</span> <span class="o">=</span> <span class="n">shifter_f030</span><span class="p">.</span><span class="n">scn_width</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">line_offset</span> <span class="o">=</span> <span class="n">shifter_f030</span><span class="p">.</span><span class="n">off_next</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_shift</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">st_shift</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">f_shift</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_control</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">control</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_mode</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">shifter</span><span class="p">.</span><span class="n">syncmode</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hht</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">hht</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hbb</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">hbb</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hbe</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">hbe</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hdb</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">hdb</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hde</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">hde</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">hss</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">hss</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vft</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">vft</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vbb</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">vbb</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vbe</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">vbe</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vdb</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">vdb</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vde</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">vde</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vss</span> <span class="o">=</span> <span class="n">videl</span><span class="p">.</span><span class="n">vss</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_hi</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_md</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>  <span class="o">|</span>
	       <span class="p">(</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_lo</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* derived parameters */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ste_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x510</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_shift</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mono</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">||</span>
	           <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span> <span class="o">&amp;</span> <span class="mh">0x510</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_shift</span> <span class="o">==</span> <span class="mh">0x200</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">falcon_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">f_change_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* only set screen_base if really necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">!=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_screen_base</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t touch any other registers if we keep the default resolution */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DontCalcRes</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Tell vbl-handler to change video mode.</span>
<span class="cm">	 * We change modes only on next VBL, to avoid desynchronisation</span>
<span class="cm">	 * (a shift to the right and wrap around by a random number of pixels</span>
<span class="cm">	 * in all monochrome modes).</span>
<span class="cm">	 * This seems to work on my Falcon.</span>
<span class="cm">	 */</span>
	<span class="n">f_new_mode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">;</span>
	<span class="n">f_change_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">falcon_vbl_switcher</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">falcon_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f_new_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f_change_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f_change_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable external pixelclock. This code only for ScreenWonder */</span>
			<span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xffff9202</span> <span class="o">=</span> <span class="mh">0xffbf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Turn off external clocks. Read sets all output bits to 1. */</span>
			<span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xffff9202</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">shifter</span><span class="p">.</span><span class="n">syncmode</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>

		<span class="n">videl</span><span class="p">.</span><span class="n">hht</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hht</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">hbb</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hbb</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">hbe</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hbe</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">hdb</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hdb</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">hde</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hde</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">hss</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hss</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">vft</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vft</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">vbb</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vbb</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">vbe</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vbe</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">vdb</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vdb</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">vde</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vde</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">vss</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vss</span><span class="p">;</span>

		<span class="n">videl</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* write enables Falcon palette, 0: 4 planes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ste_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">videl</span><span class="p">.</span><span class="n">st_shift</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">st_shift</span><span class="p">;</span>	<span class="cm">/* write enables STE palette */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* IMPORTANT:</span>
<span class="cm">			 * set st_shift 0, so we can tell the screen-depth if f_shift == 0.</span>
<span class="cm">			 * Writing 0 to f_shift enables 4 plane Falcon mode but</span>
<span class="cm">			 * doesn&#39;t set st_shift. st_shift != 0 (!= 4planes) is impossible</span>
<span class="cm">			 * with Falcon palette.</span>
<span class="cm">			 */</span>
			<span class="n">videl</span><span class="p">.</span><span class="n">st_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* now back to Falcon palette mode */</span>
			<span class="n">videl</span><span class="p">.</span><span class="n">f_shift</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">f_shift</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* writing to st_shift changed scn_width and vid_mode */</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">shifter_f030</span><span class="p">.</span><span class="n">scn_width</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">line_width</span><span class="p">;</span>
		<span class="n">shifter_f030</span><span class="p">.</span><span class="n">off_next</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">line_offset</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_control</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">vid_mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f_pan_display</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f_pan_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">videl</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">shifter_f030</span><span class="p">.</span><span class="n">off_next</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">line_offset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">falcon_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">line_offset</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">xoffset</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">line_offset</span> <span class="o">-=</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">-</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">xoffset</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">screen_base</span> <span class="o">+</span>
	        <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="n">xoffset</span><span class="p">)</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_screen_base</span><span class="p">)</span>
		<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_screen_base</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* shouldn&#39;t happen */</span>
	<span class="n">f_pan_display</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">falcon_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">f030_col</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shifter_tt</span><span class="p">.</span><span class="n">color_reg</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">)[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">|</span>
						       <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
						       <span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">falcon_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ++guenther: we can switch off graphics by changing VDB and VDE,</span>
<span class="cm">	 * so VIDEL doesn&#39;t hog the bus while saving.</span>
<span class="cm">	 * (this may affect usleep()).</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">vdb</span><span class="p">,</span> <span class="n">vss</span><span class="p">,</span> <span class="n">hbe</span><span class="p">,</span> <span class="n">hss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mon_type</span> <span class="o">==</span> <span class="n">F_MON_SM</span><span class="p">)</span>	<span class="cm">/* this doesn&#39;t work on SM124 */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vdb</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">VDB</span><span class="p">;</span>
	<span class="n">vss</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">VSS</span><span class="p">;</span>
	<span class="n">hbe</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">HBE</span><span class="p">;</span>
	<span class="n">hss</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">HSS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blank_mode</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable graphics output (this speeds up the CPU) ... */</span>
		<span class="n">vdb</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">VFT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* ... and blank all lines */</span>
		<span class="n">hbe</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">HHT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* use VESA suspend modes on VGA monitors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mon_type</span> <span class="o">==</span> <span class="n">F_MON_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blank_mode</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">blank_mode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">vss</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">VFT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blank_mode</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">blank_mode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">hss</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">HHT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">videl</span><span class="p">.</span><span class="n">vdb</span> <span class="o">=</span> <span class="n">vdb</span><span class="p">;</span>
	<span class="n">videl</span><span class="p">.</span><span class="n">vss</span> <span class="o">=</span> <span class="n">vss</span><span class="p">;</span>
	<span class="n">videl</span><span class="p">.</span><span class="n">hbe</span> <span class="o">=</span> <span class="n">hbe</span><span class="p">;</span>
	<span class="n">videl</span><span class="p">.</span><span class="n">hss</span> <span class="o">=</span> <span class="n">hss</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">falcon_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fhw</span><span class="p">;</span>

	<span class="cm">/* Determine connected monitor and set monitor parameters */</span>
	<span class="n">fhw</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xffff8006</span><span class="p">;</span>
	<span class="n">mon_type</span> <span class="o">=</span> <span class="n">fhw</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="cm">/* bit 1 of fhw: 1=32 bit ram bus, 0=16 bit */</span>
	<span class="n">f030_bus_width</span> <span class="o">=</span> <span class="n">fhw</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mon_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">F_MON_SM</span>:
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">35713</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">35715</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">F_MON_SC</span>:
	<span class="k">case</span> <span class="n">F_MON_TV</span>:
		<span class="cm">/* PAL...NTSC */</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">49</span><span class="p">;</span>	<span class="cm">/* not 50, since TOS defaults to 49.9x Hz */</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">15620</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">15755</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* initialize hsync-len */</span>
	<span class="n">f25</span><span class="p">.</span><span class="n">hsync</span> <span class="o">=</span> <span class="n">h_syncs</span><span class="p">[</span><span class="n">mon_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">f25</span><span class="p">.</span><span class="n">t</span><span class="p">;</span>
	<span class="n">f32</span><span class="p">.</span><span class="n">hsync</span> <span class="o">=</span> <span class="n">h_syncs</span><span class="p">[</span><span class="n">mon_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">f32</span><span class="p">.</span><span class="n">t</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fext</span><span class="p">.</span><span class="n">t</span><span class="p">)</span>
		<span class="n">fext</span><span class="p">.</span><span class="n">hsync</span> <span class="o">=</span> <span class="n">h_syncs</span><span class="p">[</span><span class="n">mon_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">fext</span><span class="p">.</span><span class="n">t</span><span class="p">;</span>

	<span class="n">falcon_get_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="n">falcon_encode_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atafb_predefined</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>

	<span class="cm">/* Detected mode is always the &quot;autodetect&quot; slot */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* ATAFB_FALCON */</span><span class="cp"></span>

<span class="cm">/* ------------------- ST(E) specific functions ---------------------- */</span>

<span class="cp">#ifdef ATAFB_STE</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stste_encode_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Atari Builtin&quot;</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">real_screen_base</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">screen_len</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ST_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_ATARIBLITT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stste_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mono_moni</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">st_yres</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ST_HIGH</span><span class="p">;</span>
		<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
		<span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span><span class="p">;</span>
		<span class="n">bpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">st_yres</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ST_LOW</span><span class="p">;</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">sttt_xres</span> <span class="o">||</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ST_MID</span><span class="p">;</span>
			<span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
			<span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">yres</span><span class="p">)</span>
		<span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_EXT</span><span class="p">)</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">linelen</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">linelen</span> <span class="o">&gt;</span> <span class="n">screen_len</span> <span class="o">&amp;&amp;</span> <span class="n">screen_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">*</span> <span class="n">linelen</span> <span class="o">&gt;</span> <span class="n">screen_len</span> <span class="o">&amp;&amp;</span> <span class="n">screen_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">yres</span> <span class="o">&gt;</span> <span class="n">yres_virtual</span> <span class="o">&amp;&amp;</span> <span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">screen_base</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stste_encode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="p">));</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">31041</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>		<span class="cm">/* these are incorrect */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="mi">140</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="n">FB_SYNC_EXT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ST_LOW</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_MID</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_HIGH</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">sttt_xres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">st_yres</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sttt_xres_virtual</span><span class="p">;</span>
	<span class="n">linelen</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ovsc_addlen</span> <span class="o">=</span> <span class="n">linelen</span> <span class="o">*</span> <span class="p">(</span><span class="n">sttt_yres_virtual</span> <span class="o">-</span> <span class="n">st_yres</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_hwscroll</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">screen_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* yres_virtual == 0 means use maximum */</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">screen_len</span> <span class="o">/</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwscroll</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">hwscroll</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">-</span> <span class="n">screen_base</span><span class="p">)</span> <span class="o">/</span> <span class="n">linelen</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stste_get_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">shifter_tt</span><span class="p">.</span><span class="n">st_shiftmode</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">shifter</span><span class="p">.</span><span class="n">syncmode</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_hi</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">((</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_md</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">shifter</span><span class="p">.</span><span class="n">bas_lo</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stste_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">shifter_tt</span><span class="p">.</span><span class="n">st_shiftmode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">shifter</span><span class="p">.</span><span class="n">syncmode</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">st</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
	<span class="cm">/* only set screen_base if really necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_par</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">!=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_screen_base</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stste_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">))</span>
		<span class="n">shifter_tt</span><span class="p">.</span><span class="n">color_reg</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">shifter_tt</span><span class="p">.</span><span class="n">color_reg</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stste_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">par</span><span class="p">;</span>

	<span class="cm">/* Determine the connected monitor: The DMA sound must be</span>
<span class="cm">	 * disabled before reading the MFP GPIP, because the Sound</span>
<span class="cm">	 * Done Signal and the Monochrome Detect are XORed together!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">PCM_8BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DMASND_CTRL_OFF</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>		<span class="cm">/* wait a while for things to settle down */</span>
	<span class="p">}</span>
	<span class="n">mono_moni</span> <span class="o">=</span> <span class="p">(</span><span class="n">st_mfp</span><span class="p">.</span><span class="n">par_dt_reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stste_get_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="n">stste_encode_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atafb_predefined</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">))</span>
		<span class="n">use_hwscroll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stste_set_screen_base</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">s_base</span><span class="p">);</span>
	<span class="cm">/* Setup Screen Memory */</span>
	<span class="n">shifter</span><span class="p">.</span><span class="n">bas_hi</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">shifter</span><span class="p">.</span><span class="n">bas_md</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">))</span>
		<span class="n">shifter</span><span class="p">.</span><span class="n">bas_lo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x0000ff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* ATAFB_STE */</span><span class="cp"></span>

<span class="cm">/* Switching the screen size should be done during vsync, otherwise</span>
<span class="cm"> * the margins may get messed up. This is a well known problem of</span>
<span class="cm"> * the ST&#39;s video system.</span>
<span class="cm"> *</span>
<span class="cm"> * Unfortunately there is hardly any way to find the vsync, as the</span>
<span class="cm"> * vertical blank interrupt is no longer in time on machines with</span>
<span class="cm"> * overscan type modifications.</span>
<span class="cm"> *</span>
<span class="cm"> * We can, however, use Timer B to safely detect the black shoulder,</span>
<span class="cm"> * but then we&#39;ve got to guess an appropriate delay to find the vsync.</span>
<span class="cm"> * This might not work on every machine.</span>
<span class="cm"> *</span>
<span class="cm"> * martin_rogge @ ki.maus.de, 8th Aug 1995</span>
<span class="cm"> */</span>

<span class="cp">#define LINE_DELAY  (mono_moni ? 30 : 70)</span>
<span class="cp">#define SYNC_DELAY  (mono_moni ? 1500 : 2000)</span>

<span class="cm">/* SWITCH_ACIA may be used for Falcon (ScreenBlaster III internal!) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">st_ovsc_switch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_OVSC_MASK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_ct_b</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">active_edge</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_ct_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_dt_b</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_ct_b</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_dt_b</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* TOS does it this way, don&#39;t ask why */</span>
		<span class="p">;</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_dt_b</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">LINE_DELAY</span><span class="p">);</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_dt_b</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_ct_b</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">SYNC_DELAY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_OVSC_IKBD</span><span class="p">)</span>
		<span class="n">acia</span><span class="p">.</span><span class="n">key_ctrl</span> <span class="o">=</span> <span class="n">ACIA_DIV64</span> <span class="o">|</span> <span class="n">ACIA_D8N1S</span> <span class="o">|</span> <span class="n">ACIA_RHTID</span> <span class="o">|</span> <span class="n">ACIA_RIE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_OVSC_MIDI</span><span class="p">)</span>
		<span class="n">acia</span><span class="p">.</span><span class="n">mid_ctrl</span> <span class="o">=</span> <span class="n">ACIA_DIV16</span> <span class="o">|</span> <span class="n">ACIA_D8N1S</span> <span class="o">|</span> <span class="n">ACIA_RHTID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATARI_SWITCH_OVSC_SND6</span><span class="o">|</span><span class="n">ATARI_SWITCH_OVSC_SND7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sound_ym</span><span class="p">.</span><span class="n">rd_data_reg_sel</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">sound_ym</span><span class="p">.</span><span class="n">wd_data</span> <span class="o">=</span> <span class="n">sound_ym</span><span class="p">.</span><span class="n">rd_data_reg_sel</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_OVSC_SND6</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x40</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_OVSC_SND7</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------- External Video ---------------------- */</span>

<span class="cp">#ifdef ATAFB_EXT</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext_encode_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Unknown Extern&quot;</span><span class="p">);</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">external_addr</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">external_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">external_depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
		<span class="cm">/* The letters &#39;n&#39; and &#39;i&#39; in the &quot;atavideo=external:&quot; stand</span>
<span class="cm">		 * for &quot;normal&quot; and &quot;inverted&quot;, rsp., in the monochrome case */</span>
		<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">external_pmode</span> <span class="o">==</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span> <span class="o">||</span>
			 <span class="n">external_pmode</span> <span class="o">==</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">FB_VISUAL_MONO10</span> <span class="o">:</span> <span class="n">FB_VISUAL_MONO01</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Use STATIC if we don&#39;t know how to access color registers */</span>
		<span class="kt">int</span> <span class="n">visual</span> <span class="o">=</span> <span class="n">external_vgaiobase</span> <span class="o">?</span>
					 <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span>
					 <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">external_pmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:		<span class="cm">/* truecolor */</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_TYPE_PACKED_PIXELS</span>:
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">visual</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_TYPE_PLANES</span>:
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PLANES</span><span class="p">;</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">visual</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span>:
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span><span class="p">;</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">visual</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext_decode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">myvar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atafb_predefined</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="n">myvar</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">myvar</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&gt;</span> <span class="n">myvar</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">myvar</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">=</span> <span class="n">external_xres_virtual</span> <span class="o">*</span> <span class="n">external_depth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext_encode_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span><span class="p">));</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">external_pmode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">external_depth</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">external_vgaiobase</span> <span class="o">?</span> <span class="n">external_bitspercol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">31041</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>		<span class="cm">/* these are surely incorrect */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="mi">140</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">external_xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">external_yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">external_xres_virtual</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">external_depth</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext_get_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">external_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#define OUTB(port,val) \</span>
<span class="cp">	*((unsigned volatile char *) ((port)+external_vgaiobase)) = (val)</span>
<span class="cp">#define INB(port) \</span>
<span class="cp">	(*((unsigned volatile char *) ((port)+external_vgaiobase)))</span>
<span class="cp">#define DACDelay				\</span>
<span class="cp">	do {					\</span>
<span class="cp">		unsigned char tmp = INB(0x3da);	\</span>
<span class="cp">		tmp = INB(0x3da);			\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">colmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">external_bitspercol</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">external_vgaiobase</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">external_card_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IS_VGA</span>:
		<span class="n">OUTB</span><span class="p">(</span><span class="mh">0x3c8</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
		<span class="n">DACDelay</span><span class="p">;</span>
		<span class="n">OUTB</span><span class="p">(</span><span class="mh">0x3c9</span><span class="p">,</span> <span class="n">red</span> <span class="o">&amp;</span> <span class="n">colmask</span><span class="p">);</span>
		<span class="n">DACDelay</span><span class="p">;</span>
		<span class="n">OUTB</span><span class="p">(</span><span class="mh">0x3c9</span><span class="p">,</span> <span class="n">green</span> <span class="o">&amp;</span> <span class="n">colmask</span><span class="p">);</span>
		<span class="n">DACDelay</span><span class="p">;</span>
		<span class="n">OUTB</span><span class="p">(</span><span class="mh">0x3c9</span><span class="p">,</span> <span class="n">blue</span> <span class="o">&amp;</span> <span class="n">colmask</span><span class="p">);</span>
		<span class="n">DACDelay</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IS_MV300</span>:
		<span class="n">OUTB</span><span class="p">((</span><span class="n">MV300_reg</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">red</span><span class="p">);</span>
		<span class="n">OUTB</span><span class="p">((</span><span class="n">MV300_reg</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">green</span><span class="p">);</span>
		<span class="n">OUTB</span><span class="p">((</span><span class="n">MV300_reg</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">myvar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atafb_predefined</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">dummy_par</span><span class="p">;</span>

	<span class="n">myvar</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">external_xres</span><span class="p">;</span>
	<span class="n">myvar</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">external_xres_virtual</span><span class="p">;</span>
	<span class="n">myvar</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">external_yres</span><span class="p">;</span>
	<span class="n">myvar</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">external_depth</span><span class="p">;</span>
	<span class="n">ext_encode_var</span><span class="p">(</span><span class="n">myvar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* ATAFB_EXT */</span><span class="cp"></span>

<span class="cm">/* ------ This is the same for most hardware types -------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_screen_base</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">s_base</span><span class="p">);</span>
	<span class="cm">/* Setup Screen Memory */</span>
	<span class="n">shifter</span><span class="p">.</span><span class="n">bas_hi</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">shifter</span><span class="p">.</span><span class="n">bas_md</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">shifter</span><span class="p">.</span><span class="n">bas_lo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x0000ff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_screen_base</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">screen_base</span> <span class="o">+</span>
	        <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">)</span>
	        <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_screen_base</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------ Interfaces to hardware functions ------------ */</span>

<span class="cp">#ifdef ATAFB_TT</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_hwswitch</span> <span class="n">tt_switch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">tt_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_fix</span>	<span class="o">=</span> <span class="n">tt_encode_fix</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_var</span>	<span class="o">=</span> <span class="n">tt_decode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_var</span>	<span class="o">=</span> <span class="n">tt_encode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_par</span>	<span class="o">=</span> <span class="n">tt_get_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_par</span>	<span class="o">=</span> <span class="n">tt_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_screen_base</span> <span class="o">=</span> <span class="n">set_screen_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pan_display</span>	<span class="o">=</span> <span class="n">pan_display</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef ATAFB_FALCON</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_hwswitch</span> <span class="n">falcon_switch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">falcon_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_fix</span>	<span class="o">=</span> <span class="n">falcon_encode_fix</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_var</span>	<span class="o">=</span> <span class="n">falcon_decode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_var</span>	<span class="o">=</span> <span class="n">falcon_encode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_par</span>	<span class="o">=</span> <span class="n">falcon_get_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_par</span>	<span class="o">=</span> <span class="n">falcon_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_screen_base</span> <span class="o">=</span> <span class="n">set_screen_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blank</span>		<span class="o">=</span> <span class="n">falcon_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pan_display</span>	<span class="o">=</span> <span class="n">falcon_pan_display</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef ATAFB_STE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_hwswitch</span> <span class="n">st_switch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">stste_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_fix</span>	<span class="o">=</span> <span class="n">stste_encode_fix</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_var</span>	<span class="o">=</span> <span class="n">stste_decode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_var</span>	<span class="o">=</span> <span class="n">stste_encode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_par</span>	<span class="o">=</span> <span class="n">stste_get_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_par</span>	<span class="o">=</span> <span class="n">stste_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_screen_base</span> <span class="o">=</span> <span class="n">stste_set_screen_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pan_display</span>	<span class="o">=</span> <span class="n">pan_display</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef ATAFB_EXT</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_hwswitch</span> <span class="n">ext_switch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">ext_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_fix</span>	<span class="o">=</span> <span class="n">ext_encode_fix</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_var</span>	<span class="o">=</span> <span class="n">ext_decode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_var</span>	<span class="o">=</span> <span class="n">ext_encode_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_par</span>	<span class="o">=</span> <span class="n">ext_get_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_par</span>	<span class="o">=</span> <span class="n">ext_set_par</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_get_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_par_valid</span><span class="p">)</span>
		<span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">get_par</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">set_par</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="n">current_par</span> <span class="o">=</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">current_par_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* =========================================================== */</span>
<span class="cm">/* ============== Hardware Independent Functions ============= */</span>
<span class="cm">/* =========================================================== */</span>

<span class="cm">/* used for hardware scrolling */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_fb_set_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isactive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">activate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">par</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">decode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">activate</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">&amp;</span> <span class="n">FB_ACTIVATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isactive</span><span class="p">)</span>
		<span class="n">ata_set_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">encode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="n">activate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* fbhw-&gt;encode_fix() must be called with fb_info-&gt;mm_lock held</span>
<span class="cm"> * if it is called after the register_framebuffer() - not a case here</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atafb_get_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Get fix directly (case con == -1 before)??</p></td><td class="code"><div class="highlight"><pre>	<span class="n">err</span> <span class="o">=</span> <span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">decode_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">encode_fix</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atafb_get_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">par</span><span class="p">;</span>

	<span class="n">ata_get_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">encode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>No longer called by fbcon!
Still called by set_var internally</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">atafb_set_disp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atafb_get_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">atafb_get_fix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atafb_setcolreg</span><span class="p">(</span><span class="n">u_int</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">red</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">green</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="n">u_int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_setcolreg</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">transp</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atafb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">yoffset</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">||</span> <span class="n">xoffset</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">||</span>
		    <span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">pan_display</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">pan_display</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">xoffset</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generic drawing routines; imageblit needs updating for image depth &gt; 1</span>
<span class="cm"> */</span>

<span class="cp">#if BITS_PER_LONG == 32</span>
<span class="cp">#define BYTES_PER_LONG	4</span>
<span class="cp">#define SHIFT_PER_LONG	5</span>
<span class="cp">#elif BITS_PER_LONG == 64</span>
<span class="cp">#define BYTES_PER_LONG	8</span>
<span class="cp">#define SHIFT_PER_LONG	6</span>
<span class="cp">#else</span>
<span class="cp">#define Please update me</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">atafb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="o">!</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef ATAFB_FALCON</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could use hardware clipping but on many cards you get around</span>
<span class="cm">	 * hardware clipping by writing to framebuffer directly.</span>
<span class="cm">	 * */</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">atafb_mfb_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span>
				   <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">atafb_iplan2p2_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span>
					<span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">atafb_iplan2p4_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span>
					<span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atafb_iplan2p8_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span>
					<span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atafb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rev_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef ATAFB_FALCON</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* clip the destination */</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">||</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">&lt;</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* update sx,sy */</span>
	<span class="n">sx</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sx</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span> <span class="o">-</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">);</span>
	<span class="n">sy</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">-</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">);</span>

	<span class="cm">/* the source must be completely inside the virtual screen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">||</span>
			<span class="n">sy</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">sy</span> <span class="o">||</span> <span class="p">(</span><span class="n">dy</span> <span class="o">==</span> <span class="n">sy</span> <span class="o">&amp;&amp;</span> <span class="n">dx</span> <span class="o">&gt;</span> <span class="n">sx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dy</span> <span class="o">+=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">sy</span> <span class="o">+=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">rev_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">atafb_mfb_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">atafb_iplan2p2_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">atafb_iplan2p4_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atafb_iplan2p8_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atafb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pitch</span><span class="p">;</span>

<span class="cp">#ifdef ATAFB_FALCON</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfb_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could use hardware clipping but on many cards you get around</span>
<span class="cm">	 * hardware clipping by writing to framebuffer directly like we are</span>
<span class="cm">	 * doing here.</span>
<span class="cm">	 */</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">dy</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">?</span> <span class="n">x2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">?</span> <span class="n">y2</span> <span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">dx</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">dy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>used for font data</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">dst_idx</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BYTES_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">dst_idx</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">dx</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">height</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">atafb_mfb_linefill</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span>
						   <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
						   <span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">atafb_iplan2p2_linefill</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span>
							<span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
							<span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">atafb_iplan2p4_linefill</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span>
							<span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
							<span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">atafb_iplan2p8_linefill</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span>
							<span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
							<span class="n">image</span><span class="o">-&gt;</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">fg_color</span><span class="p">);</span>
			<span class="n">dy</span><span class="o">++</span><span class="p">;</span>
			<span class="n">src</span> <span class="o">+=</span> <span class="n">pitch</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c2p_iplan2</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
			   <span class="n">height</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">next_line</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			   <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atafb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef FBCMD_GET_CURRENTPAR</span>
	<span class="k">case</span> <span class="n">FBCMD_GET_CURRENTPAR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_par</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef FBCMD_SET_CURRENTPAR</span>
	<span class="k">case</span> <span class="n">FBCMD_SET_CURRENTPAR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_par</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ata_set_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_par</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* (un)blank/poweroff</span>
<span class="cm"> * 0 = unblank</span>
<span class="cm"> * 1 = blank</span>
<span class="cm"> * 2 = suspend vsync</span>
<span class="cm"> * 3 = suspend hsync</span>
<span class="cm"> * 4 = off</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atafb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">black</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">fb_cmap</span> <span class="n">cmap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">blank</span><span class="p">(</span><span class="n">blank</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">black</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">));</span>
		<span class="n">cmap</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="n">black</span><span class="p">;</span>
		<span class="n">cmap</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">black</span><span class="p">;</span>
		<span class="n">cmap</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">black</span><span class="p">;</span>
		<span class="n">cmap</span><span class="p">.</span><span class="n">transp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmap</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">fb_set_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmap</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	else</span>
<span class="c">		do_install_cmap(info);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * New fbcon interface ...</span>
<span class="cm">	 */</span>

	 <span class="cm">/* check var by decoding var into hw par, rounding if necessary,</span>
<span class="cm">	  * then encoding hw par back into new, validated var */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atafb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="n">par</span><span class="p">;</span>

	<span class="cm">/* Validate wanted screen parameters */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>if ((err = ata<em>decode</em>var(var, &amp;par)))</p></td><td class="code"><div class="highlight"><pre>	<span class="n">err</span> <span class="o">=</span> <span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">decode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Encode (possibly rounded) screen parameters */</span>
	<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">encode_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/* actually set hw par by decoding var, then setting hardware from</span>
<span class="cm">	 * hw par just decoded */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atafb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atafb_par</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="cm">/* Decode wanted screen parameters */</span>
	<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">decode_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">encode_fix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>

	<span class="cm">/* Set new videomode */</span>
	<span class="n">ata_set_par</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">atafb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">atafb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">atafb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">atafb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span>	<span class="n">atafb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span>	<span class="o">=</span> <span class="n">atafb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">atafb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">atafb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">atafb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span> <span class="o">=</span>	<span class="n">atafb_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_default_par</span><span class="p">(</span><span class="kt">int</span> <span class="n">detected_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">default_name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">var</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_mem</span><span class="p">;</span>

	<span class="cm">/* First try the user supplied mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_par</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">atafb_predefined</span><span class="p">[</span><span class="n">default_par</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_fb_set_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">default_par</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* failed */</span>
	<span class="p">}</span>
	<span class="cm">/* Next is the autodetected one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_par</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">atafb_predefined</span><span class="p">[</span><span class="n">detected_mode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span> <span class="cm">/* autodetect */</span>
		<span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_fb_set_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">default_par</span> <span class="o">=</span> <span class="n">detected_mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If that also failed, try some default modes... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_par</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* try default1, default2... */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">default_name</span><span class="p">,</span><span class="s">&quot;default%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">default_par</span> <span class="o">=</span> <span class="n">get_video_mode</span><span class="p">(</span><span class="n">default_name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_par</span><span class="p">)</span>
				<span class="n">panic</span><span class="p">(</span><span class="s">&quot;can&#39;t set default video mode&quot;</span><span class="p">);</span>
			<span class="n">var</span> <span class="o">=</span> <span class="n">atafb_predefined</span><span class="p">[</span><span class="n">default_par</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_TEST</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_fb_set_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* ok */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">min_mem</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_mem_req</span> <span class="o">&lt;</span> <span class="n">min_mem</span><span class="p">)</span>
		<span class="n">default_mem_req</span> <span class="o">=</span> <span class="n">min_mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef ATAFB_EXT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">atafb_setup_ext</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">xres_virtual</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">planes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="cm">/* Format is: &lt;xres&gt;;&lt;yres&gt;;&lt;depth&gt;;&lt;plane organ.&gt;;</span>
<span class="cm">	 *            &lt;screen mem addr&gt;</span>
<span class="cm">	 *	      [;&lt;screen mem length&gt;[;&lt;vgaiobase&gt;[;&lt;bits-per-col&gt;[;&lt;colorreg-type&gt;</span>
<span class="cm">	 *	      [;&lt;xres-virtual&gt;]]]]]</span>
<span class="cm">	 *</span>
<span class="cm">	 * 09/23/97	Juergen</span>
<span class="cm">	 * &lt;xres_virtual&gt;:	hardware&#39;s x-resolution (f.e. ProMST)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Even xres_virtual is available, we neither support panning nor hw-scrolling!</span>
<span class="cm">	 */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yres</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">depth</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
	    <span class="n">depth</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;i&#39;</span><span class="p">)</span>
		<span class="n">planes</span> <span class="o">=</span> <span class="n">FB_TYPE_INTERLEAVED_PLANES</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;p&#39;</span><span class="p">)</span>
		<span class="n">planes</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span><span class="p">)</span>
		<span class="n">planes</span> <span class="o">=</span> <span class="n">FB_TYPE_PLANES</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;t&#39;</span><span class="p">)</span>
		<span class="n">planes</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* true color */</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">xres</span> <span class="o">*</span> <span class="n">yres</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
		<span class="n">external_vgaiobase</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">external_bitspercol</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">external_bitspercol</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">external_bitspercol</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">external_bitspercol</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">external_bitspercol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;vga&quot;</span><span class="p">))</span>
			<span class="n">external_card_type</span> <span class="o">=</span> <span class="n">IS_VGA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;mv300&quot;</span><span class="p">))</span>
			<span class="n">external_card_type</span> <span class="o">=</span> <span class="n">IS_MV300</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">xres</span><span class="p">)</span>
			<span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">yres</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">yres</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">external_xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">external_xres_virtual</span> <span class="o">=</span> <span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">external_yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
	<span class="n">external_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">external_pmode</span> <span class="o">=</span> <span class="n">planes</span><span class="p">;</span>
	<span class="n">external_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">external_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">external_card_type</span> <span class="o">==</span> <span class="n">IS_MV300</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">external_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">MV300_reg</span> <span class="o">=</span> <span class="n">MV300_reg_1bit</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">MV300_reg</span> <span class="o">=</span> <span class="n">MV300_reg_4bit</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">MV300_reg</span> <span class="o">=</span> <span class="n">MV300_reg_8bit</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* ATAFB_EXT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">atafb_setup_int</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Format to config extended internal video hardware like OverScan:</span>
<span class="cm">	 * &quot;internal:&lt;xres&gt;;&lt;yres&gt;;&lt;xres_max&gt;;&lt;yres_max&gt;;&lt;offset&gt;&quot;</span>
<span class="cm">	 * Explanation:</span>
<span class="cm">	 * &lt;xres&gt;: x-resolution</span>
<span class="cm">	 * &lt;yres&gt;: y-resolution</span>
<span class="cm">	 * The following are only needed if you have an overscan which</span>
<span class="cm">	 * needs a black border:</span>
<span class="cm">	 * &lt;xres_max&gt;: max. length of a line in pixels your OverScan hardware would allow</span>
<span class="cm">	 * &lt;yres_max&gt;: max. number of lines your OverScan hardware would allow</span>
<span class="cm">	 * &lt;offset&gt;: Offset from physical beginning to visible beginning</span>
<span class="cm">	 *	  of screen in bytes</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">xres</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">xres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sttt_xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
	<span class="n">tt_yres</span> <span class="o">=</span> <span class="n">st_yres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
		<span class="n">sttt_xres_virtual</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
		<span class="n">sttt_yres_virtual</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
		<span class="n">ovsc_offset</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovsc_offset</span> <span class="o">||</span> <span class="p">(</span><span class="n">sttt_yres_virtual</span> <span class="o">!=</span> <span class="n">st_yres</span><span class="p">))</span>
		<span class="n">use_hwscroll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef ATAFB_FALCON</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">atafb_setup_mcap</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">hmin</span><span class="p">,</span> <span class="n">hmax</span><span class="p">;</span>

	<span class="cm">/* Format for monitor capabilities is: &lt;Vmin&gt;;&lt;Vmax&gt;;&lt;Hmin&gt;;&lt;Hmax&gt;</span>
<span class="cm">	 * &lt;V*&gt; vertical freq. in Hz</span>
<span class="cm">	 * &lt;H*&gt; horizontal freq. in kHz</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">vmin</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmin</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">vmax</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vmax</span> <span class="o">&lt;=</span> <span class="n">vmin</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">hmin</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmin</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">hmax</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmax</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hmax</span> <span class="o">&lt;=</span> <span class="n">hmin</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="n">hmin</span><span class="p">;</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="n">hmax</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* ATAFB_FALCON */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">atafb_setup_user</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Format of user defined video mode is: &lt;xres&gt;;&lt;yres&gt;;&lt;depth&gt;</span>
<span class="cm">	 */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">xres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">yres</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="o">!*</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">depth</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">get_video_mode</span><span class="p">(</span><span class="s">&quot;user0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">default_par</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">atafb_predefined</span><span class="p">[</span><span class="n">default_par</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">xres</span> <span class="o">=</span> <span class="n">xres</span><span class="p">;</span>
		<span class="n">atafb_predefined</span><span class="p">[</span><span class="n">default_par</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">yres</span> <span class="o">=</span> <span class="n">yres</span><span class="p">;</span>
		<span class="n">atafb_predefined</span><span class="p">[</span><span class="n">default_par</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">atafb_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">this_opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">=</span> <span class="n">get_video_mode</span><span class="p">(</span><span class="n">this_opt</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">default_par</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">mode_option</span> <span class="o">=</span> <span class="n">this_opt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;inverse&quot;</span><span class="p">))</span>
			<span class="n">inverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;hwscroll_&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hwscroll</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hwscroll</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">hwscroll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hwscroll</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>
				<span class="n">hwscroll</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef ATAFB_EXT</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;mv300&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">external_bitspercol</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">external_card_type</span> <span class="o">=</span> <span class="n">IS_MV300</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;external:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">atafb_setup_ext</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;internal:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">atafb_setup_int</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
<span class="cp">#ifdef ATAFB_FALCON</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;eclock:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fext</span><span class="p">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="cm">/* external pixelclock in kHz --&gt; ps */</span>
			<span class="n">fext</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">fext</span><span class="p">.</span><span class="n">f</span><span class="p">;</span>
			<span class="n">fext</span><span class="p">.</span><span class="n">f</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;monitorcap:&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
			<span class="n">atafb_setup_mcap</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">11</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;keep&quot;</span><span class="p">))</span>
			<span class="n">DontCalcRes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">this_opt</span><span class="p">,</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">atafb_setup_user</span><span class="p">(</span><span class="n">this_opt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">atafb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="n">detected_mode</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">defmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_req</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;atafb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">atafb_setup</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atafb_init: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_ATARI</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
<span class="cp">#ifdef ATAFB_EXT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">external_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atafb_init: initializing external hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fbhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext_switch</span><span class="p">;</span>
			<span class="n">atafb_ops</span><span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext_setcolreg</span><span class="p">;</span>
			<span class="n">defmode</span> <span class="o">=</span> <span class="n">DEFMODE_EXT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ATAFB_TT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">TT_SHIFTER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atafb_init: initializing TT hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fbhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tt_switch</span><span class="p">;</span>
			<span class="n">atafb_ops</span><span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tt_setcolreg</span><span class="p">;</span>
			<span class="n">defmode</span> <span class="o">=</span> <span class="n">DEFMODE_TT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ATAFB_FALCON</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">VIDEL_SHIFTER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atafb_init: initializing Falcon hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fbhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">falcon_switch</span><span class="p">;</span>
			<span class="n">atafb_ops</span><span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">falcon_setcolreg</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_AUTO_4</span><span class="p">,</span> <span class="n">falcon_vbl_switcher</span><span class="p">,</span>
					    <span class="n">IRQ_TYPE_PRIO</span><span class="p">,</span>
					    <span class="s">&quot;framebuffer:modeswitch&quot;</span><span class="p">,</span>
					    <span class="n">falcon_vbl_switcher</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">defmode</span> <span class="o">=</span> <span class="n">DEFMODE_F30</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ATAFB_STE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">STND_SHIFTER</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">EXTD_SHIFTER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atafb_init: initializing ST/E hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fbhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st_switch</span><span class="p">;</span>
			<span class="n">atafb_ops</span><span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stste_setcolreg</span><span class="p">;</span>
			<span class="n">defmode</span> <span class="o">=</span> <span class="n">DEFMODE_STE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fbhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st_switch</span><span class="p">;</span>
		<span class="n">atafb_ops</span><span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stste_setcolreg</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Cannot determine video hardware; defaulting to ST(e)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* ATAFB_STE */</span><span class="cp"></span>
		<span class="cm">/* no default driver included */</span>
		<span class="cm">/* Nobody will ever see this message :-) */</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Cannot initialize video hardware&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Multisync monitor capabilities */</span>
	<span class="cm">/* Atari-TOS defaults if no boot option present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">31000</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">58</span><span class="p">;</span>
		<span class="n">fb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">62</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">detected_mode</span> <span class="o">=</span> <span class="n">fbhw</span><span class="o">-&gt;</span><span class="n">detect</span><span class="p">();</span>
	<span class="n">check_default_par</span><span class="p">(</span><span class="n">detected_mode</span><span class="p">);</span>
<span class="cp">#ifdef ATAFB_EXT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">external_addr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif </span><span class="cm">/* ATAFB_EXT */</span><span class="cp"></span>
		<span class="n">mem_req</span> <span class="o">=</span> <span class="n">default_mem_req</span> <span class="o">+</span> <span class="n">ovsc_offset</span> <span class="o">+</span> <span class="n">ovsc_addlen</span><span class="p">;</span>
		<span class="n">mem_req</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">mem_req</span><span class="p">)</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">screen_base</span> <span class="o">=</span> <span class="n">atari_stram_alloc</span><span class="p">(</span><span class="n">mem_req</span><span class="p">,</span> <span class="s">&quot;atafb&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">screen_base</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Cannot allocate screen memory&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">screen_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mem_req</span><span class="p">);</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">screen_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">screen_base</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">;</span>
		<span class="n">real_screen_base</span> <span class="o">=</span> <span class="n">screen_base</span> <span class="o">+</span> <span class="n">ovsc_offset</span><span class="p">;</span>
		<span class="n">screen_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_req</span> <span class="o">-</span> <span class="n">pad</span> <span class="o">-</span> <span class="n">ovsc_offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">st_ovsc_switch</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CPU_IS_040_OR_060</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* On a &#39;040+, the cache mode of video RAM must be set to</span>
<span class="cm">			 * write-through also for internal video hardware! */</span>
			<span class="n">cache_push</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">screen_base</span><span class="p">),</span> <span class="n">screen_len</span><span class="p">);</span>
			<span class="n">kernel_set_cachemode</span><span class="p">(</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">screen_len</span><span class="p">,</span>
					     <span class="n">IOMAP_WRITETHROUGH</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;atafb: screen_base %p real_screen_base %p screen_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">screen_base</span><span class="p">,</span> <span class="n">real_screen_base</span><span class="p">,</span> <span class="n">screen_len</span><span class="p">);</span>
<span class="cp">#ifdef ATAFB_EXT</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Map the video memory (physical address given) to somewhere</span>
<span class="cm">		 * in the kernel address space.</span>
<span class="cm">		 */</span>
		<span class="n">external_addr</span> <span class="o">=</span> <span class="n">ioremap_writethrough</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">external_addr</span><span class="p">,</span>
						     <span class="n">external_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">external_vgaiobase</span><span class="p">)</span>
			<span class="n">external_vgaiobase</span> <span class="o">=</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">external_vgaiobase</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
		<span class="n">screen_base</span> <span class="o">=</span>
		<span class="n">real_screen_base</span> <span class="o">=</span> <span class="n">external_addr</span><span class="p">;</span>
		<span class="n">screen_len</span> <span class="o">=</span> <span class="n">external_len</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">memset</span> <span class="p">(</span><span class="n">screen_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">external_len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* ATAFB_EXT */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>strcpy(fb_info.mode->name, "Atari Builtin ");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">fb_info</span><span class="p">.</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atafb_ops</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>try to set default (detected; requested) var</p></td><td class="code"><div class="highlight"><pre>	<span class="n">do_fb_set_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atafb_predefined</span><span class="p">[</span><span class="n">default_par</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>reads hw state into current par, which may not be sane yet</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ata_get_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_par</span><span class="p">);</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">par</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_par</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>tries to read from HW which may not be initialized yet
so set sane var first, then call atafb<em>set</em>par</p></td><td class="code"><div class="highlight"><pre>	<span class="n">atafb_get_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">);</span>

<span class="cp">#ifdef ATAFB_FALCON</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">current_par</span><span class="p">.</span><span class="n">hw</span><span class="p">.</span><span class="n">falcon</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">fb_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">,</span> <span class="n">mode_option</span><span class="p">,</span> <span class="n">atafb_modedb</span><span class="p">,</span>
			  <span class="n">NUM_TOTAL_MODES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atafb_modedb</span><span class="p">[</span><span class="n">defmode</span><span class="p">],</span>
			  <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">atafb_modedb</span><span class="p">,</span> <span class="n">NUM_TOTAL_MODES</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">fb_info</span><span class="p">.</span><span class="n">modelist</span><span class="p">);</span>

	<span class="n">atafb_set_disp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">);</span>

	<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">cmap</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Determined %dx%d, depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">!=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">!=</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   virtual %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">,</span>
		       <span class="n">fb_info</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ATAFB_EXT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">external_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">external_addr</span><span class="p">);</span>
			<span class="n">external_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">external_vgaiobase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">external_vgaiobase</span><span class="p">);</span>
			<span class="n">external_vgaiobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>FIXME: mode needs setting!
printk("fb%d: %s frame buffer device, using %dK of video memory\n",
      fb<em>info.node, fb</em>info.mode->name, screen_len>>10);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fb%d: frame buffer device, using %dK of video memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fb_info</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">screen_len</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* TODO: This driver cannot be unloaded yet */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">atafb_init</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">atafb_deinit</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
