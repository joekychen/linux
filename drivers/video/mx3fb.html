<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › mx3fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mx3fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2008</span>
<span class="cm"> * Guennadi Liakhovetski, DENX Software Engineering, &lt;lg@denx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2004-2007 Freescale Semiconductor, Inc. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;mach/dma.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;mach/ipu.h&gt;</span>
<span class="cp">#include &lt;mach/mx3fb.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#define MX3FB_NAME		&quot;mx3_sdc_fb&quot;</span>

<span class="cp">#define MX3FB_REG_OFFSET	0xB4</span>

<span class="cm">/* SDC Registers */</span>
<span class="cp">#define SDC_COM_CONF		(0xB4 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_GW_CTRL		(0xB8 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_FG_POS		(0xBC - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_BG_POS		(0xC0 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_CUR_POS		(0xC4 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_PWM_CTRL		(0xC8 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_CUR_MAP		(0xCC - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_HOR_CONF		(0xD0 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_VER_CONF		(0xD4 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_SHARP_CONF_1	(0xD8 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define SDC_SHARP_CONF_2	(0xDC - MX3FB_REG_OFFSET)</span>

<span class="cm">/* Register bits */</span>
<span class="cp">#define SDC_COM_TFT_COLOR	0x00000001UL</span>
<span class="cp">#define SDC_COM_FG_EN		0x00000010UL</span>
<span class="cp">#define SDC_COM_GWSEL		0x00000020UL</span>
<span class="cp">#define SDC_COM_GLB_A		0x00000040UL</span>
<span class="cp">#define SDC_COM_KEY_COLOR_G	0x00000080UL</span>
<span class="cp">#define SDC_COM_BG_EN		0x00000200UL</span>
<span class="cp">#define SDC_COM_SHARP		0x00001000UL</span>

<span class="cp">#define SDC_V_SYNC_WIDTH_L	0x00000001UL</span>

<span class="cm">/* Display Interface registers */</span>
<span class="cp">#define DI_DISP_IF_CONF		(0x0124 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP_SIG_POL		(0x0128 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_SER_DISP1_CONF	(0x012C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_SER_DISP2_CONF	(0x0130 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_HSP_CLK_PER		(0x0134 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_TIME_CONF_1	(0x0138 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_TIME_CONF_2	(0x013C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_TIME_CONF_3	(0x0140 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_TIME_CONF_1	(0x0144 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_TIME_CONF_2	(0x0148 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_TIME_CONF_3	(0x014C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_TIME_CONF_1	(0x0150 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_TIME_CONF_2	(0x0154 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_TIME_CONF_3	(0x0158 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP3_TIME_CONF	(0x015C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_DB0_MAP	(0x0160 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_DB1_MAP	(0x0164 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_DB2_MAP	(0x0168 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_CB0_MAP	(0x016C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_CB1_MAP	(0x0170 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP0_CB2_MAP	(0x0174 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_DB0_MAP	(0x0178 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_DB1_MAP	(0x017C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_DB2_MAP	(0x0180 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_CB0_MAP	(0x0184 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_CB1_MAP	(0x0188 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP1_CB2_MAP	(0x018C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_DB0_MAP	(0x0190 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_DB1_MAP	(0x0194 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_DB2_MAP	(0x0198 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_CB0_MAP	(0x019C - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_CB1_MAP	(0x01A0 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP2_CB2_MAP	(0x01A4 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP3_B0_MAP		(0x01A8 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP3_B1_MAP		(0x01AC - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP3_B2_MAP		(0x01B0 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP_ACC_CC		(0x01B4 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP_LLA_CONF	(0x01B8 - MX3FB_REG_OFFSET)</span>
<span class="cp">#define DI_DISP_LLA_DATA	(0x01BC - MX3FB_REG_OFFSET)</span>

<span class="cm">/* DI_DISP_SIG_POL bits */</span>
<span class="cp">#define DI_D3_VSYNC_POL_SHIFT		28</span>
<span class="cp">#define DI_D3_HSYNC_POL_SHIFT		27</span>
<span class="cp">#define DI_D3_DRDY_SHARP_POL_SHIFT	26</span>
<span class="cp">#define DI_D3_CLK_POL_SHIFT		25</span>
<span class="cp">#define DI_D3_DATA_POL_SHIFT		24</span>

<span class="cm">/* DI_DISP_IF_CONF bits */</span>
<span class="cp">#define DI_D3_CLK_IDLE_SHIFT		26</span>
<span class="cp">#define DI_D3_CLK_SEL_SHIFT		25</span>
<span class="cp">#define DI_D3_DATAMSK_SHIFT		24</span>

<span class="k">enum</span> <span class="n">ipu_panel</span> <span class="p">{</span>
	<span class="n">IPU_PANEL_SHARP_TFT</span><span class="p">,</span>
	<span class="n">IPU_PANEL_TFT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ipu_di_signal_cfg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">datamask_en</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">clksel_en</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">clkidle_en</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">data_pol</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* true = inverted */</span>
	<span class="kt">unsigned</span> <span class="n">clk_pol</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* true = rising edge */</span>
	<span class="kt">unsigned</span> <span class="n">enable_pol</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">Hsync_pol</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* true = active high */</span>
	<span class="kt">unsigned</span> <span class="n">Vsync_pol</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">mx3fb_modedb</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* 240x320 @ 60 Hz */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Sharp-QVGA&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">185925</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_SHARP_MODE</span> <span class="o">|</span>
				  <span class="n">FB_SYNC_CLK_INVERT</span> <span class="o">|</span> <span class="n">FB_SYNC_DATA_INVERT</span> <span class="o">|</span>
				  <span class="n">FB_SYNC_CLK_IDLE_EN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flag</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 240x33 @ 60 Hz */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Sharp-CLI&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">33</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">185925</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">287</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_SHARP_MODE</span> <span class="o">|</span>
				  <span class="n">FB_SYNC_CLK_INVERT</span> <span class="o">|</span> <span class="n">FB_SYNC_DATA_INVERT</span> <span class="o">|</span>
				  <span class="n">FB_SYNC_CLK_IDLE_EN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flag</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* 640x480 @ 60 Hz */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;NEC-VGA&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">38255</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_OE_ACT_HIGH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flag</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* NTSC TV output */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TV-NTSC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">37538</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">38</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">858</span> <span class="o">-</span> <span class="mi">640</span> <span class="o">-</span> <span class="mi">38</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">518</span> <span class="o">-</span> <span class="mi">480</span> <span class="o">-</span> <span class="mi">36</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flag</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* PAL TV output */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TV-PAL&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">37538</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">38</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">960</span> <span class="o">-</span> <span class="mi">640</span> <span class="o">-</span> <span class="mi">38</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">555</span> <span class="o">-</span> <span class="mi">480</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flag</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* TV output VGA mode, 640x480 @ 65 Hz */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TV-VGA&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">40574</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">46</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flag</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span>		<span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">backlight_level</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg_base</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">uint32_t</span>		<span class="n">h_start_width</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">v_start_width</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">disp_data_mapping</span>	<span class="n">disp_data_fmt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dma_chan_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span>	<span class="o">*</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ipu_channel</span>	<span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* MX3 specific framebuffer information. */</span>
<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="p">{</span>
	<span class="kt">int</span>				<span class="n">blank</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ipu_channel</span>		<span class="n">ipu_ch</span><span class="p">;</span>
	<span class="kt">uint32_t</span>			<span class="n">cur_ipu_buf</span><span class="p">;</span>

	<span class="n">u32</span>				<span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">completion</span>		<span class="n">flip_cmpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>			<span class="n">mutex</span><span class="p">;</span>	<span class="cm">/* Protects fb-ops */</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span>		<span class="o">*</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span>		<span class="o">*</span><span class="n">idmac_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span>			<span class="n">cookie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>		<span class="n">sg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">u32</span>				<span class="n">sync</span><span class="p">;</span>	<span class="cm">/* preserve var-&gt;sync flags */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mx3fb_dma_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* Used fb-mode and bpp. Can be set on kernel command line, therefore file-static. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fb_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">default_bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">mx3fb_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mx3fb_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">di_mapping</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">di_mapping</span> <span class="n">di_mappings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IPU_DISP_DATA_MAPPING_RGB666</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0005000f</span><span class="p">,</span> <span class="mh">0x000b000f</span><span class="p">,</span> <span class="mh">0x0011000f</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">IPU_DISP_DATA_MAPPING_RGB565</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0004003f</span><span class="p">,</span> <span class="mh">0x000a000f</span><span class="p">,</span> <span class="mh">0x000f003f</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">IPU_DISP_DATA_MAPPING_RGB888</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00070000</span><span class="p">,</span> <span class="mh">0x000f0000</span><span class="p">,</span> <span class="mh">0x00170000</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdc_fb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>

	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">SDC_COM_BG_EN</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Returns enabled flag before uninit */</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">sdc_fb_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>

	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SDC_COM_BG_EN</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">SDC_COM_BG_EN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdc_enable_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichan</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dma_chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mx3fbi %p, desc %p, sg %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mx3_fbi</span><span class="p">,</span>
			<span class="n">to_tx_desc</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">),</span> <span class="n">to_tx_desc</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mx3fbi %p, txd = NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mx3_fbi</span><span class="p">);</span>

	<span class="cm">/* This enables the channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">,</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot allocate descriptor on %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dma_chan</span><span class="o">-&gt;</span><span class="n">chan_id</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback_param</span>	<span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
		<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback</span>		<span class="o">=</span> <span class="n">mx3fb_dma_done</span><span class="p">;</span>

		<span class="n">cookie</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d: Submit %p #%d [%c]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		       <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;-&#39;</span> <span class="o">:</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">||</span> <span class="o">!</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dma_chan</span><span class="o">-&gt;</span><span class="n">chan_id</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Just re-activate the same buffer */</span>
		<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
		<span class="n">cookie</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d: Re-submit %p #%d [%c]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		       <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;-&#39;</span> <span class="o">:</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sdc_fb_init</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>
		<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Attention! Without this msleep the channel keeps generating</span>
<span class="cm">	 * interrupts. Next sdc_set_brightness() is going to be called</span>
<span class="cm">	 * from mx3fb_blank().</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdc_disable_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">enabled</span> <span class="o">=</span> <span class="n">sdc_fb_uninit</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
						   <span class="n">DMA_TERMINATE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sdc_set_window_pos() - set window position of the respective plane.</span>
<span class="cm"> * @mx3fb:	mx3fb context.</span>
<span class="cm"> * @channel:	IPU DMAC channel ID.</span>
<span class="cm"> * @x_pos:	X coordinate relative to the top left corner to place window at.</span>
<span class="cm"> * @y_pos:	Y coordinate relative to the top left corner to place window at.</span>
<span class="cm"> * @return:	0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdc_set_window_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ipu_channel</span> <span class="n">channel</span><span class="p">,</span>
			      <span class="kt">int16_t</span> <span class="n">x_pos</span><span class="p">,</span> <span class="kt">int16_t</span> <span class="n">y_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">IDMAC_SDC_0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">x_pos</span> <span class="o">+=</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">h_start_width</span><span class="p">;</span>
	<span class="n">y_pos</span> <span class="o">+=</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">v_start_width</span><span class="p">;</span>

	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="p">(</span><span class="n">x_pos</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">SDC_BG_POS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sdc_init_panel() - initialize a synchronous LCD panel.</span>
<span class="cm"> * @mx3fb:		mx3fb context.</span>
<span class="cm"> * @panel:		panel type.</span>
<span class="cm"> * @pixel_clk:		desired pixel clock frequency in Hz.</span>
<span class="cm"> * @width:		width of panel in pixels.</span>
<span class="cm"> * @height:		height of panel in pixels.</span>
<span class="cm"> * @h_start_width:	number of pixel clocks between the HSYNC signal pulse</span>
<span class="cm"> *			and the start of valid data.</span>
<span class="cm"> * @h_sync_width:	width of the HSYNC signal in units of pixel clocks.</span>
<span class="cm"> * @h_end_width:	number of pixel clocks between the end of valid data</span>
<span class="cm"> *			and the HSYNC signal for next line.</span>
<span class="cm"> * @v_start_width:	number of lines between the VSYNC signal pulse and the</span>
<span class="cm"> *			start of valid data.</span>
<span class="cm"> * @v_sync_width:	width of the VSYNC signal in units of lines</span>
<span class="cm"> * @v_end_width:	number of lines between the end of valid data and the</span>
<span class="cm"> *			VSYNC signal for next frame.</span>
<span class="cm"> * @sig:		bitfield of signal polarities for LCD interface.</span>
<span class="cm"> * @return:		0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdc_init_panel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ipu_panel</span> <span class="n">panel</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">pixel_clk</span><span class="p">,</span>
			  <span class="kt">uint16_t</span> <span class="n">width</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">height</span><span class="p">,</span>
			  <span class="kt">uint16_t</span> <span class="n">h_start_width</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">h_sync_width</span><span class="p">,</span>
			  <span class="kt">uint16_t</span> <span class="n">h_end_width</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">v_start_width</span><span class="p">,</span>
			  <span class="kt">uint16_t</span> <span class="n">v_sync_width</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">v_end_width</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ipu_di_signal_cfg</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">old_conf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">div</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">ipu_clk</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">di_mapping</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;panel size = %d x %d&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v_sync_width</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">h_sync_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Init panel size and blanking periods */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">h_sync_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">h_start_width</span> <span class="o">+</span> <span class="n">h_end_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">SDC_HOR_CONF</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; hor_conf %x,&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">v_sync_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="n">SDC_V_SYNC_WIDTH_L</span> <span class="o">|</span>
	    <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">v_start_width</span> <span class="o">+</span> <span class="n">v_end_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">SDC_VER_CONF</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; ver_conf %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">h_start_width</span> <span class="o">=</span> <span class="n">h_start_width</span><span class="p">;</span>
	<span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">v_start_width</span> <span class="o">=</span> <span class="n">v_start_width</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">panel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPU_PANEL_SHARP_TFT</span>:
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="mh">0x00FD0102L</span><span class="p">,</span> <span class="n">SDC_SHARP_CONF_1</span><span class="p">);</span>
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="mh">0x00F500F4L</span><span class="p">,</span> <span class="n">SDC_SHARP_CONF_2</span><span class="p">);</span>
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_COM_SHARP</span> <span class="o">|</span> <span class="n">SDC_COM_TFT_COLOR</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPU_PANEL_TFT</span>:
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_COM_TFT_COLOR</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init clocking */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate divider: fractional part is 4 bits so simply multiple by</span>
<span class="cm">	 * 2^4 to get fractional part, as long as we stay under ~250MHz and on</span>
<span class="cm">	 * i.MX31 it (HSP_CLK) is &lt;= 178MHz. Currently 128.267MHz</span>
<span class="cm">	 */</span>
	<span class="n">ipu_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ipu_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">ipu_clk</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">pixel_clk</span><span class="p">;</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">ipu_clk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Divider less than 4 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;InitPanel() - Pixel clock divider less than 4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pixel clk = %u, divider %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pixel_clk</span><span class="p">,</span> <span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">125</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * DISP3_IF_CLK_DOWN_WR is half the divider value and 2 fraction bits</span>
<span class="cm">	 * fewer. Subtract 1 extra from DISP3_IF_CLK_DOWN_WR based on timing</span>
<span class="cm">	 * debug. DISP3_IF_CLK_UP_WR is 0</span>
<span class="cm">	 */</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="p">(((</span><span class="n">div</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="n">div</span><span class="p">,</span> <span class="n">DI_DISP3_TIME_CONF</span><span class="p">);</span>

	<span class="cm">/* DI settings */</span>
	<span class="n">old_conf</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">DI_DISP_IF_CONF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x78FFFFFF</span><span class="p">;</span>
	<span class="n">old_conf</span> <span class="o">|=</span> <span class="n">sig</span><span class="p">.</span><span class="n">datamask_en</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_DATAMSK_SHIFT</span> <span class="o">|</span>
		<span class="n">sig</span><span class="p">.</span><span class="n">clksel_en</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_CLK_SEL_SHIFT</span> <span class="o">|</span>
		<span class="n">sig</span><span class="p">.</span><span class="n">clkidle_en</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_CLK_IDLE_SHIFT</span><span class="p">;</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">old_conf</span><span class="p">,</span> <span class="n">DI_DISP_IF_CONF</span><span class="p">);</span>

	<span class="n">old_conf</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">DI_DISP_SIG_POL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE0FFFFFF</span><span class="p">;</span>
	<span class="n">old_conf</span> <span class="o">|=</span> <span class="n">sig</span><span class="p">.</span><span class="n">data_pol</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_DATA_POL_SHIFT</span> <span class="o">|</span>
		<span class="n">sig</span><span class="p">.</span><span class="n">clk_pol</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_CLK_POL_SHIFT</span> <span class="o">|</span>
		<span class="n">sig</span><span class="p">.</span><span class="n">enable_pol</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_DRDY_SHARP_POL_SHIFT</span> <span class="o">|</span>
		<span class="n">sig</span><span class="p">.</span><span class="n">Hsync_pol</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_HSYNC_POL_SHIFT</span> <span class="o">|</span>
		<span class="n">sig</span><span class="p">.</span><span class="n">Vsync_pol</span> <span class="o">&lt;&lt;</span> <span class="n">DI_D3_VSYNC_POL_SHIFT</span><span class="p">;</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">old_conf</span><span class="p">,</span> <span class="n">DI_DISP_SIG_POL</span><span class="p">);</span>

	<span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">di_mappings</span><span class="p">[</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">disp_data_fmt</span><span class="p">];</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">,</span> <span class="n">DI_DISP3_B0_MAP</span><span class="p">);</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">b1</span><span class="p">,</span> <span class="n">DI_DISP3_B1_MAP</span><span class="p">);</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">b2</span><span class="p">,</span> <span class="n">DI_DISP3_B2_MAP</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DI_DISP_IF_CONF = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">DI_DISP_IF_CONF</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DI_DISP_SIG_POL = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">DI_DISP_SIG_POL</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DI_DISP3_TIME_CONF = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">DI_DISP3_TIME_CONF</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sdc_set_color_key() - set the transparent color key for SDC graphic plane.</span>
<span class="cm"> * @mx3fb:	mx3fb context.</span>
<span class="cm"> * @channel:	IPU DMAC channel ID.</span>
<span class="cm"> * @enable:	boolean to enable or disable color keyl.</span>
<span class="cm"> * @color_key:	24-bit RGB color to use as transparent color key.</span>
<span class="cm"> * @return:	0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdc_set_color_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ipu_channel</span> <span class="n">channel</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">color_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">,</span> <span class="n">sdc_conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">sdc_conf</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">IDMAC_SDC_0</span><span class="p">)</span>
		<span class="n">sdc_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDC_COM_GWSEL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sdc_conf</span> <span class="o">|=</span> <span class="n">SDC_COM_GWSEL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_GW_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF000000L</span><span class="p">;</span>
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="n">color_key</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFFL</span><span class="p">),</span>
			     <span class="n">SDC_GW_CTRL</span><span class="p">);</span>

		<span class="n">sdc_conf</span> <span class="o">|=</span> <span class="n">SDC_COM_KEY_COLOR_G</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sdc_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDC_COM_KEY_COLOR_G</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">sdc_conf</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sdc_set_global_alpha() - set global alpha blending modes.</span>
<span class="cm"> * @mx3fb:	mx3fb context.</span>
<span class="cm"> * @enable:	boolean to enable or disable global alpha blending. If disabled,</span>
<span class="cm"> *		per pixel blending is used.</span>
<span class="cm"> * @alpha:	global alpha value.</span>
<span class="cm"> * @return:	0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdc_set_global_alpha</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">alpha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_GW_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFFL</span><span class="p">;</span>
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">),</span> <span class="n">SDC_GW_CTRL</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">SDC_COM_GLB_A</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mx3fb_read_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
		<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SDC_COM_GLB_A</span><span class="p">,</span> <span class="n">SDC_COM_CONF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdc_set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: value = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="cm">/* This might be board-specific */</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="mh">0x03000000UL</span> <span class="o">|</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SDC_PWM_CTRL</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">bpp_to_pixfmt</span><span class="p">(</span><span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">pixfmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">IPU_PIX_FMT_BGR24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">IPU_PIX_FMT_BGR32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">pixfmt</span> <span class="o">=</span> <span class="n">IPU_PIX_FMT_RGB565</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pixfmt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mx3fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mx3fb_map_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem_len</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mx3fb_unmap_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_set_fix() - set fixed framebuffer parameters from variable settings.</span>
<span class="cm"> * @info:	framebuffer information pointer</span>
<span class="cm"> * @return:	0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_set_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;DISP3 BG&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mx3fb_dma_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idmac_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="n">to_tx_desc</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichannel</span> <span class="o">=</span> <span class="n">to_idmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">ichannel</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %d callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ichannel</span><span class="o">-&gt;</span><span class="n">eof_irq</span><span class="p">);</span>

	<span class="cm">/* We only need one interrupt, it will be re-enabled as needed */</span>
	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">ichannel</span><span class="o">-&gt;</span><span class="n">eof_irq</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">flip_cmpl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipu_di_signal_cfg</span> <span class="n">sig_cfg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ipu_panel</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">IPU_PANEL_TFT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichan</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_video_param</span> <span class="o">*</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">video</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>

	<span class="cm">/* Total cleanup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">)</span>
		<span class="n">sdc_disable_channel</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>

	<span class="n">mx3fb_set_fix</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">mem_len</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_len</span> <span class="o">&gt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">)</span>
			<span class="n">mx3fb_unmap_video_memory</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mx3fb_map_video_memory</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">;</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">),</span>
		    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
		    <span class="n">offset_in_page</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">ipu_ch</span> <span class="o">==</span> <span class="n">IDMAC_SDC_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sig_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig_cfg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">)</span>
			<span class="n">sig_cfg</span><span class="p">.</span><span class="n">Hsync_pol</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span><span class="p">)</span>
			<span class="n">sig_cfg</span><span class="p">.</span><span class="n">Vsync_pol</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_CLK_INVERT</span><span class="p">)</span>
			<span class="n">sig_cfg</span><span class="p">.</span><span class="n">clk_pol</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_DATA_INVERT</span><span class="p">)</span>
			<span class="n">sig_cfg</span><span class="p">.</span><span class="n">data_pol</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_OE_ACT_HIGH</span><span class="p">)</span>
			<span class="n">sig_cfg</span><span class="p">.</span><span class="n">enable_pol</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_CLK_IDLE_EN</span><span class="p">)</span>
			<span class="n">sig_cfg</span><span class="p">.</span><span class="n">clkidle_en</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_CLK_SEL_EN</span><span class="p">)</span>
			<span class="n">sig_cfg</span><span class="p">.</span><span class="n">clksel_en</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">sync</span> <span class="o">&amp;</span> <span class="n">FB_SYNC_SHARP_MODE</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">IPU_PANEL_SHARP_TFT</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;pixclock = %ul Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000UL</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdc_init_panel</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000UL</span><span class="p">,</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">,</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">,</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">+</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">,</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">,</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">,</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span>
				   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">,</span> <span class="n">sig_cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="s">&quot;mx3fb: Error initializing panel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sdc_set_window_pos</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">ipu_ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_pixel_fmt</span>	<span class="o">=</span> <span class="n">bpp_to_pixfmt</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_width</span>	<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_height</span>	<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">video</span><span class="o">-&gt;</span><span class="n">out_stride</span>	<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="n">sdc_enable_channel</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_set_par() - set framebuffer parameters and change the operating mode.</span>
<span class="cm"> * @fbi:	framebuffer information pointer.</span>
<span class="cm"> * @return:	0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichan</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s [%c]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;-&#39;</span> <span class="o">:</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__set_par</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_check_var() - check and adjust framebuffer variable parameters.</span>
<span class="cm"> * @var:	framebuffer variable parameters</span>
<span class="cm"> * @fbi:	framebuffer information pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vtotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">htotal</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">default_bpp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">htotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">+</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
		<span class="n">vtotal</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">+</span>
		    <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">*</span> <span class="n">htotal</span> <span class="o">*</span> <span class="mi">6UL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100UL</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;pixclock set for 60Hz refresh = %u ps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">grayscale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Preserve sync flags */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>
	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">|=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">chan_to_field</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s, regno = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If greyscale is true, then we convert the RGB value</span>
<span class="cm">	 * to greyscale no matter what visual we are using.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">grayscale</span><span class="p">)</span>
		<span class="n">red</span> <span class="o">=</span> <span class="n">green</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">19595</span> <span class="o">*</span> <span class="n">red</span> <span class="o">+</span> <span class="mi">38470</span> <span class="o">*</span> <span class="n">green</span> <span class="o">+</span>
				      <span class="mi">7471</span> <span class="o">*</span> <span class="n">blue</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 16-bit True Colour.  We encode the RGB value</span>
<span class="cm">		 * according to the RGB bitfield information.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>

			<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_VISUAL_STATIC_PSEUDOCOLOR</span>:
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_blank</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">blank</span><span class="p">;</span>

	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">=</span> <span class="n">blank</span><span class="p">;</span>

	<span class="cm">/* Attention!</span>
<span class="cm">	 * Do not call sdc_disable_channel() for a channel that is disabled</span>
<span class="cm">	 * already! This will result in a kernel NULL pointer dereference</span>
<span class="cm">	 * (mx3_fbi-&gt;txd is NULL). Hide the fact, that all blank modes are</span>
<span class="cm">	 * handled equally by this driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span> <span class="o">&gt;</span> <span class="n">FB_BLANK_UNBLANK</span> <span class="o">&amp;&amp;</span> <span class="n">was_blank</span> <span class="o">&gt;</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">sdc_set_brightness</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
		<span class="cm">/* Give LCD time to update - enough for 50 and 60 Hz */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
		<span class="n">sdc_disable_channel</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">sdc_enable_channel</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>
		<span class="n">sdc_set_brightness</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">backlight_level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_blank() - blank the display.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s, blank = %d, base %p, len %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">blank</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="n">blank</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__blank</span><span class="p">(</span><span class="n">blank</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_pan_display() - pan or wrap the display</span>
<span class="cm"> * @var:	variable screen buffer information.</span>
<span class="cm"> * @info:	framebuffer information pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * We look only at xoffset, yoffset and the FB_VMODE_YWRAP flag</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y_bottom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">off_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dma_chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s [%c]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;-&#39;</span> <span class="o">:</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;x panning not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">==</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No change, do nothing */</span>

	<span class="n">y_bottom</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">))</span>
		<span class="n">y_bottom</span> <span class="o">+=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_bottom</span> <span class="o">&gt;</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span>
	       <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Updating SDC BG buf %d address=0x%08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We enable the End of Frame interrupt, which will free a tx-descriptor,</span>
<span class="cm">	 * which we will need for the next device_prep_slave_sg(). The</span>
<span class="cm">	 * IRQ-handler will disable the IRQ again.</span>
<span class="cm">	 */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">flip_cmpl</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="o">-&gt;</span><span class="n">eof_irq</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">flip_cmpl</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Panning failed due to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span>
			 <span class="s">&quot;user interrupt&quot;</span> <span class="o">:</span> <span class="s">&quot;timeout&quot;</span><span class="p">);</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="o">-&gt;</span><span class="n">eof_irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span> <span class="o">=</span> <span class="o">!</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span><span class="p">;</span>

	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span><span class="p">])</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span><span class="p">],</span>
		    <span class="n">virt_to_page</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
		    <span class="n">offset_in_page</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">)</span>
		<span class="n">async_tx_ack</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>

	<span class="n">txd</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">sg</span> <span class="o">+</span>
		<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">,</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;Error preparing a DMA transaction descriptor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback_param</span>	<span class="o">=</span> <span class="n">txd</span><span class="p">;</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback</span>		<span class="o">=</span> <span class="n">mx3fb_dma_done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Emulate original mx3fb behaviour: each new call to idmac_tx_submit()</span>
<span class="cm">	 * should switch to another buffer</span>
<span class="cm">	 */</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%d: Submit %p #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">txd</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;Error updating SDC buf %d to address=0x%08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="n">txd</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">|=</span> <span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FB_VMODE_YWRAP</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Update complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This structure contains the pointers to the control functions that are</span>
<span class="cm"> * invoked by the core framebuffer driver to perform operations like</span>
<span class="cm"> * blitting, rectangle filling, copy regions and cursor definition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">mx3fb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> <span class="o">=</span> <span class="n">mx3fb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">mx3fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="n">mx3fb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">mx3fb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span> <span class="n">mx3fb_blank</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * Power management hooks.      Note that we won&#39;t be called from IRQ context,</span>
<span class="cm"> * unlike the blank functions above, so we may sleep.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Suspends the framebuffer and blanks the screen. Power management support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdc_disable_channel</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>
		<span class="n">sdc_set_brightness</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Resumes the framebuffer and unblanks the screen. Power management support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdc_enable_channel</span><span class="p">(</span><span class="n">mx3_fbi</span><span class="p">);</span>
		<span class="n">sdc_set_brightness</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">backlight_level</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define mx3fb_suspend   NULL</span>
<span class="cp">#define mx3fb_resume    NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Main framebuffer functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_map_video_memory() - allocates the DRAM memory for the frame buffer.</span>
<span class="cm"> * @fbi:	framebuffer information pointer</span>
<span class="cm"> * @mem_len:	length of mapped memory</span>
<span class="cm"> * @lock:	do not lock during initialisation</span>
<span class="cm"> * @return:	Error code indicating success or failure</span>
<span class="cm"> *</span>
<span class="cm"> * This buffer is remapped into a non-cached, non-buffered, memory region to</span>
<span class="cm"> * allow palette and pixel writes to occur without flushing the cache. Once this</span>
<span class="cm"> * area is remapped, all virtual memory access to the video memory should occur</span>
<span class="cm"> * at the new region.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_map_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem_len</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">dma_alloc_writecombine</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						  <span class="n">mem_len</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">GFP_DMA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Cannot allocate %u bytes framebuffer memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mem_len</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;allocated fb @ p=0x%08x, v=0x%p, size=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_size</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="cm">/* Clear the screen */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err0:</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_unmap_video_memory() - de-allocate frame buffer memory.</span>
<span class="cm"> * @fbi:	framebuffer information pointer</span>
<span class="cm"> * @return:	error code indicating success or failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_unmap_video_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_writecombine</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
			      <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mm_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mx3fb_init_fbinfo() - initialize framebuffer information object.</span>
<span class="cm"> * @return:	initialized framebuffer structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="nf">mx3fb_init_fbinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3fbi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Allocate sufficient memory for the fb structure */</span>
	<span class="n">fbi</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_info</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mx3fbi</span>			<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">cookie</span>		<span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">cur_ipu_buf</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">fbops</span>		<span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Allocate colormap */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fbi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_fb_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">idmac_channel</span> <span class="o">*</span><span class="n">ichan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_platform_data</span> <span class="o">*</span><span class="n">mx3fb_pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3fbi</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">num_modes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">disp_data_fmt</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">di_mappings</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Illegal display data format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">disp_data_fmt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ichan</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">mx3fb</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">ichan</span><span class="o">-&gt;</span><span class="n">eof_irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">.</span><span class="n">chan_id</span> <span class="o">!=</span> <span class="n">IDMAC_SDC_0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fbi</span> <span class="o">=</span> <span class="n">mx3fb_init_fbinfo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mx3fb_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_mode</span><span class="p">)</span>
		<span class="n">fb_mode</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">emode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">num_modes</span> <span class="o">=</span> <span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mx3fb_modedb</span><span class="p">;</span>
		<span class="n">num_modes</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mx3fb_modedb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">fbi</span><span class="p">,</span> <span class="n">fb_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
			  <span class="n">num_modes</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">default_bpp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">emode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_videomode_to_modelist</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">num_modes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">modelist</span><span class="p">);</span>

	<span class="cm">/* Default Y virtual size is 2x panel size */</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="p">;</span>

	<span class="cm">/* set Display Interface clock period */</span>
	<span class="n">mx3fb_write_reg</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="mh">0x00100010L</span><span class="p">,</span> <span class="n">DI_HSP_CLK_PER</span><span class="p">);</span>
	<span class="cm">/* Might need to trigger HSP clock change - see 44.3.3.8.5 */</span>

	<span class="n">sdc_set_brightness</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="n">sdc_set_global_alpha</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">sdc_set_color_key</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">IDMAC_SDC_0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mx3fbi</span>			<span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span>	<span class="o">=</span> <span class="n">ichan</span><span class="p">;</span>
	<span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">ipu_ch</span>		<span class="o">=</span> <span class="n">ichan</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">.</span><span class="n">chan_id</span><span class="p">;</span>
	<span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">mx3fb</span>		<span class="o">=</span> <span class="n">mx3fb</span><span class="p">;</span>
	<span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">blank</span>		<span class="o">=</span> <span class="n">FB_BLANK_NORMAL</span><span class="p">;</span>

	<span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">disp_data_fmt</span>	<span class="o">=</span> <span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">disp_data_fmt</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fbi</span><span class="o">-&gt;</span><span class="n">flip_cmpl</span><span class="p">);</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">eof_irq</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ichan</span><span class="o">-&gt;</span><span class="n">eof_irq</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__set_par</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">esetpar</span><span class="p">;</span>

	<span class="n">__blank</span><span class="p">(</span><span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="n">fbi</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered, using mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb_mode</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">erfb</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">erfb:</span>
<span class="nl">esetpar:</span>
<span class="nl">emode:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">chan_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan_request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_platform_data</span> <span class="o">*</span><span class="n">mx3fb_pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_dma_is_ipu</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">mx3fb_pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">&amp;&amp;</span>
		<span class="n">mx3fb_pdata</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_fbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mx3fb_unmap_video_memory</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">sdc_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span><span class="p">;</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan_request</span> <span class="n">rq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Display Interface (DI) and Synchronous Display Controller (SDC)</span>
<span class="cm">	 * registers</span>
<span class="cm">	 */</span>
	<span class="n">sdc_reg</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdc_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mx3fb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mx3fb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3fb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">sdc_reg</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">sdc_reg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Remapped %pR at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdc_reg</span><span class="p">,</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>

	<span class="cm">/* IDMAC interface */</span>
	<span class="n">dmaengine_get</span><span class="p">();</span>

	<span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mx3fb</span><span class="p">);</span>

	<span class="n">rq</span><span class="p">.</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">mx3fb</span><span class="p">;</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_PRIVATE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">rq</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IDMAC_SDC_0</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">chan_filter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ersdc0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">backlight_level</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_fb_chan</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">,</span> <span class="n">to_idmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">eisdc0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">eisdc0:</span>
	<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="nl">ersdc0:</span>
	<span class="n">dmaengine_put</span><span class="p">();</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>
<span class="nl">eremap:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mx3fb: failed to register fb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mx3fb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mx3fb_data</span> <span class="o">*</span><span class="n">mx3fb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mx3fb_info</span> <span class="o">*</span><span class="n">mx3_fbi</span> <span class="o">=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mx3_fbi</span><span class="o">-&gt;</span><span class="n">idmac_channel</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">;</span>
	<span class="n">release_fbi</span><span class="p">(</span><span class="n">fbi</span><span class="p">);</span>

	<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dmaengine_put</span><span class="p">();</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">mx3fb</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mx3fb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mx3fb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">MX3FB_NAME</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mx3fb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">mx3fb_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">mx3fb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">mx3fb_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Parse user specified options (`video=mx3fb:&#39;)</span>
<span class="cm"> * example:</span>
<span class="cm"> * 	video=mx3fb:bpp=16</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mx3fb_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;mx3fb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">opt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s">&quot;bpp=&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">default_bpp</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">opt</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fb_mode</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mx3fb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">mx3fb_setup</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mx3fb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mx3fb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mx3fb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mx3fb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Freescale Semiconductor, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MX3 framebuffer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">MX3FB_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
