<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › video › ep93xx-fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ep93xx-fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/video/ep93xx-fb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Framebuffer support for the EP93xx series.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Bluewater Systems Ltd</span>
<span class="cm"> * Author: Ryan Mallon</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 H Hartley Sweeten &lt;hsweeten@visionengravers.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the Cirrus Logic ep93xxfb driver, and various other ep93xxfb</span>
<span class="cm"> * drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>

<span class="cp">#include &lt;mach/fb.h&gt;</span>

<span class="cm">/* Vertical Frame Timing Registers */</span>
<span class="cp">#define EP93XXFB_VLINES_TOTAL			0x0000	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_VSYNC				0x0004	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_VACTIVE			0x0008	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_VBLANK				0x0228	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_VCLK				0x000c	</span><span class="cm">/* SW locked */</span><span class="cp"></span>

<span class="cm">/* Horizontal Frame Timing Registers */</span>
<span class="cp">#define EP93XXFB_HCLKS_TOTAL			0x0010	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_HSYNC				0x0014	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_HACTIVE			0x0018	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_HBLANK				0x022c	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_HCLK				0x001c	</span><span class="cm">/* SW locked */</span><span class="cp"></span>

<span class="cm">/* Frame Buffer Memory Configuration Registers */</span>
<span class="cp">#define EP93XXFB_SCREEN_PAGE			0x0028</span>
<span class="cp">#define EP93XXFB_SCREEN_HPAGE			0x002c</span>
<span class="cp">#define EP93XXFB_SCREEN_LINES			0x0030</span>
<span class="cp">#define EP93XXFB_LINE_LENGTH			0x0034</span>
<span class="cp">#define EP93XXFB_VLINE_STEP			0x0038</span>
<span class="cp">#define EP93XXFB_LINE_CARRY			0x003c	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_EOL_OFFSET			0x0230</span>

<span class="cm">/* Other Video Registers */</span>
<span class="cp">#define EP93XXFB_BRIGHTNESS			0x0020</span>
<span class="cp">#define EP93XXFB_ATTRIBS			0x0024	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_SWLOCK				0x007c	</span><span class="cm">/* SW locked */</span><span class="cp"></span>
<span class="cp">#define EP93XXFB_AC_RATE			0x0214</span>
<span class="cp">#define EP93XXFB_FIFO_LEVEL			0x0234</span>
<span class="cp">#define EP93XXFB_PIXELMODE			0x0054</span>
<span class="cp">#define EP93XXFB_PIXELMODE_32BPP		(0x7 &lt;&lt; 0)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_24BPP		(0x6 &lt;&lt; 0)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_16BPP		(0x4 &lt;&lt; 0)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_8BPP			(0x2 &lt;&lt; 0)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_SHIFT_1P_24B		(0x0 &lt;&lt; 3)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_SHIFT_1P_18B		(0x1 &lt;&lt; 3)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_COLOR_LUT		(0x0 &lt;&lt; 10)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_COLOR_888		(0x4 &lt;&lt; 10)</span>
<span class="cp">#define EP93XXFB_PIXELMODE_COLOR_555		(0x5 &lt;&lt; 10)</span>
<span class="cp">#define EP93XXFB_PARL_IF_OUT			0x0058</span>
<span class="cp">#define EP93XXFB_PARL_IF_IN			0x005c</span>

<span class="cm">/* Blink Control Registers */</span>
<span class="cp">#define EP93XXFB_BLINK_RATE			0x0040</span>
<span class="cp">#define EP93XXFB_BLINK_MASK			0x0044</span>
<span class="cp">#define EP93XXFB_BLINK_PATTRN			0x0048</span>
<span class="cp">#define EP93XXFB_PATTRN_MASK			0x004c</span>
<span class="cp">#define EP93XXFB_BKGRND_OFFSET			0x0050</span>

<span class="cm">/* Hardware Cursor Registers */</span>
<span class="cp">#define EP93XXFB_CURSOR_ADR_START		0x0060</span>
<span class="cp">#define EP93XXFB_CURSOR_ADR_RESET		0x0064</span>
<span class="cp">#define EP93XXFB_CURSOR_SIZE			0x0068</span>
<span class="cp">#define EP93XXFB_CURSOR_COLOR1			0x006c</span>
<span class="cp">#define EP93XXFB_CURSOR_COLOR2			0x0070</span>
<span class="cp">#define EP93XXFB_CURSOR_BLINK_COLOR1		0x021c</span>
<span class="cp">#define EP93XXFB_CURSOR_BLINK_COLOR2		0x0220</span>
<span class="cp">#define EP93XXFB_CURSOR_XY_LOC			0x0074</span>
<span class="cp">#define EP93XXFB_CURSOR_DSCAN_HY_LOC		0x0078</span>
<span class="cp">#define EP93XXFB_CURSOR_BLINK_RATE_CTRL		0x0224</span>

<span class="cm">/* LUT Registers */</span>
<span class="cp">#define EP93XXFB_GRY_SCL_LUTR			0x0080</span>
<span class="cp">#define EP93XXFB_GRY_SCL_LUTG			0x0280</span>
<span class="cp">#define EP93XXFB_GRY_SCL_LUTB			0x0300</span>
<span class="cp">#define EP93XXFB_LUT_SW_CONTROL			0x0218</span>
<span class="cp">#define EP93XXFB_LUT_SW_CONTROL_SWTCH		(1 &lt;&lt; 0)</span>
<span class="cp">#define EP93XXFB_LUT_SW_CONTROL_SSTAT		(1 &lt;&lt; 1)</span>
<span class="cp">#define EP93XXFB_COLOR_LUT			0x0400</span>

<span class="cm">/* Video Signature Registers */</span>
<span class="cp">#define EP93XXFB_VID_SIG_RSLT_VAL		0x0200</span>
<span class="cp">#define EP93XXFB_VID_SIG_CTRL			0x0204</span>
<span class="cp">#define EP93XXFB_VSIG				0x0208</span>
<span class="cp">#define EP93XXFB_HSIG				0x020c</span>
<span class="cp">#define EP93XXFB_SIG_CLR_STR			0x0210</span>

<span class="cm">/* Minimum / Maximum resolutions supported */</span>
<span class="cp">#define EP93XXFB_MIN_XRES			64</span>
<span class="cp">#define EP93XXFB_MIN_YRES			64</span>
<span class="cp">#define EP93XXFB_MAX_XRES			1024</span>
<span class="cp">#define EP93XXFB_MAX_YRES			768</span>

<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xxfb_mach_info</span>	<span class="o">*</span><span class="n">mach_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>			<span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">mmio_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">pseudo_palette</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">check_screenpage_bug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">check_screenpage_bug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">check_screenpage_bug</span><span class="p">,</span>
		 <span class="s">&quot;Check for bit 27 screen page bug. Default = 1&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ep93xxfb_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ep93xxfb_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write to one of the locked raster registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ep93xxfb_out_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t need a lock or delay here since the raster register</span>
<span class="cm">	 * block will remain unlocked until the next access.</span>
<span class="cm">	 */</span>
	<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">EP93XXFB_SWLOCK</span><span class="p">);</span>
	<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xxfb_set_video_attribs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attribs</span><span class="p">;</span>

	<span class="n">attribs</span> <span class="o">=</span> <span class="n">EP93XXFB_ENABLE</span><span class="p">;</span>
	<span class="n">attribs</span> <span class="o">|=</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">attribs</span><span class="p">,</span> <span class="n">EP93XXFB_ATTRIBS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xxfb_set_pixelmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">EP93XXFB_PIXELMODE_8BPP</span> <span class="o">|</span> <span class="n">EP93XXFB_PIXELMODE_COLOR_LUT</span> <span class="o">|</span>
			<span class="n">EP93XXFB_PIXELMODE_SHIFT_1P_18B</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> 	<span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">EP93XXFB_PIXELMODE_16BPP</span> <span class="o">|</span> <span class="n">EP93XXFB_PIXELMODE_COLOR_555</span> <span class="o">|</span>
			<span class="n">EP93XXFB_PIXELMODE_SHIFT_1P_18B</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> 	<span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">EP93XXFB_PIXELMODE_24BPP</span> <span class="o">|</span> <span class="n">EP93XXFB_PIXELMODE_COLOR_888</span> <span class="o">|</span>
			<span class="n">EP93XXFB_PIXELMODE_SHIFT_1P_24B</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> 	<span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">EP93XXFB_PIXELMODE_32BPP</span> <span class="o">|</span> <span class="n">EP93XXFB_PIXELMODE_COLOR_888</span> <span class="o">|</span>
			<span class="n">EP93XXFB_PIXELMODE_SHIFT_1P_24B</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> 	<span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">EP93XXFB_PIXELMODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xxfb_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vlines_total</span><span class="p">,</span> <span class="n">hclks_total</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">;</span>

	<span class="n">vlines_total</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">+</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hclks_total</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">+</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">vlines_total</span><span class="p">,</span> <span class="n">EP93XXFB_VLINES_TOTAL</span><span class="p">);</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">hclks_total</span><span class="p">,</span> <span class="n">EP93XXFB_HCLKS_TOTAL</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">vlines_total</span><span class="p">;</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">vlines_total</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_VSYNC</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">vlines_total</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vsync_len</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">upper_margin</span><span class="p">;</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">lower_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_VBLANK</span><span class="p">);</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_VACTIVE</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">vlines_total</span><span class="p">;</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">vlines_total</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_VCLK</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">hclks_total</span><span class="p">;</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">hclks_total</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span><span class="p">;</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_HSYNC</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">hclks_total</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">hsync_len</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">left_margin</span><span class="p">;</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">right_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_HBLANK</span><span class="p">);</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_HACTIVE</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">hclks_total</span><span class="p">;</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">hclks_total</span><span class="p">;</span>
	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">start</span> <span class="o">|</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">EP93XXFB_HCLK</span><span class="p">);</span>

	<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">EP93XXFB_LINE_CARRY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xxfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">clk_set_rate</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">PICOS2KHZ</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span><span class="p">));</span>

	<span class="n">ep93xxfb_set_timing</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">*</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span> <span class="n">EP93XXFB_SCREEN_PAGE</span><span class="p">);</span>
	<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EP93XXFB_SCREEN_LINES</span><span class="p">);</span>
	<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span>
			      <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EP93XXFB_LINE_LENGTH</span><span class="p">);</span>
	<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">EP93XXFB_VLINE_STEP</span><span class="p">);</span>
	<span class="n">ep93xxfb_set_video_attribs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xxfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ep93xxfb_set_pixelmode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">EP93XXFB_MIN_XRES</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">EP93XXFB_MAX_XRES</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">EP93XXFB_MIN_YRES</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">EP93XXFB_MAX_YRES</span><span class="p">);</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xxfb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dma_mmap_writecombine</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span>
					     <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
					     <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xxfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attribs</span> <span class="o">=</span> <span class="n">ep93xxfb_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">EP93XXFB_ATTRIBS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">blank</span><span class="p">)</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">blank</span><span class="p">(</span><span class="n">blank_mode</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">attribs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EP93XXFB_ENABLE</span><span class="p">,</span>
				    <span class="n">EP93XXFB_ATTRIBS</span><span class="p">);</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">ep93xxfb_out_locked</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">attribs</span> <span class="o">|</span> <span class="n">EP93XXFB_ENABLE</span><span class="p">,</span>
				    <span class="n">EP93XXFB_ATTRIBS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">blank</span><span class="p">)</span>
			<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">blank</span><span class="p">(</span><span class="n">blank_mode</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ep93xxfb_convert_color</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x7fff</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xxfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">green</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blue</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">lut_current</span><span class="p">,</span> <span class="n">lut_stat</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rgb</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">;</span>
		<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">rgb</span><span class="p">,</span> <span class="p">(</span><span class="n">EP93XXFB_COLOR_LUT</span> <span class="o">+</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)));</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ep93xxfb_readl</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">EP93XXFB_LUT_SW_CONTROL</span><span class="p">);</span>
		<span class="n">lut_stat</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EP93XXFB_LUT_SW_CONTROL_SSTAT</span><span class="p">);</span>
		<span class="n">lut_current</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">EP93XXFB_LUT_SW_CONTROL_SWTCH</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lut_stat</span> <span class="o">==</span> <span class="n">lut_current</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span> <span class="n">pal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">EP93XXFB_COLOR_LUT</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="n">ep93xxfb_writel</span><span class="p">(</span><span class="n">fbi</span><span class="p">,</span>
					<span class="n">ctrl</span> <span class="o">^</span> <span class="n">EP93XXFB_LUT_SW_CONTROL_SWTCH</span><span class="p">,</span>
					<span class="n">EP93XXFB_LUT_SW_CONTROL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">red</span> <span class="o">=</span> <span class="n">ep93xxfb_convert_color</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">green</span> <span class="o">=</span> <span class="n">ep93xxfb_convert_color</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">blue</span> <span class="o">=</span> <span class="n">ep93xxfb_convert_color</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">transp</span> <span class="o">=</span> <span class="n">ep93xxfb_convert_color</span><span class="p">(</span><span class="n">transp</span><span class="p">,</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

		<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">transp</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">ep93xxfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>	<span class="o">=</span> <span class="n">ep93xxfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>	<span class="o">=</span> <span class="n">ep93xxfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>	<span class="o">=</span> <span class="n">ep93xxfb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>	<span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>	<span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>	<span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>	<span class="o">=</span> <span class="n">ep93xxfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_mmap</span>	<span class="o">=</span> <span class="n">ep93xxfb_mmap</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ep93xxfb_calc_fbsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xxfb_mach_info</span> <span class="o">*</span><span class="n">mach_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fb_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">num_modes</span> <span class="o">==</span> <span class="n">EP93XXFB_USE_MODEDB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_size</span> <span class="o">=</span> <span class="n">EP93XXFB_MAX_XRES</span> <span class="o">*</span> <span class="n">EP93XXFB_MAX_YRES</span> <span class="o">*</span>
			<span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

			<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">*</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">*</span> <span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">fb_size</span><span class="p">)</span>
				<span class="n">fb_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fb_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ep93xxfb_alloc_videomem</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">virt_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fb_size</span><span class="p">;</span>

	<span class="n">fb_size</span> <span class="o">=</span> <span class="n">ep93xxfb_calc_fbsize</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="p">);</span>
	<span class="n">virt_addr</span> <span class="o">=</span> <span class="n">dma_alloc_writecombine</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fb_size</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">virt_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * There is a bug in the ep93xx framebuffer which causes problems</span>
<span class="cm">	 * if bit 27 of the physical address is set.</span>
<span class="cm">	 * See: http://marc.info/?l=linux-arm-kernel&amp;m=110061245502000&amp;w=2</span>
<span class="cm">	 * There does not seem to be any official errata for this, but I</span>
<span class="cm">	 * have confirmed the problem exists on my hardware (ep9315) at</span>
<span class="cm">	 * least.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_screenpage_bug</span> <span class="o">&amp;&amp;</span> <span class="n">phys_addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep93xx framebuffer bug. phys addr (0x%x) &quot;</span>
			<span class="s">&quot;has bit 27 set: cannot init framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phys_addr</span><span class="p">);</span>

		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fb_size</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">fb_size</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">virt_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xxfb_dealloc_videomem</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ep93xxfb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xxfb_mach_info</span> <span class="o">*</span><span class="n">mach_info</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">video_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mach_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_fbi</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span> <span class="o">=</span> <span class="n">mach_info</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_cmap</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ep93xxfb_alloc_videomem</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_videomem</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_resource</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME - We don&#39;t do a request_mem_region here because we are</span>
<span class="cm">	 * sharing the register space with the backlight driver (see</span>
<span class="cm">	 * drivers/video/backlight/ep93xx_bl.c) and doing so will cause</span>
<span class="cm">	 * the second loaded driver to return -EBUSY.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: No locking is required; the backlight does not touch</span>
<span class="cm">	 * any of the framebuffer registers.</span>
<span class="cm">	 */</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_resource</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ep93xxfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span>		<span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span>	<span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FBINFO_DEFAULT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span>		<span class="o">=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>

	<span class="n">fb_get_options</span><span class="p">(</span><span class="s">&quot;ep93xx-fb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_mode</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fb_find_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">video_mode</span><span class="p">,</span>
			   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">num_modes</span><span class="p">,</span>
			   <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">default_mode</span><span class="p">,</span> <span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No suitable video mode found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ep93xxfb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_check</span><span class="p">;</span>

	<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep93xxfb_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered. Mode = %dx%d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">failed_check:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">failed_mode:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
<span class="nl">failed_resource:</span>
	<span class="n">ep93xxfb_dealloc_videomem</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="nl">failed_videomem:</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
<span class="nl">failed_cmap:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ep93xxfb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_fbi</span> <span class="o">*</span><span class="n">fbi</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">);</span>
	<span class="n">ep93xxfb_dealloc_videomem</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">)</span>
		<span class="n">fbi</span><span class="o">-&gt;</span><span class="n">mach_info</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ep93xxfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ep93xxfb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ep93xxfb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ep93xx-fb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ep93xxfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep93xxfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ep93xxfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep93xxfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ep93xxfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ep93xxfb_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;EP93XX Framebuffer Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ep93xx-fb&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ryan Mallon, &quot;</span>
	      <span class="s">&quot;H Hartley Sweeten &lt;hsweeten@visionengravers.com&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
